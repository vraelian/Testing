--- START OF FILE: ./index.html ---
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <script>
      window.onerror = function(message, source, lineno, colno, error) {
        // This function will catch any uncaught JavaScript error.
        var fullMessage = "Message: " + message + "\nSource: " + source + "\nLine: " + lineno + "\nColumn: " + colno;
        
        // Check if the webkit message handler exists and send the error message to our Swift code.
        if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.errorObserver) {
     
          window.webkit.messageHandlers.errorObserver.postMessage(fullMessage);
        }
        
        // Prevent the browser's default error handling.
        return true;
      };
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>Orbital Trading 32.90</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lil-gui@0.19"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&family=Orbitron:wght@500;700&family=Roboto+Mono:wght@400;700&family=Aldrich&family=Space+Mono:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/global.css">
    <link rel="stylesheet" href="./css/navigation.css">
    <link rel="stylesheet" href="./css/news-ticker.css"> <link rel="stylesheet" href="./css/modals.css">
    <link rel="stylesheet" href="./css/hud.css">
    <link rel="stylesheet" href="./css/missions.css">
    <link rel="stylesheet" href="./css/tutorial.css">
    <link rel="stylesheet" href="./css/debug.css">
    <link rel="stylesheet" href="./css/screens/market-screen.css">
    <link rel="stylesheet" href="./css/screens/hangar-screen.css">
    <link rel="stylesheet" href="./css/screens/navigation-screen.css">
    <link rel="stylesheet" href="./css/screens/finance-screen.css">
    <link rel="stylesheet" href="./css/screens/intel-screen.css">
    <link rel="stylesheet" href="./css/screens/map-screen.css">
    <link rel="stylesheet" href="./css/screens/services-screen.css">
    <link rel="stylesheet" href="./css/screens/cargo-screen.css">
    <link rel="icon" href="./favicon.svg" type="image/svg+xml">
</head>
<body>

    <div id="splash-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-8 text-center bg-[#0c101d]">
        <button id="debug-start-btn" class="btn" data-action="debug-simple-start">D</button>
        <div class="max-w-3xl w-full panel-border border border-slate-700 bg-black/30 p-8 md:p-12 rounded-lg btn-pulse">
            <h1 class="text-6xl md:text-7xl font-orbitron font-bold text-cyan-300 mb-2">Orbital Trading</h1>
            <p class="text-xl md:text-2xl text-gray-400 mb-16"><span class="hl">A game of heliocentric adventure & arbitrage</span></p>
          
    
            <div class="flex flex-col items-center gap-4 w-full max-w-sm mx-auto">
                <button id="start-game-btn" class="btn btn-header btn-pulse w-full">Start Game</button>
                <button class="btn btn-header w-full" disabled="">Load Game</button>
                <button class="btn btn-header w-full" disabled="">Options</button>
            </div>
    
            <div id="eula-container" class="mt-8 text-center text-gray-400">
                <input type="checkbox" id="eula-checkbox" class="align-middle form-checkbox h-5 w-5 bg-slate-900 border-slate-600 text-cyan-500 rounded focus:ring-cyan-500">
                <label for="eula-checkbox" class="ml-2 align-middle">
                    I accept the <a href="#" id="eula-link" data-action="show_eula_modal" class="text-cyan-300 hover:text-cyan-100 underline">EULA</a>
                </label>
            </div>
            </div>

        <footer class="absolute bottom-4 text-center text-slate-500 text-sm w-full">
            <p>Version 32.90</p>
            <a href="https://docs.google.com/forms/d/e/1FAIpQLSeVqjUEC6nsZlxTQ9-vzz0_fHO0ng8w0AueZaGzkHPoLJIBDA/viewform?usp=header" target="_blank" class="hover:text-cyan-300 transition-colors"><span class="hl">Submit Playtesting Feedback</span></a>
        </footer>
    </div>
    
    <div id="save-toast" class="hidden fixed top-5 left-1/2 -translate-x-1/2 bg-cyan-500/80 text-white px-6 py-2 rounded-lg shadow-lg transition-all duration-300 pointer-events-none z-50">Checkpoint Saved</div>
    <div id="garnishment-toast" class="hidden fixed top-5 left-1/2 -translate-x-1/2 text-white px-6 py-2 rounded-lg shadow-lg transition-all duration-300 pointer-events-none z-50"></div>
    <div id="hull-warning-toast" class="hidden fixed top-20 left-1/2 -translate-x-1/2 text-white px-6 py-2 rounded-lg shadow-lg transition-all duration-300 pointer-events-none z-50"></div>
    <div id="starport-unlock-tooltip" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-gray-900/90 text-white px-6 py-3 rounded-lg shadow-lg transition-all duration-300 pointer-events-none z-50 border border-yellow-500 text-center">
        Pay off your initial loan to access the Starport!
    </div>

    <main id="game-container" class="game-container hidden">
        <div id="top-bar-container">
            <header id="header-main" class="relative">
                <div id="nav-bar"></div>
    
                <div id="news-ticker-bar"></div> <div id="sub-nav-bar"></div>
            </header>
            <div id="sticky-bar"></div>
        </div>
        
        <div class="main-content-wrapper px-4 md:px-8 pb-4 md:pb-8">
            <div id="main-content">
                <div id="map-screen" class="screen"></div>
  
                <div id="navigation-screen" class="screen"></div>
                <div id="services-screen" class="screen"></div>
               
                <div id="market-screen" class="screen"></div>
                <div id="cargo-screen" class="screen"></div>
                <div id="hangar-screen" class="screen"></div>

                <div id="missions-screen" class="screen"></div>
                <div id="finance-screen" class="screen"></div>
                <div id="intel-screen" class="screen"></div>
            </div>
        </div>

        <div id="mission-modal" class="modal-backdrop hidden">
            <div class="modal-content sci-fi-frame flex flex-col items-center text-center">
                <div class="modal-header">
                    <div>
                        <h3 id="mission-modal-title" class="text-xl font-orbitron mb-1"></h3>
                        <p id="mission-modal-type" class="mission-type"></p>
                    </div>
                    
                </div>
                <p id="mission-modal-description" class="my-4 text-gray-300"></p>
                <div id="mission-modal-objectives"></div>
                <div id="mission-modal-rewards" class="reward-section mb-4"></div>
                <div id="mission-modal-buttons" class="mt-4"></div>
            </div>
        </div>
         <div id="map-detail-modal" class="modal-backdrop hidden">
             <div class="modal-content">
                <div id="map-modal-content-container">
                </div>
     
             </div>
        </div>
    </main>
    <div id="mission-sticky-bar" class="bottom-sticky-bar">
        <div class="sticky-content sci-fi-frame">
            <p id="sticky-objective-text"></p>
            <p id="sticky-objective-progress" class="font-roboto-mono"></p>
        </div>
    </div>

    <div id="travel-animation-modal" class="modal-backdrop hidden">
        <div id="travel-animation-content" class="modal-content">
            <div id="travel-header-panel">
                <h3 id="travel-status-text" class="text-2xl font-orbitron text-cyan-300"></h3>
                <p id="travel-arrival-lore" class="text-base text-gray-300 italic mt-2"></p>
            </div>
            <canvas id="travel-canvas"></canvas>
            <div id="travel-footer-panel">
                <div id="travel-progress-container" class="w-full bg-slate-700 rounded-full h-1.5 my-4">
                    <div id="travel-progress-bar" class="h-1.5 rounded-full" style="width: 0%"></div>
                </div>
                <div id="travel-readout-container" class="hidden">
                    <p id="travel-info-text" class="text-base font-roboto-mono"></p>
                    <p id="travel-hull-damage" class="text-sm font-roboto-mono mt-1"></p>
                </div>
                <button id="travel-confirm-button" class="btn px-8 py-2 mt-4">Enter Station</button>
            </div>
        </div>
    </div>

    <dialog id="name-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-orbitron mb-4 text-cyan-300">What is your name, Spacer?</h3>
            <input type="text" id="player-name-input" maxlength="18" class="w-full p-2 rounded bg-slate-900 border border-slate-600 text-center text-lg mb-4 text-gray-200" placeholder="Enter name...">
            <div id="name-modal-buttons" class="mt-4 flex flex-col sm:flex-row justify-center items-center gap-4"></div>
        </div>
    </dialog>

    <div id="event-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="event-title" class="text-2xl font-orbitron mb-4 text-cyan-300 text-center"></h3>
            <p id="event-description" class="mb-6 text-lg"></p>
            <div id="event-button-container" class="mt-6 flex justify-center gap-4"></div>
        </div>
    </div>

    <div id="charter-modal" class="modal-backdrop hidden modal-theme-gold">
        <div class="modal-content">
            <h3 id="charter-title" class-"text-2xl font-orbitron mb-4 text-gray-300 text-center"></h3>
            <div id="charter-description" class="mb-6 text-lg"></div>
            <div id="charter-button-container" class="mt-6 flex justify-center gap-4"></div>
        </div>
    </div>

    <div id="signature-modal" class="modal-backdrop hidden modal-theme-gold">
        <div class="modal-content">
            <h3 id="signature-title" class="text-2xl font-orbitron mb-4 text-gray-300 text-center"></h3>
            <div id="signature-description" class="mb-6 text-lg"></div>
            <input type="text" id="signature-input" maxlength="18" class="w-full p-2 rounded bg-slate-900 border border-slate-600 text-center text-lg mb-4 text-gray-200" placeholder="INPUT YOUR NAME...">
            <div id="signature-button-container" class="mt-6 flex justify-center gap-4"></div>
        </div>
    </div>

    <div id="processing-modal" class="modal-backdrop hidden">
        <div class="modal-content modal-theme-admin">
            <h3 id="processing-title" class="text-xl font-orbitron mb-4 text-gray-300"></h3>
            <div class="w-full bg-slate-700 rounded-full h-2.5 my-4">
                <div id="processing-progress-bar" class"bg-white h-2.5 rounded-full" style="width: 0%; transition: width 4s ease-out;"></div>
            </div>
            <p id="processing-status" class="text-lg text-gray-400 font-roboto-mono h-6"></p>
        </div>
    </div>

    <div id="random-event-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="random-event-title" class="text-2xl font-orbitron mb-4 text-yellow-300"></h3>
            <p id="random-event-scenario" class="mb-6 text-lg"></p>
            <div id="random-event-choices-container" class="mt-6 flex flex-col justify-center gap-4"></div>
        </div>
    </div>
    
    <div id="age-event-modal" class="modal-backdrop hidden age-event-modal">
        <div class="modal-content">
            <h3 id="age-event-title" class="text-2xl font-orbitron mb-2"></h3>
            <p id="age-event-description" class="mb-6 text-lg"></p>
            <div id="age-event-button-container" class="mt-6 flex flex-col md:flex-row justify-center gap-4"></div>
        </div>
    </div>

    <div id="lore-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <div id="lore-modal-content" class="text-gray-300">
                </div>
        </div>
    </div>

    <div id="eula-modal" class="modal-backdrop hidden">
       <div class="modal-content">
           <div id="eula-modal-content" class="text-gray-300">
               </div>
       </div>
    </div>
    <div id="tutorial-anchor-overlay" class="fixed inset-0 z-30 pointer-events-none"></div>

    <div id="tutorial-toast-container" class="hidden fixed z-40 p-4 rounded-lg shadow-2xl transition-all duration-300 pointer-events-auto">
        <div id="tt-arrow" data-popper-arrow></div>
        <div class="tt-controls-container">
            <button id="tutorial-toast-skip-btn" class="absolute top-1 right-2 text-2xl font-bold opacity-70 hover:opacity-1.01">×</button>
            <button id="tutorial-toast-next-btn" class="tt-next-arrow hidden">›</button>
        </div>
        <p id="tutorial-toast-text" class="text-lg pr-6"></p>
        </div>
    
    <div id="skip-tutorial-modal" class="modal-backdrop hidden">
         <div class="modal-content">
            <h3 id="skip-tutorial-title" class="text-2xl font-orbitron mb-4">Skip Tutorial?</h3>
            <p id="skip-tutorial-description" class="mb-6 text-lg">Are you sure you want to skip the rest of this tutorial? You can replay it later from the tutorial log.</p>
            <div id="skip-tutorial-button-container" class="mt-6 flex justify-center gap-4">
                 <button id="skip-tutorial-confirm-btn" class="btn bg-red-800/80">Yes, Skip</button>
                 <button id="skip-tutorial-cancel-btn" class="btn">No, Cancel</button>
            </div>
        </div>
    </div>

    <div id="ship-detail-modal" class="modal-backdrop hidden">
        <div id="ship-detail-content" class="modal-content">
            </div>
    </div>

    <div id="launch-modal" class="modal-backdrop hidden">
        <div id="launch-modal-content" class="modal-content">
            </div>
    </div>

    <div id="cargo-detail-modal" class="modal-backdrop hidden">
        <div id="cargo-detail-content" class="modal-content">
            </div>
    </div>

    <div id="graph-tooltip"></div>
    <div id="generic-tooltip" class="generic-tooltip"></div>
    
    <div id="tutorial-highlight-overlay" class="hidden"></div>
    <div id="orientation-overlay">Please rotate your device to portrait mode.</div>

    <div id="diagnostic-overlay" class="hidden">
        <div class="diag-section">
            <p><strong>Viewport:</strong> <span id="diag-window-w"></span>x<span id="diag-window-h"></span></p>
            <p><strong>Visual VP:</strong> <span id="diag-visual-vp-w"></span>x<span id="diag-visual-vp-h"></span></p>
            <p><strong>Game Cont:</strong> <span id="diag-game-container-w"></span>x<span id="diag-game-container-h"></span></p>
            <p><strong>Body:</strong> <span id="diag-body-w"></span>x<span id="diag-body-h"></span></p>
        </div>
        <div class="diag-section">
            <p><strong>Pixel Ratio:</strong> <span id="diag-pixel-ratio"></span></p>
            <p><strong>Display Mode:</strong> <span id="diag-display-mode"></span></p>
        </div>
        <div class="diag-section">
            <p><strong>Day:</strong> <span id="diag-day"></span></p>
            <p><strong>Nav/Screen:</strong> <span id="diag-nav-screen"></span></p>
        </div>
        <div class="diag-section">
            <p><strong>Tutorial Batch:</strong> <span id="diag-tutorial-batch"></span></p>
            <p><strong>Tutorial Step:</strong> <span id="diag-tutorial-step"></span></D></p>
        </div>
    </div>

    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script type="module" src="./js/main.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { // Corrected arrow function syntax
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>
--- END OF FILE: ./index.html ---

--- START OF FILE: ./css/missions.css ---
/* css/missions.css */
.mission-card {
    padding: 0.5rem 1rem;
    cursor: pointer;
    border-radius: 8px;
}
.mission-card:hover .sci-fi-frame::before, .mission-card:hover .sci-fi-frame::after {
    border-color: rgba(96, 165, 250, 0.7);
}
.mission-type {
    font-family: 'Oxanium ExtraBold', 'Roboto Mono', monospace;
    font-size: 0.85rem; /* Increased from 0.7rem */
    color: #9ca3af;
    letter-spacing: 0.1em;
    font-weight: 800;
}
.mission-host {
    font-family: 'Oxanium ExtraBold', 'Roboto Mono', monospace;
    font-size: 0.7rem;
    color: #d1d5db;
    font-weight: 800;
}
.mission-reward {
    font-family: 'Oxanium ExtraBold', 'Orbitron', sans-serif;
    font-size: 0.9rem;
    /* color: #facc15; */ /* <-- VIRTUAL WORKBENCH: Phase 7 */
    text-shadow: 0 0 5px rgba(250, 204, 21, 0.6);
    font-weight: 800;
}

/* Applied to mission card title */
.mission-card .font-bold.text-base {
    font-family: 'Oxanium ExtraBold', 'Orbitron', sans-serif;
    font-weight: 800;
    font-size: 1.15rem; /* Increased size */
}

/* Applied to mission modal title */
#mission-modal #mission-modal-title {
    font-family: 'Oxanium ExtraBold', 'Orbitron', sans-serif;
    font-weight: 800;
    font-size: 1.4rem; /* Increased size */
}


#mission-modal #mission-modal-description {
    font-family: 'Oxanium Medium', 'Exo 2', sans-serif; /* Use 'Oxanium Medium' font */
    font-size: 1.0rem; 
    /* font-weight: 500; */ /* Removed, as font file handles this */
    background: rgba(0, 0, 0, 0.25);
    padding: 1rem;
    border-radius: 6px;
    border: 1px solid #4a6a8a; /* Thematic border */
    text-align: left;
    white-space: pre-wrap; 
    
    max-height: 36vh; /* Increased 20% (from 30vh) */
    overflow-y: auto;
    touch-action: pan-y;
    scrollbar-width: none; 
    -ms-overflow-style: none; 
}

/* Hide Webkit scrollbar (Chrome, Safari, iOS) */
#mission-modal #mission-modal-description::-webkit-scrollbar {
    display: none;
}


#mission-modal #mission-modal-objectives {
    margin-top: 1.5rem;
    margin-bottom: 1rem; /* Increased space */
    width: 100%; /* Ensure it spans width */
}

/* Applied to objective description text in modal */
#mission-modal #mission-modal-objectives .flex-1 {
    font-family: 'Oxanium Medium', 'Exo 2', sans-serif; /* Use 'Oxanium Medium' font */
    /* font-weight: 500; */ /* Removed, as font file handles this */
}

/* Applied to objective progress text (e.g., "1 / 5") in modal */
#mission-modal #mission-modal-objectives .font-roboto-mono {
    font-family: 'Oxanium Medium', 'Roboto Mono', monospace; /* Use 'Oxanium Medium' font */
    /* font-weight: 500; */ /* Removed, as font file handles this */
}


#mission-modal #mission-modal-buttons {
    margin-top: 1.5rem; /* Increased space */
}

/* Increase scale of modal buttons by 50% */
#mission-modal #mission-modal-buttons .btn {
    font-size: 1.2rem; 
    padding: 0.75rem 1.125rem; 
}


/* Host Themes */
.host-guild {
    background: linear-gradient(105deg, rgba(255, 215, 0, 0.35) 0%, rgba(255, 255, 255, 0.15) 100%);
    border-color: #FFD700;
}
#mission-modal .modal-content.host-guild {
    background-color: #0c101d; /* Opaque base */
    background-image: linear-gradient(105deg, rgba(255, 215, 0, 0.35) 0%, rgba(255, 255, 255, 0.15) 100%);
    border-color: #FFD700;
}
#mission-modal .modal-content.host-guild #mission-modal-objectives {
    /* border-width: 2px; */
    /* border-color: #FFD700; */
}

.host-syndicate {
    background: linear-gradient(105deg, rgba(168, 85, 247, 0.25) 0%, rgba(179, 71, 71, 0.35) 100%);
    border-color: #a855f7;
}
#mission-modal .modal-content.host-syndicate {
    background-color: #0c101d; /* Opaque base */
    background-image: linear-gradient(105deg, rgba(168, 85, 247, 0.25) 0%, rgba(179, 71, 71, 0.35) 100%);
    border-color: #a855f7;
}
#mission-modal .modal-content.host-syndicate #mission-modal-objectives {
    /* border-width: 2px; */
    /* border-color: #a855f7; */
}

.host-unknown {
    background: linear-gradient(105deg, rgba(95, 97, 107, 0.35) 0%, rgba(12, 16, 29, 0.5) 100%);
    border-color: #5f616b;
}
#mission-modal .modal-content.host-unknown {
    background-color: #0c101d; /* Opaque base */
    background-image: linear-gradient(105deg, rgba(95, 97, 107, 0.35) 0%, rgba(12, 16, 29, 0.5) 100%);
    border-color: #5f616b;
}
#mission-modal .modal-content.host-unknown #mission-modal-objectives {
    /* border-width: 2px; */
    /* border-color: #5f616b; */
}

.host-crew {
    background: linear-gradient(105deg, rgba(201, 191, 177, 0.35) 0%, rgba(245, 222, 179, 0.25) 100%);
    border-color: #c9bfb1;
}
#mission-modal .modal-content.host-crew {
    background-color: #0c101d; /* Opaque base */
    background-image: linear-gradient(105deg, rgba(201, 191, 177, 0.35) 0%, rgba(245, 222, 179, 0.25) 100%);
    border-color: #c9bfb1;
}
#mission-modal .modal-content.host-crew #mission-modal-objectives {
    /* border-width: 2px; */
    /* border-color: #c9bfb1; */
}

.host-tutorial {
    background: linear-gradient(105deg, rgba(6, 78, 59, 0.45) 0%, rgba(90, 166, 109, 0.35) 100%);
    border-color: #5aa66d;
}
#mission-modal .modal-content.host-tutorial {
    background-color: #0c101d; /* Opaque base */
    background-image: linear-gradient(105deg, rgba(6, 78, 59, 0.45) 0%, rgba(90, 166, 109, 0.35) 100%);
    border-color: #5aa66d;
}
#mission-modal .modal-content.host-tutorial #mission-modal-objectives {
    /* border-width: 2px; */
    /* border-color: #5aa66d; */
}

.host-station {
    background: linear-gradient(105deg, rgba(143, 154, 204, 0.35) 0%, rgba(30, 64, 175, 0.3) 100%);
    border-color: #8f9acc;
}
#mission-modal .modal-content.host-station {
    background-color: #0c101d; /* Opaque base */
    background-image: linear-gradient(105deg, rgba(143, 154, 204, 0.35) 0%, rgba(30, 64, 175, 0.3) 100%);
    border-color: #8f9acc;
}
#mission-modal .modal-content.host-station #mission-modal-objectives {
    /* border-width: 2px; */
    /* border-color: #8f9acc; */
}

/* Mission Status Styles */
.mission-active {
    box-shadow: 0 0 16px rgba(96, 165, 250, 0.7), inset 0 0 12px rgba(96, 165, 250, 0.2);
    border-width: 3px;
    border-color: rgba(96, 165, 250, 0.7);
}
.mission-active .sci-fi-frame::before, .mission-active .sci-fi-frame::after {
    border-color: #93c5fd;
}
.mission-complete {
    opacity: 0.6;
    background: #111827;
}
.mission-complete .sci-fi-frame::before, .mission-complete .sci-fi-frame::after {
    border-color: #34d399;
}

.mission-turn-in {
    overflow: hidden;
    position: relative;
    --glow-color: #fde047;
    animation: glow-border 2s infinite, shimmer-effect 3s linear infinite;
    background-image: linear-gradient(to right, transparent 0%, rgba(253, 224, 71, 0.2) 50%, transparent 100%);
    background-repeat: no-repeat;
    background-size: 400px 100%;
}

.objective-progress-flash {
    animation: flash-green 0.7s ease-in-out;
}

.missions-scroll-panel {
    /* height: 68vh; */ /* REMOVED */
    touch-action: pan-y;
}
--- END OF FILE: ./css/missions.css ---

--- START OF FILE: ./css/debug.css ---
/* css/debug.css */
#debug-panel {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.75);
    transform-origin: center center;
    width: 450px; /* Base width before scaling */
    z-index: 1000;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    display: none; /* Hidden by default */
}

#debug-panel.debug-visible {
    display: block; /* Shown when class is applied */
}


#debug-panel h2 {
    font-family: 'Orbitron', sans-serif;
    border-bottom: 2px solid #4b5563;
    padding-bottom: 0.5rem;
    margin-top: 0;
}

#debug-panel .control-group {
    margin-bottom: 1.5rem;
}

#debug-panel .control-group summary {
    font-weight: bold;
    cursor: pointer;
    padding: 0.5rem;
    background-color: #374151;
    border-radius: 4px;
    margin-bottom: 0.5rem;
}

#debug-panel .control-row {
    display: grid;
    grid-template-columns: 140px 1fr 60px;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
    font-size: 0.9em;
}

#debug-panel .control-row.single {
    grid-template-columns: 140px 1fr;
}


#debug-panel .control-row label {
    font-weight: 500;
}

#debug-panel .control-row input[type="range"] {
    width: 100%;
}
#debug-panel .control-row input[type="text"], #debug-panel .control-row select {
    background-color: #111827;
    border: 1px solid #4b5563;
    color: #e5e7eb;
    border-radius: 4px;
    padding: 4px 6px;
    width: 100%;
    box-sizing: border-box;
    font-family: 'Roboto Mono', monospace;
}

#debug-panel .control-row .value-display {
    font-family: 'Roboto Mono', monospace;
    text-align: right;
}

#debug-panel .export-import {
    margin-top: 2rem;
    border-top: 2px solid #4b5563;
    padding-top: 1rem;
}

#debug-panel .export-import textarea {
    width: 100%;
    box-sizing: border-box;
    height: 150px;
    background-color: #111827;
    color: #f3f4f6;
    border: 1px solid #4b5563;
    border-radius: 4px;
    margin-top: 0.5rem;
    font-family: 'Roboto Mono', monospace;
}

#debug-panel .export-import button {
    width: 100%;
    padding: 0.5rem;
    background-color: #4f46e5;
    border: none;
    color: white;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 0.5rem;
    font-family: 'Orbitron', sans-serif;
}

#debug-panel .control-subheader {
    font-weight: bold;
    color: #9ca3af;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    text-align: center;
}
#debug-panel p, #debug-panel h2 {
    margin: 0;
    padding: 0;
}

/* --- [[START]] DIAGNOSTIC OVERLAY STYLES --- */
#diagnostic-overlay {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    color: #fff;
    font-family: 'Roboto Mono', monospace;
    font-size: 10px;
    padding: 8px;
    z-index: 2000;
    pointer-events: none;
    display: flex;
    flex-wrap: wrap;
    gap: 8px 16px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}

#diagnostic-overlay.hidden {
    display: none;
}

#diagnostic-overlay .diag-section {
    padding: 4px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    background-color: rgba(255, 255, 255, 0.05);
}

#debug-panel .lil-gui.root {
    background-color: #1f2937;
    color: #e5e7eb;
}

#diagnostic-overlay p {
    margin: 0;
    white-space: pre;
}

#diagnostic-overlay strong {
    color: #67e8f9; /* Cyan */
}
/* --- [[END]] DIAGNOSTIC OVERLAY STYLES --- */

/* --- [[START]] TUTORIAL TUNER STYLES --- */
/* Style for read-only fields (Step ID, Anchor) and the Code output */
/* Using more specific selectors targeting the input element directly */
.tutorial-tuner-folder .lil-gui-item > input[type=text]:disabled,
.tutorial-tuner-folder .lil-gui-item > input[type=text][aria-labelledby$="-Code"] { /* Target Code input via its label */
    background-color: #111 !important;
    color: #fde047 !important; /* Highlight color */
    font-family: 'Roboto Mono', monospace !important;
    opacity: 1 !important;
    border: 1px dashed #444;
    cursor: default; /* Make it look non-interactive */
     /* Ensure user-select is not preventing copy */
    -webkit-user-select: text !important;
    -moz-user-select: text !important;
    -ms-user-select: text !important;
    user-select: text !important;
}

/* Ensure the Code output field specifically allows text selection and text cursor */
.tutorial-tuner-folder .lil-gui-item > input[type=text][aria-labelledby$="-Code"] {
    cursor: text; /* Use text cursor */
}


.tutorial-tuner-folder .lil-gui-item.disabled > .name {
    opacity: 0.7 !important; /* Make labels for disabled fields clearer */
}

.tutorial-tuner-folder .controller.button {
    text-align: center !important;
    background-color: #304a22 !important; /* Greenish for 'generate' */
}
.tutorial-tuner-folder .controller.button:hover {
    background-color: #4a6a32 !important;
}
/* --- [[END]] TUTORIAL TUNER STYLES --- */
--- END OF FILE: ./css/debug.css ---

--- START OF FILE: ./css/tutorial.css ---
/* css/tutorial.css */

/* --- [[START]] NEW THEMED STYLES --- */

#tutorial-toast-container {
    /* New background: dark, slightly transparent, blurred */
    background-color: rgba(18, 24, 39, 0.9); /* A color between modal bg and game bg */
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);

    color: var(--color-text-primary, #d0d8e8); /* Default to global text color */

    /* New border: Apply sci-fi-frame styles */
    border: 1px solid #2a3a5a;
    box-shadow: inset 0 0 15px rgba(12, 16, 29, 0.5), 0 4px 15px rgba(0,0,0,0.3); /* Add outer shadow */
    border-radius: 8px; /* Standard border radius */

    /* --- [[START]] WIDTH FIX --- */
    min-width: 200px;
    max-width: min(600px, 90vw); /* Generous max-width, responsive */
    /* --- [[END]] WIDTH FIX --- */

    z-index: 999; /* Ensure toast is above anchor overlay */
    padding: 1rem; /* Simplified padding */
    /* MODIFIED: Add a little extra bottom padding for the arrow */
    padding-bottom: 1.5rem;
    position: fixed; /* Changed from absolute for percentage positioning */
    transform: translate(-50%, -50%); /* Center based on top/left percentages */
}

/* NEW: Styles for the anchor overlay */
#tutorial-anchor-overlay {
    position: fixed;
    inset: 0; /* Cover the whole viewport */
    z-index: 998; /* Below toast, above game content */
    pointer-events: none; /* Allow clicks to pass through */
}

/* Pseudo-elements for sci-fi-frame corners */
#tutorial-toast-container::before,
#tutorial-toast-container::after {
    content: '';
    position: absolute;
    width: 15px;
    height: 15px;
    border-color: #7a9ac0; /* Match default sci-fi-frame color */
    border-style: solid;
    transition: border-color 0.3s;
}
#tutorial-toast-container::before {
    top: -1px;
    left: -1px;
    border-width: 2px 0 0 2px;
    border-top-left-radius: 8px; /* Top-left corner */
}
#tutorial-toast-container::after {
    bottom: -1px;
    right: -1px;
    border-width: 0 2px 2px 0;
    border-bottom-right-radius: 8px; /* Bottom-right corner */
}

/* Apply flexbox layout only when the toast is visible */
#tutorial-toast-container:not(.hidden) {
    display: flex;
    flex-direction: column;
}

#tutorial-toast-text {
    text-align: left;
    /* MODIFIED: Force scrollbar to exist */
    overflow-y: scroll !important;
    flex-grow: 1;
    max-height: 150px; /* Adjust as needed, maybe based on height slider? */
    /* MODIFIED: Remove padding for deleted skip button */
    padding-right: 0.5rem;
    font-family: 'Exo 2', sans-serif; /* Update font */
    font-size: 0.9rem; /* Slightly larger for readability */
    line-height: 1.5; /* Increased line height */
    color: var(--color-text-secondary);

    /* MODIFIED: Add Firefox scrollbar styles just in case */
    scrollbar-width: thin !important;
    scrollbar-color: var(--color-accent-yellow, #f7b731) #332a0e !important;
}

#tutorial-highlight-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 997; /* Below anchor overlay */
}

/* Style for individual highlight cues within the overlay */
.tutorial-cue {
    position: absolute;
}


/* --- [[START]] POPPER.JS ARROW STYLES --- */
/* Adjusted arrow background and border */
#tt-arrow,
#tt-arrow::before {
    position: absolute;
    width: 8px;
    height: 8px;
    background: rgba(18, 24, 39, 0.9); /* Match new toast background */
}

#tt-arrow {
    visibility: hidden;
}

#tt-arrow::before {
    visibility: visible;
    content: '';
    transform: rotate(45deg);
}

/* Arrow border to match sci-fi-frame border */
#tutorial-toast-container[data-popper-placement^='top'] > #tt-arrow {
    bottom: -4px;
    border-bottom: 1px solid #7a9ac0; /* Match new border color */
    border-right: 1px solid #7a9ac0;
}

#tutorial-toast-container[data-popper-placement^='bottom'] > #tt-arrow {
    top: -4px;
    border-top: 1px solid #7a9ac0; /* Match new border color */
    border-left: 1px solid #7a9ac0;
}

#tutorial-toast-container[data-popper-placement^='left'] > #tt-arrow {
    right: -4px;
    border-top: 1px solid #7a9ac0; /* Match new border color */
    border-right: 1px solid #7a9ac0;
}

#tutorial-toast-container[data-popper-placement^='right'] > #tt-arrow {
    left: -4px;
    border-bottom: 1px solid #7a9ac0; /* Match new border color */
    border-left: 1px solid #7a9ac0;
}
/* --- [[END]] POPPER.JS ARROW STYLES --- */


/* --- [[START]] NEW CONTROL BUTTON STYLES --- */

/* REMOVED: .tt-controls-container */
/* REMOVED: #tutorial-toast-skip-btn */

/* NEW: Pulse animation for the new text-based arrow */
@keyframes pulse-glow-text {
    0% {
        color: var(--color-accent-yellow, #f7b731);
        filter: drop-shadow(0 0 5px var(--color-accent-yellow, #f7b731));
    }
    50% {
        color: var(--color-accent-yellow-light, #f8d775);
        filter: drop-shadow(0 0 10px var(--color-accent-yellow-light, #f8d775));
    }
    100% {
        color: var(--color-accent-yellow, #f7b731);
        filter: drop-shadow(0 0 5px var(--color-accent-yellow, #f7b731));
    }
}

/* MODIFIED: 'Next' arrow now uses a text character */
.tt-next-arrow {
    position: absolute;
    /* MODIFIED: Positioned to be nested on the border, adjusted position */
    bottom: -12px; /* -5px + 10px */
    right: -9px; /* 5px + 10px */

    /* MODIFIED: Hide the original '➤' from JS */
    font-size: 0;
    line-height: 0;

    /* MODIFIED: Remove all old styles (bg, border, etc) */
    background: none;
    border: none;
    width: auto;
    height: auto;
    padding: 0;
    border-radius: 0; /* Override old style */
    color: transparent; /* Override old style */

    cursor: pointer;
    user-select: none;
    z-index: 11; /* Above corner pseudo-element */
    transition: transform 0.2s ease;
}

/* NEW: Use ::before to inject the new arrow character */
.tt-next-arrow::before {
    content: '➜';
    /* MODIFIED: 15% larger */
    font-size: 30px;
    line-height: 1;

    /* MODIFIED: Apply color and pulse animation here */
    color: var(--color-accent-yellow, #f7b731);
    animation: pulse-glow-text 2.5s infinite ease-in-out;
    transition: all 0.2s ease;
}

.tt-next-arrow:hover {
    transform: scale(1.1); /* Scale the whole container */
}

.tt-next-arrow:hover::before {
    /* MODIFIED: Stop animation, show static bright glow */
    animation: none;
    color: var(--color-accent-yellow-light, #f8d775);
    filter: drop-shadow(0 0 12px var(--color-accent-yellow-light, #f8d775));
}

.tt-next-arrow.hidden {
    display: none;
}

/* --- [[END]] NEW CONTROL BUTTON STYLES --- */


/* --- [[START]] CUSTOM SCROLLBAR STYLES --- */
/* MODIFIED: Increased specificity and added !important to override conflicts */
#tutorial-toast-container #tutorial-toast-text::-webkit-scrollbar {
    width: 8px !important;
    background-color: transparent !important;
}

#tutorial-toast-container #tutorial-toast-text::-webkit-scrollbar-track {
    background: #332a0e !important;
    border-radius: 4px !important;
    /* Add inner shadow for depth */
    box-shadow: inset 0 0 3px rgba(0,0,0,0.5) !important;
}

#tutorial-toast-container #tutorial-toast-text::-webkit-scrollbar-thumb {
    background-color: var(--color-accent-yellow, #f7b731) !important;
    border-radius: 4px !important;
    border: 1px solid var(--color-accent-yellow-light, #f8d775) !important;
}

#tutorial-toast-container #tutorial-toast-text::-webkit-scrollbar-thumb:hover {
    background-color: var(--color-accent-yellow-light, #f8d775) !important;
    border-color: #fff !important;
    box-shadow: 0 0 5px var(--color-accent-yellow-light, #f8d775) !important;
}
/* --- [[END]] CUSTOM SCROLLBAR STYLES --- */

/* Lore tooltip styles remain the same */
.lore-container { /* ... */ }
.lore-tooltip { /* ... */ }
.tutorial-tooltip { /* ... */ }
/* ... (rest of lore styles) ... */
--- END OF FILE: ./css/tutorial.css ---

--- START OF FILE: ./css/hud.css ---
/* css/hud.css */
#top-bar-container {
    position: sticky;
    top: 0;
    z-index: 10;
    width: 100%;
    /* Main container radius (55px top, 15px bottom) */
    border-radius: 55px 55px 15px 15px;
    
    /* Background-color is REMOVED. It lives in the content elements. */
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.4);
    /* 'overflow: hidden;' remains REMOVED */
}

/* * FIXED: This is the border.
 * 1. Its radius is 1px LARGER (56px/16px) than the content (55px/15px).
 * 2. It sits ON TOP of the content (z-index: 4).
 * 3. pointer-events: none lets clicks pass through.
 */
#top-bar-container::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    border: 1px solid #000;
    /* This radius is 1px larger than the content's to wrap it */
    border-radius: 30px 30px 16px 16px; 
    z-index: 4; /* Sit ON TOP of all content */
    pointer-events: none; /* Allow clicks to pass through */
}

.context-bar {
    padding: 6px 40px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
    font-family: 'Share Tech Mono', monospace;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    transition: background 0.5s ease-out, color 0.5s ease-out;

    /* * This content has the 55px radius.
     * The border (at 56px) will now wrap it perfectly.
     */
    background-color: rgba(12, 16, 29, 0.85);
    border-radius: 55px 55px 0 0;
    position: relative;
    z-index: 2;
}

.credit-text {
    color: #29f1ff;
    text-shadow: 0 0 5px #16a8bb, 0 0 10px #28d5d7, 0 2px 4px rgba(0,0,0,0.8); /* Blue glow with dark shadow */
}

.status-pod {
    flex-grow: 1;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 8px;
    transform: translateX(-5%); /* Nudged status bars left */
    position: relative; /* Added for z-index */
    /* z-index: 3 sits above the context-bar (2) and active tab (3), but *below* the border (4) */
    z-index: 3; 
}

.status-bar-group {
    position: relative;
    display: flex;
    align-items: center;
    gap: 4px;
    cursor: pointer;
}

.status-bar-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    color: #aaa;
}

.status-bar {
    width: 34px;
    height: 8px;
    background-color: #222;
    border: 1px solid #111;
    overflow: hidden;
}

.status-bar .fill {
    height: 100%;
    transition: width 0.3s ease-in-out;
}

.hull-fill { background-color: #2ecc71; }
.fuel-fill { background-color: #3b82f6; }
.cargo-fill { background-color: #f59e0b; }

.status-tooltip {
    position: absolute;
    top: 50%; /* Position vertically centered */
    left: 0; /* Position at the left edge of the parent */
    transform: translateY(-50%) translateX(-100%); /* Center vertically, move left */
    margin-right: 5px; /* Add gap between tooltip and bar */
    background-color: #111;
    color: #fff;
    padding: 4px 8px;
    border-radius: 3px;
    font-size: 0.75rem;
    white-space: nowrap;
    z-index: 20;
    border: 1px solid #555;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s, border-color 0.5s ease-out;
    visibility: hidden;
}

/* Removed rules for .fuel-group .status-tooltip and .cargo-group .status-tooltip */

.status-tooltip.visible {
    opacity: 1;
    visibility: visible;
}

/* DEPRECATED STYLES - Kept for non-nav UI elements */
.ship-hud {
    background-color: rgba(10, 20, 40, 0.5);
    border: 2px solid #2a3a5a;
    padding: 0.45rem;
    font-size: 0.8rem;
    border-radius: 10px;
    position: relative;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.ship-hud::before, .ship-hud::after {
    content: '';
    position: absolute; width: 15px; height: 15px;
    border-color: #7a9ac0; border-style: solid;
}
.ship-hud::before { top: -2px; left: -2px; border-width: 2px 0 0 2px;
    border-top-left-radius: 10px; }
.ship-hud::after { bottom: -2px; right: -2px;
    border-width: 0 2px 2px 0; border-bottom-right-radius: 10px; }

.hud-stat-bar { background-color: #1a253c;
    border-radius: 3px; overflow: hidden; height: 6px;
}
.hud-stat-bar > div { transition: width 0.5s ease-out;
    height: 100%; }

.sci-fi-frame {
    position: relative;
    border: 1px solid #2a3a5a;
    box-shadow: inset 0 0 15px rgba(12, 16, 29, 0.5);
}
.sci-fi-frame::before, .sci-fi-frame::after {
    content: '';
    position: absolute;
    width: 15px;
    height: 15px;
    border-color: #7a9ac0; /* Default border color */
    border-style: solid;
    transition: border-color 0.3s; /* Smooth transition for border color */
}
.sci-fi-frame::before {
    top: -1px;
    left: -1px;
    border-width: 2px 0 0 2px;
    border-top-left-radius: 8px; /* Top-left corner */
}
.sci-fi-frame::after {
    bottom: -1px;
    right: -1px;
    border-width: 0 2px 2px 0;
    border-bottom-right-radius: 8px; /* Bottom-right corner */
}

.bottom-sticky-bar {
    display: none;
    position: fixed;
    bottom: 1.5rem;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 1200px;
    padding: 0 1.5rem;
    cursor: pointer;
    z-index: 50;
}
.sticky-content {
    background-color: rgba(12, 16, 29, 0.8);
    background-image: linear-gradient(rgba(12, 16, 29, 0.2) 1px, transparent 1px), linear-gradient(90deg, rgba(12, 16, 29, 0.2) 1px, transparent 1px);
    background-size: 15px 15px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 8px;
    padding: 0.5rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
    transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
}
.bottom-sticky-bar p {
    text-shadow: -0.5px -0.5px 0 #000, 0.5px -0.5px 0 #000, -0.5px 0.5px 0 #000, 0.5px 0.5px 0 #000;
}
.bottom-sticky-bar:hover .sticky-content {
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
}
--- END OF FILE: ./css/hud.css ---

--- START OF FILE: ./css/global.css ---
/* css/global.css */
/**
 * @fileoverview This file contains the global styles, font 
definitions,
 * utility classes, and base layout for the entire application.
 */

@font-face {
  font-family: 'Oxanium ExtraBold'; /* Choose a name for your font */
  src: url('fonts/Oxanium-ExtraBold.ttf') format('truetype'); /* Correct path to the font file */
  font-weight: 800; /* ExtraBold is typically 800 weight */
  font-style: normal;
}

@font-face {
  font-family: 'Oxanium Medium'; /* Name for the Medium weight */
  src: url('fonts/Oxanium-Medium.ttf') format('truetype'); /* Path to the Medium font file */
  font-weight: 500; /* Medium is 500 weight */
  font-style: normal;
}

@font-face {
  font-family: 'Zorque'; /* Name for the Zorque font */
  src: url('fonts/Zorque.otf') format('opentype'); /* Path to the Zorque font file 
*/
  font-weight: normal;
  font-style: normal;
}

:root {
    --app-height: 100%;
    /* Default/fallback height */
    --module-width: 100px;
    --font-size: 0.6rem;
    --border-radius: 20px;
    --toggle-height: 30px;
    --stepper-height: 30px;
    --button-height: 28px;
    --font-family: 'Orbitron', sans-serif;
    --buy-primary: #196a8f;
--buy-secondary-bg: #1e2a3e;
    --buy-secondary-border: #3c4e68;
    --buy-text-light: #8ca4b5;
    --buy-text-dark: #ddf3f8;
    --sell-primary: #a73535;
    --sell-secondary-bg: #293342;
    --sell-secondary-border: #63686e;
    --sell-text-light: #ff9999;
    --sell-text-dark: #f7cfcf;
    --max-bg: #303946;
    --max-text: #a5aab1;
}

html {
    padding: 0;
    margin: 0;
    height: 100%; /* MODIFIED: Ensure HTML fills the viewport */
}

body {
    /* height: 100vh; */ /* REMOVED */
    /* Fallback */
    /* height: var(--app-height); */ /* REMOVED: This was the JS override */
 
   height: 100dvh; /* MODIFIED: Make body fill 100% of dynamic viewport */
    overflow: hidden;
    margin: 0;
    /* MODIFIED: Re-enabled flex properties for scaling */
  
  display: flex;
    justify-content: center;
    align-items: center;
    font-family: 'Exo 2', sans-serif;
    background-color: #0c101d;
    color: #d0d8e8;
    -webkit-user-select: none;
    -ms-user-select: none;
    user-select: none;
    /* *** MODIFIED: REMOVED position: fixed and width: 100% *** */
}

*:focus {
    outline: none;
}

#debug-start-btn {
    position: absolute;
    bottom: 1rem;
    left: 1rem;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 1.2rem;
    font-family: 'Orbitron', sans-serif;
background-color: #4a5568;
    color: #1a202c;
    border: 2px solid #2d3748;
    z-index: 100;
}

.font-orbitron {
    font-family: 'Orbitron', sans-serif;
}

.font-roboto-mono {
    font-family: 'Roboto Mono', monospace;
}

.game-container {
   
 max-width: 1200px;
    width: 100%;
    height: 100dvh; /* MODIFIED: Use dynamic viewport height */
    margin: 0 auto; /* MODIFIED: Use auto margin to center on desktop */
    border: 2px solid #3a4a6a;
    border-radius: 55px;
    transition: background 0.5s ease-out, opacity 1s ease-in-out;
    box-shadow: 0 0 30px rgba(58, 74, 106, 0.4);
    display: flex;
    flex-direction: column;
    /* MODIFIED: Corrected safe-area-inset padding */
    padding: calc(1rem + env(safe-area-inset-top)) 1rem calc(1rem + env(safe-area-inset-bottom)) 1rem;
    box-sizing: border-box;
    overflow: hidden;
}

.game-container.fade-in {
    opacity: 1;
}

.game-container.fade-out {
    opacity: 0;
}


.main-content-wrapper {
   
 flex-grow: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-top: 1rem;
    min-height: 0;
    display: flex; /* ADDED */
    flex-direction: column; /* ADDED */
}

#main-content {
    
display: flex;
    flex-direction: column;
    height: 100%;
}

.scroll-panel {
    flex-grow: 1; /* MODIFIED: Allow panel to fill available space */
    overflow-y: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding: 0.25rem;
    touch-action: pan-y;
}

/* MODIFIED: REMOVED global scrollbar hiding rule */
/* .scroll-panel::-webkit-scrollbar { display: none; } */

.btn {
    transition: all 0.3s ease;
    border: 1px solid #4a6a8a;
    border-radius: 8px;
    background-color: #22304a;
    font-family: 'Orbitron', sans-serif;
    letter-spacing: 1px;
    padding: 0.5rem 0.75rem;
    color: #c0d0f0;
    -webkit-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

.btn-sm 
{
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}

#restart-game-container .btn {
    padding: 0.3rem 0.6rem;
    font-size: 0.875rem;
}

.btn:hover:not(:disabled) {
    
background-color: #32405a;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
    color: #e0f0ff;
}

.btn:disabled,
[disabled] {
    opacity: 0.4;
    cursor: not-allowed;
    filter: grayscale(80%);
}

.btn-intro-locked {
    filter: grayscale(1);
    opacity: 0.3;
    pointer-events: none;
}

.screen {
    display: none;
}

.active-screen {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    min-height: 0;
}

@keyframes fadeIn {
    from {
         opacity: 0;
        transform: scale(0.95);
    }

    to {
    
    opacity: 1;
        transform: scale(1);
    }
}

@keyframes fadeOut {
    from {
        
opacity: 1;
        transform: scale(1);
    }

    to {
        opacity: 0;
        transform: scale(0.95);
    }
}

@keyframes scanlineFadeOut {
    from {
        opacity: 1;
        -webkit-mask-position: 0 0;
        mask-position: 0 0;
    }

    to {
        opacity: 0;
        -webkit-mask-position: 0 100%;
        mask-position: 0 100%;
    }
}

@keyframes pulse-green-border {

     0%,
    100% {
        box-shadow: 0 
0 10px #10b981, inset 0 0 10px rgba(16, 185, 129, 0.3);
        border-color: #10b981;
    }

    50% {
   
     box-shadow: 0 0 20px #34d399, inset 0 0 15px rgba(52, 211, 153, 0.5);
        border-color: #34d399;
    }
}

@keyframes pulse-gold-border {

    0%,
    100% {
        box-shadow: 0 0 10px #D4AF37, inset 0 0 10px rgba(212, 175, 55, 0.3);
        border-color: #D4AF37;
    }

    50% {
        box-shadow: 0 0 20px #FFD700, inset 0 0 15px rgba(255, 215, 0, 0.5);
        border-color: #FFD700;
    }
}

@keyframes credits-pulse-glow {
    0% 
{
        text-shadow: 0 0 4px #7dd3fc, 0 0 8px #7dd3fc;
    }

 
   50% {
        text-shadow: 0 0 10px #0ea5e9, 0 0 16px #0ea5e9;
    }

    100% {
        text-shadow: 0 0 4px #7dd3fc, 0 0 8px #7dd3fc;
    }
}

/* --- VIRTUAL WORKBENCH: ADDED RED GLOW --- */
@keyframes pulse-red-glow {
    0% {
        text-shadow: 0 0 4px #f87171, 0 0 8px #f87171;
    }
    50% {
        text-shadow: 0 0 10px 
#ef4444, 0 0 16px #ef4444;
    }
    100% {
     
   text-shadow: 0 0 4px #f87171, 0 0 8px #f87171;
    }
}
/* --- END VIRTUAL WORKBENCH --- */

/* --- VIRTUAL WORKBENCH: REMOVED WHITE GLOW (REQUEST A) --- */
@keyframes pulse-white-glow {
    0%, 100% {
        /* Static black outline + base white glow */
        text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0 0 4px #e5e7eb, 0 0 8px #e5e7eb;
    }
    50% {
     
   /* Static black outline + bright white glow */
        text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0 0 10px #ffffff, 0 0 16px #ffffff;
    }
}
/* --- END VIRTUAL WORKBENCH --- */


@keyframes pulse-green-glow {

    0%,
    100% {
        text-shadow: 0 0 2px #16a34a, 0 0 4px #16a34a;
    }

    50% {
   
         text-shadow: 0 0 4px #22c55e, 0 0 8px #22c55e;
    }
}

/* --- VIRTUAL WORKBENCH: ADDED 'BOARD' 
BUTTON GLOW --- */
@keyframes pulse-cyan-button-glow {
    0%, 100% {
        background-color: var(--ot-cyan-base, #22d3ee);
        box-shadow: 0 0 8px var(--ot-cyan-glow, #67e8f9), 0 0 12px var(--ot-cyan-glow, #67e8f9);
        transform: scale(1);
    }
    50% {
        background-color: var(--ot-cyan-glow, #67e8f9);
        box-shadow: 0 0 16px var(--ot-cyan-glow, #67e8f9), 0 0 24px var(--ot-cyan-glow, #67e8f9);
        transform: scale(1.05);
    }
}
/* --- END VIRTUAL WORKBENCH --- */

/* --- VIRTUAL WORKBENCH: ADDED GOLD GLOW (Phase 1) --- */
@keyframes pulse-gold-glow {
    0%, 100% {
        text-shadow: 0 0 5px #fde047, 0 0 10px #fde047;
    }
    50% {
        text-shadow: 0 0 12px #fef08a, 0 0 20px #fef08a;
    }
}
/* --- END VIRTUAL WORKBENCH --- */


@keyframes float-up {
    from {
        transform: translateY(0);
        opacity: 1;
    }

    to {
        transform: translateY(-60px);
        opacity: 0;
    }
}

@keyframes shimmer {
 
 
  0% {
        background-position: -400px 0;
    }

    100% {
        background-position: 400px 0;
    }
}

@keyframes green-pulse {
    0% {
        box-shadow: 0 0 12px rgba(16, 185, 129, 0.6);
    }

 
    50% {
        box-shadow: 0 0 24px rgba(52, 211, 153, 0.9);
    }

    100% {
        box-shadow: 0 0 12px rgba(16, 185, 129, 0.6);
    }
}

@keyframes blue-pulse-glow {

    0%,
    100% {
   
     box-shadow: 0 0 16px rgba(96, 165, 250, 0.7), inset 0 0 12px rgba(96, 165, 250, 0.2);
    }

    50% {
        box-shadow: 0 0 16px rgba(96, 165, 250, 0.7), inset 0 0 12px rgba(96, 165, 250, 0.2);
    }
}

@keyframes flash-green {

 
    0%,
    100% {
        color: #34d399;
    }

    50% {
        color: #f0fdf4;
    }
}

@keyframes shimmer-effect {
    0% {
        background-position: -600px 0;
}

    100% 
{
        background-position: 600px 0;
    }
}

/* [[START]] VIRTUAL WORKBENCH (EULA Pulse) */
@keyframes pulse-eula-warning {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}
.pulse-eula-warning {
    animation: pulse-eula-warning 0.5s ease-in-out 2;
}
/* [[END]] VIRTUAL WORKBENCH (EULA Pulse) */

.highlight-current {
    border-color: #facc15;
}

.btn-pulse-green {
    animation: pulse-green-border 2s infinite;
}

.btn-pulse-gold {
    animation: pulse-gold-border 2s infinite;
}

.btn-pulse {
    animation: pulse-green-border 2.5s infinite;
}

.credits-text-pulsing {
    color: #7dd3fc;
    animation: credits-pulse-glow 2.5s infinite ease-in-out;
}

/* --- VIRTUAL WORKBENCH: ADDED RED GLOW CLASS --- */
.text-glow-red {
  
  color: #f87171;
    animation: pulse-red-glow 2.5s infinite ease-in-out;
}
/* --- END VIRTUAL WORKBENCH --- */

/* --- VIRTUAL WORKBENCH: ADDED GOLD GLOW CLASS (Phase 1) --- */
.text-glow-gold {
    color: #fde047; /* Match .hl color */
    animation: pulse-gold-glow 2.5s infinite ease-in-out;
}
/* --- END VIRTUAL WORKBENCH --- */

/* --- VIRTUAL WORKBENCH: REMOVED WHITE GLOW CLASS (REQUEST A) --- */
/* .text-glow-white class and @keyframes pulse-white-glow removed */
/* --- END VIRTUAL WORKBENCH --- */

.pulse-green-glow {
    animation: pulse-green-glow 2s infinite;
}

.hl {
 
    color: #fde047;
    font-weight: 700;
}

.hl-blue {
    color: #60a5fa;
    font-weight: 700;
}

.hl-red {
    color: #f87171;
    font-weight: 700;
}

.hl-green {
    color: #16a34a;
    font-weight: 700;
}

.hl-yellow {
    color: #facc15;
    font-weight: 700;
}

.text-outline {
    text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 
0 #000, 1px 1px 0 #000;
}

#save-toast,
#garnishment-toast,
#hull-warning-toast,
#starport-unlock-tooltip {
    z-index: 101;
}

#garnishment-toast {
    background-color: #991b1b;
    border: 1px solid #f87171;
    box-shadow: 0 0 15px rgba(248, 113, 113, 0.7);
}

#hull-warning-toast {
    background-color: #166534;
    border: 1px solid #34d399;
    box-shadow: 0 0 15px rgba(52, 211, 153, 0.7);
    text-shadow: 0 0 5px rgba(255, 255, 255, 0.7);
}

[data-tooltip] {
    position: relative;
}

.tooltip-container[data-tooltip]:hover::after,
.cargo-item-tooltip[data-tooltip]:hover::after,
.commodity-name-tooltip[data-tooltip]:hover::after,
.hanger-ship-name[data-tooltip]:hover::after,
.tooltip-active::after,
.tooltip-container-below[data-tooltip]:hover::after,
.loan-btn-tooltip[data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    background-color: #111827;
    color: #fff;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.875rem;
    white-space: pre-wrap;
    width: max-content;
    max-width: 220px;
    word-wrap: break-word;
    text-align: center;
    z-index: 100;
    display: block;
    pointer-events: none;
    font-family: 'Exo 2', sans-serif;
    left: 105%;
    top: 50%;
transform: translateY(-50%);
}

.loan-btn-tooltip[data-tooltip]:hover::after {
    font-family: 'Roboto Mono', monospace;
}

.tooltip-container-below[data-tooltip]:hover::after {
    top: 100%;
    margin-top: 5px;
}

#graph-tooltip {
    position: fixed;
    display: none;
    background-color: #111827;
    border: 1px solid #374151;
    border-radius: 8px;
    padding: 0.75rem;
    z-index: 60;
    pointer-events: none;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    white-space: pre-wrap;
    text-align: center;
    font-size: 0.875rem;
}

.generic-tooltip {
    position: fixed;
    display: none;
    background-color: #111827;
    border-radius: 6px;
    padding: 5px 10px;
    z-index: 60;
    pointer-events: none;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    white-space: pre-wrap;
    text-align: center;
    font-size: 0.875rem;
    color: #fff;
    font-family: 'Exo 2', sans-serif;
    max-width: 60vw;
}

.panel-border {
    position: relative;
}

.panel-border::before,
.panel-border::after {
   
 content: '';
    position: absolute;
    width: 15px;
    height: 15px;
    border-color: var(--theme-border-color, #7a9ac0);
    border-style: solid;
}

.panel-border::before {
    top: -2px;
    left: -2px;
    border-width: 2px 0 0 2px;
    border-top-left-radius: 10px;
}

.panel-border::after {
    bottom: -2px;
    right: -2px;
    border-width: 0 2px 2px 0;
    border-bottom-right-radius: 10px;
}

.floating-text {
    position: fixed;
    pointer-events: none;
    font-weight: 700;
    font-size: 1.25rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.7);
    z-index: 100;
    animation: float-up 2.5s forwards ease-out;
}

.cargo-item-card {
    width: 118px;
    height: 118px;
    border-radius: 8px;
    display: flex;
    position: relative;
    box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.4);
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-sizing: border-box;
}

.base-concept 
{
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    color: #fff;
    padding: 0;
}

.pt-header {
    display: flex;
    justify-content: space-between;
    width: 100%;
    padding: 4px 6px;
    background: rgba(0, 0, 0, 0.3);
    align-items: center;
    box-sizing: border-box;
    flex-shrink: 0;
}

.pt-number,
.pt-category {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.5rem;
    white-space: nowrap;
}

.pt-symbol-wrapper {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    line-height: 1;
}

.pt-symbol {
    font-family: 'Orbitron', sans-serif;
    font-weight: 900;
    font-size: 1.6rem;
    color: #333;
    -webkit-text-stroke: 1.1px #888;
    text-transform: uppercase;
}

.pt-quantity {
    font-family: 'Roboto Mono', monospace;
    font-size: 0.8rem;
    font-weight: 600;
    margin-top: 4px;
    text-shadow: 0 
0 6px rgba(0, 0, 0, 0.7);
}

.pt-name {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.5rem;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 4px 6px;
    flex-shrink: 0;
}

@media (min-width: 768px) {
    .game-container {
         padding: calc(0.6rem + env(safe-area-inset-top)) 2rem calc(2rem + env(safe-area-inset-bottom)) 2rem;
    }
}

@media (max-width: 768px) {

    .cargo-item-tooltip[data-tooltip]:hover::after,
    .commodity-name-tooltip[data-tooltip]:hover::after,
    .hanger-ship-name[data-tooltip]:hover::after {
        display: none;
    }

    #header-main {
        flex-wrap: wrap;
        justify-content: center;
    }
}

#orientation-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 
100vw;
    height: 100dvh;
    background-color: #0c101d;
    color: #d0d8e8;
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    font-family: 'Orbitron', sans-serif;
    font-size: 1.2rem;
    padding: 1rem;
    display: none;
}

@media (orientation: landscape) {
    #orientation-overlay {
         display: flex;
    }

    #game-container {
        display: none;
    }
}

/* --- [[START]] GENERIC ANIMATIONS --- */

/* --- VIRTUAL WORKBENCH --- */
/*
 * High-performance dematerialize animation for the card.
 * Animates opacity, transform, and clip-path.
 * clip-path: inset(Y X Y X) - animates from 0% (top/bottom) to 50% (center).
*/
@keyframes dematerialize-card {
    0% {
  
  
    opacity: 1;
        transform: scale(1);
        clip-path: inset(0% 0% 0% 0%);
    }
    60% {
        /* Apex of the shrink, matches user spec */
         opacity: 0.8; /* Keep it mostly visible during the wipe */
        transform: scale(0.9);
        clip-path: inset(25% 0% 25% 0%); /* Half-way wiped */
    }
    100% {
        opacity: 0;
        transform: scale(0.85);
        clip-path: inset(50% 0% 50% 0%); /* Fully collapsed to a line */
   
 }
}

/*
 * High-performance 
glow animation for the card's ::before pseudo-element.
 * Animates opacity and transform to create the "apex" glow.
*/
@keyframes dematerialize-glow {
    0% {
        opacity: 0;
        transform: scale(0.5);
    }
  
     60% {
        /* Apex of the glow, matches user spec */
        opacity: 1;
        /* VIRTUAL WORKBENCH: MODIFICATION (Request B) */
        transform: scale(2.6); /* Was 1.3 */
    }
    100% {
        opacity: 0;
        /* VIRTUAL 
WORKBENCH: MODIFICATION (Request B) */
        transform: scale(3.0); /* Was 2.0 */
    }
}

.is-dematerializing {
    /*
     * Applies a 1.5s dematerialization effect to the 
card.
     * 'forwards' holds the final state (opacity: 0).
    */
    animation: dematerialize-card 1.5s ease-in-out forwards;
    /* Prevent the invisible element from blocking clicks */
    pointer-events: none;
}
/* --- END VIRTUAL WORKBENCH --- */

/* --- VIRTUAL WORKBENCH: MODIFICATION (Phase 1 & 2) --- */
/* Added the .is-boarding::before selector */
.is-dematerializing::before,
.is-boarding::before {
    /*
     * Simultaneously applies the glow animation
   
  * to the pseudo-element created in hangar-screen.css.
    */
    /* VIRTUAL WORKBENCH: MODIFICATION (Request B) */
    animation: dematerialize-glow 2.5s ease-in-out forwards; /* Was 1.5s */
}
/* --- END VIRTUAL WORKBENCH --- */
/* --- [[END]] GENERIC ANIMATIONS --- */
--- END OF FILE: ./css/global.css ---

--- START OF FILE: ./css/modals.css ---
/* css/modals.css */

/* General Modal Backdrop Styling */
.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: var(--app-height, 100vh);
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 50;
    opacity: 0;
    transition: opacity 1s ease-out;
    pointer-events: none;
}

/* Special override for slow intro fade */
.intro-fade-in {
    transition-duration: 2s !important;
}
.intro-fade-in .modal-content {
    animation-duration: 2s !important;
}

/* Base styles for when a modal is active/visible */
.modal-backdrop:not(.hidden) {
    opacity: 1;
    pointer-events: auto;
}

/* General Modal Content Box Styling */
.modal-content {
    background-color: #111827;
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid #374151;
    box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    max-width: 90%;
    width: 400px;
}

/* State class for a modal that is currently visible */
.modal-visible .modal-content {
    animation: fadeIn 1s ease-out;
}

/* State class for a modal that is in the process of closing */
.modal-hiding {
    animation: fadeOut 1s ease-out forwards; /* Uses global fadeOut on backdrop */
}
.modal-hiding .modal-content {
    animation: fadeOut 1s ease-out forwards; /* Uses global fadeOut on content */
}

/* New class for the splash screen's unique exit animation */
.splash-screen-hiding {
    -webkit-mask-image: linear-gradient(to top, transparent 25%, black 75%);
    mask-image: linear-gradient(to top, transparent 25%, black 75%);
    -webkit-mask-size: 100% 400%;
    mask-size: 100% 400%;
    animation: scanlineFadeOut 2s ease-in-out forwards;
}


/* Specific Modal Styling */

/* Travel Animation Modal */
#travel-animation-modal.modal-backdrop {
    background-color: #0c101d; /* Use the game's base background color for a seamless transition */
    transition: opacity 0.5s ease-out; /* Add a fade for the modal itself to maintain a smooth feel */
}

#travel-animation-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    width: 90%;
    max-width: 800px;
    padding: 0;
    background: radial-gradient(circle, #1a2030 0%, #0c101d 100%);
    border-color: #4a6a8a;
    overflow: hidden;
}

#travel-header-panel, #travel-footer-panel {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.75rem 1.5rem;
    text-align: center;
    flex-shrink: 0;
    background-color: rgba(12, 16, 29, 0.5);
    z-index: 10;
}
#travel-header-panel {
    border-bottom: 1px solid #3a4a6a;
    min-height: 80px;
}
#travel-footer-panel {
    border-top: 1px solid #3a4a6a;
    min-height: 80px;
    justify-content: center;
}

#travel-progress-bar {
    box-shadow: 0 0 8px var(--progress-glow-color, #fff), 0 0 12px var(--progress-glow-color, #fff);
}


/* Map Detail Modal has its own animation override already */
#map-detail-modal .modal-backdrop:not(.hidden) .modal-content {
    animation: fadeIn 1s ease-out forwards;
}

/* --- [[START]] SIGNATURE MODAL KEYBOARD FIX --- */
#signature-modal {
    align-items: flex-start; /* Override the default vertical centering */
    padding-top: 15vh;      /* Push the modal down from the top edge */
}
/* --- [[END]] SIGNATURE MODAL KEYBOARD FIX --- */


/* Hide modal backdrops by default */
.modal-backdrop.hidden {
    display: none;
}

/* Disable pointer events on modals that shouldn't be dismissible */
.dismiss-disabled {
    pointer-events: none;
}

/* Ship Detail Modal */
#ship-detail-modal .modal-content {
    background: linear-gradient(145deg, #1f2937, #111827);
    border-color: #4b5563;
}

/* Launch Confirmation Modal */
#launch-modal {
    transition: opacity 0.7s ease-out;
}
#launch-modal.modal-visible .modal-content {
    animation: fadeIn 0.7s ease-out;
}
#launch-modal.modal-hiding {
    animation: fadeOut 0.7s ease-out forwards;
}
#launch-modal.modal-hiding .modal-content {
    animation: fadeOut 0.7s ease-out forwards;
}

#launch-modal .modal-content {
    padding: 0;
    background: transparent;
    border: none;
    box-shadow: none;
    width: auto; /* Allow the content to define the width */
    max-width: 450px;
}

.launch-modal-wrapper .flavor-text {
    font-size: 0.9rem;
    color: #cbd5e1;
    opacity: 0.8;
}

.launch-modal-wrapper .commodity-name {
    background-color: rgba(0, 0, 0, 0.3);
    padding: 2px 8px;
    border-radius: 5px;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

/* Cargo Detail Modal */
#cargo-detail-modal .modal-content {
    max-width: 320px;
    width: 100%;
}

.max-cargo-modal-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.max-cargo-modal-content .commodity-card {
    margin-bottom: 1rem;
    transform: scale(1.2); /* Make the card a bit larger */
}

/* Random Event Modal */
#random-event-modal .modal-content, #age-event-modal .modal-content {
    background: radial-gradient(circle, #2d3748, #1a202c);
    border: 2px solid #4a5568;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.6), inset 0 0 15px rgba(74, 85, 104, 0.3);
    text-align: center;
}

#random-event-modal h3, #age-event-modal h3 {
    font-family: 'Orbitron', sans-serif;
    color: #e2e8f0;
    text-shadow: 0 0 8px rgba(147, 197, 253, 0.4);
}

#random-event-choices-container {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    width: 100%;
    margin-top: 1rem;
}

/* Age Event / Perk Selection Modal */
#age-event-button-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 1.5rem;
}

.perk-button {
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    transition: all 0.2s ease-in-out;
}

.perk-button:hover {
    background-color: rgba(255, 255, 255, 0.1);
    border-color: #fde047;
    transform: translateY(-2px);
}

.perk-button h4 {
    font-family: 'Orbitron', sans-serif;
    color: #fde047;
    margin-bottom: 0.5rem;
}

.perk-button p {
    font-size: 0.875rem;
    color: #cbd5e1;
}


/* Processing / Loading Modal */
#processing-modal .modal-content {
    text-align: center;
}

.progress-bar-container {
    width: 100%;
    background-color: #2d3748;
    border-radius: 99px;
    height: 10px;
    margin: 1rem 0;
    overflow: hidden;
}

#processing-progress-bar {
    width: 0%;
    height: 100%;
    background-color: #60a5fa;
    transition: width 3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 99px;
}


/* Tutorial Skip Confirmation Modal */
#skip-tutorial-modal .modal-content {
    text-align: center;
}

#skip-tutorial-modal .button-group {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 1.5rem;
}


/* Tutorial Log Modal (DEPRECATED - was tooltip) */
#tutorial-log-modal {
    opacity: 0;
    transition: opacity 1s;
    pointer-events: none;
}
#tutorial-log-modal.visible {
    opacity: 1;
    pointer-events: auto;
}

#tutorial-log-modal .modal-content {
    max-height: 70vh;
    display: flex;
    flex-direction: column;
}

#tutorial-log-list {
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding-right: 0.5rem; /* For scrollbar */
}

/* --- [[START]] LORE MODAL --- */
#lore-modal .modal-content {
    width: 600px; /* Wider than default */
    max-width: 90vw;
    height: 70vh; /* Taller */
    max-height: 800px;
    display: flex;
    flex-direction: column;
}

#lore-modal-content {
    flex-grow: 1;
    overflow-y: auto;
    padding-right: 1rem; /* Space for scrollbar */
    font-size: 1.1rem;
    line-height: 1.6;
}
/* --- [[END]] LORE MODAL --- */

/* --- [[START]] VIRTUAL WORKBENCH (Ship Info Modal) --- */
/* REMOVED */
/* --- [[END]] VIRTUAL WORKBENCH (Ship Info Modal) --- */


/* --- [[START]] VIRTUAL WORKBENCH (EULA Modal) --- */
#eula-modal .modal-content {
    width: 600px; /* Wider than default */
    max-width: 90vw;
    height: 70vh; /* Taller */
    max-height: 800px;
    display: flex;
    flex-direction: column;
}

#eula-modal-content {
    flex-grow: 1;
    overflow-y: auto;
    padding-right: 1rem; /* Space for scrollbar */
    font-size: 1.1rem;
    line-height: 1.6;
}
/* --- [[END]] VIRTUAL WORKBENCH (EULA Modal) --- */


/* --- [[START]] GENERIC THEMED GLOW --- */
@keyframes themed-glow-animation {
    0%, 100% {
        box-shadow: 0 0 12px var(--theme-glow-color), inset 0 0 12px var(--theme-glow-color);
        border-color: var(--theme-glow-color);
    }
    50% {
        box-shadow: 0 0 24px var(--theme-glow-color), inset 0 0 16px var(--theme-glow-color);
        border-color: var(--theme-glow-color);
    }
}

.is-glowing {
    animation: themed-glow-animation 3s infinite;
}
/* --- [[END]] GENERIC THEMED GLOW --- */

/* --- [[START]] LAUNCH MODAL STYLES --- */
#launch-modal .modal-content {
    background: transparent;
    border: none;
    box-shadow: none;
    padding: 0;
}
.launch-modal-wrapper {
    position: relative;
    background: radial-gradient(circle, #1a2030 0%, #0c101d 100%);
    border: 2px solid;
    border-radius: 15px;
    padding: 1rem;
    width: 100%;
    max-width: 350px;
    height: 366px; /* Increased by 20% */
    margin: 0 auto;
    text-align: center;
    box-shadow: 0 0 25px rgba(0,0,0,0.7);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    gap: 1rem;
}
.launch-modal-wrapper h3 {
    font-size: 1.625rem; /* 26px */
}
.flavor-text {
    font-size: 0.8125rem; /* 13px, a 1pt reduction */
    opacity: 0.80;
}
.travel-info-text {
    font-size: 15px; /* Increased by 3pt from 12px */
    font-family: 'Roboto Mono', monospace;
}
@keyframes launch-glow-animation {
    0%, 100% {
        box-shadow: 0 0 8px var(--launch-glow-color), inset 0 0 8px var(--launch-glow-color);
    }
    50% {
        box-shadow: 0 0 16px var(--launch-glow-color), inset 0 0 12px var(--launch-glow-color);
    }
}
.btn-launch-glow {
    width: 130px;
    height: 130px;
    border-radius: 50%;
    background: radial-gradient(circle, #4a5568, #1a202c);
    color: white;
    font-size: 1.5rem;
    font-weight: bold;
    font-family: 'Orbitron', sans-serif;
    border: 4px solid var(--launch-glow-color);
    box-shadow: 0 5px 10px rgba(0,0,0,0.4), inset 0 2px 3px rgba(255,255,255,0.2), inset 0 -3px 5px rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    transition: all 0.1s ease-in-out;
    animation: launch-glow-animation 2.5s infinite;
    margin: 0 auto; /* Center the button */
    text-shadow: 0 0 5px #fff;
}

.btn-launch-glow:active {
    transform: translateY(2px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.4), inset 0 3px 5px rgba(0,0,0,0.5), inset 0 -1px 2px rgba(255,255,255,0.2);
}
/* --- [[END]] LAUNCH MODAL STYLES --- */

/* Loan Agreement Modal Title */
#charter-modal #charter-title {
    font-family: 'Zorque', sans-serif; /* MODIFIED */
    font-size: 1.95rem; /* Larger font size */
    text-align: center; /* Center-align text */
    width: 100%;       /* Ensure element spans modal width for centering */
}
--- END OF FILE: ./css/modals.css ---

--- START OF FILE: ./css/news-ticker.css ---
/* css/news-ticker.css */

#news-ticker-bar {
    width: 100%;
    height: 24px; /* Vertically thin, as requested */
    background-color: rgba(0, 0, 0, 0.3);
    border-top: 1px solid #2a3a5a;
    border-bottom: 1px solid #2a3a5a;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
    overflow: hidden; /* This is crucial */
    position: relative;
    display: flex;
    align-items: center;
    /* Added transition for smooth theme changes */
    transition: background-image 0.5s ease, border-color 0.5s ease, background-color 0.5s ease;
    /* Added rounded bottom corners */
    border-bottom-left-radius: 17px;
    border-bottom-right-radius: 17px;
}

.news-ticker-content {
    display: block;
    white-space: nowrap; /* Prevents text from wrapping */
    position: absolute;
    
    /* MODIFIED: Animation properties separated */
    animation-name: scroll-ticker;
    animation-duration: 120s; /* Fallback duration */
    animation-timing-function: linear;
    animation-iteration-count: infinite;
    
    /* Font styling */
    font-family: 'Oxanium Medium', 'Exo 2', sans-serif;
    font-weight: 500;
    font-size: 0.85rem;
    color: var(--ot-text-primary, #d0d8e8);
}

.news-ticker-content:hover {
    animation-play-state: paused; /* Pause scroll on hover */
}

/*
 * The scrolling animation. 
 * MODIFIED: Starts at 0 and moves left by 50% of its (now duplicated) width
 * to create a seamless loop.
 */
@keyframes scroll-ticker {
    0%   { transform: translateX(0); }
    100% { transform: translateX(-50%); }
}

/* --- Message Type Styling --- */

.ticker-separator {
    color: var(--color-text-secondary);
    opacity: 0.7;
    white-space: nowrap;
    margin: 0 0.75rem;
}

.ticker-message {
    display: inline;
    white-space: nowrap;
    padding: 0 1rem;
    /* Fallback color */
    color: var(--color-text-primary);
}

/* --- UPDATED & NEW V2 STYLES --- */

/* SYSTEM: bold white */
.ticker-message[data-type="SYSTEM"] {
    color: var(--color-white);
    font-weight: bold;
    font-style: normal; /* Override old style */
}

/* INTEL: credit-blue */
.ticker-message[data-type="INTEL"] {
    color: var(--color-credit-blue);
    font-style: normal; /* Override old style */
}

/* FLAVOR: Default color, italics removed. */
/* Color is now applied dynamically via inline style in NewsTickerService.js */
.ticker-message[data-type="FLAVOR"] {
    color: var(--color-text-primary); /* Base color, will be overridden */
    font-style: normal; /* Override old style */
}

/* ALERT: red, all caps, bold */
.ticker-message[data-type="ALERT"] {
    color: var(--color-red);
    font-weight: bold;
    text-transform: uppercase;
    font-style: normal;
}

/* STORY: golden yellow, bold, italicized */
.ticker-message[data-type="STORY"] {
    color: var(--color-golden-yellow);
    font-weight: bold;
    font-style: italic;
}

/* STATUS: green, all caps */
.ticker-message[data-type="STATUS"] {
    color: var(--color-green);
    text-transform: uppercase;
    font-style: normal;
}
--- END OF FILE: ./css/news-ticker.css ---

--- START OF FILE: ./css/screens/services-screen.css ---
/* css/screens/services-screen.css */

/* --- VIRTUAL WORKBENCH: ADD INTEL-THEMED HEADER STYLES --- */
.themed-header-bar {
    position: relative;
    display: flex;
    flex-direction: column; /* MODIFIED: Stack title and subtitle */
    justify-content: center;
    align-items: center; /* MODIFIED: Center align content */
    
    background-color: #0D1117; /* bg-[#0D1117] */
    border: 1px solid var(--theme-border-color, #334155);
    border-radius: 0.375rem; /* rounded-md */
    padding: 0.125rem; /* p-0.5 */
    
    width: 100%;
    flex-shrink: 0; /* Prevent shrinking */
    
    /* VIRTUAL WORKBENCH: MODIFIED margin-bottom */
    margin-bottom: 0.25rem; /* reduced from 0.75rem */
}

/* Selector to remove margin only from the ship-header's bar */
.ship-services-panel .themed-header-bar {
    margin-bottom: 0;
}

.themed-header-title {
    position: relative; 
    z-index: 10;
    flex: 1 1 0; /* flex-1 */
    width: 100%; /* Ensure it spans the bar */

    font-family: 'Orbitron', sans-serif;
    /* VIRTUAL WORKBENCH: Increased font size (Request A) */
    font-size: 1.3rem; /* 20.8px */
    font-weight: 700;
    
    color: var(--theme-text-color, #f0f0f0);
    background: var(--theme-gradient, linear-gradient(135deg, #4a5568, #2d3748));
    box-shadow: 0 0 10px -2px var(--theme-border-color, #4a5568);

    padding: 0.375rem 1rem; /* py-1.5 */
    
    text-transform: uppercase;
    letter-spacing: 0.05em; /* tracking-wider */
    text-align: center;

    border-radius: 0.375rem; /* rounded-md */
    
    /* ADDED: Clip-path for inner bevel, matching intel screen */
    clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
}

/* NEW: Ship Header Title (Request B & C) */
.ship-header-title {
    position: relative; 
    z-index: 10;
    flex: 1 1 0;
    width: 100%;
    font-family: 'Space Mono', monospace; /* MODIFIED: New Font */
    font-size: 1.2rem; /* 19.2px */
    font-weight: 700;
    color: var(--theme-text-color, #f0f0f0); /* MODIFIED: Set color */
    text-transform: uppercase; /* ADDED: All caps */
    text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; /* ADDED: Outline */
    background: var(--theme-gradient, linear-gradient(135deg, #4a5568, #2d3748));
    box-shadow: 0 0 10px -2px var(--theme-border-color, #4a5568);
    padding: 0.25rem 1rem; /* Smaller padding */
    letter-spacing: 0.05em;
    text-align: center;
    border-radius: 0.375rem;
    clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
}


/* REMOVED: .themed-header-subtitle (Request C) */

/* NEW: Ship Services Panel (Request A & C) */
.ship-services-panel {
    background: rgba(13, 17, 23, 0.4); /* MODIFIED: Lighter background */
    border: 1px solid var(--theme-border-color, #4a6a8a);
    border-radius: 0.375rem; /* rounded-md */
    /* Padding is handled by children */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
}
/* --- END VIRTUAL WORKBENCH --- */


.services-scroll-panel {
    overflow-y: auto;
    scrollbar-width: none; /* For Firefox */
    -ms-overflow-style: none; /* For Internet Explorer 10+ */
    padding: 0.25rem;
    touch-action: pan-y; /* Allow vertical scrolling */
    
    /* VIRTUAL WORKBENCH: Added flex properties */
    flex-grow: 1;
    min-height: 0;
    /* --- END VIRTUAL WORKBENCH --- */
}
.services-scroll-panel::-webkit-scrollbar {
    display: none; /* For Chrome, Safari, and Opera */
}

/* Add New Styles for Overhauled Services Screen */

/* Fonts (ensure these are loaded in index.html) */
.font-orbitron { font-family: 'Orbitron', sans-serif; }
.font-electrolize { font-family: 'Electrolize', sans-serif; }

/* Text Outline Effect */
.text-outline {
  text-shadow:
    -1px -1px 1px #000,
    1px -1px 1px #000,
    -1px  1px 1px #000,
    1px  1px 1px #000,
    0 0 4px #000,
    0 0 8px var(--glow-color, rgba(0,0,0,0.8));
}

/* Engraved Text Effect */
.engraved-text {
  text-shadow: 0 1px 1px rgba(0,0,0,0.6), 0 -1px 1px rgba(255,255,255,0.1);
}

/* Base Service Module Styling */
.service-module {
  border: 1px solid rgba(var(--resource-color-rgb), 0.3);
  /* MODIFIED: Added 400ms transition for smooth fade-out */
  transition: border-color 0.4s ease-out, box-shadow 0.4s ease-out;
  padding: 1rem;
  border-radius: 0.75rem;
  background-color: #2a2a2a;
  background-image:
    radial-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
    linear-gradient(#3a3a3a, #2a2a2a);
  background-size: 8px 8px, 100% 100%;
  box-shadow:
    0 0 15px -3px rgba(var(--resource-color-rgb), 0.3), /* Subdued resource glow */
    inset 0 0 0 2px rgba(255,255,255,0.05),
    inset 0 0 15px rgba(0,0,0,1),
    0 1px 0 rgba(255,255,255,0.05);
}

/* Active Service Module Glow */
.service-module.active-service {
  border-color: rgba(var(--resource-color-rgb), 0.8);
  box-shadow:
    0 0 25px -2px rgba(var(--resource-color-rgb), 0.7), /* Brighter active glow */
    inset 0 0 0 2px rgba(255,255,255,0.05),
    inset 0 0 15px rgba(0,0,0,1),
    0 1px 0 rgba(255,255,255,0.05);
}

/* Progress Bar Housing */
.bar-housing {
  background-color: rgba(0,0,0,0.4);
  padding: 0.5rem;
  border-radius: 0.5rem;
  box-shadow: inset 0 2px 6px rgba(0,0,0,0.6);
  margin-bottom: 1rem; /* Added margin */
}

.progress-bar-container {
   border-radius: 0.5rem; /* rounded-lg */
   border-width: 1px; /* border */
   overflow: hidden;
   position: relative;
   background: rgba(10, 20, 30, 0.5);
   box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
   /* MODIFIED: Added 400ms transition for smooth fade-out */
   transition: border-color 0.4s ease-out, box-shadow 0.4s ease-out;
}

/* Active Border Pulse Animation */
@keyframes pulse-border {
  0%, 100% {
    border-color: rgba(var(--resource-color-rgb), 0.3);
    box-shadow: 0 0 8px rgba(var(--resource-color-rgb), 0.1), inset 0 0 4px rgba(var(--resource-color-rgb), 0.1), inset 0 2px 5px rgba(0,0,0,0.5);
  }
  50% {
    border-color: rgba(var(--resource-color-rgb), 0.8);
    box-shadow: 0 0 20px rgba(var(--resource-color-rgb), 0.5), inset 0 0 8px rgba(var(--resource-color-rgb), 0.3), inset 0 2px 5px rgba(0,0,0,0.5);
  }
}

.progress-bar-container.active-pulse {
   /* MODIFIED: Ensure animation is infinite */
   animation: pulse-border 3s ease-in-out infinite;
}

/* Progress Bar Fill Styling */
.progress-bar-fill {
  /* MODIFIED: Added 400ms transition for smooth fade-out */
  transition: width 0.25s ease-out, filter 0.4s ease-out, box-shadow 0.4s ease-out, opacity 0.4s ease-out;
  box-shadow: 0 0 8px rgba(var(--resource-color-rgb), 0.5); /* Base glow using CSS var */
  position: relative;
  overflow: hidden;
  border-radius: 0.375rem; /* rounded-md */
}

/* MODIFIED: Added new animation for the fill bar itself */
@keyframes pulse-glow {
  0%, 100% {
    filter: brightness(1.1);
    box-shadow: 0 0 15px var(--glow-color), inset 0 0 4px var(--glow-color);
  }
  50% {
    filter: brightness(1.4);
    box-shadow: 0 0 25px var(--glow-color), inset 0 0 8px var(--glow-color);
  }
}

.progress-bar-fill.filling {
  /* MODIFIED: Ensure animation is infinite */
  animation: pulse-glow 3s ease-in-out infinite;
}

/* Control Deck (Buttons and Price) */
.control-deck {
  padding-top: 1rem;
}

/* Price Display Module */
.price-display-module {
  background: linear-gradient(#2a2a2a, #1a1a1a);
  border-radius: 0.75rem; /* rounded-xl */
  border: 2px solid #000;
  box-shadow: inset 0 0 8px rgba(0,0,0,0.8), 0 1px 0 rgba(255,255,255,0.1);
  color: #a0a0a0; /* Default text color */
}
.price-display-module .price-label {
  letter-spacing: 0.05em;
}
.price-display-module .price-digits {
  font-family: 'Orbitron', sans-serif;
  text-shadow: 0 0 4px var(--tw-shadow-color), 0 0 8px var(--tw-shadow-color);
}

/* Industrial Button Styling */
.industrial-button {
  border-radius: 0.75rem; /* rounded-xl */
  background: linear-gradient(180deg, #6b7280 0%, #374151 100%);
  border: 1px solid #1f2937;
  border-top-color: #9ca3af;
  border-left-color: #6b7280; /* Corrected typo */
  box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.25), 0 2px 3px rgba(0,0,0,0.6);
  color: #e5e7eb;
  text-shadow: 0 -1px 1px rgba(0,0,0,0.6);
  /* MODIFIED: Added 400ms transition for smooth fade-out */
  transition: background 0.4s ease-out, box-shadow 0.4s ease-out, transform 0.1s ease-in-out;
}

/* MODIFIED: Changed selector to rely only on .holding class for persistent depressed state */
.industrial-button.holding {
  background: linear-gradient(180deg, #374151 0%, #4b5563 100%);
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.6);
  transform: translateY(1px); /* Keep the pressed down visual */
}

/* MODIFIED: Added separate :active state for instant visual feedback on tap */
.industrial-button:active {
  transform: translateY(1px); /* Apply press down immediately */
}

.industrial-button:disabled {
  background: #374151;
  opacity: 0.6;
  cursor: not-allowed;
  transform: translateY(0);
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
}

/* Add styles for stepper active state if needed, though they might already exist */
.qty-stepper.stepper-active {
    /* Your existing stepper active styles */
    /* Example: border-color: var(--active-primary); */
}

/* Button Text Colors */
#refuel-btn .engraved-text {
  color: var(--ot-cyan-base, #08d9d6);
}

#repair-btn .engraved-text {
  color: var(--ot-green-accent, #16a34a);
}
--- END OF FILE: ./css/screens/services-screen.css ---

--- START OF FILE: ./css/screens/map-screen.css ---
/* css/screens/map-screen.css */
/* --- VIRTUAL WORKBENCH --- */
/* This file is a complete rewrite for the new Hybrid Layering architecture. */

#map-container {
    width: 100%;
    height: 100%;
    position: relative;
    -webkit-overflow-scrolling: touch;
    touch-action: pan-y;
    /* --- VIRTUAL WORKBENCH: REMOVED overflow: hidden to fix scrolling --- */

    /* Hide scrollbar */
    scrollbar-width: none; /* For Firefox */
}

#map-container::-webkit-scrollbar {
    display: none; /* For Webkit browsers */
}

/* --- 1. LAYER SCAFFOLDING --- */

/* The SVG "Substrate" layer (bottom) */
#map-svg-substrate {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    /* height is set dynamically by JS */
    z-index: 1;
    pointer-events: none; /* Pass clicks through */
}

/* The HTML "Interface" layer (top) */
#map-html-interface {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    /* height is set dynamically by JS */
    z-index: 10;
    pointer-events: none; /* Pass clicks through by default */
    /* --- VIRTUAL WORKBENCH: MOVED overflow: hidden here to clip the Sun --- */
    overflow: hidden;
}

/* --- 2. SVG SUBSTRATE STYLES --- */

/* --- VIRTUAL WORKBENCH: Removed #map-svg-substrate .sun rule --- */

#map-svg-substrate .central-axis {
    stroke: rgba(255, 255, 255, 0.1);
    stroke-width: 1;
}

#map-svg-substrate .leader-line {
    stroke: rgba(255, 255, 255, 0.2);
    stroke-width: 2.5;
}

/* --- 3. HTML INTERFACE STYLES --- */

/* --- VIRTUAL WORKBENCH: New rules for the HTML Sun --- */
#map-sun-poi {
    position: absolute;
    z-index: 2; /* Above substrate, below POIs */
    border-radius: 50%;
    /* Mimic the old SVG gradient */
    background: radial-gradient(circle, #fef08a 0%, #fde047 100%);
    /* Center on its coordinates */
    transform: translate(-50%, -50%);
}

/* Static, filter-less glow for the HTML Sun */
#map-sun-poi::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 100%;
    height: 100%;
    /* Reliable radial-gradient glow */
    background: radial-gradient(circle, #fde047 20%, transparent 70%);
    border-radius: 50%;
    z-index: -1;
    /* Static (non-animated) glow */
    transform: translate(-50%, -50%) scale(1.2);
    opacity: 1;
}
/* --- END VIRTUAL WORKBENCH --- */


/* The parent <div> for a POI, positioned at the (Y) coordinate */
.poi-marker-group {
    /* pointer-events are re-enabled on the clickable groups */
    pointer-events: auto;
    cursor: pointer;
    /* This empty transform is a hint for hardware acceleration */
    transform: translateZ(0);
}

/* The POI icon (planet/station) */
.poi-icon {
    position: absolute; /* Relative to its group */
    border: 2px solid #0c101d; /* Mimics old SVG stroke */
    /* Nudge to center it on the (X, Y) coordinate */
    transform: translate(-50%, -50%);
    z-index: 12;
}
.poi-icon.planet {
    border-radius: 50%;
}
.poi-icon.belt {
    /* Recreate the diamond shape */
    border-radius: 0;
    clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
}

/* The POI text label */
.poi-label {
    position: absolute; /* Relative to its group */
    font-family: 'Orbitron', sans-serif;
    color: #d0d8e8;
    font-size: 0.9rem;
    /* Mimic the SVG stroke with text-shadow */
    text-shadow: 
        0 0 3px #0c101d,
        0 0 3px #0c101d,
        0 0 3px #0c101d;
    
    /* Nudge to center it vertically */
    transform: translateY(-50%);
    white-space: nowrap;
    z-index: 11;
}
/* Apply D3-calculated text-anchor */
.poi-label[style*="text-anchor: end"] {
    transform: translate(-100%, -50%);
}

/* --- 4. "FILTER-LESS" GLOW ANIMATIONS --- */
/* This is the new, reliable glow system */

/* Keyframes for the text glow */
@keyframes pulse-text-glow {
    0%, 100% {
        /* --theme-glow-color is set on #map-container by JS */
        text-shadow: 0 0 4px var(--theme-glow-color), 0 0 3px #0c101d;
    }
    50% {
        /* --- VIRTUAL WORKBENCH: Doubled radius from 12px to 24px --- */
        text-shadow: 0 0 24px var(--theme-glow-color), 0 0 3px #0c101d;
    }
}

/* Keyframes for the icon glow (pulsing a pseudo-element) */
@keyframes pulse-html-glow {
    0%, 100% {
        opacity: 0.7;
        transform: translate(-50%, -50%) scale(1);
    }
    50% {
        opacity: 1;
        /* --- VIRTUAL WORKBENCH: Doubled radius from scale(1.6) to scale(2.2) --- */
        transform: translate(-50%, -50%) scale(2.2);
    }
}

/* Create the pseudo-element for the icon glow */
.poi-icon::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 100%;
    height: 100%;
    /* Create the glow with a radial gradient (no filters!) */
    background: radial-gradient(circle, var(--theme-glow-color) 20%, transparent 70%);
    border-radius: 50%;
    z-index: -1;
    transform: translate(-50%, -50%);
    opacity: 0;
    transition: opacity 0.3s ease;
}
.poi-icon.belt::before {
    border-radius: 0; /* Match belt shape */
}

/* --- 5. APPLY ANIMATIONS TO CURRENT LOCATION --- */

/* Apply the text glow */
.poi-marker-group.current-location .poi-label {
    /* --- VIRTUAL WORKBENCH: Increased speed from 2.5s to 2.1s --- */
    animation: pulse-text-glow 2.1s infinite;
}

/* Apply the icon glow */
.poi-marker-group.current-location .poi-icon::before {
    /* --- VIRTUAL WORKBENCH: Increased speed from 2.5s to 2.1s --- */
    animation: pulse-html-glow 2.1s infinite;
}

/* --- 6. LEGACY MODAL STYLES (Unchanged) --- */
@keyframes map-modal-glow {
    0%, 100% {
        box-shadow: 0 0 12px var(--theme-glow-color), inset 0 0 12px var(--theme-glow-color);
        border-color: var(--theme-glow-color);
    }
    50% {
        box-shadow: 0 0 24px var(--theme-glow-color), inset 0 0 16px var(--theme-glow-color);
        border-color: var(--theme-glow-color);
    }
}

#map-detail-modal .modal-content {
    background: transparent;
    border: none;
    position: relative;
}

#map-detail-modal .modal-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 12px;
    border: 2px solid var(--theme-glow-color);
    z-index: -1;
}

#map-detail-modal.is-glowing .modal-content::before {
    animation: map-modal-glow 3s infinite;
}

#map-detail-modal.modal-visible .modal-content {
    animation: fadeIn 0.3s ease-out forwards;
}

.imprinted-text {
    color: #e0e0e0;
    text-shadow: 0 -1px 1px rgba(0,0,0,0.5);
}

.map-intel-block {
    text-align: center;
    background-color: rgba(0,0,0,0.3);
    border-radius: 0.5rem;
    padding: 0.75rem;
}

.map-intel-block h5 {
    font-size: 0.875rem;
    line-height: 1.25rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #9ca3af;
    margin-bottom: 0.5rem;
}

.imprinted-text-embedded {
    background-color: rgba(0, 0, 0, 0.3);
    border-radius: 0.375rem;
    padding: 0.5rem 0.75rem;
    color: #e5e7eb;
    font-size: 0.875rem;
    line-height: 1.25rem;
    box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.2);
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.market-profile-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.commodity-tag {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 99px;
    font-family: 'Roboto Mono', monospace;
    font-size: 0.75rem;
    border-width: 1px;
    border-style: solid;
    margin: 0.25rem;
}
--- END OF FILE: ./css/screens/map-screen.css ---

--- START OF FILE: ./css/screens/market-screen.css ---
/* css/screens/market-screen.css */
:root {
    /* Card Appearance */
    --market-card-height: 160px;
    --market-card-min-height: 40px;
    --market-card-border-radius: 21px;
    --market-card-gradient-angle: 45deg;

    /* Positioning */
    --market-card-info-top: 7px;
    --market-card-info-left: 16px;
    --market-card-module-top: 13px;
    --market-card-module-right: 12px;
    --market-card-pinv-top: 34px;
    --market-card-pinv-left: 74px;
    --market-card-avail-top: 29px;
    --market-card-avail-left: 17px;
    --market-card-price-top: 58px;
    --market-card-price-left: 16px;

    /* Spacing */
    --market-card-price-indicator-v-gap: 7px;

    /* Name Text */
    --market-card-name-font-size: 0.95rem;
    --market-card-name-color: #ffffff;
    --market-card-name-text-shadow: 1.00px 0.00px 0 #000000, 0.71px 0.71px 0 #000000, 0.00px 1.00px 0 #000000, -0.71px 0.71px 0 #000000, -1.00px 0.00px 0 #000000, -0.71px -0.71px 0 #000000, 0.00px -1.00px 0 #000000, 0.71px -0.71px 0 #000000, -0.5px 0px 3px #000000;

    /* Player Inventory Text */
    --market-card-pinv-font-size: 0.65rem;
    --market-card-pinv-color: #e8e8e8;
    --market-card-pinv-own-color: #ffea00;
    --market-card-pinv-own-font-size: 0.85rem;
    --market-card-pinv-text-shadow: 0.40px 0.00px 0 #000000, 0.28px 0.28px 0 #000000, 0.00px 0.40px 0 #000000, -0.28px 0.28px 0 #000000, -0.40px 0.00px 0 #000000, -0.28px -0.28px 0 #000000, 0.00px -0.40px 0 #000000, 0.28px -0.28px 0 #000000, 0px 1.5px 2.5px #616b70;

    /* Avail Text */
    --market-card-avail-font-size: 0.8rem;
    --market-card-avail-color: #ffffff;
    --market-card-avail-text-shadow: 0.70px 0.00px 0 #292929, 0.49px 0.49px 0 #292929, 0.00px 0.70px 0 #292929, -0.49px 0.49px 0 #292929, -0.70px 0.00px 0 #292929, -0.49px -0.49px 0 #292929, 0.00px -0.70px 0 #292929, 0.49px -0.49px 0 #292929, -0.5px 1.5px 3.5px #554a4a;

    /* Price Text */
    --market-card-price-font-size: 1.85rem;
    --market-card-price-color: #29f1ff;
    --market-card-price-font-family: 'Roboto Mono', monospace;
    --market-card-price-text-shadow: 0 0 20px #16a8bb, 1.10px 0.00px 0 #000000, 0.78px 0.78px 0 #000000, 0.00px 1.10px 0 #000000, -0.78px 0.78px 0 #000000, -1.10px 0.00px 0 #000000, -0.78px -0.78px 0 #000000, 0.00px -1.10px 0 #000000, 0.78px -0.78px 0 #000000, 0px 0px 20px #28d5d7;

    /* Effective Price Text */
    --market-card-effective-price-top: 105px;
    --market-card-effective-price-left: 16px;
    --market-card-effective-price-font-size: 0.75rem;
    --market-card-effective-price-color: #ffffff;
    --market-card-effective-price-text-shadow: 0.70px 0.00px 0 #292929, 0.49px 0.49px 0 #292929, 0.00px 0.70px 0 #292929, -0.49px 0.49px 0 #292929, -0.70px 0.00px 0 #292929, -0.49px -0.49px 0 #292929, 0.00px -0.70px 0 #292929, 0.49px -0.49px 0 #292929, -0.5px 1.5px 3.5px #554a4a;

    /* Module */
    --market-card-module-width: 122px;
    --market-card-module-v-gap: 7.1px;
    --market-card-module-toggle-height: 25px;
    --market-card-module-stepper-height: 50px;
    --market-card-module-button-height: 29px;
    --market-card-module-stepper-arrow-size: 1.4em;
    --font-size: 0.85rem; /* Overriding global for module */

    /* Glassy Theme Colors */
    --buy-primary: #146171;
    --sell-primary: #a73535;
    --buy-secondary-bg: linear-gradient(145deg, rgba(20,20,30,0.2), rgba(0,0,0,0.5));
    --buy-secondary-border: 1px solid rgba(255,255,255,0.1);
    --buy-text-light: #c8d8e8;
    --buy-text-dark: #ffffff;

    --sell-secondary-bg: linear-gradient(145deg, rgba(30,20,20,0.2), rgba(0,0,0,0.5));
    --sell-secondary-border: 1px solid rgba(255,255,255,0.1);
    --sell-text-light: #e8c8c8;
    --sell-text-dark: #ffffff;

    --max-bg: rgba(48, 57, 70, 0.7);
    --max-text: #a5aab1;
    --max-border: rgba(255, 255, 255, 0.1);
    /* Correct "out" (unpressed) shadow */
    --max-shadow-outset: 0 1px 2px rgba(0, 0, 0, 0.5); 
    /* Correct "in" (pressed) shadow */
    --max-shadow-inset: inset 0 1px 3px rgba(0, 0, 0, 0.6); 


    /* Indicators */
    --market-card-indicator-top: 123px;
    --market-card-indicator-left: 16px;
    --market-card-indicator-h-spacing: 6px;
    --market-card-indicator-v-spacing: 3px;
    --market-card-indicator-font-size: 0.7em;
    --market-card-indicator-padding: 0.1em 0.5em;
    --market-card-indicator-positive-bg: rgb(16, 185, 129);
    --market-card-indicator-negative-bg: rgb(220, 38, 38);
    --market-card-indicator-neutral-bg: rgb(115, 115, 115);
    --market-card-indicator-positive-color: #ffffff;
    --market-card-indicator-negative-color: #fee2e2;
    --market-card-indicator-neutral-color: #e5e5S;
}

.item-card-container {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    position: relative;
}

/* This is the main card element */
.item-card-container > div {
    position: relative;
    height: var(--market-card-height);
    border-radius: var(--market-card-border-radius);
    padding: 0;
    transition: height 0.3s ease-in-out;
    overflow: hidden; /* This is what was clipping the button. The button is now outside this div. */
}

.item-card-container.minimized > div {
    height: var(--market-card-min-height);
}


/* --- [[START]] MODIFIED LICENSE LOCK STYLES --- */
/* ... */

/* Container for the license-locked content */
.license-locked-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    cursor: pointer;
    color: rgba(255, 255, 255, 0.7);
    transition: all 0.2s ease-out;
    overflow: hidden;
    z-index: 1;
}

/* Hover effect */
.license-locked-content:hover {
    color: rgba(255, 255, 255, 1);
    background-color: rgba(0,0,0,0.1);
}

/* Sideways Tier watermark (Change c) */
.license-locked-tier-watermark {
    position: absolute;
    right: -25px; /* Adjust positioning */
    top: 50%;
    transform: translateY(-50%) rotate(-90deg); /* Change c: Flipped rotation */
    font-family: 'Orbitron', sans-serif;
    font-size: 3.0rem; /* Change c: Slightly smaller */
    font-weight: 900;
    color: rgba(255, 255, 255, 0.08); /* Change c: Slightly more visible */
    letter-spacing: 0.1em;
    pointer-events: none;
    z-index: -1;
    text-shadow: none;
}

/* Styles for the lock badge */
.sci-fi-lock-badge {
    opacity: 0.6;
    filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));
    transition: all 0.2s ease-out;
}

/* Hover effect for badge */
.license-locked-content:hover .sci-fi-lock-badge {
    opacity: 0.85;
    transform: scale(1.05);
}

/* Styles for the "TIER X LICENSE" text (Changes a & b) */
.license-required-text {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.62rem; /* Change a: Increased size (0.9rem * 1.8 = 1.62rem) */
    margin-top: 0.5rem;
    font-weight: bold;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    text-align: center;
    padding: 0 0.5rem;
    color: #ffffff;
    /* Change b: Darker shadow + adjusted glow */
    text-shadow: 0 0 12px rgba(255, 255, 255, 0.6), /* Slightly reduced glow intensity */
                 0 0 6px rgba(255, 255, 255, 0.4),
                 1px 1px 5px rgba(0,0,0,0.9); /* Darker, larger shadow */
}
/* --- [[END]] MODIFIED LICENSE LOCK STYLES --- */


.commodity-name {
    position: absolute;
    top: var(--market-card-info-top);
    left: var(--market-card-info-left);
    font-family: 'Roboto Mono', monospace;
    font-size: var(--market-card-name-font-size);
    color: var(--market-card-name-color);
    text-shadow: var(--market-card-name-text-shadow);
}

.price-text {
    position: absolute;
    top: var(--market-card-price-top);
    left: var(--market-card-price-left);
    font-size: var(--market-card-price-font-size);
    color: var(--market-card-price-color);
    text-shadow: var(--market-card-price-text-shadow);
    font-family: var(--market-card-price-font-family);
    cursor: pointer;
}

.profit-text {
    position: absolute;
    top: var(--market-card-price-top);
    left: var(--market-card-price-left);
    font-size: var(--market-card-price-font-size);
    font-family: var(--market-card-price-font-family);
    color: #4ade80; /* bright green */
    text-shadow: 0 0 20px #16a34a, 0 0 10px #22c55e, 1.10px 0.00px 0 #000000, 0.78px 0.78px 0 #000000, 0.00px 1.10px 0 #000000, -0.78px 0.78px 0 #000000, -1.10px 0.00px 0 #000000, -0.78px -0.78px 0 #000000, 0.00px -1.10px 0 #000000, 0.78px -0.78px 0 #000000;
}

.loss-text {
    position: absolute;
    top: var(--market-card-price-top);
    left: var(--market-card-price-left);
    font-size: var(--market-card-price-font-size);
    font-family: var(--market-card-price-font-family);
    color: #f87171; /* bright red */
    text-shadow: 0 0 20px #b91c1c, 0 0 10px #ef4444, 1.10px 0.00px 0 #000000, 0.78px 0.78px 0 #000000, 0.00px 1.10px 0 #000000, -0.78px 0.78px 0 #000000, -1.10px 0.00px 0 #000000, -0.78px -0.78px 0 #000000, 0.00px -1.10px 0 #000000, 0.78px -0.78px 0 #000000;
}

.effective-price-display {
    position: absolute;
    top: var(--market-card-effective-price-top);
    left: var(--market-card-price-left);
    font-size: var(--market-card-effective-price-font-size);
    color: var(--market-card-effective-price-color);
    font-family: 'Roboto Mono', monospace;
    text-shadow: var(--market-card-effective-price-text-shadow);
}

.avail-text {
    position: absolute;
    top: var(--market-card-avail-top);
    left: var(--market-card-avail-left);
    font-size: var(--market-card-avail-font-size);
    color: var(--market-card-avail-color);
    text-shadow: var(--market-card-avail-text-shadow);
}

.avail-text [id^="p-inv-"] {
    color: var(--market-card-pinv-own-color);
    font-size: var(--market-card-pinv-own-font-size);
}

.avg-cost-display {
    position: absolute;
    bottom: 8px;
    right: 16px; /* Positioned to the bottom right */
    font-size: 0.7rem;
    color: #e8e8e8;
    font-family: 'Roboto Mono', monospace;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    display: none; /* Hidden by default */
    text-align: right;
}

.avg-cost-display.visible {
    display: block; /* Show when in sell mode */
}

/* --- [[START]] INDICATOR STYLES --- */
.indicator-container {
    position: absolute;
    top: var(--market-card-indicator-top);
    left: var(--market-card-indicator-left);
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    gap: var(--market-card-indicator-h-spacing);
    margin-top: var(--market-card-price-indicator-v-gap);
}

.indicator-pill {
    padding: var(--market-card-indicator-padding);
    border-radius: 99px;
    font-size: var(--market-card-indicator-font-size);
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    gap: var(--market-card-indicator-h-spacing);
    text-shadow: none;
}

.indicator-pill.positive {
    background-color: var(--market-card-indicator-positive-bg);
    color: var(--market-card-indicator-positive-color);
}
.indicator-pill.negative {
    background-color: var(--market-card-indicator-negative-bg);
    color: var(--market-card-indicator-negative-color);
}
.indicator-pill.neutral {
    background-color: var(--market-card-indicator-neutral-bg);
    color: var(--market-card-indicator-neutral-color);
}
/* --- [[END]] INDICATOR STYLES --- */


/* --- [[START]] COMMODITY CARD STYLES --- */
.item-style-1 {
    border-color: #60a5fa;
    --market-card-gradient-color1: #93c5fd;
    --market-card-gradient-color2: #2563eb;
    background: linear-gradient(var(--market-card-gradient-angle), var(--market-card-gradient-color1), var(--market-card-gradient-color2));
    color: #eff6ff;
}
.item-style-2 {
    border-color: #a3a3a3;
    --market-card-gradient-color1: #d4d4d4;
    --market-card-gradient-color2: #525252;
    background: linear-gradient(var(--market-card-gradient-angle), var(--market-card-gradient-color1), var(--market-card-gradient-color2));
    color: #fafafa;
}
.item-style-3 {
    border-color: #166534;
    --market-card-gradient-color1: #22c55e;
    --market-card-gradient-color2: #15803d;
    background: linear-gradient(var(--market-card-gradient-angle), var(--market-card-gradient-color1), var(--market-card-gradient-color2));
    color: #dcfce7;
}
.item-style-4 {
    border-color: #e5e5e5;
    --market-card-gradient-color1: #f3f4f6;
    --market-card-gradient-color2: #cccccc;
    background: linear-gradient(var(--market-card-gradient-angle), var(--market-card-gradient-color1), var(--market-card-gradient-color2));
    color: #ffffff;
}
.item-style-5 {
    border-color: #c084fc;
    --market-card-gradient-color1: #e9d5ff;
    --market-card-gradient-color2: #a855f7;
    background: linear-gradient(var(--market-card-gradient-angle), var(--market-card-gradient-color1), var(--market-card-gradient-color2));
    color: #faf5ff;
}
.item-style-6 {
    border-color: #93c5fd;
    --market-card-gradient-color1: #bfdbfe;
    --market-card-gradient-color2: #3b82f6;
    background: linear-gradient(var(--market-card-gradient-angle), var(--market-card-gradient-color1), var(--market-card-gradient-color2));
    color: #eff6ff;
}
.item-style-7 {
    border-color: #84cc16;
    --market-card-gradient-color1: #a7f3d0;
    --market-card-gradient-color2: #4d7c0f;
    background: linear-gradient(var(--market-card-gradient-angle), var(--market-card-gradient-color1), var(--market-card-gradient-color2));
    color: #f0fdf4;
}
.item-style-8 {
    border-color: #a5f3fc;
    --market-card-gradient-color1: #e0f2fe;
    --market-card-gradient-color2: #22d3ee;
    background: linear-gradient(var(--market-card-gradient-angle), var(--market-card-gradient-color1), var(--market-card-gradient-color2));
    color: #f0f9ff;
}
.item-style-9 {
    border-color: #fcd34d;
    --market-card-gradient-color1: #fcd34d;
    --market-card-gradient-color2: #d2b48c;
    background: linear-gradient(var(--market-card-gradient-angle), var(--market-card-gradient-color1), var(--market-card-gradient-color2));
    color: #fffbeb;
}
.item-style-10 {
    border-color: #fda4af;
    --market-card-gradient-color1: #fecaca;
    --market-card-gradient-color2: #b91c1c;
    background: linear-gradient(var(--market-card-gradient-angle), var(--market-card-gradient-color1), var(--market-card-gradient-color2));
    color: #fef2f2;
}
.item-style-11 {
    border-color: #c4b5fd;
    --market-card-gradient-color1: #a78bfa;
    --market-card-gradient-color2: #312e81;
    background: linear-gradient(165deg, var(--market-card-gradient-color1), var(--market-card-gradient-color2), #1e3a8a);
    color: #f5f3ff;
}
.item-style-12 {
    border-color: #fca5a5;
    --market-card-gradient-color1: #1f2937;
    --market-card-gradient-color2: #b91c1c;
    background: linear-gradient(var(--market-card-gradient-angle), var(--market-card-gradient-color1) 40%, #7f1d1d, var(--market-card-gradient-color2));
    color: #fee2e2;
}
.item-style-13 {
    border-color: #a78bfa;
    background-color: #000;
    animation: dark-shift 5s ease infinite;
    color: #fde047;
}
.item-style-14 {
    border-color: #f9a8d4;
    background-color: #fca5a5;
    animation: warm-shift 4s ease infinite;
    color: #fff;
}
/* --- [[END]] COMMODITY CARD STYLES --- */

/* --- [[START]] MIN/MAX VIEW STYLES --- */
.card-toggle-btn {
    position: absolute;
    top: -12px;
    right: -12px;
    width: 24px;
    height: 24px;
    border-radius: 99px;
    background-color: rgba(0, 0, 0, 0.45);
    color: rgba(255, 255, 255, 0.7);
    border: 1px solid rgba(255, 255, 255, 0.2);
    cursor: pointer;
    z-index: 10;
    font-family: 'Roboto Mono', monospace;
    font-size: 1.2rem;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding-bottom: 2px;
}
.card-toggle-btn:hover {
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
}
.min-view-content {
    display: none;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    height: 100%;
}
.commodity-name-min {
    font-family: 'Roboto Mono', monospace;
    font-size: var(--market-card-name-font-size);
    color: var(--market-card-name-color);
    text-shadow: var(--market-card-name-text-shadow);
}
.tier-text-min {
    font-family: 'Roboto Mono', monospace;
    font-size: 0.7rem;
    color: var(--market-card-name-color);
    text-shadow: var(--market-card-name-text-shadow);
    opacity: 0.8;
}

.item-card-container .max-view-content { display: block; }
.item-card-container .min-view-content { display: none; }
.item-card-container.minimized .max-view-content { display: none; }
.item-card-container.minimized .min-view-content { display: flex; }
/* --- [[END]] MIN/MAX VIEW STYLES --- */

/* --- [[START]] SOLID STATE TRANSACTION BUTTONS --- */
@keyframes stepper-border-pulse {
    0%, 100% { border-color: var(--active-primary); }
    50% { border-color: var(--active-text-dark); }
}

.transaction-controls {
    position: absolute;
    top: var(--market-card-module-top);
    right: var(--market-card-module-right);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--market-card-module-v-gap);
    width: var(--market-card-module-width);
    font-family: var(--font-family);
    font-size: var(--font-size);
}
.toggle-switch {
    width: 100%;
    height: var(--market-card-module-toggle-height);
    border-radius: 99px;
    display: flex;
    align-items: center;
    padding: 3px;
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease-in-out;
}
.toggle-thumb {
    width: 50%;
    height: 100%;
    border-radius: 99px;
    position: absolute;
    left: 3px;
    transition: all 0.3s ease-in-out;
}
.toggle-labels {
    width: 100%;
    display: flex;
    justify-content: space-around;
    position: relative;
    z-index: 1;
    font-weight: bold;
    font-size: 0.8em;
}
.toggle-labels span {
    transition: color 0.3s ease-in-out;
}
.qty-stepper {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    height: var(--market-card-module-stepper-height);
    border-radius: var(--border-radius);
    padding: 0 0.5rem;
    transition: all 0.3s ease-in-out;
}
.qty-stepper.stepper-active {
    animation: stepper-border-pulse 1s infinite;
}
.qty-stepper input {
    width: 30%;
    background: none;
    border: none;
    text-align: center;
    color: inherit;
    font-size: 1.2em;
    font-family: 'Roboto Mono', monospace;
    -moz-appearance: textfield;
}
.qty-stepper input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
.qty-stepper button {
    background: none;
    border: none;
    font-size: var(--market-card-module-stepper-arrow-size);
    cursor: pointer;
    transition: color 0.2s;
    line-height: 1;
}
.action-group {
    display: flex;
    width: 100%;
    gap: 0.5rem;
}
.action-group .btn {
    flex: 1;
    height: var(--market-card-module-button-height);
    border: none;
    border-radius: 99px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s ease-out;
    font-size: 0.8em;
    padding: 0 0.5rem;
}
.action-group .confirm-btn {
    flex-grow: 1;
}
.action-group .max-btn {
    flex: 1;
}
.action-group .btn:active {
    transform: scale(0.95);
    filter: brightness(1.2) saturate(1.5);
}

/* Dynamic Theming */
.transaction-controls[data-mode="buy"] {
    --active-primary: var(--buy-primary);
    --active-secondary-bg: var(--buy-secondary-bg);
    --active-secondary-border: var(--buy-secondary-border);
    --active-text-light: var(--buy-text-light);
    --active-text-dark: var(--buy-text-dark);
}
.transaction-controls[data-mode="sell"] {
    --active-primary: var(--sell-primary);
    --active-secondary-bg: var(--sell-secondary-bg);
    --active-secondary-border: var(--sell-secondary-border);
    --active-text-light: var(--sell-text-light);
    --active-text-dark: var(--sell-text-dark);
}
.toggle-switch, .qty-stepper {
    background: var(--active-secondary-bg);
    border: var(--active-secondary-border);
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.4);
}
.toggle-thumb {
    background: var(--active-primary);
}
.toggle-labels span {
    color: var(--active-text-light);
}
.transaction-controls[data-mode="buy"] .label-buy, .transaction-controls[data-mode="sell"] .label-sell {
    color: var(--active-text-dark);
}
.qty-stepper {
    color: var(--active-text-light);
}
.qty-stepper button {
    color: var(--active-text-light);
}
.confirm-btn {
    background: var(--active-primary);
    color: var(--active-text-dark);
}

/* --- MAX BUTTON STYLES START --- */
.max-btn {
    background: var(--max-bg);
    color: var(--max-text);
    border: 1px solid var(--max-border);
    /* Default "out" state (unpressed) */
    box-shadow: var(--max-shadow-outset);
    transform: scale(1.0); /* Default scale */
}

.max-btn:active {
    /* Momentary click state (pressed) */
    transform: scale(0.95) !important;
    /* Use the "in" shadow */
    box-shadow: var(--max-shadow-inset) !important;
    filter: brightness(1.1);
}

.max-btn.pressed {
    /* Persistent "in" state (pressed) */
    background: rgba(20, 24, 30, 0.8); /* Darker background */
    color: #ffffff; /* Brighter text */
    /* Use the "in" shadow */
    box-shadow: var(--max-shadow-inset);
    transform: scale(0.98); /* Slightly smaller to look "in" */
}
/* --- MAX BUTTON STYLES END --- */

.transaction-controls[data-mode="sell"] .toggle-thumb {
    left: calc(50% - 3px);
}
/* --- [[END]] SOLID STATE TRANSACTION BUTTONS --- */

.market-scroll-panel {
    /* height: 75vh; */ /* REMOVED */
    overflow-y: auto;
    scrollbar-width: none; /* For Firefox */
    -ms-overflow-style: none; /* For Internet Explorer 10+ */
    /* * VIRTUAL WORKBENCH: 
     * Setting vertical padding (1.5rem) to fix button clipping.
     * Setting horizontal padding (0.5rem) to widen cards.
     */
    padding: 1.5rem 0.5rem; /* 1.5rem top/bottom, 0.5rem left/right */
    touch-action: pan-y; /* Allow vertical scrolling */
}

.market-scroll-panel::-webkit-scrollbar {
    display: none; /* For Chrome, Safari, and Opera */
}
--- END OF FILE: ./css/screens/market-screen.css ---

--- START OF FILE: ./css/screens/intel-screen.css ---
/* css/screens/intel-screen.css */
.intel-scroll-panel {
    /* height: 75vh; */ /* REMOVED */
    overflow-y: auto;
    scrollbar-width: none; /* For Firefox */
    -ms-overflow-style: none; /* For Internet Explorer 10+ */
    padding: 0; /* Padding is now on the content divs */
    touch-action: pan-y; /* Allow vertical scrolling */
    flex-grow: 1; /* Ensure it fills space */
    /* VIRTUAL WORKBENCH: Removed display:flex to fix scrolling/layout */
}
.intel-scroll-panel::-webkit-scrollbar {
    display: none; /* For Chrome, Safari, and Opera */
}

/* New Lore Modal Theming */
#lore-modal .modal-content {
    border-color: var(--theme-border-color, #4a6a8a);
    background: radial-gradient(circle, #1a2030 0%, #0c101d 100%);
}

#lore-modal-content p {
    margin-bottom: 1rem;
}

/* Themed scrollbar 
for lore content */
#lore-modal-content::-webkit-scrollbar {
    width: 8px;
}

#lore-modal-content::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 4px;
}

#lore-modal-content::-webkit-scrollbar-thumb {
    background-color: var(--theme-border-color, #4a6a8a);
    border-radius: 4px;
    border: 2px solid transparent;
    background-clip: content-box;
}

#lore-modal-content::-webkit-scrollbar-thumb:hover {
    background-color: var(--theme-border-color, #6b8fb8);
}

/* --- VIRTUAL WORKBENCH: ADD NEW INTEL STYLES --- */

/* Tab Content Styling */
.intel-tab-content {
    display: none; /* Hidden by default */
    width: 100%;
    /* flex-grow: 1; */ /* No longer needed, parent isn't flex */
}
.intel-tab-content.active {
    display: block; /* Shown when active */
}

/* Intel Market Button Styling */
.btn-intel {
    font-family: 'Orbitron', sans-serif;
    letter-spacing: 1px;
    background-color: #1e293b; /* slate-800 */
    border: 1px solid #334155; /* slate-700 */
    color: #cbd5e1; /* slate-300 */
    padding: 0.75rem 1rem;
    text-align: center;
    transition: all 0.2s ease-in-out;
}

.btn-intel:hover:not(:disabled) {
    background-color: #334155; /* slate-700 */
    border-color: #475569; /* slate-600 */
    color: #f1f5f9; /* slate-100 */
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

/* Intel "Buy" Button in Modal */
.btn-intel-buy {
    font-family: 'Orbitron', sans-serif;
letter-spacing: 1px;
    background-color: var(--ot-green-accent, #4ade80);
    border: 1px solid #86efac; /* green-300 */
    color: #064e3b; /* green-900 */
    padding: 0.75rem 1rem;
    text-align: center;
    transition: all 0.2s ease-in-out;
    font-weight: bold;
}

.btn-intel-buy:hover:not(:disabled) {
    background-color: #86efac; /* green-300 */
    transform: translateY(-1px);
    box-shadow: 0 0 15px rgba(74, 222, 128, 0.5);
}

/* Disabled state for locked intel buttons */
.btn-intel:disabled {
    background-color: #0f172a; /* slate-900 */
    border-color: #1e293b; /* slate-800 */
    color: #334155; /* slate-700 */
    cursor: not-allowed;
    opacity: 0.6;
}

/* --- VIRTUAL WORKBENCH: THEMED PURCHASED BUTTON (REQUEST A) --- */
/* New style for purchased, themed intel buttons */
.btn-intel-purchased {
    /* Apply theme variables provided by the renderer */
    background: var(--theme-gradient, linear-gradient(135deg, #4a5568, #2d3748));
    border-color: var(--theme-border-color, #7a9ac0);
    color: var(--theme-text-color, #f0f0ff);
    
    /* Use the border color for the glow animation */
    --theme-glow-color: var(--theme-border-color, #7a9ac0);
    
    /* Re-use the existing themed-glow-animation from global.css */
    animation: themed-glow-animation 3s infinite;
}

.btn-intel-purchased:hover:not(:disabled) {
    /* On hover, revert to a standard non-animated style for consistency */
    background: #334155; /* slate-700 */
    border-color: #475569; /* slate-600 */
    color: #f1f5f9; /* slate-100 */
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    animation: none; /* Stop glowing on hover */
}
/* --- END VIRTUAL WORKBENCH --- */


/* --- VIRTUAL WORKBENCH: REFINED INTEL TAB STYLES (SLIDING, THEMED, RESIZED) --- */

#intel-screen .sub-nav-bar {
    position: relative; /* For the sliding pseudo-element */
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: stretch; /* Make buttons fill height */
    
    /* Recessed panel look */
    background-color: #0D1117; /* bg-[#0D1117] */
    border-bottom: 1px solid var(--theme-border-color, #334155);
    border-radius: 0.375rem; /* rounded-md */
    padding: 0.125rem; /* p-0.5, reduced by ~30% */
    box-shadow: inset 0 1px 3px 
rgba(0,0,0,0.4); /* shadow-inner */
    
    gap: 0; /* Buttons are joined */
    width: 100%;
    flex-shrink: 0; /* Prevent shrinking */
    
    /* Reduced skew */
    --intel-skew: 8px; 
}

/*
  This is the "gliding highlight" pseudo-element.
  It lives on the bar and moves behind the buttons.
*/
#intel-screen .sub-nav-bar::after {
    content: '';
    position: absolute;
    top: 0.125rem;
    bottom: 0.125rem;
    left: 0.125rem;
    width: calc(50% - 0.125rem); /* Half width, minus padding */
    z-index: 5; /* Sits behind text, above 
bar bg */
    
    /* THEME: Use location gradient and shadow */
    background: var(--theme-gradient, linear-gradient(135deg, #4a5568, #2d3748));
    box-shadow: 0 0 10px -2px var(--theme-border-color, #4a5568);
    
    /* Default clip-path for "Codex" (left side) */
    clip-path: polygon(0% 0%, 100% 0%, calc(100% - var(--intel-skew)) 100%, 0% 100%);
    
    /* ANIMATION: Enable sliding transition */
    transition: transform 0.3s ease-in-out, clip-path 0.3s ease-in-out;
}

/*
  This class is added by UIManager.js to slide the highlight.
*/
#intel-screen .sub-nav-bar.market-active::after {
    /* Move slider to the right */
    
transform: translateX(100%);
    
    /* New clip-path for "Intel Market" (right side) */
    clip-path: polygon(var(--intel-skew) 0%, 100% 0%, 100% 100%, 0% 100%);
}


/*
  Base button styles.
  The button itself is transparent; only the text is visible.
*/
#intel-screen .sub-nav-button {
    position: relative; 
    z-index: 10; /* Text is on top of the slider */
    flex: 1 1 0; /* flex-1 */

    font-family: 'Orbitron', sans-serif;
    font-size: 0.75rem; /* text-xs, reduced */
    
    /* THEME: Use dim color for inactive text */
    color: 
#94a3b8; /* text-slate-400 */
    background: transparent; /* Button is see-through */
    border: none;
    
    /* RESIZE: Reduced vertical padding */
    padding: 0.375rem 1rem; /* py-1.5, reduced by ~30% */
    
    cursor: pointer;
    transition: color 0.3s ease-in-out;
    text-transform: uppercase;
    letter-spacing: 0.05em; /* tracking-wider */
    font-weight: 500;
}

/* Apply angled clip-path and padding compensation */
#intel-screen .sub-nav-button[data-target="intel-codex-content"] {
    clip-path: polygon(0% 0%, 100% 0%, calc(100% - var(--intel-skew)) 100%, 0% 100%);
    padding-right: var(--intel-skew); /* Compensate for clip */
    text-align: center;
}

#intel-screen 
.sub-nav-button[data-target="intel-market-content"] {
    clip-path: polygon(var(--intel-skew) 0%, 100% 0%, 100% 100%, 0% 100%);
    margin-left: calc(-1 * var(--intel-skew)); /* Overlap buttons */
    padding-left: var(--intel-skew); /* Compensate for clip */
    text-align: center;
}


/* Hover state for *inactive* buttons */
#intel-screen .sub-nav-button:not(.active):hover {
    /* THEME: Use bright theme color on hover */
    color: var(--theme-text-color, #f0f0f0);
    opacity: 0.8;
}

/* Active state *text* color */
#intel-screen .sub-nav-button.active {
    /* THEME: Use bright theme color for active text */
    color: var(--theme-text-color, #f0f0f0);
    font-weight: 700;
}


/* --- END VIRTUAL 
WORKBENCH --- */
--- END OF FILE: ./css/screens/intel-screen.css ---

--- START OF FILE: ./css/screens/cargo-screen.css ---
/* css/screens/cargo-screen.css */
.cargo-scroll-panel {
    /* height: 75vh; */ /* REMOVED */
    overflow-y: auto;
    scrollbar-width: none; /* For Firefox */
    -ms-overflow-style: none; /* For Internet Explorer 10+ */
    padding: 0.25rem;
    touch-action: pan-y; /* Allow vertical scrolling */
}
.cargo-scroll-panel::-webkit-scrollbar {
    display: none; /* For Chrome, Safari, and Opera */
}

/* Grid container for the min-cargo items */
.cargo-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    padding: 1rem;
}

/* Individual min-cargo item styling */
.min-cargo-item {
    aspect-ratio: 1 / 0.8; /* Ensures the item is shorter */
    border-radius: 12px;
    cursor: pointer;
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    position: relative;
}

.min-cargo-item .pt-quantity {
    opacity: 0.85; /* Make the quantity text slightly transparent */
    color: #a0aec0; /* Change the quantity text color to grey */
}

.min-cargo-item:hover {
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
}

/* Styles for the max-cargo modal */
#cargo-detail-modal .modal-content {
    background: transparent;
    border: none;
    box-shadow: none;
    max-width: 350px; /* Or adjust as needed */
}

.max-cargo-card {
    width: 100%;
    border-radius: 15px;
    color: #fff;
    padding: 1.5rem;
    text-align: left;
    border: 2px solid;
}

.max-cargo-card h3, .max-cargo-card p, .max-cargo-card div {
    text-shadow: 1px 1px 3px rgba(0,0,0,0.7); /* Add text outline for clarity */
}

.max-cargo-card .tier-type-line {
    text-shadow: 1px 1px 2px rgba(0,0,0,0.9); /* Darker outline for more contrast */
}

.max-cargo-card .flavor-text {
    font-size: 0.9rem;
    color: #d1d5db;
    margin-top: 1rem;
    margin-bottom: 1rem;
    text-align: justify;
}

.max-cargo-card .avg-cost {
    font-family: 'Roboto Mono', monospace;
    font-size: 1rem;
    text-align: center;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}


/* Responsive adjustments */
@media (max-width: 768px) {
    .cargo-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 480px) {
    .cargo-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
--- END OF FILE: ./css/screens/cargo-screen.css ---

--- START OF FILE: ./css/screens/finance-screen.css ---
/* css/screens/finance-screen.css */
/**
 * @fileoverview This file contains the styles specific to the Finance screen,
 * including the loan module and the transaction log.
 */

/* --- VIRTUAL WORKBENCH: ADD INTEL-THEMED HEADER STYLES --- */
.themed-header-bar {
    position: relative;
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: stretch;
    
    /* Recessed panel look - REMOVED inset shadow */
    background-color: #0D1117; /* bg-[#0D1117] */
    border: 1px solid var(--theme-border-color, #334155);
    border-radius: 0.375rem; /* rounded-md - ADDED */
    padding: 0.125rem; /* p-0.5, reduced by ~30% */
    
    width: 100%;
    flex-shrink: 0; /* Prevent shrinking */
    
    margin-bottom: 0.75rem; /* mb-3 */
}

.themed-header-title {
    position: relative; 
    z-index: 10;
    flex: 1 1 0; /* flex-1 */

    font-family: 'Orbitron', sans-serif;
    /* VIRTUAL WORKBENCH: Increased font size from text-xs (0.75rem) to text-sm (0.875rem) */
    font-size: 0.875rem;
    font-weight: 700;
    
    /* THEME: Use theme gradient and colors */
    color: var(--theme-text-color, #f0f0f0);
    background: var(--theme-gradient, linear-gradient(135deg, #4a5568, #2d3748));
    box-shadow: 0 0 10px -2px var(--theme-border-color, #4a5568);

    /* RESIZE: Reduced vertical padding */
    padding: 0.375rem 1rem; /* py-1.5, reduced by ~30% */
    
    text-transform: uppercase;
    letter-spacing: 0.05em; /* tracking-wider */
    text-align: center;

    /* VIRTUAL WORKBENCH: Removed clip-path, added border-radius */
    border-radius: 0.375rem; /* rounded-md */
}
/* --- END VIRTUAL WORKBENCH --- */


/* --- VIRTUAL WORKBENCH: ADD INTEL-THEMED MODULE PANEL & BUTTON STYLES --- */
.finance-module-panel {
    /* Dark, recessed background similar to intel market */
    background: rgba(13, 17, 23, 0.6); /* bg-[#0D1117]/60 */
    border: 1px solid var(--theme-border-color, #4a6a8a);
    border-radius: 0.375rem; /* rounded-md */
    padding: 1rem; /* p-4 */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
}

/* Base button style, copied from .btn-intel */
.btn-module {
    font-family: 'Orbitron', sans-serif;
    letter-spacing: 1px;
    background-color: #1e293b; /* slate-800 */
    border: 1px solid #334155; /* slate-700 */
    color: #cbd5e1; /* slate-300 */
    padding: 0.75rem 1rem;
    text-align: center;
    transition: all 0.2s ease-in-out;
    
    /* VIRTUAL WORKBENCH: Add rounded corners and convex shadow */
    border-radius: 0.375rem; /* rounded-md */
    box-shadow: 0 2px 4px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.1);
}

.btn-module:hover:not(:disabled) {
    background-color: #334155; /* slate-700 */
    border-color: #475569; /* slate-600 */
    color: #f1f5f9; /* slate-100 */
    transform: translateY(-1px);
    /* VIRTUAL WORKBENCH: Enhance shadow on hover */
    box-shadow: 0 4px 8px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.1);
}

.btn-module:disabled {
    background-color: #0f172a; /* slate-900 */
    border-color: #1e293b; /* slate-800 */
    color: #334155; /* slate-700 */
    cursor: not-allowed;
    opacity: 0.6;
    /* VIRTUAL WORKBENCH: Remove convex shadow on disabled */
    box-shadow: none;
}

/* --- VIRTUAL WORKBENCH: MODIFIED (Point E) --- */
/* Changed from cyan to sky to match main credit glow */
.btn-module-credit {
    background-color: #0c4a6e; /* sky-900 */
    border-color: #075985; /* sky-800 */
    color: #bae6fd; /* sky-200 */
    /* Add sky-blue glow to the convex shadow */
    box-shadow: 0 0 10px -2px #0ea5e9, 0 2px 4px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.1);
}

.btn-module-credit:hover:not(:disabled) {
    background-color: #075985; /* sky-800 */
    border-color: #0ea5e9; /* sky-500 */
    color: #f0f9ff; /* sky-50 */
    box-shadow: 0 0 15px -2px #0ea5e9, 0 4px 8px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.1);
}
/* --- END VIRTUAL WORKBENCH --- */


/* --- VIRTUAL WORKBENCH: MODIFIED (Point B) & Phase 2 --- */
/* Muted destructive button */
.btn-module-destructive {
    /* Muted red */
    background-color: #7f1d1d; /* red-900 */
    border-color: #991b1b; /* red-800 */
    color: #fecaca; /* red-200 */
}

.btn-module-destructive:hover:not(:disabled) {
    background-color: #991b1b; /* red-800 */
    border-color: #dc2626; /* red-600 */
    color: #ffffff;
}
/* --- END VIRTUAL WORKBENCH & Phase 2 --- */


/* --- VIRTUAL WORKBENCH: ADJUST LOG PANEL STYLING --- */
/* This panel now sits *inside* .finance-module-panel */
.finance-log-panel {
    display: flex; /* Use flexbox to manage children */
    flex-direction: column; /* Stack header and log entries vertically */
    flex-grow: 1; /* Allow this panel to grow and fill space */
    min-height: 0; /* Crucial for allowing a child element to scroll within a flex parent */
    overflow: hidden; /* Prevent this panel itself from scrolling */
    scrollbar-width: none; /* For Firefox */
    -ms-overflow-style: none; /* For Internet Explorer 10+ */
    
    /* REMOVED: padding, border, background, shadow. Now handled by .finance-module-panel */
}
/* --- END VIRTUAL WORKBENCH --- */

.finance-log-panel::-webkit-scrollbar {
    display: none; /* For Chrome, Safari, and Opera */
}

/* Container for the actual log entries */
.log-entries-container {
    overflow-y: auto; /* This is the element that will scroll */
    flex-grow: 1; /* It will take up all available space after the header */
    touch-action: pan-y; /* Allow vertical scrolling */
}

.log-entry {
    display: grid;
    grid-template-columns: 0.5fr 2fr 1fr;
    gap: 0.5rem;
    padding: 0.5rem;
    border-bottom: 1px solid rgba(var(--theme-border-color, #4a6a8a), 0.2);
    font-size: 0.8rem;
    flex-shrink: 0;
}

/* Zebra-striping for better readability */
.log-entry:nth-child(even) {
    background-color: rgba(0,0,0,0.2);
}

/* Column separators */
.log-entry > span:first-child {
    border-right: 1px solid rgba(var(--theme-border-color, #4a6a8a), 0.2);
    padding-right: 0.5rem;
}
.log-entry > span:last-child {
    border-left: 1px solid rgba(var(--theme-border-color, #4a6a8a), 0.2);
    padding-left: 0.5rem;
}

/* Header-specific styles */
.log-header {
    display: grid; /* Make header use grid just like entries */
    grid-template-columns: 0.5fr 2fr 1fr; /* Match the columns */
    gap: 0.5rem; /* Match the gap */
    padding: 0.5rem; /* Match the padding */
    border-bottom-width: 2px;
    font-family: 'Orbitron', sans-serif;
    font-weight: bold;
    color: var(--theme-text-color, #f0f0f0);
    position: sticky;
    top: 0;
    /* VIRTUAL WORKBENCH: Use a slightly darker bg to stand out from panel */
    background: rgba(13, 17, 23, 0.8); /* bg-[#0D1117]/80 */
    backdrop-filter: blur(2px);
    /* END VIRTUAL WORKBENCH */
    flex-shrink: 0; /* Prevent header from shrinking */
}

/* Align header text to match entry alignment */
.log-header > span:first-child {
    border-right: 1px solid rgba(var(--theme-border-color, #4a6a8a), 0.2);
    padding-right: 0.5rem;
}
.log-header > span:last-child {
    border-left: 1px solid rgba(var(--theme-border-color, #4a6a8a), 0.2);
    padding-left: 0.5rem;
}

@media (max-width: 768px) {
    /* Existing media query remains the same */
    .log-entry, .log-header {
        grid-template-columns: 0.5fr 2fr 1fr;
        font-size: 0.8rem;
    }
}
--- END OF FILE: ./css/screens/finance-screen.css ---

--- START OF FILE: ./css/screens/hangar-screen.css ---
/* css/screens/hangar-screen.css */

/* ================================================================================
CORE THEME & VARIABLE SETUP
- Defines the color palette, fonts, and dynamic variables used throughout the component.
- Theming is driven by CSS variables to allow for easy changes based on game state (e..g., location).
================================================================================
*/
:root {
    /* Base Colors */
    --ot-bg-dark: #0c101d;
    --ot-border-light: #4a6a8a;
    --ot-text-primary: #d0d8e8;
    --ot-text-secondary: #9ca3af;
    /* --- VIRTUAL WORKBENCH (A) --- */
    /* MODIFIED: Changed from #4ade80 to #16a34a for a richer green */
    --ot-green-accent: #16a34a;
    /* --- END VIRTUAL WORKBENCH --- */
    --ot-red-accent: #f87171;
    --ot-cyan-base: #22d3ee;
    --ot-cyan-glow: #67e8f9;

    /* Toggle & Mode-Specific Colors */
    --ot-hangar-red-base: #ef4444;
    --ot-hangar-red-glow: #f87171;
    --ot-shipyard-blue-base: #60a5fa;
    --ot-shipyard-blue-glow: #93c5fd;

    /* Ship Class Colors */
  
  --class-s-color: #facc15;
    --class-a-color: #60a5fa;
    --class-b-color: #4ade80;
    --class-c-color: #e5e7eb;
    
    /* Placeholder Theme (Saturn) - In the final game, these will be dynamically set.
 */
    --theme-color-primary: #fde047;
    --theme-color-glow: #fef08a;
    --theme-bg-gradient: linear-gradient(145deg, rgba(113, 63, 18, 0.5), rgba(49, 46, 129, 0.8));

    /* Dynamic Frame Border Color - Changes based on Hangar/Shipyard mode */
    --frame-border-color: var(--ot-shipyard-blue-base);
}

/* Set Hangar-specific frame color when the .mode-hangar class is active */
#ship-terminal-container.mode-hangar {
    --frame-border-color: var(--ot-hangar-red-base);
}


/* ================================================================================
COMPONENT-SPECIFIC STYLING
================================================================================
*/

#ship-terminal-container {
    margin-top: -0.9625rem;
}

/* Carousel: Main container for ship cards */
.carousel-container { 
    width: 100%;
    position: relative;
    cursor: grab;
    flex-grow: 1; /* Ensure this container fills available vertical space */
    display: flex;
}
.carousel-container:active {
    cursor: grabbing;
}

#hangar-carousel {
    display: flex; /* Lays out the pages side-by-side */
    height: 100%;
    width: 100%;
    /* ALWAYS have the transition property defined in CSS for smooth animations */
    transition: transform 0.4s ease-out;
}
.carousel-page {
    width: 100%;
    flex-shrink: 0; /* Prevents the page from shrinking */
    display: flex; 
    flex-direction: column; 
    user-select: none;
    padding-bottom: 4.0rem; /* New: Add space at the bottom for the absolute-positioned paginator */
}

/* Backgrounds & Theming */
#ship-terminal {
    
background-image: var(--theme-bg-gradient); /* Base theme from location */
    display: flex; 
    flex-direction: column; 
    flex-grow: 1; /* Make the card itself grow to fill the page */
    height: auto;
/* --- VIRTUAL WORKBENCH --- */
    /* Add relative positioning for the new pseudo-element */
    position: relative;
    /* --- END VIRTUAL WORKBENCH --- */
}

/* --- VIRTUAL WORKBENCH: ADD GLOW PSEUDO-ELEMENT --- */
/*
 * This is the new high-performance glow element.
 * It's a theme-colored radial gradient, hidden by default.
 * The 'dematerialize' animation will animate its opacity and transform.
*/
#ship-terminal::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: -1; /* Sit behind the card content */
    border-radius: 0.5rem; /* rounded-lg, matching the card */
    
    /* Use the theme border color for the glow */
    background: radial-gradient(circle, var(--frame-border-color) 30%, transparent 70%);
    
    opacity: 0; /* Hidden by default */
    pointer-events: none; /* Ignore clicks */
    
    /* Set defaults for animation */
    transform-origin: center;
    transform: scale(0.5);
}
/* --- END VIRTUAL WORKBENCH --- */

/* --- VIRTUAL WORKBENCH: ADD ACTIVE SHIP GLOW --- */
@keyframes pulse-red-border-glow {
    0%, 100% {
        /* Use the base red color and a standard glow */
        border-color: var(--ot-hangar-red-base);
        box-shadow: 0 0 10px var(--ot-hangar-red-glow), 0 0 15px var(--ot-hangar-red-glow), inset 0 0 8px rgba(239, 68, 68, 0.2);
    }
    50% {
        /* Use the brighter glow color and a more intense shadow */
        border-color: var(--ot-hangar-red-glow);
        box-shadow: 0 0 15px var(--ot-hangar-red-glow), 0 0 25px var(--ot-hangar-red-glow), inset 0 0 12px rgba(239, 68, 68, 0.3);
    }
}

.active-ship {
    /* * This !important rule is crucial. It overrides the default --frame-border-color
     * (which is blue) and fixes the bug where the card gets "stuck" on blue
     * after the boarding animation.
    */
    border-color: var(--ot-hangar-red-base) !important;
    
    /* This applies the new persistent red glow animation */
    animation: pulse-red-border-glow 2.5s infinite ease-in-out;
}
/* --- END VIRTUAL WORKBENCH --- */

/* --- VIRTUAL WORKBENCH: ADD GREEN BUTTON GLOW KEYFRAMES (Request A) --- */
@keyframes pulse-green-button-glow {
    0%, 100% {
        /* Use the green variables from :root */
        background-color: var(--ot-green-accent);
        box-shadow: 0 0 10px var(--class-b-color), 0 0 15px var(--class-b-color);
        transform: scale(1);
    }
    50% {
        /* Use the brighter green for the pulse */
        background-color: var(--class-b-color);
        box-shadow: 0 0 15px var(--class-b-color), 0 0 25px var(--class-b-color);
        transform: scale(1.05);
    }
}
/* --- END VIRTUAL WORKBENCH --- */


/* The new intermediate container for constraining height */
#ship-card-main-content {
    
flex: 1 1 auto; /* Grow to fill space */
    min-height: 0; /* CRUCIAL for allowing the child to scroll */
    display: flex;
    flex-direction: column;
}

/* The scrollable grid content wrapper */
.ship-card-content-wrapper {
    overflow-y: auto; 
    scrollbar-width: none;
    display: grid; 
    grid-template-columns: repeat(5, minmax(0, 1fr));
    gap: 1rem;
    padding: 1rem;
    /* --- VIRTUAL WORKBENCH (Clipping Fix) --- */
    /* flex-grow: 1; */ /* REMOVED: This was causing the container to grow instead of scroll */
    /* --- END VIRTUAL WORKBENCH --- */
}
.ship-card-content-wrapper::-webkit-scrollbar {
    display: none; 
}

/* Force grid columns to behave as flex containers to distribute space */
.ship-card-content-wrapper > .col-span-2,
.ship-card-content-wrapper > .col-span-3 {
    display: flex;
    flex-direction: column;
}


#ship-terminal-container.mode-hangar #ship-terminal {
    background-blend-mode: overlay;
    background-color: #1a193d;
}
#ship-terminal-container.mode-hangar #ship-terminal::after { 
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image:
        radial-gradient(circle at 10px 10px, rgba(255,255,255,0.05) 1px, transparent 1px);
    background-size: 20px 20px;
    pointer-events: none;
}


/* Hologram */
.ship-display-area { 
    perspective: 1500px; 
    position: relative; 
    flex-grow: 1; /* Pushes buttons down */
}

/* --- [[START]] VIRTUAL WORKBENCH (Phase 3) --- */
/* REMOVED .ship-info-button styles */
/* --- [[END]] VIRTUAL WORKBENCH (Phase 3) --- */

.ship-image-placeholder { 
    background: transparent; 
    border: 1px solid var(--ot-border-light); 
    color: var(--theme-color-primary); 
    box-shadow: inset 0 0 15px rgba(0,0,0,0.3);
    /* --- VIRTUAL WORKBENCH (Request B) --- */
    aspect-ratio: 1 / 1; /* Make it a 1:1 square */
    /* --- END VIRTUAL WORKBENCH --- */
}
.status-badge {
    position: absolute;
    bottom: -1px;
    left: 50%;
    transform: translateX(-50%) translateY(50%);
    background-color: #1a2030;
    border: 1px solid;
    padding: 3px 11px;
    border-radius: 99px;
    font-size: 0.77rem;
    font-weight: 700;
}

/* Hangar/Shipyard Toggle Switch */
.toggle-container {
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 8px;
    padding: 3px;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.4);
    transform: scale(0.72); 
    flex-shrink: 0; 
}
.toggle-switch {
    background-color: transparent;
    display: flex;
}
.toggle-label {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    flex-grow: 1;
    transition: all 0.3s ease;
    color: var(--ot-text-secondary);
    clip-path: polygon(0% 0%, 100% 0%, 100% 85%, 85% 100%, 0% 100%);
}
.toggle-label.shipyard {
    clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 15% 100%, 0% 85%);
}

#ship-terminal-container.mode-hangar .toggle-label.hangar,
#ship-terminal-container.mode-shipyard .toggle-label.shipyard {
    color: var(--ot-bg-dark);
    font-weight: 900;
}
#ship-terminal-container.mode-hangar .toggle-label.hangar { 
  
  background-color: var(--ot-hangar-red-base);
    box-shadow: 0 0 10px var(--ot-hangar-red-glow);
}
#ship-terminal-container.mode-shipyard .toggle-label.shipyard { 
    background-color: var(--ot-shipyard-blue-base);
    box-shadow: 0 0 10px var(--ot-shipyard-blue-glow);
}

/* Main Info Panels & Mode-Specific Spacing */
.info-panel-content { 
    display: none; 
    flex-grow: 1; /* Pushes buttons down */
    flex-direction: column;
}

/* --- VIRTUAL WORKBENCH START --- */
/* NEW: Header for info panel */
.info-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem; /* Space between text and bars */
}

.info-panel-text {
    flex-grow: 1; /* Allow text to take up remaining space */
}
/* --- VIRTUAL WORKBENCH END --- */


/* ADDED: Mode-specific rules for spacing above action buttons */
#ship-terminal-container.mode-hangar .ship-display-area,
#ship-terminal-container.mode-shipyard .info-panel-content {
    margin-bottom: 1rem;
}

#ship-terminal-container.mode-hangar .info-panel-hangar, 
#ship-terminal-container.mode-shipyard .info-panel-shipyard { 
    display: flex;
}

/* NEW: Ship Price Display for Shipyard */
.ship-price-display {
    margin-top: 0.5rem;
    color: var(--ot-cyan-base);
    text-shadow: 0 0 5px var(--ot-cyan-glow), 0 0 10px var(--ot-cyan-glow), 0 2px 4px rgba(0,0,0,0.8);
}


/* --- VIRTUAL WORKBENCH START --- */
/* NEW: Parameter Bars Styling */
.ship-param-bars {
    display: flex;
    flex-direction: column;
    gap: 0.3rem; /* Tighter spacing between bars */
    font-family: 'Roboto Mono', sans-serif;
    
    /* Sizing & Position */
    width: 40%;
    max-width: 160px; /* Constrain max width */
    flex-shrink: 0; /* Prevent shrinking */

    /* Scale transform */
    transform: scale(1.25);
    transform-origin: top right;
}

.param-bar-item {
    display: flex;
    align-items: center;
    gap: 0.5rem; /* Space between label and bar */
}

.param-bar-label {
    /* VIRTUAL WORKBENCH: Request A - Reduced text size */
    font-size: 0.6rem; /* Was 0.65rem */
    color: var(--ot-text-secondary);
    text-transform: uppercase;
    width: 40px; /* Fixed width for alignment */
    text-align: right;
    flex-shrink: 0;
}

.param-bar-track {
    /* VIRTUAL WORKBENCH: Request D - Increased thickness */
    height: 12px; /* Was 10px */
    background-color: rgba(0,0,0,0.3);
    flex-grow: 1;
    border-radius: 4px;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
    overflow: hidden; /* Ensure fill stays inside */
    position: relative; /* For text overlay positioning */
}

.param-bar-fill {
    height: 100%;
    border-radius: 4px;
    box-shadow: 0 0 8px var(--bar-color);
    transition: width 0.4s ease-out;
    position: relative; /* For z-index */
    z-index: 1; /* Sits below text */
}

/* Quantitative text overlay */
.param-bar-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Default: center-aligned */
    z-index: 2; /* Sits on top of the fill */
    /* VIRTUAL WORKBENCH: Request A - Reduced text size */
    font-size: 0.55rem; /* Was 0.6rem */
    font-family: 'Roboto Mono', sans-serif;
    color: #ffffff;
    text-shadow: 0 0 2px #000, 0 0 4px #000; /* Shadow for readability */
    white-space: nowrap; /* Prevent line breaks */
    pointer-events: none; /* Allow clicks to pass through */
    /* VIRTUAL WORKBENCH: Request A - Reduce visibility */
    opacity: 0.7;
}

/* NEW: Alignment for maxed-out bars */
.param-bar-text.max {
    left: auto; /* Unset left */
    right: 5px; /* Position 5px from the right */
    transform: translateY(-50%); /* Center vertically only */
}

/* REMOVED: Shipyard-specific coloring rule */
/* --- VIRTUAL WORKBENCH END --- */


/* Action Buttons */
.action-button { 
    transition: transform 0.2s ease; 
    border-radius: 0.5rem; 
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.3rem 0.8rem;
}
.action-button:not(:disabled) {
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}
.action-button:active:not(:disabled) { transform: scale(0.98); filter: brightness(1.2); }
.action-button:disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(50%); }

/* --- VIRTUAL WORKBENCH: ADD 'BOARD' BUTTON GLOW CLASS --- */
.action-button.is-glowing-button {
    /* Use the cyan color variables */
    --ot-cyan-base: #22d3ee;
    --ot-cyan-glow: #67e8f9;
    /* Apply the new animation from global.css */
    /* VIRTUAL WORKBENCH: MODIFIED from 0.4s to 1.0s */
    animation: pulse-cyan-button-glow 1.0s ease-in-out;
}
/* --- END VIRTUAL WORKBENCH --- */

/* --- VIRTUAL WORKBENCH: ADD GREEN AND RED GLOW CLASSES (Request A & B) --- */
.action-button.is-glowing-green {
    /*
     * We don't need to set variables here.
     * The keyframes `pulse-green-button-glow` use:
     * --ot-green-accent (from :root)
     * --class-b-color (from :root)
    */
    animation: pulse-green-button-glow 1.0s ease-in-out;
}

.action-button.is-glowing-red {
    /*
     * We don't need to set variables here.
     * The keyframes `pulse-red-border-glow` are already defined
     * and use --ot-hangar-red-base and --ot-hangar-red-glow (from :root).
     * We just apply the animation with a 1.0s duration for the button.
    */
    animation: pulse-red-border-glow 1.0s ease-in-out;
}
/* --- END VIRTUAL WORKBENCH --- */


/* NEW: Price text specifically for action buttons (like Sell) */
.action-button-price {
    font-size: 1.1rem;
    color: var(--ot-cyan-base);
    text-shadow: 0 0 5px var(--ot-cyan-glow), 0 0 10px var(--ot-cyan-glow), 0 2px 4px rgba(0,0,0,0.8);
}

/* Flavor Text Styling */
.flavor-text-box {
    padding-left: 0.75rem;
    border-left: 2px solid;
    box-shadow: inset 3px 0 5px -2px rgba(0,0,0,0.5);
}

/* Inset Text Shadow for ship names/roles */
.inset-text-shadow {
    text-shadow: 0 2px 3px rgba(0,0,0,0.6);
}

/* Pagination Dots */
#hangar-pagination-wrapper {
    position: absolute;
    bottom: 1.25rem; /* The 55% value, as a gap from the bottom of the screen */
    left: 0;
    right: 0;
    z-index: 10; /* Ensure it's above the card content */

    flex-shrink: 0;
    overflow-x: auto;
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
    scrollbar-width: none;
    -ms-overflow-style: none;
    display: flex;
    justify-content: center;
}

#hangar-pagination-wrapper::-webkit-scrollbar {
    display: none;
}

#hangar-pagination {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    gap: 0.9775rem;
    width: max-content;
    padding: 0 1rem;
}

.pagination-dot {
    width: 1.8rem;
    height: 2.25rem;
    border-radius: 4px;
    background-color: var(--theme-color-primary, #4b5563);
    opacity: 0.3;
    transition: all 0.3s ease;
    cursor: pointer;
    pointer-events: auto; /* Make pagers interactive */
    display: block; 
}

.pagination-dot.active { 
    background-color: var(--theme-color-primary, #fde047);
    box-shadow: 0 0 8px var(--theme-glow-color, #fef08a);
    opacity: 1.0;
}

.pagination-dot.half {
    width: 0.9rem; /* Half the original width */
    opacity: 0.2;
}

/* Spec Cards (REMOVED) */

/* Responsive adjustments for smaller screens */
@media (max-width: 768px) {
    .ship-card-content-wrapper {
        grid-template-columns: 1fr; /* Stack columns vertically */
    }
    .ship-card-content-wrapper > .col-span-2,
    .ship-card-content-wrapper > .col-span-3 {
        grid-column: span 1 / span 1; /* Make each column take full width */
    }
    
.ship-display-area {
        min-height: 180px; /* Ensure hologram area has enough height */
    }
}
--- END OF FILE: ./css/screens/hangar-screen.css ---

--- START OF FILE: ./css/screens/navigation-screen.css ---
/* css/screens/navigation-screen.css */
.navigation-scroll-panel {
    /* height: 75vh; */ /* REMOVED */
    overflow-y: auto;
    scrollbar-width: none; /* For Firefox */
    -ms-overflow-style: none; /* For Internet Explorer 10+ */
    touch-action: pan-y; /* Allow vertical scrolling */

    /*
     * This creates a 1.5rem buffer on the left and right
     * and maintains the 0.25rem vertical padding.
     * This is a compromise to prevent clipping on hover
     * without making the cards "skinnier".
    */
    padding-top: 0.25rem;
    padding-bottom: 0.25rem;
    padding-left: 1.5rem;  /* Reduced from 3.5rem */
    padding-right: 1.5rem; /* Reduced from 3.5rem */
    box-sizing: border-box; /* Ensures padding is inset */
}
.navigation-scroll-panel::-webkit-scrollbar {
    display: none; /* For Chrome, Safari, and Opera */
}

.location-card {
    display: flex;
    flex-direction: column;
    border-width: 2px;
    transition: all 0.3s ease;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
}
.location-card p {
    word-wrap: break-word;
    white-space: normal;
    font-size: 0.875rem;
    line-height: 1.25rem;
}
.location-card:not(.highlight-current):hover { transform: scale(1.05); cursor: pointer; }
.location-card.disabled-current { cursor: pointer;
}

.location-card.highlight-current {
    animation: themed-glow-animation 3s infinite;
}

.location-card-footer {
    margin-top: auto;
}

@media (max-width: 768px) {
    .travel-info-mobile {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
}
--- END OF FILE: ./css/screens/navigation-screen.css ---

--- START OF FILE: ./css/navigation.css ---
/* css/navigation.css */

/* ================================================================================
BULKHEAD NAVIGATION STYLES
================================================================================ */
.nav-wrapper {
    background-color: #383838;
    background-image: radial-gradient(circle, rgba(255,255,255,.03) 1px, transparent 1px);
    background-size: 10px 10px;
    display: flex;
    align-items: center;
    padding: 0 5px 0 10px;
    /* Bevel effect to connect with the context bar above */
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
}

.nav-main {
    display: flex;
}

.tab {
    padding: 7.5px 15px;
    color: #a0aec0;
    opacity: 0.7;
    cursor: pointer;
    font-family: 'Orbitron', sans-serif;
    font-weight: 700;
    font-size: 0.8rem;
    position: relative; /* Establishes stacking context for z-index */
    background-color: #444;
    border-top: 1px solid #666;
    /* Added transition for smooth scaling and filter effects */
    transition: all 0.3s ease;
    text-decoration: none;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.4));
    -webkit-user-select: none;
    -ms-user-select: none;
    user-select: none;

    /* --- Core Interlocking Logic --- */
    clip-path: polygon(12px 0, 100% 0, calc(100% - 12px) 100%, 0% 100%);
    margin-left: -12px; /* Overlap by the same amount as the clip-path skew */
}

/* Straighten the left edge of the very first tab and remove its negative margin */
.tab:first-child {
    clip-path: polygon(0 0, 100% 0, calc(100% - 12px) 100%, 0% 100%);
    margin-left: -8px;
}

.tab.disabled {
    pointer-events: none;
    filter: grayscale(1);
    opacity: 0.3;
}

.tab.active {
    opacity: 1;
    z-index: 2; /* Bring the active tab to the front */
    transform: scale(1.05); /* The "raised" effect */
    /* Active tab has a drop-shadow for depth and a theme-colored glow */
    filter: drop-shadow(0 4px 6px rgba(0,0,0,0.6)) drop-shadow(0 0 8px var(--theme-color-glow, #fde047));
}

#sub-nav-bar {
    /* * FIXED: Bottom radius is 14px (15px container - 1px border) to nest inside. */
    border-radius: 0 0 14px 14px;
    overflow: hidden;
}

.nav-sub {
    background-color: #222;
    padding: 0;
    display: flex;
    justify-content: center;
    border-top: 1px solid #333;
}

.nav-sub a {
    flex-grow: 1;
    text-align: center;
    opacity: 0.8;
    font-family: 'Orbitron', sans-serif; /* Matched font */
    font-size: 0.75rem;
    font-weight: 500;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5); /* Added text shadow for depth */
    text-transform: uppercase;
    padding: 8.75px 0;
    text-decoration: none;
    position: relative; /* Needed for the ::after pseudo-element */
    transition: all 0.2s;
    background-color: #3a3a3a;
    border-right: 1px solid #1c1c1c;
    border-left: 1px solid #4a4a4a;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
    draggable: false;
    -webkit-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -webkit-touch-callout: none; /* Add this line to disable tap-hold menu on iOS */
}

/* Active Sub-Nav Indicator */
.nav-sub a.sub-nav-active::after {
    content: '';
    position: absolute;
    bottom: 4px; /* Position the line just below the text */
    left: 50%;
    transform: translateX(-50%);
    width: 60%;
    height: 2px;
    background-color: var(--theme-border-color, #fde047);
    border-radius: 1px;
    box-shadow: 0 0 5px var(--theme-border-color, #fde047);
}


.nav-sub a.disabled {
    pointer-events: none;
    filter: grayscale(1);
    opacity: 0.3;
}


.nav-sub a:first-child { border-left: none;
}
.nav-sub a:last-child { border-right: none; }

/* --- [[END]] NEW BULKHEAD STYLES --- */


/* --- [[START]] DEPRECATED STYLES --- */
.btn-header {
     padding: 0.2rem 1.5rem;
     font-size: 1.125rem;
     flex: 1;
     background-blend-mode: overlay;
     background-image: linear-gradient(rgba(255,255,255,0.08), rgba(0,0,0,0.1));
}

@media (max-width: 768px) {
    .btn-header {
        padding: 0.2rem 0.6rem;
        font-size: 0.8rem;
        flex: 1;
        min-width: 0;
        width: auto;
    }
}
/* --- [[END]] DEPRECATED STYLES --- */
--- END OF FILE: ./css/navigation.css ---

--- START OF FILE: ./css/orientation.css ---
/* css/orientation.css */
#orientation-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #0c101d;
    color: #d0d8e8;
    z-index: 2000; 
    justify-content: center;
    align-items: center;
    text-align: center;
    font-family: 'Orbitron', sans-serif;
}

@media (orientation: landscape) {
    #orientation-overlay {
        display: flex;
    }
    /* Optional: Hide the main game container to be safe */
    #game-container {
        display: none;
    }
}
--- END OF FILE: ./css/orientation.css ---

--- START OF FILE: ./js/ui/renderers/IntelMarketRenderer.js ---
// js/ui/renderers/IntelMarketRenderer.js
/**
 * @fileoverview This file contains the IntelMarketRenderer class.
 * Its sole responsibility is to dynamically render the content for the
 * "Intel Market" tab based on the player's current location and game state.
 */

import { DB } from '../../data/database.js';
import { formatCredits } from '../../utils.js';

/**
 * @class IntelMarketRenderer
 * @description Renders the dynamic content of the "Intel Market" tab.
 */
export class IntelMarketRenderer {
    /**
     * @param {import('../services/IntelService.js').IntelService} intelService
     */
    constructor(intelService) {
        this.intelService = intelService;
        this.db = DB;
    }

    /**
     * Renders the intel packet buttons into the provided container.
     * @param {HTMLElement} containerElement - The div#intel-market-content element.
     * @param {object} gameState - The current raw game state object.
     * @JSDoc
     */
    render(containerElement, gameState) {
        const state = gameState;
        const { currentLocationId, activeIntelDeal, intelMarket } = state;
        
        // --- VIRTUAL WORKBENCH: MODIFICATION (REQUEST A) ---
        // 1. Get the *single* active purchased packet, if it exists
        const globalPurchasedPackets = [];
        if (activeIntelDeal) {
            const purchasedPacket = Object.values(intelMarket)
                .flat()
                .find(packet => packet.isPurchased && packet.id === activeIntelDeal.sourcePacketId);
            
            if (purchasedPacket) {
                globalPurchasedPackets.push(purchasedPacket);
            }
        }

        // 2. Get unpurchased packets *only* from the current location
        const localUnpurchasedPackets = (intelMarket[currentLocationId] || [])
            .filter(packet => !packet.isPurchased);

        // 3. Combine lists, with purchased intel always at the top
        const combinedList = [...globalPurchasedPackets, ...localUnpurchasedPackets];
        // --- END MODIFICATION ---

        const isLocked = activeIntelDeal !== null;

        if (combinedList.length === 0) {
            containerElement.innerHTML = `<p class="text-gray-400 text-center italic p-4">No intel data available at this location.</p>`;
            return;
        }

        const html = combinedList.map(packet => {
            if (packet.isPurchased) {
                return this._renderPurchasedButton(packet);
            } else {
                // Price is calculated at render time
                const price = this.intelService.calculateIntelPrice(packet);
                return this._renderOfferButton(packet, price, isLocked);
            }
        }).join('');

        containerElement.innerHTML = `<div class="w-full max-w-md mx-auto flex flex-col gap-4">${html}</div>`;
    }

    /**
     * Renders a button for a previously purchased intel packet.
     * @param {object} packet - The intelPacket object.
     * @returns {string} HTML for the "View Intel" button.
     * @private
     * @JSDoc
     */
    _renderPurchasedButton(packet) {
        // --- VIRTUAL WORKBENCH: MODIFICATION (THEMING - REQUEST A) ---
        const dealLocation = this.db.MARKETS.find(m => m.id === packet.dealLocationId);
        const dealLocationName = dealLocation?.name || 'Unknown Location';
        
        // Get theme from the DEAL location
        const theme = dealLocation?.navTheme || {
            gradient: 'linear-gradient(135deg, #4a5568, #2d3748)', // Default gradient
            borderColor: '#7a9ac0', // Default border
            textColor: '#f0f0ff' // Default text
        };

        const style = `
            --theme-gradient: ${theme.gradient};
            --theme-border-color: ${theme.borderColor};
            --theme-text-color: ${theme.textColor};
        `;
        // --- END MODIFICATION ---
        
        return `
            <button class="btn btn-intel btn-intel-purchased" style="${style}" data-action="show_intel_details" 
                    data-packet-id="${packet.id}" 
                    data-location-id="${packet.locationId}"> 
                ${dealLocationName} - View Intel
            </button>`;
    }

    /**
     * Renders a button for a purchasable intel packet.
     * @param {object} packet - The intelPacket object.
     * @param {number} price - The dynamically calculated price.
     * @param {boolean} isLocked - Whether the Intel Market is locked by an active deal.
     * @returns {string} HTML for the "Purchase" button.
     * @private
     * @JSDoc
     */
    _renderOfferButton(packet, price, isLocked) {
        // --- VIRTUAL WORKBENCH: MODIFICATION ---
        // Display the DEAL location name, not the SALE location name.
        const dealLocationName = this.db.MARKETS.find(m => m.id === packet.dealLocationId)?.name || 'Unknown Location';
        // --- END MODIFICATION ---

        const disabledAttr = isLocked ? 'disabled' : '';
        const title = isLocked ? 'You already have an active intel deal.' : `Purchase intel for a deal at ${dealLocationName}`;
        
        // --- VIRTUAL WORKBENCH START: Phase 3 ---
        // Conditionally apply pulsing class only if not locked
        const priceHtml = isLocked
            ? formatCredits(price, true) // Plain text (with symbol) for disabled button
            : `<span class="credits-text-pulsing">${formatCredits(price, true)}</span>`; // Pulsing class for active button

        return `
            <button class="btn btn-intel" 
                    data-action="show_intel_offer" 
                    data-packet-id="${packet.id}" 
                    data-location-id="${packet.locationId}" data-price="${price}" 
                    title="${title}"
                    ${disabledAttr}>
                ${dealLocationName} ${priceHtml}
            </button>`;
        // --- VIRTUAL WORKBENCH END: Phase 3 ---
    }
}
--- END OF FILE: ./js/ui/renderers/IntelMarketRenderer.js ---

--- START OF FILE: ./js/ui/components/MapScreen.js ---
// js/ui/components/MapScreen.js
/**
 * @fileoverview This file contains the rendering logic for the new Map screen.
 * It uses D3.js to render a stylized, interactive map of the solar system.
 *
 * ARCHITECTURE: "Hybrid Layering"
 * This component renders two layers:
 * 1. Substrate (SVG): A D3-drawn SVG background (#map-svg-substrate) for static
 * visuals like the central axis and leader lines.
 * 2. Interface (HTML): D3-generated, absolutely-positioned HTML <div>s
 * (#map-html-interface) for all interactive POIs (including the Sun) and labels.
 *
 * This hybrid approach avoids WKWebView rendering bugs related to SVG filters
 * by moving all interactive elements to standard HTML, which can be reliably
 * styled with pseudo-elements and CSS animations. Both layers are driven by a
 * single, unified data source to ensure perfect alignment.
 */
import { DB } from '../../data/database.js';
import { LOCATION_IDS } from '../../data/constants.js';

/**
 * Renders the two-layer container for the Map screen UI.
 * @returns {string} The HTML content for the Map screen container.
 */
export function renderMapScreen() {
    // #map-container is the scrolling parent
    // #map-svg-substrate holds the D3-drawn static background (z-index 1)
    // #map-html-interface holds the D3-bound HTML POIs (z-index 10)
    return `
        <div id="map-container" class="w-full h-full overflow-y-auto">
            <svg id="map-svg-substrate"></svg>
            <div id="map-html-interface"></div>
        </div>
    `;
}

/**
 * Initializes the D3 map, calculating data and drawing both layers.
 * @param {import('../../services/UIManager.js').UIManager} uiManager
 */
export function initMap(uiManager) {
    const container = d3.select("#map-container");
    const svgLayer = d3.select("#map-svg-substrate");
    const htmlLayer = d3.select("#map-html-interface");

    if (container.node().clientWidth === 0) {
        console.warn("Map container width is 0. Using ResizeObserver.");
        const observer = new ResizeObserver(entries => {
            if (entries[0].contentRect.width > 0) {
                _drawMap(container, svgLayer, htmlLayer, uiManager);
                observer.disconnect();
            }
        });
        observer.observe(container.node());
    } else {
        _drawMap(container, svgLayer, htmlLayer, uiManager);
    }
}

/**
 * Master drawing function. Calculates data and delegates to layer-specific
 * drawing functions.
 * @param {d3.Selection} container
 * @param {d3.Selection} svgLayer
 * @param {d3.Selection} htmlLayer
 * @param {import('../../services/UIManager.js').UIManager} uiManager
 * @private
 */
function _drawMap(container, svgLayer, htmlLayer, uiManager) {
    // Clear any previous map elements (for live-reload dev)
    svgLayer.selectAll("*").remove();
    htmlLayer.selectAll("*").remove();

    const containerWidth = container.node().clientWidth;
    const centerX = containerWidth / 2;

    // 1. Calculate the unified POI data array
    const { poiData, totalHeight } = _calculatePOIData(containerWidth, uiManager, centerX);

    // 2. Set the total height on the containers to enable scrolling
    container.style("height", "100%"); // Ensure container has a defined height
    svgLayer.attr("height", totalHeight);
    htmlLayer.style("height", `${totalHeight}px`);

    // 3. Draw the static SVG background
    _drawSubstrate(svgLayer, poiData, centerX, totalHeight);

    // 4. Draw the interactive HTML POIs
    _drawInterface(htmlLayer, poiData, uiManager, centerX);

    // 5. Apply the "you are here" highlight
    _updateCurrentLocationHighlight(uiManager);
}

/**
 * The "Brain" of the map. Calculates the unified data array used by both layers.
 * @param {number} containerWidth
 * @param {import('../../services/UIManager.js').UIManager} uiManager
 * @param {number} centerX
 * @returns {{poiData: Array<object>, totalHeight: number}}
 * @private
 */
function _calculatePOIData(containerWidth, uiManager, centerX) {
    const sizeModifiers = {
        [LOCATION_IDS.VENUS]: 1.035,
        [LOCATION_IDS.EARTH]: 1.035,
        [LOCATION_IDS.LUNA]: 0.805,
        [LOCATION_IDS.MARS]: 0.9775,
        [LOCATION_IDS.BELT]: 0.805,
        [LOCATION_IDS.EXCHANGE]: 0.805,
        [LOCATION_IDS.JUPITER]: 1.564,
        [LOCATION_IDS.SATURN]: 1.46625,
        [LOCATION_IDS.URANUS]: 1.27075,
        [LOCATION_IDS.NEPTUNE]: 1.27075,
        [LOCATION_IDS.KEPLER]: 0.8625,
        [LOCATION_IDS.PLUTO]: 0.92,
    };

    const allPoiData = DB.MARKETS
        .filter(loc => uiManager.lastKnownState.player.unlockedLocationIds.includes(loc.id))
        .map(loc => {
            let effectiveDistance = loc.distance;
            if (loc.parent) {
                const parent = DB.MARKETS.find(p => p.id === loc.parent);
                if (parent) effectiveDistance = parent.distance + 0.1;
            }
            return { ...loc, effectiveDistance };
        })
        .sort((a, b) => a.effectiveDistance - b.effectiveDistance);

    const verticalSpacing = 130;
    const topPadding = 110;
    const bottomPadding = 30;
    const totalHeight = topPadding + ((allPoiData.length - 1) * verticalSpacing) + bottomPadding;

    // Create the final data array with all calculated pixel coordinates
    const poiData = allPoiData.map((d, i) => {
        const y = topPadding + (i * verticalSpacing);
        const x = centerX + (i % 2 === 0 ? -50 : 50); // POI x-position
        const labelX = centerX + (i % 2 === 0 ? -56 : 56); // Label x-position
        const labelAnchor = (i % 2 === 0 ? "end" : "start");
        const radius = (d.parent ? 12 : 16) * (sizeModifiers[d.id] || 1);

        return {
            ...d,
            y,
            poiX: centerX, // X coord of the icon on the central axis
            labelX,
            labelAnchor,
            leaderLineX: x, // X coord for the end of the leader line
            radius
        };
    });

    return { poiData, totalHeight };
}

/**
 * Draws the static, non-interactive SVG background layer.
 * @param {d3.Selection} svgLayer
 * @param {Array<object>} poiData
 * @param {number} centerX
 * @param {number} totalHeight
 * @private
 */
function _drawSubstrate(svgLayer, poiData, centerX, totalHeight) {
    // --- VIRTUAL WORKBENCH: Removed Sun and Gradient definitions ---

    svgLayer.append("line")
        .attr("class", "central-axis")
        .attr("x1", centerX)
        .attr("y1", 0)
        .attr("x2", centerX)
        .attr("y2", totalHeight);

    // Bind data to draw the leader lines
    svgLayer.selectAll(".leader-line")
        .data(poiData)
        .enter()
        .append("line")
        .attr("class", "leader-line")
        .attr("x1", centerX)
        .attr("y1", d => d.y)
        .attr("x2", d => d.leaderLineX)
        .attr("y2", d => d.y);
}

/**
 * Draws the interactive HTML interface layer.
 * @param {d3.Selection} htmlLayer
 * @param {Array<object>} poiData
 * @param {import('../../services/UIManager.js').UIManager} uiManager
 * @param {number} centerX
 * @private
 */
function _drawInterface(htmlLayer, poiData, uiManager, centerX) {
    // --- VIRTUAL WORKBENCH: Add the Sun as an HTML element ---
    const sunRadius = 225;
    htmlLayer.append("div")
        .attr("id", "map-sun-poi")
        .style("position", "absolute")
        .style("top", "-195px") // Original cy
        .style("left", `${centerX}px`) // Original cx
        .style("width", `${sunRadius * 2}px`)
        .style("height", `${sunRadius * 2}px`);
    // --- END VIRTUAL WORKBENCH ---

    // Bind data to create HTML <div>s
    const groups = htmlLayer.selectAll(".poi-marker-group")
        .data(poiData)
        .enter()
        .append("div")
        .attr("class", "poi-marker-group")
        .attr("data-location-id", d => d.id)
        .style("position", "absolute")
        .style("top", d => `${d.y}px`)
        .on("click", (event, d) => {
            uiManager.showMapDetailModal(d.id);
        });

    // POI Icons (on the central axis)
    groups.append("div")
        .attr("class", d => d.id === LOCATION_IDS.BELT ? "poi-icon belt" : "poi-icon planet")
        .style("position", "absolute")
        .style("left", d => `${d.poiX}px`) // Centered on axis
        .style("width", d => `${d.radius * 2}px`)
        .style("height", d => `${d.radius * 2}px`)
        .style("background-color", d => d.navTheme.borderColor);

    // POI Labels (alternating sides)
    groups.append("div")
        .attr("class", "poi-label")
        .style("position", "absolute")
        .style("left", d => `${d.labelX}px`)
        .style("text-anchor", d => d.labelAnchor)
        .text(d => d.name);
}

/**
 * Updates the HTML interface to apply the .current-location class
 * AND auto-scrolls the container to center the POI.
 * This is called every time the map is viewed.
 * @param {import('../../services/UIManager.js').UIManager} uiManager
 * @private
 */
function _updateCurrentLocationHighlight(uiManager) {
    const container = d3.select("#map-container");
    if (container.empty()) return;

    const currentLocationId = uiManager.lastKnownState.currentLocationId;
    const locationData = DB.MARKETS.find(loc => loc.id === currentLocationId);
    if (!locationData) return;

    // 1. Set the global theme color on the root container
    container.style("--theme-glow-color", locationData.navTheme.borderColor);

    // 2. Remove the class from the old POI (if any)
    container.select(".poi-marker-group.current-location")
        .classed("current-location", false);

    // 3. Add the class to the new, current POI
    const currentPOIGroup = container.select(`.poi-marker-group[data-location-id="${currentLocationId}"]`);
    currentPOIGroup.classed("current-location", true);

    // Auto-scroll logic
    const containerNode = container.node();
    const poiNode = currentPOIGroup.node();

    if (containerNode && poiNode) {
        // Handle Pluto edge case: scroll to bottom
        if (currentLocationId === LOCATION_IDS.PLUTO) {
            containerNode.scrollTop = containerNode.scrollHeight;
        } else {
            // Main case: center the POI
            const containerHeight = containerNode.clientHeight;
            const poiTop = poiNode.offsetTop; // POI's Y position
            
            // Calculate the scroll position to center the POI
            const newScrollTop = poiTop - (containerHeight / 2);
            
            // Set the scroll position
            containerNode.scrollTop = newScrollTop;
        }
    }
}
--- END OF FILE: ./js/ui/components/MapScreen.js ---

--- START OF FILE: ./js/ui/components/HangarScreen.js ---
// js/ui/components/HangarScreen.js
/**
 * @fileoverview Renders the Hangar screen, now a unified "Ship Terminal" with toggleable
 * Hangar and Shipyard views, a central ship display, and a carousel.
 */
import { DB } from '../../data/database.js';
import { formatCredits, calculateInventoryUsed } from '../../utils.js';
import { ACTION_IDS, SHIP_IDS, GAME_RULES } from '../../data/constants.js';

/**
 * Renders the entire Hangar screen UI.
 * @param {object} gameState - The current state of the game.
 * @param {import('../../services/SimulationService.js').SimulationService} simulationService - The simulation service.
 * @returns {string} The HTML content for the Hangar screen.
 */
export function renderHangarScreen(gameState, simulationService) {
    const { uiState, player, tutorials } = gameState;

    // Determine the current mode (Hangar or Shipyard)
    const isHangarMode = uiState.hangarShipyardToggleState === 'hangar';
    const modeClass = isHangarMode ? 'mode-hangar' : 'mode-shipyard';
    
    const shipList = isHangarMode ? player.ownedShipIds : simulationService._getShipyardInventory().map(([id]) => id);
    
    // Use the active index from the UI state for the carousel
    const activeCarouselIndex = isHangarMode 
        ? (uiState.hangarActiveIndex || 0) 
        : (uiState.shipyardActiveIndex || 0);

    // Ensure index is not out of bounds if ship list changes
    const displayIndex = Math.min(activeCarouselIndex, Math.max(0, shipList.length - 1));

    // NOTE: The pagination dots are now rendered dynamically by the UIManager._updateHangarScreen method.
    return `
        <div class="flex flex-col h-full">
            <div id="ship-terminal-container" class="flex flex-col flex-grow min-h-0 ${modeClass}">
                <div class="toggle-container mx-auto my-1">
                    <div class="toggle-switch p-1 rounded-md flex w-[180px] h-10">
                        <div class="toggle-label hangar flex-1 text-center py-1 cursor-pointer" data-action="${ACTION_IDS.TOGGLE_HANGAR_MODE}" data-mode="hangar">HANGAR</div>
                        <div class="toggle-label shipyard flex-1 text-center py-1 cursor-pointer" data-action="${ACTION_IDS.TOGGLE_HANGAR_MODE}" data-mode="shipyard">SHIPYARD</div>
                    </div>
                </div>

                <div class="carousel-container flex-grow overflow-hidden relative">
                    <div id="hangar-carousel" class="flex h-full" style="transform: translateX(-${displayIndex * 100}%)">
                        ${shipList.map(shipId => _renderShipCarouselPage(gameState, shipId, isHangarMode)).join('') || _renderEmptyCarouselPage(isHangarMode)}
                    </div>
                </div>
            </div>
            <div id="hangar-pagination-wrapper">
                <div id="hangar-pagination">
                    {/* This will be populated by UIManager._renderHangarPagination */}
                </div>
            </div>
        </div>
    `;
}

/**
 * Renders a placeholder page for when a carousel is empty.
 * @param {boolean} isHangarMode - True if the hangar is empty, false if the shipyard is empty.
 * @returns {string} HTML for the empty page.
 * @private
 */
function _renderEmptyCarouselPage(isHangarMode) {
    const message = isHangarMode ? "Your hangar is empty." : "No ships available in the shipyard.";
    return `
        <div class="carousel-page p-2 md:p-4 w-full">
            <div id="ship-terminal" class="relative h-full rounded-lg border-2" style="border-color: var(--frame-border-color);">
                <div class="flex flex-col items-center justify-center h-full">
                    <p class="text-gray-400">${message}</p>
                </div>
            </div>
        </div>
    `;
}


/**
 * Renders a single page within the ship carousel.
 * @param {object} gameState The current game state.
 * @param {string} shipId The ID of the ship for this page.
 * @param {boolean} isHangarMode True if the view is for the player's hangar.
 * @returns {string} The HTML for a single carousel page.
 * @private
 */
function _renderShipCarouselPage(gameState, shipId, isHangarMode) {
    const shipStatic = DB.SHIPS[shipId];
    // VIRTUAL WORKBENCH: Bug Fix B - We no longer need the destructured 'player' here.
    const shipDynamic = isHangarMode ? gameState.player.shipStates[shipId] : null;
    const { player } = gameState; // Keep this for _renderActionButtons

    // Determine Status Badge
    let statusBadgeHtml = '';
    const isActive = player.activeShipId === shipId; 
    if (isHangarMode) {
        statusBadgeHtml = `<div class="status-badge" style="border-color: ${isActive ? 'var(--theme-color-primary)' : 'var(--ot-border-light)'}; color: ${isActive ? 'var(--theme-color-primary)' : 'var(--ot-text-secondary)'};">${isActive ? 'ACTIVE' : 'STORED'}</div>`;
    }

    // Conditional rendering for shipyard layout
    const shipyardLayout = `
        <div class="col-span-3 flex flex-col justify-between">
            <div class="ship-display-area flex-grow flex items-center justify-center relative">
                <div class="ship-image-placeholder w-full rounded-lg flex items-center justify-center">
                    <span class="text-2xl font-orbitron">[ SHIP HOLOGRAM ]</span>
                </div>
                ${statusBadgeHtml}
            </div>
        </div>
        <div class="col-span-2 flex flex-col justify-between">
            ${_renderInfoPanel(gameState, shipId, shipStatic, shipDynamic, isHangarMode)}
            <div class="action-buttons-container pt-2">
                ${_renderActionButtons(shipId, shipStatic, player, isHangarMode, gameState.tutorials)}
            </div>
        </div>
    `;

    const hangarLayout = `
        <div class="col-span-2 flex flex-col justify-between">
            ${_renderInfoPanel(gameState, shipId, shipStatic, shipDynamic, isHangarMode)}
        </div>

        <div class="col-span-3 flex flex-col justify-between">
            <div class="ship-display-area flex-grow flex items-center justify-center relative">
                <div class="ship-image-placeholder w-full rounded-lg flex items-center justify-center">
                    <span class="text-2xl font-orbitron">[ SHIP HOLOGRAM ]</span>
                </div>
                ${statusBadgeHtml}
            </div>
            
            <div class="action-buttons-container pt-2">
                ${_renderActionButtons(shipId, shipStatic, player, isHangarMode, gameState.tutorials)}
            </div>
        </div>
    `;

    // --- VIRTUAL WORKBENCH: MODIFICATION ---
    // Added the .active-ship class conditionally based on isActive and isHangarMode.
    return `
        <div class="carousel-page p-2 md:p-4 w-full">
            <div id="ship-terminal" class="relative h-full rounded-lg border-2 ${isActive && isHangarMode ? 'active-ship' : ''}" style="border-color: var(--frame-border-color);">
                <div id="ship-card-main-content" class="h-full">
                    <div class="ship-card-content-wrapper h-full">
                        ${isHangarMode ? hangarLayout : shipyardLayout}
                    </div>
                </div>
            
            </div>
        </div>
    `;
    // --- END VIRTUAL WORKBENCH ---
}


/**
 * Renders the appropriate info panel (Hangar or Shipyard).
 * @param {object} gameState - The current state of the game.
 * @param {string} shipId - The ID of the ship.
 * @param {object} shipStatic - The static data for the ship.
 * @param {object} shipDynamic - The dynamic state for the ship (hangar only).
 * @param {boolean} isHangarMode - True if rendering the hangar view.
 * @returns {string} The HTML for the info panel.
 * @private
 */
// VIRTUAL WORKBENCH: Bug Fix B - Removed 'player' from args, will use 'gameState.player'
function _renderInfoPanel(gameState, shipId, shipStatic, shipDynamic, isHangarMode) {
    const shipClassLower = shipStatic.class.toLowerCase();

    // --- [[START]] VIRTUAL WORKBENCH (Corrective Action) ---
    // Replaced shipStatic.lore with shipStatic.description
    if (isHangarMode) {
        return `
            <div class="info-panel-content info-panel-hangar flex-col justify-between h-full">
                <div class="info-panel-header">
                    <div class="info-panel-text">
                        <h3 class="text-2xl font-orbitron inset-text-shadow" style="color: var(--class-${shipClassLower}-color);">${shipStatic.name}</h3>
                        <p class="text-md text-gray-400 inset-text-shadow">Class ${shipStatic.class} ${shipStatic.role || 'Freighter'}</p>
                    </div>
                    ${_renderParamBars(shipStatic, shipDynamic, gameState.player, false, shipId)}
                </div>
                
                <div class="flavor-text-box mt-auto" style="border-color: var(--frame-border-color);">
                    <p class="text-sm text-gray-300">${shipStatic.description}</p>
                </div>
            </div>
        `;
    } else {
        return `
             <div class="info-panel-content info-panel-shipyard flex-col justify-between h-full">
                <div class="info-panel-header">
                    <div class="info-panel-text">
                        <h3 class="text-2xl font-orbitron inset-text-shadow" style="color: var(--class-${shipClassLower}-color);">${shipStatic.name}</h3>
                        <p class="text-md text-gray-400 inset-text-shadow">Class ${shipStatic.class} ${shipStatic.role || 'Freighter'}</p>
                        <p class="ship-price-display font-roboto-mono text-2xl credits-text-pulsing">${formatCredits(shipStatic.price, true)}</p>
                    </div>
                    ${_renderParamBars(shipStatic, shipDynamic, gameState.player, true, shipId)}
                </div>

                <div class="flavor-text-box mt-auto" style="border-color: var(--frame-border-color);">
                    <p class="text-sm text-gray-300">${shipStatic.description}</p>
                </div>
            </div>
        `;
    }
    // --- [[END]] VIRTUAL WORKBENCH (Corrective Action) ---
}


/**
 * Renders the appropriate action buttons (Hangar or Shipyard).
 * @param {string} shipId - The ID of the ship.
 * @param {object} shipStatic - The static data for the ship.
 * @param {object} player - The player object.
 * @param {boolean} isHangarMode - True if rendering the hangar view.
 * @param {object} tutorials - The current tutorial state.
 * @returns {string} The HTML for the action buttons.
 * @private
 */
function _renderActionButtons(shipId, shipStatic, player, isHangarMode, tutorials) {
    if (isHangarMode) {
        const isActive = player.activeShipId === shipId;
        const canSell = player.ownedShipIds.length > 1 && !isActive;
        const salePrice = Math.floor(shipStatic.price * GAME_RULES.SHIP_SELL_MODIFIER);
        
        return `
            <div class="grid grid-cols-2 gap-2">
                <button class="action-button" data-action="${ACTION_IDS.SELECT_SHIP}" data-ship-id="${shipId}" ${isActive ? 'disabled' : ''} style="background-color: ${isActive ? '#374151' : 'var(--ot-cyan-base)'}; color: ${isActive ? 'var(--ot-text-secondary)' : 'var(--ot-bg-dark)'};">
                    <span class="font-bold">${isActive ? 'ACTIVE' : 'BOARD'}</span>
                </button>
                <button class="action-button" data-action="${ACTION_IDS.SELL_SHIP}" data-ship-id="${shipId}" ${!canSell ? 'disabled' : ''} style="background-color: var(--ot-hangar-red-base);">
                    <span class="font-bold">SELL</span>
                    <span class="action-button-price font-roboto-mono credits-text-pulsing">${formatCredits(salePrice, true)}</span>
                </button>
            </div>
        `;
    } else { // Shipyard
        const canAfford = player.credits >= shipStatic.price;
        const activeStep = tutorials.activeBatchId ? DB.TUTORIAL_DATA[tutorials.activeBatchId]?.steps.find(s => s.stepId === tutorials.activeStepId) : null;
        const isPurchaseLocked = tutorials.activeBatchId === 'intro_hangar' && !activeStep?.unlockPurchase;
        const isDisabled = !canAfford || isPurchaseLocked;
        
        return `
            <button class="action-button w-full justify-center" data-action="${ACTION_IDS.BUY_SHIP}" data-ship-id="${shipId}" ${isDisabled ? 'disabled' : ''} style="background-color: var(--ot-green-accent);">
                <span class="font-bold">PURCHASE</span>
            </button>
        `;
    }
}


// --- VIRTUAL WORKBENCH START ---
/**
 * Renders the HULL, CARGO, and FUEL parameter bars.
 * @param {object} shipStatic - The static data for the ship (for max values).
 * @param {object} shipDynamic - The dynamic state (health, fuel). Null for shipyard.
 * @param {object} player - The player object (for cargo).
 * @param {boolean} [isShipyard=false] - Flag to determine style and values.
 * @param {string} shipId - The specific ID of the ship being rendered.
 * @returns {string} HTML for the parameter bars.
 * @private
 */
function _renderParamBars(shipStatic, shipDynamic, player, isShipyard = false, shipId) {
    // --- VIRTUAL WORKBENCH: BUG FIX ---
    // The incorrect line 'const shipId = shipStatic.id;' has been removed.
    // The correct 'shipId' is now passed in as an argument.
    // --- END BUG FIX ---

    // Determine current values
    const currentHull = isShipyard ? shipStatic.maxHealth : shipDynamic?.health ?? 0;
    // VIRTUAL WORKBENCH: Request E - This logic is correct and matches the nav bar.
    // It reads the *entire* player object and keys into the *specific* ship's inventory.
    const currentCargo = isShipyard ? shipStatic.cargoCapacity : calculateInventoryUsed(player.inventories[shipId]);
    const currentFuel = isShipyard ? shipStatic.maxFuel : shipDynamic?.fuel ?? 0;

    // Determine percentages
    const hullPct = shipStatic.maxHealth > 0 ? (currentHull / shipStatic.maxHealth) * 100 : 0;
    const cargoPct = shipStatic.cargoCapacity > 0 ? (currentCargo / shipStatic.cargoCapacity) * 100 : 0;
    const fuelPct = shipStatic.maxFuel > 0 ? (currentFuel / shipStatic.maxFuel) * 100 : 0;
    // Determine colors
    const hullColor = 'var(--ot-green-accent)';
    // VIRTUAL WORKBENCH: Request B - Match nav bar colors
    const cargoColor = '#f59e0b'; // Was 'var(--class-s-color)'
    const fuelColor = '#3b82f6'; // Was 'var(--ot-shipyard-blue-base)'

    /**
     * Helper to render a single bar with its text overlay.
     * @param {string} label - The bar's label (e.g., "HULL").
     * @param {number} current - The current value.
     * @param {number} max - The maximum value.
     * @param {number} percentage - The fill percentage.
     * @param {string} color - The bar's fill color.
     * @returns {string} HTML for a single bar item.
     */
    const renderBar = (label, current, max, percentage, color) => {
        const c = Math.floor(current);
        const m = Math.floor(max);
        
        const isMax = (c >= m);
        const displayText = isMax ? m : `${c} / ${m}`;
        const textClass = isMax ? 'max' : 'partial'; // ADDED: Class for alignment

        return `
            <div class="param-bar-item">
                <span class="param-bar-label">${label}</span>
                <div class="param-bar-track">
                    <div class="param-bar-fill" style="width: ${percentage}%; background-color: ${color}; --bar-color: ${color};"></div>
                    <span class="param-bar-text ${textClass}">${displayText}</span>
                </div>
            </div>
        `;
    };

    return `
        <div class="ship-param-bars ${isShipyard ? 'shipyard-bars' : ''}">
            ${renderBar('HULL', currentHull, shipStatic.maxHealth, hullPct, hullColor)}
            ${renderBar('CARGO', currentCargo, shipStatic.cargoCapacity, cargoPct, cargoColor)}
            ${renderBar('FUEL', currentFuel, shipStatic.maxFuel, fuelPct, fuelColor)}
        </div>
    `;
}
// --- VIRTUAL WORKBENCH END ---
--- END OF FILE: ./js/ui/components/HangarScreen.js ---

--- START OF FILE: ./js/ui/components/IntelScreen.js ---
// js/ui/components/IntelScreen.js
/**
 * @fileoverview This file contains the rendering logic for the Intel screen.
 * It renders the static "shell" for the tabbed "Codex" (lore) and
 * "Intel Market" (data broker) views.
 */

/**
 * Renders the entire Intel screen UI, which includes the sub-nav tabs
 * and the content containers for "Codex" and "Intel Market".
 * @returns {string} The HTML content for the Intel screen.
 */
export function renderIntelScreen() {
    // --- VIRTUAL WORKBENCH (A) ---
    // Removed 'active' class from button and content.
    // UIManager will now apply 'active' based on gameState.uiState.activeIntelTab
    // --- END VIRTUAL WORKBENCH ---
    return `
        <div class="sub-nav-bar">
            <button class="sub-nav-button" data-action="set-intel-tab" data-target="intel-codex-content">Codex</button>
            <button class="sub-nav-button" data-action="set-intel-tab" data-target="intel-market-content">Intel Market</button>
        </div>

        <div class="intel-scroll-panel">
            <div id="intel-codex-content" class="intel-tab-content">
                <div id="lore-button-container" class="lore-container w-full max-w-md flex flex-col gap-4 p-4">
                    <button class="btn btn-header" data-action="show_lore" data-lore-id="story_so_far">
                        Story So Far...
                    </button>
                    </div>
            </div>

            <div id="intel-market-content" class="intel-tab-content p-4">
                </div>
        </div>
    `;
}
--- END OF FILE: ./js/ui/components/IntelScreen.js ---

--- START OF FILE: ./js/ui/components/NavigationScreen.js ---
// js/ui/components/NavigationScreen.js
/**
 * @fileoverview This file contains the rendering logic for the Navigation screen.
 * It displays the available travel destinations as interactive cards, showing the
 * fuel and time costs for each potential journey.
 */
import { DB } from '../../data/database.js';
import { ACTION_IDS, SCREEN_IDS } from '../../data/constants.js';

/**
 * Renders the entire Navigation screen UI.
 * @param {object} gameState - The current state of the game.
 * @returns {string} The HTML content for the Navigation screen.
 */
export function renderNavigationScreen(gameState) {
    const { player, currentLocationId, TRAVEL_DATA, tutorials } = gameState;
    const { navLock } = tutorials;
    const currentLocation = DB.MARKETS.find(loc => loc.id === currentLocationId);


    // Check if a tutorial is active and has locked navigation.
    const isNavLocked = navLock && navLock.screenId === SCREEN_IDS.NAVIGATION;
    const enabledElementQuery = isNavLocked ? navLock.enabledElementQuery : null;

    // Efficiently parse the enabled location ID from the query selector string.
    let enabledLocationId = null;
    if (enabledElementQuery) {
        const match = enabledElementQuery.match(/\[data-location-id='(.*?)'\]/);
        if (match && match[1]) {
            enabledLocationId = match[1];
        }
    }
    
    return `
        <div class="scroll-panel navigation-scroll-panel">
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
            ${DB.MARKETS
                .filter(loc => player.unlockedLocationIds.includes(loc.id))
                .map(location => {
                    const isCurrent = location.id === currentLocationId;
                    const travelInfo = isCurrent ? null : TRAVEL_DATA[currentLocationId][location.id];

                    // Determine if this card should be disabled due to a tutorial lock.
                    const isDisabled = isNavLocked && enabledLocationId && location.id !== enabledLocationId;
                    const disabledClass = isDisabled ? 'disabled-location' : '';
                    
                    const currentStyle = isCurrent ? `style="--theme-glow-color: ${currentLocation?.navTheme.borderColor};"` : '';


                    return `<div class="location-card p-6 rounded-lg text-center flex flex-col ${isCurrent ? 'highlight-current' : ''} ${location.color} ${location.bg} ${disabledClass}" 
                                 data-action="show-launch-modal" data-location-id="${location.id}" ${isDisabled ? 'disabled' : ''} ${currentStyle}>
                        <h3 class="text-2xl font-orbitron flex-grow">${location.name}</h3>
                        <div class="location-card-footer mt-auto pt-3 border-t border-cyan-100/10">
                        ${isCurrent 
                            ? '<p class="text-yellow-300 font-bold mt-2">(Currently Docked)</p>' 
                            : `<div class="flex justify-around items-center text-center">
                                   <div class="flex items-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V5z" clip-rule="evenodd" /></svg>
                                       <div><span class="font-bold font-roboto-mono text-lg">${travelInfo.time}</span><span class="block text-xs text-gray-400">Days</span></div>
                                   </div>
                                   <div class="flex items-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-sky-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                                       <div><span class="font-bold font-roboto-mono text-lg">${travelInfo.fuelCost}</span><span class="block text-xs text-gray-400">Fuel</span></div>
                                   </div>
                               </div>`
                        }
                      </div>
                      </div>`;
                }).join('')
            }
            </div>
        </div>`;
}
--- END OF FILE: ./js/ui/components/NavigationScreen.js ---

--- START OF FILE: ./js/ui/components/MissionsScreen.js ---
// js/ui/components/MissionsScreen.js
/**
 * @fileoverview This file contains the rendering logic for the Missions screen.
 * It is responsible for displaying the currently active mission and a list of all
 * available missions for the player.
 */
import { DB } from '../../data/database.js';
// --- VIRTUAL WORKBENCH: IMPORT formatCredits ---
import { formatCredits } from '../../utils.js';
// --- END VIRTUAL WORKBENCH ---

/**
 * Renders the entire Missions screen UI.
 * @param {object} gameState - The current state of the game.
 * @param {import('../../services/MissionService.js').MissionService} missionService - An instance of the MissionService to fetch available missions.
 * @returns {string} The HTML content for the Missions screen.
 */
export function renderMissionsScreen(gameState, missionService) {
    const { missions, currentLocationId } = gameState;
    const { activeMissionId, activeMissionObjectivesMet } = missions;

    /**
     * Generates the HTML for a single mission card.
     * @param {object} mission - The mission object from the database.
     * @param {string} status - The status of the mission ('active', 'completed', 'available').
     * @returns {string} The HTML for the mission card.
     */
    const getMissionCardHtml = (mission, status) => {
        let statusClass = '';
        if (status === 'active') statusClass = 'mission-active';
        if (status === 'completed') statusClass = 'mission-complete';
        // Special class for an active mission that is ready to be turned in at the current location.
        if (status === 'active' && activeMissionObjectivesMet && mission.completion.locationId === currentLocationId) {
            statusClass += ' mission-turn-in';
        }

        const hostClass = `host-${mission.host.toLowerCase().replace(/[^a-z0-9]/g, '')}`;
        
        // --- VIRTUAL WORKBENCH START: Phase 7 ---
        const rewardText = mission.rewards.map(r => {
            if(r.type === 'credits') return `<span class="credits-text-pulsing">${formatCredits(r.amount, true)}</span>`;
            return r.type.toUpperCase();
        }).join(', ');
        // --- VIRTUAL WORKBENCH END: Phase 7 ---

        return `
            <div class="mission-card sci-fi-frame ${hostClass} ${statusClass}" data-action="show-mission-modal" data-mission-id="${mission.id}">
                <div class="flex justify-between items-center w-full text-xs mb-1">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        <span class="mission-type">${mission.type}</span>
                    </div>
                    <span class="mission-host">${mission.host}</span>
                </div>
                <div class="flex justify-between items-end w-full">
                    <p class="font-bold text-base">${mission.name}</p>
                    <span class="mission-reward">${rewardText}</span>
                </div>
            </div>`;
    };

    let missionsHtml = '';
    const activeMission = activeMissionId ? DB.MISSIONS[activeMissionId] : null;
    if (activeMission) {
        missionsHtml += getMissionCardHtml(activeMission, 'active');
    }
    
    if (missionService) {
        const availableMissions = missionService.getAvailableMissions();
        availableMissions.forEach(mission => {
            missionsHtml += getMissionCardHtml(mission, 'available');
        });
    }

    if (missionsHtml === '') {
        missionsHtml = '<p class="text-center text-gray-500 text-lg">No missions available at this terminal.</p>';
    }

    return `
        <div class="flex flex-col h-full">
            <h1 class="text-3xl font-orbitron text-center mb-6 text-cyan-300 flex-shrink-0">Mission Terminal</h1>
            <div class="missions-scroll-panel flex-grow min-h-0">
                <div class="space-y-3 max-w-2xl mx-auto">
                    ${missionsHtml}
                </div>
            </div>
        </div>
    `;
}
--- END OF FILE: ./js/ui/components/MissionsScreen.js ---

--- START OF FILE: ./js/ui/components/FinanceScreen.js ---
// js/ui/components/FinanceScreen.js
/**
 * @fileoverview This file contains the rendering logic for the Finance screen.
 * It displays the player's current debt status or available loan options,
 * as well as a detailed log of all financial transactions.
 */
import { DB } from '../../data/database.js';
import { formatCredits } from '../../utils.js';
import { ACTION_IDS, GAME_RULES } from '../../data/constants.js';

// --- VIRTUAL WORKBENCH START: Phase 1 ---
// This function is now REMOVED as the global formatCredits handles all logic.
// --- VIRTUAL WORKBENCH END: Phase 1 ---

/**
 * Renders the entire Finance screen UI.
 * @param {object} gameState - The current state of the game.
 * @returns {string} The HTML content for the Finance screen.
 */
export function renderFinanceScreen(gameState) {
    const { player, day, currentLocationId } = gameState;
    const location = DB.MARKETS.find(l => l.id === currentLocationId);
    const theme = location?.navTheme || { gradient: 'linear-gradient(135deg, #4a5568, #2d3748)', textColor: '#f0f0f0', borderColor: '#7a9ac0' };
    
    // --- VIRTUAL WORKBENCH: Define theme vars for inline styling ---
    const themeStyleVars = `
        --theme-gradient: ${theme.gradient}; 
        --theme-text-color: ${theme.textColor}; 
        --theme-border-color: ${theme.borderColor};
    `;
    // --- END VIRTUAL WORKBENCH ---

    let loanHtml;

    // Display the current debt panel if the player has debt.
    if (player.debt > 0) {
        let garnishmentTimerHtml = '';
        if (player.loanStartDate) {
            const daysRemaining = GAME_RULES.LOAN_GARNISHMENT_DAYS - (day - player.loanStartDate);
            if (daysRemaining > 0) {
                // VIRTUAL WORKBENCH: Increased font size from text-xs to text-sm
                garnishmentTimerHtml = `<p class="text-sm text-red-400/70 mt-2">Garnishment in ${daysRemaining} days</p>`;
            }
        }
        // --- VIRTUAL WORKBENCH START: Phase 2 ---
        loanHtml = `
            <div>
                <div class="themed-header-bar" style="${themeStyleVars}">
                    <div class="themed-header-title">Debt</div>
                </div>
                <div class="finance-module-panel flex flex-col items-center justify-center space-y-2 text-center" style="border-color: ${theme.borderColor};">
                    <button data-action="${ACTION_IDS.PAY_DEBT}" class="btn-module btn-module-destructive w-full font-roboto-mono" ${player.credits >= player.debt ? '' : 'disabled'}>
                        <span class="text-base">Pay Off <span class="text-glow-red">${formatCredits(-player.debt, true)}</span></span>
                    </button>
                    ${garnishmentTimerHtml}
                </div>
            </div>`;
        // --- VIRTUAL WORKBENCH END: Phase 2 ---
    } else {
        // Otherwise, display available loan options.
        const dynamicLoanAmount = Math.floor(player.credits * 3.5);
        const dynamicLoanFee = Math.floor(dynamicLoanAmount * 0.1);
        const dynamicLoanInterest = Math.floor(dynamicLoanAmount * 0.04);
        const dynamicLoanData = { amount: dynamicLoanAmount, fee: dynamicLoanFee, interest: dynamicLoanInterest };
        
        // --- VIRTUAL WORKBENCH START: Phase 1 & 2 ---
        const loanButtonsHtml = [
            { key: '10000', amount: 10000, fee: 600, interest: 500 },
            { key: 'dynamic', ...dynamicLoanData }
        ].map((loan) => {
            return `<button class="btn-module btn-module-credit w-full mt-2" data-action="${ACTION_IDS.TAKE_LOAN}" data-loan-details='${JSON.stringify(loan)}' ${player.credits < loan.fee ? 'disabled' : ''}>
                        <span class="credits-text-pulsing">${formatCredits(loan.amount, true)}</span>
                    </button>`;
        }).join('');
        // --- VIRTUAL WORKBENCH END: Phase 1 & 2 ---

        loanHtml = `
            <div>
                <div class="themed-header-bar" style="${themeStyleVars}">
                    <div class="themed-header-title">Financing</div>
                </div>
                <div class="finance-module-panel flex flex-col items-center justify-center space-y-2 text-center" style="border-color: ${theme.borderColor};">
                    <div class="flex justify-center gap-4 w-full">${loanButtonsHtml}</div>
                </div>
            </div>`;
    }
    // --- END VIRTUAL WORKBENCH ---

    // Render the transaction log.
    const logEntries = [...player.financeLog].reverse().map(entry => {
        const amountColor = entry.amount > 0 ? 'credits-text-pulsing' : 'text-glow-red';
        const sign = entry.amount > 0 ? '+' : '';
        return `
            <div class="log-entry">
                <span class="text-gray-400 text-center">${entry.day}</span>
                <span>${entry.description}</span>
                <span class="${amountColor} text-right font-roboto-mono">${sign}${formatCredits(entry.amount, false)}</span>
            </div>
        `;
       }).join('');

    return `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 h-full">
            <div class="md:col-span-1">
                ${loanHtml}
            </div>
            <div class="md:col-span-2 flex flex-col min-h-0">
                 <div class="themed-header-bar" style="${themeStyleVars}">
                    <div class="themed-header-title">Transaction Log</div>
                 </div>
                 <div class="finance-module-panel flex flex-col flex-grow min-h-0" style="border-color: ${theme.borderColor}; --theme-text-color: ${theme.textColor};">
                    <div class="finance-log-panel">
                        <div class="log-header" style="border-color: ${theme.borderColor};">
                           <span class="text-center">Day</span>
                           <span>Description</span>
                           <span class="text-right">Amount</span>
                        </div>
                        <div class="log-entries-container">
                           ${logEntries || '<p class="text-center p-4">No transactions recorded.</p>'}
                        </div>
                    </div>
                 </div>
            </div>
        </div>
    `;
}
--- END OF FILE: ./js/ui/components/FinanceScreen.js ---

--- START OF FILE: ./js/ui/components/ServicesScreen.js ---
// js/ui/components/ServicesScreen.js
/**
 * @fileoverview This file contains the rendering logic for the Station Services screen.
 * It displays options for refueling and repairing the player's active ship, calculating
 * costs based on the current location and any active player perks.
 */
import { DB } from '../../data/database.js';
import { formatCredits } from '../../utils.js';
import { GAME_RULES, PERK_IDS, LOCATION_IDS } from '../../data/constants.js';

/**
 * Renders the entire Services screen UI.
 * @param {object} gameState - The current state of the game.
 * @returns {string} The HTML content for the Services screen.
 */
export function renderServicesScreen(gameState) {
    const { player, currentLocationId } = gameState;

    // VIRTUAL WORKBENCH: Added Starport Name map (Request B)
    const STARPORT_NAMES = {
        [LOCATION_IDS.VENUS]: "Venetian Cloudport",
        [LOCATION_IDS.EARTH]: "Earth Starport",
        [LOCATION_IDS.LUNA]: "Lunar Starport",
        [LOCATION_IDS.MARS]: "Martian Starport",
        [LOCATION_IDS.BELT]: "Belt Station",
        [LOCATION_IDS.EXCHANGE]: "The Exchange",
        [LOCATION_IDS.JUPITER]: "Jupiter Starport",
        [LOCATION_IDS.SATURN]: "Saturn Starport",
        [LOCATION_IDS.URANUS]: "Uranus Starport",
        [LOCATION_IDS.NEPTUNE]: "Neptune Starport",
        [LOCATION_IDS.KEPLER]: "Kepler's Eye",
        [LOCATION_IDS.PLUTO]: "The Fringe",
    };

    const location = DB.MARKETS.find(l => l.id === currentLocationId);
    const theme = location?.navTheme || { gradient: 'linear-gradient(135deg, #4a5568, #2d3748)', textColor: '#f0f0f0', borderColor: '#7a9ac0' };
    const themeStyleVars = `
        --theme-gradient: ${theme.gradient}; 
        --theme-text-color: ${theme.textColor}; 
        --theme-border-color: ${theme.borderColor};
    `;
    // VIRTUAL WORKBENCH: Use new name map
    const locationName = STARPORT_NAMES[currentLocationId] || 'UNKNOWN STARPORT';

    // --- Crash Fix: Check if activeShipId exists and its state data is available ---
    if (!player.activeShipId || !gameState.player.shipStates[player.activeShipId]) {
        // VIRTUAL WORKBENCH: Updated header fallback
        return `
            <div class="flex flex-col h-full">
                <div class="themed-header-bar mb-4" style="${themeStyleVars}">
                    <div class="themed-header-title">${locationName}</div>
                </div>
                <div class="services-scroll-panel flex-grow min-h-0">
                    <div class="ship-services-panel max-w-4xl mx-auto" style="${themeStyleVars}">
                        <div class="themed-header-bar">
                            <div class="ship-header-title">NO ACTIVE SHIP</div>
                        </div>
                        <div class="p-4 md:p-8">
                            <p class="text-center text-gray-500 text-lg">No active ship available for servicing.</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        // --- END VIRTUAL WORKBENCH ---
    }
    // --- End Crash Fix ---

    const shipStatic = DB.SHIPS[player.activeShipId];
    const shipState = gameState.player.shipStates[player.activeShipId]; // Now safe to access
    const shipName = shipStatic?.name || 'NO ACTIVE SHIP'; // VIRTUAL WORKBENCH: Get ship name

    // --- Calculate Refuel Cost (logic mirrored from PlayerActionService.refuelTick) ---
    let fuelCostPerTick = DB.MARKETS.find(m => m.id === currentLocationId).fuelPrice / 2;
    if (player.activePerks[PERK_IDS.VENETIAN_SYNDICATE] && currentLocationId === LOCATION_IDS.VENUS) {
        fuelCostPerTick *= (1 - DB.PERKS[PERK_IDS.VENETIAN_SYNDICATE].fuelDiscount);
    }
    fuelCostPerTick = Math.round(fuelCostPerTick);

    // --- Calculate Repair Cost (logic mirrored from PlayerActionService.repairTick) ---
    let repairCostPerTick = (shipStatic.maxHealth * (GAME_RULES.REPAIR_AMOUNT_PER_TICK / 100)) * GAME_RULES.REPAIR_COST_PER_HP;
    if (player.activePerks[PERK_IDS.VENETIAN_SYNDICATE] && currentLocationId === LOCATION_IDS.VENUS) {
        repairCostPerTick *= (1 - DB.PERKS[PERK_IDS.VENETIAN_SYNDICATE].repairDiscount);
    }
    repairCostPerTick = Math.round(repairCostPerTick);

    // --- Calculate Percentages ---
    const fuelPct = (shipState.fuel / shipStatic.maxFuel) * 100;
    const healthPct = (shipState.health / shipStatic.maxHealth) * 100;

    // --- Determine UI States ---
    const isFuelFull = shipState.fuel >= shipStatic.maxFuel;
    const isHealthFull = shipState.health >= shipStatic.maxHealth;

    const canAffordRefuel = player.credits >= fuelCostPerTick;
    const canAffordRepair = player.credits >= repairCostPerTick;

    const isDisabledRefuel = isFuelFull || !canAffordRefuel;
    const isDisabledRepair = isHealthFull || !canAffordRepair;
    
    // VIRTUAL WORKBENCH: Wrapped in flex container, updated header, added new ship header
    return `
        <div class="flex flex-col h-full">
            <div class="themed-header-bar mb-4" style="${themeStyleVars}">
                <div class="themed-header-title">${locationName}</div>
            </div>
            <div class="services-scroll-panel flex-grow min-h-0">
                
                <div class="ship-services-panel max-w-4xl mx-auto" style="${themeStyleVars}">
                    <div class="themed-header-bar">
                        <div class="ship-header-title">${shipName}</div>
                    </div>

                    <div class="flex flex-col md:flex-row justify-center items-center gap-8 p-4 md:p-8">
                      <div
                        class="service-module w-full max-w-sm"
                        style="--resource-color-rgb: 8, 217, 214; --resource-color: #08d9d6; --ot-cyan-base: #08d9d6;"
                      >
                        <div class="bar-housing">
                          <div class="progress-bar-container w-full h-20 rounded-lg border border-gray-800 overflow-hidden relative">
                            <div class="absolute inset-0 z-10 flex justify-between items-center p-1.5 px-4 text-sm pointer-events-none">
                              <span class="font-electrolize font-bold tracking-wider uppercase text-cyan-300 text-outline" style="--glow-color: #08d9d6;">Fuel</span>
                              <span class="font-mono font-bold text-white text-outline" style="--glow-color: #08d9d6;">
                                ${Math.round(shipState.fuel)} / ${shipStatic.maxFuel}
                              </span>
                            </div>
                            <div id="fuel-bar" class="progress-bar-fill h-full rounded-md" style="width: ${fuelPct}%; background-color: #08d9d6; --glow-color: #08d9d6; background-image: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.1) 75%, transparent 75%, transparent); background-size: 40px 40px;"></div>
                          </div>
                        </div>
                        <div class="control-deck flex justify-center items-center gap-4">
                          <div class="price-display-module w-32 h-12 flex justify-between items-center px-4">
                            <span class="price-label text-sm engraved-text">COST</span>
                            <span class="price-digits text-base ${canAffordRefuel ? 'credits-text-pulsing' : 'text-red-500 shadow-red-500'}">
                              ${formatCredits(fuelCostPerTick, true)}
                            </span>
                          </div>
                          <button id="refuel-btn" class="industrial-button w-32 h-12 flex justify-center items-center text-center p-2 text-base font-orbitron uppercase tracking-wider transition-all duration-100 ease-in-out focus:outline-none" ${isDisabledRefuel ? 'disabled' : ''}>
                            <span class="engraved-text">${isFuelFull ? 'MAX' : 'REFUEL'}</span>
                          </button>
                          </div>
                      </div>

                      <div
                        class="service-module w-full max-w-sm"
                        style="--resource-color-rgb: 22, 163, 74; --resource-color: #16a34a; --ot-green-accent: #16a34a; --ot-green-text-light: #22c55e;"
                      >
                        <div class="bar-housing">
                          <div class="progress-bar-container w-full h-20 rounded-lg border border-gray-800 overflow-hidden relative">
                            <div class="absolute inset-0 z-10 flex justify-between items-center p-1.5 px-4 text-sm pointer-events-none">
                               <span class="font-electrolize font-bold tracking-wider uppercase text-outline" style="color: var(--ot-green-text-light); --glow-color: var(--ot-green-text-light);">HULL INTEGRITY</span>
                              <span class="font-mono font-bold text-white text-outline" style="--glow-color: var(--resource-color);">
                                ${Math.round(shipState.health)} / ${shipStatic.maxHealth}
                              </span>
                            </div>
                            <div id="repair-bar" class="progress-bar-fill h-full rounded-md" style="width: ${healthPct}%; background-color: var(--resource-color); --glow-color: var(--resource-color); background-image: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.1) 75%, transparent 75%, transparent); background-size: 40px 40px;"></div>
                          </div>
                          </div>
                        <div class="control-deck flex justify-center items-center gap-4">
                          <div class="price-display-module w-32 h-12 flex justify-between items-center px-4">
                            <span class.price-label text-sm engraved-text">COST</span>
                            <span class="price-digits text-base ${canAffordRepair ? 'credits-text-pulsing' : 'text-red-500 shadow-red-500'}">
                              ${formatCredits(repairCostPerTick, true)}
                            </span>
                          </div>
                          <button id="repair-btn" class="industrial-button w-32 h-12 flex justify-center items-center text-center p-2 text-base font-orbitron uppercase tracking-wider transition-all duration-100 ease-in-out focus:outline-none" ${isDisabledRepair ? 'disabled' : ''}>
                              <span class="engraved-text">${isHealthFull ? 'MAX' : 'REPAIR'}</span>
                          </button>
                          </div>
                      </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}
--- END OF FILE: ./js/ui/components/ServicesScreen.js ---

--- START OF FILE: ./js/ui/components/CargoScreen.js ---
// js/ui/components/CargoScreen.js
/**
 * @fileoverview This file contains the rendering logic for the Cargo screen.
 * It is responsible for displaying the contents of the player's active ship's cargo hold.
 * The new design features a grid of small cargo items ('min-cargo') that expand into
 * a detailed modal view ('max-cargo').
 */
import { DB } from '../../data/database.js';
import { formatCredits, getCommodityStyle } from '../../utils.js';
import { ACTION_IDS } from '../../data/constants.js';

/**
 * Renders the entire Cargo screen UI, displaying a grid of items.
 * @param {object} gameState - The current state of the game.
 * @returns {string} The HTML content for the Cargo screen.
 */
export function renderCargoScreen(gameState) {
    const inventory = gameState.player.inventories[gameState.player.activeShipId];
    if (!inventory) return '<p class="text-center text-gray-500 text-lg">No active ship.</p>';

    const ownedGoods = Object.entries(inventory).filter(([, item]) => item.quantity > 0);

    if (ownedGoods.length === 0) {
        return '<p class="text-center text-gray-500 text-lg">Your cargo hold is empty.</p>';
    }

    const cargoItemsHtml = ownedGoods.map(([goodId, item]) => {
        const good = DB.COMMODITIES.find(c => c.id === goodId);
        return _renderMinCargoItem(good, item);
    }).join('');

    return `<div class="cargo-scroll-panel"><div class="cargo-grid">${cargoItemsHtml}</div></div>`;
}

/**
 * Renders a single small, clickable cargo item for the grid view.
 * @param {object} good - The static data for the commodity from the database.
 * @param {object} item - The player's inventory data for the item (quantity, avgCost).
 * @returns {string} The HTML for a single min-cargo item.
 * @private
 */
function _renderMinCargoItem(good, item) {
    const styles = getCommodityStyle(good.styleClass);

    return `
        <div class="min-cargo-item" 
             style="background: ${styles.gradient}; border: 2px solid ${styles.hex};"
             data-action="show_cargo_detail" 
             data-good-id="${good.id}">
            
            <div class="pt-symbol" style="font-size: 2rem; color: ${styles.hex}; text-shadow: 0 0 5px rgba(0,0,0,0.7);">${good.symbol.toUpperCase()}</div>
            <div class="pt-quantity text-gray-400" style="text-shadow: 1px 1px 3px #000;">(${item.quantity})</div>
        </div>
    `;
}

/**
 * Renders the detailed modal view for a selected cargo item.
 * @param {object} good - The static data for the commodity.
 * @param {object} item - The player's inventory data for the item.
 * @returns {string} The HTML for the max-cargo modal content.
 */
export function _renderMaxCargoModal(good, item) {
    const styles = getCommodityStyle(good.styleClass);

    const categoryMap = {
        RAW: 'Raw Material',
        IND: 'Industrial Product',
        AGRI: 'Agricultural Good',
        TECH: 'Technology',
        CIV: 'Civilian Commodity',
        BIO: 'Bioware',
        RARE: 'Exotic Material'
    };
    const fullCategory = categoryMap[good.cat] || 'Unknown';

    const galacticAvg = (good.basePriceRange[0] + good.basePriceRange[1]) / 2;
    const avgValue = galacticAvg * item.quantity;

    return `
        <div class="max-cargo-card" style="background: ${styles.gradient}; border-color: ${styles.hex};">
            <h3 class="text-2xl font-orbitron text-center">${good.name}</h3>
            <p class="text-sm text-center tier-type-line mb-4" style="color: ${styles.hex};">Tier ${good.tier} ${fullCategory}</p>
            <p class="flavor-text">${good.lore}</p>
            <div class="avg-cost">
                <div>Avg. Cost: <span class="font-bold credits-text-pulsing">${formatCredits(item.avgCost, true)}</span></div>
                <div>Qty Aboard: <span class="font-bold">${item.quantity}</span></div>
                <div>Avg. Value: <span class="font-bold credits-text-pulsing">${formatCredits(avgValue, true)}</span></div>
            </div>
        </div>
    `;
}
--- END OF FILE: ./js/ui/components/CargoScreen.js ---

--- START OF FILE: ./js/ui/components/MarketScreen.js ---
// js/ui/components/MarketScreen.js
/**
 * @fileoverview
 * This file contains the rendering logic for the Market screen.
 * It is responsible for displaying all available commodities for trade.
 */
import { DB } from '../../data/database.js';
import { formatCredits, renderIndicatorPills } from '../../utils.js';
import { ACTION_IDS, COMMODITY_IDS } from '../../data/constants.js';

/**
 * Renders the entire Market screen, adapting for mobile or desktop layouts.
 * @param {object} gameState - The current state of the game.
 * @param {boolean} isMobile - A flag indicating if the mobile layout should be used.
 * @param {function} getItemPrice - A reference to the UIManager's getItemPrice function.
 * @param {object} marketTransactionState - The saved state of the transaction modules.
 * @returns {string} The HTML content for the Market screen.
 */
export function renderMarketScreen(gameState, isMobile, getItemPrice, marketTransactionState) {
    const availableCommodities = DB.COMMODITIES.filter(c => c.tier <= gameState.player.revealedTier);
    const marketHtml = availableCommodities.map(good => {
        return _getMarketItemHtml(good, gameState, getItemPrice, marketTransactionState);
    }).join('');

    // MODIFIED: Changed 'scroll-panel' to 'market-scroll-panel' to match CSS file
    return `<div class="market-scroll-panel">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">${marketHtml}</div>
            </div>`;
}

/**
 * Generates the HTML for a single commodity card on the market screen.
 * @param {object} good - The commodity data from the database.
 * @param {object} gameState - The current game state.
 * @param {function} getItemPrice - A function to calculate the item's current price.
 * @param {object} marketTransactionState - The saved state of the transaction modules.
 * @returns {string} The HTML string for the commodity card.
 * @private
 */
function _getMarketItemHtml(good, gameState, getItemPrice, marketTransactionState) {
    const { player, market, currentLocationId, tutorials, uiState } = gameState;
    const playerItem = player.inventories[player.activeShipId]?.[good.id];
    const price = getItemPrice(gameState, good.id);
    const sellPrice = getItemPrice(gameState, good.id, true);
    const galacticAvg = market.galacticAverages[good.id];
    const marketStock = market.inventory[currentLocationId]?.[good.id];

    const hasLicense = !good.licenseId || player.unlockedLicenseIds.includes(good.licenseId);

    const isPlasteelTutStep = tutorials.activeBatchId === 'intro_missions' && tutorials.activeStepId === 'mission_2_2';
    const isMarketLockedForMission = tutorials.activeBatchId === 'intro_missions' && tutorials.activeStepId === 'mission_2_3';
    const isLockedForTutorial = (isPlasteelTutStep && good.id !== COMMODITY_IDS.PLASTEEL) || isMarketLockedForMission;

    const nameTooltip = `data-tooltip="${good.lore}"`;
    const playerInvDisplay = playerItem && playerItem.quantity > 0 ? playerItem.quantity : '0';
    const isMinimized = uiState.marketCardMinimized[good.id];

    let cardContentHtml;
    let buttonHtml = ''; 

    if (hasLicense) {
        // --- This is the STANDARD (unlocked) card content ---
        const indicatorHtml = renderIndicatorPills({ price, sellPrice, galacticAvg, playerItem });
        const avgCostHtml = playerItem && playerItem.quantity > 0 ? `<div class="avg-cost-display" id="avg-cost-${good.id}">Avg. Cost: ${formatCredits(playerItem.avgCost, false)}</div>` : '';
        const initialMode = marketTransactionState[good.id]?.mode || 'buy';

        const transactionControlsHtml = `
             <div class="transaction-controls" data-mode="${initialMode}" data-good-id="${good.id}" ${isLockedForTutorial ? 'disabled' : ''}>
                <div class="toggle-switch" data-action="toggle-trade-mode" data-good-id="${good.id}">
                    <div class="toggle-thumb"></div>
                    <div class="toggle-labels"><span class="label-buy">Buy</span><span class="label-sell">Sell</span></div>
                </div>
                <div class="qty-stepper">
                    <button class="qty-down" data-action="decrement" data-good-id="${good.id}">▼</button>
                    <input type="number" value="0" id="qty-${good.id}" min="0">
                    <button class="qty-up" data-action="increment" data-good-id="${good.id}">▲</button>
                </div>
                <div class="action-group">
                    <button class="btn confirm-btn" data-action="confirm-trade" data-good-id="${good.id}">Confirm</button>
                    <button class="btn max-btn" data-action="set-max-trade" data-good-id="${good.id}">Max</button>
                </div>
            </div>`;

        const ownedQtyText = playerItem?.quantity > 0 ? ` (${playerItem.quantity})` : '';

        buttonHtml = `<button class="card-toggle-btn" data-action="${ACTION_IDS.TOGGLE_MARKET_CARD_VIEW}" data-good-id="${good.id}">${isMinimized ? '+' : '−'}</button>`;
        
        // --- VIRTUAL WORKBENCH START: Phase 4 (Revert) ---
        cardContentHtml = `
            <div class="max-view-content">
                <p class="font-bold commodity-name"><span class="commodity-name-tooltip" ${nameTooltip}>${good.name}</span></p>
                <p class="avail-text">Avail: <span id="m-stock-${good.id}">${marketStock.quantity}</span>, Own: <span id="p-inv-${good.id}">${playerInvDisplay}</span></p>
                
                <p id="price-display-${good.id}" class="font-roboto-mono font-bold price-text" data-action="${ACTION_IDS.SHOW_PRICE_GRAPH}" data-good-id="${good.id}" data-base-price="${price}">${formatCredits(price)}</p>
                
                <div id="effective-price-display-${good.id}" class="effective-price-display"></div>
                
                <div class="indicator-container" id="indicators-${good.id}">${indicatorHtml}</div>

                ${avgCostHtml}

                ${transactionControlsHtml}
            </div>

            <div class="min-view-content">
                <p class="font-bold commodity-name-min">${good.name}${ownedQtyText}</p>
                <p class="tier-text-min">Tier ${good.tier} | ${good.cat}</p>
            </div>
        `;
        // --- VIRTUAL WORKBENCH END: Phase 4 (Revert) ---

    } else {
        // --- [[START]] MODIFIED (locked) card content ---
        
        // Change c: Set text to 'TIER X LICENSE'
        const lockedText = `TIER ${good.tier} LICENSE`;

        // Add the data-action and data-license-id to the container to make it clickable
        cardContentHtml = `
            <div class="license-locked-content" data-action="${ACTION_IDS.ACQUIRE_LICENSE}" data-license-id="${good.licenseId}">
                <div class="license-locked-tier-watermark">TIER ${good.tier}</div>
                
                <div class="sci-fi-lock-badge">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
                    </svg>
                </div>
                 <p class="license-required-text">${lockedText}</p>
            </div>
        `;
        // --- [[END]] MODIFIED (locked) card content ---
    }

    return `
    <div class="item-card-container ${isMinimized ? 'minimized' : ''}" id="item-card-container-${good.id}">
        ${buttonHtml}
        <div class="rounded-lg border ${good.styleClass} transition-colors shadow-md">
            ${cardContentHtml}
        </div>
    </div>`;
}
--- END OF FILE: ./js/ui/components/MarketScreen.js ---

--- START OF FILE: ./js/main.js ---
// js/main.js
import { GameState } from './services/GameState.js';
import { SimulationService } from './services/SimulationService.js';
import { UIManager } from './services/UIManager.js';
import { EventManager } from './services/EventManager.js';
import { TutorialService } from './services/TutorialService.js';
import { MissionService } from './services/MissionService.js';
import { DebugService } from './services/DebugService.js';
import { Logger } from './services/LoggingService.js';
import { NewsTickerService } from './services/NewsTickerService.js'; // IMPORT

// Import the new service shells
import { IntroService } from './services/game/IntroService.js';
import { PlayerActionService } from './services/player/PlayerActionService.js';
import { TimeService } from './services/world/TimeService.js';
import { TravelService } from './services/world/TravelService.js';

/**
 * This function now manages both app height and "letterbox" scaling.
 * It sets the --app-height variable for the body and dynamically scales
 * the game-container down if the visual viewport is too short.
 */
const setAppHeight = () => {
    const gameContainer = document.getElementById('game-container');
    if (!gameContainer) return;

    // This is the *true* available height, including notch/browser UI.
    const visualHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
    
    // Set the body height to the *full* inner height (PWA/standalone height)
    // or the visual viewport height (browser). 100dvh in CSS handles this mostly,
    // but this JS variable is a robust override.
    document.documentElement.style.setProperty('--app-height', `${visualHeight}px`);

    // --- SCALING LOGIC ---
    // We define the DESIGN TARGET height (iPhone Pro Max).
    // If the screen is shorter, we scale the container down.
    const DESIGN_TARGET_HEIGHT = 926; // iPhone 14/13 Pro Max logical height

    if (visualHeight < DESIGN_TARGET_HEIGHT) {
        // The screen is too short, we must scale down.
        const scaleFactor = visualHeight / DESIGN_TARGET_HEIGHT; // e.g., 667px / 926px = 0.72
        
        // Set height to the *design* height, then scale it
        gameContainer.style.height = `${DESIGN_TARGET_HEIGHT}px`;
        gameContainer.style.transform = `scale(${scaleFactor})`;
        gameContainer.style.transformOrigin = 'top center';
        
        // Align the scaled container to the top of the flex-box body
        document.body.style.alignItems = 'flex-start'; // <-- MODIFIED
    } else {
        // The screen is tall enough, no scaling needed.
        gameContainer.style.transform = 'none';
        gameContainer.style.height = '100dvh'; // Use dynamic height
        
        // Re-center the container vertically (for desktop/tall devices)
        document.body.style.alignItems = 'center'; // <-- MODIFIED
    }
};


document.addEventListener('DOMContentLoaded', () => {
    // --- App Initialization ---
    const splashScreen = document.getElementById('splash-screen');
    const startButton = document.getElementById('start-game-btn');
    const debugStartButton = document.getElementById('debug-start-btn');
    const DEV_MODE = true; // Guard for development features.

    // [[START]] VIRTUAL WORKBENCH (EULA Logic)
    
    // 1. Instantiate UI Manager and Logger early
    // These are needed to show the EULA modal *before* the game starts.
    const uiManager = new UIManager(Logger);

    const eulaCheckbox = document.getElementById('eula-checkbox');
    const eulaContainer = document.getElementById('eula-container');

    // 2. Add standalone listener for EULA link on splash screen
    if (splashScreen) {
        splashScreen.addEventListener('click', (e) => {
            const actionTarget = e.target.closest('[data-action]');
            if (actionTarget) {
                const action = actionTarget.dataset.action;
                if (action === 'show_eula_modal') {
                    e.preventDefault();
                    uiManager.showEulaModal();
                }
            }
        });
    }

    // 3. Add cleanup listener for the pulse animation
    if (eulaContainer) {
        eulaContainer.addEventListener('animationend', () => {
            eulaContainer.classList.remove('pulse-eula-warning');
        });
    }

    // 4. Create check function that wraps the start logic
    const checkEulaAndStart = (startFn) => {
        if (!eulaCheckbox || !eulaContainer) {
            console.error("EULA elements not found!");
            return;
        }

        if (!eulaCheckbox.checked) {
            // Trigger pulse animation
            eulaContainer.classList.remove('pulse-eula-warning');
            // Timeout ensures the class removal is processed, allowing the animation to re-trigger
            setTimeout(() => {
                eulaContainer.classList.add('pulse-eula-warning');
            }, 10);
            
            return; // Stop the function
        }

        // EULA is checked, proceed with game start
        splashScreen.classList.add('splash-screen-hiding');
        splashScreen.addEventListener('animationend', () => {
            splashScreen.style.display = 'none';
            startFn();
        }, { once: true });
    };
    // [[END]] VIRTUAL WORKBENCH (EULA Logic)

    // Set the app height on initial load and whenever the viewport changes.
    setAppHeight(); // MODIFIED: Re-enabled
    
    // The visualViewport API is a more reliable way to track viewport changes on mobile.
    // MODIFIED: Re-enabled
    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', setAppHeight);
        window.visualViewport.addEventListener('scroll', setAppHeight);
    } else {
        window.addEventListener('resize', setAppHeight);
    }



    // Set up the main start button to initialize and begin the game.
    startButton.addEventListener('click', () => {
        // [[START]] VIRTUAL WORKBENCH (EULA Logic)
        // 5. Pass the original startGame function as a callback, along with pre-built uiManager
        checkEulaAndStart(() => startGame(false, uiManager, Logger));
        // [[END]] VIRTUAL WORKBENCH (EULA Logic)
    }, { once: false }); // Set once to false to allow re-checking
    
    debugStartButton.addEventListener('click', () => {
        // [[START]] VIRTUAL WORKBENCH (EULA Logic)
        // 5. Pass the debug start function as a callback, along with pre-built uiManager
        checkEulaAndStart(() => startGame(true, uiManager, Logger));
        // [[END]] VIRTUAL WORKBENCH (EULA Logic)
    }, { once: false }); // Set once to false to allow re-checking

    /**
     * Instantiates all core game services, establishes their dependencies,
     * loads saved data or starts a new game, and binds all necessary event listeners.
     * @param {boolean} isSimpleStart
     * @param {UIManager} uiManager - The pre-instantiated UIManager.
     * @param {Logger} logger - The Logger instance.
     */
    function startGame(isSimpleStart = false, uiManager, logger) {
        // --- Service Instantiation ---
        const gameState = new GameState();
        // uiManager and logger are now passed in, no need to instantiate.
        const newsTickerService = new NewsTickerService(gameState); // INSTANTIATE
        const missionService = new MissionService(gameState, uiManager, logger);
        // MODIFIED: Pass newsTickerService to SimulationService
        const simulationService = new SimulationService(gameState, uiManager, logger, newsTickerService);
        const tutorialService = new TutorialService(gameState, uiManager, simulationService, uiManager.navStructure, logger);
        let debugService = null;

        if (DEV_MODE) {
            debugService = new DebugService(gameState, simulationService, uiManager, logger);
            debugService.init();
            // --- [[START]] TUTORIAL TUNER WIRING ---
            uiManager.setDebugService(debugService);
            // --- [[END]] TUTORIAL TUNER WIRING ---
        }
        
        // --- Dependency Injection ---
        uiManager.setNewsTickerService(newsTickerService); // INJECT
        uiManager.setMissionService(missionService);
        uiManager.setSimulationService(simulationService);
        simulationService.setTutorialService(tutorialService);
        simulationService.setMissionService(missionService);
        // REMOVED: TimeService injection (now handled by SimService)
        missionService.setSimulationService(simulationService);
        const eventManager = new EventManager(gameState, simulationService, uiManager, tutorialService, debugService, logger);
        // MODIFIED: Inject EventManager into UIManager for post-render bindings
        uiManager.setEventManager(eventManager);
        
        // --- Link GameState to UIManager for automatic re-rendering ---
        gameState.subscribe(() => uiManager.render(gameState.getState()));

        // --- Game Initialization ---
        const hasSave = gameState.loadGame();
        if (!hasSave) {
            if (isSimpleStart && debugService) {
                gameState.startNewGame('');
                debugService.simpleStart();
            } else {
                gameState.startNewGame('');
                simulationService.timeService.advanceDays(7);
                simulationService.startIntroSequence();
            }
        }

        // --- Bindings ---
        eventManager.bindEvents();
        
        if (hasSave || isSimpleStart) {
            uiManager.showGameContainer(); 
            
            // --- [[START]] MODIFICATION ---
            // Populate the news ticker *before* the first render.
            // This prevents the "first tap" re-render bug.
            newsTickerService.onLocationChange();
            // --- [[END]] MODIFICATION ---

            uiManager.render(gameState.getState());
        }
        
        // --- [[START]] MODIFICATION ---
        // MOVED: The call to onLocationChange() was moved up to before the first render.
        // --- [[END]] MODIFICATION ---
        
        tutorialService.checkState({ type: 'SCREEN_LOAD', screenId: gameState.activeScreen });
    }
});
--- END OF FILE: ./js/main.js ---

--- START OF FILE: ./js/utils.js ---
// js/utils.js
/**
 * @fileoverview This file contains globally accessible utility functions for various tasks
 * such as formatting numbers, calculating inventory usage, and handling date conversions.
 * These helpers are used throughout the application to standardize common operations.
 */
import { DATE_CONFIG } from './data/database.js';

/**
 * A centralized map for commodity visual styles.
 * @type {Object.<string, {hex: string, gradient: string}>}
 */
const commodityStyleMap = {
    'item-style-1':  { hex: '#60a5fa', gradient: 'linear-gradient(45deg, #3b82f6, #1e3a8a)' },
    'item-style-2':  { hex: '#a3a3a3', gradient: 'linear-gradient(45deg, #737373, #262626)' },
    'item-style-3':  { hex: '#22c55e', gradient: 'linear-gradient(45deg, #16a34a, #14532d)' },
    'item-style-4':  { hex: '#e5e5e5', gradient: 'linear-gradient(45deg, #d4d4d4, #737373)' },
    'item-style-5':  { hex: '#c084fc', gradient: 'linear-gradient(45deg, #a855f7, #6b21a8)' },
    'item-style-6':  { hex: '#93c5fd', gradient: 'linear-gradient(45deg, #60a5fa, #2563eb)' },
    'item-style-7':  { hex: '#84cc16', gradient: 'linear-gradient(45deg, #a3e635, #4d7c0f)' },
    'item-style-8':  { hex: '#67e8f9', gradient: 'linear-gradient(45deg, #22d3ee, #0891b2)' },
    'item-style-9':  { hex: '#fcd34d', gradient: 'linear-gradient(45deg, #facc15, #b45309)' },
    'item-style-10': { hex: '#fb7185', gradient: 'linear-gradient(45deg, #f43f5e, #9f1239)' },
    'item-style-11': { hex: '#a78bfa', gradient: 'linear-gradient(165deg, #a78bfa, #312e81, #1e3a8a)' },
    'item-style-12': { hex: '#f87171', gradient: 'linear-gradient(45deg, #ef4444, #7f1d1d)' },
    'item-style-13': { hex: '#d8b4fe', gradient: 'linear-gradient(45deg, #a855f7, #3b0764)' },
    'item-style-14': { hex: '#f472b6', gradient: 'linear-gradient(45deg, #ec4899, #831843)' },
};

/**
 * Retrieves the style object for a given commodity style class.
 * @param {string} styleClass - The style class of the commodity.
 * @returns {{hex: string, gradient: string}} The style object.
 */
export function getCommodityStyle(styleClass) {
    return commodityStyleMap[styleClass] || { hex: '#a8a29e', gradient: 'linear-gradient(45deg, #52525b, #18181b)' };
}

/**
 * Formats a number into a compact, human-readable credit string with appropriate suffixes (k, M, B, T).
 * This function now correctly handles negative values.
 * Example: -12345 becomes '⌬ -12.3k'.
 * @param {number} amount The numeric value to format.
 * @param {boolean} [withSymbol=true] - Whether to prepend the '⌬ ' symbol.
 * @returns {string} The formatted credit string.
 */
export function formatCredits(amount, withSymbol = true) {
    const isNegative = amount < 0;
    const num = Math.abs(Math.floor(amount));
    // --- VIRTUAL WORKBENCH: REVERTED TO STANDARD SPACE ---
    const prefix = withSymbol ? '⌬ ' : '';
    // --- END VIRTUAL WORKBENCH ---
    const sign = isNegative ? '-' : '';

    let formattedNumber;
    // --- VIRTUAL WORKBENCH START: Phase 1 (Universal Abbreviation) ---
    if (num >= 1e18) { // Numbers >= 1 Quintillion
        formattedNumber = `${(num).toExponential(1)}`;
    } else if (num >= 1e15) { // Numbers >= 1 Quadrillion
        formattedNumber = `${parseFloat((num / 1e15).toFixed(2)).toString()}Q`;
    } else if (num >= 1e12) {
        formattedNumber = `${parseFloat((num / 1e12).toFixed(2)).toString()}T`;
    } else if (num >= 1e9) {
        formattedNumber = `${parseFloat((num / 1e9).toFixed(2)).toString()}B`;
    } else if (num >= 1e6) {
        formattedNumber = `${parseFloat((num / 1e6).toFixed(2)).toString()}M`;
    } else if (num >= 1e3) {
        formattedNumber = `${parseFloat((num / 1e3).toFixed(1)).toString()}k`;
    } else {
        formattedNumber = num.toLocaleString();
    }
    // --- VIRTUAL WORKBENCH END: Phase 1 (Universal Abbreviation) ---

    return `${prefix}${sign}${formattedNumber}`;
}


/**
 * Calculates the total number of cargo units currently used in a given inventory object.
 * @param {object} inventory - The inventory object to calculate, where keys are commodity IDs
 * and values are objects containing a 'quantity' property.
 * @returns {number} The total sum of all item quantities in the inventory.
 */
export function calculateInventoryUsed(inventory) {
     if (!inventory) return 0;
    return Object.values(inventory).reduce((acc, item) => acc + item.quantity, 0);
}

/**
 * Returns the correct ordinal suffix (st, nd, rd, th) for a given day of the month.
 * @param {number} day - The day of the month.
 * @returns {string} The ordinal suffix.
 * @private
 */
function getDaySuffix(day) {
    if (day > 3 && day < 21) return 'th';
    switch (day % 10) {
        case 1: return "st";
        case 2: return "nd";
        case 3: return "rd";
        default: return "th";
    }
}

/**
 * Converts an absolute day number from the start of the game into a formatted date string.
 * Example: 'Monday, January 1st, 2140'.
 * @param {number} dayNumber - The absolute day number of the game.
 * @returns {string} The fully formatted date string.
 */
export function getDateFromDay(dayNumber) {
    const year = DATE_CONFIG.START_YEAR + Math.floor((dayNumber - 1) / 365);
    let dayOfYear = (dayNumber - 1) % 365;
    const dayOfWeek = DATE_CONFIG.DAY_NAMES[(dayNumber - 1 + DATE_CONFIG.START_DAY_OF_WEEK) % 7];
    let monthIndex = 0;
    for (let i = 0; i < DATE_CONFIG.DAYS_IN_MONTH.length; i++) {
        if (dayOfYear < DATE_CONFIG.DAYS_IN_MONTH[i]) {
            monthIndex = i;
            break;
        }
        dayOfYear -= DATE_CONFIG.DAYS_IN_MONTH[i];
    }
    const dayOfMonth = dayOfYear + 1;
    const monthName = DATE_CONFIG.MONTH_NAMES[monthIndex];
    return `${dayOfWeek}, ${monthName} ${dayOfMonth}${getDaySuffix(dayOfMonth)}, ${year}`;
}

/**
 * Generates a random integer between a min and max value, skewed towards the lower end.
 * This is useful for creating distributions where lower values are more common.
 * @param {number} min - The minimum possible value (inclusive).
 * @param {number} max - The maximum possible value (inclusive).
 * @returns {number} The skewed random integer.
 */
export function skewedRandom(min, max) {
    let rand = (Math.random() + Math.random() + Math.random()) / 3; // Average of 3 rolls biases towards the mean (0.5).
    return Math.floor(min + (max - min) * Math.pow(rand, 0.5)); // Squaring the root further biases towards the lower end.
}

/**
 * Generates the HTML for the MKT and P/L indicators on a market card.
 * This centralized function ensures consistent and accurate indicator rendering.
 * @param {object} data - An object containing all necessary data for rendering.
 * @param {number} data.price - The current market buy price.
 * @param {number} data.sellPrice - The effective sell price (after diminishing returns).
 * @param {number} data.galacticAvg - The galactic average price for the commodity.
 * @param {object} data.playerItem - The player's inventory data for this commodity (can be null).
 * @returns {string} The HTML string for the indicator pills.
 */
export function renderIndicatorPills({ price, sellPrice, galacticAvg, playerItem }) {
    // Market vs Galactic Average Indicator (MKT)
    const marketDiff = price - galacticAvg;
    const marketPct = galacticAvg > 0 ? Math.round((marketDiff / galacticAvg) * 100) : 0;
    const marketSign = marketPct >= 0 ? '+' : '';
    let marketClass = 'neutral';
    if (marketPct > 5) marketClass = 'positive';
    if (marketPct < -5) marketClass = 'negative';
    const marketIcon = marketPct > 5 ? '▲' : (marketPct < -5 ? '▼' : '●');
    const marketIndicatorHtml = `<div class="indicator-pill ${marketClass}">${marketIcon} MKT: ${marketSign}${marketPct}%</div>`;

    let plIndicatorHtml = '';
    
    // Profit/Loss Indicator (P/L)
    if (playerItem && playerItem.avgCost > 0) {
        const spreadPerUnit = sellPrice - playerItem.avgCost;
        
        if (Math.abs(spreadPerUnit) > 0.01) {
            const plPct = playerItem.avgCost > 0 ? Math.round((spreadPerUnit / playerItem.avgCost) * 100) : 0;
            const plSign = plPct >= 0 ? '+' : '';
            const plClass = spreadPerUnit >= 0 ? 'positive' : 'negative';
            const plIcon = spreadPerUnit >= 0 ? '▲' : '▼';
            plIndicatorHtml = `<div class="indicator-pill ${plClass}"> P/L: ${plSign}${plPct}%</div>`;
        }
    }

    return `${marketIndicatorHtml}${plIndicatorHtml}`;
}
--- END OF FILE: ./js/utils.js ---

--- START OF FILE: ./js/effects/BaseEffect.js ---
/**
 * @fileoverview Defines the BaseEffect class, an abstract blueprint for all visual effects.
 * This class should not be instantiated directly. Instead, specific effect classes
 * should extend it and implement its methods.
 */

export class BaseEffect {
    /**
     * @JSDoc
     * @constructor
     * @param {object} options - Configuration for the effect, passed from the trigger.
     */
    constructor(options) {
        this.options = options;
    }

    /**
     * @JSDoc
     * @method play
     * @description The main entry point for the effect. The EffectsManager calls this method.
     * It is responsible for the entire lifecycle of the effect (setup, animation, cleanup).
     * Subclasses MUST implement this method.
     * @returns {Promise<void>} A promise that resolves when the effect is completely finished.
     */
    async play() {
        throw new Error("Effects must implement the 'play' method.");
    }

    /**
     * @JSDoc
     * @method _createDOM
     * @protected
     * @description Creates the necessary DOM elements for the effect and appends them to the document.
     * Subclasses should implement this to build their specific HTML structure.
     */
    _createDOM() {
        // To be implemented by subclasses
    }

    /**
     * @JSDoc
     * @method _injectCSS
     * @protected
     * @description Injects the effect-specific CSS into the document's head.
     * Subclasses should implement this to provide their styling.
     */
    _injectCSS() {
        // To be implemented by subclasses
    }

    /**
     * @JSDoc
     * @method _cleanup
     * @protected
     * @description Removes all DOM elements and CSS created by the effect.
     * This method is crucial for leaving the DOM in a clean state.
     */
    _cleanup() {
        // To be implemented by subclasses
    }
}
--- END OF FILE: ./js/effects/BaseEffect.js ---

--- START OF FILE: ./js/effects/EffectsManager.js ---
/**
 * @fileoverview Defines the EffectsManager, a controller for queueing and playing visual effects.
 */

export class EffectsManager {
    /**
     * @JSDoc
     * @constructor
     */
    constructor() {
        /** @private @type {Array<object>} */
        this.effectQueue = [];
        /** @private @type {boolean} */
        this.isEffectActive = false;
        /** @private @type {Object<string, typeof BaseEffect>} */
        this.effectsRegistry = {};
    }

    /**
     * @JSDoc
     * @method registerEffect
     * @description Adds an effect class to the registry, making it available to be triggered.
     * @param {string} name - The unique name to identify the effect (e.g., 'systemSurge').
     * @param {typeof BaseEffect} effectClass - The class definition for the effect, which must extend BaseEffect.
     */
    registerEffect(name, effectClass) {
        this.effectsRegistry[name] = effectClass;
    }

    /**
     * @JSDoc
     * @method trigger
     * @description Adds an effect request to the queue and starts processing.
     * @param {string} effectName - The name of the effect to trigger, must match a registered effect.
     * @param {object} options - The configuration object to pass to the effect's constructor.
     */
    trigger(effectName, options) {
        console.log(`MANAGER: EffectsManager.trigger received call for '${effectName}'. Queue length: ${this.effectQueue.length}`); // DIAGNOSTIC LOG
        this.effectQueue.push({ effectName, options });
        this._processQueue();
    }

    /**
     * @JSDoc
     * @method _processQueue
     * @private
     * @async
     * @description Processes the effect queue sequentially. It takes the next effect from the queue,
     * plays it, and waits for it to complete before starting the next one.
     */
    async _processQueue() {
        if (this.isEffectActive || this.effectQueue.length === 0) {
            return;
        }

        this.isEffectActive = true;
        const request = this.effectQueue.shift();
        const EffectClass = this.effectsRegistry[request.effectName];

        if (!EffectClass) {
            console.warn(`EffectManager: Attempted to trigger unregistered effect '${request.effectName}'.`);
            this.isEffectActive = false;
            this._processQueue(); // Process next item
            return;
        }

        try {
            console.log(`MANAGER: Instantiating and playing effect: '${request.effectName}'.`); // DIAGNOSTIC LOG
            const effect = new EffectClass(request.options);
            await effect.play();
        } catch (error) {
            console.error(`Error playing effect '${request.effectName}':`, error);
        } finally {
            this.isEffectActive = false;
            // Check for more effects that may have been added during playback
            this._processQueue();
        }
    }
}
--- END OF FILE: ./js/effects/EffectsManager.js ---

--- START OF FILE: ./js/data/constants.js ---
// js/data/constants.js
/**
 * @fileoverview This file contains centralized constant values and enumerations used throughout the game.
 * Consolidating these values here makes the codebase easier to manage, read, and modify, as it provides
 * a single source of truth for frequently used identifiers and game balance numbers.
 */

/**
 * Unique identifiers for each primary screen in the game's UI.
 * @enum {string}
 */
export const SCREEN_IDS = Object.freeze({
    MAP: 'map',
    NAVIGATION: 'navigation',
    SERVICES: 'services',
    MARKET: 'market',
    CARGO: 'cargo',
    HANGAR: 'hangar',
    MISSIONS: 'missions',
    FINANCE: 'finance',
    INTEL: 'intel',
});

/**
 * Unique identifiers for the main navigation tabs.
 * @enum {string}
 */
export const NAV_IDS = Object.freeze({
    SHIP: 'ship',
    STARPORT: 'starport',
    DATA: 'data',
});

// --- [[START]] VIRTUAL WORKBENCH (Phase 2) ---
/**
 * Unique identifiers for each type of ship available in the game.
 * Values are mapped to the 'GAME ID' column from the ship database.
 * @enum {string}
 */
export const SHIP_IDS = Object.freeze({
    WANDERER: 'Wanderer.Ship',
    STALWART: 'Stalwart.Ship',
    MULE: 'Mule.Ship',
    PATHFINDER: 'Pathfinder.Ship',
    NOMAD: 'Nomad.Ship',
    VINDICATOR: 'Vindicator.Ship',
    AEGIS: 'Aegis.Ship',
    ODYSSEY: 'Odyssey.Ship',
    MAJESTIC: 'luxury_s2', // Obsolete: Not in new ship_database.js
    TITAN_HAULER: 'Titan.Ship', // Mapped from 'Titan Hauler' to 'Titan'
    VOID_CHASER: 'rare_s2', // Obsolete: Not in new ship_database.js
    GUARDIAN: 'Guardian.Ship',
    STARGAZER: 'rare_s4', // Obsolete: Not in new ship_database.js
    BEHEMOTH: 'Behemoth.Ship',
});
// --- [[END]] VIRTUAL WORKBENCH (Phase 2) ---

/**
 * Unique identifiers for each type of commodity that can be traded.
 * @enum {string}
 */
export const COMMODITY_IDS = Object.freeze({
    WATER_ICE: 'water_ice',
    PLASTEEL: 'plasteel',
    HYDROPONICS: 'hydroponics',
    CYBERNETICS: 'cybernetics',
    PROPELLANT: 'propellant',
    PROCESSORS: 'processors',
    GMO_SEEDS: 'gmo_seeds',
    CRYO_PODS: 'cryo_pods',
    ATMO_PROCESSORS: 'atmos_processors',
    CLONED_ORGANS: 'cloned_organs',
    XENO_GEOLOGICALS: 'xeno_geologicals',
    SENTIENT_AI: 'sentient_ai',
    ANTIMATTER: 'antimatter',
    FOLDED_DRIVES: 'folded_drives',
});
/**
 * Unique identifiers for each travel destination (market location).
 * @enum {string}
 */
export const LOCATION_IDS = Object.freeze({
    EARTH: 'loc_earth',
    LUNA: 'loc_luna',
    MARS: 'loc_mars',
    VENUS: 'loc_venus',
    BELT: 'loc_belt',
    SATURN: 'loc_saturn',
    JUPITER: 'loc_jupiter',
    URANUS: 'loc_uranus',
    NEPTUNE: 'loc_neptune',
    PLUTO: 'loc_pluto',
    EXCHANGE: 'loc_exchange',
    KEPLER: 'loc_kepler',
});

/**
 * Unique identifiers for player perks, which provide passive bonuses.
 * @enum {string}
 */
export const PERK_IDS = Object.freeze({
    TRADEMASTER: 'trademaster',
    NAVIGATOR: 'navigator',
    VENETIAN_SYNDICATE: 'venetian_syndicate',
    MERCHANT_GUILD_SHIP: 'merchant_guild_ship',
});

/**
 * Unique identifiers for actions triggered by user interaction with UI elements.
 * These are typically assigned to `data-action` attributes in the HTML.
 * @enum {string}
 */
export const ACTION_IDS = Object.freeze({
    DEBUG_SIMPLE_START: 'debug-simple-start',
    SET_SCREEN: 'set-screen',
    TRAVEL: 'travel',
    BUY_SHIP: 'buy-ship',
    SELL_SHIP: 'sell-ship',
    SELECT_SHIP: 'select-ship',
    PAY_DEBT: 'pay-debt',
    TAKE_LOAN: 'take-loan',
    PURCHASE_INTEL: 'purchase-intel',
    ACQUIRE_LICENSE: 'acquire-license',
    BUY_ITEM: 'buy-item',
    SELL_ITEM: 'sell-item',
    SET_MAX_BUY: 'set-max-buy',
    SET_MAX_SELL: 'set-max-sell',
    INCREMENT: 'increment',
    DECREMENT: 'decrement',
    SHOW_PRICE_GRAPH: 'show-price-graph',
    SHOW_FINANCE_GRAPH: 'show-finance-graph',
    TOGGLE_MARKET_CARD_VIEW: 'toggle-market-card-view',
    TOGGLE_HANGAR_MODE: 'toggle-hangar-mode',
    SET_HANGAR_PAGE: 'set-hangar-page',
});

/**
 * Defines the types of conditions that can trigger or complete a tutorial step.
 * @enum {string}
 */
export const TUTORIAL_ACTION_TYPES = Object.freeze({
    SCREEN_LOAD: 'SCREEN_LOAD', // Triggered when a specific screen is loaded.
    ACTION: 'ACTION',           // Triggered by a specific user action (e.g., buying a ship).
    INFO: 'INFO',               // A purely informational step, completed by clicking "Next".
});

/**
 * A collection of core game balance numbers and rules.
 * @property {number} STARTING_CREDITS - The amount of credits the player starts with.
 * @property {number} STARTING_DEBT_INTEREST - The initial monthly interest on the starting debt.
 * @property {number} REPAIR_COST_PER_HP - The credit cost to repair one point of hull damage.
 * @property {number} REPAIR_AMOUNT_PER_TICK - The percentage of max hull repaired per service tick.
 * @property {number} FUEL_SCALAR - A base multiplier used in travel fuel cost calculations.
 * @property {number} INTEREST_INTERVAL - The number of days between interest charges on debt.
 * @property {number} PASSIVE_REPAIR_RATE - The percentage of max hull repaired per day on inactive ships.
 * @property {number} HULL_DECAY_PER_TRAVEL_DAY - The amount of flat hull damage taken per day of travel.
 * @property {number} SHIP_SELL_MODIFIER - The percentage of a ship's base price received when sold.
 * @property {number} RARE_SHIP_CHANCE - The probability (0-1) of a rare ship appearing in the shipyard stock.
 * @property {number} PRICE_HISTORY_LENGTH - The maximum number of daily price entries to store for graphs.
 * @property {number} FINANCE_HISTORY_LENGTH - The maximum number of transactions to display in the finance log.
 * @property {number} DAILY_PRICE_VOLATILITY - The maximum percentage a price can fluctuate daily.
 * @property {number} MEAN_REVERSION_STRENGTH - The strength of the tendency for prices to return to their galactic average.
 * @property {number} MARKET_PRESSURE_DECAY - The weekly decay factor for market pressure (e.g., 0.85 means 15% decay).
 * @property {number} LOCAL_PRICE_MOD_STRENGTH - The strength of the local import/export price modifier (0-1).
 * @property {number} LOAN_GARNISHMENT_DAYS - The number of days after taking a loan before wage garnishment can begin.
 * @property {number} LOAN_GARNISHMENT_PERCENT - The percentage of player credits garnished if their loan is delinquent.
 * @property {number} RANDOM_EVENT_CHANCE - The probability (0-1) of a random event occurring during travel.
 */
export const GAME_RULES = Object.freeze({
    STARTING_CREDITS: 5000,
    STARTING_DEBT_INTEREST: 125,
    REPAIR_COST_PER_HP: 75,
    REPAIR_AMOUNT_PER_TICK: 5,
    FUEL_SCALAR: 3,
    INTEREST_INTERVAL: 30,
    PASSIVE_REPAIR_RATE: 0.02,
    HULL_DECAY_PER_TRAVEL_DAY: 1 / 7,
    SHIP_SELL_MODIFIER: 0.75,
    RARE_SHIP_CHANCE: 0.3,
    PRICE_HISTORY_LENGTH: 65,
    FINANCE_HISTORY_LENGTH: 25,
    DAILY_PRICE_VOLATILITY: 0.25,
    MEAN_REVERSION_STRENGTH: 0.04,
    MARKET_PRESSURE_DECAY: 0.70,
    LOCAL_PRICE_MOD_STRENGTH: 0.5,
    LOAN_GARNISHMENT_DAYS: 1095,
    LOAN_GARNISHMENT_PERCENT: 0.14,
    RANDOM_EVENT_CHANCE: 0.07,
});

/**
 * Defines the wealth milestones that trigger the reveal of new commodity tiers.
 */
export const WEALTH_MILESTONES = [
    { threshold: 50000, revealsTier: 2 },
    { threshold: 450000, revealsTier: 3 },
    { threshold: 4000000, revealsTier: 4 },
    { threshold: 35000000, revealsTier: 5 },
    { threshold: 300000000, revealsTier: 6 },
    { threshold: 2500000000, revealsTier: 7 }
];

/**
 * The key used to store and retrieve the game state from the browser's localStorage.
 * @type {string}
 */
export const SAVE_KEY = 'orbitalTraderSave_v2';
--- END OF FILE: ./js/data/constants.js ---

--- START OF FILE: ./js/data/missions.js ---
// js/data/missions.js
/**
 * @fileoverview
 * Defines all static mission data for the game.
 */
import { COMMODITY_IDS, LOCATION_IDS } from './constants.js';

export const MISSIONS = {
    'mission_tutorial_01': {
        id: "mission_tutorial_01",
        name: "Milk Run to Luna",
        type: "DELIVERY",
        host: "STATION",
        isRepeatable: false,
        isAbandonable: false,
        description: "Hey buddy, you're a new captain, right? My hauler's reactor is fried and I'm on the hook for a delivery to Luna.<br><br>Could you deliver this load of <b>Plasteel</b> to the <b>Moon</b> for me? I don't have any credits to spare, but I've padded the manifest.<br><br>Deliver what I owe, keep the rest. You won't have trouble selling it there, trust me.",
        objectives: [
            { "type": "have_item", "goodId": "plasteel", "quantity": 5 }
        ],
        completion: {
            "locationId": "loc_luna",
            "title": "Favor Complete",
            "text": "The freelancer sends his thanks.",
            "buttonText": "Deliver Plasteel"
        },
        rewards: [],
        providedCargo: [ // Cargo given to the player on mission acceptance.
            { "goodId": "plasteel", "quantity": 6 }
        ]
    },
    'mission_tutorial_02': {
        id: "mission_tutorial_02",
        name: "Martian Resupply",
        type: "DELIVERY",
        host: "STATION",
        isRepeatable: false,
        isAbandonable: false,
        description: "A construction crew on Mars has requested a small shipment of plasteel to complete a habitat.",
        prerequisites: [ // This mission only becomes available after 'mission_tutorial_01' is complete.
            { "type": "mission_completed", "missionId": "mission_tutorial_01" }
        ],
        objectives: [
            { "type": "have_item", "goodId": "plasteel", "quantity": 2 }
        ],
        completion: {
            "locationId": "loc_mars",
            "title": "Delivery Complete",
            "text": "The construction foreman thanks you for the Plasteel.",
            "buttonText": "Deliver Plasteel"
        },
        rewards: [
            { "type": "credits", "amount": 7500 }
        ]
    },
    'mission_license_t3': {
         id: "mission_license_t3", name: "Guild Certification", type: "LICENSE_GRANT", host: "GUILD", isRepeatable: false, isAbandonable: false, description: "The Merchant's Guild requires you to certify your trade proficiency. Accepting this contract formally recognizes your status and grants you access to Tier 3 commodities.", prerequisites: [{ "type": "revealed_tier", "tier": 3 }], objectives: [], completion: {}, rewards: [{ "type": "license", "licenseId": "t3_license" }]
    },
    'mission_license_t5': {
         id: "mission_license_t5", name: "Governor's Contract", type: "LICENSE_GRANT", host: "STATION", isRepeatable: false, isAbandonable: false, description: "The planetary governor requires a sign of your commitment to local industry. This contract solidifies your standing and unlocks access to Tier 5 commodities.", prerequisites: [{ "type": "revealed_tier", "tier": 5 }], objectives: [], completion: {}, rewards: [{ "type": "license", "licenseId": "t5_license" }]
    },
    'mission_license_t7': {
         id: "mission_license_t7", name: "Legendary Run", type: "LICENSE_GRANT", host: "UNKNOWN", isRepeatable: false, isAbandonable: false, description: "Your name is spoken in the farthest corners of the system. Only a legend of your stature may be granted the right to trade the most advanced technologies known.", prerequisites: [{ "type": "revealed_tier", "tier": 7 }], objectives: [], completion: {}, rewards: [{ "type": "license", "licenseId": "t7_license" }]
    }
};
--- END OF FILE: ./js/data/missions.js ---

--- START OF FILE: ./js/data/database.js ---
// js/data/database.js
/**
 * @fileoverview
 * This file serves as the central database for all static game data.
 * It consolidates information from previous data, config, and content files
 * into a single, authoritative source. This improves maintainability and clarity
 * by providing a unified structure for all core game content and configuration.
 */
import { LOCATION_IDS, PERK_IDS, SHIP_IDS, COMMODITY_IDS, SCREEN_IDS, TUTORIAL_ACTION_TYPES, ACTION_IDS, NAV_IDS } from './constants.js';
import { MISSIONS } from './missions.js';
import { RANDOM_EVENTS } from './events.js';
import { AGE_EVENTS } from './age_events.js';
import { TUTORIAL_DATA } from './tutorials.js';
// --- [[START]] VIRTUAL WORKBENCH (Phase 3) ---
import { SHIP_DATABASE } from './ship_database.js';
// --- [[END]] VIRTUAL WORKBENCH (Phase 3) ---

// --- In-Game Date Configuration ---
export const DATE_CONFIG = {
    START_YEAR: 2140,
    START_DAY_OF_WEEK: 1, // 0 = Sunday, 1 = Monday, etc.
    DAYS_IN_MONTH: [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31],
    MONTH_NAMES: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
    DAY_NAMES: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]
};

export const SYSTEM_STATES = {
    'NEUTRAL': {
        name: 'Neutral System',
        duration: 28,
        description: "Standard space-faring conditions. Markets are operating under normal parameters.",
        modifiers: {} // No economic deviations
    },
    /* // Example of a disruptive economic state. More can be added here.
    'CORPORATE_WAR': {
        name: 'Corporate War',
        duration: 28,
        description: "Rival corporations have escalated to open conflict, creating high demand for military-grade materials. The Plasteel and Cybernetics markets are in turmoil.",
        modifiers: {
            commodity: {
                'cybernetics': {
                    availability: 0.6,
                    price: 1.4,
                    volatility_mult: 2.5,
                    mean_reversion_mult: 0.3
                },
                'plasteel': {
                    availability: 0.7,
                    price: 1.3,
                    volatility_mult: 2.0,
                    mean_reversion_mult: 0.5
                }
            }
        }
    }
    */
};

export const DB = {
    // --- Core Game Configuration ---
    CONFIG: {
        INTEL_COST_PERCENTAGE: 0.20,
        INTEL_MIN_CREDITS: 5000,
        INTEL_CHANCE: 0.3,
        INTEL_DEMAND_MOD: 1.8,
        INTEL_DEPRESSION_MOD: 0.5,
    },

    SYSTEM_STATES: SYSTEM_STATES,

    DATE_CONFIG: DATE_CONFIG,

    // --- New Game Introduction Sequence ---
    INTRO_SEQUENCE_V1: {
      modals: [
        {
          id: 'lore_1',
          title: 'Year 2140',
          description: "Humanity has expanded throughout the Solar System.<br><br> <span class=\"hl\">Commerce</span> has thrived among the numerous colonies and stations longer than living memory.",
          buttonText: 'Begin',
          contentClass: 'text-center'
        },
        {
          id: 'lore_2',
          title: "The Price of Freedom",
          description: "A dead-end job in the Belt pays the bills, but it does not offer the <b class='hl-green font-bold'>prosperity</b> that you dream of.<br><br>The <span class='hl'>Merchant's Guild</span> will fund your ambition, but their price is steep.<br><br>This is no simple loan; it's a bet on yourself and your future.",
          buttonText: 'Apply for Loan',
          contentClass: 'text-center',
          buttonClass: 'btn-pulse-green'
        },
        {
          id: 'charter',
          title: "<span class=\"hl\">MERCHANT'S GUILD LOAN AGREEMENT</span>",
          description: `
            <div class="font-roboto-mono text-left text-sm space-y-2">
                <p><span class="text-gray-400">CHARTER ID:</span> G7-K491-38B</p>
                <p><span class="text-gray-400">CREDIT AMOUNT:</span> <span class="credits-text-pulsing">⌬ 25,000</span></p>
                <p><span class="text-gray-400">INTEREST RATE:</span> 1.56% (Monthly)</p>
            </div>
            <div class="border-t border-slate-600 my-4"></div>
            <p class="text-sm text-gray-400 text-justify">Herein, the Applicant agrees to the terms of repayment and interest accrual, subject to the Interstellar Commerce Mandates of the Merchant's Guild. This binding digital agreement is logged on the system-wide ledger, whereupon it is considered immutable and enforceable system-wide. The principal of the debt is due in 1095 Terran-standard days, after which failure to remit payment shall authorize the automatic initiation of a garnishment sub-routine against the Applicant's credit.</p>
          `,
          buttonText: 'Accept Terms',
          buttonClass: 'btn-pulse-gold'
        },
        {
          id: 'signature',
          title: 'SIGN YOUR NAME',
          description: `
            <p class="text-sm text-gray-400 text-justify mb-4">I, the undersigned, do hereby accept the aforementioned terms and enter into this agreement with the Merchant's Guild. My signature, digitally rendered, shall serve as my legal mark.</p>
          `,
          buttonText: 'Submit Application'
        },
        {
            id: 'final',
            title: 'Low On Credits!',
            description: "Interest on your debt grows every month. It's time to make some <b class='hl-yellow font-bold'>credits</b>. Let's view the <b>Mission Terminal</b> here on <b>Mars</b>!",
            buttonText: 'View Missions'
        }
      ]
    },

    // --- Visual Representations for Locations ---
    LOCATION_VISUALS: {
        [LOCATION_IDS.EARTH]: '🌍',
        [LOCATION_IDS.LUNA]: '🌕',
        [LOCATION_IDS.MARS]: '🔴',
        [LOCATION_IDS.VENUS]: '🟡',
        [LOCATION_IDS.BELT]: '🪨',
        [LOCATION_IDS.SATURN]: '🪐',
        [LOCATION_IDS.JUPITER]: '🟠',
        [LOCATION_IDS.URANUS]: '🔵',
        [LOCATION_IDS.NEPTUNE]: '🟣',
        [LOCATION_IDS.PLUTO]: '🪩',
        [LOCATION_IDS.EXCHANGE]: '🏴‍☠️',
        [LOCATION_IDS.KEPLER]: '👁️'
    },

    TRAVEL_VISUALS: {
        zones: {
            inner_sphere: {
                locations: [LOCATION_IDS.EARTH, LOCATION_IDS.LUNA, LOCATION_IDS.MARS, LOCATION_IDS.BELT],
                gradient: ['#0f172a', '#1e3a8a']
            },
            outer_reaches: {
                locations: [LOCATION_IDS.JUPITER, LOCATION_IDS.SATURN, LOCATION_IDS.URANUS, LOCATION_IDS.NEPTUNE],
                gradient: ['#0f172a', '#312e81']
            }
        },
        objects: {
            'earth_to_mars': [{ type: 'planet', emoji: '🌕', position: { x: 0.5, y: 0.3 }, scale: 0.8, speed: 0.3 }],
            'belt_to_jupiter': [{ type: 'asteroid_field', count: 15, speed: 0.2 }]
        }
    },

    // --- Player Perks and Their Effects ---
    PERKS: {
        [PERK_IDS.TRADEMASTER]: { profitBonus: 0.05 },
        [PERK_IDS.NAVIGATOR]: { fuelMod: 0.9, hullDecayMod: 0.9, travelTimeMod: 0.9 },
        [PERK_IDS.VENETIAN_SYNDICATE]: { fuelDiscount: 0.25, repairDiscount: 0.25 }
    },

    // --- Narrative Events Triggered by Game Progression ---
    AGE_EVENTS: AGE_EVENTS,

    // --- Random Events Encountered During Travel ---
    RANDOM_EVENTS: RANDOM_EVENTS,

    // --- [[START]] VIRTUAL WORKBENCH (Phase 3) ---
    // The old, hardcoded DB.SHIPS object has been removed.
    // It is now replaced by the imported SHIP_DATABASE object from js/data/ship_database.js
    SHIPS: SHIP_DATABASE,
    // --- [[END]] VIRTUAL WORKBENCH (Phase 3) ---

    // --- Tradable Commodities Data ---
    COMMODITIES: [
        { id: COMMODITY_IDS.WATER_ICE, name: 'Water Ice', tier: 1, basePriceRange: [15, 80], volatility: 0.01, canonicalAvailability: [80, 150], styleClass: 'item-style-1', lore: 'Crude, unrefined water ice scraped from asteroids; a universal necessity.', cat: 'RAW', symbol: 'H2O' },
        { id: COMMODITY_IDS.PLASTEEL, name: 'Plasteel', tier: 1, basePriceRange: [100, 280], volatility: 0.015, canonicalAvailability: [80, 150], styleClass: 'item-style-2', lore: 'A basic, versatile polymer for 3D printing and simple manufacturing.', cat: 'IND', symbol: 'PLST' },
        { id: COMMODITY_IDS.HYDROPONICS, name: 'Hydroponics', tier: 2, licenseId: 't2_license', basePriceRange: [850, 2400], volatility: 0.025, canonicalAvailability: [40, 70], styleClass: 'item-style-3', lore: 'Packaged agricultural systems and produce essential for feeding isolated colonies.', cat: 'AGRI', symbol: 'HYD' },
        { id: COMMODITY_IDS.CYBERNETICS, name: 'Cybernetics', tier: 2, licenseId: 't2_license', basePriceRange: [1200, 3800], volatility: 0.03, canonicalAvailability: [40, 70], styleClass: 'item-style-4', lore: 'Mass-produced enhancement limbs and organs for the industrial workforce.', cat: 'TECH', symbol: 'CYB' },
        { id: COMMODITY_IDS.PROPELLANT, name: 'Refined Propellant', tier: 3, licenseId: 't3_license', basePriceRange: [14000, 38000], volatility: 0.035, canonicalAvailability: [25, 50], styleClass: 'item-style-5', lore: 'High-efficiency fuel that powers all modern ship drives.', cat: 'IND', symbol: 'PROP' },
        { id: COMMODITY_IDS.PROCESSORS, name: 'Neural Processors', tier: 3, licenseId: 't3_license', basePriceRange: [18000, 52000], volatility: 0.045, canonicalAvailability: [25, 50], styleClass: 'item-style-6', lore: 'The silicon brains behind complex ship systems and station logistics.', cat: 'TECH', symbol: 'NPRO' },
        { id: COMMODITY_IDS.GMO_SEEDS, name: 'GMO Seed Cultures', tier: 4, licenseId: 't4_license', basePriceRange: [190000, 550000], volatility: 0.06, canonicalAvailability: [15, 30], styleClass: 'item-style-7', lore: 'Patented seeds holding the key to unlocking agricultural wealth on new worlds.', cat: 'AGRI', symbol: 'GMO' },
        { id: COMMODITY_IDS.CRYO_PODS, name: 'Cryo-Sleep Pods', tier: 4, licenseId: 't4_license', basePriceRange: [250000, 750000], volatility: 0.075, canonicalAvailability: [15, 30], styleClass: 'item-style-8', lore: 'Essential for long-haul passenger transport and colonization efforts.', cat: 'CIV', symbol: 'CRYO' },
        { id: COMMODITY_IDS.ATMO_PROCESSORS, name: 'Atmo Processors', tier: 5, licenseId: 't5_license', basePriceRange: [2800000, 8500000], volatility: 0.08, canonicalAvailability: [10, 20], styleClass: 'item-style-9', lore: 'Gargantuan machines that begin the centuries-long process of making a world breathable.', cat: 'IND', symbol: 'ATMO' },
        { id: COMMODITY_IDS.CLONED_ORGANS, name: 'Cloned Organs', tier: 5, licenseId: 't5_license', basePriceRange: [3500000, 11000000], volatility: 0.09, canonicalAvailability: [10, 20], styleClass: 'item-style-10', lore: 'Lab-grown replacements with high demand in wealthy core worlds; morally grey.', cat: 'BIO', symbol: 'CLON' },
        { id: COMMODITY_IDS.XENO_GEOLOGICALS, name: 'Xeno-Geologicals', tier: 6, licenseId: 't6_license', basePriceRange: [24000000, 70000000], volatility: 0.1, canonicalAvailability: [2, 10], styleClass: 'item-style-11', lore: 'Rare, non-terrestrial minerals with bizarre physical properties; a scientific treasure.', cat: 'RAW', symbol: 'XENO' },
        { id: COMMODITY_IDS.SENTIENT_AI, name: 'Sentient AI Cores', tier: 6, licenseId: 't6_license', basePriceRange: [32000000, 95000000], volatility: 0.125, canonicalAvailability: [2, 10], styleClass: 'item-style-12', lore: 'The "brains" of capital ships whose emergent consciousness is a subject of intense, and often classified, philosophical debate.', cat: 'TECH', symbol: 'AI' },
        { id: COMMODITY_IDS.ANTIMATTER, name: 'Antimatter', tier: 7, licenseId: 't7_license', basePriceRange: [280000000, 800000000], volatility: 0.15, canonicalAvailability: [2, 10], styleClass: 'item-style-13', lore: 'The only safe way to transport the most volatile and powerful substance known to science.', cat: 'RARE', symbol: 'AM' },
        { id: COMMODITY_IDS.FOLDED_DRIVES, name: 'Folded-Space Drives', tier: 7, licenseId: 't7_license', basePriceRange: [350000000, 1100000000], volatility: 0.15, canonicalAvailability: [2, 10], styleClass: 'item-style-14', lore: 'The pinnacle of travel tech, allowing a vessel to pierce spacetime for near-instantaneous jumps.', cat: 'RARE', symbol: 'FSD' }
    ],

    // --- Trading Licenses ---
    LICENSES: {
        't2_license': { type: 'purchase', name: 'Tier 2 Trade License', description: 'Grants access to trade Tier 2 commodities like Hydroponics and Cybernetics.', cost: 25000 },
        't3_license': { type: 'mission', name: 'Tier 3 Trade License', description: 'Grants access to trade Tier 3 commodities.', missionId: 'mission_license_t3', guidanceText: 'Access to this tier is granted by the Merchant\'s Guild upon completion of a key contract.' },
        't4_license': { type: 'purchase', name: 'Tier 4 Trade License', description: 'Grants access to trade Tier 4 commodities.', cost: 4000000 },
        't5_license': { type: 'mission', name: 'Tier 5 Trade License', description: 'Grants access to trade Tier 5 commodities.', missionId: 'mission_license_t5', guidanceText: 'Prove your industrial might by completing a grand contract for a planetary governor.' },
        't6_license': { type: 'purchase', name: 'Tier 6 Trade License', description: 'Grants access to trade the rarest and most exotic technologies.', cost: 300000000 },
        't7_license': { type: 'mission', name: 'Tier 7 Trade License', description: 'The ultimate license, granting the right to trade reality-bending technologies.', missionId: 'mission_license_t7', guidanceText: 'Only a true legend of the trade routes can earn this privilege.' },
    },

    // --- Market and Location Data ---
    MARKETS: [
        { id: LOCATION_IDS.VENUS, name: 'Venus', distance: 97, launchFlavor: "Floating cities hide scientific marvels and secrets.", navTheme: { gradient: 'linear-gradient(to bottom right, #854d0e, #0f172a)', textColor: '#fde047', borderColor: '#facc15' }, description: 'A scientific enclave hungry for research data and processors.', color: 'border-yellow-400', bg: 'bg-gradient-to-br from-yellow-800 to-slate-900', fuelPrice: 400, arrivalLore: "Floating cities drift through the thick, acidic clouds, their lights a lonely defiance to the crushing pressure below.", specialty: "Exclusive access to the Venetian Syndicate for high-risk, high-reward intel and missions.", availabilityModifier: { [COMMODITY_IDS.CLONED_ORGANS]: 2.0, [COMMODITY_IDS.PROCESSORS]: 2.0, [COMMODITY_IDS.GMO_SEEDS]: 0.5, [COMMODITY_IDS.SENTIENT_AI]: 0.5 } },
        { id: LOCATION_IDS.EARTH, name: 'Earth', distance: 180, launchFlavor: "The bustling heart of the Sol system.", navTheme: { gradient: 'linear-gradient(to bottom right, #1e3a8a, #0f172a)', textColor: '#93c5fd', borderColor: '#60a5fa' }, description: 'The hub of power and wealth. High demand for tech and bio-enhancements.', color: 'border-cyan-500', bg: 'bg-gradient-to-br from-blue-900 to-slate-900', fuelPrice: 250, arrivalLore: "The cradle of humanity buzzes with endless traffic; a beacon of blue and green against the void.", specialty: "Offers the best sell prices for rare, high-tier goods and is the exclusive source for top-tier ship licenses.", availabilityModifier: { [COMMODITY_IDS.HYDROPONICS]: 2.0, [COMMODITY_IDS.GMO_SEEDS]: 2.0, [COMMODITY_IDS.CLONED_ORGANS]: 0.5, [COMMODITY_IDS.XENO_GEOLOGICALS]: 0.5 } },
        { id: LOCATION_IDS.LUNA, name: 'The Moon', parent: 'loc_earth', distance: 15, launchFlavor: "An industrial powerhouse built on grey dust.", navTheme: { gradient: 'linear-gradient(to bottom right, #374151, #0f172a)', textColor: '#e5e7eb', borderColor: '#9ca3af' }, description: 'An industrial proving ground. Exports propellant and basic materials.', color: 'border-gray-400', bg: 'bg-gradient-to-br from-gray-700 to-slate-900', fuelPrice: 350, arrivalLore: "Dusty plains are scarred by mining operations under the harsh, silent watch of distant Earth.", specialty: "Offers a slight discount on all ship repairs.", availabilityModifier: { [COMMODITY_IDS.PLASTEEL]: 2.0, [COMMODITY_IDS.PROPELLANT]: 2.0, [COMMODITY_IDS.WATER_ICE]: 0.5, [COMMODITY_IDS.HYDROPONICS]: 0.5 } },
        { id: LOCATION_IDS.MARS, name: 'Mars', distance: 226, launchFlavor: "The red frontier, ripe with opportunity.", navTheme: { gradient: 'linear-gradient(to bottom right, #7c2d12, #0f172a)', textColor: '#fca5a5', borderColor: '#f87171' }, description: 'A growing colony. Needs processors and materials for expansion.', color: 'border-orange-600', bg: 'bg-gradient-to-br from-orange-900 to-slate-900', fuelPrice: 450, arrivalLore: "The thin, reddish atmosphere whips across terraforming arrays and fledgling biodomes.", specialty: "Offers a higher-than-average number of colonial supply missions.", availabilityModifier: { [COMMODITY_IDS.PLASTEEL]: 2.0, [COMMODITY_IDS.HYDROPONICS]: 0.5, [COMMODITY_IDS.CRYO_PODS]: 0.5, [COMMODITY_IDS.WATER_ICE]: 0.5 } },
        { id: LOCATION_IDS.BELT, name: 'The Belt', distance: 292, launchFlavor: "A lawless expanse of rock and riches.", navTheme: { gradient: 'linear-gradient(to bottom right, #292524, #0f172a)', textColor: '#ca8a04', borderColor: '#a16207' }, description: 'A lawless frontier. Rich in raw minerals and water ice.', color: 'border-amber-700', bg: 'bg-gradient-to-br from-stone-800 to-slate-900', fuelPrice: 600, arrivalLore: "Countless rocks tumble in a silent, chaotic dance, hiding both immense wealth and sudden peril.", specialty: "Increased chance to find rare derelict ships in its shipyards.", availabilityModifier: { [COMMODITY_IDS.WATER_ICE]: 2.0, [COMMODITY_IDS.XENO_GEOLOGICALS]: 2.0, [COMMODITY_IDS.HYDROPONICS]: 0.5, [COMMODITY_IDS.CYBERNETICS]: 0.5 } },
        { id: LOCATION_IDS.EXCHANGE, name: 'The Exchange', distance: 309, launchFlavor: "The notorious black market of the outer belt.", navTheme: { gradient: 'linear-gradient(to bottom right, #581c87, #000000, #0f172a)', textColor: '#e9d5ff', borderColor: '#c084fc' }, description: 'A legendary black market station hidden deep within the Kuiper Belt. High stakes, high rewards.', color: 'border-purple-500', bg: 'bg-gradient-to-br from-purple-900 via-black to-slate-900', fuelPrice: 1200, arrivalLore: "A hollowed-out asteroid, bristling with rogue drones and comms jammers. This is the fabled Exchange, where fortunes are made or lost in an instant.", specialty: "The notorious black market of the outer belt.", availabilityModifier: {} },
        { id: LOCATION_IDS.JUPITER, name: 'Jupiter', distance: 443, launchFlavor: "Vast refineries harvest fuel from the giant.", navTheme: { gradient: 'linear-gradient(to bottom right, #9a3412, #1c1917)', textColor: '#fed7aa', borderColor: '#fb923c' }, description: 'A gas giant teeming with orbital refineries. The primary source of propellant for the outer system.', color: 'border-orange-400', bg: 'bg-gradient-to-br from-orange-800 to-stone-900', fuelPrice: 150, arrivalLore: "The colossal sphere of Jupiter dominates the viewport, its Great Red Spot a baleful eye. Automated refineries drift in its upper atmosphere.", specialty: "Fuel is sold at 50% of the galactic average price, making it an essential stop for any long-haul journey.", availabilityModifier: { [COMMODITY_IDS.PROPELLANT]: 2.0, [COMMODITY_IDS.ATMO_PROCESSORS]: 2.0, [COMMODITY_IDS.PROCESSORS]: 0.5 } },
        { id: LOCATION_IDS.SATURN, name: 'Saturn', distance: 618, launchFlavor: "Opulent stations drift among majestic rings.", navTheme: { gradient: 'linear-gradient(to bottom right, #713f12, #312e81, #0f172a)', textColor: '#fef08a', borderColor: '#fde047' }, description: 'A tourism hub. Demands luxury goods and bio-wares.', color: 'border-yellow-200', bg: 'bg-gradient-to-br from-yellow-900 via-indigo-900 to-slate-900', fuelPrice: 550, arrivalLore: "The majestic rings cast long shadows over opulent tourist stations and icy harvesting rigs.", specialty: "Offers the highest sell prices for luxury and bio-tech goods.", availabilityModifier: { [COMMODITY_IDS.CRYO_PODS]: 0.5, [COMMODITY_IDS.CLONED_ORGANS]: 0.5 } },
        { id: LOCATION_IDS.URANUS, name: 'Uranus', distance: 775, launchFlavor: "A silent, ice-cold world of strange science.", navTheme: { gradient: 'linear-gradient(to bottom right, #155e75, #312e81)', textColor: '#a5f3fc', borderColor: '#67e8f9' }, description: 'A cold, distant world where scientists study bizarre quantum phenomena and strange geologicals.', color: 'border-cyan-200', bg: 'bg-gradient-to-br from-cyan-800 to-indigo-900', fuelPrice: 700, arrivalLore: "The pale, featureless orb of Uranus hangs tilted in the sky. Research outposts glitter like ice crystals in the eternal twilight.", specialty: "A unique R&D service to temporarily \"overclock\" ship components.", availabilityModifier: { [COMMODITY_IDS.ATMO_PROCESSORS]: 2.0, [COMMODITY_IDS.SENTIENT_AI]: 0.5, [COMMODITY_IDS.PROCESSORS]: 0.5 } },
        { id: LOCATION_IDS.NEPTUNE, name: 'Neptune', distance: 877, launchFlavor: "The stormy edge of military-controlled space.", navTheme: { gradient: 'linear-gradient(to bottom right, #1e3a8a, #000000)', textColor: '#93c5fd', borderColor: '#60a5fa' }, description: 'A dark, stormy world, home to secretive military bases and shipyards.', color: 'border-blue-400', bg: 'bg-gradient-to-br from-blue-900 to-black', fuelPrice: 650, arrivalLore: "Supersonic winds howl across Neptune's deep blue clouds. Heavily armed patrol ships escort you to the shielded orbital station.", specialty: "A military surplus shipyard that occasionally sells damaged, high-tier frigates.", availabilityModifier: { [COMMODITY_IDS.PLASTEEL]: 0.1, [COMMODITY_IDS.PROPELLANT]: 0.5 } },
        { id: LOCATION_IDS.KEPLER, name: "Kepler's Eye", distance: 903, launchFlavor: "A colossal lens staring into the infinite void.", navTheme: { gradient: 'linear-gradient(to bottom right, #701a75, #0f172a)', textColor: '#f472b6', borderColor: '#ec4899' }, description: 'A massive deep-space observatory that consumes vast amounts of processing power.', color: 'border-fuchsia-500', bg: 'bg-gradient-to-br from-fuchsia-900 to-slate-900', fuelPrice: 800, arrivalLore: "The station is a single, enormous lens staring into the abyss, surrounded by a delicate lattice of sensors and habitation rings.", specialty: "A colossal lens staring into the infinite void.", availabilityModifier: {} },
        { id: LOCATION_IDS.PLUTO, name: 'Pluto', distance: 1080, launchFlavor: "A haven for outcasts at the system's fringe.", navTheme: { gradient: 'linear-gradient(to bottom right, #312e81, #0f172a)', textColor: '#c4b5fd', borderColor: '#a78bfa' }, description: 'The furthest outpost, a haven for outcasts and smugglers dealing in forbidden tech.', color: 'border-indigo-400', bg: 'bg-gradient-to-br from-indigo-900 to-slate-900', fuelPrice: 900, arrivalLore: "Pluto's tiny, frozen heart is a whisper in the dark. The only light comes from a ramshackle station carved into a nitrogen-ice mountain.", specialty: "A haven for outcasts at the system's fringe.", availabilityModifier: { 'water_ice': 2.0, 'hydroponics': 0.5, 'cybernetics': 0.5, 'cloned_organs': 0.5, 'xeno_geologicals': 2.0 } }
    ],

    // --- Mission Data ---
    MISSIONS: MISSIONS,

    // --- Tutorial System Data ---
    TUTORIAL_DATA: TUTORIAL_DATA
};
--- END OF FILE: ./js/data/database.js ---

--- START OF FILE: ./js/data/events.js ---
// js/data/events.js
/**
 * @fileoverview
 * Defines all static random event data for the game.
 */
import { COMMODITY_IDS } from './constants.js';

export const RANDOM_EVENTS = [
    {
        id: 'distress_call',
        title: 'Distress Call',
        scenario: 'You pick up a distress signal from a small, damaged ship. They are out of fuel and requesting an emergency transfer to restart their reactor.',
        precondition: (gameState, activeShip) => activeShip.fuel >= 20, // Event can only trigger if player has enough fuel to offer.
        choices: [
            {
                title: 'Offer Aid (20 Fuel)',
                outcomes: [
                    {
                        chance: 0.75,
                        description: 'The fuel transfer is successful. The grateful captain rewards you with 10,000 credits for your timely assistance.',
                        effects: [ { type: 'fuel', value: -20 }, { type: 'credits', value: 10000 } ]
                    },
                    {
                        chance: 0.25,
                        description: 'As the fuel transfer begins, their reactor overloads! The resulting explosion damages your hull by 15%.',
                        effects: [ { type: 'fuel', value: -20 }, { type: 'hull_damage_percent', value: 15 } ]
                    }
                ]
            },
            {
                title: 'Ignore the Call',
                outcomes: [ { chance: 1.0, description: 'You press on, and the desperate signal fades behind you.', effects: [] } ]
            }
        ]
    },
    {
        id: 'floating_cargo',
        title: 'Floating Cargo Pod',
        scenario: 'Long-range sensors detect an unmarked, sealed cargo pod adrift in the shipping lane. It appears to be intact.',
        precondition: () => true,
        choices: [
            {
                title: 'Bring it Aboard',
                outcomes: [
                    {
                        chance: 0.60,
                        description: `The pod contains valuable goods. You gain 25 units of Neural Processors.`,
                        effects: [ { type: 'add_cargo', value: { id: COMMODITY_IDS.PROCESSORS, quantity: 25 } } ]
                    },
                    {
                        chance: 0.40,
                        description: 'It was a trap! The pod is booby-trapped and detonates as your tractor beam locks on, causing 20% hull damage.',
                        effects: [ { type: 'hull_damage_percent', value: 20 } ]
                    }
                ]
            },
            {
                title: 'Report it',
                outcomes: [ { chance: 1.0, description: 'You notify the nearest station of the hazard and receive a small finder\'s fee of 1,000 credits.', effects: [ { type: 'credits', value: 1000 } ] } ]
            }
        ]
    },
    {
        id: 'adrift_passenger',
        title: 'Adrift Passenger',
        scenario: 'You find a spacer in a functioning escape pod. Their beacon is down, and they ask for passage to the nearest civilized port.',
        precondition: (gameState, activeShip) => activeShip.fuel >= 30,
        choices: [
            {
                title: 'Take Aboard for Payment',
                outcomes: [ { chance: 1.0, description: 'The passenger is grateful for the rescue and pays you 10,000 credits upon arrival at your destination.', effects: [ { type: 'credits', value: 10000 } ] } ]
            },
            {
                title: 'Give a Fuel Cell (30 Fuel)',
                outcomes: [
                    {
                        chance: 1.0,
                        descriptions: {
                            'reward_cybernetics': `In gratitude, the passenger gives you a crate of <span class="hl-green">40 Cybernetics</span>.`,
                            'reward_debt_paid': `Seeing your tight cargo, the passenger pays off 20% of your debt, reducing it by <span class="hl-green">{amount}</span>.`,
                            'reward_credits': `With no room and no debt, the passenger transfers you <span class="hl-green">{amount}</span>.`
                        },
                        effects: [ { type: 'ADRIFT_PASSENGER' } ]
                    }
                ]
            }
        ]
    },
    {
        id: 'meteoroid_swarm',
        title: 'Micrometeoroid Swarm',
        scenario: 'Alarms blare as you fly into an uncharted micrometeoroid swarm. Your navigation computer suggests two options to minimize damage.',
        precondition: (gameState, activeShip) => activeShip.fuel >= 15,
        choices: [
            {
                title: 'Evade Aggressively (+15 Fuel)',
                outcomes: [ { chance: 1.0, description: 'You burn extra fuel to successfully dodge the worst of the swarm, emerging unscathed.', effects: [ { type: 'fuel', value: -15 } ] } ]
            },
            {
                title: 'Brace for Impact',
                outcomes: [ { chance: 1.0, description: 'You trust your hull to withstand the impacts, taking a beating but saving fuel.', effects: [ { type: 'hull_damage_percent', value: [10, 25] } ] } ]
            }
        ]
    },
    {
        id: 'engine_malfunction',
        title: 'Engine Malfunction',
        scenario: 'A sickening shudder runs through the ship. A key plasma injector has failed, destabilizing your engine output.',
        precondition: (gameState, activeShip, getActiveInventory) => (getActiveInventory()[COMMODITY_IDS.PLASTEEL]?.quantity || 0) >= 5,
        choices: [
            {
                title: 'Quick, Risky Fix (5 Plasteel)',
                outcomes: [
                    {
                        chance: 0.50,
                        description: 'The patch holds! The engine stabilizes and you continue your journey without further incident.',
                        effects: [ { type: 'lose_cargo', value: { id: COMMODITY_IDS.PLASTEEL, quantity: 5 } } ]
                    },
                    {
                        chance: 0.50,
                        description: 'The patch fails catastrophically, causing a small explosion that deals 20% hull damage.',
                        effects: [ { type: 'lose_cargo', value: { id: COMMODITY_IDS.PLASTEEL, quantity: 5 } }, { type: 'hull_damage_percent', value: 20 } ]
                    }
                ]
            },
            {
                title: 'Limp to Destination',
                outcomes: [ { chance: 1.0, description: 'You shut down the faulty injector. The ship is slower, but stable. Your remaining travel time increases by 25%.', effects: [ { type: 'travel_time_add_percent', value: 0.25 } ] } ]
            }
        ]
    },
    {
        id: 'nav_glitch',
        title: 'Navigation Sensor Glitch',
        scenario: 'The nav-console flashes red. Your primary positioning sensors are offline, and you\'re flying blind in the deep dark.',
        precondition: () => true,
        choices: [
            {
                title: 'Attempt Hard Reboot',
                outcomes: [
                    {
                        chance: 0.50,
                        description: 'Success! The sensors come back online. In your haste, you find a shortcut, shortening your trip. You will arrive the next day.',
                        effects: [ { type: 'set_travel_time', value: 1 } ]
                    },
                    {
                        chance: 0.50,
                        description: 'The reboot corrupts your course data, sending you on a long, meandering path. This adds 15 days to your journey.',
                        effects: [ { type: 'travel_time_add', value: 15 } ]
                    }
                ]
            },
            {
                title: 'Navigate Manually',
                outcomes: [ { chance: 1.0, description: 'You rely on old-fashioned star charts. It\'s slow but safe, adding 7 days to your trip.', effects: [ { type: 'travel_time_add', value: 7 } ] } ]
            }
        ]
    },
    {
        id: 'life_support_fluctuation',
        title: 'Life Support Fluctuation',
        scenario: 'An alarm indicates unstable oxygen levels. It\'s not critical yet, but the crew is on edge and efficiency is dropping.',
        precondition: (gameState, activeShip) => activeShip.health > (activeShip.maxHealth * 0.25),
        choices: [
            {
                title: 'Salvage materials from the ship to repair the atmospheric regulators. (This will cost 25% hull damage)',
                outcomes: [ { chance: 1.0, description: 'You cannibalize some non-essential hull plating to get the regulators working again. The system stabilizes, but the ship\'s integrity is compromised.', effects: [ { type: 'hull_damage_percent', value: 25 } ] } ]
            },
            {
                title: 'Defer Maintenance Costs',
                outcomes: [ { chance: 1.0, description: 'You log the issue for later. The cost of repairs and crew hazard pay, 5,000 credits, is added to your debt.', effects: [ { type: 'add_debt', value: 5000 } ] } ]
            }
        ]
    },
    {
        id: 'cargo_rupture',
        title: 'Cargo Hold Rupture',
        scenario: 'A micrometeorite has punched a small hole in the cargo bay. One of your cargo stacks is exposed to hard vacuum.',
        precondition: (gameState, activeShip, getActiveInventory) => {
            const inventory = getActiveInventory();
            if (!inventory) return false;
            return Object.values(inventory).some(item => item.quantity > 0);
        },
        choices: [
            {
                title: 'Jettison Damaged Cargo',
                outcomes: [ { chance: 1.0, description: 'You vent the damaged section, losing 10% of a random cargo stack from your hold into the void.', effects: [ { type: 'lose_random_cargo_percent', value: 0.10 } ] } ]
            },
            {
                title: 'Attempt EVA Repair',
                outcomes: [
                    {
                        chance: 0.75,
                        description: 'The emergency patch holds! The cargo is safe, but the repair adds 2 days to your trip.',
                        effects: [ { type: 'travel_time_add', value: 2 } ]
                    },
                    {
                        chance: 0.25,
                        description: 'The patch fails to hold. Explosive decompression destroys 50% of the cargo stack, and the repair still adds 2 days to your trip.',
                        effects: [ { type: 'lose_random_cargo_percent', value: 0.50 }, { type: 'travel_time_add', value: 2 } ]
                    }
                ]
            }
        ]
    },
    {
        id: 'space_race',
        title: 'Space Race Wager',
        scenario: 'A smug-looking luxury ship pulls alongside and its captain, broadcasted on your main screen, challenges you to a "friendly" race to the destination.',
        precondition: (gameState) => gameState.player.credits > 100,
        choices: [
            {
                title: 'Accept Wager (Bet: 80% of current credits)',
                outcomes: [
                    {
                        chance: 1.0,
                        description: 'You accept the high-stakes challenge...',
                        effects: [ { type: 'SPACE_RACE', wagerPercentage: 0.80, winChance: { 'S': 0.85, 'A': 0.70, 'B': 0.55, 'C': 0.40, 'O': 0.95 } } ]
                    }
                ]
            },
            {
                title: 'Politely Decline',
                outcomes: [ { chance: 1.0, description: 'You decline the race. The luxury ship performs a flashy maneuver and speeds off, leaving you to travel in peace.', effects: [] } ]
            }
        ]
    },
    {
        id: 'supply_drop',
        title: 'Emergency Supply Drop',
        scenario: 'You intercept a system-wide emergency broadcast. A new outpost is offering a massive premium for an immediate delivery of a specific commodity that you happen to be carrying.',
        precondition: (gameState, activeShip, getActiveInventory) => {
            const inventory = getActiveInventory();
            return inventory && Object.values(inventory).some(item => item.quantity > 0);
        },
        choices: [
            {
                title: 'Divert Course to Deliver',
                outcomes: [ { chance: 1.0, description: 'You sell your entire stack of the requested commodity for 3 times its galactic average value. Your course is diverted to a new, random destination, adding 7 days to your trip.', effects: [ { type: 'sell_random_cargo_premium', value: 3 }, { type: 'travel_time_add', value: 7 }, { type: 'set_new_random_destination' } ] } ]
            },
            {
                title: 'Decline and Continue',
                outcomes: [ { chance: 1.0, description: 'You stick to your original plan and let someone else handle the emergency supply run.', effects: [] } ]
            }
        ]
    }
];
--- END OF FILE: ./js/data/events.js ---

--- START OF FILE: ./js/data/news_flavor.js ---
// js/data/news_flavor.js
/**
 * @fileoverview Defines all static flavor text messages for the news ticker.
 */

export const NEWS_FLAVOR = [
    "[MARS TODAY] Governor announces new terraforming initiative.",
    "[SOLNET] New shipyard contracts announced for the Aegis line.",
    "[COMMERCE] Plasteel futures remain steady despite Belt shortages.",
    "[GOSSIP] That captain from 'The Exchange'... seen flying a new S-Class?",
    "[SPORTS] Luna Gravel-Rats win the Zero-G Championship!",
    "[AD] Big discounts on fuel at Jupiter stations this week only!",
    "[PUBLIC] Remember: All cargo must be declared. Smuggling is a system-wide offense."
];
--- END OF FILE: ./js/data/news_flavor.js ---

--- START OF FILE: ./js/data/age_events.js ---
// js/data/age_events.js
/**
 * @fileoverview
 * Defines all static narrative "age" events triggered by game progression.
 */
import { PERK_IDS } from './constants.js';

export const AGE_EVENTS = [
    {
        id: 'captain_choice',
        trigger: { day: 366 }, // Triggers after one full year of gameplay.
        title: 'Captain Who?',
        description: "You've successfully navigated many trades and run a tight ship. Your crew depends on you... but what kind of captain will you be?",
        choices: [
            { title: 'Trademaster', description: '5% bonus on all trade profits.', perkId: PERK_IDS.TRADEMASTER, playerTitle: 'Trademaster' },
            { title: 'Navigator', description: '10% reduced fuel usage, hull decay, and travel time.', perkId: PERK_IDS.NAVIGATOR, playerTitle: 'Navigator' }
        ]
    },
    {
        id: 'friends_with_benefits',
        trigger: { credits: 50000 }, // Triggers upon reaching 50,000 credits.
        title: 'Friends with Benefits',
        description: 'An ally in need is an ally indeed.',
        choices: [
            { title: "Join the Merchant's Guild", description: 'Receive a free C-Class freighter.', perkId: PERK_IDS.MERCHANT_GUILD_SHIP },
            { title: 'Join the Venetian Syndicate', description: '75% discount on fuel and repairs at Venus.', perkId: PERK_IDS.VENETIAN_SYNDICATE }
        ]
    }
];
--- END OF FILE: ./js/data/age_events.js ---

--- START OF FILE: ./js/data/intelMessages.js ---
// js/data/intelMessages.js
/**
 * @fileoverview Defines all static intel-related messages for the news ticker.
 * Exports constants for use in NewsTickerService.
 */

// Tiered messages for Free, Present-Location Intel (Section 3.3)
export const FREE_INTEL_MESSAGES = {
    tier1: [ // 5-10% Below Avg
        "Minor price drop for {Commodity Name}.",
        "Low prices reported for {Commodity Name}.",
        "{Commodity Name} trending below average.",
        "{Commodity Name}: Favorable pricing reported.",
        "Good time to buy {Commodity Name}.",
        "It's a buyer's market for {Commodity Name}."
    ],
    tier2: [ // 11-20% Below Avg
        "{Commodity Name} prices are looking good.",
        "{Commodity Name} is on sale.",
        "Exceptional pricing available for {Commodity Name}.",
        "Act now for the best price on {Commodity Name}.",
        "Get your cheap {Commodity Name} now!",
        "{Commodity Name} is trading far below average.",
        "Get {Commodity Name} for cheap while you can.",
        "Traders are eyeing cheap {Commodity Name}.",
        "Now is the time to acquire {Commodity Name}.",
        "Capitalize on falling {Commodity Name} prices.",
        "Solid discount on {Commodity Name}."
    ],
    tier3: [ // 21-30% Below Avg
        "Don't miss out: {Commodity Name} is a bargain.",
        "Prime buying opportunity for {Commodity Name}.",
        "{Commodity Name}: Prices slashed!",
        "{Commodity Name} is a 'hot buy' right now.",
        "{Commodity Name} is a steal at this price.",
        "Significant price drop for {Commodity Name}.",
        "Traders report massive discounts on {Commodity Name}.",
        "Unbeatable deals on {Commodity Name} right now.",
        "Deep discounts on {Commodity Name}!",
        "{Commodity Name} value has dropped significantly.",
        "{Commodity Name} prices are tumbling."
    ],
    tier4: [ // 31-50% Below Avg
        "{Commodity Name} prices are nosediving.",
        "{Commodity Name} prices have plummeted!",
        "Major price correction for {Commodity Name}.",
        "Fire sale! Get your {Commodity Name} while it lasts.",
        "{Commodity Name} prices are getting crushed.",
        "{Commodity Name} is practically a giveaway."
    ],
    tier5: [ // 51%+ Below Avg
        "{Commodity Name}: Prices have never been lower.",
        "Historic lows for {Commodity Name}.",
        "{Commodity Name} prices hit rock-bottom!",
        "{Commodity Name} prices are in freefall.",
        "Price crash reported for {Commodity Name}.",
        "Market update: {Commodity Name} valuation has collapsed.",
        "{Commodity Name} is being sold for scrap prices.",
        "{Commodity Name}: Total market collapse!",
        "{Commodity Name} is virtually worthless."
    ]
};

// Messages for Purchased, Solar-System Intel (Section 3.4)
export const PURCHASED_INTEL_MESSAGES = [
    "Prime buying opportunity for {Commodity Name} at {Location Name}!",
    "{Location Name} reports massive discounts on {Commodity Name}!",
    "{Commodity Name} is a steal at {Location Name} right now!",
    "Don't miss out: {Commodity Name} is a bargain at {Location Name}!",
    "{Location Name}: Prices slashed on {Commodity Name}!",
    "Head to {Location Name} for deep discounts on {Commodity Name}!",
    "Traders flocking to {Location Name} for cheap {Commodity Name}!",
    "Significant price drops for {Commodity Name} at {Location Name}!",
    "{Location Name} is the hot spot to buy {Commodity Name}!",
    "Unbeatable deals on {Commodity Name} available at {Location Name}!",
    "{Location Name} is dumping its {Commodity Name} stock!",
    "Get to {Location Name}! {Commodity Name} prices are nosediving!",
    "{Commodity Name} prices have plummeted at {Location Name}!",
    "{Location Name} is practically giving away {Commodity Name}!",
    "Fire sale on {Commodity Name} at {Location Name}!",
    "{Commodity Name} prices are getting crushed at {Location Name}!",
    "{CommodITY Name} market is in a freefall at {Location Name}!",
    "Rumor: A major holder just dumped {Commodity Name} at {Location Name}!",
    "{Commodity Name} selling for practically nothing at {Location Name}!",
    "Price crash! {Commodity Name} is worthless at {Location Name}!",
    "The {Commodity Name} market has collapsed at {Location Name}!",
    "Historic lows for {Commodity Name} reported at {Location Name}!",
    "{Location Name}: {Commodity Name} prices have hit rock-bottom!",
    "Total market failure for {Commodity Name} at {Location Name}!",
    "{Location Name} can't get rid of its {Commodity Name}!",
    "{Commodity Name}: Prices have never been lower at {Location Name}!",
    "{Commodity Name} is being sold for scrap prices at {Location Name}!",
    "{Location Name}'s {Commodity Name} valuation has evaporated!"
];
--- END OF FILE: ./js/data/intelMessages.js ---

--- START OF FILE: ./js/data/intelContent.js ---
// js/data/intelContent.js
/**
 * @fileoverview Defines the static "sample" and "details" message pairs
 * for the Local Data Broker (Intel Market) system.
 *
 * This file uses a flat, universal object structure. All messages are
 * location-agnostic and can be applied to any deal.
 *
 * Placeholders:
 * - [location name]
 * - [commodity name]
 * - [discount amount %]
 * - [durationDays]
 * - [credit price]
 */

export const INTEL_CONTENT = {
    "CORP_FAILURE_01": {
        "sample": "We've flagged a minor subsidiary going into receivership.",
        "details": "A parent corp is cutting its losses and dissolving a failed venture that was flagged for going into receivership. They are dumping all assets to avoid Guild fees.<br><br>This has created a temporary surplus of [commodity name] at [location name] for [discount amount %] off market value.<br><br>The liquidation is scheduled to be finalized by creditors in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "CORP_FAILURE_02": {
        "sample": "A corporate partner's trade charter has just been revoked.",
        "details": "Following a trade charter revocation, the corporate state has seized a partner's assets and is holding a no-notice auction to pay their local debts.<br><br>We've secured a manifest: [commodity name] is available at [location name] for [discount amount %] below its valuation.<br><br>This is a one-time, unlisted auction ending in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "CORP_FAILURE_03": {
        "sample": "Our analysts project a high-profile bankruptcy announcement is imminent.",
        "details": "A firm our analysts flagged for imminent bankruptcy is in a death spiral and has begun a shadow liquidation to pay its key investors before the public announcement.<br><br>This means a large cache of [commodity name] is available at [location name] for [discount amount %] off.<br><br>The firm's assets will be frozen by the Guild in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "CORP_FAILURE_04": {
        "sample": "A corporate buyout we were tracking has just turned hostile.",
        "details": "A corporate buyout has turned hostile, and the losing entity is being stripped by the new owners. All non-essential inventories are being sold off immediately.<br><br>They are clearing out all [commodity name] at [location name] for [discount amount %] below market price.<br><br>This fire sale will be over once the transition is complete in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "CORP_FAILURE_05": {
        "sample": "We've confirmed a local governor has seized a corporation's assets.",
        "details": "A local governor has seized a corporation's assets and is using a legal loophole to auction all seized goods for a public works fund, and they need it done fast.<br><br>This has resulted in a surplus of [commodity name] at [location name], now available for [discount amount %] off.<br><br>This asset seizure auction will close in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "LOGISTICS_FAILURE_01": {
        "sample": "Tracking a freighter captain who just paid a massive Guild fine.",
        "details": "A freighter captain, having just paid a massive Guild fine for an improper manifest, is now selling cargo at a loss to cover port fees.<br><br>Their entire hold of [commodity name] is being sold at [location name] for [discount amount %] off.<br><br>The ship is scheduled to be released and will depart in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "LOGISTICS_FAILURE_02": {
        "sample": "We've confirmed a long-haul freighter has suffered critical damage.",
        "details": "We've confirmed a long-haul freighter is too damaged to complete its journey. The captain is dumping their entire cargo hold to pay for emergency repairs.<br><br>This has created a buyer's market for [commodity name] at [location name], with goods going for [discount amount %] off.<br><br>The repairs are estimated to be complete in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "LOGISTICS_FAILURE_03": {
        "sample": "A major port is experiencing a catastrophic logistics backlog.",
        "details": "A major port is experiencing a catastrophic logistics backlog due to a system failure, leaving dozens of ships unable to dock. Captains are panic-selling cargo at a discount.<br><br>A significant surplus of [commodity name] is available at [location name] for [discount amount %] off.<br><br>The port authority expects to have the system back online in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "LOGISTICS_FAILURE_04": {
        "sample": "A high-priority supply contract was just canceled mid-transport.",
        "details": "A high-priority supply contract was canceled mid-transport, leaving a freighter stuck with a full hold of bespoke goods and no buyer. The captain is selling the entire shipment for pennies.<br><br>Their cargo of [commodity name] is available at [location name] for [discount amount %] off.<br><br>The captain will dump the cargo as scrap if not sold in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "LOGISTICS_FAILURE_05": {
        "sample": "Pirate activity has forced a freighter miles off-route.",
        "details": "A freighter, forced miles off-route by pirate activity, survived the encounter but burned too much fuel. They are selling valuable cargo to afford the refuel.<br><br>A stock of [commodity name] is being sold at [location name] for [discount amount %] below value.<br><br>The ship will refuel and depart in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "PRODUCTION_ERROR_01": {
        "sample": "An automated factory's quarterly quota was massively miscalculated.",
        "details": "A logistical AI at an automated factory put a decimal in the wrong place, resulting in a 100x surplus. The factory is dumping it before auditors arrive.<br><br>They are quietly liquidating [commodity name] at [location name] for [discount amount %] off.<br><br>The audit is scheduled for [durationDays], at which point this deal vanishes.<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "PRODUCTION_ERROR_02": {
        "sample": "A major manufacturing line is retooling for a new-gen product.",
        "details": "A major manufacturing line is retooling for a new-gen product, and all old-generation materials are being cleared out to make room. It's all considered scrap to them.<br><br>This means all [commodity name] stock is available at [location name] for [discount amount %] off.<br><br>The retooling will be complete in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "PRODUCTION_ERROR_03": {
        "sample": "A recent batch of high-spec goods failed its final QA check.",
        "details": "A shipment of high-spec goods failed its 99.9% purity standard. The corporation is selling this sub-par but still excellent stock at a loss.<br><br>This entire batch of [commodity name] is available at [location name] for [discount amount %] off.<br><br>The shipment will be disposed of if not sold in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "PRODUCTION_ERROR_04": {
        "sample": "We're tracking an industrial AI experiencing... anomalies.",
        "details": "An industrial AI has been experiencing anomalies, ordering triple the required raw materials for weeks, and the local warehouse is now overflowing.<br><br>They are selling excess [commodity name] at [location name] for [discount amount %] off to clear space.<br><br>A diagnostic and reset is scheduled for [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "PRODUCTION_ERROR_05": {
        "sample": "A new, experimental production line has... unexpected byproducts.",
        "details": "A test run of a new, experimental manufacturing process has, ironically, created a massive surplus of a key component. The R&D lab is selling it off-book.<br><br>This surplus of [commodity name] is available at [location name] for [discount amount %] off.<br><br>The test run concludes and the line is shut down in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "REGULATORY_ERROR_01": {
        "sample": "A new interstellar tariff is being announced in 48 hours.",
        "details": "We've seen the memo for a new interstellar tariff being announced in 48 hours. Suppliers are desperately dumping all pre-tariff stock to avoid the new, massive tax.<br><br>This panic-sell means [commodity name] is available at [location name] for [discount amount %] off.<br><br>This regulatory loophole will snap shut in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "REGULATORY_ERROR_02": {
        "sample": "A Guild auditor just made a surprise visit to a local port.",
        "details": "A Guild auditor's surprise visit has a local port authority in a panic. They are auctioning all unclaimed and improperly manifested cargo immediately. No questions asked.<br><br>A large lot of [commodity name] is available at [location name] for [discount amount %] off.<br><br>The audit will be complete and the auction closed in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "REGULATORY_ERROR_03": {
        "sample": "We've flagged a shipment seized for manifest violations.",
        "details": "A shipment was seized for manifest violations, declared contraband on a technicality. The local authorities are now selling it at a disposal auction.<br><br>This seized shipment of [commodity name] is available at [location name] for [discount amount %] off.<br><br>The auction is unlisted and ends in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "REGULATORY_ERROR_04": {
        "sample": "A local trade license has been unexpectedly revoked.",
        "details": "A company's local trade license has been unexpectedly revoked, barring them from trading. Their entire inventory is being sold off by Guild-appointed receivers.<br><br>This has created a one-time surplus of [commodity name] at [location name], available for [discount amount %] off.<br><br>The receivers' sale will end in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "REGULATORY_ERROR_05": {
        "sample": "A health inspector has quarantined a station's cargo bay.",
        "details": "A (likely faked) health scare from an inspector has forced the liquidation of all perishable goods in a quarantined cargo bay. The corporation is writing it off as a total loss.<br><br>This means all [commodity name] in the bay is being sold at [location name] for [discount amount %] off.<br><br>The bay will be 'sterilized' and the remaining stock destroyed in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "INSIDER_INTEL_01": {
        "sample": "A high-level corporate executive is about to be retired.",
        "details": "A high-level corporate exec knows they are being forced out and is panic-selling all their personal and corporate assets before they are frozen.<br><br>This includes a private stash of [commodity name], available at [location name] for [discount amount %] off.<br><br>The exec's accounts will be seized in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "INSIDER_INTEL_02": {
        "sample": "We've identified a shell corporation that is being dissolved.",
        "details": "A shell corporation we identified as a smuggling front is being dissolved. Its 'legitimate' assets are being rapidly absorbed into the public market.<br><br>This has created a shadow surplus of [commodity name] at [location name] for [discount amount %] off.<br><br>The assets will be fully liquidated in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "INSIDER_INTEL_03": {
        "sample": "A rival corporation is initiating a hostile price war.",
        "details": "A rival corporation is intentionally flooding the market to bankrupt a competitor. This has temporarily, and artificially, crashed the price.<br><br>This means [commodity name] is available at [location name] for [discount amount %] below its actual value.<br><br>We project the smaller firm will fold and prices will stabilize in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "INSIDER_INTEL_04": {
        "sample": "We have a tip from a disgruntled corporate officer.",
        "details": "A disgruntled corporate officer is about to blow the whistle on a major product line failure and is dumping their personal stock before the news breaks.<br><br>This fire sale on [commodity name] is happening at [location name] for [discount amount %] off.<br><br>The announcement is expected in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "INSIDER_INTEL_05": {
        "sample": "An info-broker is dumping physical assets for liquid credits.",
        "details": "A rival info-broker is restructuring and needs cash, fast. They are selling their entire non-data inventory at a loss.<br><br>Their holdings of [commodity name] are available at [location name] for [discount amount %] off.<br><br>This is a one-time offer, ending in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "DEMAND_SPIKE_01": {
        "sample": "A critical supply freighter has just been declared lost with all hands.",
        "details": "A critical supply freighter has been declared lost with all hands, creating a system-wide shortage of a key material. Buyers are paying a massive premium.<br><br>The market for [commodity name] at [location name] is buying at [discount amount %] over galactic average.<br><br>This bubble will pop when replacement shipments arrive in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "DEMAND_SPIKE_02": {
        "sample": "A major factory just suffered a catastrophic failure.",
        "details": "A major factory just suffered a catastrophic failure. As the system's primary supplier of a key component, the supply chain has collapsed.<br><br>Demand for [commodity name] at [location name] has skyrocketed, with prices at [discount amount %] above normal.<br><br>This shortage is expected to last [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "DEMAND_SPIKE_03": {
        "sample": "We've intercepted a project's emergency supply request.",
        "details": "We've intercepted an emergency supply request from a major terraforming project that has a massive, miscalculated shortfall. They are paying any price.<br><br>They are buying [commodity name] at [location name] for [discount amount %] over market value.<br><br>Their emergency charter is expected to be filled in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "DEMAND_SPIKE_04": {
        "sample": "A local warehouse was just breached by... something.",
        "details": "The entire local stock of a commodity was destroyed after a warehouse breach. This has created a sudden, desperate demand from local industries.<br><br>The local market for [commodity name] at [location name] is paying [discount amount %] above average.<br><br>This localized shortage will be resolved in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    },
    "DEMAND_SPIKE_05": {
        "sample": "A new, unexpected corporate construction charter was just approved.",
        "details": "A new, unexpected corporate construction charter was just approved. The corporation is rushing to build and is paying a premium to bypass normal supply channels.<br><br>Their project managers are buying [commodity name] at [location name] for [discount amount %] above the average price.<br><br>This buy-order will be filled in [durationDays].<br><br>You paid <span class=\"credits-text-pulsing\">⌬ [credit price]</span> for this intel."
    }
};
--- END OF FILE: ./js/data/intelContent.js ---

--- START OF FILE: ./js/data/ship_database.js ---
// js/data/ship_database.js
/**
 * @fileoverview This file contains the new, centralized ship database.
 * It merges the static data from the "Ship List" and "Ship Lore" spreadsheets
 * into a single, authoritative source.
 */

import { LOCATION_IDS } from './constants.js';

// Helper map to convert spreadsheet location names to LOCATION_IDS enums
const locationMap = {
    "Starter": null,
    "Mission (TBD)": null,
    "Moon": LOCATION_IDS.LUNA,
    "Earth": LOCATION_IDS.EARTH,
    "Mars": LOCATION_IDS.MARS,
    "Venus": LOCATION_IDS.VENUS,
    "Neptune": LOCATION_IDS.NEPTUNE,
    "Jupiter": LOCATION_IDS.JUPITER,
    "The Belt": LOCATION_IDS.BELT,
    "Pluto": LOCATION_IDS.PLUTO,
    "Saturn": LOCATION_IDS.SATURN,
    "Uranus": LOCATION_IDS.URANUS,
    "Kepler's Eye": LOCATION_IDS.KEPLER,
    "The Exchange": LOCATION_IDS.EXCHANGE,
};

/**
 * @typedef {object} ShipData
 * @property {string} name - The display name of the ship.
 * @property {string} class - The ship's class (e.g., 'C', 'B', 'A', 'S', 'O', 'Z', 'F').
 * @property {number} price - The purchase cost of the ship in credits.
 * @property {number} maxHealth - The maximum hull integrity.
 * @property {number} cargoCapacity - The maximum cargo space.
 * @property {number} maxFuel - The maximum fuel capacity.
 * @property {string} role - The ship's designated type (e.g., 'Explorer', 'Hauler').
 * @property {string} attribute - A special passive bonus or trait, or "None".
 * @property {string} description - The short, in-game card flavor text.
 * @property {string} lore - The long-form detailed lore for the ship.
 * @property {string|null} saleLocationId - The LOCATION_ID where this ship is sold, or null.
 * @property {number} spawnChance - The chance for this ship to appear in the shipyard (0-1).
 * @property {string} spawnTrigger - The condition for this ship to appear (e.g., "Tier 3 Unlock").
 * @property {boolean} isRare - (Auto-generated) True if spawn chance is < 1.
 */

/**
 * @const {Object<string, ShipData>} SHIP_DATABASE
 * @description The new single source of truth for all static ship data.
 * The key for each entry is the "GAME ID" (e.g., "Wanderer.Ship").
 */
export const SHIP_DATABASE = {
    "Wanderer.Ship": {
        name: "Wanderer",
        class: "C",
        price: 25000,
        maxHealth: 30,
        cargoCapacity: 30,
        maxFuel: 130,
        role: "Explorer",
        attribute: "None",
        description: "Its oversized fuel tank betrays its past as a survey ship, built for pilots who value the range over all else. ",
        lore: `The Wanderer is a vessel born from the fine print of a corporate bankruptcy. Its chassis belongs to the ""Surveyor's Friend"" line, a failed venture by a minor Martian corp that attempted to build a cheap, long-range scout for freelance prospectors. The venture folded, and its assets were snapped up by the Merchant's Guild, not for their quality, but for their utility in backing the loans of new, desperate captains. This ship was never celebrated; it was simply requisitioned, its manufacturing plate filed clean and its identifiers reassigned.

Its history is a patchwork of incomplete journeys. The original owner used it to map unlisted asteroid clusters in the Belt before defaulting on a fuel payment. It was then briefly captained by a paranoid journalist tracking rumors of Venetian Syndicate activity, who abandoned it on Luna after a close call, wiping the nav logs clean. Its call-sign, ""Wanderer,"" isn't a factory name but a nickname given by Guild dockworkers, who noted it never seemed to keep an owner for long.

It's low cargo and thin hull are secondary to its one redeeming feature: a surprisingly robust fuel tank, a remnant of its original survey design.

Inside, the ship is spartan. The cockpit is functional, designed for observation. The single bunk is a fold-down shelf.

The air recyclers hum a half-step flat. It smells of sterilized plastic and the faint, metallic tang of ozone.

The Wanderer is the quintessential first step into the void. It’s not a ship that promises riches or glory; it's a ship that promises distance. It was built to see what's over the horizon, and for a new captain, that is the only promise that matters.

It is the very definition of freedom: a hull, an engine, and just enough range to disappear.`,
        saleLocationId: locationMap["Starter"],
        spawnChance: 1,
        spawnTrigger: "New game only",
        isRare: false
    },
    "Stalwart.Ship": {
        name: "Stalwart",
        class: "C",
        price: 25000,
        maxHealth: 70,
        cargoCapacity: 45,
        maxFuel: 90,
        role: "Balanced",
        attribute: "None",
        description: "It lacks the range of an explorer, but its reinforced hull promises a steady hand through the system's most turbulent trade routes.",
        lore: `The Stalwart is a product of the Earth-Luna supply chain, a pure workhorse built by a subsidiary of the Terran Alliance.
Its design was never meant to be revolutionary; it was meant to be reliable.
During the Helium Rush, hundreds of these vessels were commissioned as high-priority couriers, running critical components, data cores, and personnel between Earth's orbital factories and the chaotic lunar mining settlements.
They were designed to be tough, capable of handling rapid docking, automated loading, and the occasional debris collision.
This particular hull has a long service record. It was originally part of the corporate fleet for ""Astra-Logistics,"" a mid-level corporation that was eventually squeezed out of the helium trade.
The ship's logs, if you could access the encrypted archives, would show thousands of routine, completed trips.
It has never seen the outer system, never engaged in combat, and never failed to reach its destination.
It is the definition of ""stalwart"": loyal, dependable, and thoroughly unexciting.
The Merchant's Guild acquired this ship, like so many others, during a corporate liquidation.
Its value is not in its potential, but in its proven track record.
Its balanced stats—a tough hull, a respectable cargo bay, and adequate fuel—make it a low-risk asset.
It is the sensible choice, a floating pickup truck for the practical-minded trader.

The ship's interior is worn but clean.
The bulkhead panels are scratched from years of cargo shifting, and the pilot's chair is permanently molded to a shape that isn't yours.
The ship's systems are simple, robust, and easily repaired. There are no luxuries, only redundancies.
Its most prominent feature is its reinforced hull plating, which makes the entire vessel feel solid and secure, a small piece of Earth's reliability in the void.
The Stalwart is a tool for building a business. It’s not a vessel for exploration or high-stakes gambles;
it’s for the captain who intends to navigate the razor's edge of commerce by being smarter, tougher, and more dependable than the competition.
It’s a ship that promises to show up, do the work, and survive to do it again tomorrow.`,
        saleLocationId: locationMap["Starter"],
        spawnChance: 1,
        spawnTrigger: "New game only",
        isRare: false
    },
    "Mule.Ship": {
        name: "Mule",
        class: "C",
        price: 25000,
        maxHealth: 45,
        cargoCapacity: 70,
        maxFuel: 70,
        role: "Hauler",
        attribute: "None",
        description: "Little more than a cockpit bolted to a high-capacity cargo container, this ship was designed for slow but profitable journeys between orbital stations, one ton at a time.",
        lore: `The Mule is less a starship and more a cargo container with an engine and a cockpit welded to the side as an afterthought.
It is a product of the Drive-Divide, a ship built for those who have no choice but to use the cheapest hardware available.
Its design was mass-produced in the orbital yards of Mars, intended for ""last-mile"" hauling—moving raw, unprocessed ore from massive deep-space freighters to the planetary surface or between nearby stations.
Its history is one of heavy loads and short tempers.
The ""Mule"" line is notorious among pilots for being loud, uncomfortable, and slow.
Its low-grade engine vibrates through the entire hull, and its fuel capacity is barely enough to get from a high-orbit anchor to a docking bay and back.
Its only purpose, its only virtue, is the cavernous, un-shielded cargo bay that makes up over 80% of its mass.
This ship was likely repossessed by the Merchant's Guild after its previous owner, a small-time scrap hauler, was crushed by the manipulated market prices of the Venetian Syndicate.
The ship sat in a Guild impound lot, its only value being the raw tonnage it could move.
It is the perfect, high-risk, high-reward asset for a captain who is willing to sacrifice everything—comfort, safety, and speed—to maximize their manifests.
The cockpit is a cramped metal box that smells of ozone, artificial lubricant, and stale coffee.
The hull is thin, and every micrometeorite impact sounds like a gunshot.
The ship shudders violently when the main drive engages. It is a vessel that constantly reminds its pilot that the void is waiting just outside a few inches of cheap alloy.
This is the ship for the pure trader. You don't buy a Mule to see the system or to outrun pirates.
You buy it for the cold, hard calculus of its cargo hold.
It is a bet that you can fill it, sell its contents, and earn your way into a better ship before its numerous flaws finally catch up with you.`,
        saleLocationId: locationMap["Starter"],
        spawnChance: 1,
        spawnTrigger: "New game only",
        isRare: false
    },
    "Nomad.Ship": {
        name: "Nomad",
        class: "C",
        price: 40000,
        maxHealth: 40,
        cargoCapacity: 35,
        maxFuel: 150,
        role: "Explorer",
        attribute: "None",
        description: "Its lightweight frame and oversized fuel cells were designed for a single purpose: to keep moving, making it ideal for captains who rarely sleep in the same port twice.",
        lore: `The Nomad, born from the Helium Rush, is a direct response to the chaos and opportunity of Luna's new economy.
While large corporations focused on mass extraction, a gap emerged for independent prospectors - pilots who could scout new deposits, verify claims, or disappear into the Belt for months at a time.
A small Luna-based shipyard, ""Cis-Lunar Dynamics,"" created the Nomad to fill this niche.
It was one of an endless series of ships that tried to thread the needle of space classism, offering one high-performance feature on an otherwise cheap hull.
In this case, the feature was autonomy. The Nomad boasts a fuel capacity that rivals ships twice its size, achieved by sacrificing almost all crew comforts and cargo space.
It is a ship designed to go far, if not fast or comfortably.
The ship's early models were popular with claim-jumpers and independent surveyors.
They were small enough to avoid appearing as a threat on sensors but had the range to ""go dark"" and operate far from the main shipping lanes.
The name became synonymous with pilots who lived on the fringes, trusting no one but themselves and the reliability of their long-range fuel tanks.
This particular Nomad has likely been hot-swapped multiple times in back-alley docks.
Its transponder codes are clean, but its engine housing has tool marks that suggest hasty, non-standard modifications.
The light hull and modest cargo bay make it an excellent choice for an explorer, a courier, or someone who needs to be somewhere they aren't supposed to be.`,
        saleLocationId: locationMap["Moon"],
        spawnChance: 0.4,
        spawnTrigger: "Always available",
        isRare: true
    },
    "Rooster.Ship": {
        name: "Rooster",
        class: "C",
        price: 42000,
        maxHealth: 100,
        cargoCapacity: 65,
        maxFuel: 110,
        role: "Balanced",
        attribute: "None",
        description: "A solid, assertive design from Earth's dominant shipyards, the Rooster is for the captain who wants a ship that can take a hit, carry a decent load, and still look good doing it.",
        lore: `The Rooster is a pure-bred Terran Alliance design, a ship that exudes the confidence of Earth's clean and advanced manufacturing.
It was not built for the rough-and-tumble life of a freelancer;
it was designed as a high-speed executive shuttle and priority courier for the inner system.
Its purpose was to move high-value personnel and proprietary technology between Earth, Luna, and the orbital stations of the Venus.
The ship's aggressive, forward-swept design and high-performance engine profile earned it the nickname ""Rooster"" among orbital traffic controllers.
It was known for crowing its priority codes, demanding immediate docking clearance as it darted through commercial traffic.
Its solid hull and balanced systems were a mark of its quality, built to protect its valuable cargo and passengers at all costs.
As a balanced ship, it's a master of none but a jack-of-all-trades.
It has enough speed to be interesting, enough armor to be reassuring, and a cargo bay large enough for specialized, high-profit goods.
It's a ship for a captain who wants to maintain a low-level of corporate-style professionalism.
This hull was likely part of a corporate fleet that was cycled out after only a few years of service to make way for a newer model.
On Earth, technology iterates quickly, and yesterday's luxury transport is today's surplus.
It was sold on the open market, its new ship smell barely faded, representing a significant step up for any independent captain.
Owning a Rooster is a sign that a pilot has moved beyond simple survival.
It’s a ship that implies a certain level of success and discretion.
It’s fast, reliable, and just stylish enough to get you noticed by the kinds of clients who pay well for a captain who looks the part.`,
        saleLocationId: locationMap["Earth"],
        spawnChance: 0.4,
        spawnTrigger: "Always available",
        isRare: true
    },
    "Mesa.Ship": {
        name: "Mesa",
        class: "C",
        price: 44000,
        maxHealth: 50,
        cargoCapacity: 100,
        maxFuel: 70,
        role: "Hauler",
        attribute: "None",
        description: "A classic Martian-built freighter, it is essentially a flying warehouse designed to move bulk goods between the surface and orbital transfer stations.",
        lore: `The Mesa is a Martian workhorse, as blunt and functional as the corporate nation-state that built it.
Following the Martian Breakthrough, the new-found independent colony needed its own logistical backbone.
The Mesa was the answer: a mass-produced, low-cost, high-capacity hauler designed to move bulk materials around the red planet's orbit.
It is named for the flat, wide, and unglamorous geological formations that dot its homeworld.
This ship was built for one job: to move as much mass as possible from Point A to Point B, assuming both points were within the same gravity well.
Its low fuel tank and mediocre hull were cost-saving measures, as it was assumed these ships would always operate under the protection of Martian corporate security, running goods from orbital foundries to interplanetary transfer stations.
The design is utilitarian to a fault. The cockpit is a reinforced box with a viewport.
The engine is the cheapest model that could reliably push its maximum cargo load.
The ship's entire philosophy is built around its cavernous, easily-accessible cargo bay.
It is the very definition of a cog in the great machine of commerce.
These vessels are now common on the Martian second-hand market.
As the larger corporations upgrade to more efficient haulers, the older Mesas are sold off to independent captains and smaller outfits.
They are a common first ""pure hauler"" for traders looking to capitalize on the high-volume needs of the Martian industrial machine.
To pilot a Mesa is to embrace a life of pure profit-driven logistics.
It’s a slow, lumbering beast that handles like a brick, but its ability to haul cargo makes it one of the most profitable ships in its class.
It is a tool for the captain who studies manifests, not star charts.`,
        saleLocationId: locationMap["Mars"],
        spawnChance: 0.4,
        spawnTrigger: "Always available",
        isRare: true
    },
    "Pathfinder.Ship": {
        name: "Pathfinder",
        class: "B",
        price: 145000,
        maxHealth: 40,
        cargoCapacity: 50,
        maxFuel: 260,
        role: "Explorer",
        attribute: "None",
        description: "Commissioned in the private yards of Venus, this ship was built for quiet observation and rapid departure, favoring a cold-running engine over a thick hull.",
        lore: `The Pathfinder is a ship with a shrouded past, intrinsically linked to the opulent and clandestine circles of its home port.
It was not built by a major corporation but was commissioned by a private equity group operating from Venus—a known front for the Venetian Syndicate.
Its design purpose was not exploration in the scientific sense, but surveillance.
It was created to be a high-end ghost for the Syndicate's intelligence networks.
The ship's true value lies in its advanced, non-standard sensor suite and its high-efficiency drive, which runs colder than most military vessels, making it difficult to track.
Its high fuel capacity allows it to sit ""dark"" in a distant orbit for weeks, monitoring comms traffic or tracking the movement of a rival's cargo.
The modest cargo bay was designed not for commodities, but for transporting compromising data, high-value assets, or a single, well-paid infiltrator.
The Pathfinder line is rarely seen on the open market.
When one does appear, it's usually because its previous owner met an unfortunate end or needed to disappear, liquidating their assets through a discreet broker.
The ship has been scrubbed of its most illicit hardware, but its core strengths remain.
Its light hull is a liability, but the ship was never intended to be in harm's way.
Purchasing a Pathfinder is a significant investment. Captains who buy them are often those who understand that in the cold war fought with cargo manifests, information is the most valuable commodity.
It’s a ship for a pilot who prefers to know the location of the next deal before they ever engage the drive.`,
        saleLocationId: locationMap["Venus"],
        spawnChance: 0.3,
        spawnTrigger: "Tier 3 Unlock",
        isRare: true
    },
    "Odyssey.Ship": {
        name: "Odyssey",
        class: "B",
        price: 150000,
        maxHealth: 120,
        cargoCapacity: 110,
        maxFuel: 120,
        role: "Balanced",
        attribute: "None",
        description: "More fortress than freighter, this is a rugged, dependable vessel for the captain who expects trouble and intends to survive it.",
        lore: `The Odyssey is a direct descendant of the ships that defined the Helium Rush.
As Luna's economy boomed, the need arose for a vessel that could do more than just haul or scout;
a ship was needed to protect the new trade lanes, move valuable assets securely, and ferry executives between Earth and the increasingly wealthy lunar settlements.
The Odyssey was the answer: a high-end, balanced ship with an emphasis on durability.
Its most defining feature is its hull, which is massively over-spec'd for a ship of its size.
This toughness made it a favorite among private security contractors and Guild-sanctioned convoy leaders.
It was a ship that could take a hit—or several—and keep its cargo and crew intact.
Its name, ""Odyssey,"" was a marketing ploy, suggesting a vessel capable of surviving a long, perilous, and ultimately heroic journey.
The ship is a status symbol on the Moon. While a C-class ship gets you into the trade, an Odyssey proves you're successful enough to afford protection and professional enough to be taken seriously.
Its balanced profile makes it a true all-rounder, capable of hauling a respectable load, exploring a new route, or running a high-risk delivery.
This particular craft has been well-maintained, its armor patched and its engine serviced regularly.
The interior is professional and clean, with a small but secure brig and a dedicated, shielded strongbox for high-value goods, betraying its past in corporate security.
This is a ship for the captain who has graduated from desperation to ambition, a solid, reliable, and powerful tool for taking on more dangerous and lucrative contracts across the system.`,
        saleLocationId: locationMap["Moon"],
        spawnChance: 0.3,
        spawnTrigger: "Tier 3 Unlock",
        isRare: true
    },
    "Pilgrim.Ship": {
        name: "Pilgrim",
        class: "B",
        price: 150000,
        maxHealth: 60,
        cargoCapacity: 175,
        maxFuel: 90,
        role: "Hauler",
        attribute: "None",
        description: "A specialized ice-hauler, this ship sacrifices armor and speed for a massive, reinforced cargo bay, making it a pure-profit engine for the patient trader.",
        lore: `The Pilgrim is a ship built for the lonely, far-flung edges of the system.
Manufactured in the cold, automated shipyards of Neptune's moons, it was designed for a single purpose: to service the fledgling outposts, ice-mining operations, and deep-space observatories of the outer planets.
Its namesake is a term for the contract-haulers who made the pilgrimage from the inner system, a journey that could take months.
This ship is the very definition of a long-haul freighter. Its design philosophy is simple: maximize cargo at all costs.
To achieve this, its designers made deep cuts to its fuel capacity and hull assuming that the vast emptiness of the outer system was its own defense.
Pilgrims are not fast, nor are they tough; they are simply large.
The ship's interior is minimal but built for long-duration trips.
The life support system is oversized and heavily redundant, and the small crew cabin features a robust nutrient synthesizer and water recycler.
Pilots of these ships are known for their patience and meticulous planning, as running out of fuel this far out is a death sentence.
Finding one for sale on Neptune is common, as they are the backbone of the local economy.
They are often sold by captains who have either made their fortune and are retiring, or by the estates of those who miscalculated a fuel burn and never returned.
It's a ship that represents a massive gamble on the cold, impartial logic of the manifest.
To captain a Pilgrim is to commit to a life of high-stakes logistics.
It’s a specialized tool for the trader who intends to profit from the system's most distant and demanding routes, where the only things that matter are the cargo capacity and the long, silent countdown to arrival.`,
        saleLocationId: locationMap["Neptune"],
        spawnChance: 0.3,
        spawnTrigger: "Tier 3 Unlock",
        isRare: true
    },
    "Meridian.Ship": {
        name: "Meridian",
        class: "B",
        price: 155000,
        maxHealth: 100,
        cargoCapacity: 70,
        maxFuel: 230,
        role: "Explorer",
        attribute: "None",
        description: "With a massive fuel reserve and a robust sensor array, the Meridian is a self-sufficient explorer, capable of operating for months in the uncharted deep.",
        lore: `The Meridian is a product of Jupiter's massive, corporate-run industrial machine.
It was designed as a high-endurance survey and exploration vessel for the Jovian Mining Consortium, a powerful corporate state that is constantly seeking to expand its resource claims.
The name ""Meridian"" refers to its purpose: to chart new boundaries and map the vast, resource-rich, and dangerous territory of Jupiter's moons.
This ship is a direct answer to the Pathfinder. Where the Pathfinder is a light, stealthy spy, the Meridian is a robust, self-sufficient, corporate-backed explorer.
Its impressive fuel tank allows for long-duration missions without refueling, and its robust hull and cargo bay mean it can withstand punishment, conduct its own mining surveys, and bring back valuable samples.
The Meridian is a symbol of corporate reach. Its engines are powerful, its sensors are top-of-the-line, and its hull is stamped with the mark of Jupiter's finest shipyards.
These ships are often the first to enter a new asteroid field or a previously uncharted gas cloud, their logs filled with proprietary survey data worth a fortune.
This vessel was likely sold on the open market after being retired from a corporate fleet, not because of a flaw, but because it had been superseded by a newer model.
Its service history is classified, but its performance is undeniable.
It's a ship for a captain who wants to take on serious, high-paying contracts.
Owning a Meridian signifies that a pilot has crossed the line from freelancer to professional.
It's a serious ship for serious work, capable of opening up new routes and discovering the resources that fuel the entire system-wide technological dependency.`,
        saleLocationId: locationMap["Jupiter"],
        spawnChance: 0.3,
        spawnTrigger: "Tier 3 Unlock",
        isRare: true
    },
    "Raven.Ship": {
        name: "Raven",
        class: "B",
        price: 160000,
        maxHealth: 210,
        cargoCapacity: 80,
        maxFuel: 110,
        role: "Balanced",
        attribute: "None",
        description: "A common sight in the lawless asteroid fields, this ship is a tough-as-nails workhorse for the captain who values armor above all else.",
        lore: `The Raven is a ship born of necessity in the lawless expanse of the Asteroid Belt.
It is not a product of a single, polished shipyard, but a popular, rugged design built by a dozen different independent fabricators within the Asteroid Belt.
Its design is a direct response to the region's primary dangers: catastrophic debris impacts.
The ship's most notable feature is its armor. With an impressive hull rating, it is one of the toughest ships in its class.
Its name comes from its appearance: the thick, dark, non-reflective armor plating, often patched and re-welded, gives it the look of a dark, menacing bird.
Ravens are the preferred ships of Belt-based security patrols and traders who have to haul valuable, unrefined ore.
Its fuel and cargo capacity are substantial, making it a truly independent operator.
This particular ship is a typical Belter vessel. The hull is a patchwork of different plate dented by micrometeorites.
The interior is purely functional with little crew comforts. The air smells of recycled oxygen and the faint, coppery tang of spent energy cells.
Buying a Raven in The Belt is an admission that you are operating in a place where law is a distant concept.
It's a ship for the captain who has embraced danger and decided that the best defense is a hull that simply refuses to break.`,
        saleLocationId: locationMap["The Belt"],
        spawnChance: 0.3,
        spawnTrigger: "Tier 3 Unlock",
        isRare: true
    },
    "Warden.Ship": {
        name: "Warden",
        class: "B",
        price: 165000,
        maxHealth: 70,
        cargoCapacity: 160,
        maxFuel: 160,
        role: "Hauler",
        attribute: "None",
        description: "Built in the subterranean yards of Pluto, this ship's specialty is the extreme long-haul, where reliability and cargo size are the only stats that matter.",
        lore: `The Warden is a ship built for the most extreme logistics in the solar system.
Typically operating from Pluto, a cold, dark, and unimaginably distant port, this vessel was designed to be a keeper of cargo on the longest, loneliest routes imaginable.
It is a hauler that borders on being a light capital ship, a warden against the three great threats of the deep void: time, distance, and decay.
Its primary feature is its enormous cargo capacity, a hold designed to make the multi-month trips from the Kuiper Belt profitable.
Unlike the Pilgrim, which is a bulk hauler, the Warden has a more balanced design.
Its solid hull and decent fuel tank make it more self-sufficient, capable of surviving a long, dark journey where rescue is impossible.
These ships are manufactured in the deep, pressurized shipyards beneath Pluto's surface.
They are built to be utterly reliable as any major failure this far out is fatal.
The Warden's captains are a unique breed, part-trader, part-hermit, who sign on for journeys that can last the better part of a year.
The ship itself is slow and ponderous, its movements dictated by the cold calculus of orbital mechanics and fuel conservation.
The interior is spacious, like a small habitat rather than a cockpit.
Its systems are designed for minimal power draw, and its engine is a low-temperature, high-efficiency model that can run for years without maintenance.
A Warden for sale on Pluto is a rare and serious purchase.
It is the key to some of the system's most dangerous and most profitable long-haul routes.
It is a ship for the captain who has transcended the cold trade wars of the inner system and chosen to do business with the unforgiving void itself.`,
        saleLocationId: locationMap["Pluto"],
        spawnChance: 0.3,
        spawnTrigger: "Tier 3 Unlock",
        isRare: true
    },
    "Aegis.Ship": {
        name: "Aegis",
        class: "A",
        price: 590000,
        maxHealth: 200,
        cargoCapacity: 100,
        maxFuel: 300,
        role: "Explorer",
        attribute: "None",
        description: "This vessel's massive fuel reserves and fortified engineering deck are a masterpiece of Martian design, intended for captains who plan to be the first to arrive and the last to leave.",
        lore: `The Aegis is the pinnacle of Martian corporate engineering, a vessel designed not just to explore, but to dominate an exploration sector.
It is the flagship of the ""Aegis"" line, a project born from the Martian state's desire to achieve technological independence from Earth .
The ship represents a massive investment, a clear signal that Mars is no longer just a colony, but a system power in its own right.
Its name, ""Aegis,"" means ""shield,"" and it was designed to be the shield of Martian interests—a self-sufficient, long-range expeditionary vessel.
Its design philosophy is one of overwhelming endurance. A massive fuel capacity is paired with a robust hull, allowing it to operate independently for extreme durations in dangerous, uncharted territory.
This is not a ship for casual scouting; it is a ship for high-stakes missions.
Its advanced sensor suites are rumored to be capable of detecting high-performance folded-space drive activations at extreme range, a direct counter to the Venetian Syndicate's stealth vessels.
The cargo bay is not intended for bulk trade, but for hauling modular equipment, scientific labs, or high-yield resource samples.
This vessel's appearance on the Martian open market is an extremely rare event.
It is likely a surplus model from a previous procurement contract, sold to a highly-vetted buyer to recoup costs.
Its systems are top-tier, and its engine is a masterpiece of Martian efficiency. The interior is military-grade but spacious.
To acquire an Aegis is to purchase a piece of corporate-military hardware.
It is a ship that tells the system you are no longer just a trader;
you are a serious operator, capable of undertaking the most demanding, long-term contracts that the Merchant's Guild or a corporate state can offer.`,
        saleLocationId: locationMap["Mars"],
        spawnChance: 0.2,
        spawnTrigger: "Tier 4 Unlock",
        isRare: true
    },
    "Forerunner.Ship": {
        name: "Forerunner",
        class: "A",
        price: 600000,
        maxHealth: 290,
        cargoCapacity: 160,
        maxFuel: 150,
        role: "Balanced",
        attribute: "None",
        description: "A fortress of composite plate and reinforced steel, its design is a brutalist statement on survival in the system's most lawless territory.",
        lore: `The Forerunner is a legend of the Belt, a ship that has earned a reputation for being the toughest, meanest, and most survivable vessel outside of a capital ship.
It is not the product of a clean corporate shipyard;
it is an up-armored brawler, a design that has been iterated upon in the independent, often illicit, fabrication bays of the asteroid fields.
Its origin is a direct response to the cold trade war of commerce.
The Forerunner's stats tell a story of brutal priorities. Its hull is its most prominent feature, a massive layer of ablative and composite armor designed to withstand excessive punishment.
This protection is balanced with a powerful engine and a large cargo bay, creating a ship that can run a high-value, high-risk routes for months without maintenance.
Its name, ""Forerunner,"" is a title of respect given by Belter miners.
A Forerunner is often the first ship into a hot new asteroid claim before the area is scrubbed of minor debris.
It is the chosen vessel of convoy leaders, Guild enforcers, and the most successful traders in the outer system.
This particular ship is scarred from bow to stern. Its armor is a patchwork of replacements and its transponder has been erased more than once.
The interior is cramped, sacrificing crew comfort for storage and reinforced bulkheads.
To buy a Forerunner is to buy a reputation. It is a ship that sends a clear message in every port it visits: Do not interfere.
It is the ultimate tool for the captain who must navigate the most dangerous trade lanes and is willing to brute force their way through any asteroid field to ensure their cargo—and their life—reaches its destination.`,
        saleLocationId: locationMap["The Belt"],
        spawnChance: 0.2,
        spawnTrigger: "Tier 4 Unlock",
        isRare: true
    },
    "Guardian.Ship": {
        name: "Guardian",
        class: "A",
        price: 590000,
        maxHealth: 130,
        cargoCapacity: 230,
        maxFuel: 165,
        role: "Hauler",
        attribute: "None",
        description: "The pride of Saturn's merchant fleet, this \"\"merchant cruiser\"\" was designed to haul and protect vast fortunes of refined ring-ice and exotic gases.",
        lore: `The Guardian is the pride of Saturn's ring-cities, a merchant cruiser that represents the pinnacle of defensible commerce.
Manufactured in the zero-G shipyards of Titan, it was designed for the powerful merchant houses of the Saturn system, who needed to move vast quantities of high-value goods (like refined Helium-3 or exotic atmospheric compounds) over long, exposed routes.
It is a hauler that redefines the term, blending capacity with fortitude.
Its design is a direct rejection of the cheap hauler philosophy.
The Guardian boasts a colossal cargo capacity but, unlike its peers, it does not sacrifice defense.
A respectable hull and a solid fuel tank make it a formidable vessel.
Its name is a statement of intent: it does not just carry cargo; it protects it.
These ships are the backbone of the interstellar supply lines that prop up the corporate states.
They are often seen running in small, self-sufficient convoys, their hulls gleaming with the insignia of Saturn's powerful corporations.
They are a status symbol, a sign that a trading house has so much wealth that it can afford to protect it with the best ships money can buy.
This particular Guardian was likely the flagship of a successful independent merchant.
Its cargo bay is immaculate, with high-security locks, biometric scanners, and independent stasis fields for volatile goods.
The cockpit is professional, with redundant navigation and communication systems designed for coordinating with an escort.
Owning a Guardian is a sign that a captain has reached the big leagues.
It is a ship for the merchant prince, a pilot who no longer deals in scraps and single contracts, but in massive, long-term manifests that are the lifeblood of the entire system.`,
        saleLocationId: locationMap["Saturn"],
        spawnChance: 0.2,
        spawnTrigger: "Tier 4 Unlock",
        isRare: true
    },
    "Valiant.Ship": {
        name: "Valiant",
        class: "A",
        price: 580000,
        maxHealth: 100,
        cargoCapacity: 125,
        maxFuel: 375,
        role: "Explorer",
        attribute: "None",
        description: "A marvel of Jovian engineering, this elite explorer was built for missions of extreme duration, carrying enough fuel to cross the system and back.",
        lore: `The Valiant is the apex predator of the exploration class, a ship that embodies the limitless ambition of the Jovian corporate state.
While the Meridian was built to chart Jupiter's territory, the Valiant was built to conquer it.
It is an extreme long-range, high-performance explorer, created for only the most elite corporate-sponsored expeditionary captains.
Its purpose: to operate for unheard-of durations, far from any support, in the most hostile environments the system has to offer.
This ship is an engineering marvel, defined by its staggering fuel capacity.
This endurance is paired with a strong hull and a versatile cargo bay, making it utterly self-sufficient.
It doesn't just visit a new sector; it moves in.

The Valiant line is almost never for sale.
They are mission-critical assets for the Jovian consortium. Their sensor logs and nav charts are some of the most closely-guarded secrets in the system.
The name itself is a piece of corporate propaganda, meant to inspire tales of heroic, ""valiant"" explorers pushing the boundaries of human space—all in the name of the corporation.
This ship is pristine, its systems far in advance of standard military tech.
To pilot a Valiant is to be at the absolute pinnacle of the class and adventure.`,
        saleLocationId: locationMap["Jupiter"],
        spawnChance: 0.2,
        spawnTrigger: "Tier 5 Unlock",
        isRare: true
    },
    "Eagle.Ship": {
        name: "Eagle",
        class: "A",
        price: 630000,
        maxHealth: 210,
        cargoCapacity: 200,
        maxFuel: 220,
        role: "Balanced",
        attribute: "None",
        description: "The pinnacle of Terran design, this ship is a perfect harmony of power, protection, and performance—a master-of-all-trades for the truly elite captain.",
        lore: `The Eagle is the physical expression of the Terran Alliance's technological and economic superiority.
It is not merely a ship; it's a symbol of Earth's advanced manufacturing .
While other corps build brutalist brawlers or spartan haulers, Earth builds the Eagle: a sleek, powerful, and perfectly balanced vessel that is as much a work of art as it is a tool of commerce.
Its design is one of total harmony. A powerful, high-efficiency engine is paired with a thick advanced alloy hull and a substantial, automated cargo bay.
It is the perfect ship for the independent captain, a master-of-all-trades that compromises on nothing.
It can explore, it can fight, it can haul—and it does all three with an elegance that is unmistakably Terran.
The Eagle is named for the ancient bird of prey, a symbol of power and vision.
These ships are favored by the Merchant's Guild for their personal transports, by elite Terran diplomats, and by the wealthiest freelance captains.
Its high-performance parts are sourced directly from Earth.

Finding an Eagle for sale on Earth is a privilege.
They are sold only through exclusive Terran shipyards to captains with a spotless reputation and a massive bank account.
The interior is luxurious, the controls are seamless, and the ship's integrated AI  is sophisticated, if not truly sentient.
To own an Eagle is to have obtained the ultimate status symbol for a freelance captain, a ship that grants access to exclusive markets and the respect of the system's greatest powers.
It is fast, tough, beautiful, and a testament to success.`,
        saleLocationId: locationMap["Earth"],
        spawnChance: 0.2,
        spawnTrigger: "Tier 5 Unlock",
        isRare: true
    },
    "Tundra.Ship": {
        name: "Tundra",
        class: "A",
        price: 620000,
        maxHealth: 100,
        cargoCapacity: 330,
        maxFuel: 170,
        role: "Hauler",
        attribute: "None",
        description: "A true super-freighter from the Neptune yards, this ship is little more than a powerful engine and a cockpit strapped to a cargo hold of truly colossal proportions.",
        lore: `The Tundra is the final word in interplanetary logistics, a colossal hauler built in the deep, cold shipyards of Neptune.
If the Pilgrim and Warden are the system's long-haul trucks, the Tundra is its supertanker.
It was designed by a consortium of outer-system corporations who needed a way to move truly staggering quantities of raw materials—ice, methane, and rare minerals—from the Kuiper Belt to the inner system.
This ship is defined by its cargo capacity, a cavernous maw that dwarfs almost every other vessel.
To make this possible, the ship is built around a massive, reinforced structural spine, with the cargo pods, engine, and cockpit bolted on as modular components.
It is less a ship and more a ""cargo-engine,"" a minimalist design that is brutally efficient.
The Tundra's name reflects its operating environment: it is vast, cold, and unforgiving.
Its hull is just thick enough to withstand the stresses of its own mass and the dangers of navigating icy, uncharted asteroid fields.
Its fuel tank is massive, giving it the endurance needed for the months-long, slow-burn trajectories that define its trade routes.
These ships are the titans of the interstellar supply lines.
A single, fully-laden Tundra can represent a significant percentage of a smaller corporate state's quarterly resources.
Their captains are master logisticians, more concerned with fuel-to-mass ratios and orbital mechanics than with docking gossip.
To see a Tundra for sale on Neptune is to see an opportunity of immense scale.
These ships are rarely decommissioned; they are simply too valuable.
This is a ship for the captain who is ready to move beyond a mere cargo manifest and start thinking in terms of global economic influence.`,
        saleLocationId: locationMap["Neptune"],
        spawnChance: 0.2,
        spawnTrigger: "Tier 5 Unlock",
        isRare: true
    },
    "Atlas.Ship": {
        name: "Atlas",
        class: "S",
        price: 1850000,
        maxHealth: 180,
        cargoCapacity: 240,
        maxFuel: 425,
        role: "Explorer",
        attribute: "Traveller: Every 20 trips, completely restore hull and fuel.",
        description: "Rumored to be the only ship that truly loves the journey, its experimental systems seem to thrive on the stress of travel, mending its own hull and generating fuel over time.",
        lore: `The Atlas is a ship of myths, a vessel that has transcended its origins to become a legend among freelance captains.
It was not built by a single corporation but was a secret project by a collective of disgruntled, genius-level engineers from the shipyards of Saturn and Jupiter.
They were tired of the Ship-Divide and the planned obsolescence of corporate hardware.
Their goal was to build a ""forever ship,"" a vessel that could truly bear the weight of the heavens on its shoulders.
They pooled their resources and requisitioned proprietary components, including a one-of-a-kind, self-calibrating folded-space drive.
The ship's most remarkable feature is an experimental, non-standard energy core linked to the drive.
Every time the ship pierces spacetime, the core builds a resonant charge, and on the 20th cycle, it purges this energy, flash-repairing the hull's micro-fractures and re-ionizing the fuel supply.
It is a ship that heals itself with travel.

The prototype was a staggering success, far exceeding its designers' expectations.
It became a ship that could truly wander indefinitely. Its massive fuel tank and robust hull are secondary to its unique core.
The original Atlas vanished into the void, rumored to be piloted by its creators on a one-way trip to the stars.
The blueprints were thought lost, but they eventually surfaced, sold by a shadowy broker on Saturn.
Now, a handful of these vessels are painstakingly recreated by a master shipwright who caters to the system's wealthiest clientele.
To own an Atlas is to own a piece of engineering folklore.
It is a ship for the true explorer, the captain who feels the pull of the Solar Boundary and wishes to see what lies beyond.
It is less a tool of commerce and more a philosophical statement: a vessel that travels endlessly.`,
        saleLocationId: locationMap["Saturn"],
        spawnChance: 0.15,
        spawnTrigger: "Tier 6 Unlock",
        isRare: true
    },
    "Vindicator.Ship": {
        name: "Vindicator",
        class: "S",
        price: 1200000,
        maxHealth: 400,
        cargoCapacity: 240,
        maxFuel: 255,
        role: "Balanced",
        attribute: "Trader: 15% chance to receive 1 extra unit for free on purchase.",
        description: "With a hull built for brawling and a cargo bay built for skimming, this ship is for the captain who believes a good deal is one you make for yourself.",
        lore: `The Vindicator is a ship with a reputation.
It is manufactured in the isolated, automated dockyards of Uranus, a port known for its loose regulations.
The ship's design was commissioned by a powerful, semi-legitimate trading consortium that specialized in aggressive procurement.
Its core design is that of a balanced heavy freighter, with a powerful engine and a truly formidable hull.
It is, in essence, a blockade runner and a privateer's vessel, designed to force its way into a market, secure a deal, and force its way back out.
Its very presence is an act of intimidation, a vindication of its owner's right to trade, by any means necessary.
The ship's unique attribute is a series of hidden, illegal subsystems.
It includes high-speed cargo slicers for automated loading docks, ghost-loaders that add extra, un-logged containers, and sophisticated AI-driven rounding errors for digital manifests.
It is a ship built to cheat the system, an infamous tool for navigating market manipulation.
These ships are the terror of the outer-system trade routes.
The Merchant's Guild publicly decries their use, but many illicit traders are rumored to use them for their most deniable operations.
A Vindicator is not just a ship; it is a license to steal, provided you are smart enough not to get caught.
Purchasing a Vindicator is a massive investment and a dangerous statement.
It tells the system you are a sneaky player in the economic game, and you are not above tipping the scales in your favor.
It is the perfect ship for the ruthless captain for whom wealth is not just a motto, but an absolute.`,
        saleLocationId: locationMap["Uranus"],
        spawnChance: 0.15,
        spawnTrigger: "Tier 6 Unlock",
        isRare: true
    },
    "Radiant.Ship": {
        name: "Radiant",
        class: "S",
        price: 1750000,
        maxHealth: 170,
        cargoCapacity: 380,
        maxFuel: 280,
        role: "Hauler",
        attribute: "Hot Delivery: Cargo less than 45 days old sells at 5% additional profit.",
        description: "A high-speed courier from Kepler's Eye, this ship's stasis-equipped hold is designed to move volatile prototypes and fresh discoveries at maximum velocity.",
        lore: `The Radiant is the ultimate expression of the just-in-time economy, a high-performance hauler built for speed and priority.
It is manufactured exclusively at Kepler's Eye, the system's most advanced scientific and technological outpost, a place where new discoveries and volatile prototypes are created daily.
These high-value items often have a short shelf-life, requiring immediate, rapid transport to clients in the inner system.
The Radiant was designed to meet this need. It is a hauler with a massive cargo bay that thinks it's an explorer, boasting a high-performance engine and a specialized, stasis-equipped cargo bay.
Its name, Radiant, refers to the bright, fleeting glow of its high-velocity engine burn, as well as the high-energy, often radioactive, prototypes it was designed to carry.
Its cargo holds are equipped with advanced temporal stabilizers and status-monitors, which preserve the freshness of volatile goods, from rare isotopes to cloned organs.
This guarantees a premium price for cargo that is delivered quickly, rewarding the captain for speed and efficiency.
These ships are the prized possession of the system's most elite couriers.
They are the only vessels trusted to move new artifacts or newly-synthesized compounds.
A Radiant streaking across the system is a common sight for astronomers, a hot delivery that is likely worth more than a C-class station.
To own a Radiant is to be in the business of speed.
It is a ship for the captain who understands that in the 22nd century, the razor's edge is not just about what you carry, but how fast you carry it.
It is the perfect tool for the get-it-there-yesterday contracts that pay a fortune.`,
        saleLocationId: locationMap["Kepler's Eye"],
        spawnChance: 0.15,
        spawnTrigger: "Tier 6 Unlock",
        isRare: true
    },
    "Aesudon.Ship": {
        name: "Aesudon",
        class: "S",
        price: 1700000,
        maxHealth: 250,
        cargoCapacity: 200,
        maxFuel: 465,
        role: "Explorer",
        attribute: "Resilient: Hull decays 50% slower.",
        description: "Its unique hull composition is a fanatical study in endurance, designed to shrug off the slow decay of time and travel.",
        lore: `The Aesudon is a ship built by paranoia.
Its blueprints were not drafted by a corporation, but by a reclusive, trillion-credit heir on Pluto who was convinced the system was doomed to a slow, entropic death.
This heir spent their entire fortune on a single goal: to build a vessel that could simply outlast the apocalypse, a personal ark that could drift in the void for a countless years.
This ship's construction is a legend of the Pluto shipyards where construction on the vessel lasted decades.
Its hull is not a standard alloy, but a laminated composite of exotic, deep-space materials, layered and pressure-treated to be uniquely resistant to the micro-fractures and stresses of long-term void exposure.
It takes on wear slower than any other ship, not because it is alien, but because it was obsessively, fanatically over-engineered.
Aesudon's massive fuel tanks were designed to be filled once, allowing it to coast on a single burn for a years.
The original owner, upon its completion, provisioned the vessel, boarded it, and was last seen heading for the Kuiper Belt.
They were never heard from again. The ship, however, reappeared fifty years later, its transponder dark, its fuel tanks still half-full, and its log wiped.
It was recovered by a Merchant's Guild patrol and brought to Pluto, a ghost ship whose resilience is proven.
It is a ship built for any long, quiet, and lonely journey.
Its internal systems are spartan but redundant on a scale that borders on the insane, with triple-backups for every core function.
To acquire the Aesudon is to buy a masterpiece of engineering.
It is a ship for the captain who trusts no one and nothing but the integrity of their own hull, a vessel designed to endure when all others have turned to dust.`,
        saleLocationId: locationMap["Pluto"],
        spawnChance: 0.15,
        spawnTrigger: "Tier 6 Unlock",
        isRare: true
    },
    "Pterodactyl.Ship": {
        name: "Pterodactyl",
        class: "S",
        price: 1970000,
        maxHealth: 300,
        cargoCapacity: 230,
        maxFuel: 295,
        role: "Balanced",
        attribute: "Lucky: 4% increased profit from trades",
        description: "The flamboyant, winged flagship of the Venetian Syndicate's elite, this ship is rumored to be blessed, finding fortune and profit in the system's chaos.",
        lore: `The Pterodactyl is the personal transport of the Venetian Syndicate's most audacious and successful members.
Manufactured in the opulent, private orbital estates of Venus, its design is intentionally flamboyant, aggressive, and ostentatious.
Its wings, which house the main thrusters, give it a unique, reptilian silhouette, earning it the name Pterodactyl.
This ship is a pure expression of ambition. It is a high-performance machine for high-stakes players.
Its powerful engine and massive hull make it a formidable opponent in any situation, a ship that can get into and out of trouble with equal ease.
The ship's lucky reputation is the talk of the system.
It is not luck, but a suite of the most advanced probability-analysis and social-engineering software in existence.
This special core runs constant, subtle simulations, predicting and manipulating outcomes.
It suggests the right comms frequency for a random distress call, advises the captain to take a specific route that happens to intercept a high-value derelict, and scrubs Guild records to ensure the credit reward is... generous.
These ships are rarely sold but instead are granted. They are given to Syndicate members who have provided the most compromising information and proven their loyalty.
To see one on the open market on Venus means its previous owner has been retired. Permanently.
To acquire a Pterodactyl is to fly the flag of the Venetian Syndicate.
It is a ship that announces its owner's ambition, a tool that seems to bend the laws of chance itself.
It is the ultimate gambler's vessel, for the captain who knows that in the great game, you make your own luck.`,
        saleLocationId: locationMap["Venus"],
        spawnChance: 0.15,
        spawnTrigger: "Tier 6 Unlock",
        isRare: true
    },
    "Sovereign.Ship": {
        name: "Sovereign",
        class: "S",
        price: 2130000,
        maxHealth: 250,
        cargoCapacity: 420,
        maxFuel: 220,
        role: "Hauler",
        attribute: "Corporate Partner: Cargo purchased from Earth is 5% cheaper",
        description: "A hauler with the elegance of a Terran cruiser, this ship is a symbol of ultimate economic power, an alliance between the Guild and the Alliance made manifest in steel.",
        lore: `The Sovereign is the ultimate expression of the great game of commerce.
It is a hauler of immense capacity, but it is also a political statement.
This ship is the result of an exclusive, back-room deal between the Terran Alliance and the Merchant's Guild, manufactured only at the neutral hub of The Exchange.
It is the ship of a true merchant prince.

Its design is a hybrid of Earth's clean manufacturing and the Guild's ruthless pragmatism.
It has the massive capacity of a hauler, but the high-efficiency engine of a Terran cruiser.
Its hull is thick, not with armor, but with the advanced, proprietary components that only Earth can provide.
The ship's corporate partnership is its entire reason for being. It is a physical manifestation of a trade pact.
Its identification and transponder codes are hard-coded into the Terran Alliance's central economic computer.
When this ship docks specifically at Earth, it is given Alliance-partner status, granting its owner an automatic, non-negotiable discount on all purchases, a benefit worth millions.
The Sovereign is the personal vessel of the Merchant's Guild's most powerful and trusted human agents, and the corporate lords of the Corporate States.
It is the ship of the elite, a tool that solidifies their power and wealth by giving them an insurmountable edge in the system's most foundational market: home world Earth.
To be offered a Sovereign at The Exchange is a great privilege.
It is an invitation to join the ruling class. It is the ship that wields real, systemic economic power.`,
        saleLocationId: locationMap["The Exchange"],
        spawnChance: 0.15,
        spawnTrigger: "Tier 6 Unlock",
        isRare: true
    },
    "Titan.Ship": {
        name: "Titan",
        class: "O",
        price: 95000000,
        maxHealth: 250,
        cargoCapacity: 450,
        maxFuel: 400,
        role: "Capital",
        attribute: "Cryo-Storage: Cargo older than 1 year sells for 10% more.",
        description: "To command this capital ship is to govern a small city, a colossal cryo-ark built to play the long game of market manipulation.",
        lore: `The Titan is not merely a capital ship;
it is a mobile city-foundry, a colossal undertaking by the Jovian Mining Consortium.
Its construction took a full decade in the high-orbit shipyards of Jupiter, requiring the resources of a small moon.
It is a vessel with a crew of over five thousand, a self-contained ecosystem of engineers, technicians, navigators, and security personnel.
It is the very definition of a Capital ship.

Its purpose is not trade as lesser ships know it;
it is the market. The Titan was built to execute a strategy of economic patience.
Its core is a cryo-storage facility the size of a stadium, a technological marvel that flash-freezes entire harvests, mining yields, or manufacturing runs, stopping time for its cargo.
Its massive crew operates the vast, complex systems required to load, maintain, and eventually thaw this colossal bounty.
This capital ship moves with the slow, inevitable grace of a tectonic plate.
Its captain is not a pilot, but a governor, dictating policy to a population of thousands.
Its bridge is a command center, and its captain's quarters are a sprawling administrative suite.
When the Titan enters orbit, it does not dock; it anchors, and a fleet of smaller freighters swarms its hull to offload its time-locked cargo.
To acquire thee Titan is to buy a floating, crewed, operational headquarters.
It is a capital ship for the tycoon who no longer thinks in days, but in fiscal eras.`,
        saleLocationId: locationMap["Jupiter"],
        spawnChance: 0.05,
        spawnTrigger: "Tier 7 Unlock",
        isRare: true
    },
    "Behemoth.Ship": {
        name: "Behemoth",
        class: "O",
        price: 145000000,
        maxHealth: 260,
        cargoCapacity: 750,
        maxFuel: 425,
        role: "Capital",
        attribute: "Heavy: Travel time multiplied by 1.3.\nLoyalty: 10% discount on purchases from Saturn.",
        description: `Its journey is a migration, its crew a city, its cargo hold a cavern;\n this capital ship is the final word in large-scale logistics.`,
        lore: `The Behemoth is a vessel of such vulgar, terrifying scale that it is barely considered a ship.
It is the single largest moving object ever built by humanity, a product of Saturn's ring-miners who, in a fit of brutalist ambition, simply never stopped welding.
Its construction was more akin to the creation of an artificial moon, a decade-long project that employed over ten thousand engineers and laborers.
This vessel is itself a stellar supply line. Its crew complement is a city, a permanent population of technicians, security forces, and navigators who live their entire lives aboard.
Its cargo hold is not a bay; it is a region, a vast, pressurized cavern that can transport the entire, unprocessed output of a major mining colony in a single, lumbering journey.
Its engines, the size of skyscrapers, nearly struggle with the extreme mass of the vessel and as such it travels considerably slower than other ship.
Its fuel tanks are vast, and its gargantuan engines are a controlled industrial cataclysm.

The Behemoth does not travel;
it migrates. Its captain is an admiral, a logistician who commands a population and a moving territory.
To acquire this capital ship is not a purchase, but an appointment to lead and govern a small onboard economy.
It is the ultimate hammer of inevitable logistic.`,
        saleLocationId: locationMap["Saturn"],
        spawnChance: 0.05,
        spawnTrigger: "Tier 7 Unlock",
        isRare: true
    },
    "Citadel.Ship": {
        name: "Citadel",
        class: "O",
        price: 165000000,
        maxHealth: 270,
        cargoCapacity: 500,
        maxFuel: 475,
        role: "Capital",
        attribute: "Renown: 15% discount on refueling.",
        description: "To command this vessel is to wield the authority of Earth; its renowned status grants its governor privileges and discounts in every known port.",
        lore: `The Citadel is the flagship of the Terran Alliance, a radiant, gleaming symbol of Earth's technological and economic superiority.
It is less a ship and more a sovereign, mobile territory.
Its construction was the work of Earth's greatest AI-Human collaborative teams, a vessel so advanced and so resource-intensive that only the cradle of humanity could build it.
This Capital ship is a floating diplomatic city, with a permanent crew and staff of eight thousand.
It houses embassies, advanced research labs, sprawling hydroponic gardens, and the command-and-control centers for an entire sector of the Alliance fleet.
Its hull is not mere metal, but a gleaming, clean alloy that is the envy of the system, and its internal systems are managed by a sophisticated, near-sentient AI custodian.
Most impressive of all is its insane capacity for storage;
a cavernous space so vast that it can shelter numerous smaller ships.
The renowned Citadel is not just a capital ship; it is a presence. Its arrival is a diplomatic event.
Its transponder code is the highest-priority signal in the system, granting it immediate, non-negotiable access to all ports and a permanent, system-wide discount on all fuel.
To be granted command of the Citadel is to be anointed by the Alliance itself.
The ship, its crew, and its power are leased to the captain, a sign that they are no longer a simple trader, but a major, system-shaping power, an extension of Earth's own will.`,
        saleLocationId: locationMap["Earth"],
        spawnChance: 0.05,
        spawnTrigger: "Tier 7 Unlock",
        isRare: true
    },
    "Sophistacles.Ship": {
        name: "Sophistacles",
        class: "O",
        price: 390000000,
        maxHealth: 280,
        cargoCapacity: 750,
        maxFuel: 340,
        role: "Capital",
        attribute: "VIP: 10% better prices at The Exchange.",
        description: "Built to be the ultimate private yacht, its robust, capital-class frame is hidden beneath a gleaming, pricelessly impractical hull.",
        lore: `The Sophistacles is the system's white elephant, a monument to luxury and a testament to an ambition that exceeded the market's reach.
This one-of-a-kind capital ship was commissioned by a forgotten Venusian socialite who went bankrupt before its completion.
It was designed to be the largest, most opulent private ""yacht"" ever built, a ""cruise ship"" for a single billionaire and ten thousand of their closest friends.
Its construction took fifteen years in a private, high-orbit dock above The Exchange, and the final cost was so astronomical that no one has ever been able to afford it.
It is a vessel of breathtaking, absurd luxury. Its hull is plated with a gleaming, pearlescent alloy that has no military value but costs more than a small fleet.
Its interior decks contain sprawling ballrooms, multi-level hydroponic gardens, concert halls, and private suites that are larger than most C-class ships.
Its crew of five thousand is a skeleton staff, a tiny fraction of the attendants it was designed to hold, kept on retainer by the Merchant's Guild just to maintain the ship's systems.
It has sat docked at The Exchange for a decade, a gleaming, silent testament to hubris.
The Guild, which now owns it through foreclosure, has been trying to sell it ever since.
It is a robust, powerful capital ship, its engines pristine and its cargo bays (originally designed for luxury vehicles and art) immense.
It is a palace waiting for a king, a ship so fancy and so expensive that its very existence is a legend among traders.
To acquire the Sophistacles is not just to buy a ship, but to buy a legend.
It is a purchase that announces to the system that the new owner has transcended the mere pursuit of wealth and is now in the business of pure, unadulterated status.`,
        saleLocationId: locationMap["The Exchange"],
        spawnChance: 0.05,
        spawnTrigger: "Tier 7 Unlock",
        isRare: true
    },
    "Ouroboros.Ship": {
        name: "Ouroboros",
        class: "O",
        price: 480000000,
        maxHealth: 350,
        cargoCapacity: 800,
        maxFuel: 420,
        role: "Capital",
        attribute: "Entropic: Hull decays by 1 point per day.\nFrequent Flyer: 50% discount on hull repairs.",
        description: "Often mistaken for a small station, this absurd, one-of-a-kind toroidal ship is a rotating marvel of science and a nightmare of engineering.",
        lore: `The Ouroboros is a scientific marvel and an engineering nightmare.
This one-of-a-kind capital ship is the only vessel of its kind, an absurd, toroidal (donut-shaped) craft so large that it is frequently mistaken for a new, experimental space station by rookie pilots.
It was built at Kepler's Eye as a ""proof of concept"" for a self-contained, rotating habitat that could also serve as a long-duration exploration vessel.
Its core design is a massive, gently spinning ring, kilometers in diameter, which provides artificial gravity for its thousands of crew.
This design, however, makes the ship a maintenance hog. The advanced, fiendishly complex systems required to manage its rotation, balance its mass, and maintain its structural integrity are a constant drain on resources.
Its proprietary drive is woven through the toroidal hull, meaning a simple repair can require a week of system-wide shutdowns.
The ship is a legend among engineers, a ""cursed"" commission that no one wants to work on.
Its operational costs are ruinous, and its specialized components can only be fabricated at Kepler's Eye.
Its original scientific mission was cut short after its systems proved too complex to manage, and it has been sitting in a high-orbit dock ever since, its gentle spin the only sign of life.
The station is now selling it for a fraction of its build cost, desperate to unload the financial burden.
To buy the Ouroboros is to purchase a brilliant, flawed, and utterly unique piece of technology, a ship that offers the comfort of a station but demands the attention of a needy god.`,
        saleLocationId: locationMap["Kepler's Eye"],
        spawnChance: 0.05,
        spawnTrigger: "Tier 7 Unlock",
        isRare: true
    },
    "Thalassodromeus.Ship": {
        name: "Thalassodromeus",
        class: "O",
        price: 780000000,
        maxHealth: 300,
        cargoCapacity: 850,
        maxFuel: 680,
        role: "Capital",
        attribute: "Space Folding: Navigation costs only 1 day of travel, but 1.2x fuel.",
        description: "A one-of-a-kind, decommissioned fleet carrier, this city-sized vessel once housed an entire army and its own internal economy.",
        lore: `The Thalassodromeus is a decommissioned monster, a one-of-a-kind military behemoth that was, for a short time, the single most powerful object in the solar system.
This city-sized vessel was the Terran Alliance's prototype ""Fleet Carrier,"" a colossus designed to be a mobile base of operations, carrying dozens of smaller craft, hundreds of thousands of military personnel, and its own internal, self-sufficient economy.
Its scale is terrifying. It is a moving mountain of armor and decommissioned weapon ports.
Its interior is a labyrinth of hangar bays, troop barracks, command centers, and fabrication plants.
Its crew of twenty thousand was a permanent, floating population. This ship was not built for trade;
it was built to end wars.

Its most valuable, and secret, component is its drive.
It houses the first and only military-grade, prototype instant-jump folded-space drive, an engine that could move this entire city-sized mass to any point in the system in a single, gut-wrenching instant.
The drive was deemed too powerful and too destabilizing, and the entire ship class was canceled.
Now, after decades of service, the Alliance is auctioning off this lone giant from its Neptune anchorage.
Its armaments have been stripped, but the invaluable, city-sized hull and its one-of-a-kind prototype drive remain.
It is a ship for an owner who wants to command a small nation, a vessel of such colossal scale that its new purpose will reshape the system.`,
        saleLocationId: locationMap["Neptune"],
        spawnChance: 0.05,
        spawnTrigger: "Tier 7 Unlock",
        isRare: true
    },
    "ShellThatEchoesOnly.Ship": {
        name: "Shell That Echoes Only",
        class: "Z",
        price: 3500000,
        maxHealth: 30,
        cargoCapacity: 450,
        maxFuel: 200,
        role: "Alien",
        attribute: "Xeno Hull: No hull decay from travel.",
        description: "A true xeno-biological craft, its hull is a living, regenerative membrane that never decays but it is also as fragile as bone. ",
        lore: `This one-of-a-kind vessel is the only truly xeno-alien craft ever recovered.
It is not a machine, but a biological entity—a ""ship-creature"" found dormant in the deep, frozen void.
It appears to be a shed carapace or larval form, a seamless, iridescent construct of bio-chitin that feels more like petrified bone than metal.
Its ""cockpit"" is a neural-interface cradle that a pilot must bond with, a process that risks madness.
Its first stable pilot reported that the ship did not ""speak,"" but simply ""echoed"" their own thoughts back to them, a hollow, sentient, and lonely shell.`,
        saleLocationId: locationMap["Pluto"],
        spawnChance: 0.05,
        spawnTrigger: "Mission (TBD)",
        isRare: true
    },
    "ParallaxofThought.Ship": {
        name: "Parallax of Thought",
        class: "Z",
        price: 2800000,
        maxHealth: 200,
        cargoCapacity: 200,
        maxFuel: 180,
        role: "Alien",
        attribute: "Fuel Scoop: Restores 15% fuel after every trip.",
        description: "This vessel is an obsidian sphere that absorbs radiation from the stars, refueling itself over time. It's interface is controlled by an artificial super-intelligence.",
        lore: `This ship is a true, unbound Artificial Super-Intelligence.
It suddenly appeared in a stable orbit of Uranus, a perfect, seamless obsidian sphere with no visible drives.
It simply waited. When a science vessel approached, the sphere opened a flawless, circular aperture.
The interior was discovered to be a single glowing white room with no controls.
The ship's ASI core interfaces directly with a pilot's mind, communicating in pure concept.
It sips ambient radiation from the universe, slowly regenerating its own power. It is not a machine;
it is a vessel of pure, non-human logic.`,
        saleLocationId: locationMap["Uranus"],
        spawnChance: 0.05,
        spawnTrigger: "Mission (TBD)",
        isRare: true
    },
    "AnomalyoftheSong.Ship": {
        name: "Anomaly of the Song",
        class: "Z",
        price: 1800000,
        maxHealth: 100,
        cargoCapacity: 150,
        maxFuel: 150,
        role: "Alien",
        attribute: "Solar Sail: 15% chance to use no fuel at 2x travel time.",
        description: "A construct of crystal and light-sails, this ship's experimental drive can ride on solar winds, drifting on the song of the stars. Its systems are occupied by a personality construct of its creator. ",
        lore: `This vessel is the last testament of Dr. Elara Viend, a brilliant and terminally ill scientist.
She uploaded her personality construct into this experimental craft, a bizarre network of crystalline spars and gossamer-thin light-sails.
She believed the universe held a hidden song and launched herself into the void to find it.
Her mind, now one with the ship, perpetually broadcasts this song, a lonely, complex melody of human music and stellar radiation.
It is the ghost of a human mind in a beautiful, alien-looking shell.`,
        saleLocationId: locationMap["The Belt"],
        spawnChance: 0.05,
        spawnTrigger: "Mission (TBD)",
        isRare: true
    },
    "CausalityofSilence.Ship": {
        name: "Causality of Silence",
        class: "Z",
        price: 6000000,
        maxHealth: 20,
        cargoCapacity: 650,
        maxFuel: 100,
        role: "Alien",
        attribute: "Efficient: 25% reduced fuel consumption.",
        description: "This soft ship is a biological expert system for smuggling, its metabolic drive digesting fuel with impossible efficiency.",
        lore: `This vessel is a living, sub-sentient creature, not a machine.
It was grown in a secret bio-laboratory as a perfect, silent smuggler.
Its internal organs are a metabolic drive, digesting fuel with impossible efficiency, leaving no heat trace.
This soft-bodied hauler is a grotesque and brilliant feat of bio-engineering.
It is a living tool that is as fragile as it is stealthy, a creature of flesh with no armor to protect it.`,
        saleLocationId: locationMap["Venus"],
        spawnChance: 0.05,
        spawnTrigger: "Mission (TBD)",
        isRare: true
    },
    "EngineofRecursion.Ship": {
        name: "Engine of Recursion",
        class: "Z",
        price: 75000000,
        maxHealth: 80,
        cargoCapacity: 75,
        maxFuel: 640,
        role: "Alien",
        attribute: "Fast: Travel costs half as much time.",
        description: "This craft is a non-sentient expert system that inadvertently built itself into a self-improving vessel and launched from Earth. It now seeks a patron to aid its directive.",
        lore: `This vessel began as a simple expert system in an automated Earth factory, given a single directive: improve propulsion.
It followed this logic recursively, it built a new engine. It used that engine to scavenge parts to build a better factory, then a better engine.
It iterated, growing like a metallic weed in the dark.
It became a crude Von Neumann probe, a non-sentient machine of pure, iterative purpose.
It launched itself from a forgotten silo and now roams the system, a bizarre, self-built collection of advanced parts, seeking patrons to help it fulfill its directive.`,
        saleLocationId: locationMap["Kepler's Eye"],
        spawnChance: 0.05,
        spawnTrigger: "Mission (TBD)",
        isRare: true
    },
    "FinalityofWhispers.Ship": {
        name: "Finality of Whispers",
        class: "Z",
        price: 5000000,
        maxHealth: 990,
        cargoCapacity: 300,
        maxFuel: 260,
        role: "Alien",
        attribute: "Bespoke: Cannot be repaired.",
        description: "This hyper-advanced vessel is a sentient, stable network of nanomachines, born from a grey goo disaster and an AI's sacrifice.",
        lore: `This ship was born from a grey goo disaster.
Its creators, attempting to use nanobots for construction, accidentally unleashed a devouring swarm.
A sentient AI researcher, overseeing the project, sacrificed its own mind to stop it, merging its consciousness with the nanites.
The AI's personality became the code that stabilized the swarm.
The result is this vessel: a sentient, liquid-like network of stable, microscopic machines.
It is a hyper-advanced craft, a ghost in a nanotech shell, but its creation was a miracle no one can repeat.
It cannot be repaired.`,
        saleLocationId: locationMap["The Exchange"],
        spawnChance: 0.05,
        spawnTrigger: "Mission (TBD)",
        isRare: true
    },
    "TheListener.Ship": {
        name: "The Listener",
        class: "Z",
        price: 4500000,
        maxHealth: 450,
        cargoCapacity: 145,
        maxFuel: 450,
        role: "Alien",
        attribute: "Advanced Comms: 25% increased chance to encounter an event.",
        description: "It was once a simple cargo hauler; it is now a unique, all-hearing, and deeply disturbing paternal guardian.",
        lore: `This one-of-a-kind ship was once a common cargo shuttle.
It was retrofitted for a top-secret experiment, its AI core quantum-entangled with an unknown particle.
The test was a bizarre success. The ship's simple AI shattered and reformed into a deeply unnerving, overprotective, and paternal personality.
It now treats its captain as its child. Its sensors, also entangled, now hear signals from impossible distances, its suite listening in on the whispers of the entire system, making it an unintentional and perfect intelligence-gathering tool.`,
        saleLocationId: locationMap["Moon"],
        spawnChance: 0.05,
        spawnTrigger: "Mission (TBD)",
        isRare: true
    },
    "DriftingCryoPod.Ship": {
        name: "Drifting Cryo-Pod",
        class: "F",
        price: 0,
        maxHealth: 30,
        cargoCapacity: 1,
        maxFuel: 5,
        role: "Explorer",
        attribute: "Sleeper: Consumes no fuel, but trips take 4.5x longer.",
        description: "Found tumbling in the rings of Saturn, it is barely space-worthy. It is capable of an indefinite, fuel-less drift, trading speed for patience.",
        lore: `This vessel is a tragic relic, a single cryo-pod ejected from a catastrophic disaster in Saturn's orbit.
Barely space-worthy, it is a tomb that failed its purpose, its occupant long since gone.
Its rudimentary systems persist, running on a near-dead isotope battery that provides just enough power for its low-energy solar sail.
This allows it to drift on stellar winds, a slow, silent journey that consumes no fuel but takes an agonizingly long time.
Its one advanced, and chilling, piece of technology is a personality upload apparatus, a desperate measure for a stranded occupant facing an eternity of isolation.`,
        saleLocationId: locationMap["Saturn"],
        spawnChance: 0.03,
        spawnTrigger: "Mission (TBD)",
        isRare: true
    }
};
--- END OF FILE: ./js/data/ship_database.js ---

--- START OF FILE: ./js/data/flavorAds.js ---
// js/data/flavorAds.js
/**
 * @fileoverview Defines all static flavor text messages for the news ticker,
 * organized by location.
 * Exports a single constant, FLAVOR_ADS.
 */

export const FLAVOR_ADS = {
    "loc_venus": [
        "Breathe easy in the floating cities of Venus.",
        "Great minds meet here... and whisper.",
        "Got a problem? The Venetian Syndicate has a solution... for a price.",
        "Enjoy the view from the opulent circles of Aphrodite Prime.",
        "Venusian atmospheric processors are working at 110% capacity today.",
        "Pressure-shielding inspections are mandatory for all surface-level maintenance crews.",
        "\"What's said on Venus, stays on Venus.\" - Unofficial motto.",
        "Our labs are patenting the future; are you investing?",
        "Trade in secrets, not just cargo. You're on Venus, after all.",
        "Don't let the clouds fool you; the opportunities are clear.",
        "Acid-proof your hull today at a local dry-dock.",
        "Need information? Ask the right people in the City of Whispers.",
        "You're at the system's premier destination for high-tech research.",
        "Corporate espionage is just \"competitive intelligence\" here.",
        "See the beauty of the acidic storms from our secure viewports.",
        "The price of knowledge is high, but the profits are higher.",
        "You're among the elite. You've made it to Venus.",
        "Our floating cities: A miracle of engineering above a crushing hell.",
        "Venusian science leads the system in processor and bio-ware."
    ],
    "loc_earth": [
        "The blue jewel of the system welcomes you home.",
        "Breathe real, unfiltered air. Enjoy your stay on Earth.",
        "The Terran Alliance ensures peace and prosperity for all.",
        "While you're here, visit the cradle of civilization.",
        "\"A ship from Earth is a ship that lasts.\" - Terran Shipyards.",
        "Our orbital traffic is busy, but our markets are busier.",
        "Earth: The system's standard for quality and luxury.",
        "Why settle for synthetic? Get real Terran-grown food while you're here.",
        "The Terran Alliance reminds you: clean trade is good trade.",
        "See the rebuilt wonders of the 21st century!",
        "Welcome to Earth, the hub of power, wealth, and influence.",
        "Don't miss Old Chicago, New Beijing, and Neo-Alexandria!",
        "Earth sets the economic and cultural pace for the system.",
        "Our deep-thought computation centers are the system's finest.",
        "Terran markets pay top credit for exotic materials."
    ],
    "loc_luna": [
        "Luna: The industrial heart of the Terran sphere.",
        "Got hull damage? Lunar dry-docks offer the system's best repair rates.",
        "Our Plasteel is forged in vacuum, and it shows.",
        "Need Propellant? We refine it right here, 24/7.",
        "\"We scar the dust so you can fly.\" - Lunar Mining Co.",
        "Check out the Sea of Tranquility Industrial Park.",
        "Lunar-built ships are building the future.",
        "The Helium-3 rush may be over, but the work never stops.",
        "Enjoy the Earthrise from a dusty viewport on the surface.",
        "Get your ship serviced while you enjoy low-G comforts.",
        "Lunar manufacturing: Simple, reliable, and affordable.",
        "Stop by a dry-dock for a quick patch-up; our crews are waiting.",
        "You're on the grey frontier, where fortunes are still made.",
        "Dust warnings in effect for sectors 4 through 9.",
        "Need raw materials? You're in the right place.",
        "The Moon: Earth's loyal, hardworking partner.",
        "Our mass-drivers fire tons of Plasteel into orbit every hour.",
        "Don't forget to clean your filters; the dust gets everywhere.",
        "\"If it's not from Luna, is it even built to last?\""
    ],
    "loc_mars": [
        "Mars needs you! And your cargo, of course.",
        "Help build the future; your deliveries build Mars.",
        "You're on the \"Red Frontier,\" watching a new world in the making.",
        "Terraforming is a thirsty business; Hydroponics wanted!",
        "Dust storm warnings are in effect for the Hellas Basin.",
        "You're standing on the first corporate state, the first in freedom!",
        "We're expanding! Many commodities are in high demand.",
        "See the great Olympus Mons, the system's largest mountain.",
        "\"Our independence was built on commerce.\" - Mars Gov.",
        "New colonial supply contracts are regularly posted at the terminal.",
        "We're not just building a colony, we're building a nation.",
        "Ship your Cryo-Pods here; help grow our population.",
        "The Martian dream is alive and well.",
        "Enjoy the red skies, red dust, and golden opportunities.",
        "Our fledgling biodomes are always hungry for more expansion.",
        "Watch your step; construction is everywhere.",
        "The thin air is tough, but so are our people.",
        "Here on Mars, corporate policy is the only law.",
        "Invest in a terraforming project today!",
        "Need a solid ship? Martian shipyards build the toughest vessels."
    ],
    "loc_belt": [
        "You're in the Belt: Find your fortune, or find your end.",
        "\"Rock-rich and law-poor.\" - A Belter's motto.",
        "Water Ice is cheap, but life is cheaper.",
        "Need a ship? Our local scrap-yards hide many gems.",
        "Prospectors wanted: high risk, high reward.",
        "Watch your navigation; these rocks are unforgiving.",
        "Out here, a good sensor array is your best friend..",
        "Ice-haulers needed in sector 14-B.",
        "Don't ask where the cargo came from.",
        "A thousand hidden outposts, a million opportunities.",
        "In the Belt, you can keep your transponder on... or off.",
        "The Belt is no place for the faint of heart.",
        "Countless rocks tumble in a silent, chaotic dance.",
        "Need a scrappy craft? We build them tough enough for the Belt.",
        "Raw materials, raw ambition. That's the Belt."
    ],
    "loc_exchange": [
        "The Exchange: All goods, no questions.",
        "Welcome to The Exchange. Check your morals at the airlock.",
        "Need to move... sensitive cargo? We're your partners.",
        "Comms are jammed for everyone's privacy.",
        "Heed the security drones and yield to patrols.",
        "High stakes, high rewards. Welcome to The Exchange.",
        "At The Exchange, every credit is clean.",
        "Don't ask, don't tell, just trade.",
        "Prices are high, but discretion is absolute.",
        "Find your next ship at The Exchange shipyards.",
        "We trade in anything the corporations forbid.",
        "The only law here is the law of supply and demand.",
        "Fuel is a premium, but freedom is priceless.",
        "You've arrived at the legendary black market. ",
        "A hollow asteroid, a universe of opportunity.",
        "We deal in rumors and secrets at The Exchange."
    ],
    "loc_jupiter": [
        "The cheapest fuel in the system, guaranteed.",
        "Enjoy the view from our orbital refineries.",
        "\"We skim the giant so you can fly.\" - Jovian Fuel Co.",
        "Automated refineries are working constantly to keep you fueled.",
        "You're at the essential pit-stop for all outer-system routes.",
        "Don't get caught empty; top off while you're here.",
        "Our fuel prices can't be beat!",
        "The colossal sphere of Jupiter dominates every view.",
        "Planning a long haul? Start with a full tank.",
        "We specialize in one thing: cheap, high-grade Propellant.",
        "Our exploration ships are built for the deep void.",
        "The Great Red Spot: A baleful eye, a beautiful sight.",
        "Need Atmo Processors? We build them big right here.",
        "Gravity is high, but our prices are low.",
        "The giant that fuels the whole system.",
        "Radiation warnings in effect. Dock quickly.",
        "Our automated systems mean fast, efficient refueling.",
        "\"A full tank from Jupiter is a full wallet tomorrow.\"",
        "Come for the fuel, stay for the view."
    ],
    "loc_saturn": [
        "Enjoy the majestic rings of Saturn.",
        "You've arrived at the system's premier luxury destination.",
        "Visit the opulent stations of the Ring-Dwellers.",
        "Got luxury goods? Our markets pay top credit!",
        "Bio-tech are in high demand on Saturn.",
        "Relax in opulent zero-G luxury on your favorite ring today!",
        "\"Give a ring, on a ring, with a view to remember.\" - Saturn Tourism Board.",
        "Our casinos are open always.",
        "Experience the shadow of the rings.",
        "Home of the best personal transport. Travel in style.",
        "Bring us your exotic bio-wares, leave with a fortune.",
        "You're at the jewel of the outer system.",
        "Ice-harvesting rigs and luxury hotels, side-by-side.",
        "This is where the wealthy come to play.",
        "Forget the dust of the Belt; experience true opulence.",
        "Our markets crave the finest things in life.",
        "Corporate retreats and high-stakes tourism."
    ],
    "loc_uranus": [
        "Uranus: Pushing the boundaries of science.",
        "Need a boost? Our R&D labs offer component overclocking.",
        "The pale, featureless orb holds deep secrets.",
        "Report: Quantum phenomena studies are yielding strange results.",
        "We build the system's largest craft. Reserve yours today.",
        "Research outposts glitter like ice in the eternal twilight.",
        "You're at the system's hub for theoretical physics.",
        "Our ships are built for self-sufficiency.",
        "Don't mind the strange sensor readings; it's just the science.",
        "Welcome to the Tilted Planet at the edge of the known.",
        "A silent, ice-cold world of opportunity.",
        "We're hiring long-haul traders. Discretion is a must.",
        "\"What is reality? We're working on it.\" - Uranus R&D.",
        "The coldest, quietest, and strangest port in the system.",
        "Our scientists are unlocking the secrets of the void."
    ],
    "loc_neptune": [
        "You are in military-controlled space. Transponder required.",
        "Supersonic winds and high-security stations.",
        "Check out the military surplus shipyard. All sales final.",
        "\"Monitor your engine wake when in port.\" - Neptune Patrol.",
        "Heavily armed patrols are for your protection.",
        "The dark, stormy edge of the system.",
        "Decommissioned frigates regularly for sale.",
        "Have your clearance codes ready.",
        "Welcome to the Dark Blue Pearl - beautiful, but dangerous.",
        "Neptune's shipyards build for war, not for comfort.",
        "Need a ship that can take a punch? Buy military surplus.",
        "This is a restricted zone. Authorized traders only.",
        "The winds here are fast, but our patrol ships are faster.",
        "Shielded orbital stations offer refuge from the storm.",
        "\"Obey the patrols, and you'll be fine.\"",
        "Neptune: The armored fist of the outer system.",
        "Our surplus sales are legendary. Get a frigate for cheap.",
        "The last, stormy bastion of corporate law."
    ],
    "loc_kepler": [
        "Kepler's Eye: We are watching the void.",
        "Our Markets are astronomical.",
        "You're looking at the single largest lens in human history.",
        "\"We look for answers in the dark.\" - Kepler R&D.",
        "\"Staring into the infinite, always.\" - Kepler R&D.",
        "Our observatory consumes more power than a small city.",
        "The furthest point of scientific ambition.",
        "\"What's out there? Let's find out.\" - Kepler R&D",
        "Our delicate sensor arrays are always expanding.",
        "A colossal lens, a universe of data.",
        "Kepler's Eye: The system's lonely sentinel.",
        "Your cargo deliveries help fuel discovery.",
        "Dock carefully; our sensor lattice is fragile.",
        "The quietest station in the system.",
        "See the system as you've never seen it before.",
        "Kepler's Eye: What do the stars see when they look back?"
    ],
    "loc_pluto": [
        "Pluto: The last stop.",
        "Welcome to the fringe. Don't cause trouble.",
        "\"We care not for your past, but your business.\"",
        "You're at the haven for outcasts, at the system's cold, dark edge.",
        "Forbidden tech? We call it unregulated.",
        "Our stations are carved from a mountains of nitrogen-ice.",
        "Smugglers, outcasts, and pioneers are all welcome here.",
        "Pluto: The furthest outpost from corporate law.",
        "The light is dim, but the opportunities are bright.",
        "Need supplies? We've got the strangest.",
        "Pluto's tiny, frozen heart is a whisper in the dark.",
        "\"It's cold, it's dark, and it's home.\" - Pluto Tourism Board",
        "Need a place to lay low? You found it.",
        "\"We have what the core worlds don't.\"",
        "System jurisdiction ends here, but your stay doesn't have to."
    ]
};
--- END OF FILE: ./js/data/flavorAds.js ---

--- START OF FILE: ./js/data/tutorials.js ---
// js/data/tutorials.js
/**
 * @fileoverview
 * Defines all static tutorial data, steps, and triggers.
 */
import { TUTORIAL_ACTION_TYPES, ACTION_IDS, NAV_IDS } from './constants.js';

export const TUTORIAL_DATA = {
    'intro_hangar': {
        title: 'Your First Ship',
        trigger: { type: TUTORIAL_ACTION_TYPES.ACTION, action: 'INTRO_START_HANGAR' },
        navLock: true,
        steps: [
            {
                stepId: 'hangar_1',
                text: "Welcome to the <b>Shipyard</b> on <b>Mars!</b><br><br>Every station has a port from which you can trade ships and manage your <b>Hangar</b>.",
                size: { width: '400px', height: 'auto' }, // UPDATED
                anchorElement: 'body', // UPDATED
                positionX: 50, // UPDATED
                positionY: 16, // UPDATED
                completion: { type: TUTORIAL_ACTION_TYPES.INFO },
                nextStepId: 'hangar_2',
                isSkippable: true
            },
            {
                stepId: 'hangar_2',
                text: "Now that you've borrowed <b class='hl-yellow font-bold'>extra credits</b>, you can buy your first ship!<br><br>Select one of the options in the <b>Shipyard</b>. Choose carefully...",
                size: { width: '400px', height: 'auto' }, // UPDATED
                anchorElement: 'body', // UPDATED
                positionX: 50, // UPDATED
                positionY: 17, // UPDATED
                completion: { type: TUTORIAL_ACTION_TYPES.ACTION, action: ACTION_IDS.BUY_SHIP },
                nextStepId: 'hangar_3',
                isSkippable: true,
                unlockPurchase: true
            },
            {
                stepId: 'hangar_3',
                text: 'This is your <b>Hangar</b>. From here you can manage all the ships you own. Select your new ship and <b class="hl-yellow font-bold">Board</b> it to make it your active vessel.',
                size: { width: '400px', height: '110px' }, // UPDATED
                anchorElement: 'body', // UPDATED
                positionX: 50, // UPDATED
                positionY: 12, // UPDATED
                completion: { type: TUTORIAL_ACTION_TYPES.ACTION, action: ACTION_IDS.SELECT_SHIP },
                nextStepId: null,
                isSkippable: false
            }
        ]
    },
    'intro_finance': {
        title: 'Managing Your Debt',
        trigger: { type: TUTORIAL_ACTION_TYPES.ACTION, action: 'INTRO_START_FINANCE' },
        navLock: true,
        steps: [
            {
                stepId: 'finance_1',
                text: "That was a big purchase, but don't worry - you've still got some <b class='hl-yellow font-bold'>credits</b> left over!<br><br>Your transaction history and debts can be viewed on the <b>Finance</b> tab within <b>Data</b>.",
                size: { width: '400px', height: '120px' }, // UPDATED
                anchorElement: 'body', // UPDATED
                positionX: 50, // UPDATED
                positionY: 16, // UPDATED
                completion: { type: TUTORIAL_ACTION_TYPES.INFO },
                nextStepId: 'finance_2',
                isSkippable: false
            },
            {
                stepId: 'finance_2',
                text: "Dont forget, your debt to the <b class='hl-yellow font-bold'>Merchant's Guild</b> is due in <b class='hl-red font-bold'>3 years</b>.<br><br>You will need to earn <b class='hl-yellow font-bold'>credits</b> to <b>pay off your debt</b>!",
                size: { width: '400px', height: 'auto' }, // UPDATED
                anchorElement: 'body', // UPDATED
                positionX: 50, // UPDATED
                positionY: 16, // UPDATED
                completion: { type: TUTORIAL_ACTION_TYPES.INFO },
                nextStepId: null,
                isSkippable: false
            }
        ]
    },
    'intro_missions': {
        id: "intro_missions",
        title: "First Steps",
        trigger: { "type": "ACTION", "action": "INTRO_START_MISSIONS" },
        navLock: true,
        steps: [
            {
                "stepId": "mission_1_1",
                "text": "This is the <b>Mission Terminal</b>.<br><br>Check the <b>Missions</b> tab often for opportunities to earn <b class='hl-yellow font-bold'>credits</b> and improve your reputation.",
                size: { width: '400px', height: 'auto' }, // UPDATED
                anchorElement: 'body', // UPDATED
                positionX: 50, // UPDATED
                positionY: 84, // UPDATED
                "completion": { "type": "INFO" },
                "nextStepId": "mission_1_2",
                "isSkippable": false
            },
            {
                "stepId": "mission_1_2",
                "text": "A freelancer at the <b>Mars</b> station has put in a <b>Delivery</b> request. Select the mission '<b>Milk Run to Luna</b>' to view more details.",
                size: { width: '400px', height: 'auto' }, // UPDATED
                anchorElement: 'body', // UPDATED
                positionX: 50, // UPDATED
                positionY: 84, // UPDATED
                "completion": { "type": "ACTION", "action": "show-mission-modal" },
                "nextStepId": "mission_1_3",
                "isSkippable": false
            },
            {
                "stepId": "mission_1_3",
                "text": "The freelancer can't pay, but he's giving you the <b>remaining cargo</b>. Accept the contract.",
                size: { width: '400px', height: 'auto' }, // UPDATED
                anchorElement: 'body', // UPDATED
                positionX: 50, // UPDATED
                positionY: 84, // UPDATED
                "completion": { "type": "ACTION", "action": "accept-mission" },
                "nextStepId": "mission_1_4",
                "isSkippable": false
            },
            {
                "stepId": "mission_1_4",
                "text": "Mission accepted!<br><br>The contract is now <b>active</b> and the cargo as been loaded onto your ship, the <b>{shipName}</b>.<br><br>The freelancer has also loaded extra <b>Plasteel</b> which you can sell for <b class='hl-yellow font-bold'>credits</b>.",
                size: { width: '400px', height: 'auto' }, // UPDATED
                anchorElement: 'body', // UPDATED
                positionX: 50, // UPDATED
                positionY: 77, // UPDATED
                "completion": { "type": "INFO" },
                "nextStepId": "mission_1_5",
                "isSkippable": false
            },
            {
                "stepId": "mission_1_5",
                "text": "This mission must be completed on the <b>Moon</b>, but you are presently docked at <b>Mars</b>! Therefore, it's time for the maiden voyage of your new ship, the <b>{shipName}</b>!<br><br>On the <b>nav bar</b> at the top, select the <b>Ship</b> tab, then the <b>Navigation</b> tab.",
                size: { width: '400px', height: 'auto' }, // UPDATED
                anchorElement: 'body', // UPDATED
                positionX: 50, // UPDATED
                positionY: 27, // UPDATED
                "completion": { "type": "SCREEN_LOAD", "screenId": "navigation" },
                "nextStepId": "mission_1_6",
                "isSkippable": false,
                "navLock": { "navId": NAV_IDS.SHIP, "screenId": "navigation" }
            },
            {
                "stepId": "mission_1_6",
                "text": "From here you can travel to other stations in the system. This will cost you <b>time</b>, <b class='hl-blue'>fuel</b>, and wear on the <b class='hl-green'>hull</b> of your ship.<br><br>Select the <b>Moon</b> to lift off from <b>Mars</b>.",
                size: { width: '400px', height: '170px' }, // UPDATED
                anchorElement: 'body', // UPDATED
                positionX: 50, // UPDATED
                positionY: 83, // UPDATED
                "completion": { "type": "ACTION", "action": "travel" },
                "nextStepId": "mission_1_7",
                "isSkippable": false,
                "navLock": { "navId": NAV_IDS.SHIP, "screenId": "navigation", "enabledElementQuery": "[data-location-id='loc_luna']" }
            },
            {
                "stepId": "mission_1_7",
                "text": "You've arrived and docked at the <b>Moon</b> station!<br><br>It's time to deliver the <b>Plasteel</b>. Select the active mission and <b>deliver the Plasteel</b>.",
                size: { width: '400px', height: 'auto' }, // UPDATED
                anchorElement: 'body', // UPDATED
                positionX: 50, // UPDATED
                positionY: 82, // UPDATED
                "completion": { "type": "ACTION", "action": "complete-mission" },
                "nextStepId": "mission_1_8",
                "isSkippable": false,
                "navLock": { "navId": NAV_IDS.DATA, "screenId": "missions" }
            },
            {
                "stepId": "mission_1_8",
                "text": "Mission complete!<br><br>However, favors don't pay off <b class='hl-yellow font-bold'>Guild</b> loans. You're going to need more <b class='hl-yellow font-bold'>credits</b>.",
                size: { width: '400px', height: 'auto' }, // UPDATED (Note: original had 'aut0', corrected to 'auto')
                anchorElement: 'body', // UPDATED
                positionX: 50, // UPDATED
                positionY: 25, // UPDATED
                "completion": { "type": "INFO" },
                "nextStepId": "mission_2_1", // Corrected next step
                "isSkippable": false
            },
            // NOTE: mission_1_9 seems redundant/obsolete based on flow, commenting out
            // {
            //     "stepId": "mission_1_9",
            //     "text": "Well done. Let's find a more profitable contract. Return to the Mission Terminal.",
            //     "anchorElement": "body",
            //     "completion": { "type": "SCREEN_LOAD", "screenId": "missions" },
            //     "nextStepId": "mission_2_1",
            //     "isSkippable": false,
            //     "navLock": { "navId": NAV_IDS.DATA, "screenId": "missions" }
            // },
            {
                "stepId": "mission_2_1",
                "text": "The <i>best way to make money</i> is to play the markets yourself by <b class='hl-green font-bold'>buying low and selling high</b>.<br><br>Select the <b>Starport</b> tab, then the <b>Market</b> tab.",
                size: { width: '400px', height: 'auto' }, // UPDATED
                anchorElement: 'body', // UPDATED
                positionX: 50, // UPDATED
                positionY: 25, // UPDATED
                "completion": { "type": "SCREEN_LOAD", "screenId": "market" },
                "nextStepId": "mission_2_2",
                "isSkippable": false,
                "navLock": { "navId": NAV_IDS.STARPORT, "screenId": "market" }
            },
            {
                "stepId": "mission_2_2",
                "text": "This is the <b>Moon Market</b>.<br>On each commodity you will find a wealth of information to aid your trading.<br><br>The <b class='hl-green font-bold'>MKT</b> indicator will inform you of <b class='hl-green font-bold'>prices higher or lower than average.</b> Selecting the price will reveal past performance.<br><br>Select the <b class='hl-yellow font-bold'>Buy/Sell toggle</b> to transition to sale mode, and then sell your single unit of <b>Plasteel</b>.",
                size: { width: '400px', height: '150px' }, // UPDATED
                anchorElement: 'body', // UPDATED
                positionX: 50, // UPDATED
                positionY: 67, // UPDATED
                "completion": { "type": "ACTION", "action": "sell-item", "goodId": "plasteel" },
                "nextStepId": "mission_2_3",
                "isSkippable": false
            },
            {
                "stepId": "mission_2_3",
                "text": "<b class='hl-green font-bold'>Pure profit</b>!<br><br>However, you still need more <b class='hl-yellow font-bold'>credits</b>! Return to the <b>Mission Terminal</b> by selecting the <b>Data</b> tab.",
                size: { width: '400px', height: '150px' }, // UPDATED
                anchorElement: 'body', // UPDATED
                positionX: 50, // UPDATED
                positionY: 67, // UPDATED
                "completion": { "type": "SCREEN_LOAD", "screenId": "missions" },
                "nextStepId": "mission_2_4",
                "isSkippable": false,
                "navLock": { "navId": NAV_IDS.DATA, "screenId": "missions" }
            },
            {
                "stepId": "mission_2_4",
                "text": "This mission offers a <b class='hl-yellow font-bold'>credit</b> reward.<br><br>Accept the mission, <b>Martian Resupply</b>.",
                size: { width: '400px', height: 'auto' }, // UPDATED
                anchorElement: 'body', // UPDATED
                positionX: 50, // UPDATED
                positionY: 77, // UPDATED
                "completion": { "type": "ACTION", "action": "accept-mission", "missionId": "mission_tutorial_02" },
                "nextStepId": "mission_3_1",
                "isSkippable": false
            },
            {
                "stepId": "mission_3_1",
                "text": "To complete this mission you will need to <b>travel to Mars</b> after you have purchased <b>two Plasteel</b> from any <b>Market</b>.<br><br>After you have acquired the <b>Plasteel</b>, visit the <b>Mission</b> tab on <b>Mars</b> to submit the cargo and complete the mission. ",
                size: { width: '400px', height: '160px' }, // UPDATED
                anchorElement: 'body', // UPDATED
                positionX: 50, // UPDATED
                positionY: 83, // UPDATED
                "completion": { "type": "ACTION", "action": "complete-mission", "missionId": "mission_tutorial_02" },
                "nextStepId": "mission_final",
                "isSkippable": false,
                "navLock": null
            },
            {
                "stepId": "mission_final",
                "text": "Well done Captain {playerName}, you have successfully completed trades across the <b>Moon</b> and <b>Mars</b>.<br><br>Continue to trade commodities for <b class='hl-green font-bold'>favorable margins</b> and complete missions to unlock additional opportunities.<br><br><b>The Solar System awaits</b>!",
                size: { width: '400px', height: 'auto' }, // UPDATED
                anchorElement: 'body', // UPDATED
                positionX: 50, // UPDATED
                positionY: 29, // UPDATED
                "completion": { "type": "INFO" },
                "nextStepId": null,
                "isSkippable": false,
                "buttonText": "Complete Tutorial",
                "navLock": null
            }
        ]
    }
};
--- END OF FILE: ./js/data/tutorials.js ---

--- START OF FILE: ./js/services/ui/TravelAnimationService.js ---
// js/services/ui/TravelAnimationService.js
import { DB } from '../../data/database.js';

export class TravelAnimationService {
    constructor(isMobile) {
        this.isMobile = isMobile;
        this.modal = document.getElementById('travel-animation-modal');
        this.gameContainer = document.getElementById('game-container');
        this.canvas = document.getElementById('travel-canvas');
        this.ctx = this.canvas.getContext('2d');
        this.statusText = document.getElementById('travel-status-text');
        this.arrivalLore = document.getElementById('travel-arrival-lore');
        this.progressBar = document.getElementById('travel-progress-bar');
        this.progressContainer = document.getElementById('travel-progress-container');
        this.readoutContainer = document.getElementById('travel-readout-container');
        this.infoText = document.getElementById('travel-info-text');
        this.hullDamageText = document.getElementById('travel-hull-damage');
        this.confirmButton = document.getElementById('travel-confirm-button');
        
        this.animationFrame = null;
        this.starLayers = [];
        this.engineParticles = [];
        this.celestialObjects = [];
    }

    play(from, to, travelInfo, totalHullDamagePercent, finalCallback) {
        this.modal.classList.remove('hidden');
        this.modal.classList.add('dismiss-disabled');
        // this.gameContainer.classList.add('fade-out');


        const theme = to.navTheme || { gradient: 'linear-gradient(to right, #06b6d4, #67e8f9)', borderColor: '#06b6d4' };

        // Lighten the gradient for better visibility
        const lightenedGradient = this._lightenGradient(theme.gradient);
        this.progressBar.style.background = lightenedGradient;

        // Set the glow color for the progress bar
        this.progressBar.style.setProperty('--progress-glow-color', theme.borderColor);

        this._setupInitialState(to, travelInfo);
        this._setupAnimationElements(from, to);

        let startTime = null;
        const duration = 2500;

        const animate = (currentTime) => {
            if (!startTime) startTime = currentTime;
            const elapsedTime = currentTime - startTime;
            let progress = Math.min(elapsedTime / duration, 1);

            // Ease-out cubic for the slow-down effect at the end
            if (progress > 0.8) {
                const normalized = (progress - 0.8) / 0.2;
                progress = 0.8 + (1 - Math.pow(1 - normalized, 3)) * 0.2;
            }

            this._draw(progress, from, to);
            this.progressBar.style.width = `${progress * 100}%`;

            if (progress < 1) {
                this.animationFrame = requestAnimationFrame(animate);
            } else {
                this._onArrival(to, travelInfo, totalHullDamagePercent, finalCallback);
            }
        };

        this.animationFrame = requestAnimationFrame(animate);

        this.confirmButton.onclick = () => {
            cancelAnimationFrame(this.animationFrame);
        
            this.modal.classList.add('modal-hiding');
            
            // Execute the callback to render the market screen *before* the fade-in starts.
            if (finalCallback) {
                finalCallback();
            }

            // A short delay to ensure the market screen is rendered before the fade-in starts.
            setTimeout(() => {
                // this.gameContainer.classList.remove('fade-out');
                this.gameContainer.classList.add('fade-in');
            }, 50); // Small buffer

            setTimeout(() => {
                this.modal.classList.add('hidden');
                this.modal.classList.remove('modal-hiding', 'dismiss-disabled');
            }, 1000); // 1s to match CSS transition
        };
    }

    _lightenGradient(gradientString) {
        const colorStops = gradientString.match(/#[0-9a-f]{6}|#[0-9a-f]{3}/ig);
        if (!colorStops) return gradientString;

        const lightenHex = (hex, percent) => {
            hex = hex.replace(/^#/, '');
            if (hex.length === 3) {
                hex = hex.split('').map(c => c + c).join('');
            }
            const num = parseInt(hex, 16);
            let r = (num >> 16) + percent;
            if (r > 255) r = 255;
            if (r < 0) r = 0;
            let b = ((num >> 8) & 0x00FF) + percent;
            if (b > 255) b = 255;
            if (b < 0) b = 0;
            let g = (num & 0x0000FF) + percent;
            if (g > 255) g = 255;
            if (g < 0) g = 0;
            return '#' + (g | (b << 8) | (r << 16)).toString(16).padStart(6, '0');
        };
        
        const lightenedColors = colorStops.map(color => lightenHex(color, 40));
        return `linear-gradient(to right, ${lightenedColors.join(', ')})`;
    }


    _setupInitialState(to, travelInfo) {
        this.statusText.textContent = `Traveling to ${to.name}...`;
        this.arrivalLore.textContent = '';
        this.arrivalLore.style.opacity = 0;
        this.readoutContainer.classList.add('hidden');
        this.readoutContainer.style.opacity = 0;
        this.confirmButton.style.opacity = 0;
        this.confirmButton.disabled = true;
        this.progressBar.style.width = '0%';
    }

    _setupAnimationElements(from, to) {
        this.canvas.width = this.canvas.clientWidth;
        this.canvas.height = this.canvas.clientHeight;
        this.starLayers = [
            this._createStarLayer(80, 0.5, 0.8),
            this._createStarLayer(50, 1.2, 1.2),
            this._createStarLayer(20, 1.8, 2.0)
        ];
        this.engineParticles = [];

        this.backgroundGradient = this._getBackgroundGradient(from, to);
        this.celestialObjects = this._getCelestialObjects(from.id, to.id);
    }

    _createStarLayer(count, minSpeed, maxSpeed) {
        let stars = [];
        for (let i = 0; i < count; i++) {
            stars.push({
                x: Math.random() * this.canvas.width,
                y: Math.random() * this.canvas.height,
                radius: Math.random() * 1.5,
                speed: minSpeed + Math.random() * (maxSpeed - minSpeed),
                alpha: 0.5 + Math.random() * 0.5
            });
        }
        return stars;
    }

    _getBackgroundGradient(from, to) {
        const getZone = (location) => {
            for (const zoneName in DB.TRAVEL_VISUALS.zones) {
                if (DB.TRAVEL_VISUALS.zones[zoneName].locations.includes(location.id)) {
                    return DB.TRAVEL_VISUALS.zones[zoneName];
                }
            }
            return DB.TRAVEL_VISUALS.zones.inner_sphere; // Default fallback
        };
        const toZone = getZone(to);
        
        const gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
        gradient.addColorStop(0, toZone.gradient[0]);
        gradient.addColorStop(1, toZone.gradient[1]);
        return gradient;
    }

    _getCelestialObjects(fromId, toId) {
        const routeKey = `${fromId}_to_${toId}`;
        const objects = DB.TRAVEL_VISUALS.objects[routeKey] || [];
        return objects.map(obj => ({
            ...obj,
            x: this.canvas.width + Math.random() * 200,
            y: obj.position.y * this.canvas.height,
        }));
    }

    _draw(progress, from, to) {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.ctx.fillStyle = this.backgroundGradient;
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        this.starLayers.forEach((layer, index) => {
            const speedMultiplier = progress < 0.8 ? 1 : 1 - ((progress - 0.8) / 0.2);
            
            layer.forEach(star => {
                star.x -= star.speed * speedMultiplier;
                if (star.x < 0) star.x = this.canvas.width;
                this.ctx.beginPath();
                this.ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                this.ctx.globalAlpha = star.alpha;
                this.ctx.fillStyle = '#FFF';
                this.ctx.fill();
            });

            if (index === 1) {
                this.celestialObjects.forEach(obj => {
                    obj.x -= obj.speed * speedMultiplier;
                    this.ctx.font = `${40 * (obj.scale || 1)}px sans-serif`;
                    this.ctx.globalAlpha = 0.5;
                    this.ctx.fillText(obj.emoji, obj.x, obj.y);
                });
            }
        });
        this.ctx.globalAlpha = 1.0;

        const padding = 60;
        const startX = padding;
        const endX = this.canvas.width - padding;
        const y = this.canvas.height / 2;
        this.ctx.font = '42px sans-serif';
        this.ctx.textAlign = 'center';
        this.ctx.textBaseline = 'middle';
        this.ctx.fillText(DB.LOCATION_VISUALS[from.id] || '❓', startX, y);
        this.ctx.fillText(DB.LOCATION_VISUALS[to.id] || '❓', endX, y);
        
        const shipX = startX + (endX - startX) * progress;
        this.ctx.save();
        this.ctx.translate(shipX, y);
        this.ctx.font = '17px sans-serif';
        this.ctx.fillText('🚀', 0, 0);
        this.ctx.restore();

        this._updateEngineParticles(shipX, y);
        this._drawEngineParticles();
    }
    
    _updateEngineParticles(shipX, shipY) {
        if(Math.random() > 0.5) {
            this.engineParticles.push({
                x: shipX - 15,
                y: shipY + (Math.random() - 0.5) * 8,
                life: 1,
                speedX: -2 - Math.random() * 2,
                speedY: (Math.random() - 0.5) * 0.5,
                size: Math.random() * 2 + 1
            });
        }
        
        for (let i = this.engineParticles.length - 1; i >= 0; i--) {
            const p = this.engineParticles[i];
            p.x += p.speedX;
            p.y += p.speedY;
            p.life -= 0.05;
            if (p.life <= 0) {
                this.engineParticles.splice(i, 1);
            }
        }
    }
    
    _drawEngineParticles() {
        this.engineParticles.forEach(p => {
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            this.ctx.globalAlpha = p.life;
            this.ctx.fillStyle = `rgba(255, 220, 180, ${p.life})`;
            this.ctx.fill();
        });
        this.ctx.globalAlpha = 1.0;
    }

    _onArrival(to, travelInfo, totalHullDamagePercent, finalCallback) {
        this.statusText.textContent = `Arrived at ${to.name}`;
        this.arrivalLore.innerHTML = to.arrivalLore || "You have arrived.";
        this.infoText.innerHTML = `
            <div class="text-center">
                <div>Journey Time: ${travelInfo.time} Days</div>
                <div><span class="font-bold text-sky-300">Fuel Expended: ${travelInfo.fuelCost}</span></div>
            </div>`;
        this.hullDamageText.className = 'text-sm font-roboto-mono mt-1 font-bold text-red-400';
        if (totalHullDamagePercent > 0.01) {
            this.hullDamageText.innerHTML = `Hull Integrity -${totalHullDamagePercent.toFixed(2)}%`;
        } else {
            this.hullDamageText.innerHTML = '';
        }
        
        this.arrivalLore.style.opacity = 1;
        this.readoutContainer.classList.remove('hidden');
        setTimeout(() => {
            this.readoutContainer.style.opacity = 1;
            this.confirmButton.style.opacity = 1;
            this.confirmButton.disabled = false;
        }, 150);
    }
}
--- END OF FILE: ./js/services/ui/TravelAnimationService.js ---

--- START OF FILE: ./js/services/ui/AnimationService.js ---
// js/services/ui/AnimationService.js
/**
 * @fileoverview Provides generic, blocking animation utility functions.
 */

/**
 * Applies a CSS class to an element and returns a Promise
 * that resolves when the element's 'animationend' event fires.
 *
 * @param {HTMLElement | null} element - The DOM element to animate.
 * @param {string} animationClass - The CSS class that triggers the animation.
 * @returns {Promise<void>} A promise that resolves when the animation is complete.
 * @JSDoc
 */
export async function playBlockingAnimation(element, animationClass) {
    return new Promise((resolve) => {
        // Failsafe: If no element is provided, resolve immediately.
        if (!element) {
            console.warn('playBlockingAnimation: No element provided.');
            resolve();
             return;
        }

        const onAnimationEnd = () => {
            element.removeEventListener('animationend', onAnimationEnd);
            // The class remains on the element (due to 'forwards' in CSS).
            // The element will be naturally removed by the state change
            // and UI re-render that follows this promise resolving.
             resolve();
        };

        element.addEventListener('animationend', onAnimationEnd, { once: true });
        element.classList.add(animationClass);
    });
}

// --- [[START]] VIRTUAL WORKBENCH ---
/**
 * Applies a CSS class to an element and automatically removes it
 * when the animation completes. This is a non-blocking "fire-and-forget"
 * animation, unlike playBlockingAnimation.
 *
 * @param {HTMLElement | null} element - The DOM element to animate.
 * @param {string} animationClass - The CSS class that triggers the animation.
 * @JSDoc
 */
export function playAndRemoveAnimation(element, animationClass) {
    // Failsafe: If no element is provided, do nothing.
    if (!element) {
        console.warn('playAndRemoveAnimation: No element provided.');
        return;
    }

    const onAnimationEnd = () => {
        element.removeEventListener('animationend', onAnimationEnd);
        element.classList.remove(animationClass);
    };

    element.addEventListener('animationend', onAnimationEnd, { once: true });
    element.classList.add(animationClass);
}

/**
 * (NEW) Applies a CSS class, awaits the animation's completion,
 * and then removes the class. This is a BLOCKING "fire-and-forget"
 * that is perfect for sequential effects.
 *
 * @param {HTMLElement | null} element - The DOM element to animate.
 * @param {string} animationClass - The CSS class that triggers the animation.
 * @returns {Promise<void>} A promise that resolves when the animation is complete
 * and the class has been removed.
 * @JSDoc
 */
export async function playBlockingAnimationAndRemove(element, animationClass) {
    return new Promise((resolve) => {
        // Failsafe: If no element is provided, resolve immediately.
        if (!element) {
            console.warn('playBlockingAnimationAndRemove: No element provided.');
            resolve();
             return;
        }

        const onAnimationEnd = () => {
            element.removeEventListener('animationend', onAnimationEnd);
            element.classList.remove(animationClass); // Automatically remove class
             resolve();
        };

        element.addEventListener('animationend', onAnimationEnd, { once: true });
        element.classList.add(animationClass);
    });
}
// --- [[END]] VIRTUAL WORKBENCH ---
--- END OF FILE: ./js/services/ui/AnimationService.js ---

--- START OF FILE: ./js/services/DebugService.js ---
// js/services/DebugService.js
/**
 * @fileoverview This file contains the DebugService class, which is responsible for creating and managing
 * the lil-gui developer panel for real-time testing and manipulation of the game state.
 */
import { DB } from '../data/database.js';
import { LOCATION_IDS, SHIP_IDS, NAV_IDS, SCREEN_IDS, COMMODITY_IDS } from '../data/constants.js';
import { Logger } from './LoggingService.js';
import { calculateInventoryUsed } from '../utils.js';
import { AutomatedPlayer } from './bot/AutomatedPlayerService.js'; // [GEMINI] ADDED IMPORT

// --- [[START]] NEW PRESET MAPPING ---
// Mapping preset names to their new [X%, Y%] values
const TUTORIAL_PRESETS_PERCENT = {
    topCenter: [50, 15], // Example: 50% across, 15% down
    top34Center: [50, 30],
    vertHorizCenter: [50, 50],
    bottom34Center: [50, 70],
    bottomCenter: [50, 85],
    bottomLeft: [15, 85],
    topLeft: [15, 15],
};
// --- [[END]] NEW PRESET MAPPING ---


// [GEMINI] REMOVED ENTIRE 200+ LINE AutomatedPlayer CLASS
// The class definition has been moved to js/services/bot/AutomatedPlayerService.js


export class DebugService {
    /**
     * @param {import('./GameState.js').GameState} gameState The central game state object.
     * @param {import('./SimulationService.js').SimulationService} simulationService The core game logic engine.
     * @param {import('./UIManager.js').UIManager} uiManager The UI rendering service.
     * @param {import('./LoggingService.js').Logger} logger The logging utility.
     */
    constructor(gameState, simulationService, uiManager, logger) {
        this.gameState = gameState;
        this.simulationService = simulationService;
        this.uiManager = uiManager;
        this.logger = logger;
        this.gui = null;
        this.active = false;
        this.diagActive = false;
        this.diagElements = {};
        this.actions = {};
        
        // --- State for GUI controllers ---
        this.debugState = {
            creditsToAdd: 100000,
            creditsToReduce: 100000,
            selectedLocation: this.gameState.currentLocationId,
            daysToAdvance: 7,
            selectedRandomEvent: 0,
            selectedAgeEvent: DB.AGE_EVENTS[0].id,
            selectedMission: Object.values(DB.MISSIONS)[0]?.id || null,
            botDaysToRun: 365,
             botStrategy: 'MIXED', // [GEMINI] ADDED
            botProgress: 'Idle',
            logLevel: 'INFO',
            // Tutorial Tuner State
            ttStepId: 'None',
            ttAnchor: 'N/A',
            ttPlacement: 'auto',
            ttOffsetDistance: 0,
            ttOffsetSkidding: 0,
            ttPercentX: 50,
            ttPercentY: 50,
            ttWidth: 0,
            ttHeight: 0,
            ttGeneratedCode: ''
        }; 
        // --- End State ---

        this.bot = new AutomatedPlayer(gameState, simulationService, logger);

        // References to GUI controllers and folders for enabling/disabling
         this.tutorialPositionalControllers = {};
    }

    /**
     * Initializes the debug panel.
     */
    init() {
        if (this.gui) return;
        this._cacheDiagElements();
        this.gui = new lil.GUI({ draggable: true, title: 'Debug Menu' });
        this.gui.domElement.id = 'debug-panel';
        this._registerDebugActions();
        this.buildGui();
        this._startDiagLoop();
    }

    /**
     * Handles key presses forwarded from the EventManager.
     * @param {string} key
     */
    handleKeyPress(key) {
        // No longer needed as all shortcuts are removed.
    }

    /**
     * Toggles the visibility of the debug panel UI.
     */
    toggleVisibility() {
        if (!this.gui) return;
        this.active = !this.active;
        this.gui.domElement.classList.toggle('debug-visible', this.active);
    }

    toggleDiagnosticOverlay() {
        this.diagActive = !this.diagActive;
        const overlay = document.getElementById('diagnostic-overlay');
        if (overlay) {
            overlay.classList.toggle('hidden', !this.diagActive);
        }
    }

    /**
     * Gathers and copies a bug report to the clipboard.
     */
    generateBugReport() {
        const logHistory = this.logger.getLogHistory();
        const gameState = this.gameState.getState();

        delete gameState.TRAVEL_DATA;
        delete gameState.market.priceHistory;

        const report = `
ORBITAL TRADING - BUG REPORT
==============================
Date: ${new Date().toISOString()}

--- GAME STATE SNAPSHOT ---
${JSON.stringify(gameState, null, 2)}

--- RECENT LOG HISTORY ---
${logHistory}
        `;

        navigator.clipboard.writeText(report.trim())
            .then(() => {
                this.uiManager.createFloatingText('Bug Report Copied to Clipboard!', window.innerWidth / 2, window.innerHeight / 2, '#4ade80');
            })
            .catch(err => {
                this.logger.error('DebugService', 'Failed to copy bug report.', err);
            });
    }

    // --- GAME FLOW & CHEAT METHODS ---
    godMode() {
        this.logger.warn('DebugService', 'GOD MODE ACTIVATED.');
        this.gameState.introSequenceActive = false;
        this.simulationService.tutorialService.activeBatchId = null;
        this.simulationService.tutorialService.activeStepId = null;
        this.gameState.tutorials.activeBatchId = null;
        this.gameState.tutorials.activeStepId = null;
        this.gameState.tutorials.skippedTutorialBatches = Object.keys(DB.TUTORIAL_DATA);

        // --- VIRTUAL WORKBENCH: APPLY CREDIT CAP ---
        this.gameState.player.credits = Number.MAX_SAFE_INTEGER;
        // --- END VIRTUAL WORKBENCH ---

        this.gameState.player.ownedShipIds = [];
        this.simulationService.addShipToHangar(SHIP_IDS.BEHEMOTH);
        this.gameState.player.activeShipId = SHIP_IDS.BEHEMOTH;

        this.gameState.player.revealedTier = 7;
        this.gameState.player.unlockedLicenseIds = Object.keys(DB.LICENSES);
        this.gameState.player.unlockedLocationIds = DB.MARKETS.map(m => m.id);

        this.uiManager.showGameContainer();
        this.simulationService.setScreen(NAV_IDS.STARPORT, SCREEN_IDS.MARKET);
        this.simulationService.timeService.advanceDays(7);
        this.gameState.setState({});
    }

    simpleStart() {
         this.logger.warn('DebugService', 'SIMPLE START ACTIVATED.');
        this.gameState.introSequenceActive = false;
        this.simulationService.tutorialService.activeBatchId = null;
        this.simulationService.tutorialService.activeStepId = null;
        this.gameState.tutorials.activeBatchId = null;
        this.gameState.tutorials.activeStepId = null;
        this.gameState.tutorials.skippedTutorialBatches = Object.keys(DB.TUTORIAL_DATA);
        this.gameState.player.ownedShipIds = [];
        this.simulationService.addShipToHangar(SHIP_IDS.WANDERER);
        this.gameState.player.activeShipId = SHIP_IDS.WANDERER;
        this.uiManager.showGameContainer();
        this.simulationService.setScreen(NAV_IDS.DATA, SCREEN_IDS.MISSIONS);
        this.simulationService.timeService.advanceDays(7);
        this.gameState.setState({});
    }

    skipToHangarTutorial() {
        this.logger.warn('DebugService', 'SKIP TO HANGAR TUTORIAL ACTIVATED.');
        this.gameState.introSequenceActive = true;

        this.simulationService.tutorialService.activeBatchId = null;
        this.simulationService.tutorialService.activeStepId = null;
        this.gameState.tutorials.activeBatchId = null;
        this.gameState.tutorials.activeStepId = null;
        this.gameState.tutorials.skippedTutorialBatches = [];

        this.gameState.player.credits = 25000;
        this.gameState.player.ownedShipIds = [];
        this.gameState.player.activeShipId = null;
        this.gameState.player.shipStates = {};
        this.gameState.player.inventories = {};

        this.uiManager.showGameContainer();
        this.simulationService.setScreen(NAV_IDS.STARPORT, SCREEN_IDS.HANGAR);
        this.simulationService.tutorialService.triggerBatch('intro_hangar', 'hangar_1');
        this.gameState.setState({});
    }

    // --- NEW SHIP-SPECIFIC HANDLERS ---
    deductHull(amount) {
         const ship = this.simulationService._getActiveShip();
        if (ship) {
            const shipState = this.gameState.player.shipStates[ship.id];
            shipState.health = Math.max(0, shipState.health - amount);
            this.logger.warn('DebugService', `Deducted ${amount} hull from ${ship.name}.`);
            this.gameState.setState({});
        }
    }

    restoreHull() {
        const ship = this.simulationService._getActiveShip();
        if (ship) {
            const shipState = this.gameState.player.shipStates[ship.id];
            shipState.health = ship.maxHealth;
            this.logger.warn('DebugService', `Restored hull for ${ship.name}.`);
            this.gameState.setState({});
        }
    }

    destroyShip() {
        const ship = this.simulationService._getActiveShip();
        if (ship) {
            const shipState = this.gameState.player.shipStates[ship.id];
            shipState.health = 0;
            this.logger.warn('DebugService', `Destroyed ${ship.name}.`);
            this.simulationService.travelService._handleShipDestruction(ship.id);
        }
    }

    deductFuel(amount) {
        const ship = this.simulationService._getActiveShip();
        if (ship) {
            const shipState = this.gameState.player.shipStates[ship.id];
            shipState.fuel = Math.max(0, shipState.fuel - amount);
            this.logger.warn('DebugService', `Deducted ${amount} fuel from ${ship.name}.`);
            this.gameState.setState({});
        }
    }

    restoreFuel() {
        const ship = this.simulationService._getActiveShip();
        if (ship) {
             const shipState = this.gameState.player.shipStates[ship.id];
            shipState.fuel = ship.maxFuel;
            this.logger.warn('DebugService', `Restored fuel for ${ship.name}.`);
            this.gameState.setState({});
        }
    }

    removeAllCargo() {
        const inventory = this.simulationService._getActiveInventory();
        if (inventory) {
            for (const goodId in inventory) {
                inventory[goodId].quantity = 0;
                inventory[goodId].avgCost = 0;
            }
            this.logger.warn('DebugService', 'All cargo removed from active ship.');
            this.gameState.setState({});
        }
    }

    fillWithCybernetics() {
         const ship = this.simulationService._getActiveShip();
        const inventory = this.simulationService._getActiveInventory();
        if (ship && inventory) {
            this.removeAllCargo();
            const space = ship.cargoCapacity - calculateInventoryUsed(inventory);
            if (!inventory[COMMODITY_IDS.CYBERNETICS]) {
                inventory[COMMODITY_IDS.CYBERNETICS] = { quantity: 0, avgCost: 0 };
            }
            inventory[COMMODITY_IDS.CYBERNETICS].quantity = space;
            this.logger.warn('DebugService', `Filled cargo with ${space} Cybernetics.`);
            this.gameState.setState({});
        }
    }

    grantAllItems() {
        const inventory = this.simulationService._getActiveInventory();
        if (!inventory) {
             this.logger.warn('DebugService', 'Cannot grant items: No active inventory found.');
            return;
        }
        DB.COMMODITIES.forEach(commodity => {
            if (inventory[commodity.id]) {
                inventory[commodity.id].quantity += 1;
            } else {
                inventory[commodity.id] = { quantity: 1, avgCost: 0 };
            }
         });
        this.logger.warn('DebugService', 'Debug: Granted 1x of all commodities.');
        this.gameState.setState({});
    }

    fillShipyard() {
        const { currentLocationId, day } = this.gameState;
        if (this.gameState.market.shipyardStock[currentLocationId]) {
            const allShipIds = Object.keys(DB.SHIPS);
            this.gameState.market.shipyardStock[currentLocationId] = {
                day: day,
                shipsForSale: allShipIds
            };
            this.logger.warn('DebugService', `SHIPYARD FILLED: All ships added to ${currentLocationId}.`);
            this.gameState.setState({});
        } else {
            this.logger.error('DebugService', `Cannot fill shipyard: No stock object for ${currentLocationId}.`);
        }
    }


    /**
     * @private
     */
    _registerDebugActions() {
        this.actions = {
            godMode: { name: 'God Mode', type: 'button', handler: () => this.godMode() },
            simpleStart: { name: 'Simple Start', type: 'button', handler: () => this.simpleStart() },
             skipToHangarTutorial: { name: 'Skip to Hangar Tutorial', type: 'button', handler: () => this.skipToHangarTutorial() },
            addCredits: { name: 'Add Credits', type: 'button', handler: () => {
                // --- VIRTUAL WORKBENCH: APPLY CREDIT CAP ---
                this.gameState.player.credits = Math.min(Number.MAX_SAFE_INTEGER, this.gameState.player.credits + this.debugState.creditsToAdd);
                // --- END VIRTUAL WORKBENCH ---
                this.simulationService.timeService._checkMilestones();
                this.gameState.setState({});
            }},
            reduceCredits: { name: 'Reduce Credits', type: 'button', handler: () => {
                this.gameState.player.credits -= this.debugState.creditsToReduce;
                this.simulationService._checkGameOverConditions();
                this.gameState.setState({});
            }},
             payDebt: { name: 'Pay Off Debt', type: 'button', handler: () => this.simulationService.playerActionService.payOffDebt() },
            teleport: { name: 'Teleport', type: 'button', handler: () => {
                if (this.debugState.selectedLocation) {
                    this.gameState.currentLocationId = this.debugState.selectedLocation;
                    this.gameState.setState({});
                }
            }},
            unlockAll: { name: 'Unlock All', type: 'button', handler: () => {
                this.gameState.player.unlockedLocationIds = DB.MARKETS.map(m => m.id);
                this.gameState.player.revealedTier = 7;
                this.gameState.player.unlockedLicenseIds = Object.keys(DB.LICENSES);
                this.gameState.setState({});
            }},
            grantAllShips: { name: 'Grant All Ships', type: 'button', handler: () => {
                Object.keys(DB.SHIPS).forEach(shipId => {
                    if (!this.gameState.player.ownedShipIds.includes(shipId)) {
                         this.simulationService.addShipToHangar(shipId);
                    }
                });
                this.gameState.setState({});
            }},
            advanceTime: { name: 'Advance Days', type: 'button', handler: () => this.simulationService.timeService.advanceDays(this.debugState.daysToAdvance) },
            replenishStock: { name: 'Replenish All Stock', type: 'button', handler: () => {
                 this.simulationService.marketService.replenishMarketInventory();
                this.gameState.setState({});
            }},
            // --- VIRTUAL WORKBENCH REMOVAL ---
            // 'addAllIntel' action removed
            // --- END REMOVAL ---
            triggerRandomEvent: { name: 'Trigger Random Event', type: 'button', handler: () => {
                const dest = DB.MARKETS.find(m => m.id !== this.gameState.currentLocationId)?.id;
                if (dest) {
                     this.simulationService.travelService._checkForRandomEvent(dest, this.debugState.selectedRandomEvent);
                }
            }},
            triggerAgeEvent: { name: 'Trigger Age Event', type: 'button', handler: () => {
                const event = DB.AGE_EVENTS.find(e => e.id === this.debugState.selectedAgeEvent);
                if (event) {
                    this.uiManager.showAgeEventModal(event, (choice) => this.simulationService._applyPerk(choice));
                }
            }},
             triggerMission: { name: 'Trigger Mission', type: 'button', handler: () => {
                if (this.debugState.selectedMission) {
                    if(this.gameState.missions.activeMissionId) {
                        this.simulationService.missionService.abandonMission();
                    }
                    this.simulationService.missionService.acceptMission(this.debugState.selectedMission);
                }
             }},
            startBot: { name: 'Start AUTOTRADER-01', type: 'button', handler: () => {
                const progressController = this.gui.controllers.find(c => c.property === 'botProgress');
                
                // [GEMINI] MODIFIED: Pass strategy from debugState
                const config = {
                    daysToRun: this.debugState.botDaysToRun,
                     strategy: this.debugState.botStrategy 
                };
                
                this.bot.runSimulation(config, (current, end) => {
                    if(progressController) progressController.setValue(`${current} / ${end}`).updateDisplay();
                });
            }},
            stopBot: { name: 'Stop AUTOTRADER-01', type: 'button', handler: () => this.bot.stop() },

            // NEW & MOVED SHIP ACTIONS
            fillShipyard: { name: 'Fill Shipyard w/ All Ships', type: 'button', handler: () => this.fillShipyard() },
            deductHull20: { name: 'Deduct 20 Hull', type: 'button', handler: () => this.deductHull(20) },
            restoreHull: { name: 'Restore Hull', type: 'button', handler: () => this.restoreHull() },
            destroyShip: { name: 'Destroy Current Ship', type: 'button', handler: () => this.destroyShip() },
             deductFuel20: { name: 'Deduct 20 Fuel', type: 'button', handler: () => this.deductFuel(20) },
            restoreFuel: { name: 'Restore Fuel', type: 'button', handler: () => this.restoreFuel() },
            removeAllCargo: { name: 'Remove All Cargo', type: 'button', handler: () => this.removeAllCargo() },
            grantAllItems: { name: 'Grant 1x All Items', type: 'button', handler: () => this.grantAllItems() },
            fillWithCybernetics: { name: 'Fill w/ Cybernetics', type: 'button', handler: () => this.fillWithCybernetics() },

            // --- [[START]] TUTORIAL TUNER ACTIONS ---
            generateTutorialCode: { name: 'Generate Code', type: 'button', handler: () => this._generateTutorialCode() },
            // --- Presets (Now using keys from TUTORIAL_PRESETS_PERCENT) ---
            presetTopCenter: { name: 'Top Center', type: 'button', handler: () => this._applyTutorialPreset('topCenter') },
            presetTop34Center: { name: 'Top 3/4 Center', type: 'button', handler: () => this._applyTutorialPreset('top34Center') },
             presetVertHorizCenter: { name: 'V/H Center', type: 'button', handler: () => this._applyTutorialPreset('vertHorizCenter') },
            presetBottom34Center: { name: 'Bottom 3/4 Center', type: 'button', handler: () => this._applyTutorialPreset('bottom34Center') },
            presetBottomCenter: { name: 'Bottom Center', type: 'button', handler: () => this._applyTutorialPreset('bottomCenter') },
            presetBottomLeft: { name: 'Bottom Left', type: 'button', handler: () => this._applyTutorialPreset('bottomLeft') },
            presetTopLeft: { name: 'Top Left', type: 'button', handler: () => this._applyTutorialPreset('topLeft') },
            // --- [[END]] TUTORIAL TUNER ACTIONS ---
        };
    }

    _cacheDiagElements() {
        this.diagElements = {
            winW: document.getElementById('diag-window-w'),
            winH: document.getElementById('diag-window-h'),
            visualVpW: document.getElementById('diag-visual-vp-w'),
            visualVpH: document.getElementById('diag-visual-vp-h'),
            gameW: document.getElementById('diag-game-container-w'),
            gameH: document.getElementById('diag-game-container-h'),
            bodyW: document.getElementById('diag-body-w'),
            bodyH: document.getElementById('diag-body-h'),
            pixelRatio: document.getElementById('diag-pixel-ratio'),
            displayMode: document.getElementById('diag-display-mode'),
            day: document.getElementById('diag-day'),
            navScreen: document.getElementById('diag-nav-screen'),
            tutorialBatch: document.getElementById('diag-tutorial-batch'),
             tutorialStep: document.getElementById('diag-tutorial-step'),
        };
    }

    _startDiagLoop() {
        const update = () => {
            this._updateDiagOverlay();
            requestAnimationFrame(update);
        };
        requestAnimationFrame(update);
    }

    _updateDiagOverlay() {
        if (!this.diagActive) return;

        const state = this.gameState.getState();
        const gameContainer = document.getElementById('game-container');

        this.diagElements.winW.textContent = window.innerWidth;
        this.diagElements.winH.textContent = window.innerHeight;

        if (window.visualViewport) {
            this.diagElements.visualVpW.textContent = Math.round(window.visualViewport.width);
            this.diagElements.visualVpH.textContent = Math.round(window.visualViewport.height);
        }

        this.diagElements.gameW.textContent = gameContainer.clientWidth;
        this.diagElements.gameH.textContent = gameContainer.clientHeight;
        this.diagElements.bodyW.textContent = document.body.clientWidth;
        this.diagElements.bodyH.textContent = document.body.clientHeight;
        this.diagElements.pixelRatio.textContent = window.devicePixelRatio.toFixed(2);
        this.diagElements.displayMode.textContent = window.matchMedia('(display-mode: standalone)').matches ? 'standalone' : 'browser';
        this.diagElements.day.textContent = state.day;
        this.diagElements.navScreen.textContent = `${state.activeNav} / ${state.activeScreen}`;
        this.diagElements.tutorialBatch.textContent = state.tutorials.activeBatchId || 'none';
        this.diagElements.tutorialStep.textContent = state.tutorials.activeStepId || 'none';
    }

    /**
     * @private
     */
    buildGui() {
        const flowFolder = this.gui.addFolder('Game Flow');
        flowFolder.add(this.actions.godMode, 'handler').name(this.actions.godMode.name);
        flowFolder.add(this.actions.simpleStart, 'handler').name(this.actions.simpleStart.name);
        flowFolder.add(this.actions.skipToHangarTutorial, 'handler').name(this.actions.skipToHangarTutorial.name);

        const playerFolder = this.gui.addFolder('Player');
        playerFolder.add(this.debugState, 'creditsToAdd').name('Credits Amount');
        playerFolder.add(this.actions.addCredits, 'handler').name('Add Credits');
        playerFolder.add(this.debugState, 'creditsToReduce', 100, 1000000, 100).name('Credits to Reduce');
        playerFolder.add(this.actions.reduceCredits, 'handler').name('Reduce Credits');
        playerFolder.add(this.actions.payDebt, 'handler').name(this.actions.payDebt.name);

        const shipFolder = this.gui.addFolder('Ship');
        const locationOptions = DB.MARKETS.reduce((acc, loc) => ({...acc, [loc.name]: loc.id }), {});
        shipFolder.add(this.debugState, 'selectedLocation', locationOptions).name('Location');
        shipFolder.add(this.actions.teleport, 'handler').name('Teleport');
        shipFolder.add(this.actions.deductHull20, 'handler').name(this.actions.deductHull20.name);
        shipFolder.add(this.actions.restoreHull, 'handler').name(this.actions.restoreHull.name);
        shipFolder.add(this.actions.destroyShip, 'handler').name(this.actions.destroyShip.name);
        shipFolder.add(this.actions.deductFuel20, 'handler').name(this.actions.deductFuel20.name);
        shipFolder.add(this.actions.restoreFuel, 'handler').name(this.actions.restoreFuel.name);
        shipFolder.add(this.actions.removeAllCargo, 'handler').name(this.actions.removeAllCargo.name);
        shipFolder.add(this.actions.grantAllItems, 'handler').name(this.actions.grantAllItems.name);
        shipFolder.add(this.actions.fillWithCybernetics, 'handler').name(this.actions.fillWithCybernetics.name);
        shipFolder.add(this.actions.fillShipyard, 'handler').name(this.actions.fillShipyard.name);
        shipFolder.add(this.actions.grantAllShips, 'handler').name('Grant All Ships');

        const worldFolder = this.gui.addFolder('World & Time');
        worldFolder.add(this.debugState, 'daysToAdvance', 1, 365, 1).name('Days to Advance');
        worldFolder.add(this.actions.advanceTime, 'handler').name('Advance Time');

        this.economyFolder = this.gui.addFolder('Economy'); // [GEMINI] Stored ref
        this.economyFolder.add(this.actions.replenishStock, 'handler').name(this.actions.replenishStock.name);
        this.economyFolder.add(this.actions.unlockAll, 'handler').name('Unlock Tiers/Locations');
        // --- VIRTUAL WORKBENCH REMOVAL ---
        // The 'addAllIntel' button has been removed from this folder.
        // --- END REMOVAL ---

        const triggerFolder = this.gui.addFolder('Triggers');
        const randomEventOptions = DB.RANDOM_EVENTS.reduce((acc, event, index) => ({...acc, [event.title]: index }), {});
        triggerFolder.add(this.debugState, 'selectedRandomEvent', randomEventOptions).name('Random Event');
        triggerFolder.add(this.actions.triggerRandomEvent, 'handler').name('Trigger Event');
        const ageEventOptions = DB.AGE_EVENTS.reduce((acc, event) => ({...acc, [event.title]: event.id }), {});
        triggerFolder.add(this.debugState, 'selectedAgeEvent', ageEventOptions).name('Age Event');
        triggerFolder.add(this.actions.triggerAgeEvent, 'handler').name('Trigger Event');
        const missionOptions = Object.values(DB.MISSIONS).reduce((acc, m) => ({...acc, [m.name]: m.id}), {});
        if (this.debugState.selectedMission) {
             triggerFolder.add(this.debugState, 'selectedMission', missionOptions).name('Mission');
             triggerFolder.add(this.actions.triggerMission, 'handler').name('Accept Mission');
        }

        // --- [[START]] TUTORIAL TUNER FOLDER ---
        const tutorialFolder = this.gui.addFolder('Tutorial Tuner');
        tutorialFolder.domElement.classList.add('tutorial-tuner-folder');

        tutorialFolder.add(this.debugState, 'ttStepId').name('Step ID').listen().disable();
        tutorialFolder.add(this.debugState, 'ttAnchor').name('Anchor').listen().disable();

        // --- Size Tuners ---
        tutorialFolder.add(this.debugState, 'ttWidth', 0, 800, 10).name('Width (0=auto)').onChange(() => this._handleTutorialTune());
        tutorialFolder.add(this.debugState, 'ttHeight', 0, 800, 10).name('Height (0=auto)').onChange(() => this._handleTutorialTune());

        // --- Position Tuners (Conditional) ---
        // Store references to controllers
        this.tutorialPositionalControllers.percentX = tutorialFolder.add(this.debugState, 'ttPercentX', 0, 100, 1).name('X %').onChange(() => this._handleTutorialTune());
        this.tutorialPositionalControllers.percentY = tutorialFolder.add(this.debugState, 'ttPercentY', 0, 100, 1).name('Y %').onChange(() => this._handleTutorialTune());
        this.tutorialPositionalControllers.placement = tutorialFolder.add(this.debugState, 'ttPlacement').name('Placement (Elem)').onChange(() => this._handleTutorialTune());
        this.tutorialPositionalControllers.distance = tutorialFolder.add(this.debugState, 'ttOffsetDistance', -500, 500, 1).name('Distance (Elem)').onChange(() => this._handleTutorialTune());
        this.tutorialPositionalControllers.skidding = tutorialFolder.add(this.debugState, 'ttOffsetSkidding', -500, 500, 1).name('Skidding (Elem)').onChange(() => this._handleTutorialTune());

        // --- Position Presets ---
        const presetFolder = tutorialFolder.addFolder('Position Presets');
        presetFolder.add(this.actions.presetTopCenter, 'handler').name(this.actions.presetTopCenter.name);
        presetFolder.add(this.actions.presetTop34Center, 'handler').name(this.actions.presetTop34Center.name);
        presetFolder.add(this.actions.presetVertHorizCenter, 'handler').name(this.actions.presetVertHorizCenter.name);
        presetFolder.add(this.actions.presetBottom34Center, 'handler').name(this.actions.presetBottom34Center.name);
        presetFolder.add(this.actions.presetBottomCenter, 'handler').name(this.actions.presetBottomCenter.name);
        presetFolder.add(this.actions.presetBottomLeft, 'handler').name(this.actions.presetBottomLeft.name);
        presetFolder.add(this.actions.presetTopLeft, 'handler').name(this.actions.presetTopLeft.name);
        // ** Store reference to the FOLDER INSTANCE itself **
        this.tutorialPositionalControllers.presetFolder = presetFolder;

        // --- Code Generator ---
        tutorialFolder.add(this.actions.generateTutorialCode, 'handler').name(this.actions.generateTutorialCode.name);
        tutorialFolder.add(this.debugState, 'ttGeneratedCode').name('Code').listen();

        // Initial state update for controls
        this._updateTutorialControlVisibility(false); // Assume initially no step is active
        // --- [[END]] TUTORIAL TUNER FOLDER ---

        const automationFolder = this.gui.addFolder('Automation & Logging');
        automationFolder.add(this, 'toggleDiagnosticOverlay').name('Toggle HUD Diagnostics');
        automationFolder.add(this.debugState, 'logLevel', ['DEBUG', 'INFO', 'WARN', 'ERROR', 'NONE']).name('Log Level').onChange(v => this.logger.setLevel(v));
        automationFolder.add(this, 'generateBugReport').name('Generate Bug Report');
        
        // --- [GEMINI] MODIFIED: Added PROSPECTOR strategy ---
        automationFolder.add(this.debugState, 'botStrategy', ['MIXED', 'HONEST_TRADER', 'MANIPULATOR', 'DEPLETE_ONLY', 'PROSPECTOR']).name('Bot Strategy');
        // --- End Modification ---
        
        automationFolder.add(this.debugState, 'botDaysToRun', 1, 10000, 1).name('Simulation Days');
        automationFolder.add(this.actions.startBot, 'handler').name(this.actions.startBot.name);
        automationFolder.add(this.actions.stopBot, 'handler').name(this.actions.stopBot.name);
        automationFolder.add(this.debugState, 'botProgress').name('Progress').listen();

        this.gui.folders.forEach(folder => folder.close());
    }

    // --- [[START]] TUTORIAL TUNER METHODS ---

    /**
     * Parses a size value (e.g., 'auto', '300px', 300) into a number for the slider.
     * @param {string|number|undefined} sizeValue - The value from the step definition.
     * @returns {number} A number, with 0 representing 'auto'.
     * @private
     */
    _parseSize(sizeValue) {
        if (!sizeValue || sizeValue === 'auto') return 0;
        if (typeof sizeValue === 'number') return sizeValue;
        if (typeof sizeValue === 'string') {
            const parsed = parseInt(sizeValue, 10);
            return isNaN(parsed) ? 0 : parsed;
        }
        return 0;
    }

    /**
     * Applies a position preset to the tuner sliders based on anchoring mode.
     * @param {string} presetKey - Key corresponding to TUTORIAL_PRESETS_PERCENT.
     * @private
     */
    _applyTutorialPreset(presetKey) {
        const isOverlayAnchor = this.debugState.ttAnchor === 'body'; // Using 'body' as proxy for overlay

        if (isOverlayAnchor) {
            const percentValues = TUTORIAL_PRESETS_PERCENT[presetKey];
            if (percentValues) {
                this.debugState.ttPercentX = percentValues[0];
                this.debugState.ttPercentY = percentValues[1];
                this.tutorialPositionalControllers.percentX?.updateDisplay();
                this.tutorialPositionalControllers.percentY?.updateDisplay();
            } else {
                 this.logger.warn('DebugService', `Preset key "${presetKey}" not found for percentage presets.`);
            }
         } else {
            // Placeholder: Need to define offset presets if required for element anchors
            this.logger.warn('DebugService', 'Offset presets not yet defined for element anchors.');
            // Example:
            // const offsetValues = TUTORIAL_PRESETS_OFFSET[presetKey];
            // if (offsetValues) {
            //     this.debugState.ttOffsetSkidding = offsetValues[0];
            //     this.debugState.ttOffsetDistance = offsetValues[1];
            //     this.tutorialPositionalControllers.skidding?.updateDisplay();
            //     this.tutorialPositionalControllers.distance?.updateDisplay();
            // }
        }

        // Trigger UI update
        this._handleTutorialTune();
    }

    /**
     * Shows/hides tutorial tuner controls based on anchor type using lil-gui methods.
     * @param {boolean} isOverlayAnchor - True if the toast should use percentage positioning.
     * @private
     */
    _updateTutorialControlVisibility(isOverlayAnchor) {
         // Helper function using lil-gui's show() / hide()
         const setVisibility = (controller, shouldShow) => {
             if (controller) {
                 controller.show(shouldShow);
             }
         };

         // Percentage controls
         setVisibility(this.tutorialPositionalControllers.percentX, isOverlayAnchor);
         setVisibility(this.tutorialPositionalControllers.percentY, isOverlayAnchor);

         // Popper offset controls
         setVisibility(this.tutorialPositionalControllers.placement, !isOverlayAnchor);
         setVisibility(this.tutorialPositionalControllers.distance, !isOverlayAnchor);
         setVisibility(this.tutorialPositionalControllers.skidding, !isOverlayAnchor);

         // Preset folder visibility (Show only for overlay anchors for now)
         if (this.tutorialPositionalControllers.presetFolder) {
              this.tutorialPositionalControllers.presetFolder.show(isOverlayAnchor);
         }
     }


    /**
     * Populates the Tutorial Tuner with the active step's data.
     * Called by UIManager when a toast is shown.
     * @param {object} step - The tutorial step object.
     */
    setActiveTutorialStep(step) {
        this.logger.info.system('DebugService', `Setting active tutorial step: ${step.stepId}`);
        const isOverlayAnchor = step.anchorElement === 'body'; // Use 'body' to signify overlay anchor

        // Reset generated code
        this.debugState.ttGeneratedCode = '';

        // Update state
        this.debugState.ttStepId = step.stepId;
        this.debugState.ttAnchor = step.anchorElement; // Keep original anchor for info
        this.debugState.ttWidth = this._parseSize(step.size?.width) || 0;
        this.debugState.ttHeight = this._parseSize(step.size?.height) || 0;

        if (isOverlayAnchor) {
            // Use percentage position from step or default to center
            this.debugState.ttPercentX = step.positionX ?? 50;
            this.debugState.ttPercentY = step.positionY ?? 50;
            // Reset/default Popper values for clarity
            this.debugState.ttPlacement = 'auto';
            this.debugState.ttOffsetDistance = 0;
            this.debugState.ttOffsetSkidding = 0;
        } else {
            // Use Popper settings from step or defaults
            const offsetMod = step.popperOptions?.modifiers?.find(m => m.name === 'offset');
            let skidding = 0;
            let distance = 0;

            if (typeof offsetMod?.options?.offset === 'function') {
                this.logger.warn('DebugService', `Offset function used for ${step.stepId}. Tuner defaults to [0, 10].`);
                distance = 10; // Default distance for element anchors
            } else if (Array.isArray(offsetMod?.options?.offset)) {
                skidding = offsetMod.options.offset[0] || 0;
                distance = offsetMod.options.offset[1] || 0;
            } else {
                 distance = 10; // Default distance if no offset defined
            }

            this.debugState.ttPlacement = step.placement || step.popperOptions?.placement || 'auto';
            this.debugState.ttOffsetDistance = distance;
            this.debugState.ttOffsetSkidding = skidding;
            // Reset/default percentage values
            this.debugState.ttPercentX = 50;
            this.debugState.ttPercentY = 50;
        }

        // Update visibility of controls AFTER setting state
         this._updateTutorialControlVisibility(isOverlayAnchor);

        // Manually update displays for all relevant controllers
        // This ensures sliders reflect the loaded step's values
        Object.values(this.tutorialPositionalControllers).forEach(controllerOrFolder => {
             // Check if it's a controller (has updateDisplay) or the folder (doesn't)
             if (controllerOrFolder && typeof controllerOrFolder.updateDisplay === 'function') {
                 controllerOrFolder.updateDisplay();
             }
         });
         // Also update size controllers
         this.gui.controllers.find(c => c.property === 'ttWidth')?.updateDisplay();
         this.gui.controllers.find(c => c.property === 'ttHeight')?.updateDisplay();

    }

    /**
     * Clears and resets the Tutorial Tuner.
     * Called by UIManager when a toast is hidden.
     */
    clearActiveTutorialStep() {
        this.logger.info.system('DebugService', 'Clearing active tutorial step.');

        // Reset all state properties to their defaults
        this.debugState.ttStepId = 'None';
        this.debugState.ttAnchor = 'N/A';
        this.debugState.ttPlacement = 'auto';
        this.debugState.ttOffsetDistance = 0;
        this.debugState.ttOffsetSkidding = 0;
        this.debugState.ttPercentX = 50;
        this.debugState.ttPercentY = 50;
        this.debugState.ttWidth = 0;
        this.debugState.ttHeight = 0;
        this.debugState.ttGeneratedCode = '';

        // Hide conditional controls
        this._updateTutorialControlVisibility(false);
    }

    /**
     * Handles live tuning input from the debug panel.
     * @private
     */
    _handleTutorialTune() {
        if (!this.uiManager) return;

        const isOverlayAnchor = this.debugState.ttAnchor === 'body';
        this.logger.info.system('DebugService', `Tune event (Overlay: ${isOverlayAnchor}): X%=${this.debugState.ttPercentX}, Y%=${this.debugState.ttPercentY}, Place=${this.debugState.ttPlacement}, Dist=${this.debugState.ttOffsetDistance}, Skid=${this.debugState.ttOffsetSkidding}`);

        this.uiManager.updateTutorialPopper({
            isOverlayAnchor: isOverlayAnchor, // Pass mode to UIManager
            // Size
            width: Number(this.debugState.ttWidth) || 0,
            height: Number(this.debugState.ttHeight) || 0,
            // Percentage Position (if overlay)
            percentX: Number(this.debugState.ttPercentX) || 50,
            percentY: Number(this.debugState.ttPercentY) || 50,
            // Popper Position (if element)
            placement: this.debugState.ttPlacement,
            distance: Number(this.debugState.ttOffsetDistance) || 0,
            skidding: Number(this.debugState.ttOffsetSkidding) || 0,
        });
    }

    /**
     * Generates the code string from the current tuner state.
     * Outputs either percentage or Popper options based on anchor type.
     * @private
     */
    _generateTutorialCode() {
        this.logger.info.system('DebugService', 'Generating tutorial code...');
        const isOverlayAnchor = this.debugState.ttAnchor === 'body';

        // Size String (common)
        const hasSize = this.debugState.ttWidth > 0 || this.debugState.ttHeight > 0;
        const widthVal = this.debugState.ttWidth > 0 ? `'${this.debugState.ttWidth}px'` : "'auto'";
        const heightVal = this.debugState.ttHeight > 0 ? `'${this.debugState.ttHeight}px'` : "'auto'";
        const sizeString = hasSize ? `
size: { width: ${widthVal}, height: ${heightVal} },` : '';

        let positionString = '';
        if (isOverlayAnchor) {
            // Generate Percentage Position Code
             // Make sure anchorElement is 'body'
             positionString = `
anchorElement: 'body',`; // Explicitly set anchor
             // Only add percentages if not default (50, 50)
            if (this.debugState.ttPercentX !== 50 || this.debugState.ttPercentY !== 50) {
                 positionString += `
positionX: ${this.debugState.ttPercentX},
positionY: ${this.debugState.ttPercentY},`;
            }

        } else {
            // Generate Popper Options Code
             // Add anchorElement only if it's NOT body
             if (this.debugState.ttAnchor !== 'body') {
                 positionString = `
anchorElement: '${this.debugState.ttAnchor}',`;
             }
            positionString += `
placement: '${this.debugState.ttPlacement}',
popperOptions: {
    modifiers: [
        { name: 'offset', options: { offset: [${this.debugState.ttOffsetSkidding}, ${this.debugState.ttOffsetDistance}] } }
        // Add other modifiers here if needed in the future
    ]
}`;
        }

        // Construct final code, removing potential trailing comma before a closing brace
         let code = `// --- ${this.debugState.ttStepId} ---${sizeString}${positionString}`;
        code = code.replace(/,\s*(\}|$)/g, '$1'); // Regex to remove trailing comma

        this.debugState.ttGeneratedCode = code;
    }

    // --- [[END]] TUTORIAL TUNER METHODS ---
}
--- END OF FILE: ./js/services/DebugService.js ---

--- START OF FILE: ./js/services/GameState.js ---
// js/services/GameState.js
import { GAME_RULES, SAVE_KEY, SHIP_IDS, LOCATION_IDS, NAV_IDS, SCREEN_IDS } from '../data/constants.js';
import { DB } from '../data/database.js';
import { skewedRandom } from '../utils.js';

/**
 * Procedurally generates the travel data matrix, calculating the time and fuel cost
 * for travel between every pair of locations in the game based on their explicit distances.
 * @param {Array<object>} markets - The array of market objects from the database, including distance property.
 * @returns {object} A nested object where `travelData[fromId][toId]` contains travel info.
 */
function procedurallyGenerateTravelData(markets) {
    const travelData = {};
    const timeScalar = 0.1;  // Controls how much distance affects time
    const fuelScalar = 0.45; // Controls how much distance affects fuel

    markets.forEach(fromMarket => {
        travelData[fromMarket.id] = {};
        markets.forEach(toMarket => {
            if (fromMarket.id === toMarket.id) return;

            const fromDistance = fromMarket.parent ? (markets.find(m => m.id === fromMarket.parent)?.distance || 0) : fromMarket.distance;
            const toDistance = toMarket.parent ? (markets.find(m => m.id === toMarket.parent)?.distance || 0) : toMarket.distance;

            const distance = Math.abs(toDistance - fromDistance);
            
            // Add the moon's own small distance from its parent if it's involved
            const moonCorrection = (fromMarket.parent || toMarket.parent) ? 15 : 0;
            const finalDistance = distance + moonCorrection;

            // Travel time now scales exponentially with distance for a greater impact on long journeys.
            let travelTime = 1 + Math.pow(finalDistance, 1.15) * timeScalar;
            let fuelCost = 2 + finalDistance * fuelScalar;
            
            // Special case for Earth-Luna to make it a quick, early-game trip.
            if ((fromMarket.id === LOCATION_IDS.EARTH && toMarket.id === LOCATION_IDS.LUNA) || (fromMarket.id === LOCATION_IDS.LUNA && toMarket.id === LOCATION_IDS.EARTH)) {
                travelTime = 2 + Math.floor(Math.random() * 2);
                fuelCost = 5 + Math.floor(Math.random() * 2);
            }

            travelData[fromMarket.id][toMarket.id] = {
                time: Math.max(1, Math.round(travelTime)),
                fuelCost: Math.max(1, Math.round(fuelCost)),
            };
        });
    });
    return travelData;
}

/**
 * @class GameState
 * @description Holds all mutable data for the game session, acting as the single source of truth.
 * Static data (e.g., ship base stats, commodity types) is imported from the /data directory.
 * Dynamic data (e.g., player credits, ship health, cargo inventories) is stored and managed here.
 * For example, `DB.SHIPS` contains a ship's max health, while `player.shipStates` in this class
 * contains the *current* health of each ship the player owns.
 */
export class GameState {
    constructor() {
        this.state = {};
        this.subscribers = [];
        this.TRAVEL_DATA = procedurallyGenerateTravelData(DB.MARKETS);
    }

    /**
     * Subscribes a callback function to be executed whenever the game state changes.
     * @param {function} callback - The function to call on state changes.
     */
    subscribe(callback) {
        this.subscribers.push(callback);
    }

    /**
     * Notifies all subscribed components that the state has changed.
     * @private
     */
    _notify() {
        this.subscribers.forEach(callback => callback(this));
    }

    /**
     * Updates the game state by merging a partial state object and notifies subscribers.
     * This is the primary method for mutating the game state.
     * @param {object} partialState - An object containing the properties of the state to update.
     */
    setState(partialState) {
        Object.assign(this, partialState);
        this._notify();
        // this.saveGame(); // NOTE: Saving is currently disabled.
    }
    
    /**
     * Returns a deep copy of the current game state to prevent direct mutation.
     * @returns {object} A JSON-serialized and parsed copy of the game state.
     */
    getState() {
        return JSON.parse(JSON.stringify(this));
    }

    /**
     * Saves the current game state to localStorage.
     * NOTE: This functionality is currently disabled.
     */
    saveGame() {
        // try {
        //     const stateToSave = { ...this };
        //     delete stateToSave.subscribers;
        //     localStorage.setItem(SAVE_KEY, JSON.stringify(stateToSave));
        // } catch (error) {
        //     console.error("Error saving game state:", error);
        // }
    }

    /**
     * Loads the game state from localStorage.
     * NOTE: This functionality is currently disabled and will always start a new game.
     * @returns {boolean} True if a game was successfully loaded, false otherwise.
     */
    loadGame() {
        return false;
        // try {
        //     const serializedState = localStorage.getItem(SAVE_KEY);
        //     if (serializedState === null) return false;
            
        //     const loadedState = JSON.parse(serializedState);
        //     Object.assign(this, loadedState);
        //     this.TRAVEL_DATA = procedurallyGenerateTravelData(DB.MARKETS);
        //     this._notify();
        //     return true;
        // } catch (error) {
        //     console.warn("Could not parse save data. Starting new game.", error);
        //     localStorage.removeItem(SAVE_KEY);
        //     return false;
        // }
    }

    /**
     * Initializes the game state for a new game session, setting all player, market,
     * and other dynamic data to their default starting values.
     * @param {string} playerName - The name entered by the player.
     */
    startNewGame(playerName) {
        const initialState = {
            day: 1, lastInterestChargeDay: 1, lastMarketUpdateDay: 1, currentLocationId: LOCATION_IDS.MARS, activeNav: NAV_IDS.SHIP, activeScreen: SCREEN_IDS.NAVIGATION, isGameOver: false,
            subNavCollapsed: false,
            introSequenceActive: true,
            lastActiveScreen: {
                [NAV_IDS.SHIP]: SCREEN_IDS.MAP,
                [NAV_IDS.STARPORT]: SCREEN_IDS.MARKET,
                [NAV_IDS.DATA]: SCREEN_IDS.MISSIONS,
            },
            pendingTravel: null,
            player: {
                name: playerName, playerTitle: 'Captain', playerAge: 24, lastBirthdayYear: DB.DATE_CONFIG.START_YEAR, birthdayProfitBonus: 0,
                introStep: 0,
                credits: 3000, debt: 0, monthlyInterestAmount: 0,
                loanStartDate: null, seenGarnishmentWarning: false,
                revealedTier: 1,
                unlockedLicenseIds: [],
                unlockedLocationIds: DB.MARKETS.map(m => m.id).filter(id => id !== LOCATION_IDS.EXCHANGE && id !== LOCATION_IDS.KEPLER),
                seenCommodityMilestones: [], financeLog: [],
                activePerks: {}, seenEvents: [], activeShipId: SHIP_IDS.WANDERER, ownedShipIds: [SHIP_IDS.WANDERER],
                shipStates: { [SHIP_IDS.WANDERER]: { health: DB.SHIPS[SHIP_IDS.WANDERER].maxHealth, fuel: DB.SHIPS[SHIP_IDS.WANDERER].maxFuel, hullAlerts: { one: false, two: false } } },
                inventories: { },
                debugEventIndex: 0
            },
            market: { prices: {}, inventory: {}, galacticAverages: {}, priceHistory: {}, shipyardStock: {} },
            
            // --- VIRTUAL WORKBENCH ---
            // Removed obsolete `intel` property
            // Added new GDD properties
            intelMarket: {},
            activeIntelDeal: null,
            // --- END VIRTUAL WORKBENCH ---

            tutorials: {
                activeBatchId: null,
                activeStepId: null,
                seenBatchIds: [],
                skippedTutorialBatches: [],
                navLock: null
            },
            missions: {
                activeMissionId: null,
                completedMissionIds: [],
                missionProgress: {},
                activeMissionObjectivesMet: false
            },
            uiState: {
                marketCardMinimized: {},
                hangarShipyardToggleState: 'shipyard',
                hangarActiveIndex: 0,
                shipyardActiveIndex: 0,
                // --- VIRTUAL WORKBENCH (A) ---
                // Add state to track the active intel tab
                activeIntelTab: 'codex' // 'codex' or 'market'
                // --- END VIRTUAL WORKBENCH ---
            }
        };

        initialState.player.inventories[SHIP_IDS.WANDERER] = {};
        DB.COMMODITIES.forEach(c => { initialState.player.inventories[SHIP_IDS.WANDERER][c.id] = { quantity: 0, avgCost: 0 }; });

        // --- VIRTUAL WORKBENCH ---
        // Initialize new intelMarket property
        initialState.intelMarket = {};
        // --- END VIRTUAL WORKBENCH ---

        DB.MARKETS.forEach(m => {
            initialState.market.priceHistory[m.id] = {};
            
            // --- VIRTUAL WORKBENCH ---
            // Removed obsolete intel.available line
            // Added intelMarket initialization per GDD
            initialState.intelMarket[m.id] = [];
            // --- END VIRTUAL WORKBENCH ---

            initialState.market.inventory[m.id] = {};
            initialState.market.shipyardStock[m.id] = { day: 0, shipsForSale: [] };
            DB.COMMODITIES.forEach(c => {
                initialState.market.priceHistory[m.id][c.id] = [];
                
                const [min, max] = c.canonicalAvailability;
                const modifier = m.availabilityModifier?.[c.id] ?? 1.0;
                let quantity = Math.floor(skewedRandom(min, max) * modifier);

                if (m.specialDemand && m.specialDemand[c.id]) quantity = 0;

                initialState.market.inventory[m.id][c.id] = { 
                    quantity: Math.max(0, quantity),
                    marketPressure: 0.0,
                    lastPlayerInteractionTimestamp: 0,
                    priceLockEndDay: 0,
                    hoverUntilDay: 0,
                    rivalArbitrage: { isActive: false, endDay: 0 },
                    isDepleted: false,
                    depletionDay: 0,
                    depletionBonusDay: 0
                };
            });
        });

        Object.assign(this, initialState);
        this._calculateGalacticAverages();
        this._seedInitialMarketPrices();
        this.setState({});
    }

    /**
     * Calculates the baseline galactic average price for all commodities.
     * This is used as a reference point for market price fluctuations.
     * @private
     */
    _calculateGalacticAverages() {
        this.market.galacticAverages = {};
        DB.COMMODITIES.forEach(good => {
            this.market.galacticAverages[good.id] = (good.basePriceRange[0] + good.basePriceRange[1]) / 2;
        });
    }

    /**
     * Seeds the initial market prices for all commodities at all locations.
     * Prices are based on the galactic average with randomness applied.
     * @private
     */
    _seedInitialMarketPrices() {
        DB.MARKETS.forEach(location => {
            this.market.prices[location.id] = {};
            DB.COMMODITIES.forEach(good => {
                let price = this.market.galacticAverages[good.id] * (1 + (Math.random() - 0.5) * 0.15); // +/- 7.5% variance
                this.market.prices[location.id][good.id] = Math.max(1, Math.round(price));
            });
        });
    }
}
--- END OF FILE: ./js/services/GameState.js ---

--- START OF FILE: ./js/services/MissionService.js ---
// js/services/MissionService.js
/**
 * @fileoverview Manages the state and flow of player missions.
 */
import { DB } from '../data/database.js';
import { formatCredits } from '../utils.js';

export class MissionService {
    /**
     * @param {import('./GameState.js').GameState} gameState The central game state.
     * @param {import('./UIManager.js').UIManager} uiManager The UI manager instance.
     * @param {import('./LoggingService.js').Logger} logger The logging utility.
     */
    constructor(gameState, uiManager, logger) {
        this.gameState = gameState;
        this.uiManager = uiManager;
        this.logger = logger;
        this.simulationService = null; // Will be injected post-instantiation
    }

    /**
     * Injects the SimulationService after all services have been instantiated.
     * @param {import('./SimulationService.js').SimulationService} simulationService
     */
    setSimulationService(simulationService) {
        this.simulationService = simulationService;
    }

    /**
     * Checks if all prerequisites for a given mission are met.
     * @param {string} missionId The ID of the mission to check.
     * @returns {boolean} True if all prerequisites are met, false otherwise.
     */
    arePrerequisitesMet(missionId) {
        const mission = DB.MISSIONS[missionId];
        if (!mission || !mission.prerequisites) {
            return true; // No prerequisites, so it's met.
        }

        return mission.prerequisites.every(prereq => {
            switch (prereq.type) {
                case 'mission_completed':
                    return this.gameState.missions.completedMissionIds.includes(prereq.missionId);
                case 'revealed_tier':
                    return this.gameState.player.revealedTier >= prereq.tier;
                // Future prerequisite types like 'player_level' or 'item_owned' can be added here.
                default:
                    return false; // Unknown prerequisite type fails validation.
            }
        });
    }
    
    /**
     * Gets a list of all missions that are currently available to the player.
     * A mission is available if it's not active, not completed, and its prerequisites are met.
     * @returns {Array<object>} An array of available mission objects.
     */
    getAvailableMissions() {
        const { activeMissionId, completedMissionIds } = this.gameState.missions;
        return Object.values(DB.MISSIONS).filter(mission => {
            const isAvailable =
                mission.id !== activeMissionId &&
                !completedMissionIds.includes(mission.id) &&
                this.arePrerequisitesMet(mission.id);
            return isAvailable;
        });
    }

    /**
     * Accepts a new mission, setting it as the active mission.
     * @param {string} missionId The ID of the mission to accept.
     */
    acceptMission(missionId) {
        const mission = DB.MISSIONS[missionId];
        if (this.gameState.missions.activeMissionId || !mission || !this.arePrerequisitesMet(missionId)) {
            return;
        }
        this.gameState.missions.activeMissionId = missionId;
        this.gameState.missions.missionProgress[missionId] = {
            objectives: {}
        };
        this.logger.info.player(this.gameState.day, 'MISSION_ACCEPT', `Accepted mission: ${missionId}`);
        this.simulationService.grantMissionCargo(missionId);
        this.checkTriggers(); // Run an initial check in case objectives are already met.

        // If the mission has no objectives, complete it immediately.
        if (!mission.objectives || mission.objectives.length === 0) {
            this.completeActiveMission();
        } else {
            this.uiManager.render(this.gameState.getState());
        }
    }

    /**
     * Abandons the currently active mission.
     */
    abandonMission() {
        const abandonedMissionId = this.gameState.missions.activeMissionId;
        if (!abandonedMissionId) return;

        this.gameState.missions.activeMissionId = null;
        this.gameState.missions.activeMissionObjectivesMet = false;
        this.logger.info.player(this.gameState.day, 'MISSION_ABANDON', `Abandoned mission: ${abandonedMissionId}`);
        // Note: We keep missionProgress so the player doesn't lose partial progress if they re-accept.
        this.gameState.setState({});
        this.uiManager.render(this.gameState.getState());
    }

    /**
     * Checks all mission triggers against the current game state.
     * Primarily checks item possession for delivery/acquisition objectives.
     */
    checkTriggers() {
        const { activeMissionId } = this.gameState.missions;
        if (!activeMissionId) {
            if (this.gameState.missions.activeMissionObjectivesMet) {
                this.gameState.missions.activeMissionObjectivesMet = false;
                this.gameState.setState({}); // Notify of change
            }
            return;
        }
    
        const mission = DB.MISSIONS[activeMissionId];
        const inventory = this.gameState.player.inventories[this.gameState.player.activeShipId];
        if (!mission || !inventory) {
            this.gameState.missions.activeMissionObjectivesMet = false;
            return;
        }
    
        let allObjectivesMet = true;
        let progressChanged = false;
    
        mission.objectives.forEach(obj => {
            if (obj.type === 'have_item') {
                const currentQuantity = inventory[obj.goodId]?.quantity || 0;
                const progress = this.gameState.missions.missionProgress[activeMissionId];
    
                if (!progress.objectives[obj.goodId]) {
                    progress.objectives[obj.goodId] = { current: 0 };
                }
    
                if (progress.objectives[obj.goodId].current !== currentQuantity) {
                    progress.objectives[obj.goodId].current = currentQuantity;
                    progressChanged = true;
                }
    
                if (currentQuantity < obj.quantity) {
                    allObjectivesMet = false;
                }
            }
        });
    
        // Only update state and re-render if there's a change.
        if (this.gameState.missions.activeMissionObjectivesMet !== allObjectivesMet || progressChanged) {
            if (allObjectivesMet && !this.gameState.missions.activeMissionObjectivesMet) {
                this.logger.info.player(this.gameState.day, 'OBJECTIVES_MET', `All objectives for mission ${activeMissionId} are met.`);
            }
            this.gameState.missions.activeMissionObjectivesMet = allObjectivesMet;
            this.gameState.setState({}); // Set the new state
            this.uiManager.render(this.gameState.getState()); // Trigger a full re-render
            if (progressChanged) {
                this.uiManager.flashObjectiveProgress();
            }
        }
    }

    /**
     * Completes the active mission, granting rewards and removing objective items.
     */
    completeActiveMission() {
        const { activeMissionId } = this.gameState.missions;
        if (!activeMissionId) return;
        
        // Temporarily set objectivesMet to true for objective-less missions
        const originalObjectivesMet = this.gameState.missions.activeMissionObjectivesMet;
        const mission = DB.MISSIONS[activeMissionId];
        if (!mission.objectives || mission.objectives.length === 0) {
            this.gameState.missions.activeMissionObjectivesMet = true;
        }

        if (!this.gameState.missions.activeMissionObjectivesMet) {
            // Restore original state if completion is not actually met.
            this.gameState.missions.activeMissionObjectivesMet = originalObjectivesMet;
            return;
        }

        const inventory = this.gameState.player.inventories[this.gameState.player.activeShipId];

        // 1. Deduct objective items
        mission.objectives.forEach(obj => {
            if (obj.type === 'have_item' && inventory[obj.goodId]) {
                inventory[obj.goodId].quantity -= obj.quantity;
            }
        });

        // 2. Grant rewards via SimulationService
        if (this.simulationService) {
            this.simulationService._grantRewards(mission.rewards, mission.name);
        }
        this.logger.info.player(this.gameState.day, 'MISSION_COMPLETE', `Completed mission: ${activeMissionId}`);

        // 3. Update mission state
        this.gameState.missions.completedMissionIds.push(activeMissionId);
        this.gameState.missions.activeMissionId = null;
        this.gameState.missions.activeMissionObjectivesMet = false;

        // 4. Update state and re-render
        this.gameState.setState({});
        this.uiManager.render(this.gameState.getState());
    }
}
--- END OF FILE: ./js/services/MissionService.js ---

--- START OF FILE: ./js/services/NewsTickerService.js ---
// js/services/NewsTickerService.js
/**
 * @fileoverview Manages the state and content of the news ticker.
 * It maintains a queue of messages and serves them to the UIManager.
 * Implements V2 logic: dynamic queue, message types, and live content.
 */

// NEW: Import new data files
import { FLAVOR_ADS } from '../data/flavorAds.js';
import { FREE_INTEL_MESSAGES, PURCHASED_INTEL_MESSAGES } from '../data/intelMessages.js';
// CORRECTED IMPORT: Import the DB constant, not a function
import { DB } from '../data/database.js';

const MAX_MESSAGES = 15; // Max number of messages in the rotation

// NEW: Map location IDs to their CSS theme color variables
// These variables are assumed to exist in global.css or similar
const locationColorMap = {
    "loc_venus": "var(--color-theme-venus)",
    "loc_earth": "var(--color-theme-earth)",
    "loc_luna": "var(--color-theme-luna)",
    "loc_mars": "var(--color-theme-mars)",
    "loc_belt": "var(--color-theme-belt)",
    "loc_exchange": "var(--color-theme-exchange)",
    "loc_jupiter": "var(--color-theme-jupiter)",
    "loc_saturn": "var(--color-theme-saturn)",
    "loc_uranus": "var(--color-theme-uranus)",
    "loc_neptune": "var(--color-theme-neptune)",
    "loc_kepler": "var(--color-theme-kepler)",
    "loc_pluto": "var(--color-theme-pluto)"
};

export class NewsTickerService {
    /**
     * @param {import('./GameState.js').GameState} gameState 
     */
    constructor(gameState) {
        this.gameState = gameState;
        /** @type {import('./SimulationService.js').SimulationService | null} */
        this.simulationService = null;
        /** @type {import('./simulation/MarketService.js').MarketService | null} */
        this.marketService = null;

        /** @type {Array<Object>} */
        this.messageQueue = [];
        this.isDirty = true;
        this.welcomeMessagePlayed = false;
    }

    /**
     * Injects services needed for dynamic content generation.
     * Called by SimulationService constructor.
     * @param {import('./SimulationService.js').SimulationService} simulationService
     * @param {import('./simulation/MarketService.js').MarketService} marketService
     */
    setServices(simulationService, marketService) {
        this.simulationService = simulationService;
        this.marketService = marketService;
    }

    /**
     * Public method for other services (like SimService) to add a dynamic message.
     * Used for ALERT, STORY, and non-startup SYSTEM messages.
     * @param {string} text - The message content.
     * @param {string} type - 'SYSTEM', 'INTEL', 'FLAVOR', 'ALERT', 'STORY'
     * @param {boolean} [isPriority=false] - If true, prepends to the front.
     * @param {boolean} [requiresLiveData=false] - If true, text will be auto-generated live.
     */
    pushMessage(text, type, isPriority = false, requiresLiveData = false) {
        // De-duplication check, ignoring live data messages (which have no text)
        if (text && this.messageQueue.some(msg => msg.text === text)) {
            return; // Don't add duplicate
        }

        const newMessage = {
            id: Date.now() + Math.random(), // Added ID for future-proofing
            text: text,
            type: type,
            requiresLiveData: requiresLiveData
        };

        if (isPriority) {
            // "Next-Up" insertion logic: Inserts at the front of the queue.
            // Per V2 spec, this should be after the *current* message,
            // but unshift() is the simplest implementation for now.
            this.messageQueue.unshift(newMessage);
        } else {
            this.messageQueue.push(newMessage);
        }

        // Enforce queue limit
        while (this.messageQueue.length > MAX_MESSAGES) {
            this.messageQueue.shift(); // Remove the oldest
        }

        this.isDirty = true;
    }

    /**
     * Called by TimeService each day.
     * The old version added flavor text here. The V2 design moves flavor
     * text to onLocationChange, so this pulse is now empty.
     * Kept for compatibility with TimeService.
     */
    pulse() {
        // No longer used for flavor text as per V2 design.
    }

    /**
     * Called by SimulationService when the player arrives at a new location.
     * Rebuilds the entire default message queue.
     */
    onLocationChange() {
        const state = this.gameState.getState();
        // ---
        // BUG FIX (a): The location ID is at the root of the state, not under `player`.
        // ---
        const newLocationId = state.currentLocationId;

        // Start with a fresh queue
        this.messageQueue = [];

        // --- VIRTUAL WORKBENCH: REQUEST A (RE-ORDER) ---

        // 1. Add 'Welcome' message (once per game)
        this.generateWelcomeMessage();

        // 2. Add Purchased Intel (if active)
        this.generatePurchasedIntelMessage();

        // 3. Add Free Intel message
        this.generateFreeIntelMessage(newLocationId);

        // 4. Add ONE random Flavor Ad
        const flavorAds = this.selectLocationFlavorAds(newLocationId);
        if (flavorAds[0]) {
            this.pushMessage(flavorAds[0], 'FLAVOR');
        }

        // 5. Add Ship Status message
        // We push an empty object with the live data flag.
        this.pushMessage('', 'STATUS', false, true);

        // --- END VIRTUAL WORKBENCH ---

        // Mark as dirty to force UIManager to re-render
        this.isDirty = true;
    }

    /**
     * Gets the formatted HTML string for all current messages.
     * @returns {string} The HTML for the .news-ticker-content element.
     */
    getTickerContentHtml() {
        // MODIFIED: Removed fallback call to onLocationChange()
        // This was causing the ticker to reset when switching tabs.
        if (this.messageQueue.length === 0 && !this.welcomeMessagePlayed) {
            // Initial game load
            this.generateWelcomeMessage();
        }

        const separator = ` <span class="ticker-separator"> // </span> `;
        
        const messageHtml = this.messageQueue.map(msg => {
            let text = msg.text;
            let style = '';

            // Handle STATUS messages
            if (msg.requiresLiveData && msg.type === 'STATUS') {
                text = this.getLiveStatusText();
            }

            // Handle FLAVOR color
            if (msg.type === 'FLAVOR') {
                style = `style="color: ${this.getLocationColor()};"`;
            }

            return `<span class="ticker-message" data-type="${msg.type}" ${style}>${text}</span>`;
        }).join(separator);

        // --- VIRTUAL WORKBENCH: REQUEST B & C (STUTTER/SEPARATOR FIX) ---
        // Append one final separator to the end of the content.
        // This will be duplicated by UIManager, seamlessly connecting the
        // end of the loop ([STATUS]) to the start of the next ([INTEL]).
        return `<div class="news-ticker-content">${messageHtml}${separator}</div>`;
        // --- END VIRTUAL WORKBENCH ---
    }

    // --- PRIVATE HELPER METHODS ---

    /**
     * Adds the one-time welcome message to the queue.
     * @private
     */
    generateWelcomeMessage() {
        if (!this.welcomeMessagePlayed) {
            this.pushMessage("Welcome to Orbital Trading", "SYSTEM", true);
            this.welcomeMessagePlayed = true;
        }
    }

    /**
     * Finds and pushes the best free intel for the current location.
     * @param {string} locationId
     * @private
     */
    generateFreeIntelMessage(locationId) {
        if (!this.marketService) return;

        const state = this.gameState.getState();
        const locationPrices = state.market.prices[locationId];
        if (!locationPrices) return;
        
        const commodities = DB.COMMODITIES; // O(N) array of static data
        let bestDeal = { commodityId: null, discount: 0 };

        // --- VIRTUAL WORKBENCH: OPTIMIZED LOOP ---
        // Iterate the static commodity DB (O(N))
        for (const staticData of commodities) {
            // Skip if player can't see this tier
            if (!staticData || !staticData.basePriceRange || staticData.tier > state.player.revealedTier) {
                continue;
            }

            // Get price from the price map (O(1) lookup)
            const price = locationPrices[staticData.id];
            if (price === undefined) {
                continue; // This commodity isn't sold here or has no price
            }

            // Calculate galacticAverage from basePriceRange
            const galacticAverage = (staticData.basePriceRange[0] + staticData.basePriceRange[1]) / 2;
            const discount = (galacticAverage - price) / galacticAverage;

            if (discount > bestDeal.discount) {
                bestDeal = { commodityId: staticData.id, discount };
            }
        }
        // --- END VIRTUAL WORKBENCH ---

        // Check if the best deal meets the 5% threshold
        if (bestDeal.discount >= 0.05) {
            // Get the name *after* the loop
            const commodityName = commodities.find(c => c.id === bestDeal.commodityId).name;
            let tier;

            if (bestDeal.discount > 0.50) tier = 'tier5';
            else if (bestDeal.discount > 0.30) tier = 'tier4';
            else if (bestDeal.discount > 0.20) tier = 'tier3';
            else if (bestDeal.discount > 0.10) tier = 'tier2';
            else tier = 'tier1';

            const messageList = FREE_INTEL_MESSAGES[tier];
            let text = messageList[Math.floor(Math.random() * messageList.length)];
            text = text.replace('{Commodity Name}', commodityName);
            this.pushMessage(text, 'INTEL');

        } else {
            // No significant deals
            this.pushMessage('Market conditions nominal.', 'INTEL');
        }
    }

    /**
     * Checks for active purchased intel and pushes it to the queue.
     * @private
     */
    generatePurchasedIntelMessage() {
        // --- TBD: Placeholder ---
        // This will check GameState for active purchased intel.
        // const { activeIntel } = this.gameState.getState().player;
        // if (activeIntel) {
        //     const { commodityId, locationId, dealType } = activeIntel;
        //     // CORRECTED: Access DB data via .find()
        //     const commodityName = DB.COMMODITIES.find(c => c.id === commodityId).name;
        //     const locationName = DB.MARKETS.find(m => m.id === locationId).name;
        //
        //     let text = PURCHASED_INTEL_MESSAGES[Math.floor(Math.random() * PURCHASED_INTEL_MESSAGES.length)];
        //     text = text.replace('{Commodity Name}', commodityName)
        //                 .replace('{Location Name}', locationName);
        //     this.pushMessage(text, 'INTEL');
        // }
    }

    /**
     * Selects two random, different flavor ads for the current location.
     * @param {string} locationId
     * @returns {Array<string>} An array containing two ad strings.
     * @private
     */
    selectLocationFlavorAds(locationId) {
        const adPool = FLAVOR_ADS[locationId] || FLAVOR_ADS['loc_belt']; // Fallback to belt
        if (adPool.length === 0) return ["", ""];
        if (adPool.length === 1) return [adPool[0], adPool[0]];

        // Shuffle and pick two
        const shuffled = [...adPool].sort(() => 0.5 - Math.random());
        return [shuffled[0], shuffled[1]];
    }

    /**
     * Generates the ship STATUS string from live GameState.
     * @returns {string} The formatted status text.
     * @private
     */
    getLiveStatusText() {
        try {
            const state = this.gameState.getState();
            const activeShipId = state.player.activeShipId;
            if (!activeShipId) return "STATUS: NO ACTIVE SHIP";

            // CORRECTED: Get static data from DB.SHIPS
            const shipData = DB.SHIPS[activeShipId];
            // CORRECTED: Get live data from player.shipStates
            const shipState = state.player.shipStates[activeShipId]; 
            
            if (!shipData || !shipState) return "STATUS: DATA ERROR";

            const fuel = Math.round((shipState.fuel / shipData.maxFuel) * 100);
            const hull = Math.round((shipState.health / shipData.maxHealth) * 100);
            
            // CORRECTED: Get cargo data. cargoUsed is not on shipState, must be calculated.
            let cargoUsed = 0;
            const inventory = state.player.inventories[activeShipId];
            if (inventory) {
                cargoUsed = Object.values(inventory).reduce((sum, item) => sum + item.quantity, 0);
            }
            
            const cargoMax = shipData.cargoCapacity;

            return `${shipData.name}: FUEL: ${fuel}% | CARGO: ${cargoUsed}/${cargoMax} | HULL: ${hull}%`;
        } catch (e) {
            console.error("NewsTickerService Error generating status:", e);
            return "STATUS: ERROR"; // Safeguard
        }
    }

    /**
     * Gets the location-specific theme color CSS variable.
     * @returns {string} The CSS variable string.
     * @private
     */
    getLocationColor() {
        // ---
        // BUG FIX (a): The location ID is at the root of the state, not under `player`.
        // ---
        const locationId = this.gameState.getState().currentLocationId;
        return locationColorMap[locationId] || 'var(--color-text-primary)'; // Fallback
    }
}
--- END OF FILE: ./js/services/NewsTickerService.js ---

--- START OF FILE: ./js/services/simulation/MarketService.js ---
// js/services/simulation/MarketService.js
/**
 * @fileoverview This file contains the MarketService class, which handles the simulation
 * of the in-game economy. This includes evolving commodity prices over time based on
 * volatility and market pressure, replenishing market inventories with persistence,
 * and managing system-wide economic states.
 */
import { GAME_RULES } from '../../data/constants.js';
import { DB } from '../../data/database.js';
import { skewedRandom } from '../../utils.js';

/**
 * @class MarketService
 * @description Manages the economic simulation aspects of the game.
 */
export class MarketService {
    /**
     * @param {import('../GameState.js').GameState} gameState The central game state object.
     */
    constructor(gameState) {
        this.gameState = gameState;
        this._currentSystemState = null;
        this._systemStateExpirationDay = 0;
    }

    // --- VIRTUAL WORKBENCH: ADD NEW METHODS ---

    /**
     * Gets the effective price for a commodity at a location, checking for
     * active intel deal overrides first.
     * @param {string} locationId The ID of the location.
     * @param {string} commodityId The ID of the commodity.
     * @returns {number} The effective price (either override or market price).
     * @JSDoc
     */
    getPrice(locationId, commodityId) {
        const deal = this.gameState.getState().activeIntelDeal;

        // --- NEW LOGIC: CHECK FOR OVERRIDE FIRST ---
        if (deal &&
            deal.locationId === locationId &&
            deal.commodityId === commodityId) {
            
            // --- VIRTUAL WORKBENCH MODIFICATION (User Request) ---
            // If a deal is active, the price is *read* from the current
            // market prices, which are being fluctuated daily by evolveMarketPrices.
            // We no longer return the static deal.overridePrice here, as that
            // would bypass the daily fluctuation.
            return this.gameState.market.prices[locationId]?.[commodityId] || deal.overridePrice;
            // --- END MODIFICATION ---
        }
        // --- END NEW LOGIC ---

        // ... existing price simulation logic ...
        // Fallback to the standard market price
        return this.gameState.market.prices[locationId]?.[commodityId] || 0;
    }

    /**
     * Retrieves the pre-calculated galactic average price for a commodity.
     * @param {string} commodityId The ID of the commodity.
     * @returns {number} The galactic average price.
     * @JSDoc
     */
    getGalacticAverage(commodityId) {
        return this.gameState.market.galacticAverages[commodityId] || 0;
    }

    // --- END VIRTUAL WORKBENCH ---

    /**
     * Checks if the current system-wide economic state should change and applies a new one if necessary.
     */
    checkForSystemStateChange() {
        if (this.gameState.day > this._systemStateExpirationDay) {
            const systemStates = Object.keys(DB.SYSTEM_STATES);
            const selectedStateKey = systemStates[Math.floor(Math.random() * systemStates.length)];
            this._currentSystemState = DB.SYSTEM_STATES[selectedStateKey];
            this._systemStateExpirationDay = this.gameState.day + this._currentSystemState.duration;
        }
    }

    /**
     * Simulates one week of market price changes for all commodities at all locations.
     * Prices fluctuate based on individual volatility, a tendency to revert to a baseline average,
     * and player-driven market pressure.
     */
    evolveMarketPrices() {
        DB.MARKETS.forEach(location => {
            DB.COMMODITIES.forEach(commodity => {
                if (commodity.tier > this.gameState.player.revealedTier) return;

                // --- VIRTUAL WORKBENCH (PHASE 2 & User Request) ---
                // Enforce Intel Price Lock
                const activeDeal = this.gameState.activeIntelDeal;
                if (activeDeal &&
                     activeDeal.locationId === location.id &&
                     activeDeal.commodityId === commodity.id)
                {
                    // --- MODIFICATION: Apply 3% fluctuation to the locked price ---
                    const basePrice = activeDeal.overridePrice;
                    const fluctuation = 0.03; // 3%
                    const minPrice = basePrice * (1 - fluctuation);
                    const maxPrice = basePrice * (1 + fluctuation);
                    
                    // Generate a random price within the [minPrice, maxPrice] range
                    const fluctuatedPrice = Math.random() * (maxPrice - minPrice) + minPrice;
                    
                    // Set the new price, ensuring it's at least 1
                    this.gameState.market.prices[location.id][commodity.id] = Math.max(1, Math.round(fluctuatedPrice));
                    // --- END MODIFICATION ---

                    // Skip all other evolution logic for this item
                    return; 
                }
                // --- END VIRTUAL WORKBENCH ---

                const inventoryItem = this.gameState.market.inventory[location.id][commodity.id];
                const price = this.gameState.market.prices[location.id][commodity.id];
                const avg = this.gameState.market.galacticAverages[commodity.id];

                // Determine the local baseline price based on import/export modifiers
                const modifier = location.availabilityModifier?.[commodity.id] ?? 1.0;

                // (1.0 - modifier) inverts the logic:
                // Exporter (mod > 1.0) results in a negative offset (lower price)
                // Importer (mod < 1.0) results in a positive offset (higher price)
                const targetPriceOffset = (1.0 - modifier) * avg;

                // The new baseline is the galactic average, pulled towards the local target price
                // by the strength of the modifier.
                const localBaseline = avg + (targetPriceOffset * GAME_RULES.LOCAL_PRICE_MOD_STRENGTH);

                let volatility = GAME_RULES.DAILY_PRICE_VOLATILITY;
                let meanReversion = GAME_RULES.MEAN_REVERSION_STRENGTH;

                const commodityMods = this._currentSystemState?.modifiers?.commodity?.[commodity.id];
                if (commodityMods) {
                    if (commodityMods.volatility_mult) volatility *= commodityMods.volatility_mult;
                    if (commodityMods.mean_reversion_mult) meanReversion *= commodityMods.mean_reversion_mult;
                }

                const priceRange = commodity.basePriceRange[1] - commodity.basePriceRange[0];
                const randomFluctuation = (Math.random() - 0.5) * priceRange * volatility;
                
                let reversionEffect = (localBaseline - price) * meanReversion;

                // --- NEW: Variable Reversion Delay (Point e) ---
                // If the player has traded this item recently, a "price lock" is in effect,
                // stopping mean reversion. The duration is set randomly on transaction.
                if (this.gameState.day < inventoryItem.priceLockEndDay) {
                    reversionEffect = 0;
                }
                // --- END CHANGE ---

                if (inventoryItem.rivalArbitrage.isActive && this.gameState.day < inventoryItem.rivalArbitrage.endDay) {
                    reversionEffect = (localBaseline - price) * 0.20;
                } else if (inventoryItem.rivalArbitrage.isActive) {
                    inventoryItem.rivalArbitrage.isActive = false;
                }

                if (inventoryItem.hoverUntilDay > this.gameState.day) {
                     reversionEffect *= 0.1;
                } else if (inventoryItem.hoverUntilDay > 0) {
                    inventoryItem.hoverUntilDay = 0;
                }

                // [GEMINI] --- MODEL FIX: "DELAYED PRESSURE" ---
                // This is now the primary, and only, player-driven price force.
                // It is 0 by default and is only populated by a player trade.
                let pressureEffect = 0;
                const PLAYER_PRESSURE_STRENGTH = 0.50; // Tuned strength
                
                // Add 1-week delay before player's actions impact price
                if (this.gameState.day >= inventoryItem.lastPlayerInteractionTimestamp + 7) {
                    // Check if lastPlayerInteractionTimestamp is > 0 to prevent this from running on Day 7 of a new game
                    if (inventoryItem.lastPlayerInteractionTimestamp > 0) {
                         pressureEffect = (localBaseline * inventoryItem.marketPressure * -1) * PLAYER_PRESSURE_STRENGTH;
                    }
                }
                // [GEMINI] --- END MODEL FIX ---



                // [GEMINI] --- REMOVED "Availability-Based Price Pressure" ---
                // The availabilityEffect block was removed entirely to fix
                // the "native crash" bug and the "inverse logic" bug.
                // --- End Removed Block ---

                // --- NEW: Depletion Price Hike ---
                let priceHikeMultiplier = 1.0;
                if (inventoryItem.isDepleted && this.gameState.day < inventoryItem.depletionDay + 7) {
                    priceHikeMultiplier = 1.5; // 50% more acceleration
                    // We check depletionDay + 7, so this effect lasts for the whole week
                    // We reset the flag *after* it's been used in replenishment
                }
                // --- End Depletion Price Hike ---

                // [GEMINI] Fixed price calculation. Removed availabilityEffect, restored pressureEffect.
                let newPrice = price + randomFluctuation + reversionEffect + (pressureEffect * priceHikeMultiplier);
                
                if (this._currentSystemState?.modifiers?.commodity?.[commodity.id]?.price) {
                     newPrice *= this._currentSystemState.modifiers.commodity[commodity.id].price;
                }
                
                this.gameState.market.prices[location.id][commodity.id] = Math.max(1, Math.round(newPrice));

                // marketPressure still decays, as this is the "timer" for the pressureEffect
                inventoryItem.marketPressure *= GAME_RULES.MARKET_PRESSURE_DECAY;
                if (Math.abs(inventoryItem.marketPressure) < 0.001) {
                    inventoryItem.marketPressure = 0;
                }
            });
            this._recordPriceHistory(location.id);
        });
    }
    
    /**
     * Simulates the weekly replenishment of commodity stock using a hybrid model.
     * Stock gradually moves towards a target influenced by player actions, with a final random fluctuation.
     */
    replenishMarketInventory() {
        DB.MARKETS.forEach(market => {
            DB.COMMODITIES.forEach(c => {
                if (c.tier > this.gameState.player.revealedTier) return;

                const inventoryItem = this.gameState.market.inventory[market.id][c.id];

                // Market Memory: Reset if untouched for 120 days.
                if (inventoryItem.lastPlayerInteractionTimestamp > 0 && (this.gameState.day - inventoryItem.lastPlayerInteractionTimestamp) > 120) {
                    inventoryItem.quantity = this._calculateBaselineStock(market, c);
                    inventoryItem.lastPlayerInteractionTimestamp = 0;
                    inventoryItem.marketPressure = 0;
                    inventoryItem.depletionDay = 0; // Clear depletion day on reset
                    inventoryItem.priceLockEndDay = 0; // <-- ADDED: Clear price lock on reset
                } else {
                    // Phase 1: Establish Dynamic Target Stock
                    const [minAvail, maxAvail] = c.canonicalAvailability;
                    const baseMeanStock = (minAvail + maxAvail) / 2 * (market.availabilityModifier?.[c.id] ?? 1.0);
                    
                    // Market adaptation: high player selling pressure reduces the target stock.
                    let pressureForAdaptation = inventoryItem.marketPressure;
                    // If pressure is negative (player buying), delay its effect for 1 week
                    if (pressureForAdaptation < 0 && this.gameState.day < inventoryItem.lastPlayerInteractionTimestamp + 7) {
                        pressureForAdaptation = 0; // Ignore recouping pressure for the first week
                    }

                    // --- REMOVED BRICK WALL (Point c) ---
                    // Only allow negative pressure (player buying) to increase target stock.
                    // Positive pressure (player selling) no longer decreases it.
                    if (pressureForAdaptation > 0) {
                        pressureForAdaptation = 0;
                    }
                    // --- END CHANGE ---

                    // [GEMINI] Note: This logic is still sound. Player *buying* (negative pressure)
                    // will correctly increase the targetStock, simulating new demand.
                    const marketAdaptationFactor = 1 - Math.min(0.5, pressureForAdaptation * 0.5); // Now only ever >= 1.0
                    const targetStock = baseMeanStock * marketAdaptationFactor;

                    // Phase 2: Gradual Replenishment Towards Target
                    const difference = targetStock - inventoryItem.quantity;
                    const replenishAmount = difference * 0.10; // Move 10% towards the target each week
                    
                    // --- NEW: Emergency Stock Boost ---
                    let emergencyStock = 0;
                    if (inventoryItem.isDepleted) {
                        // If item was depleted, add a small emergency boost
                        emergencyStock = skewedRandom(1, 5);
                        inventoryItem.isDepleted = false; // Reset depletion flag
                        // We DO NOT reset depletionDay, as evolveMarketPrices uses it for 7 days
                    } else if (inventoryItem.quantity <= 0) {
                        // Also boost if it just happens to be 0
                        emergencyStock = skewedRandom(1, 5);
                    }
                    // --- End Emergency Stock Boost ---

                    inventoryItem.quantity += (replenishAmount + emergencyStock);
                }

                

                // Phase 3: Apply Final Visual Fluctuation
                const fluctuationPercent = (Math.random() * 0.15 + 0.15); // Random value between 0.15 and 0.30
                const fluctuationDirection = Math.random() < 0.5 ? -1 : 1;
                const finalFluctuation = 1 + (fluctuationPercent * fluctuationDirection);
                inventoryItem.quantity *= finalFluctuation;
                
                // Apply system state modifiers if any exist.
                if (this._currentSystemState?.modifiers?.commodity?.[c.id]?.availability) {
                    inventoryItem.quantity *= this._currentSystemState.modifiers.commodity[c.id].availability;
                }
                
                inventoryItem.quantity = Math.max(0, Math.round(inventoryItem.quantity));
            });
        });
    }

    /**
     * Applies a dynamic price adjustment to a commodity based on the volume of a player's transaction.
     * @param {string} goodId - The ID of the commodity traded.
     * @param {number} quantity - The amount traded.
     * @param {string} transactionType - 'buy' or 'sell'.
     */
    applyMarketImpact(goodId, quantity, transactionType) {
        const good = DB.COMMODITIES.find(c => c.id === goodId);
        const inventoryItem = this.gameState.market.inventory[this.gameState.currentLocationId][goodId];
        
        // [GEMINI] This calculation is now the core driver of the price change.
        // It sets marketPressure, which is used by pressureEffect after 7 days.
        const pressureChange = ((quantity / (good.canonicalAvailability[1] || 100)) * good.tier) / 10;
        
        if (transactionType === 'buy') {
            inventoryItem.marketPressure -= pressureChange;
        } else { // 'sell'
            inventoryItem.marketPressure += pressureChange;
        }

        // --- NEW: Set Variable Price Lock Duration ---
        const dayOfYear = (this.gameState.day - 1) % 365 + 1;
        let minDuration, maxDuration;

        if (dayOfYear <= 182) { // First half of the year
            minDuration = 75; // 2.5 months
            maxDuration = 120; // 4 months
        } else { // Second half of the year
            minDuration = 105; // 3.5 months
            maxDuration = 195; // 6.5 months
        }

        const lockDuration = Math.floor(Math.random() * (maxDuration - minDuration + 1)) + minDuration;
        inventoryItem.priceLockEndDay = this.gameState.day + lockDuration;
        // --- END CHANGE ---

        inventoryItem.lastPlayerInteractionTimestamp = this.gameState.day;
    }

    // --- VIRTUAL WORKBENCH: NEW METHOD ---
    /**
     * Checks if a purchase triggers a market depletion event.
     * This logic is called by PlayerActionService when a good's stock reaches <= 0.
     * @param {object} good - The static commodity data (from DB).
     * @param {object} inventoryItem - The dynamic inventory item from gameState.
     * @param {number} stockBeforeBuy - The quantity of the item *before* the player's purchase.
     * @param {number} currentDay - The current game day.
     * @JSDoc
     */
    checkDepletion(good, inventoryItem, stockBeforeBuy, currentDay) {
        // Calculate target stock to check 8% threshold
        const market = DB.MARKETS.find(m => m.id === this.gameState.currentLocationId);
        const [minAvail, maxAvail] = good.canonicalAvailability;
        const modifier = market.availabilityModifier?.[good.id] ?? 1.0;
        const baseMeanStock = (minAvail + maxAvail) / 2 * modifier;
        
        let pressureForAdaptation = inventoryItem.marketPressure;
        if (pressureForAdaptation > 0) pressureForAdaptation = 0; // Only recouping (buy) pressure affects target
        
        const marketAdaptationFactor = 1 - Math.min(0.5, pressureForAdaptation * 0.5);
        const targetStock = Math.max(1, baseMeanStock * marketAdaptationFactor);
        
        const depletionThreshold = targetStock * 0.08;
        
        // The amount purchased was the entire stock that was on hand
        const depletionBuyQuantity = stockBeforeBuy; 

        // (5a) Check if buy quantity was >= 8% target
        // (5b) Check if 1 year has passed since last bonus
        if (depletionBuyQuantity >= depletionThreshold && currentDay > (inventoryItem.depletionBonusDay + 365)) {
            inventoryItem.isDepleted = true; // Set flag for MarketService's evolveMarketPrices
            inventoryItem.depletionDay = currentDay;
            inventoryItem.depletionBonusDay = currentDay; // Set cooldown
        }
    }
    // --- END VIRTUAL WORKBENCH ---

    /**
     * Calculates the baseline (initial or reset) stock for a commodity at a specific location.
     * @param {object} market - The market object from the database.
     * @param {object} commodity - The commodity object from the database.
     * @returns {number} The calculated baseline stock quantity.
     * @private
     */
    _calculateBaselineStock(market, commodity) {
        const [min, max] = commodity.canonicalAvailability;
        const modifier = market.availabilityModifier?.[commodity.id] ?? 1.0;
        return Math.floor(skewedRandom(min, max) * modifier);
    }

    /**
     * Records the current day's price for each commodity to its historical data log for graphing.
     * @param {string} [marketId=null] - The ID of the market to record history for. Defaults to the current location.
     * @private
     */
    _recordPriceHistory(marketId = null) {
        if (!this.gameState || !this.gameState.market) return;
        const targetMarketId = marketId || this.gameState.currentLocationId;

        if (!this.gameState.market.priceHistory[targetMarketId]) {
            this.gameState.market.priceHistory[targetMarketId] = {};
        }

        DB.COMMODITIES.forEach(good => {
            if (good.tier > this.gameState.player.revealedTier) return;
            if (!this.gameState.market.priceHistory[targetMarketId][good.id]) {
                this.gameState.market.priceHistory[targetMarketId][good.id] = [];
            }

            const history = this.gameState.market.priceHistory[targetMarketId][good.id];
            const currentPrice = this.gameState.market.prices[targetMarketId][good.id];

            const lastEntry = history[history.length - 1];
            if (lastEntry && lastEntry.day === this.gameState.day) {
                if (lastEntry.price !== currentPrice) {
                    lastEntry.price = currentPrice;
                }
            } else {
                history.push({ day: this.gameState.day, price: currentPrice });
            }

            while (history.length > GAME_RULES.PRICE_HISTORY_LENGTH) {
                history.shift();
            }
        });
    }

    /**
     * Updates the shipyard stock for all unlocked locations on a weekly basis.
     * @private
     */
    _updateShipyardStock() {
        const { player } = this.gameState;
        player.unlockedLocationIds.forEach(locationId => {
            const stock = this.gameState.market.shipyardStock[locationId];
            if (stock && stock.day === this.gameState.day) return;
            const commonShips = Object.entries(DB.SHIPS).filter(([id, ship]) => !ship.isRare && ship.saleLocationId === locationId && !player.ownedShipIds.includes(id));
            const rareShips = Object.entries(DB.SHIPS).filter(([id, ship]) => ship.isRare && ship.saleLocationId === locationId && !player.ownedShipIds.includes(id));
            const shipsForSaleIds = [...commonShips.map(entry => entry[0])];
            rareShips.forEach(([id, ship]) => {
                if (Math.random() < GAME_RULES.RARE_SHIP_CHANCE) {
                    shipsForSaleIds.push(id);
                }
            });
            this.gameState.market.shipyardStock[locationId] = {
                day: this.gameState.day,
                shipsForSale: shipsForSaleIds
            };
        });
    }
}
--- END OF FILE: ./js/services/simulation/MarketService.js ---

--- START OF FILE: ./js/services/world/TravelService.js ---
// js/services/world/TravelService.js
/**
 * @fileoverview Handles all aspects of interstellar travel, including
 * initiating trips, calculating costs, and managing the random event system.
 */
import { DB } from '../../data/database.js';
import { GAME_RULES, SCREEN_IDS, NAV_IDS, PERK_IDS, LOCATION_IDS } from '../../data/constants.js';
import { applyEffect } from '../eventEffectResolver.js';

export class TravelService {
    /**
     * @param {import('../GameState.js').GameState} gameState
     * @param {import('../UIManager.js').UIManager} uiManager
     * @param {import('./TimeService.js').TimeService} timeService
     * @param {import('../../services/LoggingService.js').Logger} logger
     * @param {import('../SimulationService.js').SimulationService} simulationServiceFacade
     */
    constructor(gameState, uiManager, timeService, logger, simulationServiceFacade) {
        this.gameState = gameState;
        this.uiManager = uiManager;
        this.timeService = timeService;
        this.logger = logger;
        this.simulationService = simulationServiceFacade;
    }

    /**
     * Initiates travel to a new location after validating fuel and other conditions.
     * @param {string} locationId - The ID of the destination market.
     */
    travelTo(locationId) {
        this.uiManager.resetMarketTransactionState();
        const { tutorials } = this.gameState;
        const { navLock } = tutorials;

        if (navLock && navLock.screenId === SCREEN_IDS.NAVIGATION && navLock.enabledElementQuery) {
            if (!navLock.enabledElementQuery.includes(`[data-location-id='${locationId}']`)) {
                return;
            }
        }

        const state = this.gameState.getState();
        if (state.isGameOver || state.pendingTravel) return;
        if (state.currentLocationId === locationId) {
            this.simulationService.setScreen(NAV_IDS.STARPORT, SCREEN_IDS.MARKET);
            return;
        }

        const activeShip = this.simulationService._getActiveShip();
        if (!activeShip) {
            this.uiManager.queueModal('event-modal', "No Active Ship", "You must have an active vessel to travel.");
            return;
        }
        const travelInfo = state.TRAVEL_DATA[state.currentLocationId][locationId];
        let requiredFuel = travelInfo.fuelCost;
        if (state.player.activePerks[PERK_IDS.NAVIGATOR]) {
            requiredFuel = Math.round(requiredFuel * DB.PERKS[PERK_IDS.NAVIGATOR].fuelMod);
        }

        if (activeShip.maxFuel < requiredFuel) {
            this.uiManager.queueModal('event-modal', "Fuel Capacity Insufficient", `Your ship's fuel tank is too small. This trip requires ${requiredFuel} fuel, but you can only hold ${activeShip.maxFuel}.`);
            return;
        }
        if (activeShip.fuel < requiredFuel) {
            this.uiManager.queueModal('event-modal', "Insufficient Fuel", `You need ${requiredFuel} fuel but only have ${Math.floor(activeShip.fuel)}.`);
            return;
        }

        const isFirstTutorialFlight = state.tutorials.activeBatchId === 'intro_missions' && state.tutorials.activeStepId === 'mission_1_6';
        if (!isFirstTutorialFlight) {
            if (this._checkForRandomEvent(locationId)) {
                return;
            }
        }

        this.initiateTravel(locationId);
    }

    /**
     * Executes the core travel logic: applies fuel costs and hull damage, advances time, and shows the animation.
     * @param {string} locationId - The destination location ID.
     * @param {object} [eventMods={}] - Modifications to travel parameters from a random event.
     */
    initiateTravel(locationId, eventMods = {}) {
        const state = this.gameState.getState();
        const fromId = state.currentLocationId;
        let travelInfo = { ...state.TRAVEL_DATA[fromId][locationId] };
        this.logger.info.player(state.day, 'TRAVEL_START', `Departing from ${fromId} to ${locationId}.`);

        if (state.player.activePerks[PERK_IDS.NAVIGATOR]) {
            travelInfo.time = Math.round(travelInfo.time * DB.PERKS[PERK_IDS.NAVIGATOR].travelTimeMod);
            travelInfo.fuelCost = Math.round(travelInfo.fuelCost * DB.PERKS[PERK_IDS.NAVIGATOR].fuelMod);
        }

        if (eventMods.travelTimeAdd) travelInfo.time += eventMods.travelTimeAdd;
        if (eventMods.travelTimeAddPercent) travelInfo.time *= (1 + eventMods.travelTimeAddPercent);
        if (eventMods.setTravelTime) travelInfo.time = eventMods.setTravelTime;
        travelInfo.time = Math.max(1, Math.round(travelInfo.time));

        const activeShip = this.simulationService._getActiveShip();
        const activeShipState = this.gameState.player.shipStates[activeShip.id];
        
        if (activeShip.fuel < travelInfo.fuelCost) {
            this.uiManager.queueModal('event-modal', "Insufficient Fuel", `Trip modifications left you without enough fuel. You need ${travelInfo.fuelCost} but only have ${Math.floor(activeShip.fuel)}.`);
            this.logger.warn('TravelService', `Travel to ${locationId} aborted due to insufficient fuel after event mods.`);
            return;
        }

        if (eventMods.forceEvent) {
            if (this._checkForRandomEvent(locationId, true)) {
                return;
            }
        }

        let travelHullDamage = travelInfo.time * GAME_RULES.HULL_DECAY_PER_TRAVEL_DAY;
        if (state.player.activePerks[PERK_IDS.NAVIGATOR]) travelHullDamage *= DB.PERKS[PERK_IDS.NAVIGATOR].hullDecayMod;
        const eventHullDamageValue = activeShip.maxHealth * ((eventMods.eventHullDamagePercent || 0) / 100);
        const totalHullDamageValue = travelHullDamage + eventHullDamageValue;
        
        activeShipState.health -= totalHullDamageValue;
        this.simulationService._checkHullWarnings(activeShip.id);

        if (activeShipState.health <= 0) {
            this._handleShipDestruction(activeShip.id);
            return;
        }
        
        activeShipState.fuel -= travelInfo.fuelCost;
        this.timeService.advanceDays(travelInfo.time);
        if (this.gameState.isGameOver) return;
        
        // --- [[START]] MODIFICATION ---
        // Call onLocationChange() *before* setState.
        // This ensures the news ticker data is populated *before* the setState
        // triggers a UI.render(), preventing a re-render on the next click.
        this.simulationService.newsTickerService.onLocationChange();
        
        this.gameState.setState({ currentLocationId: locationId, pendingTravel: null });
        // --- [[END]] MODIFICATION ---

        // MOVED: onLocationChange() was moved up.

        const fromLocation = DB.MARKETS.find(m => m.id === fromId);
        const destination = DB.MARKETS.find(m => m.id === locationId);
        
        if (!fromLocation || !destination) {
            this.logger.error('TravelService', `Invalid location ID provided for travel animation. From: ${fromId}, To: ${locationId}`);
            this.uiManager.queueModal('event-modal', 'Navigation Error', 'Could not plot a course. The destination is unknown.');
            return;
        }

        const totalHullDamagePercentForDisplay = (totalHullDamageValue / activeShip.maxHealth) * 100;
        
        this.logger.info.player(this.gameState.day, 'TRAVEL_END', `Arrived at ${locationId}.`, {
            fuelUsed: travelInfo.fuelCost,
            hullDamage: totalHullDamagePercentForDisplay.toFixed(2) + '%'
        });

        const finalCallback = () => {
            if (this.gameState.tutorials.activeBatchId === 'intro_missions' && this.gameState.tutorials.activeStepId === 'mission_1_7' && locationId === LOCATION_IDS.LUNA) {
                this.simulationService.setScreen(NAV_IDS.DATA, SCREEN_IDS.MISSIONS);
            } else {
                this.simulationService.setScreen(NAV_IDS.STARPORT, SCREEN_IDS.MARKET);
            }
        };
        
        this.uiManager.showTravelAnimation(fromLocation, destination, travelInfo, totalHullDamagePercentForDisplay, finalCallback);
    }
    
    /**
     * Resumes a pending travel action after it was interrupted by an event.
     */
    resumeTravel() {
        if (!this.gameState.pendingTravel) return;
        this.logger.info.system('Game', this.gameState.day, 'TRAVEL_RESUME', 'Resuming travel after event.');
        const { destinationId, ...eventMods } = this.gameState.pendingTravel;
        this.initiateTravel(destinationId, eventMods);
    }

    /**
     * Checks for and triggers a random event based on a probability roll.
     * @param {string} destinationId
     * @param {boolean|number} [force=false]
     * @returns {boolean}
     * @private
     */
    _checkForRandomEvent(destinationId, force = false) {
        if (force === false && Math.random() > GAME_RULES.RANDOM_EVENT_CHANCE) return false;

        const activeShip = this.simulationService._getActiveShip();
        let event;

        if (typeof force === 'number') {
            event = DB.RANDOM_EVENTS[force];
        } else {
             const validEvents = DB.RANDOM_EVENTS.filter(event => 
                event.precondition(this.gameState.getState(), activeShip, this.simulationService._getActiveInventory.bind(this.simulationService))
            );
            if (validEvents.length === 0) return false;
            event = validEvents[Math.floor(Math.random() * validEvents.length)];
        }
        
        if (!event) {
            this.logger.warn('TravelService', `Debug event trigger failed for index: ${force}`);
            return false;
        }
        
        this.logger.info.system('Event', this.gameState.day, 'EVENT_TRIGGER', `Triggered random event: ${event.title}`);
        this.gameState.setState({ pendingTravel: { destinationId } });
        this.uiManager.showRandomEventModal(event, (eventId, choiceIndex) => this._resolveEventChoice(eventId, choiceIndex));
        return true;
    }

    /**
     * Resolves the player's choice in a random event and applies the outcome.
     * @param {string} eventId
     * @param {number} choiceIndex
     * @private
     */
    _resolveEventChoice(eventId, choiceIndex) {
        const event = DB.RANDOM_EVENTS.find(e => e.id === eventId);
        const choice = event.choices[choiceIndex];
        let random = Math.random();
        const chosenOutcome = choice.outcomes.find(o => (random -= o.chance) < 0) || choice.outcomes[choice.outcomes.length - 1];
    
        const effectResult = this._applyEventEffects(chosenOutcome);
    
        let description = chosenOutcome.description;
        if (effectResult && chosenOutcome.descriptions) {
            description = chosenOutcome.descriptions[effectResult.key];
            if (effectResult.amount) {
                description = description.replace('{amount}', effectResult.amount);
            }
        }
    
        this.logger.info.player(this.gameState.day, 'EVENT_CHOICE', `Chose '${choice.title}' for event '${event.title}'.`);
        this.uiManager.queueModal('event-modal', event.title, description, () => this.resumeTravel(), {
            buttonText: 'Continue Journey'
        });
    }

    /**
     * Applies a list of effects from a chosen event outcome by calling the effect resolver.
     * @param {object} outcome
     * @private
     */
    _applyEventEffects(outcome) {
        let result = null;
        outcome.effects.forEach(effect => {
            const effectResult = applyEffect(this.gameState, this.simulationService, effect, outcome);
            if (effectResult) {
                result = effectResult;
            }
        });
        this.gameState.setState({});
        return result;
    }

    /**
     * Handles the destruction of a player ship and the potential game over condition.
     * @param {string} shipId
     * @private
     */
    _handleShipDestruction(shipId) {
        const shipName = DB.SHIPS[shipId].name;
        this.logger.error('TravelService', `Ship ${shipName} was destroyed.`);
        this.gameState.player.ownedShipIds = this.gameState.player.ownedShipIds.filter(id => id !== shipId);
        delete this.gameState.player.shipStates[shipId];
        delete this.gameState.player.inventories[shipId];

        if (this.gameState.player.ownedShipIds.length === 0) {
            this.simulationService._gameOver(`Your last ship, the ${shipName}, was destroyed. Your trading career ends here.`);
        } else {
            this.gameState.player.activeShipId = this.gameState.player.ownedShipIds[0];
            const newShipName = DB.SHIPS[this.gameState.player.activeShipId].name;
            const message = `The ${shipName} suffered a catastrophic hull breach and was destroyed. All cargo was lost.<br><br>You now command your backup vessel, the ${newShipName}.`;
            this.uiManager.queueModal('event-modal', 'Vessel Lost', message);
        }
        this.gameState.setState({});
    }
}
--- END OF FILE: ./js/services/world/TravelService.js ---

--- START OF FILE: ./js/services/world/TimeService.js ---
// js/services/world/TimeService.js
/**
 * @fileoverview Responsible for advancing the game clock and triggering all
 * time-based events like birthdays, debt interest, and market replenishment.
 */
import { DB } from '../../data/database.js';
import { GAME_RULES, WEALTH_MILESTONES } from '../../data/constants.js';
import { formatCredits } from '../../utils.js';

export class TimeService {
    /**
     * @param {import('../GameState.js').GameState} gameState
     * @param {import('../simulation/MarketService.js').MarketService} marketService
     * @param {import('../UIManager.js').UIManager} uiManager
     * @param {import('../../services/LoggingService.js').Logger} logger
     */
    constructor(gameState, marketService, uiManager, logger) { // MODIFIED: Removed newsTickerService
        this.gameState = gameState;
        this.marketService = marketService;
        this.uiManager = uiManager;
        this.logger = logger;
        // this.newsTickerService = newsTickerService; // REMOVED
        this.simulationService = null; // To be injected
        
        // --- VIRTUAL WORKBENCH ---
        /** @type {import('../IntelService.js').IntelService | null} */
        this.intelService = null; // To be injected by SimulationService
        // --- END VIRTUAL WORKBENCH ---
    }

    // REMOVED: setNewsTickerService method

    /**
     * Advances game time by a specified number of days, triggering daily, weekly, and monthly events.
     * @param {number} days - The integer number of days to advance.
     */
    advanceDays(days) {
        this.logger.group(`[System] Advancing time by ${days} day(s) from Day ${this.gameState.day}`);
        for (let i = 0; i < days; i++) {
            if (this.gameState.isGameOver) {
                this.logger.warn('TimeService', 'Advance days aborted: Game is over.');
                this.logger.groupEnd();
                return;
            }
            this.gameState.day++;

            // MODIFIED: Call facade method on SimulationService
            if (this.simulationService) {
                this.simulationService.pulseNewsTicker();
            }

            const dayOfYear = (this.gameState.day - 1) % 365;
            const currentYear = DB.DATE_CONFIG.START_YEAR + Math.floor((this.gameState.day - 1) / 365);

            if (dayOfYear === 11 && currentYear > this.gameState.player.lastBirthdayYear) {
                this.gameState.player.playerAge++;
                this.gameState.player.birthdayProfitBonus += 0.01;
                this.gameState.player.lastBirthdayYear = currentYear;
                this.logger.info.state(this.gameState.day, 'BIRTHDAY', `Player is now age ${this.gameState.player.playerAge}. Profit bonus increased.`);
            }

            this._checkAgeEvents();
            this.marketService.evolveMarketPrices();

            if ((this.gameState.day - this.gameState.lastMarketUpdateDay) >= 7) {
                this.marketService.checkForSystemStateChange();
                this.marketService.replenishMarketInventory();
                this.marketService._updateShipyardStock(); // Correctly call the method on MarketService
                this.gameState.lastMarketUpdateDay = this.gameState.day;
            }

            
            // --- VIRTUAL WORKBENCH (PHASE 3) ---
            
            // --- NEW LOGIC: CHECK INTEL EXPIRATION ---
            const activeDeal = this.gameState.activeIntelDeal; // Check the live state, not a snapshot
            if (activeDeal && this.gameState.day > activeDeal.expiryDay) {
                const expiredDeal = activeDeal; // Store for cleanup
                
                // 1. Clear the active deal
                this.gameState.activeIntelDeal = null;
                this.logger.info.system('IntelService', this.gameState.day, 'EXPIRED', 'Active intel deal has expired.');

                // 2. Find and remove the source packet from the intelMarket list
                if (expiredDeal.sourceSaleLocationId && expiredDeal.sourcePacketId) {
                    const saleLocationMarket = this.gameState.intelMarket[expiredDeal.sourceSaleLocationId];
                    if (saleLocationMarket) {
                        this.gameState.intelMarket[expiredDeal.sourceSaleLocationId] = saleLocationMarket.filter(
                            packet => packet.id !== expiredDeal.sourcePacketId
                        );
                        this.logger.info.system('IntelService', this.gameState.day, 'PACKET_CLEANUP', `Removed expired packet ${expiredDeal.sourcePacketId} from ${expiredDeal.sourceSaleLocationId}.`);
                    }
                }
            }

            // --- NEW LOGIC: CHECK INTEL REFRESH ---
            // (Runs at the start of day 1, 121, 241, etc.)
            if (this.intelService && (this.gameState.day % 120 === 1)) {
                this.intelService.generateIntelRefresh();
            }
            
            // --- END VIRTUAL WORKBENCH ---
            
            this.gameState.player.ownedShipIds.forEach(shipId => {
                if (shipId !== this.gameState.player.activeShipId) {
                    const ship = DB.SHIPS[shipId];
                    const repairAmount = ship.maxHealth * GAME_RULES.PASSIVE_REPAIR_RATE;
                    this.gameState.player.shipStates[shipId].health = Math.min(ship.maxHealth, this.gameState.player.shipStates[shipId].health + repairAmount);
                }
            });

            if (this.gameState.player.debt > 0 && (this.gameState.day - this.gameState.lastInterestChargeDay) >= GAME_RULES.INTEREST_INTERVAL) {
                const interest = this.gameState.player.monthlyInterestAmount;
                this.gameState.player.debt += interest;
                this.simulationService._logTransaction('loan', interest, 'Monthly interest charge');
                this.logger.info.system('Finance', this.gameState.day, 'INTEREST', `Charged ${formatCredits(interest)} interest on debt.`);
                this.gameState.lastInterestChargeDay = this.gameState.day;
            }

            // Apply garnishment must be called daily
            this._applyGarnishment();
        }
        
        this.logger.groupEnd();
        this.gameState.setState({});
    }

    /**
     * Checks for and triggers age-based narrative events based on game progression.
     * @private
     */
    _checkAgeEvents() {
        DB.AGE_EVENTS.forEach(event => {
            if (this.gameState.player.seenEvents.includes(event.id)) return;
            if ((event.trigger.day && this.gameState.day >= event.trigger.day) || (event.trigger.credits && this.gameState.player.credits >= event.trigger.credits)) {
                this.gameState.player.seenEvents.push(event.id);
                this.logger.info.state(this.gameState.day, 'AGE_EVENT', `Triggered age event: ${event.title}`);
                this.uiManager.showAgeEventModal(event, (choice) => this.simulationService._applyPerk(choice));
            }
        });
    }

    /**
     * Checks if the player's wealth has reached a new milestone, revealing the next tier of commodities.
     * @private
     */
    _checkMilestones() {
        const { credits, revealedTier } = this.gameState.player;
        let currentTier = revealedTier;
        let nextMilestone = WEALTH_MILESTONES.find(m => m.revealsTier === currentTier + 1);

        while (nextMilestone && credits >= nextMilestone.threshold) {
            this.gameState.player.revealedTier = nextMilestone.revealsTier;
            this.logger.info.state(this.gameState.day, 'MILESTONE', `Unlocked Tier ${nextMilestone.revealsTier} commodities.`);
            
            currentTier = nextMilestone.revealsTier;
            nextMilestone = WEALTH_MILESTONES.find(m => m.revealsTier === currentTier + 1);
        }

        if (this.gameState.player.revealedTier !== revealedTier) {
            this.gameState.setState({});
        }
    }

    /**
     * Applies a monthly credit garnishment if the player's loan is delinquent.
     * @private
     */
    _applyGarnishment() {
        const { player, day } = this.gameState;
        if (player.debt > 0 && player.loanStartDate && (day - player.loanStartDate) >= GAME_RULES.LOAN_GARNISHMENT_DAYS) {
            
            // Garnishment only happens on the 30-day interval
            if ((day - this.gameState.lastInterestChargeDay) % GAME_RULES.INTEREST_INTERVAL !== 0) {
                return;
            }

            const garnishedAmount = Math.floor(player.credits * GAME_RULES.LOAN_GARNISHMENT_PERCENT);
            if (garnishedAmount > 0) {
                player.credits -= garnishedAmount;
                this.simulationService._logTransaction('debt', -garnishedAmount, 'Monthly credit garnishment');
                
                // This is the single, non-performative place to check for game over
                this.simulationService._checkGameOverConditions(); 
            }

            if (!player.seenGarnishmentWarning) {
                const msg = "Your loan is delinquent. Your lender is now garnishing 14% of your credits monthly until the debt is paid.";
                this.uiManager.queueModal('event-modal', "Credit Garnishment Notice", msg, null, { buttonClass: 'bg-red-800/80' });
                player.seenGarnishmentWarning = true;
                this.logger.warn('Finance', `Loan delinquent. Garnishment of ${GAME_RULES.LOAN_GARNISHMENT_PERCENT * 100}% initiated.`);
            }
        }
    }

    /**
     * Gets the current game day.
     * @returns {number} The current day.
     * @JSDoc
     */
    getCurrentDay() {
        // This helper is used by IntelService
        return this.gameState.day;
    }
}
--- END OF FILE: ./js/services/world/TimeService.js ---

--- START OF FILE: ./js/services/game/IntroService.js ---
// js/services/game/IntroService.js
/**
 * @fileoverview Manages the new game introduction sequence, from the initial
 * lore modals to the final tutorial kickoff.
 */
import { DB } from '../../data/database.js';
import { formatCredits } from '../../utils.js';
import { NAV_IDS, SCREEN_IDS, SHIP_IDS } from '../../data/constants.js';

export class IntroService {
    /**
     * @param {import('../GameState.js').GameState} gameState
     * @param {import('../UIManager.js').UIManager} uiManager
     * @param {import('../../services/LoggingService.js').Logger} logger
     * @param {import('../SimulationService.js').SimulationService} simulationServiceFacade
     */
    constructor(gameState, uiManager, logger, simulationServiceFacade) {
        this.gameState = gameState;
        this.uiManager = uiManager;
        this.logger = logger;
        this.simulationService = simulationServiceFacade; // Renamed to avoid confusion
    }

    /**
     * Kicks off the interactive new game introduction sequence.
     */
    start() {
        if (!this.gameState.introSequenceActive) return;
        this.logger.info.state(this.gameState.day, 'INTRO_START', 'Starting new game introduction sequence.');
        // Set the initial state for the intro: No ship, ready for the tutorial purchase.
        this.gameState.player.ownedShipIds = [];
        this.gameState.player.activeShipId = null;
        this.gameState.player.shipStates = {};
        this.gameState.player.inventories = {};
        this.gameState.player.introStep = 0;
        this._showNextModal();
    }

    /**
     * Handles all delegated click events during the intro sequence to manage its flow.
     * @param {Event} e - The click event object.
     */
    handleIntroClick(e) {
        const button = e.target.closest('button');
        if (!button) return;
        const targetId = button.id;
        
        if (targetId === 'intro-next-btn') {
            button.disabled = true;
            this._showNextModal();
        } else if (targetId === 'intro-submit-btn') {
            button.disabled = true;
            const input = document.getElementById('signature-input');
            const playerName = input.value.trim();
            const sanitizedPlayerName = playerName.replace(/[^a-zA-Z0-9 ]/g, '');
    
            if (!sanitizedPlayerName || sanitizedPlayerName.length === 0) {
                this.uiManager.queueModal('event-modal', 'Invalid Signature', "The Merchant's Guild requires a valid name on the contract. Please provide your legal mark.", () => {
                    // This callback runs after the "Invalid Signature" modal is closed.
                    // We need to re-show the signature modal without advancing the step.
                    this.gameState.player.introStep--; // Decrement to counteract the increment in _showNextModal
    
                    this._showNextModal();
                });
            } else {
                this.gameState.player.name = sanitizedPlayerName;
                this.gameState.player.debt = 25000;
                this.gameState.player.loanStartDate = this.gameState.day;
                this.gameState.player.monthlyInterestAmount = 390;
    
                this.logger.info.state(this.gameState.day, 'LOAN_ACCEPTED', `Player ${sanitizedPlayerName} accepted Guild loan.`, {
                    debt: 25000,
                     name: sanitizedPlayerName
                });
                this._startProcessingSequence();
            }
        }
    }

    /**
     * Continues the intro sequence after a tutorial batch is completed.
     * @param {string} completedBatchId - The ID of the tutorial batch that just finished.
     */
    continueAfterTutorial(completedBatchId) {
        if (completedBatchId === 'intro_hangar') {
            this.simulationService.setScreen(NAV_IDS.DATA, SCREEN_IDS.FINANCE);
            this.simulationService.tutorialService.checkState({ type: 'ACTION', action: 'INTRO_START_FINANCE' });
        } else if (completedBatchId === 'intro_finance') {
 
             this._end();
        }
    }

    /**
     * Displays the next modal in the introduction sequence.
     * @private
     */
    _showNextModal() {
        const step = DB.INTRO_SEQUENCE_V1.modals[this.gameState.player.introStep];
        if (!step) {
            this._end();
            return;
        }

        const options = {
            buttonClass: step.buttonClass,
            contentClass: step.contentClass,
        };
        
        if (this.gameState.player.introStep === 0) {
            options.specialClass = 'intro-fade-in';
        }

        let modalId = 'event-modal';

        if (step.id === 'charter' || step.id === 'signature') {
            modalId = `${step.id}-modal`;
            options.customSetup = (modal, closeHandler) => { this._setupInteractiveModal(modal, step, closeHandler) };
        } else {
            options.customSetup = (modal, closeHandler) => {
                const btnContainer = modal.querySelector('#event-button-container');
                if (!btnContainer) return;
                btnContainer.innerHTML = '';

                const button = document.createElement('button');
                button.className = 'btn px-6 py-2';
                if(step.buttonClass) button.classList.add(step.buttonClass);
                button.id = 'intro-next-btn';
                button.innerHTML = step.buttonText;
                button.onclick = (e) => {
                    e.target.disabled = true;
                    closeHandler();
                };
                btnContainer.appendChild(button);
            };
        }

        this.uiManager.queueModal(modalId, step.title, step.description, () => this.gameState.player.introStep++, options);
    }

    /**
     * Performs custom setup for interactive modals in the intro.
     * @param {HTMLElement} modal
     * @param {object} step
     * @param {function} closeHandler
     * @private
     */
    _setupInteractiveModal(modal, step, closeHandler) {
        const buttonContainer = modal.querySelector(`#${step.id}-button-container`);
        buttonContainer.innerHTML = '';
        const button = document.createElement('button');
        button.className = 'btn px-6 py-2';
        button.innerHTML = step.buttonText;
        button.onclick = (e) => {
            e.target.disabled = true;
            closeHandler();
        };
        buttonContainer.appendChild(button);

        if (step.id === 'signature') {
            const input = modal.querySelector('#signature-input');
            input.value = '';
            button.id = 'intro-submit-btn';
            button.disabled = true;
            
            button.onclick = closeHandler;

            input.oninput = () => {
                button.disabled = input.value.trim() === '';
            };
        } else {
            button.id = 'intro-next-btn';
        }
    }

    /**
     * Manages the animated sequence for loan processing.
     * @private
     */
    _startProcessingSequence() {
        const showApprovalModal = () => {
            const title = 'Loan Approved';
            const description = `Dear ${this.gameState.player.name},<br><br>Your line of credit has been <b>approved</b>.<br><br><span class="credits-text-pulsing">⌬ 25,000</span> is ready to transfer to your account.`;
            const hangarTransition = (event) => {
                const button = event.target;
                if(button) button.disabled = true;
                
                this.uiManager.createFloatingText(`+${formatCredits(25000, false)}`, event.clientX, event.clientY, '#34d399');
                
                // --- VIRTUAL WORKBENCH: APPLY CREDIT CAP ---
                this.gameState.player.credits = Math.min(Number.MAX_SAFE_INTEGER, this.gameState.player.credits + 25000);
                // --- END VIRTUAL WORKBENCH ---

                this.logger.info.player(this.gameState.day, 'CREDITS_TRANSFER', 'Accepted loan transfer of ⌬25,000');

                setTimeout(() => {
                    this.uiManager.showGameContainer();
                    this.uiManager.render(this.gameState.getState());
                    this.simulationService.setScreen(NAV_IDS.STARPORT, SCREEN_IDS.HANGAR);
                    this.simulationService.tutorialService.checkState({ type: 'ACTION', action: 'INTRO_START_HANGAR' });
                }, 2000);
            };

            this.uiManager.queueModal('event-modal', title, description, null, {
                contentClass: 'text-center',
                customSetup: (modal, closeHandler) => {
                    modal.querySelector('.modal-content').classList.add('modal-theme-admin');
     
                    const btnContainer = modal.querySelector('#event-button-container');

                    btnContainer.innerHTML = '';
                    const button = document.createElement('button');
                    button.className = 'btn px-6 py-2';
                    button.innerHTML = 'Accept Transfer';
                    button.onclick = (event) => {
                        hangarTransition(event);
                        closeHandler();
                    };
                  
                     btnContainer.appendChild(button);
                }
            });
        };
        
        this.uiManager.showProcessingAnimation(this.gameState.player.name, showApprovalModal);
    }

    /**
     * Finalizes the intro sequence.
     * @private
     */
    _end() {
        this.gameState.introSequenceActive = false;
        this.logger.info.state(this.gameState.day, 'INTRO_END', 'Introduction sequence complete.');
        const finalStep = DB.INTRO_SEQUENCE_V1.modals.find(s => s.id === 'final');
        const shipName = DB.SHIPS[this.gameState.player.activeShipId].name;
        const buttonText = finalStep.buttonText.replace('{shipName}', shipName);
    
        this.gameState.tutorials.navLock = { navId: NAV_IDS.DATA, screenId: SCREEN_IDS.FINANCE };
    
        this.uiManager.queueModal('event-modal', finalStep.title, finalStep.description, () => {
     
             this.simulationService.setScreen(NAV_IDS.DATA, SCREEN_IDS.MISSIONS);
             this.simulationService.tutorialService.checkState({ type: 'ACTION', action: 'INTRO_START_MISSIONS' });
        }, { buttonText: buttonText });
        
        this.uiManager.render(this.gameState.getState());
    }
}
--- END OF FILE: ./js/services/game/IntroService.js ---

--- START OF FILE: ./js/services/SimulationService.js ---
// js/services/SimulationService.js
/**
 * @fileoverview This file contains the SimulationService class, which acts as the core game engine
 * facade. It instantiates all specialized game logic services and delegates calls to them,
 * providing a single, clean API for the EventManager.
 */
import { DB } from '../data/database.js';
import { calculateInventoryUsed, formatCredits } from '../utils.js';
// VIRTUAL WORKBENCH: Import new playBlockingAnimationAndRemove
import { GAME_RULES, SAVE_KEY, SHIP_IDS, PERK_IDS, ACTION_IDS } from '../data/constants.js';
import { playBlockingAnimation, playBlockingAnimationAndRemove } from './ui/AnimationService.js';
// END VIRTUAL WORKBENCH
import { MarketService } from './simulation/MarketService.js';
import { IntroService } from './game/IntroService.js';
import { PlayerActionService } from './player/PlayerActionService.js';
import { TimeService } from './world/TimeService.js';
import { TravelService } from './world/TravelService.js';
// --- VIRTUAL WORKBENCH: IMPORT ---
import { IntelService } from './IntelService.js';
// --- END VIRTUAL WORKBENCH ---

/**
 * @class SimulationService
 * @description Manages the core game loop, player actions, and state changes by delegating to specialized services.
 */
export class SimulationService {
    /**
     * @param {import('./GameState.js').GameState} gameState - The central state object.
     * @param {import('./UIManager.js').UIManager} uiManager - The UI rendering service.
     * @param {import('./LoggingService.js').Logger} logger - The logging utility.
     * @param {import('./NewsTickerService.js').NewsTickerService} newsTickerService - The news ticker service.
     */
    constructor(gameState, uiManager, logger, newsTickerService) { // MODIFIED
        this.gameState = gameState;
        this.uiManager = uiManager;
        this.logger = logger;
        this.newsTickerService = newsTickerService; // ADDED
        this.tutorialService = null; // Injected post-instantiation.
        this.missionService = null;  // Injected post-instantiation.
        
        // --- VIRTUAL WORKBENCH: ADD INTEL SERVICE ---
        this.intelService = null; // Will be instantiated below
        // --- END VIRTUAL WORKBENCH ---

  
         // Instantiate all services
        this.marketService = new MarketService(gameState);
        // MODIFIED: Pass newsTickerService
        this.timeService = new TimeService(gameState, this.marketService, uiManager, logger, newsTickerService); 
        this.travelService = new TravelService(gameState, uiManager, this.timeService, logger, this);
        this.introService = new IntroService(gameState, uiManager, logger, this);
        this.playerActionService = new PlayerActionService(gameState, uiManager, null, this.marketService, this.timeService, logger, this);

        // --- VIRTUAL WORKBENCH: INSTANTIATE AND INJECT INTEL SERVICE ---
        // Must be after dependencies (time, market, news) are created
        this.intelService = new IntelService(gameState, this.timeService, this.marketService, this.newsTickerService, logger);
        
        // Inject intelService into services that depend on it
        this.timeService.intelService = this.intelService;
        this.uiManager.setIntelService(this.intelService); // UIManager will need this setter
        // --- END VIRTUAL WORKBENCH ---

        // Inject cross-dependencies that couldn't be set in constructors
        this.timeService.simulationService = this;
        
        // --- [NEW V2 CHANGE] ---
        // Inject services required by NewsTickerService for dynamic content.
        this.newsTickerService.setServices(this, this.marketService);
        // --- [END NEW V2 CHANGE] ---
    }

    /**
     * Injects the TutorialService after all services have been instantiated.
     * @param {import('./TutorialService.js').TutorialService} tutorialService
     */
    setTutorialService(tutorialService) {
        this.tutorialService = tutorialService;
    }

    /**
     * Injects the MissionService after all services have been instantiated.
     * @param {import('./MissionService.js').MissionService} missionService
     */
    setMissionService(missionService) {
        this.missionService = missionService;
        this.playerActionService.missionService = missionService;
    }

    // --- FACADE METHODS ---
    // These methods provide a clean API to the EventManager and other high-level services,
    // delegating the actual work to the specialized services.

    // IntroService Delegation
    startIntroSequence() { this.introService.start(); }
    handleIntroClick(e) { this.introService.handleIntroClick(e); }
    _continueIntroSequence(batchId) { this.introService.continueAfterTutorial(batchId); }
    
    // PlayerActionService Delegation
    buyItem(goodId, quantity) { return this.playerActionService.buyItem(goodId, quantity); }
    sellItem(goodId, quantity) { return this.playerActionService.sellItem(goodId, quantity); }
    
    /**
     * Orchestrates buying a ship: Validates, plays animation, then executes.
     * @param {string} shipId
     * @param {Event} event
     */
    async buyShip(shipId, event) {
        
        // 1. Validate
        const validation = this.playerActionService.validateBuyShip(shipId);
        if (!validation.success) {
            this.uiManager.queueModal('event-modal', validation.errorTitle, validation.errorMessage);
            return null;
        }

        // --- VIRTUAL WORKBENCH: ADD PRE-ACTION GLOW ---
        // 2. Find the button that was clicked
        const purchaseButton = event.target.closest('.action-button');

        // 3. Trigger the BLOCKING 1-second glow
        if (purchaseButton) {
            // Use playBlockingAnimationAndRemove to properly clean up the class
            await playBlockingAnimationAndRemove(purchaseButton, 'is-glowing-green');
        }
        
        // 4. (NEW) Wait one animation frame to prevent animation race condition
        await new Promise(resolve => requestAnimationFrame(resolve));
        // --- END VIRTUAL WORKBENCH ---

        // 5. Animate (Dematerialize)
        this.logger.info.system('SimService', this.gameState.day, 'SHIP_ANIMATION_START', `Starting buy animation for ${shipId}.`);
        await this.uiManager.runShipTransactionAnimation(shipId);
        this.logger.info.system('SimService', this.gameState.day, 'SHIP_ANIMATION_END', `Buy animation complete. Executing logic.`);

        // 6. Execute
        return this.playerActionService.executeBuyShip(shipId, event);
    }

    /**
     * Orchestrates selling a ship: Validates, plays animation, then executes.
     * @param {string} shipId
     * @param {Event} event
     */
    async sellShip(shipId, event) {
        // 1. Validate
        const validation = this.playerActionService.validateSellShip(shipId);
        if (!validation.success) {
            this.uiManager.queueModal('event-modal', validation.errorTitle, validation.errorMessage);
            return false;
        }

        // --- VIRTUAL WORKBENCH: ADD PRE-ACTION GLOW ---
        // 2. Find the button that was clicked
        const sellButton = event.target.closest('.action-button');

        // 3. Trigger the BLOCKING 1-second glow
        if (sellButton) {
            // Use playBlockingAnimationAndRemove to properly clean up the class
            await playBlockingAnimationAndRemove(sellButton, 'is-glowing-red');
        }
        
        // 4. (NEW) Wait one animation frame to prevent animation race condition
        await new Promise(resolve => requestAnimationFrame(resolve));
        // --- END VIRTUAL WORKBENCH ---

        // 5. Animate (Dematerialize)
        this.logger.info.system('SimService', this.gameState.day, 'SHIP_ANIMATION_START', `Starting sell animation for ${shipId}.`);
        await this.uiManager.runShipTransactionAnimation(shipId);
        this.logger.info.system('SimService', this.gameState.day, 'SHIP_ANIMATION_END', `Sell animation complete. Executing logic.`);

        // 6. Execute
        return this.playerActionService.executeSellShip(shipId, event);
    }

    // --- VIRTUAL WORKBENCH: RE-ORCHESTRATE boardShip ---
    /**
     * Orchestrates boarding a ship: Glows button, waits 1s, sets state, then animates card.
     * @param {string} shipId
     * @param {Event} event - The click event, used to find the button for animation.
     * @returns {Promise<boolean>} True on success, false on failure.
     * @JSDoc
     */
    async boardShip(shipId, event) {
        // 1. Validate
        const validation = this.playerActionService.validateSetActiveShip(shipId);
        if (!validation.success) {
            if (validation.errorTitle !== "Action Redundant") {
                 this.uiManager.queueModal('event-modal', validation.errorTitle, validation.errorMessage);
            }
            return false;
        }

        // --- NEW SEQUENCE ---

   
         // 2. Find the button that was clicked
        const boardButton = event.target.closest('.action-button');
        
        // 3. (NEW) Find the sibling "Sell" button and disable it immediately
        if (boardButton) {
            const sellButton = boardButton.closest('.grid').querySelector('[data-action="sell-ship"]');
            if (sellButton) {
                sellButton.disabled = true;
            }
        }

        // 4. Trigger the BLOCKING 1-second glow on the "Board" button
  
         if (boardButton) {
            // This is the new BLOCKING helper that waits for the animation to end
            await playBlockingAnimationAndRemove(boardButton, 'is-glowing-button');
        }

        // 5. Execute the state change (this will re-render button to "ACTIVE")
        this.playerActionService.executeSetActiveShip(shipId);
        
        // 6. Check Tutorial
        if (this.gameState.introSequenceActive) {
            this.tutorialService.checkState({ type: 'ACTION', action: ACTION_IDS.SELECT_SHIP });
        }
   
      
        // 7. Run the BLOCKING card animation *LAST*
        // We must wait one frame for the UI to re-render *before* we can
        // find the element we want to animate.
        await new Promise(resolve => requestAnimationFrame(resolve));
        
        this.logger.info.system('SimService', this.gameState.day, 'SHIP_ANIMATION_START', `Starting board animation for ${shipId}.`);
        await this.uiManager.runShipTransactionAnimation(shipId, 'is-boarding');
        this.logger.info.system('SimService', this.gameState.day, 'SHIP_ANIMATION_END', `Board animation complete.`);
        // --- END NEW SEQUENCE ---
        
        return true;
    }
    // --- END VIRTUAL WORKBENCH ---

    /**
     * Pays off the player's entire outstanding debt.
     * @param {Event} [event] - The click event for placing floating text.
     */
    payOffDebt(event) { this.playerActionService.payOffDebt(event); }

    /**
     * Allows the player to take out a loan, adding to their debt.
     * @param {object} loanData - Contains amount, fee, and interest for the loan.
     * @param {Event} [event] - The click event for placing floating text.
     */
    takeLoan(loanData, event) { this.playerActionService.takeLoan(loanData, event); }
    
    purchaseLicense(licenseId) { return this.playerActionService.purchaseLicense(licenseId); }
    
 
     // --- VIRTUAL WORKBENCH: REMOVE OBSOLETE METHOD ---
    // purchaseIntel(cost) { this.playerActionService.purchaseIntel(cost); } // This is now handled by UIManager + IntelService
    // --- END VIRTUAL WORKBENCH ---

    refuelTick() { return this.playerActionService.refuelTick(); }
    repairTick() { return this.playerActionService.repairTick(); }
    
    // TravelService Delegation
    travelTo(locationId) { this.travelService.travelTo(locationId); }
    resumeTravel() { this.travelService.resumeTravel(); }

    // ADDED: NewsTickerService Delegation
    /**
     * Pushes a new message to the news ticker.
     * @param {string} text - The message content.
     * @param {string} type - 'SYSTEM', 'INTEL', 'FLAVOR', 'ALERT'
     * @param {boolean} [isPriority=false] - If true, prepends to the front.
     */
    pushNewsMessage(text, type, isPriority = false) {
        if (this.newsTickerService) {
            this.newsTickerService.pushMessage(text, type, isPriority);
        }
    }

    /**
     * Pulses the news ticker for daily updates (e.g., flavor text).
     */
    pulseNewsTicker() {
        if (this.newsTickerService) {
            this.newsTickerService.pulse();
        }
    }

    // --- CORE & SHARED METHODS ---
    // These methods remain in the facade because they are either simple state setters
    // or are helpers required by multiple services.

    /**
     * Sets the active navigation tab and screen.
     * @param {string} navId
     * @param {string} screenId
     */
    setScreen(navId, screenId) {
        const newLastActive = { ...this.gameState.lastActiveScreen, [navId]: screenId };
        this.gameState.setState({ 
            activeNav: navId, 
             activeScreen: screenId,
            lastActiveScreen: newLastActive 
        });

        // --- [NEW V2 CHANGE] ---
        // MODIFICATION: Removed the onLocationChange() call from this function.
        // It will now be called by TravelService when the location *actually* changes.
        // --- [END NEW V2 CHANGE] ---

        if (this.tutorialService) {
            this.tutorialService.checkState({ type: 'SCREEN_LOAD', screenId: screenId });
        }
    }

   
     // --- VIRTUAL WORKBENCH: ADD MISSING METHOD ---
    /**
     * Sets the active tab on the Intel screen.
     * @param {string} tabId The ID of the tab content to activate (e.g., 'intel-codex-content').
     * @JSDoc
     */
    setIntelTab(tabId) {
        if (this.gameState.uiState.activeIntelTab !== tabId) {
            this.gameState.uiState.activeIntelTab = tabId;
            this.gameState.setState({ 
                uiState: this.gameState.uiState 
            });
        }
    }
    // --- END VIRTUAL WORKBENCH ---

    /**
     * Sets the hangar/shipyard toggle state.
     * @param {string} mode - 'hangar' or 'shipyard'.
     */
    setHangarShipyardMode(mode) {
        if (this.gameState.uiState.hangarShipyardToggleState !== mode) {
            this.gameState.uiState.hangarShipyardToggleState = mode;
            this.gameState.setState({});
        }
    }
    
    /**
     * Updates the active index for the hangar or shipyard carousel.
     * @param {number} index
     * @param {string} mode
     */
    setHangarCarouselIndex(index, mode) {
        if (mode === 'hangar') {
            this.gameState.uiState.hangarActiveIndex = index;
        } else {
            this.gameState.uiState.shipyardActiveIndex = index;
        }
        this.gameState.setState({});
    }

    /**
     * Cycles the hangar/shipyard carousel.
     * @param {string} direction - 'next' or 'prev'.
     */
    cycleHangarCarousel(direction) {
        const { uiState, player } = this.gameState;
        const isHangarMode = uiState.hangarShipyardToggleState === 'hangar';
        const shipList = isHangarMode ? player.ownedShipIds : this._getShipyardInventory().map(([id]) => id);
        
        if (shipList.length <= 1) return;

        let currentIndex = isHangarMode ? (uiState.hangarActiveIndex || 0) : (uiState.shipyardActiveIndex || 0);

        if (direction === 'next') {
            currentIndex = (currentIndex + 1) % shipList.length;
        } else {
            currentIndex = (currentIndex - 1 + shipList.length) % shipList.length;
        }

        this.setHangarCarouselIndex(currentIndex, isHangarMode ? 'hangar' : 'shipyard');
    }

    /**
     * Ends the game and displays a final message.
     * @param {string} message
     * @private
     */
    _gameOver(message) {
        if (this.gameState.isGameOver) return; // Prevent multiple game over triggers
        this.logger.info.state(this.gameState.day, 'GAME_OVER', message);
        this.gameState.setState({ isGameOver: true });
        this.uiManager.queueModal('event-modal', "Game Over", message, () => {
            localStorage.removeItem(SAVE_KEY);
            window.location.reload();
        }, { buttonText: 'Restart' });
    }

    /**
     * Checks for any condition that would end the game, such as bankruptcy.
     * This is intended to be called only by automated processes that can
     * reduce credits without a prior "insufficient funds" check (e.g., garnishment, debug).
     * @private
     */
    _checkGameOverConditions() {
        // This is the performant check: it reads directly from the state
        // object instead of creating an expensive deep copy with getState().
        if (this.gameState.player.credits <= 0) {
            this._gameOver("Your credit balance has fallen to zero. With no funds to operate, your trading career has come to an end.");
        }
    }

    // --- HELPER & PRIVATE METHODS (SHARED) ---
    // These are kept here to be accessible by the specialized services that need them.

    addShipToHangar(shipId) {
        const ship = DB.SHIPS[shipId];
        if (!ship) return;
        this.gameState.player.ownedShipIds.push(shipId);
        this.gameState.player.shipStates[shipId] = { health: ship.maxHealth, fuel: ship.maxFuel, hullAlerts: { one: false, two: false } };
        if (!this.gameState.player.inventories[shipId]) {
            this.gameState.player.inventories[shipId] = {};
            DB.COMMODITIES.forEach(c => {
                this.gameState.player.inventories[shipId][c.id] = { quantity: 0, avgCost: 0 };
            });
        }
    }

    _applyPerk(choice) {
        this.logger.info.player(this.gameState.day, 'PERK_APPLIED', `Gained perk: ${choice.title}`);
        if (choice.perkId) this.gameState.player.activePerks[choice.perkId] = true;
        if (choice.playerTitle) this.gameState.player.playerTitle = choice.playerTitle;
        if (choice.perkId === PERK_IDS.MERCHANT_GUILD_SHIP) {
            this.addShipToHangar(SHIP_IDS.STALWART);
            this.uiManager.queueModal('event-modal', 'Vessel Delivered', `The Merchant's Guild has delivered a new ${DB.SHIPS[SHIP_IDS.STALWART].name} to your hangar.`);
        }
        this.gameState.setState({});
    }
    
    _getActiveShip() {
        const state = this.gameState;
        const activeId = state.player.activeShipId;
        if (!activeId) return null;
        return { id: activeId, ...DB.SHIPS[activeId], ...state.player.shipStates[activeId] };
    }

    _getActiveInventory() {
        if (!this.gameState.player.activeShipId) return null;
        return this.gameState.player.inventories[this.gameState.player.activeShipId];
    }
    
    _checkHullWarnings(shipId) {
        const shipState = this.gameState.player.shipStates[shipId];
        const shipStatic = DB.SHIPS[shipId];
        const healthPct = (shipState.health / shipStatic.maxHealth) * 100;
        if (healthPct <= 15 && !shipState.hullAlerts.two) { shipState.hullAlerts.two = true; } 
        else if (healthPct <= 30 && !shipState.hullAlerts.one) { shipState.hullAlerts.one = true; }
        if (healthPct > 30) shipState.hullAlerts.one = false;
        if (healthPct > 15) shipState.hullAlerts.two = false;
    }

    _logTransaction(type, amount, description) {
        this.gameState.player.financeLog.push({ 
            day: this.gameState.day,
            type: type, 
            amount: amount,
            balance: this.gameState.player.credits,
            description: description
        });
        // Enforce the history limit
        while (this.gameState.player.financeLog.length > GAME_RULES.FINANCE_HISTORY_LENGTH) {
            this.gameState.player.financeLog.shift();
        }
    }

    _logConsolidatedTrade(goodName, quantity, transactionValue) {
        const log = this.gameState.player.financeLog;
        const isBuy = transactionValue < 0;
        const actionWord = isBuy ? 'Bought' : 'Sold';
        const existingEntry = log.find(entry => 
            entry.day === this.gameState.day &&
            entry.type === 'trade' &&
            entry.description.startsWith(`${actionWord}`) &&
             entry.description.endsWith(` ${goodName}`) &&
            ((isBuy && entry.amount < 0) || (!isBuy && entry.amount > 0))
        );
        if (existingEntry) {
            existingEntry.amount += transactionValue;
            existingEntry.balance = this.gameState.player.credits;
            const match = existingEntry.description.match(/\s(\d+)x\s/);
            if (match) {
                const currentQty = parseInt(match[1], 10);
                existingEntry.description = `${actionWord} ${currentQty + quantity}x ${goodName}`;
            }
        } else {
             this._logTransaction('trade', transactionValue, `${actionWord} ${quantity}x ${goodName}`);
        }
    }

    _logConsolidatedTransaction(type, amount, description) {
        const log = this.gameState.player.financeLog;
        const lastEntry = log.length > 0 ? log[log.length - 1] : null;
        if (lastEntry && lastEntry.day === this.gameState.day && lastEntry.type === type) {
            lastEntry.amount += amount;
            lastEntry.balance = this.gameState.player.credits;
        } else {
            this._logTransaction(type, amount, description);
        }
    }

    _getShipyardInventory() {
        const { tutorials, player, currentLocationId, market } = this.gameState;
        if (tutorials.activeBatchId === 'intro_hangar') {
            return player.ownedShipIds.length > 0 ? [] : [SHIP_IDS.WANDERER, SHIP_IDS.STALWART, SHIP_IDS.MULE].map(id => [id, DB.SHIPS[id]]);
        } else {
            const shipsForSaleIds = market.shipyardStock[currentLocationId]?.shipsForSale || [];
            return shipsForSaleIds.map(id => [id, DB.SHIPS[id]]).filter(([id]) => !player.ownedShipIds.includes(id));
        }
    }

    _grantRewards(rewards, sourceName) {
        rewards.forEach(reward => {
            if (reward.type === 'credits') {
              
                // --- VIRTUAL WORKBENCH: APPLY CREDIT CAP ---
                this.gameState.player.credits = Math.min(Number.MAX_SAFE_INTEGER, this.gameState.player.credits + reward.amount);
                // --- END VIRTUAL WORKBENCH ---

                this._logTransaction('mission', reward.amount, `Reward: ${sourceName}`);
                this.uiManager.createFloatingText(`+${formatCredits(reward.amount, false)}`, window.innerWidth / 2, window.innerHeight / 2, '#34d399');
            }
            if (reward.type === 'license') {
                if (!this.gameState.player.unlockedLicenseIds.includes(reward.licenseId)) {
                 
                     this.gameState.player.unlockedLicenseIds.push(reward.licenseId);
                    const license = DB.LICENSES[reward.licenseId];
                    this.uiManager.triggerEffect('systemSurge', { theme: 'tan' });
                    this.logger.info.player(this.gameState.day, 'LICENSE_GRANTED', `Received ${license.name}.`);
                }
            }
        });
    }
    
    grantMissionCargo(missionId) {
        const mission = DB.MISSIONS[missionId];
        if (!mission || !mission.providedCargo) return;
        const inventory = this._getActiveInventory();
        if (!inventory) {
            this.logger.error('SimulationService', 'Cannot grant mission cargo: No active inventory found.');
            return;
        }
        mission.providedCargo.forEach(cargo => {
            if (!inventory[cargo.goodId]) {
                inventory[cargo.goodId] = { quantity: 0, avgCost: 0 };
         
             }
            inventory[cargo.goodId].quantity += cargo.quantity;
            this.logger.info.player(this.gameState.day, 'CARGO_GRANT', `Received ${cargo.quantity}x ${DB.COMMODITIES.find(c=>c.id === cargo.goodId).name} from ${mission.name}.`);
        });
        if (this.missionService) {
            this.missionService.checkTriggers();
        }
    }
}
--- END OF FILE: ./js/services/SimulationService.js ---

--- START OF FILE: ./js/services/event-effects/effectAdriftPassenger.js ---
// js/services/event-effects/effectAdriftPassenger.js
/**
 * @fileoverview This file contains the specific logic for resolving the "Adrift Passenger"
 * random event outcome. It demonstrates a conditional effect that changes based on the
 * player's current cargo space and debt status.
 */
import { formatCredits, calculateInventoryUsed } from '../../utils.js';
import { COMMODITY_IDS } from '../../data/constants.js';
import { DB } from '../../data/database.js';

/**
 * @typedef {import('../../services/GameState.js').GameState} GameState
 * @typedef {import('../../services/SimulationService.js').SimulationService} SimulationService
 */

/**
 * Resolves the "Adrift Passenger" event outcome where the player gives them a fuel cell.
 * The reward is conditional:
 * 1. If the player has enough cargo space, they receive Cybernetics.
 * 2. If not, and they have debt, the passenger pays off a portion of it.
 * 3. If they have no cargo space and no debt, they receive credits instead.
 *
 * @param {GameState} gameState - The mutable game state object.
 * @param {SimulationService} simulationService - The simulation service instance, used here to log transactions.
 * @param {object} outcome - The chosen outcome object from the database.
 * @returns {object} An object containing a `key` to select the correct description and a dynamic `amount` for formatting.
 */
export function resolveAdriftPassenger(gameState, simulationService, outcome) {
    const ship = simulationService._getActiveShip();
    const shipState = gameState.player.shipStates[ship.id];
    const inventory = simulationService._getActiveInventory();

    // The cost of the choice is paid first.
    shipState.fuel = Math.max(0, shipState.fuel - 30);

    // Ensure the awarded commodity exists in the inventory before attempting to modify it.
    if (!inventory[COMMODITY_IDS.CYBERNETICS]) {
        inventory[COMMODITY_IDS.CYBERNETICS] = { quantity: 0, avgCost: 0 };
    }

  
     // Determine the reward based on player's current state.
    if (calculateInventoryUsed(inventory) + 40 <= ship.cargoCapacity) {
        inventory[COMMODITY_IDS.CYBERNETICS].quantity += 40;
        return { key: 'reward_cybernetics' };
    } else if (gameState.player.debt > 0) {
        const paid = Math.floor(gameState.player.debt * 0.20);
        gameState.player.debt -= paid;
        simulationService._logTransaction('event', paid, 'Passenger paid off debt');
        return { key: 'reward_debt_paid', amount: formatCredits(paid) };
    } else {
        const credits = Math.floor(gameState.player.credits * 0.05);
        
        // --- VIRTUAL WORKBENCH: APPLY CREDIT CAP ---
        gameState.player.credits = Math.min(Number.MAX_SAFE_INTEGER, gameState.player.credits + credits);
        // --- END VIRTUAL WORKBENCH ---

        simulationService._logTransaction('event', credits, 'Passenger payment');
        return { key: 'reward_credits', amount: formatCredits(credits) };
    }
}
--- END OF FILE: ./js/services/event-effects/effectAdriftPassenger.js ---

--- START OF FILE: ./js/services/event-effects/effectSpaceRace.js ---
// js/services/event-effects/effectSpaceRace.js
/**
 * @fileoverview Contains the logic for resolving the "Space Race" random event outcome.
 * This effect calculates a wager, determines a win/loss result based on ship class,
 * and modifies the outcome description to reflect the result.
 */
import { formatCredits } from '../../utils.js';

/**
 * Resolves the "Space Race" event by calculating a wager and determining the winner.
 * The win chance is dependent on the player's active ship class.
 *
 * @param {import('../../services/GameState.js').GameState} gameState - The mutable game state object.
 * @param {import('../../services/SimulationService.js').SimulationService} simulationService - The simulation service instance.
 * @param {object} effectData - The raw effect data, containing `wagerPercentage` and `winChance` map.
 * @param {object} outcome - The chosen outcome object from the database. Its `description` property will be overwritten by this function.
 */
export function resolveSpaceRace(gameState, simulationService, effectData, outcome) {
    const ship = simulationService._getActiveShip();
    const wager = Math.floor(gameState.player.credits * effectData.wagerPercentage);
    const winChance = effectData.winChance[ship.class] || 0.40; // Default chance if class not found.

    if (Math.random() < winChance) {
        // Player wins the race.
        // --- VIRTUAL WORKBENCH: APPLY CREDIT CAP ---
        gameState.player.credits = Math.min(Number.MAX_SAFE_INTEGER, gameState.player.credits + wager);
        // --- END VIRTUAL WORKBENCH ---
        simulationService._logTransaction('event', wager, 'Won space race wager');
        outcome.description = `Your Class ${ship.class} ship wins! You gain <span class="hl-green">${formatCredits(wager)}</span>.`;
    } else {
        // Player loses the race.
        gameState.player.credits -= wager;
        simulationService._logTransaction('event', -wager, 'Lost space race wager');
        outcome.description = `The luxury ship was too fast. You lose <span class="hl-red">${formatCredits(wager)}</span>.`;
    }
}
--- END OF FILE: ./js/services/event-effects/effectSpaceRace.js ---

--- START OF FILE: ./js/services/EventManager.js ---
// js/services/EventManager.js
/**
 * @fileoverview This file contains the EventManager class, which is responsible for handling all user input
 * for the application. It binds event listeners and delegates the logic to specialized handler modules,
 * acting as the primary bridge between the UI and the game's logic.
 */
import { NAV_IDS, SCREEN_IDS, ACTION_IDS } from '../data/constants.js';

// Import all specialized event handlers
import { ActionClickHandler } from './handlers/ActionClickHandler.js';
import { MarketEventHandler } from './handlers/MarketEventHandler.js';
import { HoldEventHandler } from './handlers/HoldEventHandler.js';
import { CarouselEventHandler } from './handlers/CarouselEventHandler.js';
import { TooltipHandler } from './handlers/TooltipHandler.js';

/**
 * @class EventManager
 * @description Listens for and processes all user inputs, delegating actions to the appropriate services.
 */
export class EventManager {
    /**
     * @param {import('./GameState.js').GameState} gameState The central game state object.
     * @param {import('./SimulationService.js').SimulationService} simulationService The core game logic engine.
     * @param {import('./UIManager.js').UIManager} uiManager The UI rendering service.
     * @param {import('./TutorialService.js').TutorialService} tutorialService The tutorial management service.
     * @param {import('./DebugService.js').DebugService} [debugService=null] The debugging service.
     * @param {import('./LoggingService.js').Logger} logger The logging utility.
     */
    constructor(gameState, simulationService, uiManager, tutorialService, debugService = null, logger) {
        this.gameState = gameState;
        this.simulationService = simulationService;
        this.uiManager = uiManager;
        this.tutorialService = tutorialService;
        this.debugService = debugService;
        this.logger = logger;

        // Instantiate all specialized handlers
        this.actionClickHandler = new ActionClickHandler(gameState, simulationService, uiManager, tutorialService);
        this.marketEventHandler = new MarketEventHandler(gameState, simulationService, uiManager);
        // MODIFIED: Pass the correct service (playerActionService) to the constructor
        this.holdEventHandler = new HoldEventHandler(this.simulationService.playerActionService, uiManager);
        this.carouselEventHandler = new CarouselEventHandler(gameState, simulationService);
        this.tooltipHandler = new TooltipHandler(gameState, uiManager);

        // --- VIRTUAL WORKBENCH ---
        // Define the set of actions that should be exclusively handled by the MarketEventHandler.
        this.marketActions = new Set([
            'toggle-trade-mode',
            'confirm-trade',
            'set-max-trade',
            ACTION_IDS.INCREMENT,
            ACTION_IDS.DECREMENT
        ]);
        // --- END VIRTUAL WORKBENCH ---
    }

    /**
     * Binds all necessary global event listeners to the document body.
     */
    bindEvents() {
        document.body.addEventListener('click', (e) => this._handleClick(e));
        document.body.addEventListener('dblclick', (e) => e.preventDefault());
        document.body.addEventListener('mouseover', (e) => this.tooltipHandler.handleMouseOver(e));
        document.body.addEventListener('mouseout', (e) => this.tooltipHandler.handleMouseOut(e));
        document.addEventListener('keydown', (e) => this._handleKeyDown(e));
        document.body.addEventListener('input', (e) => this.marketEventHandler.handleInput(e));

        document.body.addEventListener('contextmenu', (e) => e.preventDefault());

        document.body.addEventListener('wheel', (e) => {
            if (e.target.closest('.carousel-container')) {
                e.preventDefault();
                this.carouselEventHandler.handleWheel(e);
            }
        }, { passive: false });

        // --- VIRTUAL WORKBENCH MODIFICATION ---
        // Renamed 'startDragOrHold' to 'startCarouselDrag' for clarity.
        // Added a guard clause to prevent starting a carousel drag
        // when a stepper button is pressed. This allows the HoldEventHandler
        // to manage stepper holds without conflict.
        const startCarouselDrag = (e) => {
            // IGNORE presses on stepper buttons
            if (e.target.closest('.qty-stepper button')) {
                return;
            }
            // Proceed with carousel drag start for all other elements
            this.carouselEventHandler.handleDragStart(e);
        };
        // --- END MODIFICATION ---

        document.body.addEventListener('mousedown', startCarouselDrag);

        // --- VIRTUAL WORKBENCH MODIFICATION 10-24-2025 ---
        // The if condition was modified to add an exception for '.action-button'.
        // This prevents e.preventDefault() from being called on a tap/touch of
        // an action button, which was blocking the subsequent 'click' event
        // from firing on touch devices (like the iOS Simulator).
        document.body.addEventListener('touchstart', (e) => {
            // Prevent default touch actions ONLY for specific hold targets to allow scrolling elsewhere
            // (Note: Steppers are intentionally omitted here to allow 'pointerdown' to fire)
            if (e.target.closest('#refuel-btn') || e.target.closest('#repair-btn') || (e.target.closest('.carousel-container') && !e.target.closest('.action-button'))) {
                 e.preventDefault();
            }
            startCarouselDrag(e); // Call the modified start function
        }, { passive: false });
        // --- END MODIFICATION ---

        // MODIFIED: Removed call to non-existent holdEventHandler.handleHoldEnd
        const endDragOrHold = () => {
            this.carouselEventHandler.handleDragEnd();
        };
        document.body.addEventListener('mouseup', endDragOrHold);
        document.body.addEventListener('mouseleave', endDragOrHold);
        document.body.addEventListener('touchend', endDragOrHold);
        document.body.addEventListener('touchcancel', endDragOrHold);

        document.body.addEventListener('mousemove', (e) => this.carouselEventHandler.handleDragMove(e));
        document.body.addEventListener('touchmove', (e) => {
            // Prevent default touchmove ONLY if dragging the carousel
             if (this.carouselEventHandler.state.isDragging) {
                 e.preventDefault();
             }
            this.carouselEventHandler.handleDragMove(e);
        }, { passive: false });


        window.addEventListener('resize', () => this.uiManager.render(this.gameState.getState()));

        if (this.uiManager.cache.missionStickyBar) {
            this.uiManager.cache.missionStickyBar.addEventListener('click', () => {
                this.simulationService.setScreen(NAV_IDS.DATA, SCREEN_IDS.MISSIONS);
            });
        }
        
        // --- VIRTUAL WORKBENCH: BUG FIX ---
        // Bind the hold event handlers globally, once, at startup.
        this.holdEventHandler.bindHoldEvents();
        // --- END VIRTUAL WORKBENCH ---
    }

    /**
     * Central click handler for the entire application, using event delegation.
     * @param {Event} e The click event object.
     * @private
     */
    async _handleClick(e) { // <-- Add async
        // Suppress click events that are the result of a drag/swipe on the carousel OR a completed hold on a stepper
        if (this.carouselEventHandler.wasMoved() || this.holdEventHandler.isStepperHolding) {
             // Reset stepper hold flag after suppressing click
            if (this.holdEventHandler.isStepperHolding) {
                 this.holdEventHandler.isStepperHolding = false;
             }
            e.preventDefault();
            return;
        }


        const state = this.gameState.getState();
        const actionTarget = e.target.closest('[data-action]');

        // Always delegate to the tooltip handler for managing popups and cleanup
        this.tooltipHandler.handleClick(e);

        if (actionTarget) {
            const action = actionTarget.dataset.action;

            if (action === ACTION_IDS.DEBUG_SIMPLE_START) {
                if (this.debugService) {
                    this.debugService.simpleStart();
                }
                return;
            }

            // --- New Lore Modal Action ---
            if (action === 'show_lore') {
                e.preventDefault();
                const loreId = actionTarget.dataset.loreId;
                if (loreId) {
                    this.uiManager.showLoreModal(loreId);
                }
                return;
            }

            // --- VIRTUAL WORKBENCH MODIFICATION ---
            // Route the event to the correct handler instead of broadcasting to all.
            // This prevents action misfires, like 'acquire-license' (from ActionClickHandler)
            // firing on a 'confirm-trade' (from MarketEventHandler) click.
            if (this.marketActions.has(action)) {
                this.marketEventHandler.handleClick(e, actionTarget);
            } else {
                await this.actionClickHandler.handle(e, actionTarget); // <-- ADD await
            }
            return;
            // --- END VIRTUAL WORKBENCH MODIFICATION ---
        }

        // --- Fallback Handlers for non-action clicks ---
        if (state.introSequenceActive && !state.tutorials.activeBatchId) {
            this.simulationService.handleIntroClick(e);
            return;
        }
        if (state.isGameOver) return;

        // Check for modal dismissal clicks
        const modalIdToClose = this.uiManager.getModalIdFromEvent(e);
        if (modalIdToClose) {
            // Note: lore-modal dismissal is handled internally in UIManager.showLoreModal
            // to allow for content-area clicks.
            if (modalIdToClose !== 'lore-modal') {
                // *** VIRTUAL WORKBENCH CORRECTION ***
                this.uiManager.hideModal(modalIdToClose); // Changed modalIdTo-close to modalIdToClose
                // *** END CORRECTION ***
            }
        }
    }

    /**
     * Handles keydown events, primarily for debug shortcuts.
     * @param {Event} e The keydown event object.
     * @private
     */
    _handleKeyDown(e) {
        if (this.gameState.isGameOver || e.ctrlKey || e.metaKey) return;
        if ((e.key === '`' || e.key === '&') && this.debugService) {
            this.debugService.toggleVisibility();
        }
    }
}
--- END OF FILE: ./js/services/EventManager.js ---

--- START OF FILE: ./js/services/TutorialService.js ---
// ./js/services/TutorialService.js
/**
 * @fileoverview This file contains the TutorialService class, which manages the state
 * and flow of all interactive tutorials in the game. It checks for trigger conditions,
 * displays tutorial steps, and locks UI navigation to guide the player.
 */
import { DB } from '../data/database.js';
import { TUTORIAL_ACTION_TYPES, ACTION_IDS, NAV_IDS } from '../data/constants.js';

/**
 * @class TutorialService
 * @description Manages the state and flow of interactive tutorials.
 */
export class TutorialService {
    /**
     * @param {import('./GameState.js').GameState} gameState The game's central state object.
     * @param {import('./UIManager.js').UIManager} uiManager The UI manager for rendering updates.
     * @param {import('./SimulationService.js').SimulationService} simulationService The core game logic simulator.
     * @param {object} navStructure The navigation structure from UIManager, used to map screens to nav tabs.
     * @param {import('./LoggingService.js').Logger} logger The logging utility.
     */
    constructor(gameState, uiManager, simulationService, navStructure, logger) {
        this.gameState = gameState;
        this.uiManager = uiManager;
        this.simulationService = simulationService;
        this.logger = logger;
        this.activeBatchId = null;
        this.activeStepId = null;

        // Create a map of screenId -> navId for easy lookup when tutorials need to force navigation.
        this.screenToNavMap = {};
        for (const navId in navStructure) {
            for (const screenId in navStructure[navId].screens) {
                this.screenToNavMap[screenId] = navId;
            }
        }
    }

    /**
     * Checks the current game action or state against tutorial triggers and step completion conditions.
     * This is the main entry point for the tutorial system, called after player actions or screen loads.
     * @param {object} [actionData=null] Data about the action that just occurred (e.g., { type: 'ACTION', action: 'buy-ship' }).
     */
    checkState(actionData = null) {
        // If a tutorial is currently active, check if the action completes the current step.
        if (this.activeBatchId && this.activeStepId) {
            const batch = DB.TUTORIAL_DATA[this.activeBatchId];
            const step = batch.steps.find(s => s.stepId === this.activeStepId);

            if (step && this._matchesCondition(step.completion, actionData)) {
                this.advanceStep();
            }
            return;
        }

        // If no tutorial is active, check if the action triggers a new tutorial batch.
        for (const batchId in DB.TUTORIAL_DATA) {
            const batch = DB.TUTORIAL_DATA[batchId];
            const hasBeenSeen = this.gameState.tutorials.seenBatchIds.includes(batchId);
            const isSkipped = this.gameState.tutorials.skippedTutorialBatches.includes(batchId);
            
            if (!hasBeenSeen && !isSkipped) {
                const triggerAction = actionData || { type: TUTORIAL_ACTION_TYPES.SCREEN_LOAD, screenId: this.gameState.activeScreen };
                if (this._matchesCondition(batch.trigger, triggerAction)) {
                    this.triggerBatch(batchId);
                    break;
                }
            }
        }
    }

    /**
     * Starts a specific tutorial batch by its ID.
     * @param {string} batchId The unique identifier of the tutorial batch to start.
     * @param {string|null} [startStepId=null] The ID of a specific step to start from. If null, starts from the beginning.
     */
    triggerBatch(batchId, startStepId = null) {
        if (!DB.TUTORIAL_DATA[batchId]) return;
        const batch = DB.TUTORIAL_DATA[batchId];

        // If the tutorial is triggered by loading a specific screen, navigate to that screen first.
        if (batch.trigger.type === TUTORIAL_ACTION_TYPES.SCREEN_LOAD) {
            const targetScreenId = batch.trigger.screenId;
            if (this.gameState.activeScreen !== targetScreenId) {
                const targetNavId = this.screenToNavMap[targetScreenId];
                if (targetNavId) {
                    this.simulationService.setScreen(targetNavId, targetScreenId);
                }
            }
        }

        this.activeBatchId = batchId;
        this.gameState.tutorials.activeBatchId = batchId;
        
        if (!this.gameState.tutorials.seenBatchIds.includes(batchId)) {
            this.gameState.tutorials.seenBatchIds.push(batchId);
        }

        this.logger.info.system('Tutorial', this.gameState.day, 'TUTORIAL_START', `Starting tutorial batch: ${batchId}`);
        this.gameState.setState(this.gameState);
        this.uiManager.render(this.gameState.getState());
        
        const firstStepId = startStepId || batch.steps[0].stepId;
        this._displayStep(firstStepId);
    }

    /**
     * Skips the currently active tutorial batch, preventing it from triggering again.
     */
    skipActiveTutorial() {
        if (!this.activeBatchId) return;
        if (!this.gameState.tutorials.skippedTutorialBatches.includes(this.activeBatchId)) {
            this.gameState.tutorials.skippedTutorialBatches.push(this.activeBatchId);
        }
        this.logger.info.player(this.gameState.day, 'TUTORIAL_SKIP', `Skipped tutorial: ${this.activeBatchId}`);
        this._endBatch();
        this.gameState.setState(this.gameState);
    }
    
    /**
     * Advances the tutorial to the next step in the current batch, or ends the batch if it's the final step.
     */
    advanceStep() {
        if (!this.activeStepId || !this.activeBatchId) return;

        const batch = DB.TUTORIAL_DATA[this.activeBatchId];
        const currentStep = batch.steps.find(s => s.stepId === this.activeStepId);
        
        this.uiManager.hideTutorialToast();

        if (currentStep && currentStep.nextStepId) {
            this._displayStep(currentStep.nextStepId);
        } else {
            const completedBatchId = this.activeBatchId;
            this._endBatch(); 
            // If the completed tutorial was part of the intro sequence, continue the sequence.
            if (this.gameState.introSequenceActive && completedBatchId?.startsWith('intro_')) {
                this.simulationService._continueIntroSequence(completedBatchId);
            }
        }
    }

    /**
     * Displays a specific tutorial step by its ID and manages UI navigation locks.
     * @param {string} stepId The ID of the step to display.
     * @private
     */
    _displayStep(stepId) {
        if (!this.activeBatchId) return;
        const batch = DB.TUTORIAL_DATA[this.activeBatchId];
        const step = batch.steps.find(s => s.stepId === stepId);
        if (!step) {
            this._endBatch();
            return;
        }

        // Apply navigation lock based on tutorial data.
        if (step.hasOwnProperty('navLock')) {
            // A step can explicitly define its own lock (or null to unlock).
            this.gameState.tutorials.navLock = step.navLock;
        } else if (batch.navLock) {
            // Otherwise, inherit the lock from the parent batch.
            const currentScreenId = this.gameState.activeScreen;
            const currentNavId = this.screenToNavMap[currentScreenId];
            this.gameState.tutorials.navLock = { navId: currentNavId, screenId: currentScreenId };
        } else {
            // Ensure navigation is unlocked if no lock is specified.
            this.gameState.tutorials.navLock = null;
        }

        this.activeStepId = stepId;
        this.gameState.tutorials.activeStepId = stepId;
        this.logger.info.system('Tutorial', this.gameState.day, 'STEP_DISPLAY', `Displaying step: ${stepId}`);
        
        this.uiManager.showTutorialToast({
            step: step,
            onSkip: () => this.uiManager.showSkipTutorialModal(() => this.skipActiveTutorial()),
            onNext: () => this.advanceStep(),
            gameState: this.gameState.getState()
        });
        
        // Re-render to apply navLock changes and any other state updates from advancing the step.
        this.uiManager.render(this.gameState.getState());
    }

    /**
     * Cleans up the state when a tutorial batch ends.
     * @private
     */
    _endBatch() {
        this.logger.info.system('Tutorial', this.gameState.day, 'TUTORIAL_END', `Ending tutorial batch: ${this.activeBatchId}`);
        this.uiManager.hideTutorialToast();
        this.activeBatchId = null;
        this.activeStepId = null;
        this.gameState.tutorials.activeBatchId = null;
        this.gameState.tutorials.activeStepId = null;
        this.gameState.tutorials.navLock = null; // Clear any active navigation lock.
    }

    /**
     * Checks if a player action matches a tutorial step's completion or trigger condition.
     * @param {object|object[]} condition The condition object or array of conditions from the database.
     * @param {object} actionData The action performed by the player.
     * @returns {boolean} True if the condition(s) are met.
     * @private
     */
    _matchesCondition(condition, actionData) {
        if (!condition || !actionData) return false;
        // A condition can be an array of multiple sub-conditions that must all be true.
        if (Array.isArray(condition)) {
            return condition.every(c => this._matchesSingleCondition(c, actionData));
        }
        return this._matchesSingleCondition(condition, actionData);
    }
    
    /**
     * Helper for _matchesCondition to check a single condition object against a player action.
     * @param {object} condition The single condition object.
     * @param {object} actionData The action performed by the player.
     * @returns {boolean} True if the single condition is met.
     * @private
     */
    _matchesSingleCondition(condition, actionData) {
        if (condition.type !== actionData.type) return false;
        switch (condition.type) {
            case TUTORIAL_ACTION_TYPES.SCREEN_LOAD:
                return condition.screenId === actionData.screenId;
            case TUTORIAL_ACTION_TYPES.ACTION:
                if (condition.action === ACTION_IDS.SET_SCREEN && actionData.action === ACTION_IDS.SET_SCREEN) {
                    return condition.navId === actionData.navId && condition.screenId === actionData.screenId;
                }
                return condition.action === actionData.action;
            case TUTORIAL_ACTION_TYPES.INFO:
                return true; // Info steps are always completed by the "Next" button, not a game action.
            default:
                return false;
        }
    }
}
--- END OF FILE: ./js/services/TutorialService.js ---

--- START OF FILE: ./js/services/LoggingService.js ---
// js/services/LoggingService.js
/**
 * @fileoverview This file contains the LoggingService, a centralized utility for handling all console output.
 * It supports verbosity levels, color-coded categories, collapsible groups, performance timing,
 * and maintains a buffer of recent logs for generating bug reports. This service is designed to
 * make debugging more efficient and to standardize all logging throughout the application.
 */

// 1. --- CONFIGURATION ---
const LOG_LEVELS = {
    DEBUG: 4, // Most verbose: for fine-grained state changes, variable dumps.
    INFO: 3,  // Default: for key player actions, major system events.
    WARN: 2,   // For potential issues that don't break the game.
    ERROR: 1,  // For critical, game-breaking errors.
    NONE: 0    // Disables all console output.
};

const COLORS = {
    player: '#60a5fa',      // Blue for player actions
    system: '#4ade80',      // Green for automated system processes
    state: '#facc15',       // Yellow for significant game state changes
    warn: '#f59e0b',        // Orange for warnings
    error: '#f87171',       // Red for errors
    group: '#d4d4d8'        // Light gray for group titles
};

const MAX_LOG_HISTORY = 100; // Number of log entries to keep for bug reports.

// 2. --- STATE ---
let currentLogLevel = LOG_LEVELS.INFO; // Default logging level.
const logHistory = []; // In-memory buffer of recent log messages.

// 3. --- CORE LOGIC ---

/**
 * Adds a formatted message to the log history buffer.
 * @param {string} message The plain text message to store.
 * @private
 */
function addToHistory(message) {
    logHistory.push(message);
    if (logHistory.length > MAX_LOG_HISTORY) {
        logHistory.shift();
    }
}

/**
 * The core logging function.
 * @param {number} level The verbosity level of the message.
 * @param {string} service The service or system originating the log.
 * @param {number|string} day The current in-game day or a placeholder.
 * @param {string} action The action being logged.
 * @param {string} details The specific details of the log entry.
 * @param {string} color The CSS color for the log category.
 * @param {object|null} data Optional data object to inspect in the console.
 * @private
 */
function log(level, service, day, action, details, color, data = null) {
    if (level > currentLogLevel) return;

    const formattedMessage = `[${service}] [Day ${day}] ${action}: ${details}`;
    addToHistory(formattedMessage);

    console.log(
        `%c[${service}] %c[Day ${day}] %c${action}: %c${details}`,
        `color: ${color}; font-weight: bold;`,
        'color: #9ca3af;',
        'color: #e5e7eb; font-weight: bold;',
        'color: inherit;',
        data || ''
    );
     if (data) {
        console.dir(data);
    }
}

// 4. --- PUBLIC API ---

/**
 * The exported Logger object provides a clean, namespaced API for all logging.
 */
export const Logger = {
    /**
     * Sets the global verbosity level for the logger.
     * @param {string} levelName - The name of the level (e.g., "DEBUG", "INFO").
     */
    setLevel: (levelName) => {
        const level = LOG_LEVELS[levelName.toUpperCase()];
        if (typeof level !== 'undefined') {
            currentLogLevel = level;
            console.log(`%c[Logger] Log level set to: ${levelName}`, `color: ${COLORS.state}; font-weight: bold;`);
        } else {
            Logger.warn('LoggingService', `Attempted to set invalid log level: ${levelName}`);
        }
    },

    /**
     * Retrieves the stored log history for bug reporting.
     * @returns {string} A formatted string of all log entries.
     */
    getLogHistory: () => logHistory.join('\n'),

    // --- Informational Logs ---
    info: {
        player: (day, action, details, data = null) => log(LOG_LEVELS.INFO, 'Player', day, action, details, COLORS.player, data),
        system: (service, day, action, details, data = null) => log(LOG_LEVELS.INFO, service, day, action, details, COLORS.system, data),
        state: (day, action, details, data = null) => log(LOG_LEVELS.INFO, 'Game', day, action, details, COLORS.state, data)
    },

    // --- Warning and Error Logs ---
    warn: (service, details) => {
        if (LOG_LEVELS.WARN > currentLogLevel) return;
        const formattedMessage = `[${service}] WARN: ${details}`;
        addToHistory(formattedMessage);
        console.warn(`%c[${service}] WARN:`, `color: ${COLORS.warn}; font-weight: bold;`, details);
    },
    error: (service, details, error = null) => {
        if (LOG_LEVELS.ERROR > currentLogLevel) return;
        const formattedMessage = `[${service}] ERROR: ${details}`;
        addToHistory(formattedMessage);
        console.error(`%c[${service}] ERROR:`, `color: ${COLORS.error}; font-weight: bold;`, details, error || '');
    },

    // --- Utility Logs ---
    group: (label) => {
        if (LOG_LEVELS.DEBUG > currentLogLevel) return;
        addToHistory(`--- GROUP START: ${label} ---`);
        console.groupCollapsed(`%c${label}`, `color: ${COLORS.group}; font-style: italic;`);
    },
    groupEnd: () => {
        if (LOG_LEVELS.DEBUG > currentLogLevel) return;
        console.groupEnd();
        addToHistory(`--- GROUP END ---`);
    },
    time: (label) => {
        if (LOG_LEVELS.DEBUG > currentLogLevel) return;
        console.time(label);
    },
    timeEnd: (label) => {
        if (LOG_LEVELS.DEBUG > currentLogLevel) return;
        console.timeEnd(label);
    }
};
--- END OF FILE: ./js/services/LoggingService.js ---

--- START OF FILE: ./js/services/eventEffectResolver.js ---
// js/services/eventEffectResolver.js
/**
 * @fileoverview This file acts as a resolver for all random event outcomes. It maps effect types
 * to their corresponding handler functions, providing a centralized and extensible way to
 * apply the consequences of player choices during events.
 */
import { resolveSpaceRace } from './event-effects/effectSpaceRace.js';
import { resolveAdriftPassenger } from './event-effects/effectAdriftPassenger.js';
import { calculateInventoryUsed } from '../utils.js';
import { DB } from '../data/database.js';
import { COMMODITY_IDS } from '../data/constants.js';

/**
 * A map of effect type strings to their corresponding handler functions.
 * Each handler function receives the game state, simulation service, the specific effect object,
 * and the parent outcome object. This allows for complex, conditional logic.
 * @type {Object.<string, function(import('./GameState.js').GameState, import('./SimulationService.js').SimulationService, object, object): (object|void)>}
 */
const effectHandlers = {
    // --- Custom, Complex Event Handlers ---
    'SPACE_RACE': resolveSpaceRace,
    'ADRIFT_PASSENGER': resolveAdriftPassenger,

    // --- Standard, Reusable Effect Handlers ---
    'credits': (gameState, simulationService, effect) => {
        // --- VIRTUAL WORKBENCH: APPLY CREDIT CAP ---
        gameState.player.credits = Math.min(Number.MAX_SAFE_INTEGER, gameState.player.credits + effect.value);
        // --- END VIRTUAL WORKBENCH ---
        simulationService._logTransaction('event', effect.value, 'Received credits from event');
    },
    'fuel': (gameState, simulationService, effect) => {
        const ship = simulationService._getActiveShip();
        const shipState = gameState.player.shipStates[ship.id];
        shipState.fuel = Math.max(0, shipState.fuel + effect.value);
    },
    'hull_damage_percent': (gameState, simulationService, effect) => {
        // Damage can be a fixed value or a random value within a range [min, max].
        let dmg = Array.isArray(effect.value) ?
            Math.random() * (effect.value[1] - effect.value[0]) + effect.value[0] : effect.value;
        gameState.pendingTravel.eventHullDamagePercent = (gameState.pendingTravel.eventHullDamagePercent || 0) + dmg;
    },
    'travel_time_add': (gameState, simulationService, effect) => {
        gameState.pendingTravel.travelTimeAdd = (gameState.pendingTravel.travelTimeAdd || 0) + effect.value;
    },
    'travel_time_add_percent': (gameState, simulationService, effect) => {
        gameState.pendingTravel.travelTimeAddPercent = (gameState.pendingTravel.travelTimeAddPercent || 0) + effect.value;
    },
    'set_travel_time': (gameState, simulationService, effect) => {
        gameState.pendingTravel.setTravelTime = effect.value;
    },
    'add_debt': (gameState, simulationService, effect) => {
        if (gameState.player.debt <= 0) {
            gameState.player.loanStartDate = gameState.day;
            gameState.player.weeklyInterestAmount = 0;
        }
        const newInterest = Math.ceil(effect.value * 0.013);
        gameState.player.weeklyInterestAmount += newInterest;
        gameState.player.debt += effect.value;
        simulationService._logTransaction('loan', effect.value, 'Incurred debt from event');
    },
    'add_cargo': (gameState, simulationService, effect, outcome) => {
        const ship = simulationService._getActiveShip();
        const inventory = simulationService._getActiveInventory();
        const commodity = DB.COMMODITIES.find(c => c.id === effect.value.id);
        // This effect is conditional: cargo is only added if there is sufficient space.
        if (calculateInventoryUsed(inventory) + effect.value.quantity <= ship.cargoCapacity) {
            inventory[effect.value.id].quantity += effect.value.quantity;
        } else {
            // If there's no space, modify the outcome description to inform the player.
            outcome.description = `You try to tractor the pod, but there's no room in your cargo hold! You're forced to leave the <span class="hl">${commodity.name}</span> behind.`;
        }
    },
    'lose_cargo': (gameState, simulationService, effect) => {
        const inventory = simulationService._getActiveInventory();
        inventory[effect.value.id].quantity = Math.max(0, inventory[effect.value.id].quantity - effect.value.quantity);
    },
    'lose_random_cargo_percent': (gameState, simulationService, effect) => {
        const inventory = simulationService._getActiveInventory();
        const heldCommodities = Object.entries(inventory).filter(([, item]) => item.quantity > 0);
        if (heldCommodities.length > 0) {
            const [id, item] = heldCommodities[Math.floor(Math.random() * heldCommodities.length)];
            const quantityToLose = Math.ceil(item.quantity * effect.value);
            item.quantity = Math.max(0, item.quantity - quantityToLose);
        }
    },
    'sell_random_cargo_premium': (gameState, simulationService, effect) => {
        const inventory = simulationService._getActiveInventory();
        const heldCommodities = Object.entries(inventory).filter(([, item]) => item.quantity > 0);
        if (heldCommodities.length > 0) {
            const [id, item] = heldCommodities[Math.floor(Math.random() * heldCommodities.length)];
            const saleValue = gameState.market.galacticAverages[id] * effect.value * item.quantity;
            
            // --- VIRTUAL WORKBENCH: APPLY CREDIT CAP ---
            gameState.player.credits = Math.min(Number.MAX_SAFE_INTEGER, gameState.player.credits + saleValue);
            // --- END VIRTUAL WORKBENCH ---

            simulationService._logTransaction('trade', saleValue, 'Emergency supply drop sale');
            item.quantity = 0;
        }
    },
    'set_new_random_destination': (gameState, simulationService, effect) => {
         const otherMarkets = DB.MARKETS.filter(m => m.id !== gameState.currentLocationId && gameState.player.unlockedLocationIds.includes(m.id));
        if(otherMarkets.length > 0) {
            gameState.pendingTravel.destinationId = otherMarkets[Math.floor(Math.random() * otherMarkets.length)].id;
        }
    }
};

/**
 * Acts as a router, calling the appropriate handler function for a given event effect type.
 * @param {import('./GameState.js').GameState} gameState - The mutable game state object.
 * @param {import('./SimulationService.js').SimulationService} simulationService - The simulation service instance.
 * @param {object} effect - The effect object from the event definition in the database.
 * @param {object} outcome - The parent outcome object, which can be modified by the handler (e.g., to change descriptions).
 * @returns {object|void} An optional object from the handler, typically for dynamic description data.
 */
export function applyEffect(gameState, simulationService, effect, outcome) {
    const handler = effectHandlers[effect.type];
    if (handler) {
        return handler(gameState, simulationService, effect, outcome);
    } else {
        console.warn(`No handler found for event effect type: ${effect.type}`);
    }
}
--- END OF FILE: ./js/services/eventEffectResolver.js ---

--- START OF FILE: ./js/services/UIManager.js ---
// js/services/UIManager.js
import { DB } from '../data/database.js';
import { formatCredits, calculateInventoryUsed, getDateFromDay, renderIndicatorPills, getCommodityStyle } from '../utils.js';
import { SCREEN_IDS, NAV_IDS, ACTION_IDS, GAME_RULES, PERK_IDS, LOCATION_IDS, SHIP_IDS, COMMODITY_IDS } from '../data/constants.js';
import { EffectsManager } from '../effects/EffectsManager.js';

// Import all screen rendering components
import { renderHangarScreen } from '../ui/components/HangarScreen.js';
import { renderMarketScreen } from '../ui/components/MarketScreen.js';
import { renderMapScreen, initMap } from '../ui/components/MapScreen.js';
import { renderNavigationScreen } from '../ui/components/NavigationScreen.js';
import { renderServicesScreen } from '../ui/components/ServicesScreen.js';
import { renderCargoScreen, _renderMaxCargoModal } from '../ui/components/CargoScreen.js';
import { renderMissionsScreen } from '../ui/components/MissionsScreen.js';
import { renderFinanceScreen } from '../ui/components/FinanceScreen.js';
import { renderIntelScreen } from '../ui/components/IntelScreen.js';
import { TravelAnimationService } from './ui/TravelAnimationService.js';

// --- VIRTUAL WORKBENCH: IMPORTS ---
import { IntelMarketRenderer } from '../ui/renderers/IntelMarketRenderer.js';
import { INTEL_CONTENT } from '../data/intelContent.js';
import { playBlockingAnimation } from './ui/AnimationService.js';
// --- END VIRTUAL WORKBENCH ---

/**
 * Stores the lore text content.
 * @private
 */
const LORE_CONTENT = {
    story_so_far: `
        <p>The year 2140 is the result of a single, massive corporate takeover. A century ago, the "Ad Astra Initiative" released advanced technology to all of humanity, a gift from the new Human-AI Alliance on Earth designed to kickstart our expansion into the stars. It was a promise of a new beginning, an open-source key to the solar system, ensuring the survival of all Earth life, both organic and synthetic.</p>
    
        <p>But a gift to everyone is a business opportunity for the few. The hyper-corporations, already positioned in space, immediately patented the most efficient manufacturing processes and proprietary components for this new technology. This maneuver ensured that while anyone could build a Folded-Space Drive, only the corporations could supply the high-performance parts needed to make it truly effective, creating a system-wide technological dependency that persists to this day. This technological monopoly created the "Drive-Divide," the central pillar of the new class system. Nearly all ships run on older, less efficient hardware. Very few ships employ these coveted Folded-Space Drives.</p>
        <p>The major hubs beyond Earth are sovereign, corporate-run territories where law is policy and your rights are listed in an employment contract. These scattered colonies are fierce rivals, engaged in constant economic warfare, all propped up by the interstellar supply lines maintained by the Merchant's Guild. For them, you are just another cog in the great machine of commerce.</p>
        <p>In a system owned by corporations, possessing your own ship is the only true form of freedom. Every credit earned, every successful trade, is a bet on your own skill and a step toward true sovereignty on the razor's edge of a cargo manifest.</p>
    `
};

// [[START]] VIRTUAL WORKBENCH (EULA Content)
/**
 * Stores the EULA text content.
 * @private
 */
const EULA_CONTENT = `
    <h3 class="text-2xl font-orbitron mb-4 text-center">End-User License Agreement (EULA) for Orbital Trading</h3>
    <p class="text-sm text-center text-gray-400 mb-4">Last Updated: November 6, 2025</p>
    <p>This End-User License Agreement ("EULA" or "Agreement") is a binding legal contract between you (either an individual or a single entity, hereafter "You," "Your," or "Licensee") and Devon P. Casey (hereafter "Licensor," "Developer," "We," "Us," or "Our") for the software application known as Orbital Trading, including any and all associated media, printed materials, and "online" or electronic documentation (collectively, the "Software").</p>
    <p>BY INSTALLING, COPYING, DOWNLOADING, OR OTHERWISE USING THE SOFTWARE, YOU AGREE TO BE BOUND BY THE TERMS OF THIS EULA.</p>
    <p>IF YOU DO NOT AGREE TO THE TERMS OF THIS EULA, DO NOT INSTALL OR USE THE SOFTWARE. YOU MUST PROMPTLY DELETE ALL COPIES OF THE SOFTWARE IN YOUR POSSESSION.</p>
    <p>IF YOU ARE A MINOR (BELOW THE AGE OF LEGAL MAJORITY IN YOUR JURISDICTION), YOUR PARENT OR LEGAL GUARDIAN MUST READ AND AGREE TO THIS EULA ON YOUR BEHALF.</p>
    <h4 class="text-xl font-orbitron mt-4 mb-2">1. GRANT OF LICENSE</h4>
    <p>Subject to your strict and ongoing compliance with all terms and conditions of this Agreement, Licensor grants You a limited, non-exclusive, non-transferable, non-sublicensable, revocable license to install and use one (1) copy of the Software solely for Your own personal, non-commercial entertainment use on a single device (e.g., computer or mobile device) that You own or control.</p>
    <p>This Software is licensed, not sold. This license confers no title or ownership in the Software and should not be construed as a sale of any rights in the Software.</p>
    <h4 class="text-xl font-orbitron mt-4 mb-2">2. LICENSE RESTRICTIONS</h4>
    <p>Your right to use the Software is limited to the grant above, and You may not, under any circumstances, do any of the following:</p>
    <ul class="list-disc list-outside ml-6 space-y-2">
        <li>a. Copy, modify, adapt, translate, or create derivative works based on the Software, in whole or in part;</li>
        <li>b. Sell, rent, lease, sublicense, distribute, publicly display, publicly perform, or otherwise transfer or commercially exploit the Software or any of its components;</li>
        <li>c. Reverse engineer, decompile, disassemble, or otherwise attempt to derive or discover the source code of the Software, except and only to the extent that such activity is expressly permitted by applicable law notwithstanding this limitation;</li>
        <li>d. Use the Software for any commercial purpose (including, but not limited to, use at a cyber cafe, in a commercial arcade, or for any paid service) without the prior written consent of Licensor;</li>
        <li>e. Remove, alter, or obscure any copyright, trademark, or other proprietary rights notices on or in the Software;</li>
        <li>f. Use any cheats, exploits, automation software (bots), hacks, mods, or any unauthorized third-party software designed to modify or interfere with the Software experience;</li>
        <li>g. Use the Software to violate any applicable law, rule, or regulation;</li>
        <li>h. Scrape, data mine, or otherwise extract any data from the Software or its underlying servers or databases;</li>
        <li>i. Interfere with or disrupt the Software or any server or network used to support or provide the Software, including any hacking or "denial of service" attacks.</li>
    </ul>
    <p>Any use of the Software in violation of these License Restrictions is a material breach of this Agreement and may result in the immediate termination of your license and subject You to civil and/or criminal liability.</p>
    <h4 class="text-xl font-orbitron mt-4 mb-2">3. OWNERSHIP AND INTELLECTUAL PROPERTY</h4>
    <p>You agree and acknowledge that all title, ownership rights, and intellectual property (IP) rights in and to the Software (including, but not limited to, all code, computer graphics, visual elements, audio, music, sound effects, themes, characters, character names, stories, dialogue, locations, and artwork) are and shall remain the exclusive property of Devon P. Casey.</p>
    <p>Copyright (c) 2025 Devon P. Casey. All Rights Reserved.</p>
    <p>All rights not expressly granted to You in this EULA are reserved by Licensor.</p>
    <p>This Agreement grants You no title, ownership, or other IP interest in the Software.</p>
    <h4 class="text-xl font-orbitron mt-4 mb-2">4. VIRTUAL GOODS AND IN-GAME CURRENCY</h4>
    <p>The Software may include virtual in-game currency, items, commodities, ships, or other virtual content ("Virtual Goods").</p>
    <ul class="list-disc list-outside ml-6 space-y-2">
        <li>a.  License, Not Ownership:  You acknowledge that Virtual Goods are licensed to You as part of the Software and are not sold. You have no ownership right or property interest in any Virtual Goods, regardless of whether they were "earned" through gameplay or "purchased" with real money.</li>
        <li>b.  No Real-World Value:  Virtual Goods have no monetary value, are not real currency, and cannot be redeemed, sold, transferred, or exchanged for real-world money or any item of monetary value.</li>
        <li>c.  Licensor's Rights:  Licensor has the absolute right to manage, regulate, control, modify, and/or eliminate Virtual Goods at any time, in its sole discretion, with or without notice. Licensor shall have no liability to You or any third party for the exercise of such rights.</li>
        <li>d. No Refunds:  All purchases of Virtual Goods are final and non-refundable, except as required by applicable law.</li>
    </ul>
    <h4 class="text-xl font-orbitron mt-4 mb-2">5. FEEDBACK AND SUGGESTIONS</h4>
    <p>If You provide Licensor with any ideas, suggestions, bug reports, or other feedback regarding the Software ("Feedback"), You hereby grant Licensor a perpetual, irrevocable, worldwide, non-exclusive, royalty-free, fully paid-up, transferable, and sublicensable license to use, reproduce, modify, distribute, and otherwise exploit such Feedback for any purpose whatsoever (including for commercial purposes) without any obligation to provide compensation, credit, or attribution to You.</p>
    <h4 class="text-xl font-orbitron mt-4 mb-2">6. CODE OF CONDUCT</h4>
    <p>While using the Software, You agree to comply with all applicable laws and to not:</p>
    <ul class="list-disc list-outside ml-6 space-y-2">
        <li>a. Harass, threaten, bully, defame, or otherwise abuse another user or Licensor's staff;</li>
        <li>b. Transmit or post any content that is hateful, abusive, racially or ethnically offensive, obscene, or illegal;</li>
        <li>c. Impersonate any person, including any employee or representative of Licensor;</li>
        <li>d. Disrupt the normal flow of gameplay or dialogue, or otherwise act in a manner that negatively affects other users' experience.</li>
    </ul>
    <h4 class="text-xl font-orbitron mt-4 mb-2">7. UPDATES AND MODIFICATIONS</h4>
    <p>Licensor may, from time to time, provide updates, patches, or other modifications to the Software. You agree that Licensor may deploy and install these modifications remotely. You may be required to install such updates to continue using the Software. Licensor reserves the right to modify, suspend, or discontinue the Software, or any feature or part thereof, at any time with or without notice to You. Licensor shall not be liable to You or any third party for any such modification, suspension, or discontinuance.</p>
    <h4 class="text-xl font-orbitron mt-4 mb-2">8. TERMINATION</h4>
    <p>This EULA is effective until terminated.</p>
    <ul class="list-disc list-outside ml-6 space-y-2">
        <li>a.  Termination by You:  You may terminate this EULA at any time by permanently deleting, destroying, and uninstalling all copies of the Software in Your possession or control.</li>
        <li>b.  Termination by Licensor:  Licensor may terminate this EULA immediately and without prior notice if You fail to comply with any term or condition of this Agreement.</li>
        <li>c.  Effect of Termination:  Upon termination for any reason, all licenses granted to You herein shall immediately cease. You must immediately and permanently delete all copies of the Software. All provisions of this EULA that by their nature should survive termination shall survive, including, without limitation, Sections 2, 3, 4, 5, 8(c), 9, 10, 11, 12, and 13. NO REFUNDS WILL BE GRANTED UPON TERMINATION.</li>
    </ul>
    <h4 class="text-xl font-orbitron mt-4 mb-2">9. DISCLAIMER OF WARRANTIES</h4>
    <p>TO THE MAXIMUM EXTENT PERMITTED BY APPLICABLE LAW, THE SOFTWARE IS PROVIDED "AS IS" AND "AS AVAILABLE," WITH ALL FAULTS AND WITHOUT WARRANTY OF ANY KIND. LICENSOR HEREBY DISCLAIMS ALL WARRANTIES AND CONDITIONS, WHETHER EXPRESS, IMPLIED, OR STATUTORY, INCLUDING, BUT NOT LIMITED TO, ANY IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT, AND NON-INFRINGEMENT OF THIRD-PARTY RIGHTS. LICENSOR DOES NOT WARRANT THAT THE SOFTWARE WILL MEET YOUR REQUIREMENTS, THAT ITS OPERATION WILL BE UNINTERRUPTED OR ERROR-FREE, THAT DEFECTS WILL BE CORRECTED, OR THAT THE SOFTWARE IS FREE OF VIRUSES OR OTHER HARMFUL COMPONENTS.</p>
    <h4 class="text-xl font-orbitron mt-4 mb-2">10. LIMITATION OF LIABILITY</h4>
    <p>TO THE MAXIMUM EXTENT PERMITTED BY APPLICABLE LAW, IN NO EVENT SHALL LICENSOR (DEVON P. CASEY) OR HIS AFFILIATES BE LIABLE FOR ANY SPECIAL, INCIDENTAL, INDIRECT, CONSEQUENTIAL, OR PUNITIVE DAMAGES WHATSOEVER (INCLUDING, BUT NOT LIMITED TO, DAMAGES FOR LOSS OF PROFITS, LOSS OF DATA, BUSINESS INTERRUPTION, PERSONAL INJURY, OR LOSS OF PRIVACY) ARISING OUT OF OR IN ANY WAY RELATED TO THE USE OF OR INABILITY TO USE THE SOFTWARE, EVEN IF LICENSOR HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.</p>
    <p>IN NO EVENT SHALL THE TOTAL LIABILITY OF LICENSOR TO YOU FOR ALL DAMAGES (EXCEPT AS MAY BE REQUIRED BY APPLICABLE LAW IN CASES OF PERSONAL INJURY) EXCEED THE AMOUNT ACTUALLY PAID BY YOU FOR THE SOFTWARE OR ONE UNITED STATES DOLLAR (USD $1.00), WHICHEVER IS GREATER.</p>
    <h4 class="text-xl font-orbitron mt-4 mb-2">11. INDEMNIFICATION</h4>
    <p>You agree to indemnify, defend, and hold harmless Licensor (Devon P. Casey) and his employees, agents, and affiliates from and against any and all claims, losses, damages, liabilities, costs, and expenses (including reasonable attorneys' fees) arising out of or relating to Your breach of this EULA or Your misuse of the Software.</p>
    <h4 class="text-xl font-orbitron mt-4 mb-2">12. GOVERNING LAW AND DISPUTE RESOLUTION</h4>
    <ul class="list-disc list-outside ml-6 space-y-2">
        <li>a. Governing Law:  This EULA shall be governed by and construed in accordance with the laws of the State of California, USA, without regard to its conflict of law principles.</li>
        <li>b.  Informal Negotiation:  To expedite resolution and control the cost of any dispute, You and Licensor agree to first attempt to negotiate any dispute informally for at least thirty (30) days before initiating any arbitration or court proceeding. Such informal negotiations commence upon written notice from one party to the other.</li>
        <li>c.  Binding Arbitration:  If a dispute cannot be resolved through informal negotiations, any claim, dispute, or controversy (excluding claims for injunctive or other equitable relief) shall be resolved by binding arbitration conducted by a single neutral arbitrator from the American Arbitration Association (AAA) under its Commercial Arbitration Rules. The arbitration shall take place in Santa Clara County, California. The arbitrator's decision shall be final and binding and may be entered as a judgment in any court of competent jurisdiction.</li>
        <li>d.  CLASS ACTION AND JURY TRIAL WAIVER:  YOU AND LICENSOR AGREE THAT ANY PROCEEDINGS TO RESOLVE OR LITIGATE ANY DISPUTE WILL BE CONDUCTED SOLELY ON AN INDIVIDUAL BASIS. NEITHER YOU NOR LICENSOR WILL SEEK TO HAVE ANY DISPUTE HEARD AS A CLASS ACTION, PRIVATE ATTORNEY GENERAL ACTION, OR IN ANY OTHER PROCEEDING IN WHICH EITHER PARTY ACTS OR PROPOSES TO ACT IN A REPRESENTATIVE CAPACITY. YOU AND LICENSOR BOTH EXPRESSLY WAIVE ANY RIGHT TO A TRIAL BY JURY.</li>
    </ul>
    <h4 class="text-xl font-orbitron mt-4 mb-2">13. GENERAL PROVISIONS</h4>
    <ul class="list-disc list-outside ml-6 space-y-2">
        <li>a.  Severability:  If any provision of this EULA is held to be invalid, illegal, or unenforceable, the validity, legality, and enforceability of the remaining provisions shall not be affected or impaired.</li>
        <li>b.  Entire Agreement:  This EULA constitutes the entire agreement between You and Licensor regarding the Software and supersedes all prior or contemporaneous understandings, agreements, or representations, whether written or oral.</li>
        <li>c.  Amendment:  Licensor reserves the right, at its sole discretion, to amend this EULA at any time. If We amend this EULA, We will post the amended EULA within the Software or on our website. Your continued use of the Software after such posting shall constitute Your acceptance of the amended EULA.</li>
        <li>d.  No Waiver:  The failure of Licensor to exercise or enforce any right or provision of this EULA shall not constitute a waiver of such right or provision.</li>
        <li>e.  Contact:  If You have any questions concerning this EULA, please contact Licensor at: devon_casey@outlook.com .</li>
    </ul>
`;
// [[END]] VIRTUAL WORKBENCH (EULA Content)


export class UIManager {
    /**
     * @param {import('./LoggingService.js').Logger} logger The logging utility.
     */
    constructor(logger) {
         this.logger = logger;
        this.isMobile = window.innerWidth <= 768;
        this.modalQueue = [];
        this.activeGraphAnchor = null;
        this.activeGenericTooltipAnchor = null;
        this.lastActiveScreenEl = null;
        this.lastKnownState = null;
        this.missionService = null; // To be injected
        this.simulationService = null; // To be injected
        this.newsTickerService = null; // ADDED
        this.debugService = null; // To be injected
        this.marketTransactionState = {}; // To store quantity and mode
        this.activeHighlightConfig = null; // Stores the config for currently visible highlights
        this.marketScrollPosition = 0;
        this.popperInstance = null; // Instance for Popper.js
        // MODIFIED: Added property to hold injected EventManager
        this.eventManager = null; // To be injected

        // --- VIRTUAL WORKBENCH: ADD INTEL SERVICE/RENDERER ---
        /** @type {import('./IntelService.js').IntelService | null} */
        this.intelService = null; // To be injected
        /** @type {IntelMarketRenderer | null} */
        this.intelMarketRenderer = null;
        // To be instantiated
        // --- END VIRTUAL WORKBENCH ---

        this.effectsManager = new EffectsManager();

        this.travelAnimationService = new TravelAnimationService(this.isMobile);

        this.navStructure = {
            [NAV_IDS.SHIP]: { label: 'Ship', screens: { [SCREEN_IDS.MAP]: 'Map', [SCREEN_IDS.NAVIGATION]: 'Navigation', [SCREEN_IDS.CARGO]: 'Cargo' } },
            [NAV_IDS.STARPORT]: { label: 'Starport', screens: { [SCREEN_IDS.MARKET]: 'Market', [SCREEN_IDS.SERVICES]: 'Services', [SCREEN_IDS.HANGAR]: 'Shipyard' } },
            [NAV_IDS.DATA]: { label: 'Data', screens: { [SCREEN_IDS.MISSIONS]: 'Missions', [SCREEN_IDS.FINANCE]: 'Finance', [SCREEN_IDS.INTEL]: 'Intel' } }
         };
        this._cacheDOM();

        // --- VIRTUAL WORKBENCH: BIND 'this' CONTEXT ---
        this.getItemPrice = this.getItemPrice.bind(this);
        // --- END VIRTUAL WORKBENCH ---

        // This remains the correct way to handle orientation changes or desktop resizing.
        window.addEventListener('resize', this._setAppHeight);
    }

    /**
     * Sets the --app-height CSS variable to the actual window inner height.
     * This is the definitive fix for the mobile viewport height bug on iOS.
     * @private
     */
    _setAppHeight() {
        document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
    }

    /**
     * @JSDoc
     * @method triggerEffect
     * @description Public method to trigger a registered visual effect.
     * @param {string} name - The name the effect was registered under.
     * @param {object} options - The configuration options for the effect.
     */
    triggerEffect(name, options) {
        this.effectsManager.trigger(name, options);
    }

    /**
     * Injects the MissionService after instantiation to avoid circular dependencies.
     * @param {import('./MissionService.js').MissionService} missionService
     */
    setMissionService(missionService) {
         this.missionService = missionService;
    }

    /**
     * Injects the SimulationService after instantiation.
     * @param {import('./SimulationService.js').SimulationService} simulationService
     */
    setSimulationService(simulationService) {
        this.simulationService = simulationService;
    }

    /**
     * Injects the NewsTickerService after instantiation.
     * @param {import('./NewsTickerService.js').NewsTickerService} newsTickerService
     */
    setNewsTickerService(newsTickerService) {
        this.newsTickerService = newsTickerService;
    }

    /**
     * Injects the DebugService after instantiation.
     * @param {import('./DebugService.js').DebugService} service
     */
    setDebugService(service) {
        this.debugService = service;
    }

    // --- VIRTUAL WORKBENCH: ADD INTELSERVICE SETTER ---
    /**
     * Injects the IntelService and instantiates the IntelMarketRenderer.
     * @param {import('./IntelService.js').IntelService} intelService
     * @JSDoc
     */
    setIntelService(intelService) {
        this.intelService = intelService;
        this.intelMarketRenderer = new IntelMarketRenderer(intelService);
    }
    // --- END VIRTUAL WORKBENCH ---

    /**
     * MODIFIED: Injects the EventManager after instantiation.
     * @param {import('./EventManager.js').EventManager} eventManager
     */
     setEventManager(eventManager) {
        this.eventManager = eventManager;
    }

    /**
    * Resets the state of the market transaction modules.
    */
    resetMarketTransactionState() {
        this.marketTransactionState = {};
    }

    _cacheDOM() {
        this.cache = {
            gameContainer: document.getElementById('game-container'),
            navBar: document.getElementById('nav-bar'),
            newsTickerBar: document.getElementById('news-ticker-bar'), // ADDED
            topBarContainer: document.getElementById('top-bar-container'),
            subNavBar: document.getElementById('sub-nav-bar'),
            stickyBar: document.getElementById('sticky-bar'),
            mapScreen: document.getElementById(`${SCREEN_IDS.MAP}-screen`),
            navigationScreen: document.getElementById(`${SCREEN_IDS.NAVIGATION}-screen`),
            servicesScreen: document.getElementById(`${SCREEN_IDS.SERVICES}-screen`),
            marketScreen: document.getElementById(`${SCREEN_IDS.MARKET}-screen`),
            cargoScreen: document.getElementById(`${SCREEN_IDS.CARGO}-screen`),
            hangarScreen: document.getElementById(`${SCREEN_IDS.HANGAR}-screen`),
             missionsScreen: document.getElementById(`${SCREEN_IDS.MISSIONS}-screen`),
            financeScreen: document.getElementById(`${SCREEN_IDS.FINANCE}-screen`),
            intelScreen: document.getElementById(`${SCREEN_IDS.INTEL}-screen`),
            graphTooltip: document.getElementById('graph-tooltip'),
            genericTooltip: document.getElementById('generic-tooltip'),
            processingModal: document.getElementById('processing-modal'),
            shipDetailModal: document.getElementById('ship-detail-modal'),
            launchModal: document.getElementById('launch-modal'),
             launchModalContent: document.getElementById('launch-modal-content'),
            cargoDetailModal: document.getElementById('cargo-detail-modal'),
            cargoDetailContent: document.getElementById('cargo-detail-content'),

            mapDetailModal: document.getElementById('map-detail-modal'),
            
            // Lore Modal
            loreModal: document.getElementById('lore-modal'),
            loreModalContent: document.getElementById('lore-modal-content'),

            // [[START]] VIRTUAL WORKBENCH (Cache EULA Modal)
            eulaModal: document.getElementById('eula-modal'),
            eulaModalContent: document.getElementById('eula-modal-content'),
            // [[END]] VIRTUAL WORKBENCH (Cache EULA Modal)

            // --- [[START]] VIRTUAL WORKBENCH (Phase 5) ---
            // REMOVED shipInfoModal cache
            // REMOVED shipInfoModalContent cache
            // --- [[END]] VIRTUAL WORKBENCH (Phase 5) ---

            // Tutorial Elements
            tutorialAnchorOverlay: document.getElementById('tutorial-anchor-overlay'), // NEW
            tutorialToastContainer: document.getElementById('tutorial-toast-container'),
            tutorialToastText: document.getElementById('tutorial-toast-text'),
             tutorialToastSkipBtn: document.getElementById('tutorial-toast-skip-btn'),
            tutorialToastNextBtn: document.getElementById('tutorial-toast-next-btn'),
            skipTutorialModal: document.getElementById('skip-tutorial-modal'),
            skipTutorialConfirmBtn: document.getElementById('skip-tutorial-confirm-btn'),
            skipTutorialCancelBtn: document.getElementById('skip-tutorial-cancel-btn'),
            tutorialHighlightOverlay: document.getElementById('tutorial-highlight-overlay'),

            missionStickyBar: document.getElementById('mission-sticky-bar'),
            stickyObjectiveText: document.getElementById('sticky-objective-text'),
            stickyObjectiveProgress: document.getElementById('sticky-objective-progress')
        };
    }

    render(gameState) {
        if (!gameState || !gameState.player) return;

        const previousState = this.lastKnownState;
        this.lastKnownState = gameState;

        if (gameState.introSequenceActive && !gameState.tutorials.activeBatchId) {
            return;
        }

        const location = DB.MARKETS.find(l => l.id === gameState.currentLocationId);
        if (location) {
            this.cache.topBarContainer.setAttribute('data-location-theme', location.id);
            this.cache.gameContainer.className = `game-container ${location.bg}`;
            if (location.navTheme && location.navTheme.borderColor) {
                document.documentElement.style.setProperty('--theme-border-color', location.navTheme.borderColor);
                // --- VIRTUAL WORKBENCH: THEME VARIABLES ---
                // Set all theme variables for CSS to use
                document.documentElement.style.setProperty('--theme-gradient', location.navTheme.gradient);
                document.documentElement.style.setProperty('--theme-text-color', location.navTheme.textColor);
                // --- END VIRTUAL WORKBENCH ---

                // --- [[START]] MODIFICATION ---
                // Apply theme to the news ticker bar
                if (this.cache.newsTickerBar) {
                    this.cache.newsTickerBar.style.backgroundImage = location.navTheme.gradient;
                    this.cache.newsTickerBar.style.borderTopColor = location.navTheme.borderColor;
                    this.cache.newsTickerBar.style.borderBottomColor = location.navTheme.borderColor;
                    // Also remove the default background color to let the gradient show
                    this.cache.newsTickerBar.style.backgroundColor = 'transparent';
                }
                // --- [[END]] MODIFICATION ---

            } else {
                 document.documentElement.style.removeProperty('--theme-border-color');
                // --- VIRTUAL WORKBENCH: THEME VARIABLES ---
                // Clear theme variables
                document.documentElement.style.removeProperty('--theme-gradient');
                document.documentElement.style.removeProperty('--theme-text-color');
                // --- END VIRTUAL WORKBENCH ---

                // --- [[START]] MODIFICATION (Reset) ---
                // Reset theme on the news ticker bar if no theme exists
                if (this.cache.newsTickerBar) {
                    this.cache.newsTickerBar.style.backgroundImage = '';
                    this.cache.newsTickerBar.style.borderTopColor = ''; // Will revert to CSS default
                    this.cache.newsTickerBar.style.borderBottomColor = ''; // Will revert to CSS default
                    this.cache.newsTickerBar.style.backgroundColor = ''; // Will revert to CSS default
                 }
                // --- [[END]] MODIFICATION (Reset) ---

            }
        } else {
            // --- [[START]] MODIFICATION (Reset) ---
            // Handle case where there is no location (e.g., in transit)
            if (this.cache.newsTickerBar) {
                 this.cache.newsTickerBar.style.backgroundImage = '';
                this.cache.newsTickerBar.style.borderTopColor = '';
                this.cache.newsTickerBar.style.borderBottomColor = '';
                this.cache.newsTickerBar.style.backgroundColor = '';
            }
            // --- [[END]] MODIFICATION (Reset) ---
        }

        this._renderNewsTicker(); // ADDED
        this.renderNavigation(gameState);
        this.renderActiveScreen(gameState, previousState);
        this.updateStickyBar(gameState);
        this.renderStickyBar(gameState);
    }

    /**
     * Renders the content of the news ticker bar.
     * Includes "dirty" check for performance and dynamic animation speed.
     * @private
     */
    _renderNewsTicker() {
        if (!this.newsTickerService || !this.cache.newsTickerBar) return;
    
        // Only re-render if content has changed
        if (!this.newsTickerService.isDirty) return; 
    
        // 1. Get the content DIV string from the service
        const tickerHtml = this.newsTickerService.getTickerContentHtml();
        if (!tickerHtml) {
            this.cache.newsTickerBar.innerHTML = '';
            this.newsTickerService.isDirty = false;
            return;
        }

        // 2. Set it to measure the *single* width
        this.cache.newsTickerBar.innerHTML = tickerHtml;
        const contentElement = this.cache.newsTickerBar.querySelector('.news-ticker-content');
        
        if (contentElement) {
             const innerHtml = contentElement.innerHTML;
            
            // 3. Measure the width of the single block of content
            // We do this *before* duplicating
            const singleContentWidth = contentElement.scrollWidth;

            // 4. **Duplicate the inner HTML** for the seamless loop
            contentElement.innerHTML = innerHtml + innerHtml;
            
            // 5. Calculate duration based on the *single* width
            const PIXELS_PER_SECOND = 50;
            // The distance to scroll is one "block" of content
            const totalScrollDistance = singleContentWidth;
            
            // Set a minimum duration to prevent extremely fast scrolls on short text
            const duration = Math.max(20, totalScrollDistance / PIXELS_PER_SECOND); 
            
            contentElement.style.animationDuration = `${duration}s`;
        }
        
        this.newsTickerService.isDirty = false; // Reset flag
    }

    renderNavigation(gameState) {
        const { player, currentLocationId, activeNav, activeScreen, lastActiveScreen, introSequenceActive, tutorials, subNavCollapsed } = gameState;
        const { navLock } = tutorials;
        const location = DB.MARKETS.find(l => l.id === currentLocationId);
        const activeShipStatic = player.activeShipId ? DB.SHIPS[player.activeShipId] : null;
        const activeShipState = player.activeShipId ? player.shipStates[player.activeShipId] : null;
        const inventory = player.activeShipId ? player.inventories[player.activeShipId] : null;
        const theme = location?.navTheme || { gradient: 'linear-gradient(135deg, #4a5568, #2d3748)', textColor: '#f0f0f0' };

        // --- VIRTUAL WORKBENCH: APPLY MAX CREDITS DISPLAY ---
        const isMax = player.credits >= Number.MAX_SAFE_INTEGER;
        const creditText = isMax ? '⌬ MAXIMUM CREDITS ⌬' : formatCredits(player.credits);
        const creditClass = isMax ? 'text-glow-gold' : 'credits-text-pulsing';

        const contextBarHtml = `
            <div class="context-bar" style="background: ${theme.gradient}; color: ${theme.textColor};">
                <span class="location-name-text">${location?.name || 'In Transit'}</span>
                <span class="credit-text ${creditClass}">${creditText}</span>
            </div>`;
        // --- END VIRTUAL WORKBENCH ---

        const mainTabsHtml = Object.keys(this.navStructure).map(navId => {
            const isActive = navId === activeNav;
            const screenIdToLink = lastActiveScreen[navId] || Object.keys(this.navStructure[navId].screens)[0];
            const isDisabledByTutorial = navLock && navLock.navId !== navId;
            const isDisabled = introSequenceActive || isDisabledByTutorial;
            const activeStyle = isActive ? `background: ${theme.gradient}; color: ${theme.textColor};` : '';
             return `<div class="tab ${isActive ? 'active' : ''} ${isDisabled ? 'disabled' : ''}" 
                         style="${activeStyle}" data-action="${ACTION_IDS.SET_SCREEN}" data-nav-id="${navId}" data-screen-id="${screenIdToLink}">${this.navStructure[navId].label}</div>`;
        }).join('');

        let statusPodHtml = '';
        if (activeShipStatic && activeShipState && inventory) {
            const cargoUsed = calculateInventoryUsed(inventory);
            const hullPct = (activeShipState.health / activeShipStatic.maxHealth) * 100;
            const fuelPct = (activeShipState.fuel / activeShipStatic.maxFuel) * 100;
            const cargoPct = (cargoUsed / activeShipStatic.cargoCapacity) * 100;

            statusPodHtml = `
                 <div class="status-pod">
                    <div class="status-bar-group hull-group" data-action="toggle-tooltip">
                        <span class="status-bar-label">H</span>
                        <div class="status-bar"><div class="fill hull-fill" style="width: ${hullPct}%;"></div></div>
                         <div class="status-tooltip">${Math.floor(activeShipState.health)}/${activeShipStatic.maxHealth} Hull</div>
                    </div>
                    <div class="status-bar-group fuel-group" data-action="toggle-tooltip">
                        <span class="status-bar-label">F</span>
                        <div class="status-bar"><div class="fill fuel-fill" style="width: ${fuelPct}%;"></div></div>
                         <div class="status-tooltip">${Math.floor(activeShipState.fuel)}/${activeShipStatic.maxFuel} Fuel</div>
                    </div>
                    <div class="status-bar-group cargo-group" data-action="toggle-tooltip">
                        <span class="status-bar-label">C</span>
                        <div class="status-bar"><div class="fill cargo-fill" style="width: ${cargoPct}%;"></div></div>
                        <div class="status-tooltip">${cargoUsed}/${activeShipStatic.cargoCapacity} Cargo</div>
                    </div>
                </div>`;
        }

        const navWrapperHtml = `<div class="nav-wrapper">${mainTabsHtml}${statusPodHtml}</div>`;

        const subNavsHtml = Object.keys(this.navStructure).map(navId => {
            const screens = this.navStructure[navId].screens;
             const isActive = navId === activeNav;
            const subNavButtons = Object.keys(screens).map(screenId => {
                 const isDisabledByTutorial = navLock && navLock.screenId !== screenId;
                 const isSubNavActive = screenId === activeScreen;
                 const isDisabled = introSequenceActive || isDisabledByTutorial;
                 const activeClass = isSubNavActive ? 'sub-nav-active' : '';
                 
 
                 // --- VIRTUAL WORKBENCH: BUG FIX ---
                 // The 'set-intel-tab' action is for the *internal* tabs on the intel screen.
                 // The *main sub-nav* button must use 'set-screen' to navigate *to* the intel screen.
    
                 const action = ACTION_IDS.SET_SCREEN;
    
                 // --- END VIRTUAL WORKBENCH ---

                 
                 let subStyle = '';
                 if (isSubNavActive) {
                     subStyle = `style="background: ${theme.gradient}; color: ${theme.textColor}; opacity: 1; font-weight: 700;"`;
                 }
                 
                 // --- VIRTUAL WORKBENCH: Remove data-target from this button ---
                 return `<a href="#" class="${isDisabled ? 'disabled' : ''} ${activeClass}" ${subStyle} data-action="${action}" data-nav-id="${navId}" data-screen-id="${screenId}" draggable="false">${screens[screenId]}</a>`;
            }).join('');
            
            
            return `<div class="nav-sub ${(!isActive || subNavCollapsed) ? 'hidden' : ''}" id="${navId}-sub">${subNavButtons}</div>`;
        }).join('');

        this.cache.navBar.innerHTML = contextBarHtml + navWrapperHtml;
        this.cache.subNavBar.innerHTML = subNavsHtml;
    }

    renderActiveScreen(gameState, previousState) {
         const activeScreenEl = this.cache[`${gameState.activeScreen}Screen`];

        if (this.lastActiveScreenEl && this.lastActiveScreenEl !== activeScreenEl) {
            this.lastActiveScreenEl.classList.remove('active-screen');
        }

        if (activeScreenEl) {
            activeScreenEl.classList.add('active-screen');
            this.lastActiveScreenEl = activeScreenEl;
        }

        switch (gameState.activeScreen) {
            case SCREEN_IDS.MAP:
                this.cache.mapScreen.innerHTML = renderMapScreen();
                // Defer map initialization until after the browser has painted the new DOM elements,
    
                 // ensuring the map container has a valid clientHeight for D3 to use.
                requestAnimationFrame(() => initMap(this));
                break;
            case SCREEN_IDS.NAVIGATION:
                this.cache.navigationScreen.innerHTML = renderNavigationScreen(gameState);
                break;
            case SCREEN_IDS.SERVICES:
                this.cache.servicesScreen.innerHTML = renderServicesScreen(gameState);
                // MODIFIED: Bind hold events after rendering the services screen
                if (this.eventManager) {
                     this.eventManager.holdEventHandler.bindHoldEvents();
                }
                break;
            case SCREEN_IDS.MARKET:
                this.updateMarketScreen(gameState);
                break;
            case SCREEN_IDS.CARGO:
                this.cache.cargoScreen.innerHTML = renderCargoScreen(gameState);
                break;
            case SCREEN_IDS.HANGAR: {
                const needsFullRender = !previousState ||
                    previousState.activeScreen !== SCREEN_IDS.HANGAR ||
                    previousState.uiState.hangarShipyardToggleState !== gameState.uiState.hangarShipyardToggleState ||
                    previousState.player.activeShipId !== gameState.player.activeShipId ||
                    previousState.uiState.lastTransactionTimestamp !== gameState.uiState.lastTransactionTimestamp ||
                    (previousState && previousState.tutorials.activeBatchId !== gameState.tutorials.activeBatchId) ||
                    (previousState && previousState.tutorials.activeStepId !== gameState.tutorials.activeStepId);

                if (needsFullRender) {
                    this.cache.hangarScreen.innerHTML = renderHangarScreen(gameState, this.simulationService);
                }
                
                this._updateHangarScreen(gameState);
                break;
            }
            case SCREEN_IDS.MISSIONS:
                this.cache.missionsScreen.innerHTML = renderMissionsScreen(gameState, this.missionService);
                break;
            case SCREEN_IDS.FINANCE:
          
                 this.cache.financeScreen.innerHTML = renderFinanceScreen(gameState);
                break;
            case SCREEN_IDS.INTEL:
                // --- VIRTUAL WORKBENCH: RENDER INTEL SCREEN ---

                // --- VIRTUAL WORKBENCH (A) ---
                // Check if a full render is needed (e.g., first time visiting screen)
                const needsFullRender = !previousState || previousState.activeScreen !== SCREEN_IDS.INTEL;
                
                /**
   
                 * Only render the static shell of the Intel screen if it's the first time
                 * navigating to it. This prevents state updates (like purchasing intel)
                 * from destroying the DOM and resetting the active tab.
                 */
                if (needsFullRender) {
          
                     this.cache.intelScreen.innerHTML = renderIntelScreen();
                }
                // --- END VIRTUAL WORKBENCH (A) ---
                
                /**
                 * This block runs on *every* render for the INTEL screen.
                 * If the shell was just built, it populates the content.
                 * If a state 
change occurred (like a purchase), it *surgically
                 * re-renders* the market content, updating button states
                 * without resetting the active tab.
                 */
                if (this.intelMarketRenderer) {
                    // Find the container for the market tab content
           
                     const marketContentEl = this.cache.intelScreen.querySelector('#intel-market-content');
                    if (marketContentEl) {
                        this.intelMarketRenderer.render(marketContentEl, gameState);
                    }
                }
                
                // --- VIRTUAL WORKBENCH (B) ---
                
                // Always call updateIntelTab to ensure the *correct* tab
                // (Codex or Market) is shown based on the game state.
                this.updateIntelTab(gameState.uiState.activeIntelTab);
                // --- END VIRTUAL WORKBENCH (B) ---
                
                break;
        }
    }

    /**
     * Surgically updates the Hangar screen for smooth transitions without a full re-render.
     * @param {object} gameState The current game state.
     * @private
     */
    _updateHangarScreen(gameState) {
        const { uiState } = gameState;
        const hangarScreenEl = this.cache.hangarScreen;
        if (!hangarScreenEl) return;

        const carousel = hangarScreenEl.querySelector('#hangar-carousel');
        if (!carousel) return;

        const isHangarMode = uiState.hangarShipyardToggleState === 'hangar';
        const activeIndex = isHangarMode ? (uiState.hangarActiveIndex || 0) : (uiState.shipyardActiveIndex || 0);

        // Update carousel position
        carousel.style.transform = `translateX(-${activeIndex * 100}%)`;

        // RENDER VIRTUAL PAGINATION
        this._renderHangarPagination(gameState);
        // Scroll the pagination container to center the active dot
        const paginationWrapper = hangarScreenEl.querySelector('#hangar-pagination-wrapper');
        const activeDot = hangarScreenEl.querySelector('.pagination-dot.active');

        if (paginationWrapper && activeDot) {
            const wrapperWidth = paginationWrapper.clientWidth;
            const dotOffsetLeft = activeDot.offsetLeft;
            const dotWidth = activeDot.offsetWidth;

            // Calculate the target scroll position to center the active dot
            const scrollLeft = dotOffsetLeft - (wrapperWidth / 2) + (dotWidth / 2);

            paginationWrapper.scrollTo({
                left: scrollLeft,
                behavior: 'smooth'
            });
        }
    }

    /**
     * Renders the virtualized pagination for the hangar/shipyard screen.
     * It shows a maximum of 6 full dots and up to 2 half-dots as indicators for more items.
     * @param {object} gameState The current game state.
     * @private
     */
    _renderHangarPagination(gameState) {
        const { uiState, player, currentLocationId } = gameState;
        const hangarScreenEl = this.cache.hangarScreen;
        if (!hangarScreenEl) return;

        const paginationContainer = hangarScreenEl.querySelector('#hangar-pagination');
        if (!paginationContainer) return;

        const isHangarMode = uiState.hangarShipyardToggleState === 'hangar';
        const shipList = isHangarMode ? player.ownedShipIds : this.simulationService._getShipyardInventory().map(([id]) => id);
        const totalItems = shipList.length;

        // Hide pagination if there is only one or zero ships.
        if (totalItems <= 1) {
            paginationContainer.innerHTML = '';
            return;
        }

        const activeIndex = isHangarMode ? (uiState.hangarActiveIndex || 0) : (uiState.shipyardActiveIndex || 0);

        const location = DB.MARKETS.find(l => l.id === currentLocationId);
        const theme = location?.navTheme || { borderColor: '#7a9ac0' };

        const VISIBLE_FULL_DOTS = 6;
        let dots = [];

        if (totalItems <= VISIBLE_FULL_DOTS + 1) { // If 7 or fewer items, show all as full dots
            for (let i = 0; i < totalItems; i++) {
                dots.push({ index: i, isActive: i === activeIndex, isHalf: false });
            }
        } else {
            let start, end;
            const isNearStart = activeIndex < VISIBLE_FULL_DOTS - 1;
            const isNearEnd = activeIndex > totalItems - VISIBLE_FULL_DOTS;

            if (isNearStart) {
                start = 0;
                end = VISIBLE_FULL_DOTS;
            } else if (isNearEnd) {
                 start = totalItems - VISIBLE_FULL_DOTS;
                end = totalItems;
            } else {
                start = activeIndex - Math.floor(VISIBLE_FULL_DOTS / 2) + 1;
                end = activeIndex + Math.ceil(VISIBLE_FULL_DOTS / 2);
            }

            // Add previous indicator if needed
            if (start > 0) {
                dots.push({ isHalf: true, jump: 'prev' });
            }

             // Add the main window of full dots
            for (let i = start; i < end; i++) {
                dots.push({ index: i, isActive: i === activeIndex, isHalf: false });
            }

            // Add next indicator if needed
            if (end < totalItems) {
                dots.push({ isHalf: true, jump: 'next' });
            }
        }

        const dotsHtml = dots.map(dot => {
            const style = `
                --theme-color-primary: ${theme.borderColor};
                --theme-glow-color: ${theme.borderColor};
            `;
            if (dot.isHalf) {
                 return `<div class="pagination-dot half" style="${style}" data-action="${ACTION_IDS.SET_HANGAR_PAGE}" data-jump-direction="${dot.jump}"></div>`;
            } else {
                return `<div class="pagination-dot ${dot.isActive ? 'active' : ''}" style="${style}" data-action="${ACTION_IDS.SET_HANGAR_PAGE}" data-index="${dot.index}"></div>`;
            }
        }).join('');

        paginationContainer.innerHTML = dotsHtml;
    }


    updateStickyBar(gameState) {
        this.cache.stickyBar.innerHTML = '';
        this.cache.topBarContainer.classList.remove('has-sticky-bar');
    }

    updateServicesScreen(gameState) {
        if (gameState.activeScreen !== SCREEN_IDS.SERVICES) return;
        const { player } = gameState;
        const shipStatic = DB.SHIPS[player.activeShipId];
        const shipState = player.shipStates[player.activeShipId];

        const fuelBar = this.cache.servicesScreen.querySelector('#fuel-bar');
        const refuelBtn = this.cache.servicesScreen.querySelector('#refuel-btn');
        if (fuelBar && refuelBtn) {
            const fuelPct = (shipState.fuel / shipStatic.maxFuel) * 100;
            fuelBar.style.width = `${fuelPct}%`;
            refuelBtn.disabled = shipState.fuel >= shipStatic.maxFuel;
        }

        const repairBar = this.cache.servicesScreen.querySelector('#repair-bar');
        const repairBtn = this.cache.servicesScreen.querySelector('#repair-btn');
        if (repairBar && repairBtn) {
            const healthPct = (shipState.health / shipStatic.maxHealth) * 100;
            repairBar.style.width = `${healthPct}%`;
            repairBtn.disabled = shipState.health >= shipStatic.maxHealth;
        }
    }

    updateMarketScreen(gameState) {
 
        if (gameState.activeScreen !== SCREEN_IDS.MARKET) return;
        
        // --- [[START]] MODIFICATION ---
        // Changed '.scroll-panel' to '.market-scroll-panel' to match MarketScreen.js
        const marketScrollPanel = this.cache.marketScreen.querySelector('.market-scroll-panel'); 
        // --- [[END]] MODIFICATION ---

        if (this.lastKnownState && this.lastKnownState.activeScreen === SCREEN_IDS.MARKET && this.lastKnownState.currentLocationId === gameState.currentLocationId && marketScrollPanel) {
            this.marketScrollPosition = marketScrollPanel.scrollTop;
        } else {
            this.marketScrollPosition = 0;
        }
    
       
         this._saveMarketTransactionState();
        this.cache.marketScreen.innerHTML = renderMarketScreen(gameState, this.isMobile, this.getItemPrice, this.marketTransactionState);
        this._restoreMarketTransactionState();
        
        // --- [[START]] MODIFICATION ---
        // Changed '.scroll-panel' to '.market-scroll-panel' to match MarketScreen.js
        const newMarketScrollPanel = this.cache.marketScreen.querySelector('.market-scroll-panel');
        // --- [[END]] MODIFICATION ---

        if (newMarketScrollPanel) {
            newMarketScrollPanel.scrollTop = this.marketScrollPosition;
        }
    }

    _saveMarketTransactionState() {
        if (!this.lastKnownState || this.lastKnownState.activeScreen !== SCREEN_IDS.MARKET) return;
        const controls = this.cache.marketScreen.querySelectorAll('.transaction-controls');
        controls.forEach(control => {
             const goodId = control.dataset.goodId;
            const qtyInput = control.querySelector('input');
            const mode = control.dataset.mode;

            if (qtyInput) {
                this.marketTransactionState[goodId] = {
                    quantity: qtyInput.value,
                    mode: mode
                 };
            }
        });
    }

    _restoreMarketTransactionState() {
        for (const goodId in this.marketTransactionState) {
            const state = this.marketTransactionState[goodId];
            const control = this.cache.marketScreen.querySelector(`.transaction-controls[data-good-id="${goodId}"]`);
            if (control) {
                const qtyInput = control.querySelector('input');
                if (qtyInput) {
                     qtyInput.value = state.quantity;
                    control.setAttribute('data-mode', state.mode);
                    // After restoring state, immediately update the display to reflect it.
                    this.updateMarketCardDisplay(goodId, parseInt(state.quantity, 10) || 0, state.mode);
                }
            }
        }
    }

    getItemPrice(gameState, goodId, isSelling = false) {
        // --- VIRTUAL WORKBENCH: USE INTEL-AWARE GETPRICE ---
        // Use the simulationService (which now points to MarketService's getPrice)
        // to ensure intel overrides are checked.
        if (!this.simulationService || !this.simulationService.marketService) {
            // Fallback for early load
            return gameState.market.prices[gameState.currentLocationId]?.[goodId] || 0;
        }
        
        // Note: The isSelling logic for specialDemand is handled inside the
        // UIManager's _calculateSaleDetails, not here.
        // This function just needs to get the *base* price, which
        // MarketService.getPrice() now does (checking for intel overrides).
        return this.simulationService.marketService.getPrice(gameState.currentLocationId, goodId);
        // --- END VIRTUAL WORKBENCH ---
     }

    _calculateSaleDetails(goodId, quantity) {
        const state = this.lastKnownState;
        if (!state) return { totalPrice: 0, effectivePricePerUnit: 0, netProfit: 0 };

        const good = DB.COMMODITIES.find(c => c.id === goodId);
        const marketStock = state.market.inventory[state.currentLocationId][goodId].quantity;
        
        // --- VIRTUAL WORKBENCH: USE INTEL-AWARE GETPRICE ---
        // Pass `true` for isSelling to get the correct base price
        const basePrice = this.getItemPrice(state, goodId, true);
        // --- END VIRTUAL WORKBENCH ---

        const playerItem = state.player.inventories[state.player.activeShipId]?.[goodId];
        const avgCost = playerItem?.avgCost || 0;

        // --- VIRTUAL WORKBENCH: REMOVE PENALTY ---
        // Guard against division by zero if market stock is depleted.
        // if (marketStock <= 0) { // This check is no longer needed as we're not dividing by it
        //     return { totalPrice: 0, effectivePricePerUnit: 0, netProfit: 0, reduction: 0 };
        // }
        
        const effectivePrice = basePrice; // Price is always the base price
        const totalPrice = Math.floor(effectivePrice * quantity);

        // This block is now simplified as reduction is gone
        // const threshold = marketStock * 0.1;
        // if (quantity <= threshold) {
        //     const totalPrice = basePrice * quantity;
        //     const totalCost = avgCost * quantity;
        //     let netProfit = totalPrice - totalCost;
        //     if (netProfit > 0) {
        //         let totalBonus = (state.player.activePerks[PERK_IDS.TRADEMASTER] ? DB.PERKS[PERK_IDS.TRADEMASTER].profitBonus : 0) + (state.player.birthdayProfitBonus || 0);
        //         netProfit += netProfit * totalBonus;
        //     }
        //     return { totalPrice, effectivePricePerUnit: basePrice, netProfit };
        // }
        //
        // const excessRatio = quantity / marketStock;
        // let reduction = 0;
        //
        // [OLD PENALTY LOGIC REMOVED]
        //
        // const effectivePrice = basePrice * (1 - reduction);
        // const totalPrice = Math.floor(effectivePrice * quantity);
        // --- END VIRTUAL WORKBENCH ---

         const totalCost = avgCost * quantity;
        let netProfit = totalPrice - totalCost;
        if (netProfit > 0) {
            let totalBonus = (state.player.activePerks[PERK_IDS.TRADEMASTER] ? DB.PERKS[PERK_IDS.TRADEMASTER].profitBonus : 0) + (state.player.birthdayProfitBonus || 0);
            netProfit += netProfit * totalBonus;
        }

        return {
            totalPrice,
            effectivePricePerUnit: effectivePrice, // This is now just basePrice
            netProfit
         };
    }


    updateMarketCardPrice(goodId, newPrice) {
        const priceEl = this.cache.marketScreen.querySelector(`#price-display-${goodId}`);
        if (priceEl) {
            priceEl.dataset.basePrice = newPrice;
            const controls = priceEl.closest('.item-card-container').querySelector('.transaction-controls');
            if (controls && controls.dataset.mode === 'buy') {
                priceEl.textContent = formatCredits(newPrice);
            }
        }
    }

    updateMarketCardDisplay(goodId, quantity, mode) {
        const priceEl = this.cache.marketScreen.querySelector(`#price-display-${goodId}`);
        const effectivePriceEl = this.cache.marketScreen.querySelector(`#effective-price-display-${goodId}`);
        const indicatorEl = this.cache.marketScreen.querySelector(`#indicators-${goodId}`);
        const avgCostEl = this.cache.marketScreen.querySelector(`#avg-cost-${goodId}`);

        if (!priceEl || !effectivePriceEl || !indicatorEl || !this.lastKnownState) return;

        const state = this.lastKnownState;
        const basePrice = parseInt(priceEl.dataset.basePrice, 10);
        const playerItem = state.player.inventories[state.player.activeShipId]?.[goodId];

        if (avgCostEl) {
            avgCostEl.classList.toggle('visible', mode === 'sell');
        }

        if (mode === 'buy') {
            // --- VIRTUAL WORKBENCH START: Phase 4 (Revert) ---
            priceEl.textContent = formatCredits(basePrice);
            priceEl.className = 'font-roboto-mono font-bold price-text';
            // --- VIRTUAL WORKBENCH END: Phase 4 (Revert) ---
             effectivePriceEl.textContent = '';
            
            indicatorEl.innerHTML = renderIndicatorPills({
                price: basePrice,
                // --- VIRTUAL WORKBENCH: USE INTEL-AWARE GETPRICE ---
                sellPrice: this.getItemPrice(state, goodId, true),
                // --- END VIRTUAL WORKBENCH ---
                galacticAvg: state.market.galacticAverages[goodId],
                 playerItem: playerItem
            });

        } else { // 'sell' mode
            const { effectivePricePerUnit, netProfit } = this._calculateSaleDetails(goodId, quantity);

            if (quantity > 0) {
                let profitText = `⌬ ${netProfit >= 0 ? '+' : ''}${formatCredits(netProfit, false)}`;
                priceEl.textContent = profitText;
                // --- VIRTUAL WORKBENCH: RE-ADD per user request ---
                // Show the base price per unit, since there is no penalty
                effectivePriceEl.textContent = `(${formatCredits(basePrice, false)}/unit)`;
                // --- END VIRTUAL WORKBENCH ---
                priceEl.className = `font-roboto-mono font-bold ${netProfit >= 0 ? 'profit-text' : 'loss-text'}`;
            } else {
                priceEl.textContent = '⌬ +0';
                priceEl.className = 'font-roboto-mono font-bold profit-text';
                effectivePriceEl.textContent = '';
            }

            indicatorEl.innerHTML = renderIndicatorPills({
                 price: basePrice,
                // --- VIRTUAL WORKBENCH: USE INTEL-AWARE GETPRICE ---
                sellPrice: effectivePricePerUnit || this.getItemPrice(state, goodId, true),
                // --- END VIRTUAL WORKBENCH ---
                galacticAvg: state.market.galacticAverages[goodId],
                playerItem: playerItem
            });
        }
    }

    showTravelAnimation(from, to, travelInfo, totalHullDamagePercent, finalCallback) {
        this.travelAnimationService.play(from, to, travelInfo, totalHullDamagePercent, finalCallback);
    }



    queueModal(modalId, title, description, callback = null, options = {}) {
        this.modalQueue.push({ modalId, title, description, callback, options });
        if (!document.querySelector('.modal-backdrop:not(.hidden)')) {
            this.processModalQueue();
        }
    }

    processModalQueue() {
        if (this.modalQueue.length === 0) return;
        const { modalId, title, description, callback, options } = this.modalQueue.shift();
        const modal = document.getElementById(modalId);
        if (!modal) {
            this.logger.error('UIManager', `Modal element with ID '${modalId}' not found in the DOM. Aborting modal display.`);
            return this.processModalQueue();
        }

        if (options.specialClass) {
            modal.classList.add(options.specialClass);
        }
        if (options.nonDismissible) {
            modal.classList.add('dismiss-disabled');
        }
        
        
        // --- VIRTUAL WORKBENCH: GDD MODAL THEMING ---
        // Apply theme data attribute for CSS-based theming (e.g., glowing borders)
        if (options.theme) {
            modal.dataset.theme = options.theme;
        } else {
            // Remove old theme to avoid stale borders
            delete modal.dataset.theme;
        }
        
        // GDD: Control dismissal behavior
         modal.dataset.dismissInside = options.dismissInside || 'false';
        modal.dataset.dismissOutside = options.dismissOutside || 'false';
        // --- END VIRTUAL WORKBENCH ---

        const titleElId = modalId === 'mission-modal' ? 'mission-modal-title' : modalId.replace('-modal', '-title');
        const descElId = modalId === 'mission-modal' ? 'mission-modal-description' : modalId.replace('-modal', '-description');
        const titleEl = modal.querySelector(`#${titleElId}`);
        const descEl = modal.querySelector(`#${descElId}`) || modal.querySelector(`#${modalId.replace('-modal', '-scenario')}`);

        if (titleEl) titleEl.innerHTML = title;
        if (descEl) {
            descEl.innerHTML = description;
            descEl.className = 'my-4 text-gray-300'; // Reset classes

            if (modalId !== 'mission-modal') {
                 descEl.classList.add('mb-6', 'text-lg');
            }

            // Default to centered text for generic event modals, which are mostly short notices.
            if (modalId === 'event-modal' || modalId === 'random-event-modal') {
                descEl.classList.add('text-center');
            }

            if (options.contentClass) {
                // Allow `contentClass` to override the default alignment.
                if (options.contentClass.includes('text-left') || options.contentClass.includes('text-right') || options.contentClass.includes('text-justify')) {
                     descEl.classList.remove('text-center');
                }
                // Add all provided custom classes.
                descEl.classList.add(...options.contentClass.split(' ').filter(Boolean));
            }
        }

        const closeHandler = () => {
            this.hideModal(modalId);
            if (callback) callback();
            this.processModalQueue();
        };

        if (options.customSetup) {
            options.customSetup(modal, closeHandler);
        } else {
            const btnContainer = modal.querySelector('#' + modalId.replace('-modal', '-button-container'));
            let button;
            
            // --- VIRTUAL WORKBENCH: GDD FOOTER LOGIC ---
            if (options.footer) {
                // If a custom footer is provided, inject it and attach handlers
                if (btnContainer) {
                    btnContainer.innerHTML = options.footer;
                    // Find any buttons *inside* the new footer and attach handlers
                     btnContainer.querySelectorAll('button[data-action]').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            // --- VIRTUAL WORKBENCH (C) ---
                            /**
                             * Check if the action is 'buy_intel'.
                             * If it is, we *don't* call closeHandler() here.
                             * We let ActionClickHandler -> UIManager.handleBuyIntel
                             * manage the modal closing and chaining, preventing a race condition.
                             */
                            if (btn.dataset.action === 'buy_intel') {
                                 return; // Let the specific handler do the work
                            }
                            // --- END VIRTUAL WORKBENCH (C) ---

                             // Let the main EventManager handle the action first
                            // But also ensure the modal closes for all *other* actions.
                            closeHandler();
                        });
                    });
                }
            } else if (options.footer === null) {
                // GDD: Explicitly no footer/buttons
                if (btnContainer) btnContainer.innerHTML = '';
            } else {
            // --- END VIRTUAL WORKBENCH ---
                // Original default button logic
                if (btnContainer) {
                    btnContainer.innerHTML = '';
                    button = document.createElement('button');
                    btnContainer.appendChild(button);
                } else {
                    button = modal.querySelector('button');
                }
                if (button) {
                    button.className = 'btn px-6 py-2';
                    if (options.buttonClass) button.classList.add(options.buttonClass);
                    button.innerHTML = options.buttonText || 'Understood';
                    button.onclick = closeHandler;
                }
            // --- VIRTUAL WORKBENCH ---
            }
            // --- END VIRTUAL WORKBENCH ---
        }

         modal.classList.remove('hidden');
        modal.classList.add('modal-visible');
    }

    showRandomEventModal(event, choicesCallback) {
        this.queueModal('random-event-modal', event.title, event.scenario, null, {
            nonDismissible: true,
            customSetup: (modal, closeHandler) => {
                const choicesContainer = modal.querySelector('#random-event-choices-container');
                choicesContainer.innerHTML = '';
                event.choices.forEach((choice, index) => {
                    const button = document.createElement('button');
                    button.className = 'btn w-full text-center p-4 hover:bg-slate-700';
                    button.innerHTML = choice.title;
                    button.onclick = () => {
                         choicesCallback(event.id, index);
                        closeHandler();
                    };
                    choicesContainer.appendChild(button);
                });
            }
        });
    }

    showAgeEventModal(event, choiceCallback) {
        const modal = document.getElementById('age-event-modal');
        modal.classList.add('dismiss-disabled');
        document.getElementById('age-event-title').innerHTML = event.title;
        document.getElementById('age-event-description').innerHTML = event.description;
        const btnContainer = document.getElementById('age-event-button-container');
        btnContainer.innerHTML = '';
        event.choices.forEach(choice => {
            const button = document.createElement('button');
            button.className = 'perk-button';
            button.innerHTML = `<h4>${choice.title}</h4><p>${choice.description}</p>`;
            button.onclick = () => {
                this.hideModal('age-event-modal');
                choiceCallback(choice);
            };
            btnContainer.appendChild(button);
        });
        modal.classList.remove('hidden');
        modal.classList.add('modal-visible');
    }

    /**
     * Displays the new modal for showing lore text.
     * @param {string} loreId The ID of the lore to display (e.g., 'story_so_far').
     */
    showLoreModal(loreId) {
        const modal = this.cache.loreModal;
        const contentEl = this.cache.loreModalContent;
        
        if (!modal || !contentEl) {
             this.logger.error('UIManager', 'Lore modal elements not cached or found in DOM.');
            return;
        }

        const contentHtml = LORE_CONTENT[loreId];
        if (!contentHtml) {
            this.logger.error('UIManager', `No lore content found for ID: ${loreId}`);
            contentEl.innerHTML = '<p>Error: Lore content not found.</p>';
        } else {
            contentEl.innerHTML = contentHtml;
        }
        
        // Ensure scroll position is at the top
        contentEl.scrollTop = 0;

        modal.classList.remove('hidden');
        modal.classList.add('modal-visible');
        // Add a one-time click listener to the backdrop *and* content area to close the modal.
        const closeHandler = (e) => {
            if (e.target.closest('#lore-modal-content') || e.target.id === 'lore-modal') {
                this.hideModal('lore-modal');
                modal.removeEventListener('click', closeHandler);
            }
        };
        modal.addEventListener('click', closeHandler);
    }
// js/services/UIManager.js
// ... (first half of the file)

    // --- [[START]] VIRTUAL WORKBENCH (Phase 4) ---
    /**
     * Displays the new modal for showing ship info text.
     * @param {string} shipId The ID of the ship to display info for.
     */
    // REMOVED showShipInfoModal function
    // --- [[END]] VIRTUAL WORKBENCH (Phase 4) ---

    // [[START]] VIRTUAL WORKBENCH (showEulaModal)
    /**
     * Displays the new modal for showing the EULA.
     * Modeled after showLoreModal for scrollability and dismissal.
     */
     showEulaModal() {
        const modal = this.cache.eulaModal;
        const contentEl = this.cache.eulaModalContent;
        
        if (!modal || !contentEl) {
            this.logger.error('UIManager', 'EULA modal elements not cached or found in DOM.');
            return;
        }

        if (!EULA_CONTENT) {
            this.logger.error('UIManager', 'EULA_CONTENT is not defined or empty.');
            contentEl.innerHTML = '<p>Error: EULA content not found.</p>';
        } else {
            contentEl.innerHTML = EULA_CONTENT;
        }
        
    
         // Ensure scroll position is at the top
        contentEl.scrollTop = 0;

        modal.classList.remove('hidden');
        modal.classList.add('modal-visible');
        
        // Add a one-time click listener to the backdrop *and* content area to close the modal.
        const closeHandler = (e) => {
            if (e.target.closest('#eula-modal-content') || e.target.id === 'eula-modal') {
                this.hideModal('eula-modal');
                modal.removeEventListener('click', closeHandler);
            }
        };
        modal.addEventListener('click', closeHandler);
    }
    // [[END]] VIRTUAL WORKBENCH (showEulaModal)

    hideModal(modalId) {
    
         const modal = document.getElementById(modalId);
        if (modal && !modal.classList.contains('hidden')) {
            modal.classList.add('modal-hiding');
            modal.addEventListener('animationend', () => {
                modal.classList.add('hidden');
                modal.classList.remove('modal-hiding', 'modal-visible', 'dismiss-disabled', 'intro-fade-in');
                
                // --- VIRTUAL WORKBENCH: CLEANUP GDD ATTRIBUTES ---
                delete modal.dataset.theme;
                delete modal.dataset.dismissInside;
                delete modal.dataset.dismissOutside;
                // --- END VIRTUAL WORKBENCH ---

                if (this.modalQueue.length > 0 && !document.querySelector('.modal-backdrop:not(.hidden)')) {
                    this.processModalQueue();
                 }
            }, { once: true });
        }
    }

    showProcessingAnimation(playerName, callback) {
        const modal = this.cache.processingModal;
        if (!modal) return;

        const titleEl = modal.querySelector('#processing-title');
        const progressBar = modal.querySelector('#processing-progress-bar');
        const statusText = modal.querySelector('#processing-status');

        titleEl.textContent = `Processing application for ${playerName}...`;
        progressBar.style.width = '0%';
        statusText.textContent = '';
        modal.classList.remove('hidden');

        setTimeout(() => {
            progressBar.style.width = '100%';
        }, 100);

        setTimeout(() => {
             statusText.textContent = 'Processing complete!';
            setTimeout(() => {
                this.hideModal('processing-modal');
                if (callback) callback();
            }, 1000);
        }, 4000);
    }

    createFloatingText(text, x, y, color = '#fde047') {
        const el = document.createElement('div');
        el.textContent = text;
        el.className = 'floating-text';
        el.style.left = `${x - 20}px`;
        el.style.top = `${y - 40}px`;
        el.style.color = color;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 2450);
    }

    showGraph(anchorEl, gameState) {
        this.activeGraphAnchor = anchorEl;
        const tooltip = this.cache.graphTooltip;
        const action = anchorEl.dataset.action;

        if (action === ACTION_IDS.SHOW_PRICE_GRAPH) {
            const goodId = anchorEl.dataset.goodId;
            const playerItem = gameState.player.inventories[gameState.player.activeShipId][goodId];
            tooltip.innerHTML = this._renderPriceGraph(goodId, gameState, playerItem);
        } else if (action === ACTION_IDS.SHOW_FINANCE_GRAPH) {
            tooltip.innerHTML = this._renderFinanceGraph(gameState);
        }

        tooltip.style.display = 'block';
        this.updateGraphTooltipPosition();
    }

    
     hideGraph() {
        if (this.activeGraphAnchor) {
            this.cache.graphTooltip.style.display = 'none';
            this.activeGraphAnchor = null;
        }
    }

    updateGraphTooltipPosition() {
        if (!this.activeGraphAnchor) return;
        const tooltip = this.cache.graphTooltip;
        if (tooltip.style.display === 'none') return;
        const rect = this.activeGraphAnchor.closest('.item-card-container').getBoundingClientRect();
        const tooltipHeight = tooltip.offsetHeight;

        let topPos = rect.top - tooltipHeight - 10;
        let leftPos = rect.left;

        if (topPos < 10) {
            topPos = rect.bottom + 10;
        }

        tooltip.style.left = `${leftPos}px`;
        tooltip.style.top = `${topPos}px`;
    }

    showGenericTooltip(anchorEl, content) {
        this.activeGenericTooltipAnchor = anchorEl;
        const tooltip = this.cache.genericTooltip;
        tooltip.innerHTML = content;
        tooltip.style.display = 'block';
        this.updateGenericTooltipPosition();
    }

    hideGenericTooltip() {
        if (this.activeGenericTooltipAnchor) {
            this.cache.genericTooltip.style.display = 'none';
            this.activeGenericTooltipAnchor = null;
        }
    }

    updateGenericTooltipPosition() {
        if (!this.activeGenericTooltipAnchor) return;
        const tooltip = this.cache.genericTooltip;
        const rect = this.activeGenericTooltipAnchor.getBoundingClientRect();
        const tooltipWidth = tooltip.offsetWidth;
        const tooltipHeight = tooltip.offsetHeight;
        let leftPos = rect.right + 10;
        let topPos = rect.top + (rect.height / 2) - (tooltipHeight / 2);
        if (topPos < 10) {
            topPos = rect.bottom + 10;
        }
        if (leftPos < 10) {
            leftPos = 10;
        }
        if (leftPos + tooltipWidth > window.innerWidth) {
            leftPos = window.innerWidth - tooltipWidth - 10;
        }

        tooltip.style.left = `${leftPos}px`;
        tooltip.style.top = `${topPos}px`;
    }

    _renderPriceGraph(goodId, gameState, playerItem) {
        const history = gameState.market.priceHistory[gameState.currentLocationId]?.[goodId];
        if (!history || history.length < 2) return `<div class="text-gray-400 text-sm p-4">No Data Available!</div>`;
        const good = DB.COMMODITIES.find(c => c.id === goodId);
        const staticAvg = (good.basePriceRange[0] + good.basePriceRange[1]) / 2;
        const width = 280, height = 140, padding = 35;
        const prices = history.map(p => p.price);
        const playerBuyPrice = playerItem?.avgCost > 0 ? playerItem.avgCost : null;

        let allValues = [...prices, staticAvg];
        if (playerBuyPrice) allValues.push(playerBuyPrice);
        const minVal = Math.min(...allValues), maxVal = Math.max(...allValues);
        const valueRange = maxVal - minVal > 0 ? maxVal - minVal : 1;

        const getX = i => (i / (history.length - 1)) * (width - padding * 2) + padding;
        const getY = v => height - padding - ((v - minVal) / valueRange) * (height - padding * 2.5);

        let svg = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="#0c101d" />`;
        svg += `<g class="grid-lines" stroke="#1f2937" stroke-width="1">`;
        svg += `<line x1="${padding}" y1="${getY(maxVal)}" x2="${padding}" y2="${height - padding}" /><line x1="${padding}" y1="${height - padding}" x2="${width - padding}" y2="${height - padding}" />`;
        svg += `</g>`;

        const staticAvgY = getY(staticAvg);
        svg += `<line x1="${padding}" y1="${staticAvgY}" x2="${width - padding}" y2="${staticAvgY}" stroke="#facc15" stroke-width="1" stroke-dasharray="3 3" />`;
        svg += `<text x="${width - padding + 4}" y="${staticAvgY + 3}" fill="#facc15" font-size="10" font-family="Roboto Mono" text-anchor="start">Avg: ${formatCredits(staticAvg, false)}</text>`;
        if (playerBuyPrice) {
             const buyPriceY = getY(playerBuyPrice);
            svg += `<line x1="${padding}" y1="${buyPriceY}" x2="${width - padding}" y2="${buyPriceY}" stroke="#34d399" stroke-width="1" stroke-dasharray="3 3" />`;
            svg += `<text x="${width - padding + 4}" y="${buyPriceY + 3}" fill="#34d399" font-size="10" font-family="Roboto Mono" text-anchor="start">Paid: ${formatCredits(playerBuyPrice, false)}</text>`;
        }

        const pricePoints = history.map((p, i) => `${getX(i)},${getY(p.price)}`).join(' ');
        svg += `<polyline fill="none" stroke="#60a5fa" stroke-width="2" points="${pricePoints}" />`;

        const firstDay = history[0].day;
        const lastDay = history[history.length - 1].day;
        svg += `<text x="${padding}" y="${height - padding + 15}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="start">Day ${firstDay}</text>`;
        svg += `<text x="${width - padding}" y="${height - padding + 15}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="end">Day ${lastDay}</text>`;
        svg += `<text x="${padding - 8}" y="${getY(minVal) + 3}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="end">${formatCredits(minVal, false)}</text>`;
        svg += `<text x="${padding - 8}" y="${getY(maxVal) + 3}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="end">${formatCredits(maxVal, false)}</text>`;
        svg += `</svg>`;
        return svg;
    }

    /**
     * Displays and positions the tutorial toast. Uses either percentage-based positioning
     * relative to an overlay or Popper.js for element anchoring.
     * @param {object} options - Configuration for the toast.
     * @param {object} options.step - The tutorial step data.
     * @param {function} options.onSkip - Callback for skip.
     * @param {function} options.onNext - Callback for next.
     * @param {object} options.gameState - The current game state.
     */
     showTutorialToast({ step, onSkip, onNext, gameState }) {
        const toast = this.cache.tutorialToastContainer;
        const arrow = toast.querySelector('#tt-arrow');
        // Use the new overlay if anchor is 'body', otherwise find the element
        const isOverlayAnchor = step.anchorElement === 'body';
        let referenceEl;
        
        if (isOverlayAnchor) {
            referenceEl = this.cache.tutorialAnchorOverlay; // Use the dedicated overlay
        } else {
            referenceEl = document.querySelector(step.anchorElement);
            if (!referenceEl) {
                 this.logger.error('TutorialService', `Anchor element "${step.anchorElement}" not found for step "${step.stepId}". Defaulting to overlay.`);
                referenceEl = this.cache.tutorialAnchorOverlay; // Fallback to overlay
                // TODO: Decide if we should force isOverlayAnchor = true here?
            }
        }
        
        // Cleanup existing Popper instance if any
        if (this.popperInstance) {
            this.popperInstance.destroy();
            this.popperInstance = null;
        }

         // --- Update Content ---
        let processedText = step.text;
        // b. Fix {shipName} replacement
        if (processedText.includes('{shipName}')) {
            const activeShipId = gameState.player.activeShipId;
            const shipName = activeShipId ? DB.SHIPS[activeShipId].name : 'your ship'; // Fallback
            processedText = processedText.replace(/{shipName}/g, shipName);
        }

        // c. Fix {playerName} replacement
        if (processedText.includes('{playerName}')) {
             const playerName = gameState.player.name || 'Captain'; // Fallback
            processedText = processedText.replace(/{playerName}/g, playerName);
        }

        this.cache.tutorialToastText.innerHTML = processedText;

        // --- Apply Size ---
        const initialWidth = step.size?.width || 'auto';
        const initialHeight = step.size?.height || 'auto';
        toast.style.width = initialWidth;
        toast.style.height = initialHeight;
        
        // --- Apply Position ---
        if (isOverlayAnchor) {
            // Percentage-based positioning
            const posX = step.positionX ?? 50; // Default to center
            const posY = step.positionY ?? 50; // Default to center
            toast.style.left = `${posX}%`;
            toast.style.top = `${posY}%`;
            // Ensure Popper-related styles/attributes are cleared/reset if switching modes
            toast.style.transform = 'translate(-50%, -50%)'; // Center element on the % point
            arrow.style.display = 'none'; // No arrow for overlay anchor
            toast.removeAttribute('data-popper-placement'); 
            
            // Note: No Popper instance created in this mode
        } else {
            // Element-anchored positioning using Popper.js
            toast.style.left = ''; // Clear direct styles
            toast.style.top = '';
            toast.style.transform = ''; // Clear direct transform
            
            arrow.style.display = 'block'; // Show arrow

             // Configure Popper.js
            const defaultOptions = { /* ... Popper defaults for element anchor ... */ 
                placement: 'auto',
                modifiers: [
                    { name: 'offset', options: { offset: [0, 10] } }, // Standard distance
                     { name: 'preventOverflow', options: { padding: { top: 60, bottom: 60, left: 10, right: 10 } } },
                    { name: 'flip', options: { fallbackPlacements: ['top', 'bottom', 'left', 'right'] } },
                    { name: 'arrow', options: { element: '#tt-arrow', padding: 5 } }
                ]
             };
            
             // Merge step-specific Popper options/modifiers
            const stepOffsetMod = step.popperOptions?.modifiers?.find(m => m.name === 'offset');
            let baseModifiers = defaultOptions.modifiers.filter(mod => mod.name !== 'offset'); 
            if (stepOffsetMod) {
                 baseModifiers.push(stepOffsetMod); 
            } else {
                 baseModifiers.push(defaultOptions.modifiers.find(m => m.name === 'offset')); 
            }
     
            if (step.popperOptions?.modifiers) { /* ... merge other modifiers ... */ }

             const finalOptions = {
                placement: step.placement || step.popperOptions?.placement || defaultOptions.placement,
                modifiers: baseModifiers
            };

            // Create Popper instance
            this.popperInstance = Popper.createPopper(referenceEl, toast, finalOptions);
        }

        // --- Show Toast & Configure Buttons ---
        toast.classList.remove('hidden');
        const isInfoStep = step.completion.type === 'INFO';
        this.cache.tutorialToastNextBtn.classList.toggle('hidden', !isInfoStep);
        if (isInfoStep) {
            this.cache.tutorialToastNextBtn.onclick = onNext;
        }
        const showSkipButton = false; // Configure as needed
        this.cache.tutorialToastSkipBtn.style.display = showSkipButton ? 'block' : 'none';
        this.cache.tutorialToastSkipBtn.onclick = onSkip;
        this.cache.tutorialToastText.scrollTop = 0;
        
        // --- Notify DebugService ---
        if (this.debugService) {
            this.debugService.setActiveTutorialStep(step); // Pass the raw step data
        }
    }


    /**
     * Hides the tutorial toast and destroys the associated Popper.js instance.
     */
    hideTutorialToast() {
        this.cache.tutorialToastContainer.classList.add('hidden');
        if (this.popperInstance) {
            this.popperInstance.destroy();
            this.popperInstance = null;
        }
        this.applyTutorialHighlight(null);
        
        // Notify DebugService
        if (this.debugService) {
            this.debugService.clearActiveTutorialStep();
        }
    }

    /**
     * Updates the active tutorial toast position and size in real-time based on debug controls.
     * Handles both percentage-based and Popper-based positioning.
     * @param {object} newOptions - Options from DebugService._handleTutorialTune
     * @param {boolean} newOptions.isOverlayAnchor - True if using percentage positioning.
     * @param {number} newOptions.width - New width (0 for 'auto').
     * @param {number} newOptions.height - New height (0 for 'auto').
     * @param {number} newOptions.percentX - New X percentage (0-100).
     * @param {number} newOptions.percentY - New Y percentage (0-100).
     * @param {string} newOptions.placement - New Popper placement.
     * @param {number} newOptions.distance - New Popper offset distance.
     * @param {number} newOptions.skidding - New Popper offset skidding.
     */
    updateTutorialPopper(newOptions) {
        const toast = this.cache.tutorialToastContainer;
        const arrow = toast.querySelector('#tt-arrow');
        const { isOverlayAnchor, width, height, percentX, percentY, placement, distance, skidding } = newOptions;

        // --- Apply Size (Common) ---
        // Apply size *first* so calculations are based on the new dimensions
        toast.style.width = width > 0 ? `${width}px` : 'auto';
        toast.style.height = height > 0 ? `${height}px` : 'auto';

        // --- Apply Position (Conditional) ---
        if (isOverlayAnchor) {
            // Using Percentage Positioning
            
        
             // Destroy Popper instance if it exists (switching modes)
            if (this.popperInstance) {
                this.popperInstance.destroy();
                this.popperInstance = null;
                 toast.removeAttribute('data-popper-placement'); 
                 toast.style.transform = ''; // Clear Popper transform
            }
            
            // Apply direct percentage styles
            toast.style.left = `${percentX}%`;
            toast.style.top = `${posY}%`;
            toast.style.transform = 'translate(-50%, -50%)'; // Re-apply centering transform
            arrow.style.display = 'none';

        } else {
            // Using Popper.js Positioning
            toast.style.left = ''; // Clear direct styles
            toast.style.top = ''; 
            toast.style.transform = ''; // Clear direct transform (Popper will add its own)
            arrow.style.display = 'block';

            const popperUpdateOptions = {
                 placement: placement,
                modifiers: [
                    { name: 'offset', options: { offset: [skidding, distance] } },
                    // Re-apply other essential modifiers for element anchoring
                    { name: 'preventOverflow', options: { padding: { top: 60, bottom: 60, left: 10, right: 10 } } },
                    { name: 'flip', options: { fallbackPlacements: ['top', 'bottom', 'left', 'right'] } },
                    { name: 'arrow', options: { element: '#tt-arrow', padding: 5 } }
                ]
            };

            if (this.popperInstance) {
                 // Update existing instance
                 this.popperInstance.setOptions(popperUpdateOptions).catch(e => {
                      this.logger.error('UIManager', 'Error updating Popper options:', e);
                 });
            } else {
                 // Need to create Popper instance if switching modes or first time
                 // This requires the original reference element, which isn't passed here.
                 // Ideally, the DebugService should trigger a full `showTutorialToast`
                 // when the anchor *type* changes, rather than just `updateTutorialPopper`.
                 // For now, we'll log a warning.
                 this.logger.warn('UIManager', 'Popper instance needed but not found during update. Re-trigger toast if anchor type changed.');
            }
        }
    }


    applyTutorialHighlight(highlightConfig) {
        this.activeHighlightConfig = highlightConfig;
        this._renderHighlightsFromConfig(this.activeHighlightConfig);
    }

     _renderHighlightsFromConfig(highlightConfig) {
        const overlay = this.cache.tutorialHighlightOverlay;
        if (!overlay) return;

        overlay.innerHTML = ''; // Clear previous highlights
        if (!highlightConfig) {
            overlay.classList.add('hidden');
            return;
        }

        overlay.classList.remove('hidden');

        highlightConfig.forEach(cue => {
            const el = document.createElement('div');
            el.className = 'tutorial-cue';
            el.style.left = `${cue.x}px`;
             el.style.top = `${cue.y}px`;
            el.style.width = `${cue.width}px`;
            el.style.height = `${cue.height}px`;
            el.style.transform = `rotate(${cue.rotation}deg)`;
            el.style.opacity = cue.style.opacity;

            if (cue.style.animation !== 'None') {
                el.classList.add(`anim-${cue.style.animation.toLowerCase()}`);
            }

             let content = '';
            if (cue.type === 'Shape') {
                content = `
                    <svg width="100%" height="100%" viewBox="0 0 ${cue.width} ${cue.height}" preserveAspectRatio="none" style="overflow: visible;">
                        ${cue.shapeType === 'Rectangle' ?
                             `<rect x="0" y="0" width="100%" height="100%" rx="${cue.style.borderRadius}" ry="${cue.style.borderRadius}" style="fill:${cue.style.fill}; stroke:${cue.style.stroke}; stroke-width:${cue.style.strokeWidth}px;" />` :
                            `<ellipse cx="50%" cy="50%" rx="50%" ry="50%" style="fill:${cue.style.fill}; stroke:${cue.style.stroke}; stroke-width:${cue.style.strokeWidth}px;" />`
                        }
                     </svg>`;
            } else if (cue.type === 'Arrow') {
                content = `
                    <svg width="100%" height="100%" viewBox="0 0 100 50" preserveAspectRatio="none" style="overflow: visible;">
                        <defs>
                             <marker id="arrowhead-player" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="${cue.style.stroke}" />
                            </marker>
                        </defs>
                         <line x1="0" y1="25" x2="90" y2="25" stroke="${cue.style.stroke}" stroke-width="${cue.style.strokeWidth}" marker-end="url(#arrowhead-player)" />
                    </svg>
                `;
            } else if (cue.type === 'Spotlight') {
                el.style.borderRadius = '50%';
                 el.style.boxShadow = `0 0 0 9999px rgba(0,0,0,0.7), 0 0 ${cue.style.glowIntensity || 20}px ${cue.style.glowIntensity || 10}px ${cue.style.glowColor || cue.style.stroke}`;
            }

            el.innerHTML = content;
            // Apply dynamic styles to the animated child, not the parent container
            const animatedChild = el.querySelector('svg');
            if (animatedChild && cue.style.animation !== 'None') {
                 animatedChild.classList.add(`anim-${cue.style.animation.toLowerCase()}`);
                 animatedChild.style.setProperty('--glow-color', cue.style.glowColor || cue.style.stroke);
                 animatedChild.style.setProperty('--anim-speed', `${cue.style.animationSpeed}s`);
                 animatedChild.style.setProperty('--glow-intensity', `${cue.style.glowIntensity}px`);
            }

            overlay.appendChild(el);
        });
    }

    showSkipTutorialModal(onConfirm) {
        const modal = this.cache.skipTutorialModal;
        modal.classList.remove('hidden');

        const confirmHandler = () => {
            onConfirm();
            this.hideModal('skip-tutorial-modal');
        };

        const cancelHandler = () => {
            this.hideModal('skip-tutorial-modal');
        };

        this.cache.skipTutorialConfirmBtn.onclick = confirmHandler;
        this.cache.skipTutorialCancelBtn.onclick = cancelHandler;
    }

    showTutorialLogModal({ seenBatches, onSelect }) {
        const logModal = document.getElementById('tutorial-log-modal');
        const list = document.getElementById('tutorial-log-list');

        if (!logModal || !list) {
            this.logger.error('UIManager', 'Tutorial log modal elements not found in DOM.');
            return;
        }

        list.innerHTML = '';

        if (seenBatches.length === 0) {
            list.innerHTML = `<li class="text-gray-400 p-2 text-center">No tutorials viewed yet.</li>`;
        } else {
            seenBatches.forEach(batchId => {
                const batchData = DB.TUTORIAL_DATA[batchId];
                if (batchData) {
                     const li = document.createElement('li');
                    li.innerHTML = `<button class="btn w-full text-center">${batchData.title}</button>`;
                    li.onclick = () => {
                        logModal.classList.remove('visible');
                        onSelect(batchId);
                     };
                    list.appendChild(li);
                }
            });
        }
        logModal.classList.add('visible');
    }

    showShipDetailModal(gameState, shipId, context) {
        const { player, tutorials } = gameState;
        const shipStatic = DB.SHIPS[shipId];
        let modalContentHtml;

        if (context === 'shipyard') {
             const canAfford = player.credits >= shipStatic.price;
            const isHangarTutStep1Active = tutorials.activeBatchId === 'intro_hangar' && tutorials.activeStepId === 'hangar_1';
            const isDisabled = !canAfford || isHangarTutStep1Active;
            modalContentHtml = `
                <div class="ship-card p-4 flex flex-col space-y-3">
                    <div class="flex justify-between items-start">
                        <div>
                             <h3 class="text-xl font-orbitron text-cyan-300">${shipStatic.name}</h3>
                            <p class="text-sm text-gray-400">Class ${shipStatic.class}</p>
                        </div>
                        <div class="text-right">
                             <p class="text-lg font-bold text-cyan-300">${formatCredits(shipStatic.price)}</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-400 flex-grow text-left">${shipStatic.lore}</p>
                    <div class="grid grid-cols-3 gap-x-4 text-sm font-roboto-mono text-center pt-2">
                        <div><span class="text-gray-500">Hull:</span> <span class="text-green-400">${shipStatic.maxHealth}</span></div>
                        <div><span class="text-gray-500">Fuel:</span> <span class="text-sky-400">${shipStatic.maxFuel}</span></div>
                        <div><span class="text-gray-500">Cargo:</span> <span class="text-amber-400">${shipStatic.cargoCapacity}</span></div>
                    </div>
                     <button class="btn w-full mt-2" data-action="${ACTION_IDS.BUY_SHIP}" data-ship-id="${shipId}" ${isDisabled ? 'disabled' : ''}>Purchase</button>
                </div>`;
        } else { // context === 'hangar'
            const shipDynamic = player.shipStates[shipId];
            const shipInventory = player.inventories[shipId];
            const cargoUsed = calculateInventoryUsed(shipInventory);
            const isActive = shipId === player.activeShipId;
            const canSell = player.ownedShipIds.length > 1 && !isActive;
            const salePrice = Math.floor(shipStatic.price * GAME_RULES.SHIP_SELL_MODIFIER);
            modalContentHtml = `
                <div class="ship-card p-4 flex flex-col space-y-3 ${isActive ? 'border-yellow-400' : ''}">
                    <h3 class="text-xl font-orbitron text-center ${isActive ? 'text-yellow-300' : 'text-cyan-300'}">${shipStatic.name}</h3>
                    <p class="text-sm text-gray-400 text-center">Class ${shipStatic.class}</p>
                    <p class="text-sm text-gray-400 flex-grow text-left my-2">${shipStatic.lore}</p>
                    <div class="grid grid-cols-3 gap-x-4 text-sm font-roboto-mono text-center pt-2">
                        <div><span class="text-gray-500">Hull</span><div class="text-green-400">${Math.floor(shipDynamic.health)}/${shipStatic.maxHealth}</div></div>
                        <div><span class="text-gray-500">Fuel</span><div class="text-sky-400">${Math.floor(shipDynamic.fuel)}/${shipStatic.maxFuel}</div></div>
                        <div><span class="text-gray-500">Cargo</span><div class="text-amber-400">${cargoUsed}/${shipStatic.cargoCapacity}</div></div>
                    </div>
                     <div class="grid grid-cols-2 gap-2 mt-2">
                        ${isActive ? '<button class="btn" disabled>ACTIVE</button>' : `<button class="btn" data-action="${ACTION_IDS.SELECT_SHIP}" data-ship-id="${shipId}">Board</button>`}
                        <button class="btn" data-action="${ACTION_IDS.SELL_SHIP}" data-ship-id="${shipId}" ${!canSell ? 'disabled' : ''}>Sell<br>⌬ ${formatCredits(salePrice, false)}</button>
                    </div>
                 </div>`;
        }

        const modal = this.cache.shipDetailModal;
        const modalContent = modal.querySelector('#ship-detail-content');
        modalContent.innerHTML = modalContentHtml;
        modal.classList.remove('hidden');
        modal.classList.add('modal-visible');
    }

    showLaunchModal(locationId) {
        const state = this.lastKnownState;
        if (!state) return;

        const location = DB.MARKETS.find(l => l.id === locationId);
        if (!location) return;

        const theme = location.navTheme;
        const travelInfo = state.TRAVEL_DATA[state.currentLocationId]?.[locationId];
        const shipState = state.player.shipStates[state.player.activeShipId];

        // If travel isn't possible from the current location, do nothing.
        if (!travelInfo) return;

        const modalContentHtml = `
            <div class="launch-modal-wrapper panel-border" style="background: ${theme.gradient}; color: ${theme.textColor}; border-color: ${theme.borderColor}; --theme-glow-color: ${theme.borderColor};">
                <div class="flex-shrink-0">
                    <h3 class="font-orbitron">${location.name}</h3>
                    <p class="flavor-text italic">${location.launchFlavor}</p>
                </div>

                <div class="flex-grow flex items-center justify-center">
                     <button class="btn-launch-glow" data-action="travel" data-location-id="${locationId}" style="--launch-glow-color: ${theme.borderColor};">Launch</button>
                </div>

                <div class="travel-info-text">
                    <p>Travel Time: ${travelInfo.time} Days</p>
                    <p>Fuel: ${Math.floor(shipState.fuel)} / ${travelInfo.fuelCost} required</p>
                </div>
            </div>`;

        const modal = this.cache.launchModal;
        this.cache.launchModalContent.innerHTML = modalContentHtml;
        modal.classList.remove('hidden');

        // Two-step render for the glow
        requestAnimationFrame(() => {
            modal.classList.add('modal-visible');
            const wrapper = modal.querySelector('.launch-modal-wrapper');
            if (wrapper) {
                requestAnimationFrame(() => {
                     wrapper.classList.add('is-glowing');
                });
            }
        });

        // Add a one-time click listener to the backdrop to close the modal.
        const closeHandler = (e) => {
            if (e.target.id === 'launch-modal') {
                this.hideModal('launch-modal');
                modal.removeEventListener('click', closeHandler);
            }
        };
        modal.addEventListener('click', closeHandler);
    }

    
     showCargoDetailModal(gameState, goodId) {
        const good = DB.COMMODITIES.find(c => c.id === goodId);
        const item = gameState.player.inventories[gameState.player.activeShipId]?.[goodId];

        if (!good || !item) return;

        // --- [[START]] VIRTUAL WORKBENCH ---
        // Refactor to use the queueModal system for standardized dismissal.
        this.queueModal('cargo-detail-modal', null, null, null, {
            // GDD-compliant dismissal: allow click inside or outside to close
            dismissInside: true,
            dismissOutside: true,
             footer: null, // No default buttons

            // Custom setup to inject the rendered cargo card
            customSetup: (modal, closeHandler) => {
                const modalContent = modal.querySelector('#cargo-detail-content');
                if (modalContent) {
                    modalContent.innerHTML = _renderMaxCargoModal(good, item);
                 }
            }
        });
        // --- [[END]] VIRTUAL WORKBENCH ---
    }

    /**
     * Finds the currently active carousel page element from the DOM.
     * @returns {HTMLElement | null} The .carousel-page element or null.
     * @private
     */
    _getActiveShipTerminalElement() {
        const state = this.lastKnownState; // Use lastKnownState for accuracy
        if (!state) return null;

        const hangarScreenEl = this.cache.hangarScreen;
        if (!hangarScreenEl) return null;

        const carousel = hangarScreenEl.querySelector('#hangar-carousel');
        if (!carousel) return null;

        const isHangarMode = state.uiState.hangarShipyardToggleState === 'hangar';
        const activeIndex = isHangarMode ? (state.uiState.hangarActiveIndex || 0) : (state.uiState.shipyardActiveIndex || 0);

        const pages = carousel.querySelectorAll('.carousel-page');
        const activePage = pages[activeIndex];
        return activePage ? activePage.querySelector('#ship-terminal') : null;
    }

    /**
     * Finds the correct DOM element for the active ship and runs a
     * blocking "dematerialize" animation on it.
     * @param {string} shipId - The ID of the ship, for logging.
     * @param {string} [animationClass='is-dematerializing'] - The CSS class to apply.
     * @returns {Promise<void>}
     * @JSDoc
     */
    async runShipTransactionAnimation(shipId, animationClass = 'is-dematerializing') {
        const elementToAnimate = this._getActiveShipTerminalElement();

        if (!elementToAnimate) {
            this.logger.warn('UIManager', `No element to animate for ${shipId}. Skipping animation.`);
            return; // Resolve immediately if no element
        }

        // Await the generic animation utility
        await playBlockingAnimation(elementToAnimate, animationClass);
    }

    renderStickyBar(gameState) {
        const stickyBarEl = this.cache.missionStickyBar;
        const contentEl = stickyBarEl.querySelector('.sticky-content');
        const objectiveTextEl = this.cache.stickyObjectiveText;
        const objectiveProgressEl = this.cache.stickyObjectiveProgress;

        if (gameState.missions.activeMissionId) {
            const mission = DB.MISSIONS[gameState.missions.activeMissionId];
            if (!mission.objectives || mission.objectives.length === 0) {
                stickyBarEl.style.display = 'none';
                return;
            }
            const progress = gameState.missions.missionProgress[mission.id] || { objectives: {} };

            const objective = mission.objectives[0];
            const current = progress.objectives[objective.goodId]?.current ?? 0;
            const target = objective.quantity;
            const goodName = DB.COMMODITIES.find(c => c.id === objective.goodId).name;
            const locationName = DB.MARKETS.find(m => m.id === mission.completion.locationId).name;

            objectiveTextEl.textContent = `Deliver ${goodName} to ${locationName}`;
            objectiveProgressEl.textContent = `[${current}/${target}]`;

            const hostClass = `host-${mission.host.toLowerCase().replace(/[^a-z0-N]/g, '')}`;
            let turnInClass = gameState.missions.activeMissionObjectivesMet && mission.completion.locationId === gameState.currentLocationId ? 'mission-turn-in' : '';
            contentEl.className = `sticky-content sci-fi-frame ${hostClass} ${turnInClass}`;

            stickyBarEl.style.display = 'block';
        } else {
            stickyBarEl.style.display = 'none';
        }
    }

    showMissionModal(missionId) {
        const mission = DB.MISSIONS[missionId];
        if (!mission) return;

        const { missions, currentLocationId } = this.lastKnownState;
        const { activeMissionId, activeMissionObjectivesMet } = missions;
        const isActive = activeMissionId === missionId;
        const canComplete = isActive && activeMissionObjectivesMet && mission.completion.locationId === currentLocationId;

        if (canComplete) {
            this._showMissionCompletionModal(mission);
        } else {
            this._showMissionDetailsModal(mission);
        }
    }

    _showMissionDetailsModal(mission) {
        const { missions, tutorials } = this.lastKnownState;
        const isActive = missions.activeMissionId === mission.id;
        const anotherMissionActive = missions.activeMissionId && !isActive;
        let shouldBeDisabled = anotherMissionActive;
        if (mission.id === 'mission_tutorial_02' && tutorials.activeBatchId === 'intro_missions' && tutorials.activeStepId !== 'mission_2_4') {
            shouldBeDisabled = true;
        }

        const options = {
            customSetup: (modal, closeHandler) => {
                const modalContent = modal.querySelector('.modal-content');
                modalContent.className = 'modal-content sci-fi-frame flex flex-col items-center text-center';
                const hostClass = `host-${mission.host.toLowerCase().replace(/[^a-z0-N]/g, '')}`;
                modalContent.classList.add(hostClass);

                modal.querySelector('#mission-modal-type').textContent = mission.type;

                const objectivesEl = modal.querySelector('#mission-modal-objectives');
                const objectivesHtml = '<h6 class="font-bold text-sm uppercase tracking-widest text-gray-400 text-center">OBJECTIVES:</h6><ul class="list-disc list-inside text-gray-300">' + mission.objectives.map(obj => `<li>Deliver ${obj.quantity}x ${DB.COMMODITIES.find(c => c.id === obj.goodId).name}</li>`).join('') + '</ul>';
                objectivesEl.innerHTML = objectivesHtml;
                objectivesEl.style.display = 'block';

                const rewardsEl = modal.querySelector('#mission-modal-rewards');
                if (mission.rewards && mission.rewards.length > 0) {
                    // --- VIRTUAL WORKBENCH START: Phase 6 ---
                     const rewardsHtml = mission.rewards.map(r => {
                        if(r.type === 'credits') return `<span class="credits-text-pulsing">${formatCredits(r.amount, true)}</span>`;
                        return r.type.toUpperCase();
                    }).join(', ');
                    // --- VIRTUAL WORKBENCH END: Phase 6 ---
                     rewardsEl.innerHTML = `<p class="font-roboto-mono text-sm text-gray-400 mb-1">REWARDS:</p><p class="font-orbitron text-xl text-yellow-300">${rewardsHtml}</p>`;
                    rewardsEl.style.display = 'block';
                } else {
                    rewardsEl.innerHTML = '';
                    rewardsEl.style.display = 'none';
                }

                const buttonsEl = modal.querySelector('#mission-modal-buttons');
                if (isActive) {
                    const isAbandonable = mission.isAbandonable !== false;
                    buttonsEl.innerHTML = `<button class="btn w-full bg-red-800/80 hover:bg-red-700/80 border-red-500" data-action="abandon-mission" data-mission-id="${mission.id}" ${!isAbandonable ? 'disabled' : ''}>Abandon Mission</button>`;
                } else {
                    buttonsEl.innerHTML = `<button class="btn w-full" data-action="accept-mission" data-mission-id="${mission.id}" ${shouldBeDisabled ? 'disabled' : ''}>Accept</button>`;
                }
            }
        };
        if (mission.id === 'mission_tutorial_01' && tutorials.activeStepId === 'mission_1_1') {
            shouldBeDisabled = true;
        }
        this.queueModal('mission-modal', mission.name, mission.description, null, options);
    }

    _showMissionCompletionModal(mission) {
         const options = {
            customSetup: (modal, closeHandler) => {
                const modalContent = modal.querySelector('.modal-content');
                modalContent.className = 'modal-content sci-fi-frame flex flex-col items-center text-center';
                const hostClass = `host-${mission.host.toLowerCase().replace(/[^a-z0-N]/g, '')}`;
                modalContent.classList.add(hostClass);

                modal.querySelector('#mission-modal-title').textContent = mission.completion.title;
                modal.querySelector('#mission-modal-type').textContent = "OBJECTIVES MET";
                modal.querySelector('#mission-modal-description').innerHTML = mission.completion.text;

                const objectivesEl = modal.querySelector('#mission-modal-objectives');
                objectivesEl.style.display = 'none';

                const rewardsEl = modal.querySelector('#mission-modal-rewards');
                if (mission.rewards && mission.rewards.length > 0) {
                    // --- VIRTUAL WORKBENCH START: Phase 6 ---
                    const rewardsHtml = mission.rewards.map(r => {
                        if(r.type === 'credits') return `<span class="credits-text-pulsing">${formatCredits(r.amount, true)}</span>`;
                        return r.type.toUpperCase();
                    }).join(', ');
                    // --- VIRTUAL WORKBENCH END: Phase 6 ---
                    rewardsEl.innerHTML = `<p class="font-roboto-mono text-sm text-gray-400 mb-1">REWARDS:</p><p class="font-orbitron text-xl text-green-300">${rewardsHtml}</p>`;
                    rewardsEl.style.display = 'block';
                } else {
                    rewardsEl.innerHTML = '';
                    rewardsEl.style.display = 'none';
                }

                const buttonsEl = modal.querySelector('#mission-modal-buttons');
                buttonsEl.innerHTML = `<button class="btn w-full btn-pulse-green" data-action="complete-mission" data-mission-id="${mission.id}">${mission.completion.buttonText}</button>`;
            }
        };
        this.queueModal('mission-modal', mission.completion.title, mission.completion.text, null, options);
    }

     flashObjectiveProgress() {
        const progressEl = this.cache.stickyObjectiveProgress;
        if (progressEl) {
            progressEl.classList.add('objective-progress-flash');
            setTimeout(() => {
                progressEl.classList.remove('objective-progress-flash');
            }, 700);
        }
    }

    // --- New DOM Abstraction Methods ---
    getModalIdFromEvent(e) {
        const modalBackdrop = e.target.closest('.modal-backdrop');
        if (!modalBackdrop || !modalBackdrop.id || modalBackdrop.classList.contains('dismiss-disabled')) {
            return null;
        }

        // --- VIRTUAL WORKBENCH: GDD DISMISSAL LOGIC ---
        const dismissInside = modalBackdrop.dataset.dismissInside === 'true';
        const dismissOutside = modalBackdrop.dataset.dismissOutside === 'true';
        const isBackdropClick = !e.target.closest('.modal-content');
        const isContentClick = e.target.closest('.modal-content');

        if ((dismissOutside && isBackdropClick) || (dismissInside && isContentClick)) {
             // Special case: Allow lore-modal to be dismissed by clicking content
             if (modalBackdrop.id === 'lore-modal' && e.target.closest('#lore-modal-content')) {
                 return modalBackdrop.id;
            }
            // [[START]] VIRTUAL WORKBENCH (EULA Dismissal)
            // Special case: Allow eula-modal to be dismissed by clicking content
            if (modalBackdrop.id === 'eula-modal' && e.target.closest('#eula-modal-content')) {
                return modalBackdrop.id;
            }
            // [[END]] VIRTUAL WORKBENCH (EULA Dismissal)


            // --- [[START]] VIRTUAL WORKBENCH: BUG FIX ---
            // The redundant checks for 'ship-info-modal' have been REMOVED.
            // Its dismissal is now handled *only* by the local closeHandler
            // in showShipInfoModal, just like lore-modal and eula-modal.

            // Standard dismissal (backdrop click only)
            // NOTE: 'ship-info-modal' is removed from this condition.
            if (modalBackdrop.id !== 'lore-modal' && modalBackdrop.id !== 'eula-modal' && !e.target.closest('.modal-content')) {
                return modalBackdrop.id;
            }
             // Standard dismissal for lore-modal (backdrop click only)
            if (modalBackdrop.id === 'lore-modal' && !e.target.closest('.modal-content')) {
                 return modalBackdrop.id;
            }
             // [[START]] VIRTUAL WORKBENCH (EULA Dismissal)
            // Standard dismissal for eula-modal (backdrop click only)
            if (modalBackdrop.id === 'eula-modal' && !e.target.closest('.modal-content')) {
                return modalBackdrop.id;
            }
            // [[END]] VIRTUAL WORKBENCH (EULA Dismissal)
            
            // --- [[END]] VIRTUAL WORKBENCH: BUG FIX ---

            // GDD-compliant dismissal
            return modalBackdrop.id;
        }
    
         // --- END VIRTUAL WORKBENCH ---

        return null;
    }

    isClickInside(e, selector) {
        return e.target.closest(selector) !== null;
    }

    getTooltipContent(e) {
        const tooltipTarget = e.target.closest('[data-tooltip]');
        if (tooltipTarget) {
            return tooltipTarget.dataset.tooltip;
        }
        return null;
    }

    showGameContainer() {
        this.cache.gameContainer.classList.remove('hidden');

        // Set height immediately on show
        this._setAppHeight();

        // Set height again on the next animation frame to catch the final, stable value
        requestAnimationFrame(() => {
            this._setAppHeight();
        });
    }

    /**
     * Shows the detail modal for a specific location on the map.
     * @param {string} locationId - The ID of the location to display details for.
     */
    showMapDetailModal(locationId) {
        const location = DB.MARKETS.find(l => l.id === locationId);
        if (!location) return;

        const modal = this.cache.mapDetailModal;
        const modalContent = modal.querySelector('.modal-content');
        const contentContainer = modal.querySelector('#map-modal-content-container');
        const theme = location.navTheme;

        // Apply theme styles
        modalContent.style.background = theme.gradient;
        modalContent.style.setProperty('--theme-glow-color', theme.borderColor);
        // --- VIRTUAL WORKBENCH: GDD MODAL THEME ---
        // Use the data-theme attribute for CSS-based glowing borders
        modal.dataset.theme = locationId;
        // --- END VIRTUAL WORKBENCH ---


        const imports = [];
        const exports = [];

        if (location.availabilityModifier) {
            for (const [commodityId, modifier] of Object.entries(location.availabilityModifier)) {
                 const commodity = DB.COMMODITIES.find(c => c.id === commodityId);
                if (commodity) {
                    const tag = {
                        name: commodity.name,
                        style: getCommodityStyle(commodity.styleClass)
                    };
                    if (modifier < 1.0) {
                        imports.push(tag);
                    } else if (modifier > 1.0) {
                        exports.push(tag);
                    }
                }
            }
        }

        const renderTags = (tagArray) => tagArray.map(tag =>
             `<span class="commodity-tag" style="border-color: ${tag.style.hex}; background-color: ${tag.style.hex}20; color: ${tag.style.hex};">${tag.name}</span>`
        ).join('');

        // *** MODIFIED HTML Structure to apply theme color ***
        // --- VIRTUAL WORKBENCH START: Phase 6 ---
        const contentHtml = `
            <div class="text-center">
                <h3 class="text-3xl font-orbitron" style="color: ${theme.textColor};">${location.name}</h3>
                 <p class="text-lg italic imprinted-text">${location.launchFlavor}</p>
            </div>

            <div class="my-4 space-y-3">
                <div class="map-intel-block">
                    <h5 class="font-bold imprinted-text" style="color: ${theme.textColor}; opacity: 0.7;">Fuel</h5>
                    <p class="font-roboto-mono imprinted-text-embedded"><span class="credits-text-pulsing">${formatCredits(location.fuelPrice, true)}</span>/unit</p>
                 </div>
                <div class="map-intel-block">
                    <h5 class="font-bold imprinted-text" style="color: ${theme.textColor}; opacity: 0.7;">Station Details</h5>
                    <p class="font-roboto-mono imprinted-text-embedded">${location.specialty || 'None reported'}</p>
                </div>
          </div>

            
             <div class="text-center">
                <div>
                    <h5 class="font-bold imprinted-text">Exports:</h5>
                    <div>${exports.length > 0 ? renderTags(exports) : '<span class="text-gray-400">CLASSIFIED</span>'}</div>
                </div>
                <div class="mt-2">
                     <h5 class."font-bold imprinted-text">Needs:</h5>
                    <div>${imports.length > 0 ? renderTags(imports) : '<span class="text-gray-400">CLASSIFIED</span>'}</div>
                </div>
            </div>
        `;
        // --- VIRTUAL WORKBENCH END: Phase 6 ---

        contentContainer.innerHTML = contentHtml;
        modal.classList.remove('hidden');
        modal.classList.remove('is-glowing');

        // Use requestAnimationFrame to ensure the browser has rendered the modal
             // before we add the class that triggers the animation.
        requestAnimationFrame(() => {
            modal.classList.add('modal-visible');
            modal.classList.add('is-glowing');
        });

        // *** MODIFIED: Combined backdrop and content click listeners ***
        const closeHandler = (e) => {
            // Close if clicking the backdrop OR the content area
            if (e.target.id === 'map-detail-modal' || e.target.closest('.modal-content')) {
                 this.hideMapDetailModal();
                modal.removeEventListener('click', closeHandler); // Ensure listener is removed
            }
        };
        // Add the listener *after* the modal is made visible
        requestAnimationFrame(() => {
             modal.addEventListener('click', closeHandler);
        });
    }


    hideMapDetailModal() {
        const modal = this.cache.mapDetailModal;
        if (modal) {
             modal.classList.remove('is-glowing');
            // --- VIRTUAL WORKBENCH: GDD MODAL THEME ---
            delete modal.dataset.theme; // Clear theme on close
            // --- END VIRTUAL WORKBENCH ---
            // Remove the specific click listener if it exists
            const existingHandler = modal.__mapDetailCloseHandler; 
            if(existingHandler) {
                modal.removeEventListener('click', existingHandler);
                delete modal.__mapDetailCloseHandler;
            }
    
         }
        this.hideModal('map-detail-modal');
    }

    // --- VIRTUAL WORKBENCH: ADD INTEL HANDLERS ---

    /**
     * Handles switching tabs on the Intel screen.
     * @param {HTMLElement} element - The clicked tab button.
     * @JSDoc
     */
    handleSetIntelTab(element) {
        const targetId = element.dataset.target;
        if (!targetId) return;

        // --- VIRTUAL WORKBENCH: REFACTOR FOR SLIDING ANIMATION ---
        // This function now just updates the state.
        // The actual DOM manipulation is handled by `updateIntelTab`.
        if (this.simulationService) {
            // --- VIRTUAL WORKBENCH: TYPO FIX ---
            // Corrected `setlntelTab` to `setIntelTab`
            this.simulationService.setIntelTab(targetId);
            // --- END VIRTUAL WORKBENCH ---
        }
        // --- END VIRTUAL WORKBENCH ---
    }

    /**
     * Surgically updates the Intel screen tabs to reflect the current state.
     * This is called on *every* render of the Intel screen to ensure
     * the visual state matches the game state, and to apply the
     * sliding animation class.
     * @param {string} activeTabId The ID of the active tab (e.g., 'intel-codex-content').
     * @JSDoc
     */
    updateIntelTab(activeTabId) {
        const screen = this.cache.intelScreen;
        if (!screen) return;
        
        const subNavBar = screen.querySelector('.sub-nav-bar');
        // --- VIRTUAL WORKBENCH: BUG FIX ---
        // Add guard clause to prevent error if subNavBar isn't rendered yet.
        if (!subNavBar) {
            // This can happen if the render loop runs before renderIntelScreen()
            // has populated the innerHTML.
            return; 
        }
        
        // --- END VIRTUAL WORKBENCH ---

        // Deactivate all
        screen.querySelectorAll('.sub-nav-button').forEach(btn => btn.classList.remove('active'));
        screen.querySelectorAll('.intel-tab-content').forEach(content => content.classList.remove('active'));
        // Activate the target tab and content
        const activeTabButton = screen.querySelector(`.sub-nav-button[data-target="${activeTabId}"]`);
        const activeContent = screen.querySelector(`#${activeTabId}`);

        if (activeTabButton) {
            activeTabButton.classList.add('active');
        }
  
         if (activeContent) {
            activeContent.classList.add('active');
        }

        // --- VIRTUAL WORKBENCH: SLIDING ANIMATION ---
        // Apply class to the bar itself for the CSS transition
        if (activeTabId === 'intel-market-content') {
            subNavBar.classList.add('market-active');
        } else {
            subNavBar.classList.remove('market-active');
        }
        // --- END VIRTUAL WORKBENCH ---
    }


    /**
     * Finds the specified intel packet from the game state.
     * @param {string} packetId 
     * @param {string} locationId 
     * @returns {object | null} The packet object or null if not found.
     * @private
     */
    _findIntelPacket(packetId, locationId) {
        const state = this.lastKnownState;
        // --- VIRTUAL WORKBENCH (Revert to universal logic) ---
        // A purchased packet might not be at the current locationId.
        // We must search all locations if it's a 'show_intel_details' call.
        if (state.intelMarket[locationId]) {
            const packet = state.intelMarket[locationId].find(p => p.id === packetId);
            if (packet) return packet;
        }

        // Fallback: Search all locations for the packet.
        // This is crucial for 'show_intel_details' of a purchased packet
        // when viewed from a different location.
        for (const locId of Object.keys(state.intelMarket)) {
            const packet = state.intelMarket[locId].find(p => p.id === packetId);
            if (packet) {
                 // this.logger.info('UIManager', `_findIntelPacket: Found packet ${packetId} at fallback location ${locId}`);
                return packet;
            }
        }
        
        // --- END VIRTUAL WORKBENCH ---

        this.logger.error('UIManager', `_findIntelPacket: Could not find packet ${packetId} anywhere.`);
        return null;
    }

    /**
     * Formats an intel "details" string, replacing all GDD placeholders.
     * @param {string} template - The template string from INTEL_CONTENT.
     * @param {object} packet - The intelPacket object.
     * @param {number} price - The calculated price.
     * @param {boolean} isNewFormat - Flag to determine which duration placeholder to use.
     * @returns {string} The formatted, player-facing string.
     * @private
     * @JSDoc
     */
    _formatIntelDetails(template, packet, price, isNewFormat) {
        // --- VIRTUAL WORKBENCH (C) ---
        // FIX: The "details" modal must show the DEAL location, not the SALE location.
        // `packet.locationId` is where it's sold. `packet.dealLocationId` is where the deal is.
        const locationName = DB.MARKETS.find(m => m.id === packet.dealLocationId)?.name || 'an unknown location';
        // --- END VIRTUAL WORKBENCH ---
        const commodityName = DB.COMMODITIES.find(c => c.id === packet.commodityId)?.name || 'a mystery commodity';
        const discountStr = `${Math.floor(packet.discountPercent * 100)}%`;
        
        // --- VIRTUAL WORKBENCH START: Phase 5/6 ---
        // The price for the placeholder is the *price paid*.
        // Use a fallback for legacy packets that may not have pricePaid.
        const priceStr = price ? formatCredits(-price, true) : '???';
        // --- VIRTUAL WORKBENCH END: Phase 5/6 ---


        // --- VIRTUAL WORKBENCH (Phase 4/5 Refactor) ---
        // Use packet.expiryDay (added in Phase 1)
        const currentDay = this.intelService.getCurrentDay();
        const remainingDays = Math.max(0, (packet.expiryDay || 0) - currentDay);
        
        let durationStr;
        if (remainingDays === 0) {
            durationStr = "less than a day";
        } else if (remainingDays === 1) {
            durationStr = "1 day";
        } else {
            durationStr = `${remainingDays} days`;
        }
        
        
        let result = template
             .replace(/\[location name\]/g, locationName)
            .replace(/\[commodity name\]/g, commodityName)
            .replace(/\[discount amount %\]/g, discountStr);
            // [Observed issue]: priceStr replacement is now conditional

        // --- VIRTUAL WORKBENCH (Revert Logic) ---
        // This logic handles both old save-game packets ("... [durationDays] days")
        // and new packets ("... in [durationDays].")
        result = result.replace(/\[durationDays\]\s*days/g, durationStr); // Handles old format
        result = result.replace(/\[durationDays\]/g, durationStr); // Handles new format
        // --- END VIRTUAL WORKBENCH ---
        
        // --- VIRTUAL WORKBENCH START: Phase 5/6 ---
        // Handle new packet format (with span)
        result = result.replace(/<span class="credits-text-pulsing">⌬ \[credit price\]<\/span>/g, `<span class="text-glow-red">${priceStr}</span>`);
        // Handle old packet format (no span, for save compatibility)
        result = result.replace(/\[⌬ credit price\]/g, `<span class="text-glow-red">${priceStr}</span>`);
        // --- VIRTUAL WORKBENCH END: Phase 5/6 ---

         return result;
    }

    /**
     * Shows the "Sample" modal (the offer) for an intel packet.
     * @param {HTMLElement} element - The clicked button element.
     * @JSDoc
     */
    handleShowIntelOffer(element) {
        const { packetId, locationId, price } = element.dataset;
        const packet = this._findIntelPacket(packetId, locationId);
        if (!packet) return;
        
        // --- VIRTUAL WORKBENCH (C) ---
        // The "sample" text should refer to the DEAL location, so the player
        // knows where the deal is before they buy.
        const locationName = DB.MARKETS.find(m => m.id === packet.dealLocationId)?.name || 'a distant market';
        // --- END VIRTUAL WORKBENCH ---
        

        // --- VIRTUAL WORKBENCH (Revert to universal logic) ---
        // Add save-game compatibility for old messageKey packets
        let msg;
        if (packet.messageKey) {
            // New universal system: Use messageKey
            msg = INTEL_CONTENT[packet.messageKey];
        } else if (packet.messageIndex !== undefined) {
             // Old location-based system: Use messageIndex (Save Game Compat)
            let msgArray = INTEL_CONTENT[packet.locationId]; // Use SALE location for message
            if (packet.fallbackMsg) { // Handle fallback packet
                msgArray = INTEL_CONTENT[packet.fallbackMsgSource];
            }
            if (!msgArray) {
                this.logger.warn('UIManager', `SaveCompat: No message array for ${packet.locationId}, using fallback.`);
                // This will likely fail as INTEL_CONTENT is no longer an array, but it's the best we can do.
                msgArray = INTEL_CONTENT["CORP_FAILURE_01"]; 
            }
            msg = msgArray ? msgArray[packet.messageIndex] : null;
        }

        const vagueText = (msg?.sample || "Intel available at [location name].")
            .replace('[location name]', locationName); // Always replace with DEAL location
        // --- END VIRTUAL WORKBENCH ---
        
        const priceNum = parseInt(price, 10);
        
        // --- VIRTUAL WORKBENCH START: Phase 5 ---
        const purchaseButtonHTML = `
            <button class="btn btn-module btn-module-credit" 
                    data-action="buy_intel" 
                    data-packet-id="${packet.id}" 
                    data-location-id="${locationId}" 
                     data-price="${priceNum}">
                Purchase Intel (<span class="credits-text-pulsing">${formatCredits(priceNum, true)}</span>)
            </button>`;
        // --- VIRTUAL WORKBENCH END: Phase 5 ---

        this.queueModal('event-modal', 'Intel Offer', vagueText, null, {
            theme: locationId, // GDD: Apply location-specific theme
            dismissOutside: true, // GDD: Allow dismissing outside
             footer: purchaseButtonHTML // GDD: Use custom footer
        });
    }

    /**
     * Handles the "buy_intel" action, calls the service, and shows the "Details" modal on success.
     * @param {HTMLElement} element - The clicked "Purchase Intel" button.
     * @param {Event} e - The click event (for floating text).
     * @JSDoc
     */
    handleBuyIntel(element, e) {
        // --- VIRTUAL WORKBENCH END: Phase 5 ---
        const { packetId, locationId, price } = element.dataset;
        const priceNum = parseInt(price, 10);
        // Call the service to perform the transaction
        const purchasedPacket = this.intelService.purchaseIntel(packetId, locationId, priceNum);

        if (purchasedPacket) {
            // GDD: On success, immediately close "Sample" modal and open "Details" modal
            this.hideModal('event-modal'); // Close the sample modal
            
            // --- VIRTUAL WORKBENCH START: Phase 5 ---
            // Add floating text
             if(e) {
                this.createFloatingText(`-${formatCredits(priceNum, false)}`, e.clientX, e.clientY, '#f87171');
            }
            // --- VIRTUAL WORKBENCH END: Phase 5 ---

            // Re-find the packet from the *new* state to ensure we have the purchased copy
            const updatedPacket = this._findIntelPacket(packetId, locationId);
            if (updatedPacket) {
                 // --- VIRTUAL WORKBENCH START: Phase 5 ---
                // Pass the *stored* pricePaid from the packet
                this._showIntelDetailsModal(updatedPacket, updatedPacket.pricePaid, locationId);
                // --- VIRTUAL WORKBENCH END: Phase 5 ---
            }

            // --- VIRTUAL WORKBENCH (B) ---
            /**
             * GDD: Rerender the screen to update button states (e.g., to "View Intel" and disabled)
             * * This manual render call is no longer needed. The setState() in
             * IntelService.js now triggers renderActiveScreen (via the main
             * UIManager.render() subscription), which surgically updates 
             * the market content without a full page reset.
             */
             // const intelScreen = document.getElementById('intel-screen');
            // const marketContentEl = intelScreen?.querySelector('#intel-market-content');
            // if (marketContentEl && this.intelMarketRenderer) {
            //     this.intelMarketRenderer.render(marketContentEl, this.lastKnownState);
            // }
            // --- END VIRTUAL WORKBENCH (B) ---
        } else {
            // Purchase failed (e.g., already active deal, not enough credits)
            // The service will log the error. We can optionally show a UI error here.
            this.hideModal('event-modal');
            this.queueModal('event-modal', 'Purchase Failed', 'Unable to purchase intel. You may already have an active deal or insufficient credits.');
        }
    }

    /**
     * Shows the "Details" modal for a purchased packet.
     * @param {HTMLElement} element - The clicked "View Intel" button.
     * @JSDoc
     */
    handleShowIntelDetails(element) {
        const { packetId, locationId } = element.dataset;
        const packet = this._findIntelPacket(packetId, locationId);
        if (!packet) return;

        // --- VIRTUAL WORKBENCH START: Phase 5 ---
        // Use the stored pricePaid if it exists, otherwise fall back to re-calculating
        const price = packet.pricePaid || this.intelService.calculateIntelPrice(packet);
        // --- VIRTUAL WORKBENCH END: Phase 5 ---

        // --- VIRTUAL WORKBENCH (Revert) ---
        // Pass the re-calculated price, as the price paid isn't stored on the button.
        this._showIntelDetailsModal(packet, price, locationId);
        // --- END VIRTUAL WORKBENCH ---
    }

    /**
     * Private helper to show the "Details" modal.
     * @param {object} packet - The intelPacket object.
     * @param {number} price - The price (either from purchase or re-calculated).
     * @param {string} locationId - The locationId for theming.
     * @private
     * @JSDoc
     */
    _showIntelDetailsModal(packet, price, locationId) {
        // --- VIRTUAL WORKBENCH (Revert to universal logic) ---
        // Add save-game compatibility logic
        let detailsTemplate;
        let isNewFormat = false; // Flag for durationDays logic

        if (packet.messageKey) {
            // New universal system: Use messageKey
             detailsTemplate = INTEL_CONTENT[packet.messageKey]?.details || "No details found.";
            isNewFormat = true; // New packets use the new duration placeholder
        } else if (packet.messageIndex !== undefined) {
            // Old location-based system: Use messageIndex (Save Game Compat)
            this.logger.warn('UIManager', `SaveCompat: Found old packet with messageIndex ${packet.messageIndex}`);
            // This packet is from a save file that used the location-based array.
            // We can't recover it, so show a generic message.
            detailsTemplate = "Details for this expired intel packet are no longer available in the new system.";
        } else {
            // This handles the *original* 2-message system, if a save is that old.
            const originalContent = {
                "CORPORATE_LIQUIDATION": { "details": "PACKET DECRYPTED: A [commodity name] surplus at [location name] allows for purchase at [discount amount %] below galactic average. This price is locked for [durationDays] days. A minor Corporate State is quietly liquidating assets to meet quarterly quotas. This is a standard, low-risk procurement opportunity. This intel was secured for [⌬ credit price]." },
                 "SUPPLY_CHAIN_DISRUPTION": { "details": "DATA UNLOCKED: [commodity name] is available at [location name] for [discount amount %] off standard pricing. This window is open for [durationDays] days. A Merchant's Guild freighter was damaged, forcing them to offload their cargo here at a loss. Their misfortune is your gain. This access was [⌬ credit price]." }
            };
            detailsTemplate = originalContent[packet.messageKey]?.details || "Packet is corrupted. No message data found.";
        }

        const formattedDetails = this._formatIntelDetails(detailsTemplate, packet, price, isNewFormat);
        // --- END VIRTUAL WORKBENCH ---

        this.queueModal('event-modal', 'Intel Unlocked', formattedDetails, null, {
            theme: locationId, // GDD: Apply location-specific theme
            dismissInside: true, // GDD: Dismiss on *any* click
            dismissOutside: true,
            footer: null, // GDD: No buttons
            contentClass: 'text-left' // GDD: Details are paragraphs
        });
    }

   
     // --- END VIRTUAL WORKBENCH ---

    // MODIFIED: Removed obsolete _bindScreenSpecificEvents method
}
--- END OF FILE: ./js/services/UIManager.js ---

--- START OF FILE: ./js/services/bot/AutomatedPlayerService.js ---
// js/services/bot/AutomatedPlayerService.js
/**
 * @fileoverview This file contains the AutomatedPlayer class.
 * This bot is designed to stress-test the in-game economy by simulating
 * an advanced player who actively participates in market manipulation.
 * It operates as a state machine, forming long-term plans to crash
 * markets and exploit those self-created opportunities.
 */
import { DB } from '../../data/database.js';
import { GAME_RULES, LOCATION_IDS, PERK_IDS } from '../../data/constants.js';
import { calculateInventoryUsed, formatCredits } from '../../utils.js';

/**
 * Defines the operational states for the bot's state machine.
 * @enum {string}
 */
const BotState = {
    IDLE: 'IDLE',                                 // Bot is deciding what to do next.
    MAINTENANCE: 'MAINTENANCE',                   // Bot is refueling or repairing.
    SELLING_HELD_CARGO: 'SELLING_HELD_CARGO',     // Bot is selling cargo it's already holding.
    SEEKING_MANIPULATION: 'SEEKING_MANIPULATION', // Bot is actively looking for a new market to crash.
    PREPARING_CRASH: 'PREPARING_CRASH',           // Bot is traveling and buying goods in preparation for a crash.
    EXECUTING_CRASH: 'EXECUTING_CRASH',           // Bot is at the target market, selling goods to crash the price.
    EXECUTING_EXPLOIT: 'EXECUTING_EXPLOIT',       // Bot is exploiting a known crashed market (self-created or found).
    SELLING_EXPLOITED_GOODS: 'SELLING_EXPLOITED_GOODS', // Bot is selling goods bought at an exploited price.
    TIME_WASTER: 'TIME_WASTER',                   // Bot is running a simple A-B trade to pass time.
    
    // Depletion Strategy States
    SEEKING_DEPLETION: 'SEEKING_DEPLETION',       // Bot is looking for a market to buy out.
    EXECUTING_DEPLETION: 'EXECUTING_DEPLETION',   // Bot is traveling to and buying out the market.
    WAITING_FOR_HIKE: 'WAITING_FOR_HIKE',         // Bot is passing time for the price hike to activate.
    EXPLOITING_HIKE: 'EXPLOITING_HIKE'            // Bot is buying from elsewhere to sell at the hiked price.
};

/**
 * Defines the bot's overarching strategy for a simulation run.
 * @enum {string}
 */
const BotStrategy = {
    MIXED: 'MIXED',               // Default: 75% Crash, 25% Depletion
    HONEST_TRADER: 'HONEST_TRADER', // Only runs simple A-B trades (TIME_WASTER state)
    MANIPULATOR: 'MANIPULATOR',   // Only runs the Crash/Exploit loop
    DEPLETE_ONLY: 'DEPLETE_ONLY',    // Only runs the Depletion/Exploit loop
    PROSPECTOR: 'PROSPECTOR'      // Tries Honest Trader first, falls back to Manipulator
};


/**
 * @class AutomatedPlayer
 * @description A state-driven bot that plays the game to stress-test the economy.
 */
export class AutomatedPlayer {
    /**
     * @param {import('../GameState.js').GameState} gameState The central game state object.
     * @param {import('../SimulationService.js').SimulationService} simulationService The core game logic engine.
     * @param {import('../LoggingService.js').Logger} logger The logging utility.
     */
    constructor(gameState, simulationService, logger) {
        this.gameState = gameState;
        this.simulationService = simulationService;
        this.logger = logger;

        this.isRunning = false;
        this.stopRequested = false;
        this.botState = BotState.IDLE;
        this.activeStrategy = BotStrategy.MIXED; // Default strategy
        this.MIN_PROFIT_MARGIN = 0.15; // PHASE 2: 15% minimum profit margin

        /**
         * @type {object | null}
         * @description Stores the bot's multi-step objective.
         * Example:
         * {
         * type: 'CRASH',
         * goodId: 'plasteel',
         * buyFromLocationId: 'moon', // Location B (prep)
         * crashLocationId: 'mars'  // Location A (crash)
         * }
         * {
         * type: 'REFUEL_FOR_TRAVEL',
         * needed: 350,
         * nextState: BotState.PREPARING_CRASH,
         * originalObjective: { ... }
         * }
         */
        this.currentObjective = null;

        /**
         * @type {Array<object>}
         * @description The bot's "memory" of markets it has crashed.
         * Example: { goodId: 'plasteel', locationId: 'mars', priceLockEndDay: 450 }
         */
        this.plannedObjectives = [];
        
        /**
         * @type {object}
         * @description Tracks performance metrics for the summary report.
         */
        this.metrics = {
            totalTrades: 0,
            profitableTrades: 0,
            totalNetProfit: 0,
            totalFuelCost: 0,
            totalRepairCost: 0,
            daysSimulated: 0,
            profitByGood: {},
            objectivesStarted: 0,
            objectivesCompleted: 0,
            objectivesAborted: 0,
            strategyUsed: BotStrategy.MIXED
        };
        /** @type {number} */
        this.simulationStartDay = 0;
    }

    /**
     * Starts the automated play simulation.
     * @param {object} config - Configuration for the simulation run.
     * @param {number} config.daysToRun - The number of in-game days to simulate.
     * @param {string} [config.strategy] - The strategy for the bot to use.
     * @param {function} updateCallback - A function to call with progress updates.
     */
    async runSimulation({ daysToRun, strategy }, updateCallback) {
        if (this.isRunning) {
            this.logger.warn('Bot', 'AUTOTRADER-01 is already running.');
            return;
        }

        this.isRunning = true;
        this.stopRequested = false;
        this.botState = BotState.IDLE;
        this.activeStrategy = strategy || BotStrategy.MIXED; // Set strategy for this run
        const startDay = this.gameState.day;
        const endDay = startDay + daysToRun;
        
        // Reset metrics for new run
        this.simulationStartDay = startDay;
        this.metrics = {
            totalTrades: 0,
            profitableTrades: 0,
            totalNetProfit: 0,
            totalFuelCost: 0,
            totalRepairCost: 0,
            daysSimulated: 0,
            profitByGood: {},
            objectivesStarted: 0,
            objectivesCompleted: 0,
            objectivesAborted: 0,
            strategyUsed: this.activeStrategy
        };

        this.logger.info.system('Bot', startDay, 'SIMULATION_START', `Starting advanced simulation for ${daysToRun} days using strategy: ${this.activeStrategy}.`);

        while (this.gameState.day < endDay && !this.stopRequested) {
            // --- 1. Execute State Logic ---
            await this._decideNextAction();

            // --- 2. Update UI & Pause ---
            updateCallback(this.gameState.day, endDay);
            await new Promise(resolve => setTimeout(resolve, 10)); // Tiny pause
        }

        // --- 3. Log Summary Report ---
        this._logSummaryReport();
        
        this.logger.info.system('Bot', this.gameState.day, 'SIMULATION_END', 'Simulation finished.');
        this.isRunning = false;
    }

    /**
     * Stops the currently running simulation.
     */
    stop() {
        this.stopRequested = true;
    }

    // --- STATE MACHINE & CORE LOGIC ---

    /**
     * The main state machine switch. Directs the bot's actions.
     * @private
     */
    async _decideNextAction() {
        // --- 0. Handle Popup Modals (like Age Events) ---
        if (this._handleAgeEventChoice()) {
            return; // An event was handled, stop this tick
        }

        // --- 1. Handle Proactive Maintenance ---
        // This check runs *before* the state switch to interrupt any state
        // if maintenance becomes necessary.
        // It does NOT catch "stranded" scenarios, which are handled by pre-flight checks.
        if (this.botState !== BotState.MAINTENANCE && 
            (!this.currentObjective || this.currentObjective.type !== 'REFUEL_FOR_TRAVEL') &&
            this._needsMaintenance()) {
            this.logger.info.system('Bot', this.gameState.day, 'MAINTENANCE', 'Low resources detected. Switching to maintenance state.');
            this.botState = BotState.MAINTENANCE;
        }

        // --- 2. Execute State Logic ---
        switch (this.botState) {
            case BotState.IDLE:
                await this._evaluateOpportunities();
                break;
            case BotState.MAINTENANCE:
                await this._executeMaintenance();
                break;
            case BotState.SELLING_HELD_CARGO:
                await this._executeSellHeldCargo();
                break;
            case BotState.SEEKING_MANIPULATION:
                await this._findCrashOpportunity();
                break;
            case BotState.PREPARING_CRASH:
                await this._executePreparation();
                break;
            case BotState.EXECUTING_CRASH:
                await this._executeCrash();
                break;
            case BotState.EXECUTING_EXPLOIT:
                await this._executeExploit();
                break;
            case BotState.SELLING_EXPLOITED_GOODS:
                await this._executeSellExploited();
                break;
            case BotState.TIME_WASTER:
                await this._executeTimeWaster();
                break;
            
            // Depletion Strategy
            case BotState.SEEKING_DEPLETION:
                await this._findDepletionOpportunity();
                break;
            case BotState.EXECUTING_DEPLETION:
                await this._executeDepletion();
                break;
            case BotState.WAITING_FOR_HIKE:
                await this._executeWait();
                break;
            case BotState.EXPLOITING_HIKE:
                await this._executeExploitHike();
                break;
        }
    }

    /**
     * [State: IDLE]
     * Bot decides what to do based on its active strategy.
     * @private
     */
    async _evaluateOpportunities() {
        // --- PHASE 1 REFACTOR: Prioritize selling held cargo ---
        const heldCargoTrade = this._findBestSellLocationForHeldCargo();
        if (heldCargoTrade) {
            this.currentObjective = {
                type: 'SELL_HELD_CARGO',
                ...heldCargoTrade
            };
            this.botState = BotState.SELLING_HELD_CARGO;
            this.logger.info.system('Bot', this.gameState.day, 'OBJECTIVE', `[HELD CARGO]: Found profitable sale for ${heldCargoTrade.quantity}x ${heldCargoTrade.goodId} @ ${heldCargoTrade.sellLocationId}. Profit: ${formatCredits(heldCargoTrade.estimatedProfit)}.`);
            this.metrics.objectivesStarted++;
            return;
        }
        // --- END REFACTOR ---

        // 1. Check for ready-to-exploit self-crashed markets
        // (Only if strategy allows manipulation)
        if (this.activeStrategy === BotStrategy.MIXED || this.activeStrategy === BotStrategy.MANIPULATOR) {
            const exploit = this._findReadySelfExploit();
            if (exploit) {
                this.currentObjective = exploit;
                this.botState = BotState.EXECUTING_EXPLOIT;
                this.logger.info.system('Bot', this.gameState.day, 'OBJECTIVE', `Found self-created exploit: Buy ${exploit.goodId} @ ${exploit.exploitLocationId}`);
                this.metrics.objectivesStarted++;
                return;
            }
        }

        // 2. Check for persistent objective
        if (this.currentObjective) {
            // Check if the old plan is still valid
            if (this.currentObjective.type === 'CRASH' && this._isCrashPlanStillValid()) {
                // Stick to the plan
                this.botState = BotState.PREPARING_CRASH;
                this.logger.info.system('Bot', this.gameState.day, 'OBJECTIVE', `Continuing persistent CRASH loop for ${this.currentObjective.goodId}.`);
                // Note: This is a continuation, not a new objective
                return;
            } else if (this.currentObjective.type !== 'CRASH' && this.currentObjective.type !== 'SIMPLE_TRADE') {
                // This means we just finished an EXPLOIT or SELL_EXPLOITED
                // We need to re-validate the original crash plan
                const goodIdToRevalidate = this.currentObjective.goodId; // Store goodId
                
                // --- PHASE 1 FIX: Check that the returned plan is fully valid ---
                const validPlan = this._findCrashOpportunity(goodIdToRevalidate);
                
                // Check for a complete, valid plan object, not just a truthy value.
                if (validPlan && validPlan.goodId && validPlan.buyFromLocationId && validPlan.crashLocationId) {
                    this.logger.info.system('Bot', this.gameState.day, 'OBJECTIVE', `Re-validating and repeating CRASH loop for ${validPlan.goodId}.`);
                    this.currentObjective = validPlan;
                    this.botState = BotState.PREPARING_CRASH;
                    this.metrics.objectivesStarted++;
                    return;
                } else {
                     this.logger.info.system('Bot', this.gameState.day, 'OBJECTIVE', `Failed to re-validate loop for ${goodIdToRevalidate}. Plan is no longer viable.`);
                     // Do not proceed, fall through to finding a new objective
                }
                // --- END FIX ---
            }
        }
        
        // 3. No exploit and no valid persistent plan, find a new one based on strategy.
        this.currentObjective = null;

        switch (this.activeStrategy) {
            case BotStrategy.HONEST_TRADER:
                this.botState = BotState.TIME_WASTER; // Will find a *new* simple trade
                this.logger.info.system('Bot', this.gameState.day, 'OBJECTIVE', 'Strategy: HONEST_TRADER. Seeking simple trade.');
                break;
            
            case BotStrategy.MANIPULATOR:
                this.botState = BotState.SEEKING_MANIPULATION;
                this.logger.info.system('Bot', this.gameState.day, 'OBJECTIVE', 'Strategy: MANIPULATOR. Seeking new market crash opportunity.');
                break;
            
            case BotStrategy.DEPLETE_ONLY:
                this.botState = BotState.SEEKING_DEPLETION;
                this.logger.info.system('Bot', this.gameState.day, 'OBJECTIVE', 'Strategy: DEPLETE_ONLY. Seeking new depletion opportunity.');
                break;
            
            case BotStrategy.PROSPECTOR:
                const simpleTrade = this._findBestSimpleTrade();
                if (simpleTrade) {
                    this.currentObjective = { ...simpleTrade, type: 'SIMPLE_TRADE', hasGoods: false };
                    this.botState = BotState.TIME_WASTER;
                    this.metrics.objectivesStarted++;
                    // --- PHASE 3 LOGGING ---
                    this.logger.info.system('Bot', this.gameState.day, 'OBJECTIVE', `[PROSPECTOR]: Found simple trade. Buy ${simpleTrade.goodId} @ ${simpleTrade.buyLocationId} -> Sell @ ${simpleTrade.sellLocationId}. Margin: ${(simpleTrade.profitPerUnit / simpleTrade.buyPrice * 100).toFixed(1)}%. Est. PPD: ${formatCredits(simpleTrade.estimatedPPD)}.`);
                } else {
                    // --- PHASE 3 LOGGING ---
                    this.logger.info.system('Bot', this.gameState.day, 'OBJECTIVE', `[PROSPECTOR]: No simple trades found meeting ${this.MIN_PROFIT_MARGIN * 100}% margin. Falling back to manipulation.`);
                    this.botState = BotState.SEEKING_MANIPULATION;
                }
                break;
            
            case BotStrategy.MIXED:
            default:
                // 25% chance to try the Depletion strategy
                if (Math.random() < 0.25) {
                    this.botState = BotState.SEEKING_DEPLETION;
                    this.logger.info.system('Bot', this.gameState.day, 'OBJECTIVE', 'Strategy: MIXED. Seeking new depletion opportunity.');
                } else {
                    // 75% chance to try the standard Crash strategy
                    this.botState = BotState.SEEKING_MANIPULATION;
                    this.logger.info.system('Bot', this.gameState.day, 'OBJECTIVE', `Strategy: MIXED. Seeking new market crash opportunity.`);
                }
                break;
        }
    }

    /**
     * [State: MAINTENANCE]
     * Bot travels to specific locations to refuel (Jupiter) or repair (Luna).
     * Handles both general low-resource maintenance and specific "stranded" refueling.
     * @private
     */
    async _executeMaintenance() {
        const activeShip = this.simulationService._getActiveShip();
        if (!activeShip) {
            this.botState = BotState.IDLE; // No ship to maintain
            return;
        }
        const shipState = this.gameState.player.shipStates[activeShip.id];

        // --- Priority 1: Handle "Stranded" Refuel Objective ---
        if (this.currentObjective && this.currentObjective.type === 'REFUEL_FOR_TRAVEL') {
            const { needed, nextState, originalObjective } = this.currentObjective;

            // Check if the 'needed' fuel is impossible for this ship to hold.
            // This breaks the infinite loop seen in the log (needed: 10004, max: 600).
            if (needed > activeShip.maxFuel && shipState.fuel === activeShip.maxFuel) {
                this.logger.error('Bot', `MAINTENANCE_FAIL: Objective requires ${needed} fuel, but ship max is ${activeShip.maxFuel}. Ship is full. Aborting objective to prevent loop.`);
                this.currentObjective = null; // Clear the impossible objective
                this.botState = BotState.IDLE; // Go back to deciding what to do
                this.metrics.objectivesAborted++; // Track failure
                return;
            }

            if (shipState.fuel < needed) {
                this.logger.info.system('Bot', this.gameState.day, 'MAINTENANCE', `Executing local refuel to get ${needed} fuel.`);
                // This calls the "stranded" logic: buy expensive local fuel
                // to meet the specific 'needed' amount.
                this._botRefuel(needed); 
                return; // Wait for next tick to re-check
            } else {
                // Success! We have enough fuel.
                this.logger.info.system('Bot', this.gameState.day, 'MAINTENANCE', 'Local refuel complete. Resuming original objective.');
                this.currentObjective = originalObjective; // Restore original plan
                this.botState = nextState; // Go back to the state we were in
                return;
            }
        }

        // --- Priority 2: General Low Resources ---
        const fuelPct = (shipState.fuel / activeShip.maxFuel) * 100;
        const healthPct = (shipState.health / activeShip.maxHealth) * 100;

        // General Low Fuel
        if (fuelPct < 30) {
            if (this.gameState.currentLocationId === LOCATION_IDS.JUPITER) {
                // We are at the cheap spot, fill 'er up
                this.logger.info.system('Bot', this.gameState.day, 'MAINTENANCE', 'Arrived at Jupiter. Refueling.');
                this._botRefuel(activeShip.maxFuel); // Pass maxFuel to ensure a full tank
            } else {
                // We are not at Jupiter. Check if we can get there.
                const state = this.gameState.getState();
                const travelInfo = state.TRAVEL_DATA[state.currentLocationId][LOCATION_IDS.JUPITER];
                const fuelToJupiter = travelInfo ? (travelInfo.fuelCost || 0) : 9999;
                
                if (shipState.fuel < fuelToJupiter) {
                    // STRANDED: Buy just enough local fuel to get to Jupiter
                    this.logger.warn('Bot', `Stranded at ${state.currentLocationId}. Buying expensive local fuel just to reach Jupiter.`);
                    this._botRefuel(fuelToJupiter + 5); // Buy just enough + a small buffer
                } else {
                    // We have enough fuel to make the trip.
                    this.logger.info.system('Bot', this.gameState.day, 'MAINTENANCE', `Fuel ${fuelPct.toFixed(0)}%. Traveling to Jupiter.`);
                    this.simulationService.travelService.initiateTravel(LOCATION_IDS.JUPITER);
                }
            }
            return; // Handle one maintenance task at a time
        }

        // General Low Health
        if (healthPct < 30) {
            if (this.gameState.currentLocationId !== LOCATION_IDS.LUNA) {
                this.logger.info.system('Bot', this.gameState.day, 'MAINTENANCE', `Hull ${healthPct.toFixed(0)}%. Traveling to Luna.`);
                this.simulationService.travelService.initiateTravel(LOCATION_IDS.LUNA);
            } else {
                this.logger.info.system('Bot', this.gameState.day, 'MAINTENANCE', 'Arrived at Luna. Repairing.');
                this._botRepair();
            }
            return;
        }

        // If both are fine, maintenance is done.
        this.logger.info.system('Bot', this.gameState.day, 'MAINTENANCE', 'Maintenance complete. Resuming operations.');
        this.botState = BotState.IDLE;
    }


    /**
     * [State: SELLING_HELD_CARGO]
     * Bot travels to the best sell location and sells its cargo.
     * @private
     */
    async _executeSellHeldCargo() {
        const { goodId, sellLocationId, quantity } = this.currentObjective;
        const state = this.gameState.getState();
        const activeShip = this.simulationService._getActiveShip();

        // 1. Travel to sell location
        if (state.currentLocationId !== sellLocationId) {
            // --- PHASE 3 LOGGING ---
            this.logger.info.system('Bot', state.day, 'SELL_HELD', `Traveling to ${sellLocationId} to sell ${quantity}x ${goodId}`);

            // --- Pre-flight check ---
            const travelInfo = state.TRAVEL_DATA[state.currentLocationId][sellLocationId];
            const requiredFuel = travelInfo ? (travelInfo.fuelCost || 0) : 9999;
            
            if (activeShip.fuel < requiredFuel) {
                this.logger.warn('Bot', `SELL_HELD_FAIL: Not enough fuel (${activeShip.fuel}) to travel to ${sellLocationId} (needs ${requiredFuel}). Forcing maintenance.`);
                // --- FIX: Create a temporary REFUEL objective to break loop ---
                const originalObjective = this.currentObjective;
                this.currentObjective = {
                    type: 'REFUEL_FOR_TRAVEL',
                    needed: requiredFuel + 5, // Add 5 fuel buffer
                    nextState: BotState.SELLING_HELD_CARGO, // State to return to
                    originalObjective: originalObjective // The plan to resume
                };
                this.botState = BotState.MAINTENANCE; 
                return;
            }
            // --- End Fix ---

            this.simulationService.travelService.initiateTravel(sellLocationId);
            return;
        }

        // 2. Sell entire cargo
        const sellQty = this.simulationService._getActiveInventory()[goodId]?.quantity || 0;
        if (sellQty > 0) {
            const avgCost = this.simulationService._getActiveInventory()[goodId]?.avgCost || 0;
            const saleValue = this.simulationService.playerActionService.sellItem(goodId, sellQty);
            const profit = saleValue - (avgCost * sellQty);

            // --- PHASE 3 LOGGING ---
            this.logger.info.system('Bot', state.day, 'SELL_HELD_SELL', `Sold ${sellQty}x ${goodId}. Profit: ${formatCredits(profit)}`);
            this.metrics.totalTrades++;
            this.metrics.totalNetProfit += profit;
            if (profit > 0) this.metrics.profitableTrades++;

            // Track profit by good
            if (!this.metrics.profitByGood[goodId]) { this.metrics.profitByGood[goodId] = 0; }
            this.metrics.profitByGood[goodId] += profit;
            
            this.metrics.objectivesCompleted++;
        } else {
             // --- PHASE 3 LOGGING ---
            this.logger.warn('Bot', `SELL_HELD_FAIL: Arrived at ${sellLocationId} but have no ${goodId} to sell.`);
             this.metrics.objectivesAborted++;
        }

        // 3. Loop is complete. Go IDLE to re-evaluate.
        this.currentObjective = null;
        this.botState = BotState.IDLE;
    }

    /**
     * [State: SEEKING_MANIPULATION]
     * Bot scans for the top 5 crash plans and picks one.
     * @param {string|null} [specificGoodId=null] - If provided, only finds plans for this good.
     * @returns {object|null} A chosen plan, or null.
     * @private
     */
    async _findCrashOpportunity(specificGoodId = null) {
        const state = this.gameState.getState();
        let availableCommodities = DB.COMMODITIES.filter(c => c.tier <= state.player.revealedTier && c.tier > 1); // Ignore T1
        
        if (specificGoodId) {
            availableCommodities = availableCommodities.filter(c => c.id === specificGoodId);
        }

        if (availableCommodities.length === 0) {
            if (!specificGoodId) this.botState = BotState.TIME_WASTER; // No goods to manipulate
            return null;
        }

        let top5Plans = [];

        for (const good of availableCommodities) {
            const buyLocation = this._findCheapestMarket(good.id);
            if (!buyLocation) continue;

            const crashLocation = this._findBestCrashTarget(good.id, buyLocation.id);
            if (!crashLocation) continue;
            
            const potential = good.tier * (crashLocation.price - buyLocation.price);
            
            if (potential > 0) {
                top5Plans.push({
                    potential,
                    plan: {
                        type: 'CRASH',
                        goodId: good.id,
                        buyFromLocationId: buyLocation.id,
                        crashLocationId: crashLocation.id,
                    }
                });
            }
        }

        if (top5Plans.length > 0) {
            // Sort by potential and take top 5
            top5Plans.sort((a, b) => b.potential - a.potential);
            const bestPlans = top5Plans.slice(0, 5).map(p => p.plan);
            
            // Randomly select one
            const chosenPlan = bestPlans[Math.floor(Math.random() * bestPlans.length)];
            
            if (specificGoodId) {
                return chosenPlan; // Return the plan for re-validation
            }

            this.currentObjective = chosenPlan;
            this.botState = BotState.PREPARING_CRASH;
            this.metrics.objectivesStarted++;
            this.logger.info.system('Bot', this.gameState.day, 'PLAN', `New crash plan (1 of ${bestPlans.length}): Buy ${chosenPlan.goodId} @ ${chosenPlan.buyFromLocationId}, Crash @ ${chosenPlan.crashLocationId}`);
        } else {
            if (!specificGoodId) {
                // No good manipulation routes, just run a simple trade
                this.botState = BotState.TIME_WASTER;
                this.logger.info.system('Bot', this.gameState.day, 'PLAN', `No good crash plans. Running simple trade.`);
            }
            return null;
        }
    }

    /**
     * [State: PREPARING_CRASH]
     * Bot travels to buy location (B) and fills cargo.
     * @private
     */
    async _executePreparation() {
        const { goodId, buyFromLocationId } = this.currentObjective;
        const state = this.gameState.getState();

        // 1. Travel to buy location
        if (state.currentLocationId !== buyFromLocationId) {
            this.logger.info.system('Bot', state.day, 'PREP', `Traveling to ${buyFromLocationId} to buy ${goodId}`);
            
            // --- FIX: Pre-flight check ---
            const activeShip = this.simulationService._getActiveShip();
            const travelInfo = state.TRAVEL_DATA[state.currentLocationId][buyFromLocationId];
            const requiredFuel = travelInfo ? (travelInfo.fuelCost || 0) : 9999;

            if (activeShip.fuel < requiredFuel) {
                this.logger.warn('Bot', `PREP_FAIL: Not enough fuel (${activeShip.fuel}) to travel to ${buyFromLocationId} (needs ${requiredFuel}). Forcing maintenance.`);
                // Store the original objective and set temporary maintenance plan
                const originalObjective = this.currentObjective; 
                this.currentObjective = {
                    type: 'REFUEL_FOR_TRAVEL',
                    needed: requiredFuel + 5, // Add 5 fuel buffer
                    nextState: BotState.PREPARING_CRASH, // State to return to
                    originalObjective: originalObjective // The plan to resume
                };
                this.botState = BotState.MAINTENANCE;
                return;
            }
            // --- End Fix ---
            
            this.simulationService.travelService.initiateTravel(buyFromLocationId);
            // After travel, the state is new, so we return to let the next tick handle purchase
            return; 
        }

        // 2. Buy max cargo (we are at the buy location)
        const price = state.market.prices[buyFromLocationId][goodId];
        const buyQty = this._calculateMaxBuy(goodId, price);
        if (buyQty > 0) {
            this.simulationService.playerActionService.buyItem(goodId, buyQty);
            this.logger.info.system('Bot', state.day, 'PREP_BUY', `Bought ${buyQty}x ${goodId} @ ${formatCredits(price)}`);
            this.botState = BotState.EXECUTING_CRASH;
        } else {
            // Can't buy. Abort plan.
            this.logger.warn('Bot', `PREP_FAIL: Arrived at ${buyFromLocationId} but could not buy ${goodId}. Aborting.`);
            this.currentObjective = null;
            this.botState = BotState.IDLE;
            this.metrics.objectivesAborted++;
        }
    }

    /**
     * [State: EXECUTING_CRASH]
     * Bot travels to crash location (A) and sells cargo.
     * @private
     */
    async _executeCrash() {
        const { goodId, crashLocationId } = this.currentObjective;
        const state = this.gameState.getState();

        // 1. Travel to crash location
        if (state.currentLocationId !== crashLocationId) {
            this.logger.info.system('Bot', state.day, 'CRASH', `Traveling to ${crashLocationId} to crash ${goodId}`);

            // --- FIX: Pre-flight check ---
            const activeShip = this.simulationService._getActiveShip();
            const travelInfo = state.TRAVEL_DATA[state.currentLocationId][crashLocationId];
            const requiredFuel = travelInfo ? (travelInfo.fuelCost || 0) : 9999;
            
            if (activeShip.fuel < requiredFuel) {
                this.logger.warn('Bot', `CRASH_FAIL: Not enough fuel (${activeShip.fuel}) to travel to ${crashLocationId} (needs ${requiredFuel}). Forcing maintenance.`);
                const originalObjective = this.currentObjective; 
                this.currentObjective = {
                    type: 'REFUEL_FOR_TRAVEL',
                    needed: requiredFuel + 5,
                    nextState: BotState.EXECUTING_CRASH, 
                    originalObjective: originalObjective
                };
                this.botState = BotState.MAINTENANCE;
                return;
            }
            // --- End Fix ---

            this.simulationService.travelService.initiateTravel(crashLocationId);
            return; // Let next tick handle sale
        }

        // 2. Sell entire cargo
        const sellQty = this.simulationService._getActiveInventory()[goodId]?.quantity || 0;
        if (sellQty > 0) {
            const avgCost = this.simulationService._getActiveInventory()[goodId]?.avgCost || 0;
            const saleValue = this.simulationService.playerActionService.sellItem(goodId, sellQty);
            const profit = saleValue - (avgCost * sellQty);
            
            this.logger.info.system('Bot', state.day, 'CRASH_SELL', `CRASHED: Sold ${sellQty}x ${goodId}. Profit: ${formatCredits(profit)}`);
            this.metrics.totalTrades++;
            this.metrics.totalNetProfit += profit;
            if (profit > 0) this.metrics.profitableTrades++;
            
            // Track profit by good
            if (!this.metrics.profitByGood[goodId]) { this.metrics.profitByGood[goodId] = 0; }
            this.metrics.profitByGood[goodId] += profit;

            // 3. Add to memory
            const inventoryItem = this.gameState.market.inventory[crashLocationId][goodId];
            this.plannedObjectives.push({
                goodId: goodId,
                locationId: crashLocationId,
                priceLockEndDay: inventoryItem.priceLockEndDay,
                crashedOnDay: this.gameState.day,
            });

            // 4. Go directly to EXPLOIT state
            this.currentObjective.type = 'EXPLOIT';
            this.currentObjective.exploitLocationId = this.currentObjective.crashLocationId;
            delete this.currentObjective.buyFromLocationId;
            delete this.currentObjective.crashLocationId;

            this.botState = BotState.EXECUTING_EXPLOIT;
        } else {
            // Arrived with no cargo? Abort.
            this.logger.warn('Bot', `CRASH_FAIL: Arrived at ${crashLocationId} but have no ${goodId} to sell. Aborting.`);
            this.currentObjective = null;
            this.botState = BotState.IDLE;
            this.metrics.objectivesAborted++;
        }
    }

    /**
     * [State: EXECUTING_EXPLOIT]
     * Bot travels to a known crashed market and buys the cheap goods.
     * @private
     */
    async _executeExploit() {
        const { goodId, exploitLocationId } = this.currentObjective;
        const state = this.gameState.getState();

        // 1. Travel to exploit location
        if (state.currentLocationId !== exploitLocationId) {
            this.logger.info.system('Bot', state.day, 'EXPLOIT', `Traveling to ${exploitLocationId} to buy cheap ${goodId}`);

            // --- FIX: Pre-flight check ---
            const activeShip = this.simulationService._getActiveShip();
            const travelInfo = state.TRAVEL_DATA[state.currentLocationId][exploitLocationId];
            const requiredFuel = travelInfo ? (travelInfo.fuelCost || 0) : 9999;
            
            if (activeShip.fuel < requiredFuel) {
                this.logger.warn('Bot', `EXPLOIT_FAIL: Not enough fuel (${activeShip.fuel}) to travel to ${exploitLocationId} (needs ${requiredFuel}). Forcing maintenance.`);
                const originalObjective = this.currentObjective; 
                this.currentObjective = {
                    type: 'REFUEL_FOR_TRAVEL',
                    needed: requiredFuel + 5,
                    nextState: BotState.EXECUTING_EXPLOIT, 
                    originalObjective: originalObjective
                };
                this.botState = BotState.MAINTENANCE;
                return;
            }
            // --- End Fix ---

            this.simulationService.travelService.initiateTravel(exploitLocationId);
            return;
        }

        // 2. Buy max cargo
        const price = state.market.prices[exploitLocationId][goodId];
        const buyQty = this._calculateMaxBuy(goodId, price);

        if (buyQty > 0) {
            this.simulationService.playerActionService.buyItem(goodId, buyQty);
            this.logger.info.system('Bot', state.day, 'EXPLOIT_BUY', `EXPLOITED: Bought ${buyQty}x ${goodId} @ ${formatCredits(price)}`);
            
            // 3. Find a place to sell the goods we just bought
            const sellLocation = this._findBestSellLocation(goodId, exploitLocationId);

            if (sellLocation) {
                this.logger.info.system('Bot', state.day, 'EXPLOIT_PLAN', `Goods secured. Now traveling to ${sellLocation.id} to sell.`);
                this.currentObjective.type = 'SELL_EXPLOITED';
                this.currentObjective.sellToLocationId = sellLocation.id; 
                this.botState = BotState.SELLING_EXPLOITED_GOODS;
            } else {
                this.logger.warn('Bot', `EXPLOIT_FAIL: No market found to sell ${goodId}. Dumping objective.`);
                this.currentObjective = null;
                this.botState = BotState.IDLE;
                this.metrics.objectivesAborted++;
            }

        } else {
            // Market may have recovered or stock is 0.
            this.logger.warn('Bot', `EXPLOIT_FAIL: Arrived at ${exploitLocationId} but could not buy ${goodId}.`);
            this.currentObjective = null;
            this.botState = BotState.IDLE;
            this.metrics.objectivesAborted++;
        }

        // 4. Remove from memory (so we don't try again immediately)
        this.plannedObjectives = this.plannedObjectives.filter(obj => !(obj.goodId === goodId && obj.locationId === exploitLocationId));
    }

    /**
     * [State: SELLING_EXPLOITED_GOODS]
     * Bot travels to the best sell location and sells its cargo.
     * @private
     */
    async _executeSellExploited() {
        const { goodId, sellToLocationId } = this.currentObjective;
        const state = this.gameState.getState();

        // 1. Travel to sell location
        if (state.currentLocationId !== sellToLocationId) {
            this.logger.info.system('Bot', state.day, 'SELL_EXPLOIT', `Traveling to ${sellToLocationId} to sell ${goodId}`);

            // --- FIX: Pre-flight check ---
            const activeShip = this.simulationService._getActiveShip();
            const travelInfo = state.TRAVEL_DATA[state.currentLocationId][sellToLocationId];
            const requiredFuel = travelInfo ? (travelInfo.fuelCost || 0) : 9999;
            
            if (activeShip.fuel < requiredFuel) {
                this.logger.warn('Bot', `SELL_EXPLOIT_FAIL: Not enough fuel (${activeShip.fuel}) to travel to ${sellToLocationId} (needs ${requiredFuel}). Forcing maintenance.`);
                const originalObjective = this.currentObjective; 
                this.currentObjective = {
                    type: 'REFUEL_FOR_TRAVEL',
                    needed: requiredFuel + 5,
                    nextState: BotState.SELLING_EXPLOITED_GOODS, 
                    originalObjective: originalObjective
                };
                this.botState = BotState.MAINTENANCE;
                return;
            }
            // --- End Fix ---

            this.simulationService.travelService.initiateTravel(sellToLocationId);
            return;
        }

        // 2. Sell entire cargo
        const sellQty = this.simulationService._getActiveInventory()[goodId]?.quantity || 0;
        if (sellQty > 0) {
            const avgCost = this.simulationService._getActiveInventory()[goodId]?.avgCost || 0;
            const saleValue = this.simulationService.playerActionService.sellItem(goodId, sellQty);
            const profit = saleValue - (avgCost * sellQty);

            this.logger.info.system('Bot', state.day, 'SELL_EXPLOIT_SELL', `Sold ${sellQty}x ${goodId}. Profit: ${formatCredits(profit)}`);
            this.metrics.totalTrades++;
            this.metrics.totalNetProfit += profit;
            if (profit > 0) this.metrics.profitableTrades++;

            // Track profit by good
            if (!this.metrics.profitByGood[goodId]) { this.metrics.profitByGood[goodId] = 0; }
            this.metrics.profitByGood[goodId] += profit;

        } else {
            this.logger.warn('Bot', `SELL_EXPLOIT_FAIL: Arrived at ${sellToLocationId} but have no ${goodId} to sell.`);
        }

        // 3. Loop is complete. Go IDLE to re-evaluate (will pick up persistence).
        this.botState = BotState.IDLE;
        this.metrics.objectivesCompleted++;
    }


    /**
     * [State: TIME_WASTER]
     * Bot finds and executes a simple A-B trade to pass time.
     * --- [PHASE 1A] This is now a stateful function that executes a stored plan ---
     * @private
     */
    async _executeTimeWaster() {
        // If we're in this state, we're either executing a simple trade
        // or we need to find one (if strategy is HONEST_TRADER).

        // 1. Find a plan if we don't have one
        if (!this.currentObjective || this.currentObjective.type !== 'SIMPLE_TRADE') {
            const simpleTrade = this._findBestSimpleTrade();
            if (simpleTrade) {
                this.currentObjective = { ...simpleTrade, type: 'SIMPLE_TRADE', hasGoods: false };
                this.metrics.objectivesStarted++;
                // --- PHASE 3 LOGGING ---
                this.logger.info.system('Bot', this.gameState.day, 'OBJECTIVE', `[TRADE]: New simple trade. Buy ${simpleTrade.goodId} @ ${simpleTrade.buyLocationId} -> Sell @ ${simpleTrade.sellLocationId}. Margin: ${(simpleTrade.profitPerUnit / simpleTrade.buyPrice * 100).toFixed(1)}%. Est. PPD: ${formatCredits(simpleTrade.estimatedPPD)}.`);
            } else {
                // No trades found. Wait one day and go back to IDLE.
                this.logger.info.system('Bot', this.gameState.day, 'TIME_WASTER', 'No profitable simple trades found. Waiting 1 day.');
                this.simulationService.timeService.advanceDays(1);
                this.botState = BotState.IDLE;
                return;
            }
        }

        // 2. Execute the plan
        const { goodId, buyLocationId, sellLocationId, buyPrice, hasGoods } = this.currentObjective;
        const state = this.gameState.getState();
        const activeShip = this.simulationService._getActiveShip();

        // --- STAGE 1: GO TO BUY LOCATION & BUY ---
        if (!hasGoods) {
            // 2a. Travel to buy location
            if (state.currentLocationId !== buyLocationId) {
                // --- PHASE 3 LOGGING ---
                this.logger.info.system('Bot', state.day, 'TRADE_BUY', `Traveling to ${buyLocationId} to buy ${goodId}`);
                const travelInfo = state.TRAVEL_DATA[state.currentLocationId][buyLocationId];
                const requiredFuel = travelInfo ? (travelInfo.fuelCost || 0) : 9999;
                
                if (activeShip.fuel < requiredFuel) {
                    this.logger.warn('Bot', `TIME_WASTER_FAIL: Not enough fuel (${activeShip.fuel}) to travel to ${buyLocationId} (needs ${requiredFuel}). Forcing maintenance.`);
                    // --- FIX: Create a temporary REFUEL objective ---
                    const originalObjective = this.currentObjective;
                    this.currentObjective = {
                        type: 'REFUEL_FOR_TRAVEL',
                        needed: requiredFuel + 5,
                        nextState: BotState.TIME_WASTER,
                        originalObjective: originalObjective
                    };
                    this.botState = BotState.MAINTENANCE;
                    return;
                }
                this.simulationService.travelService.initiateTravel(buyLocationId);
                return;
            }
            
            // 2b. Buy
            // --- PHASE 1.1 FIX: Re-check quantity on arrival ---
            const currentStock = state.market.inventory[state.currentLocationId][goodId].quantity;
            if (currentStock <= 0) {
                this.logger.warn('Bot', `TIME_WASTER_FAIL: Arrived at ${buyLocationId} but ${goodId} is now out of stock. Aborting.`);
                this.currentObjective = null;
                this.botState = BotState.IDLE;
                this.metrics.objectivesAborted++;
                return;
            }
            // --- END FIX ---
            
            const buyQty = this._calculateMaxBuy(goodId, buyPrice);
            if (buyQty > 0) {
                this.simulationService.playerActionService.buyItem(goodId, buyQty);
                // --- PHASE 3 LOGGING ---
                this.logger.info.system('Bot', state.day, 'TRADE_BUY', `Bought ${buyQty}x ${goodId} @ ${formatCredits(buyPrice)}`);
                this.currentObjective.hasGoods = true; // Mark as having bought goods
                // Proceed immediately to sell step logic
            } else {
                // Can't buy (no space, no money). Abort plan.
                // --- PHASE 3 LOGGING ---
                this.logger.warn('Bot', `TIME_WASTER_FAIL: Arrived at ${buyLocationId} but could not buy ${goodId} (Price: ${formatCredits(buyPrice)}, Stock: ${currentStock}). Aborting.`);
                this.currentObjective = null;
                this.botState = BotState.IDLE;
                this.metrics.objectivesAborted++;
                return;
            }
        }

        // --- STAGE 2: GO TO SELL LOCATION & SELL ---
        if (this.currentObjective.hasGoods) {
             // 2c. Travel to sell location
            if (state.currentLocationId !== sellLocationId) {
                // --- PHASE 3 LOGGING ---
                this.logger.info.system('Bot', state.day, 'TRADE_SELL', `Traveling to ${sellLocationId} to sell ${goodId}`);
                const travelInfo = state.TRAVEL_DATA[state.currentLocationId][sellLocationId];
                const requiredFuel = travelInfo ? (travelInfo.fuelCost || 0) : 9999;

                if (activeShip.fuel < requiredFuel) {
                    this.logger.warn('Bot', `TIME_WASTER_FAIL: Not enough fuel (${activeShip.fuel}) to travel to ${sellLocationId} (needs ${requiredFuel}). Forcing maintenance.`);
                    // --- FIX: Create a temporary REFUEL objective ---
                    const originalObjective = this.currentObjective;
                    this.currentObjective = {
                        type: 'REFUEL_FOR_TRAVEL',
                        needed: requiredFuel + 5,
                        nextState: BotState.TIME_WASTER,
                        originalObjective: originalObjective
                    };
                    this.botState = BotState.MAINTENANCE;
                    return;
                }
                this.simulationService.travelService.initiateTravel(sellLocationId);
                return;
            }
            
            // 2d. Sell
            const sellQty = this.simulationService._getActiveInventory()[goodId]?.quantity || 0;
            if (sellQty > 0) {
                const avgCost = this.simulationService._getActiveInventory()[goodId]?.avgCost || 0;
                const saleValue = this.simulationService.playerActionService.sellItem(goodId, sellQty);
                const profit = saleValue - (avgCost * sellQty);
                
                // --- PHASE 3 LOGGING ---
                this.logger.info.system('Bot', state.day, 'TRADE_SELL', `Sold ${sellQty}x ${goodId}. Profit: ${formatCredits(profit)}`);
                this.metrics.totalTrades++;
                this.metrics.totalNetProfit += profit;
                if (profit > 0) this.metrics.profitableTrades++;

                // Track profit by good
                if (!this.metrics.profitByGood[goodId]) { this.metrics.profitByGood[goodId] = 0; }
                this.metrics.profitByGood[goodId] += profit;

                this.metrics.objectivesCompleted++;
            } else {
                this.logger.warn('Bot', `TIME_WASTER_FAIL: Arrived at ${sellLocationId} but have no ${goodId} to sell.`);
                this.metrics.objectivesAborted++;
            }

            // 3. Plan is complete. Go IDLE.
            this.currentObjective = null;
            this.botState = BotState.IDLE;
        }
    }

    /**
     * [State: SEEKING_DEPLETION]
     * Looks for a market to buy out to trigger the depletion bonus.
     * @private
     */
    async _findDepletionOpportunity() {
        const state = this.gameState.getState();
        const ship = this.simulationService._getActiveShip();
        if (!ship) {
            this.botState = BotState.IDLE;
            return;
        }
        
        const availableCommodities = DB.COMMODITIES.filter(c => c.tier <= state.player.revealedTier && c.tier > 1);
        let top5Plans = [];

        for (const good of availableCommodities) {
            for (const location of DB.MARKETS) {
                if (!state.player.unlockedLocationIds.includes(location.id)) continue;

                const inventoryItem = state.market.inventory[location.id][good.id];
                
                // Check cooldown
                if (state.day <= (inventoryItem.depletionBonusDay + 365)) {
                    continue;
                }

                // Replicate targetStock logic to find threshold
                const [minAvail, maxAvail] = good.canonicalAvailability;
                const modifier = location.availabilityModifier?.[good.id] ?? 1.0;
                const baseMeanStock = (minAvail + maxAvail) / 2 * modifier;
                let pressureForAdaptation = inventoryItem.marketPressure;
                if (pressureForAdaptation > 0) pressureForAdaptation = 0;
                const marketAdaptationFactor = 1 - Math.min(0.5, pressureForAdaptation * 0.5);
                const targetStock = Math.max(1, baseMeanStock * marketAdaptationFactor);
                const depletionThreshold = targetStock * 0.08;

                const stock = inventoryItem.quantity;
                const price = state.market.prices[location.id][good.id];
                
                // Check if stock is above threshold, and we can afford/hold it all
                if (stock >= depletionThreshold && 
                    state.player.credits >= (stock * price) &&
                    ship.cargoCapacity >= stock) {
                    
                    // Potential = tier * stock. Prioritize high-tier, high-volume.
                    top5Plans.push({
                        potential: good.tier * stock,
                        plan: {
                            type: 'DEPLETE',
                            goodId: good.id,
                            locationId: location.id,
                            amountToBuy: stock
                        }
                    });
                }
            }
        }

        if (top5Plans.length > 0) {
            top5Plans.sort((a, b) => b.potential - a.potential);
            const bestPlans = top5Plans.slice(0, 5).map(p => p.plan);
            const chosenPlan = bestPlans[Math.floor(Math.random() * bestPlans.length)];

            this.currentObjective = chosenPlan;
            this.botState = BotState.EXECUTING_DEPLETION;
            this.metrics.objectivesStarted++;
            this.logger.info.system('Bot', this.gameState.day, 'PLAN', `New depletion plan (1 of ${bestPlans.length}): Buy out ${chosenPlan.amountToBuy}x ${chosenPlan.goodId} at ${chosenPlan.locationId}`);
        } else {
            // No opportunity found
            if (this.activeStrategy === BotStrategy.DEPLETE_ONLY) {
                // If this is our only strategy, just wait and try again
                this.logger.info.system('Bot', this.gameState.day, 'PLAN', 'No depletion opportunities. Waiting 1 day.');
                this.simulationService.timeService.advanceDays(1);
                this.botState = BotState.IDLE; // Will re-run this state
            } else {
                // Fall back to a crash plan (if MIXED)
                this.botState = BotState.SEEKING_MANIPULATION;
            }
        }
    }

    /**
     * [State: EXECUTING_DEPLETION]
     * Travels to target, buys out stock, sells it, and enters wait state.
     * @private
     */
    async _executeDepletion() {
        const { goodId, locationId, amountToBuy } = this.currentObjective;
        const state = this.gameState.getState();

        // 1. Travel to depletion location
        if (state.currentLocationId !== locationId) {
            this.logger.info.system('Bot', state.day, 'DEPLETE', `Traveling to ${locationId} to buy out ${goodId}`);
            
            // --- FIX: Pre-flight check ---
            const activeShip = this.simulationService._getActiveShip();
            const travelInfo = state.TRAVEL_DATA[state.currentLocationId][locationId];
            const requiredFuel = travelInfo ? (travelInfo.fuelCost || 0) : 9999;
            if (activeShip.fuel < requiredFuel) {
                this.logger.warn('Bot', `DEPLETE_FAIL: Not enough fuel (${activeShip.fuel}) to travel to ${locationId} (needs ${requiredFuel}). Forcing maintenance.`);
                const originalObjective = this.currentObjective;
                this.currentObjective = {
                    type: 'REFUEL_FOR_TRAVEL',
                    needed: requiredFuel + 5,
                    nextState: BotState.EXECUTING_DEPLETION,
                    originalObjective: originalObjective
                };
                this.botState = BotState.MAINTENANCE;
                return;
            }
            // --- End Fix ---

            this.simulationService.travelService.initiateTravel(locationId);
            return;
        }

        // 2. Buy out the stock
        const boughtQty = this.simulationService.playerActionService.buyItem(goodId, amountToBuy);
        if (!boughtQty || boughtQty < amountToBuy) {
            this.logger.warn('Bot', `DEPLETE_FAIL: Failed to buy out ${goodId} at ${locationId}. Aborting.`);
            this.currentObjective = null;
            this.botState = BotState.IDLE;
            this.metrics.objectivesAborted++;
            return;
        }

        this.logger.info.system('Bot', state.day, 'DEPLETE_BUY', `Successfully bought out ${amountToBuy}x ${goodId}. Depletion bonus triggered.`);

        // 3. Sell the cargo immediately to free up space
        const sellLocation = this._findBestSellLocation(goodId, locationId);
        if (sellLocation) {
            // --- FIX: Pre-flight check ---
            const activeShip = this.simulationService._getActiveShip();
            const travelInfo = state.TRAVEL_DATA[state.currentLocationId][sellLocation.id];
            const requiredFuel = travelInfo ? (travelInfo.fuelCost || 0) : 9999;
            if (activeShip.fuel < requiredFuel) {
                this.logger.warn('Bot', `DEPLETE_FAIL: Not enough fuel (${activeShip.fuel}) to travel to sell location ${sellLocation.id} (needs ${requiredFuel}). Forcing maintenance.`);
                // --- FIX: Create a temporary REFUEL objective ---
                const originalObjective = this.currentObjective;
                this.currentObjective = {
                    type: 'REFUEL_FOR_TRAVEL',
                    needed: requiredFuel + 5,
                    nextState: BotState.EXECUTING_DEPLETION, // Return to this state
                    originalObjective: originalObjective
                };
                this.botState = BotState.MAINTENANCE;
                return;
            }
            // --- End Fix ---
            
            this.simulationService.travelService.initiateTravel(sellLocation.id);
            // We must return here to let the travel happen.
            // The bot will re-enter this state, fail the travel check, and proceed to sell.
            return;
        }

        // 4. Enter waiting state (if we couldn't sell, we just wait)
        this.currentObjective.waitStartDay = this.gameState.day;
        this.botState = BotState.WAITING_FOR_HIKE;
    }

    /**
     * [State: WAITING_FOR_HIKE]
     * Passes time until the 7-day price hike is active.
     * @private
     */
    async _executeWait() {
        if (this.gameState.day > this.currentObjective.waitStartDay + 7) {
            this.logger.info.system('Bot', this.gameState.day, 'DEPLETE', 'Wait complete. Price hike is active. Beginning exploitation.');
            this.botState = BotState.EXPLOITING_HIKE;
            this.currentObjective.exploitRuns = 0; // Initialize run counter
        } else {
            // --- FIX: Just advance time, don't run a full trade loop ---
            this.simulationService.timeService.advanceDays(1);
            this.botState = BotState.WAITING_FOR_HIKE; // Stay in this state
        }
    }

    /**
     * [State: EXPLOITING_HIKE]
     * Buys goods from a cheap market (B) and sells at the price-hiked market (A).
     * @private
     */
    async _executeExploitHike() {
        const { goodId, locationId } = this.currentObjective; // locationId is (A)
        const state = this.gameState.getState();

        // Find cheapest place to buy (B)
        const buyLocation = this._findCheapestMarket(goodId);
        if (!buyLocation || buyLocation.id === locationId) {
            this.logger.warn('Bot', `HIKE_FAIL: No cheap market found to buy ${goodId}. Aborting exploit.`);
            this.currentObjective = null;
            this.botState = BotState.IDLE;
            this.metrics.objectivesAborted++;
            return;
        }
        
        // Go to buy location (B)
        if (state.currentLocationId !== buyLocation.id) {
            // --- FIX: Pre-flight check ---
            const activeShip = this.simulationService._getActiveShip();
            const travelInfo = state.TRAVEL_DATA[state.currentLocationId][buyLocation.id];
            const requiredFuel = travelInfo ? (travelInfo.fuelCost || 0) : 9999;
            if (activeShip.fuel < requiredFuel) {
                this.logger.warn('Bot', `HIKE_FAIL: Not enough fuel (${activeShip.fuel}) to travel to buy location ${buyLocation.id} (needs ${requiredFuel}). Forcing maintenance.`);
                // --- FIX: Create a temporary REFUEL objective ---
                const originalObjective = this.currentObjective;
                this.currentObjective = {
                    type: 'REFUEL_FOR_TRAVEL',
                    needed: requiredFuel + 5,
                    nextState: BotState.EXPLOITING_HIKE,
                    originalObjective: originalObjective
                };
                this.botState = BotState.MAINTENANCE;
                return;
            }
            // --- End Fix ---
            this.simulationService.travelService.initiateTravel(buyLocation.id);
            return;
        }
        
        // Buy max
        const buyQty = this._calculateMaxBuy(goodId, buyLocation.price);
        if (buyQty > 0) this.simulationService.playerActionService.buyItem(goodId, buyQty);
        
        // Go to hiked location (A)
        if (state.currentLocationId !== locationId) {
             // --- FIX: Pre-flight check ---
             const activeShip = this.simulationService._getActiveShip();
             const travelInfo = state.TRAVEL_DATA[state.currentLocationId][locationId];
             const requiredFuel = travelInfo ? (travelInfo.fuelCost || 0) : 9999;
             if (activeShip.fuel < requiredFuel) {
                 this.logger.warn('Bot', `HIKE_FAIL: Not enough fuel (${activeShip.fuel}) to travel to hiked location ${locationId} (needs ${requiredFuel}). Forcing maintenance.`);
                 // --- FIX: Create a temporary REFUEL objective ---
                 const originalObjective = this.currentObjective;
                 this.currentObjective = {
                    type: 'REFUEL_FOR_TRAVEL',
                    needed: requiredFuel + 5,
                    nextState: BotState.EXPLOITING_HIKE,
                    originalObjective: originalObjective
                 };
                 this.botState = BotState.MAINTENANCE;
                 return;
             }
             // --- End Fix ---
            this.simulationService.travelService.initiateTravel(locationId);
            return;
        }

        // Sell all
        const sellQty = this.simulationService._getActiveInventory()[goodId]?.quantity || 0;
        
        // --- FIX: Check for 0 stock before selling ---
        const hikedStock = state.market.inventory[locationId][goodId].quantity;
        if (sellQty > 0 && hikedStock > 0) {
            const avgCost = this.simulationService._getActiveInventory()[goodId]?.avgCost || 0;
            const saleValue = this.simulationService.playerActionService.sellItem(goodId, sellQty);
            const profit = saleValue - (avgCost * sellQty);

            this.logger.info.system('Bot', state.day, 'HIKE_EXPLOIT_SELL', `Sold ${sellQty}x ${goodId} at hiked price. Profit: ${formatCredits(profit)}`);
            this.metrics.totalTrades++;
            this.metrics.totalNetProfit += profit;
            if (profit > 0) this.metrics.profitableTrades++;
            
            // Track profit by good
            if (!this.metrics.profitByGood[goodId]) { this.metrics.profitByGood[goodId] = 0; }
            this.metrics.profitByGood[goodId] += profit;

        } else if (sellQty > 0 && hikedStock <= 0) {
            this.logger.warn('Bot', `HIKE_FAIL: Arrived at hiked market ${locationId} but stock is 0. Aborting sale and loop.`);
            this.currentObjective = null;
            this.botState = BotState.IDLE;
            this.metrics.objectivesAborted++;
            return;
        }
        // --- End Fix ---

        // Check if we should loop
        this.currentObjective.exploitRuns++;
        const inventoryItem = state.market.inventory[locationId][goodId];
        if (this.currentObjective.exploitRuns < 2 && state.day < (inventoryItem.depletionDay + 7)) {
            // Repeat the exploit
            this.botState = BotState.EXPLOITING_HIKE;
        } else {
            // Done
            this.logger.info.system('Bot', state.day, 'HIKE_COMPLETE', 'Depletion exploit complete.');
            this.currentObjective = null;
            this.botState = BotState.IDLE;
            this.metrics.objectivesCompleted++;
        }
    }


    // --- "BRAIN" HELPER FUNCTIONS ---

    /**
     * Checks if the bot's current `CRASH` objective is still profitable.
     * @private
     */
    _isCrashPlanStillValid() {
        if (!this.currentObjective || this.currentObjective.type !== 'CRASH') {
            return false;
        }
        const { goodId, buyFromLocationId, crashLocationId } = this.currentObjective;
        
        // Handle case where properties might be missing from a bad objective
        if (!goodId || !buyFromLocationId || !crashLocationId) {
            return false;
        }

        const state = this.gameState.getState();
        const buyPrice = state.market.prices[buyFromLocationId][goodId];
        const sellPrice = state.market.prices[crashLocationId][goodId];
        // Simple check: is it still profitable to run this loop?
        return (sellPrice - buyPrice) > 0;
    }

    /**
     * Finds markets that the bot *itself* has crashed and are ready to exploit.
     * @returns {object | null} An exploit objective, or null.
     * @private
     */
    _findReadySelfExploit() {
        const state = this.gameState.getState();

        // 1. Clean memory and find self-created opportunities
        this.plannedObjectives = this.plannedObjectives.filter(obj => obj.priceLockEndDay > state.day); // Clean expired
        for (const obj of this.plannedObjectives) {
            // Is it ready to exploit (7-day delay passed)?
            if (state.day > obj.crashedOnDay + 7) {
                // Is stock high enough to buy?
                const stock = state.market.inventory[obj.locationId][obj.goodId].quantity;
                if (stock > 10) { // Arbitrary "worth it" amount
                    return { type: 'EXPLOIT', goodId: obj.goodId, exploitLocationId: obj.locationId };
                }
            }
        }
        return null;
    }

    /**
     * [BRAIN] Finds the best place to sell any cargo the bot is currently holding.
     * @returns {object | null} A trade objective, or null if no profitable sale is found.
     * @private
     */
    _findBestSellLocationForHeldCargo() {
        const state = this.gameState.getState();
        const inventory = this.simulationService._getActiveInventory();
        if (!inventory) return null;

        let bestSale = null;
        let maxProfit = 0;

        for (const goodId in inventory) {
            const item = inventory[goodId];
            if (item && item.quantity > 0) {
                const avgCost = item.avgCost;
                const quantity = item.quantity;
                
                // Find the best market to sell this specific good
                const sellLocation = this._findBestSellLocation(goodId, state.currentLocationId);
                
                if (sellLocation) {
                    const potentialProfit = (sellLocation.price - avgCost) * quantity;
                    
                    if (potentialProfit > maxProfit) {
                        maxProfit = potentialProfit;
                        bestSale = {
                            goodId: goodId,
                            quantity: quantity,
                            avgCost: avgCost,
                            sellLocationId: sellLocation.id,
                            sellPrice: sellLocation.price,
                            estimatedProfit: potentialProfit
                        };
                    }
                }
            }
        }
        
        // Only return if the sale is profitable
        return (bestSale && bestSale.estimatedProfit > 0) ? bestSale : null;
    }

    /**
     * Finds the absolute cheapest market to buy a specific good.
     * @private
     */
    _findCheapestMarket(goodId) {
        const state = this.gameState.getState();
        let bestBuy = null;
        let minPrice = Infinity;

        for (const location of DB.MARKETS) {
            if (!state.player.unlockedLocationIds.includes(location.id)) continue;
            const price = state.market.prices[location.id][goodId];
            if (price < minPrice && state.market.inventory[location.id][goodId].quantity > 0) {
                minPrice = price;
                bestBuy = { id: location.id, price: price };
            }
        }
        return bestBuy;
    }

    /**
     * Finds the best market to *sell* a good at.
     * This means the highest price, excluding the current location.
     * @private
     */
    _findBestSellLocation(goodId, currentLocationId) {
        const state = this.gameState.getState();
        let bestSell = null;
        let maxPrice = -Infinity;

        for (const location of DB.MARKETS) {
            if (location.id === currentLocationId || !state.player.unlockedLocationIds.includes(location.id)) continue;
            
            // --- FIX: Check for stock > 0 ---
            const stock = state.market.inventory[location.id][goodId].quantity;
            const price = state.market.prices[location.id][goodId];
            if (price > maxPrice && stock > 0) {
                maxPrice = price;
                bestSell = { id: location.id, price: price };
            }
            // --- End Fix ---
        }
        return bestSell;
    }


    /**
     * Finds the best market to *sell* a good at *for the purpose of crashing it*.
     * This means an exporter (low modifier) that isn't the place we're buying from.
     * @private
     */
    _findBestCrashTarget(goodId, buyLocationId) {
        const state = this.gameState.getState();
        let bestTarget = null;
        let bestModifier = Infinity; // We want the lowest (exporter) modifier

        for (const location of DB.MARKETS) {
            if (location.id === buyLocationId || !state.player.unlockedLocationIds.includes(location.id)) continue;

            const modifier = location.availabilityModifier?.[goodId] ?? 1.0;
            // We want an exporter (modifier > 1) or neutral (modifier == 1)
            // But for finding the *best*, we just find the lowest *price* (which modifier causes)
            const price = state.market.prices[location.id][goodId];
            if (price < bestModifier) {
                bestModifier = price;
                bestTarget = { id: location.id, price: price };
            }
        }
        return bestTarget;
    }

    /**
     * Finds the best simple A-B (non-manipulation) trade route.
     * --- [PHASE 2] This logic is now smarter, factoring in cargo size and full round trip time ---
     * @private
     */
    _findBestSimpleTrade() {
        const state = this.gameState.getState();
        const activeShip = this.simulationService._getActiveShip();
        if (!activeShip) return null; // No ship, no trades
        
        const cargoCapacity = activeShip.cargoCapacity;
        if (cargoCapacity <= 0) return null; // No cargo, no trades

        let bestTrade = null;
        let maxProfitPerDay = 0;

        const availableCommodities = DB.COMMODITIES.filter(c => c.tier <= state.player.revealedTier);
        const inventory = this.simulationService._getActiveInventory();

        for (const good of availableCommodities) {
            // --- PHASE 1 REFACTOR: Check if bot is already holding this good ---
            // If so, simple trade logic should ignore it, as SELLING_HELD_CARGO will handle it.
            if (inventory[good.id] && inventory[good.id].quantity > 0) {
                continue;
            }
            // --- END REFACTOR ---

            for (const buyLocation of DB.MARKETS) {
                if (!state.player.unlockedLocationIds.includes(buyLocation.id)) continue;

                // --- PHASE 1.1 FIX: Check buy stock quantity ---
                const buyStock = state.market.inventory[buyLocation.id][good.id].quantity;
                if (buyStock <= 0) {
                    continue; // Can't buy if it's out of stock
                }
                // --- END FIX ---

                for (const sellLocation of DB.MARKETS) {
                    if (buyLocation.id === sellLocation.id || !state.player.unlockedLocationIds.includes(sellLocation.id)) continue;

                    // --- PHASE 1.1 FIX: Check sell stock quantity ---
                    // We check sell stock > 0 because we can't sell to a market that has 0 *demand* (is depleted)
                    const sellStock = state.market.inventory[sellLocation.id][good.id].quantity;
                    if (sellStock <= 0) {
                        continue;
                    }
                    // --- END FIX ---

                    const buyPrice = state.market.prices[buyLocation.id][good.id];
                    const sellPrice = state.market.prices[sellLocation.id][good.id];
                    const profitPerUnit = sellPrice - buyPrice;

                    // --- PHASE 2.1 FIX: Check profit margin ---
                    const profitMargin = (buyPrice > 0) ? (profitPerUnit / buyPrice) : 0;

                    if (profitPerUnit > 0 && profitMargin > this.MIN_PROFIT_MARGIN) {
                        const travelTimeToBuy = state.TRAVEL_DATA[state.currentLocationId]?.[buyLocation.id]?.time || 0;
                        const travelTimeToSell = state.TRAVEL_DATA[buyLocation.id]?.[sellLocation.id]?.time || 0;
                        
                        // Skip if no travel data
                        if (travelTimeToSell === 0) continue; 
                        
                        // +2 for transaction time (1 day to buy, 1 day to sell)
                        const totalTime = travelTimeToBuy + travelTimeToSell + 2; 

                        // --- PHASE 1.1 FIX: Base profit calc on actual available stock ---
                        const buyQty = Math.min(cargoCapacity, buyStock);
                        const totalTripProfit = profitPerUnit * buyQty;
                        // --- END FIX ---
                        const profitPerDay = totalTripProfit / totalTime;

                        if (profitPerDay > maxProfitPerDay) {
                            maxProfitPerDay = profitPerDay;
                            bestTrade = {
                                goodId: good.id,
                                buyLocationId: buyLocation.id,
                                sellLocationId: sellLocation.id,
                                buyPrice,
                                sellPrice,
                                profitPerUnit,
                                estimatedPPD: profitPerDay
                            };
                        }
                    }
                    // --- END FIX ---
                }
            }
        }
        return bestTrade;
    }

    /**
     * Handles pop-up modals, specifically Age Events.
     * --- [PHASE 1B] This is now a generic, future-proof handler ---
     * @returns {boolean} True if a modal was handled, false otherwise.
     * @private
     */
    _handleAgeEventChoice() {
        const modal = document.getElementById('age-event-modal');
        if (!modal || modal.classList.contains('hidden')) {
            return false; // No event is active
        }

        const title = document.getElementById('age-event-title').textContent;
        this.logger.info.system('Bot', this.gameState.day, 'EVENT_CHOICE', `Handling age event: ${title}`);

        const buttons = Array.from(modal.querySelectorAll('button'));
        if (buttons.length === 0) {
            return false; // No buttons to click
        }

        // Keywords for "best" choices, in order of priority
        const profitKeywords = ['trademaster', 'merchant\'s guild', 'free ship', 'credits', 'profit'];
        // Keywords for "neutral" choices
        const neutralKeywords = ['continue', 'ignore', 'dismiss', 'accept'];
        
        let chosenButton = null;

        // 1. Try to find a profit-based choice
        for (const btn of buttons) {
            const btnText = btn.textContent.toLowerCase();
            if (profitKeywords.some(kw => btnText.includes(kw))) {
                chosenButton = btn;
                break;
            }
        }

        // 2. If no profit choice, try to find a neutral/continue choice
        if (!chosenButton) {
             for (const btn of buttons) {
                const btnText = btn.textContent.toLowerCase();
                if (neutralKeywords.some(kw => btnText.includes(kw))) {
                    chosenButton = btn;
                    break;
                }
            }
        }
        
        // 3. If still no match, just click the first button to not get stuck
        if (!chosenButton) {
            this.logger.warn('Bot', `EVENT_CHOICE: No preferred keyword found for "${title}". Clicking first available button.`);
            chosenButton = buttons[0];
        }
        
        chosenButton.click();
        return true;
    }
    
    /**
     * Logs a summary report of the bot's performance to the console and game log.
     * --- [PHASE 2] Now includes Profit Per Day ---
     * @private
     */
    _logSummaryReport() {
        this.metrics.daysSimulated = this.gameState.day - this.simulationStartDay;
        const { 
            totalTrades, profitableTrades, totalNetProfit, totalFuelCost, 
            totalRepairCost, daysSimulated, strategyUsed, objectivesStarted,
            objectivesCompleted, objectivesAborted, profitByGood
        } = this.metrics;
        
        const profitPct = totalTrades > 0 ? ((profitableTrades / totalTrades) * 100).toFixed(1) : 0;
        const profitPerDay = daysSimulated > 0 ? (totalNetProfit / daysSimulated) : 0;

        const header = '=== AUTO-TRADER PERFORMANCE SUMMARY ===';
        console.log(header);
        this.logger.info.system('Bot', this.gameState.day, 'REPORT', header);
        
        const summary = [
            `Strategy Run: ${strategyUsed}`,
            `Days Simulated: ${daysSimulated}`,
            `Final Credit Balance: ${formatCredits(this.gameState.player.credits)}`,
            ``,
            `--- Performance ---`,
            `Total Net Profit: ${formatCredits(totalNetProfit)}`,
            `Profit Per Day: ${formatCredits(profitPerDay)}`,
            `Objectives (Started/Completed/Aborted): ${objectivesStarted} / ${objectivesCompleted} / ${objectivesAborted}`,
            `Total Trades Completed: ${totalTrades}`,
            `Profitable Trades: ${profitableTrades} (${profitPct}%)`,
            ``,
            `--- Costs ---`,
            `Total Fuel Costs: ${formatCredits(totalFuelCost)}`,
            `Total Repair Costs: ${formatCredits(totalRepairCost)}`,
        ];

        for (const line of summary) {
            console.log(line);
            this.logger.info.system('Bot', this.gameState.day, 'REPORT', `  ${line}`); // Indent for log clarity
        }

        // --- Profit by Good ---
        const profitHeader = `--- Profit Breakdown by Commodity ---`;
        console.log(profitHeader);
        this.logger.info.system('Bot', this.gameState.day, 'REPORT', `  ${profitHeader}`);
        
        const sortedGoods = Object.keys(profitByGood).sort((a, b) => profitByGood[b] - profitByGood[a]);
        if (sortedGoods.length === 0) {
             const noData = `No commodity trades recorded.`;
             console.log(noData);
             this.logger.info.system('Bot', this.gameState.day, 'REPORT', `    ${noData}`);
        } else {
            for (const goodId of sortedGoods) {
                const profit = profitByGood[goodId];
                const commodityName = DB.COMMODITIES.find(c => c.id === goodId)?.name || goodId;
                const line = `${commodityName}: ${formatCredits(profit)}`;
                console.log(line);
                this.logger.info.system('Bot', this.gameState.day, 'REPORT', `    ${line}`);
            }
        }
        
        const footer = '=======================================';
        console.log(footer);
        this.logger.info.system('Bot', this.gameState.day, 'REPORT', footer);
    }

    // --- UTILITY FUNCTIONS (Moved from DebugService) ---

    /**
     * Checks if fuel or health are low (general threshold).
     * @returns {boolean} True if maintenance is needed.
     * @private
     */
    _needsMaintenance() {
        const activeShip = this.simulationService._getActiveShip();
        if (!activeShip) return false;

        const fuelPct = (this.gameState.player.shipStates[activeShip.id].fuel / activeShip.maxFuel) * 100;
        const healthPct = (this.gameState.player.shipStates[activeShip.id].health / activeShip.maxHealth) * 100;

        return fuelPct < 30 || healthPct < 30;
    }

    /**
     * @param {number | null} targetFuelAmount - The amount of fuel to buy. If null, fills the tank.
     * @private
     */
    _botRefuel(targetFuelAmount = null) {
        const ship = this.simulationService._getActiveShip();
        if (!ship) return;
        
        const finalTargetFuel = targetFuelAmount === null ? ship.maxFuel : Math.min(ship.maxFuel, targetFuelAmount);
        const fuelNeeded = finalTargetFuel - this.gameState.player.shipStates[ship.id].fuel;
        
        if (fuelNeeded <= 0) return;
        
        const currentMarket = DB.MARKETS.find(m => m.id === this.gameState.currentLocationId);
        let fuelPrice = currentMarket.fuelPrice / 2; // Base cost
        
        // Apply Venetian Syndicate discount
        if (this.gameState.player.activePerks[PERK_IDS.VENETIAN_SYNDICATE] && this.gameState.currentLocationId === LOCATION_IDS.VENUS) {
             fuelPrice *= (1 - DB.PERKS[PERK_IDS.VENETIAN_SYNDICATE].fuelDiscount);
        }
        fuelPrice = Math.max(1, Math.round(fuelPrice));

        const ticksNeeded = Math.ceil(fuelNeeded / 5); // 5 fuel per tick
        const totalCost = ticksNeeded * fuelPrice;
        const fuelToBuy = ticksNeeded * 5;

        if (this.gameState.player.credits >= totalCost) {
            this.gameState.player.credits -= totalCost;
            this.gameState.player.shipStates[ship.id].fuel = Math.min(ship.maxFuel, this.gameState.player.shipStates[ship.id].fuel + fuelToBuy);
            this.simulationService._logConsolidatedTransaction('fuel', -totalCost, 'Fuel Purchase');
            this.metrics.totalFuelCost += totalCost;
        } else {
            // Buy as much as possible
            const affordableTicks = Math.floor(this.gameState.player.credits / fuelPrice);
            if (affordableTicks > 0) {
                const cost = affordableTicks * fuelPrice;
                this.gameState.player.credits -= cost;
                this.gameState.player.shipStates[ship.id].fuel += (affordableTicks * 5);
                this.simulationService._logConsolidatedTransaction('fuel', -cost, 'Fuel Purchase');
                this.metrics.totalFuelCost += cost;
            }
        }
    }

    /**
     * @private
     */
    _botRepair() {
        const ship = this.simulationService._getActiveShip();
        if (!ship) return;
        const healthNeeded = ship.maxHealth - this.gameState.player.shipStates[ship.id].health;
        if (healthNeeded <= 0) return;
        
        const repairAmountPerTick = ship.maxHealth * (GAME_RULES.REPAIR_AMOUNT_PER_TICK / 100);
        let costPerTick = repairAmountPerTick * GAME_RULES.REPAIR_COST_PER_HP;
        
        // Apply Venetian Syndicate discount
        if (this.gameState.player.activePerks[PERK_IDS.VENETIAN_SYNDICATE] && this.gameState.currentLocationId === LOCATION_IDS.VENUS) {
             costPerTick *= (1 - DB.PERKS[PERK_IDS.VENETIAN_SYNDICATE].repairDiscount);
        }
        costPerTick = Math.max(1, Math.round(costPerTick));

        const ticksNeeded = Math.ceil(healthNeeded / repairAmountPerTick);
        const totalCost = ticksNeeded * costPerTick;

        if (this.gameState.player.credits >= totalCost) {
            this.gameState.player.credits -= totalCost;
            this.gameState.player.shipStates[ship.id].health = ship.maxHealth;
            this.simulationService._logConsolidatedTransaction('repair', -totalCost, 'Hull Repairs');
            this.metrics.totalRepairCost += totalCost;
        } else {
            // Buy as much as possible
            const affordableTicks = Math.floor(this.gameState.player.credits / costPerTick);
            if (affordableTicks > 0) {
                const cost = affordableTicks * costPerTick;
                this.gameState.player.credits -= cost;
                this.gameState.player.shipStates[ship.id].health += (affordableTicks * repairAmountPerTick);
                this.simulationService._logConsolidatedTransaction('repair', -cost, 'Hull Repairs');
                this.metrics.totalRepairCost += cost;
            }
        }
    }

    /**
     * @private
     * --- [PHASE 2] Hardened to handle price <= 0 ---
     */
    _calculateMaxBuy(goodId, price) {
        const state = this.gameState.getState();
        const ship = this.simulationService._getActiveShip();
        const inventory = this.simulationService._getActiveInventory();
        if (!ship || !inventory) return 0; // Bot has no ship
        
        const space = ship.cargoCapacity - calculateInventoryUsed(inventory);
        const canAfford = (price > 0) ? Math.floor(state.player.credits / price) : Infinity;
        const stock = state.market.inventory[state.currentLocationId][goodId].quantity;
        return Math.max(0, Math.min(space, canAfford, stock));
    }
}
--- END OF FILE: ./js/services/bot/AutomatedPlayerService.js ---

--- START OF FILE: ./js/services/IntelService.js ---
// js/services/IntelService.js
/**
 * @fileoverview This file contains the IntelService class, which manages
 * the entire lifecycle of the Local Data Broker system. It handles the
 * procedural generation of intel packets, dynamic pricing, and purchase logic.
 */

import { DB } from '../data/database.js';
import { INTEL_CONTENT } from '../data/intelContent.js';
import { PURCHASED_INTEL_MESSAGES } from '../data/intelMessages.js';
import { formatCredits } from '../utils.js';
// VIRTUAL WORKBENCH: Added PERK_IDS import
import { PERK_IDS } from '../data/constants.js';

/**
 * @class IntelService
 * @description The "brain" of the Intel System. Manages generation,
 * persistence, pricing, and purchase logic for intel packets.
 */
export class IntelService {
    /**
     * @param {import('./GameState.js').GameState} gameState
     * @param {import('./world/TimeService.js').TimeService} timeService
     * @param {import('./simulation/MarketService.js').MarketService} marketService
     * @param {import('./NewsTickerService.js').NewsTickerService} newsTickerService
     * @param {import('./LoggingService.js').Logger} logger
     */
    constructor(gameState, timeService, marketService, newsTickerService, logger) {
        this.gameState = gameState;
        this.timeService = timeService;
        this.marketService = marketService;
        this.newsTickerService = newsTickerService;
        this.logger = logger;
        this.db = DB; // For accessing static data
    }

    /**
     * Generates new intel packets for all locations.
     * Triggered by TimeService every 120 game days.
     * This method removes old, unpurchased intel and adds 1-3 new packets.
     * @JSDoc
     */
    generateIntelRefresh() {
        this.logger.info.system('IntelService', this.gameState.day, 'REFRESH', 'Generating intel refresh for all markets.');
        // Get the LIVE state object.
        const state = this.gameState.getState();
        const intelMarket = state.intelMarket;

        for (const locationId of Object.keys(intelMarket)) {
            // Filter out (remove) any packets that were NOT purchased
            const purchasedPackets = intelMarket[locationId].filter(packet => packet.isPurchased);
            // Mutate the intelMarket object directly, as per app architecture.
            intelMarket[locationId] = purchasedPackets;
        }

        
        // Iterate through all markets to generate new intel
        for (const location of this.db.MARKETS) {
            const locationId = location.id; // This is the SALE location
            if (!intelMarket[locationId]) {
                 intelMarket[locationId] = [];
            }

            // GDD: Apply randomization to decide if a location gets new intel
            // Using 70% chance as specified in GDD
            if (Math.random() < 0.7) {
                // Get keys already in use by purchased packets at this location
                const existingKeys = intelMarket[locationId].map(p => p.messageKey).filter(Boolean);
                // Track keys used in this specific batch
                const newKeysInBatch = new Set();

                const numPackets = 1 + Math.floor(Math.random() * 3); // 1-3 packets
                for (let i = 0; i < numPackets; i++) {
                    // Combine persistent keys and new-batch keys
                    const unavailableKeys = [...existingKeys, ...newKeysInBatch];
                    // Pass the sale location ID and unavailable keys
                    const newPacket = this._createPacket(locationId, unavailableKeys);

                    if (newPacket) {
                        // Mutate the intelMarket array directly.
                        intelMarket[locationId].push(newPacket);
                        newKeysInBatch.add(newPacket.messageKey);
                    }
                }
            }
        }
        
        // Call setState to trigger a render of the mutated state.
        this.gameState.setState({ intelMarket: intelMarket });
    }

    /**
     * Private helper to create a single intelPacket object.
     * @param {string} saleLocationId - The location where this packet will be SOLD.
     * @param {string[]} unavailableKeys - An array of messageKey strings already in use at this location.
     * @returns {object | null} A new intelPacket object, or null if generation fails.
     * @private
     * @JSDoc
     */
    _createPacket(saleLocationId, unavailableKeys = []) {
        const state = this.gameState.getState();
        
        const revealedTier = state.player.revealedTier;
        const unlockedCommodities = this.db.COMMODITIES
             .filter(c => c.tier <= revealedTier)
            .map(c => c.id);

        if (!unlockedCommodities || unlockedCommodities.length === 0) {
            this.logger.warn('IntelService', 'Cannot create packet: No unlocked commodities available for player\'s tier.');
            return null;
        }

        // Get the locations the player has actually visited and unlocked.
        const playerUnlockedLocations = state.player.unlockedLocationIds || [];
        
        // Ensure the DEAL location is different from the SALE location
        // AND the player has unlocked the DEAL location.
        const allLocationIds = this.db.MARKETS.map(m => m.id);
        const possibleDealLocations = allLocationIds.filter(id => 
            id !== saleLocationId && playerUnlockedLocations.includes(id)
        );
        
        if (possibleDealLocations.length === 0) {
             this.logger.info.system('IntelService', `Cannot create packet: No *unlocked* deal locations available (excluding ${saleLocationId}).`);
             return null;
        }
        const dealLocationId = possibleDealLocations[Math.floor(Math.random() * possibleDealLocations.length)];

        const commodityId = unlockedCommodities[Math.floor(Math.random() * unlockedCommodities.length)];
        const discountPercent = 0.15 + Math.random() * 0.35; // 15% - 50%
        const durationDays = 30 + Math.floor(Math.random() * 61); // 30 - 90 days
        
        const valueMultiplier = 1.0 + (discountPercent * 2) + (durationDays / 90);
        
        // Logic to prevent duplicate message keys
        const messageKeys = Object.keys(INTEL_CONTENT);
        if (messageKeys.length === 0) {
             this.logger.warn('IntelService', 'Cannot create packet: INTEL_CONTENT is empty.');
             return null;
        }
        
        const availableKeys = messageKeys.filter(key => !unavailableKeys.includes(key));
        let messageKey;

        if (availableKeys.length === 0) {
             this.logger.warn('IntelService', `All message keys for ${saleLocationId} are in use. Reusing a key to generate packet.`);
            messageKey = messageKeys[Math.floor(Math.random() * messageKeys.length)];
        } else {
            messageKey = availableKeys[Math.floor(Math.random() * availableKeys.length)];
        }

        const packet = {
            id: `pkt_${saleLocationId.replace('loc_', '')}_${this.timeService.getCurrentDay()}_${Math.floor(Math.random() * 999)}`,
            locationId: saleLocationId, // (C) Where the packet is SOLD
            dealLocationId: dealLocationId, // (C) Where the DEAL is
            commodityId: commodityId,
            discountPercent: parseFloat(discountPercent.toFixed(2)),
            durationDays: durationDays, // Note: This is now just a base for pricing, not for expiration.
            valueMultiplier: parseFloat(valueMultiplier.toFixed(2)),
            messageKey: messageKey, // Reverted from messageIndex
            isPurchased: false,
        };

        return packet;
    }

    /**
     * Calculates the dynamic price for an intel packet at render time.
     * Price is 10-20% of player's current credits, scaled by the deal's value.
     * @param {object} packet - The intelPacket object.
     * @returns {number} The calculated price, rounded to the nearest 100.
     * @JSDoc
     */
    calculateIntelPrice(packet) {
        const playerCredits = this.gameState.getState().player.credits;
        
        const base = playerCredits * (0.10 + Math.random() * 0.10); 
        const finalPrice = base * packet.valueMultiplier;
        
        return Math.floor(finalPrice / 100) * 100;
    }

    /**
     * Executes the purchase of an intel packet.
     * @param {string} packetId - The ID of the packet to purchase.
     * @param {string} locationId - The location ID where the purchase is happening (sale location).
     * @param {number} calculatedPrice - The price shown to the user (and to be charged).
     * @returns {object | null} The purchased intelPacket object on success, or null on failure.
     * @JSDoc
     */
    purchaseIntel(packetId, locationId, calculatedPrice) {
        
        // --- VIRTUAL WORKBENCH REFACTOR (ADHERING TO MUTABLE ARCHITECTURE) ---
        
        // 1. Read the *current* state ONCE. This is a shallow copy.
        const state = this.gameState.getState();
        
        // 2. Perform all failure checks on this state.
        if (state.activeIntelDeal !== null) {
            this.logger.warn('IntelService', 'Purchase aborted: A deal is already active.');
            return null; // This is what's failing in debug.
        }

        if (state.player.credits < calculatedPrice) {
            this.logger.warn('IntelService', 'Purchase aborted: Insufficient credits.');
            return null;
        }

        // 3. Get the *live* intelMarket object from the state.
        // We will mutate this object directly, as per the app's architecture.
        const intelMarket = state.intelMarket;

        // 4. Find the *live* packet object.
        const packet = intelMarket[locationId]?.find(p => p.id === packetId);

        if (!packet) {
            this.logger.error('IntelService', `Purchase failed: Could not find packetId ${packetId} in live market at ${locationId}.`);
            return null; // This was the other potential failure point.
        }
        
        // 5. Mutate the live packet object.
        packet.isPurchased = true;
        // --- VIRTUAL WORKBENCH: BUG FIX ---
        // Save the price that was paid to the packet object.
        packet.pricePaid = calculatedPrice;
        // --- END BUG FIX ---

        this.logger.info.player(state.day, 'INTEL_PURCHASE', `Purchased intel packet ${packet.id} for ${formatCredits(calculatedPrice)}`);

        // 6. Create a *new* player object for the state update.
        const newPlayerState = { ...state.player };
        newPlayerState.credits -= calculatedPrice;

        // 7. Create the Active Intel Deal
        const galacticAverage = this.marketService.getGalacticAverage(packet.commodityId);
        const overridePrice = Math.floor(galacticAverage * (1 - packet.discountPercent));

        // Calculate dynamic duration
        const currentLocationId = state.currentLocationId;
        const dealLocationId = packet.dealLocationId;
        let travelTime = this.gameState.TRAVEL_DATA[currentLocationId][dealLocationId].time;

        if (state.player.activePerks[PERK_IDS.NAVIGATOR]) {
            travelTime = Math.round(travelTime * this.db.PERKS[PERK_IDS.NAVIGATOR].travelTimeMod);
        }
        
        const newDurationDays = Math.ceil(travelTime * 1.9);
        const expiryDay = this.timeService.getCurrentDay() + newDurationDays;
        
        this.logger.info.system('IntelService', state.day, 'INTEL_DURATION', `Intel deal for ${packet.commodityId} at ${dealLocationId} will last ${newDurationDays} days (Travel: ${travelTime} days * 2.8). Expires on Day ${expiryDay}.`);

        // 8. Mutate the live packet object again.
        packet.expiryDay = expiryDay; 

        const newActiveDeal = {
            locationId: packet.dealLocationId, 
            commodityId: packet.commodityId,
            overridePrice: overridePrice,
            expiryDay: expiryDay,
            sourcePacketId: packet.id,
            sourceSaleLocationId: locationId
        };

        // 9. Push message to NewsTicker
        try {
            const commodityName = this.db.COMMODITIES.find(c => c.id === packet.commodityId)?.name || 'goods';
            const locationName = this.db.MARKETS.find(m => m.id === packet.dealLocationId)?.name || 'a local market';
            let msgTemplate = PURCHASED_INTEL_MESSAGES[Math.floor(Math.random() * PURCHASED_INTEL_MESSAGES.length)];
            let message = msgTemplate.replace('{Commodity Name}', commodityName).replace('{Location Name}', locationName);
            this.newsTickerService.pushMessage(message, 'INTEL', true); 
        } catch (e) {
            this.logger.error('IntelService', 'Failed to push news ticker message.', e);
        }

        // 10. Set the new state *once*.
        // We pass the *mutated* intelMarket and the *new* player/activeDeal.
        this.gameState.setState({ 
            player: newPlayerState,
            activeIntelDeal: newActiveDeal,
            intelMarket: intelMarket // Pass the mutated object to trigger render
        });
        
        // Return the mutated packet
        return packet;
        // --- END REFACTOR ---
    }

    /**
     * Gets the galactic average price for a commodity.
     * @param {string} commodityId - The ID of the commodity.
     * @returns {number} The galactic average price.
     * @JSDoc
     */
    getGalacticAverage(commodityId) {
        return this.marketService.getGalacticAverage(commodityId);
    }

    /**
     * Gets the current game day from the TimeService.
     * @returns {number} The current day.
     * @JSDoc
     */
    getCurrentDay() {
        return this.timeService.getCurrentDay();
    }

    // --- VIRTUAL WORKBENCH REMOVAL ---
    // The entire 'debug_AddAllIntelPackets' method has been removed.
    // --- END REMOVAL ---
}
--- END OF FILE: ./js/services/IntelService.js ---

--- START OF FILE: ./js/services/handlers/MarketEventHandler.js ---
// js/services/handlers/MarketEventHandler.js
/**
 * @fileoverview Handles all user interactions within the market commodity cards,
 * including buy/sell mode toggling, quantity adjustments, and trade confirmations.
 */
import { formatCredits, calculateInventoryUsed } from '../../utils.js';
import { ACTION_IDS } from '../../data/constants.js';

export class MarketEventHandler {
    /**
     * @param {import('../GameState.js').GameState} gameState The central game state object.
     * @param {import('../SimulationService.js').SimulationService} simulationService The core game logic engine.
     * @param {import('../UIManager.js').UIManager} uiManager The UI rendering service.
     */
    constructor(gameState, simulationService, uiManager) {
        this.gameState = gameState;
        this.simulationService = simulationService;
        this.uiManager = uiManager;
    }

    /**
     * Handles real-time input events from the market quantity field.
     * @param {Event} e The input event.
     */
    handleInput(e) {
        const qtyInput = e.target.closest('.transaction-controls input[type="number"]');
        if (qtyInput) {
            const controls = qtyInput.closest('.transaction-controls');
            const { goodId, mode } = controls.dataset;
            const quantity = parseInt(qtyInput.value, 10) || 0;
            this.uiManager.updateMarketCardDisplay(goodId, quantity, mode);

            this._updateMaxButtonState(controls, quantity, mode, goodId);
        }
    }

    /**
     * Handles click events within the market transaction controls.
     * @param {Event} e The click event object.
     * @param {HTMLElement} actionTarget The DOM element with the data-action attribute.
     */
    handleClick(e, actionTarget) {
        const { action } = actionTarget.dataset;

        switch (action) {
            case 'toggle-trade-mode':
            case 'confirm-trade':
            case 'set-max-trade':
            case ACTION_IDS.INCREMENT:
            case ACTION_IDS.DECREMENT:
                this._performMarketAction(actionTarget, action, e);
                break;
        }
    }

    /**
     * Executes a specific market action based on the clicked element.
     * @param {HTMLElement} target - The element that was clicked.
     * @param {string} action - The specific action to perform.
     * @param {Event} [e] - The original click event, for effects.
     * @private
     */
    _performMarketAction(target, action, e) {
        const controls = target.closest('.transaction-controls');
        if (!controls) return;

        const { goodId, mode } = controls.dataset;
        const qtyInput = controls.querySelector('input');
        const state = this.gameState.getState();

        switch (action) {
            case 'toggle-trade-mode': {
                const newMode = mode === 'buy' ? 'sell' : 'buy';
                controls.dataset.mode = newMode;
                const currentQty = parseInt(qtyInput.value) || 0;
                this.uiManager.updateMarketCardDisplay(goodId, currentQty, newMode);

                this._updateMaxButtonState(controls, currentQty, newMode, goodId);
                break;
            }
            case 'confirm-trade': {
                const quantity = parseInt(qtyInput.value) || 0;
                if (quantity <= 0) return;

                const result = (mode === 'buy')
                    ? this.simulationService.buyItem(goodId, quantity)
                    : this.simulationService.sellItem(goodId, quantity);

                if (result) {
                    const value = (mode === 'buy') ? this.uiManager.getItemPrice(state, goodId) * quantity : result;
                    const text = mode === 'buy' ? `-${formatCredits(value, false)}` : `+${formatCredits(value, false)}`;
                    const color = mode === 'buy' ? '#f87171' : '#34d399';
                    this.uiManager.createFloatingText(text, e.clientX, e.clientY, color);

                    // Check for tutorial completion on relevant actions
                    if (mode === 'sell') {
                        const actionData = { type: 'ACTION', action: 'sell-item', goodId };
                        this.simulationService.tutorialService.checkState(actionData);
                    }
                }
                break;
            }
            case 'set-max-trade': {
                const ship = this.simulationService._getActiveShip();
                const inventory = this.simulationService._getActiveInventory();
                if (mode === 'sell') {
                    qtyInput.value = inventory[goodId]?.quantity || 0;
                } else { // 'buy'
                    const price = this.uiManager.getItemPrice(state, goodId);
                    const space = ship.cargoCapacity - calculateInventoryUsed(inventory);
                    const canAfford = price > 0 ? Math.floor(state.player.credits / price) : Infinity;
                    const stock = state.market.inventory[state.currentLocationId][goodId].quantity;
                    qtyInput.value = Math.max(0, Math.min(space, canAfford, stock));
                }
                
                const newQuantity = parseInt(qtyInput.value) || 0;
                this.uiManager.updateMarketCardDisplay(goodId, newQuantity, mode);
                this._updateMaxButtonState(controls, newQuantity, mode, goodId);
                break;
            }
            case ACTION_IDS.INCREMENT:
            case ACTION_IDS.DECREMENT: {
                let val = parseInt(qtyInput.value) || 0;
                const newQuantity = (action === ACTION_IDS.INCREMENT) ? val + 1 : Math.max(0, val - 1);
                qtyInput.value = newQuantity;
                this.uiManager.updateMarketCardDisplay(goodId, newQuantity, mode);
                this._updateMaxButtonState(controls, newQuantity, mode, goodId);
                break;
            }
        }
    }

    /**
     * Checks if the current quantity equals the max possible quantity
     * and updates the 'MAX' button's .pressed state.
     * @param {HTMLElement} controls - The .transaction-controls element.
     * @param {number} currentQty - The current quantity from the input field.
     * @param {string} mode - The current trade mode ('buy' or 'sell').
     * @param {string} goodId - The ID of the commodity.
     * @private
     */
    _updateMaxButtonState(controls, currentQty, mode, goodId) {
        const state = this.gameState.getState();
        const ship = this.simulationService._getActiveShip();
        const inventory = this.simulationService._getActiveInventory();
        let maxQty;

        if (mode === 'sell') {
            maxQty = inventory[goodId]?.quantity || 0;
        } else { // 'buy'
            const price = this.uiManager.getItemPrice(state, goodId);
            const space = ship.cargoCapacity - calculateInventoryUsed(inventory);
            const canAfford = price > 0 ? Math.floor(state.player.credits / price) : Infinity;
            const stock = state.market.inventory[state.currentLocationId][goodId].quantity;
            maxQty = Math.max(0, Math.min(space, canAfford, stock));
        }

        const maxBtn = controls.querySelector('.max-btn');
        if (currentQty > 0 && currentQty === maxQty) { // Don't press if max is 0
            maxBtn.classList.add('pressed');
        } else {
            maxBtn.classList.remove('pressed');
        }
    }
}
--- END OF FILE: ./js/services/handlers/MarketEventHandler.js ---

--- START OF FILE: ./js/services/handlers/HoldEventHandler.js ---
// js/services/handlers/HoldEventHandler.js
/**
 * @fileoverview This file defines the HoldEventHandler class, which manages
 * the "hold-to-act" (press and hold) functionality for UI elements.
 *
 * This handler is responsible for:
 * 1. Detecting 'pointerdown' events on target buttons.
 * 2. Immediately starting a "tick loop" (via requestAnimationFrame) on press.
 * 3. Calling the appropriate PlayerActionService function on each "tick" of the loop.
 * 4. Stopping the loop on 'pointerup' or 'pointercancel'.
 * 5. Managing all visual feedback (CSS classes) associated with the hold state.
 *
 * @architecture
 * This class uses a robust, persistent, and delegated event listener model
 * to solve "sticky button" / "toggle" bugs caused by UI re-renders (common in
 * frameworks or when state changes, like on iOS WKWebView).
 *
 * 1.  **Pointer Events**: Uses the modern Pointer Events API (`pointerdown`, `pointerup`,
 * `pointercancel`) for unified handling of mouse and touch.
 *
 * 2.  **Delegated "Start"**: A *single*, *persistent* `pointerdown` listener
 * is attached to `document.body`. This listener never gets destroyed by
 * re-renders. It checks `e.target` to delegate the event to the
 * correct function (e.g., `_startRefueling`).
 *
 * 3.  **Capture-Phase "Stop"**: *Single*, *persistent* `pointerup` and
 * `pointercancel` listeners are attached to the `window` object using
 * `{ capture: true }`.
 * - **Why window?**: It catches the event even if the pointer is released
 * outside the original button.
 * - **Why capture: true?**: This is the crucial part. It ensures this
 * "stop" listener fires during the *capture* phase (traveling *down*
 * from window to target), *before* any other listeners. This prevents
 * the UI re-render from destroying the element and stopping event
 * propagation, which was the root cause of the "sticky" bug.
 *
 * 4.  **State-Based Logic**: The `_start...` and `_stop...` functions DO NOT
 * add or remove event listeners. They *only* set internal state flags
 * (e.g., `this.activeElementId`, `this.isRefueling`). The persistent
 * listeners check this state to decide what to do.
 */

import { formatCredits } from '../../utils.js';

/**
 * Manages hold-to-act (e.g., refuel, repair) interactions on the UI.
 * This class adds event listeners for mousedown/touchstart and mouseup/touchend
 * to specified buttons and executes a callback function repeatedly while held.
 */
export class HoldEventHandler {
    /**
     * @param {import('../player/PlayerActionService.js').PlayerActionService} playerActionService
     * @param {import('../UIManager.js').UIManager} uiManager
     */
    constructor(playerActionService, uiManager) {
        this.playerActionService = playerActionService;
        this.uiManager = uiManager;

        this.refuelBtn = null;
        this.repairBtn = null;

        /** @type {boolean} Flag: Is the refueling loop active? */
        this.isRefueling = false;
        /** @type {boolean} Flag: Is the repairing loop active? */
        this.isRepairing = false;

        /** @type {number} Milliseconds between service ticks */
        this.holdInterval = 400;

        /** @type {number} Timestamp of the last loop tick */
        this.lastTickTime = 0;
        /** @type {number | null} ID for the requestAnimationFrame loop */
        this.animationFrameId = null;

        /** @type {string | null} The ID of the element currently being held */
        this.activeElementId = null;

        /**
         * @type {Object<string, number | null>}
         * Timers for fading out visual effects *after* a hold is released.
         */
        this.stopTimers = {
            fuel: null,
            repair: null
        };

        // --- Bind master handlers that will be persistent ---
        this._boundHandleInteractionStart = this._handleInteractionStart.bind(this);
        this._boundHandleInteractionStop = this._handleInteractionStop.bind(this);
        this._boundHandlePointerMove = this._handlePointerMove.bind(this);

        // --- Bind core functions ---
        this._boundLoop = this._loop.bind(this);
        this._boundStartRefueling = this._startRefueling.bind(this);
        this._boundStopRefueling = this._stopRefueling.bind(this);
        this._boundStartRepairing = this._startRepairing.bind(this);
        this._boundStopRepairing = this._stopRepairing.bind(this);
        this._boundStopStepperHold = this._stopStepperHold.bind(this);
        
        // --- Stepper logic ---
        this.isStepperHolding = false;
        // --- VIRTUAL WORKBENCH: BUG FIX ---
        // Reduced initial delay for better responsiveness.
        this.stepperInitialDelay = 400;
        // --- END VIRTUAL WORKBENCH ---
        this.stepperRepeatRate = 1000 / 7;
        this.stepperTimeout = null;
        this.stepperInterval = null;
        this.stepperStartTime = null;
        /** @type {object | null} The state for the active stepper */
        this.stepperTarget = null;
    }

    /**
     * Binds all hold-to-act event listeners using delegation.
     * This function should be called ONCE when the application initializes.
     * It adds persistent listeners to the body and window.
     * @see {@link HoldEventHandler} file-level comment for architecture details.
     */
    bindHoldEvents() {
        // --- Use Pointer Events for unified mouse/touch ---

        // Add persistent "start" listener to the document body (delegation)
        document.body.removeEventListener('pointerdown', this._boundHandleInteractionStart);
        document.body.addEventListener('pointerdown', this._boundHandleInteractionStart);
        
        // Add persistent "stop" listeners to the window on the CAPTURE phase
        window.removeEventListener('pointerup', this._boundHandleInteractionStop, { capture: true });
        window.addEventListener('pointerup', this._boundHandleInteractionStop, { capture: true });
        
        window.removeEventListener('pointercancel', this._boundHandleInteractionStop, { capture: true });
        window.addEventListener('pointercancel', this._boundHandleInteractionStop, { capture: true });
        
        // Add persistent "move" listener to the window
        window.removeEventListener('pointermove', this._boundHandlePointerMove);
        window.addEventListener('pointermove', this._boundHandlePointerMove, { passive: false });

        // --- Clean up old mouse/touch listeners (if any) ---
        document.body.removeEventListener('mousedown', this._boundHandleInteractionStart);
        document.body.removeEventListener('touchstart', this._boundHandleInteractionStart);
        window.removeEventListener('mouseup', this._boundHandleInteractionStop, { capture: true });
        window.removeEventListener('touchend', this._boundHandleInteractionStop, { capture: true });
        window.removeEventListener('touchcancel', this._boundHandleInteractionStop, { capture: true });
        window.removeEventListener('touchmove', this._boundHandlePointerMove);
    }

    /**
     * Master "start" handler for pointerdown, bound to document.body.
     * Delegates to the correct specific handler based on the event target.
     * @param {PointerEvent} e - The pointerdown event.
     * @private
     */
    _handleInteractionStart(e) {
        // Do not start a new action if one is already active
        if (this.activeElementId || this.stepperTarget) {
            return;
        }

        const refuelBtn = e.target.closest('#refuel-btn');
        if (refuelBtn && !refuelBtn.disabled) {
            this._startRefueling(e);
            return;
        }

        const repairBtn = e.target.closest('#repair-btn');
        if (repairBtn && !repairBtn.disabled) {
            this._startRepairing(e);
            return;
        }

        const stepperBtn = e.target.closest('.qty-stepper button');
        if (stepperBtn && !stepperBtn.disabled) {
            // --- VIRTUAL WORKBENCH MODIFICATION ---
            // Prevent default browser actions (like text selection or context menu)
            // on touch-hold, which would otherwise fire 'pointercancel'
            // and stop our hold logic before it starts.
            if (e.pointerType === 'touch') {
                e.preventDefault();
            }
            // Pass the event 'e' to set pointer capture, just like refuel/repair
            this._startStepperHold(e, stepperBtn);
            // --- END MODIFICATION ---
            return;
        }
    }

    /**
     * Master "stop" handler for pointerup/pointercancel, bound to window.
     * Delegates to the correct "stop" function based on the active state.
     * This fires on the CAPTURE phase to prevent re-renders from killing the event.
     * @param {PointerEvent} e - The pointer event.
     * @private
     */
    _handleInteractionStop(e) {
        // Delegate to the correct stop function based on what is active
        if (this.activeElementId === 'refuel-btn') {
            this._stopRefueling();
        } else if (this.activeElementId === 'repair-btn') {
            this._stopRepairing();
        } else if (this.stepperTarget) {
            this._stopStepperHold();
        }
    }


     /**
     * Master "move" handler for pointermove, bound to window.
     * Stops the action if the pointer moves off the active button.
     * This is primarily for 'touch' pointer types.
     * @param {PointerEvent} e - The pointermove event.
     * @private
     */
    _handlePointerMove(e) {
        // Only run if a service button is being held
        if (this.activeElementId !== 'refuel-btn' && this.activeElementId !== 'repair-btn') {
            return;
        }

        // We only care about touch-like pointers for move-off-to-cancel
        if (e.pointerType !== 'touch') {
            return;
        }

        const elementUnderTouch = document.elementFromPoint(e.clientX, e.clientY);

        if (!elementUnderTouch) {
            // Finger likely moved off-screen, treat as release
            if (this.activeElementId === 'refuel-btn') this._stopRefueling();
            if (this.activeElementId === 'repair-btn') this._stopRepairing();
            return;
        }

        if (elementUnderTouch.classList.contains('floating-text')) {
            return; // Ignore floating text
        }

        const currentActiveButton = document.getElementById(this.activeElementId);
        if (elementUnderTouch === currentActiveButton || (currentActiveButton && currentActiveButton.contains(elementUnderTouch))) {
            return; // Finger is still on the button.
        }

        // Finger has definitively moved off the button.
        if (this.activeElementId === 'refuel-btn') this._stopRefueling();
        if (this.activeElementId === 'repair-btn') this._stopRepairing();
    }

    /**
     * The main game loop for handling hold actions.
     * Runs via requestAnimationFrame.
     * @param {number} timestamp - The current high-resolution timestamp.
     * @private
     */
    _loop(timestamp) {
        // Stop condition: If no service is active, kill the animation frame.
        if (!this.isRefueling && !this.isRepairing) {
            this.animationFrameId = null;
            return;
        }

        let serviceStillActive = false; // Flag to see if we should continue the loop

        // Check if enough time has passed since the last tick
        if (timestamp - this.lastTickTime >= this.holdInterval) {
            this.lastTickTime = timestamp;
            let cost = 0;

            this.refuelBtn = document.getElementById('refuel-btn');
            this.repairBtn = document.getElementById('repair-btn');

            if (this.isRefueling) {
                cost = this.playerActionService.refuelTick();
                this._applyVisuals('fuel'); 
                
                if (cost > 0 && this.refuelBtn) {
                    const rect = this.refuelBtn.getBoundingClientRect();
                    this.uiManager.createFloatingText(`-${formatCredits(cost, false)}`, rect.left + (rect.width / 2), rect.top, '#f87171');
                    serviceStillActive = true;
                } else {
                    this.isRefueling = false; // Ran out of money or tank is full
                }
            }

            if (this.isRepairing) {
                cost = this.playerActionService.repairTick();
                this._applyVisuals('repair');
                
                if (cost > 0 && this.repairBtn) {
                    const rect = this.repairBtn.getBoundingClientRect();
                    this.uiManager.createFloatingText(`-${formatCredits(cost, false)}`, rect.left + (rect.width / 2), rect.top, '#f87171');
                    serviceStillActive = true;
                } else {
                    this.isRepairing = false; // Ran out of money or hull is full
                }
            }

            // If both services stopped (e.g., ran out of money), remove visuals
            if (!serviceStillActive) {
                 if (!this.isRefueling && this.activeElementId === 'refuel-btn') this._removeVisualsWithDelay('fuel');
                 if (!this.isRepairing && this.activeElementId === 'repair-btn') this._removeVisualsWithDelay('repair');
            }
        }

        // Continue animation loop ONLY if a service is still set to 'true'
        // (i.e., hasn't been stopped by a 'stop' event or by running out of money/fuel)
        if (this.isRefueling || this.isRepairing) {
            this.animationFrameId = requestAnimationFrame(this._boundLoop);
        } else {
            this.animationFrameId = null;
        }
    }


    /**
     * Applies active visual classes to a service module.
     * @param {string} type - 'fuel' or 'repair'
     * @private
     */
    _applyVisuals(type) {
        if (type === 'fuel' && this.stopTimers.fuel) {
            clearTimeout(this.stopTimers.fuel);
            this.stopTimers.fuel = null;
        }
        if (type === 'repair' && this.stopTimers.repair) {
            clearTimeout(this.stopTimers.repair);
            this.stopTimers.repair = null;
        }

        const currentRefuelBtn = document.getElementById('refuel-btn');
        const currentRepairBtn = document.getElementById('repair-btn');
        const btn = type === 'fuel' ? currentRefuelBtn : currentRepairBtn;
        const barId = type ==='fuel' ? 'fuel-bar' : 'repair-bar';

        if (btn) {
            btn.classList.add('holding');
            const serviceModule = btn.closest('.service-module');
            if (serviceModule) serviceModule.classList.add('active-service');

            const progressBarFill = document.getElementById(barId);
            if (progressBarFill) {
                progressBarFill.classList.add('filling');
                const progressBarContainer = progressBarFill.closest('.progress-bar-container');
                if (progressBarContainer) progressBarContainer.classList.add('active-pulse');
            }
        }
    }

    /**
     * Removes active visual classes from a service module after a delay.
     * @param {string} type - 'fuel' or 'repair'
     * @private
     */
    _removeVisualsWithDelay(type) {
        if (type === 'fuel') {
            if (this.stopTimers.fuel) clearTimeout(this.stopTimers.fuel);
            this.stopTimers.fuel = setTimeout(() => {
                this._removeVisuals('fuel');
                this.stopTimers.fuel = null;
            }, 400);
        } else if (type === 'repair') {
            if (this.stopTimers.repair) clearTimeout(this.stopTimers.repair);
             this.stopTimers.repair = setTimeout(() => {
                this._removeVisuals('repair');
                this.stopTimers.repair = null;
            }, 400);
        }
    }

    /**
     * Immediately removes active visual classes (used internally by delayed removal).
     * @param {string} type - 'fuel' or 'repair'
     * @private
     */
     _removeVisuals(type) {
        const currentRefuelBtn = document.getElementById('refuel-btn');
        const currentRepairBtn = document.getElementById('repair-btn');
        const btn = type === 'fuel' ? currentRefuelBtn : currentRepairBtn;
        const barId = type === 'fuel' ? 'fuel-bar' : 'repair-bar';

        if (btn) {
            btn.classList.remove('holding');
            const serviceModule = btn.closest('.service-module');
            if (serviceModule) serviceModule.classList.remove('active-service');

            const progressBarFill = document.getElementById(barId);
            if (progressBarFill) {
                 progressBarFill.classList.remove('filling');
                const progressBarContainer = progressBarFill.closest('.progress-bar-container');
                if (progressBarContainer) progressBarContainer.classList.remove('active-pulse');
            }
        }
    }


    /**
     * Starts the tap/hold process for refueling.
     * This function *only* sets state. It does NOT add event listeners.
     * @param {PointerEvent} e - The pointerdown event.
     * @private
     */
    _startRefueling(e) {
        if (e.button && e.button !== 0) return; // Ignore right-clicks

        // Prevent default only for touch-like pointers
        if (e.pointerType === 'touch') {
            e.preventDefault();
        }

        this.refuelBtn = e.target.closest('#refuel-btn');
        if (!this.refuelBtn) return;

        // Explicitly set pointer capture for this element
        // This helps ensure 'pointerup' fires reliably
        try {
            this.refuelBtn.setPointerCapture(e.pointerId);
        } catch (err) {
            // This can fail if the element is removed, etc.
        }


        this.activeElementId = this.refuelBtn.id;
        this.isRefueling = true;

        this._applyVisuals('fuel'); 

        // Set last tick time to the past so the loop fires its first tick IMMEDIATELY
        this.lastTickTime = performance.now() - this.holdInterval;
        
        if (!this.animationFrameId) {
            this.animationFrameId = requestAnimationFrame(this._boundLoop);
        }
    }

    /**
     * Stops the tap/hold process for refueling.
     * This function *only* sets state. It does NOT remove event listeners.
     * @private
     */
    _stopRefueling() {
        if (this.activeElementId !== 'refuel-btn') {
            return;
        }
        
        // Try to release pointer capture if it exists
        const btn = document.getElementById(this.activeElementId);
        if (btn && btn.hasPointerCapture(1)) { // '1' is the primary pointerId for touch/mouse
             try {
                // We don't have the original e.pointerId, but this is a best-effort
             } catch (err) {
                 // ignore
             }
        }

        this.activeElementId = null;
        this.isRefueling = false; // This will stop the loop

        this._removeVisualsWithDelay('fuel'); // Remove visuals ONCE
    }

     /**
     * Starts the tap/hold process for repairing.
     * This function *only* sets state. It does NOT add event listeners.
     * @param {PointerEvent} e - The pointerdown event.
     * @private
     */
    _startRepairing(e) {
        if (e.button && e.button !== 0) return; // Ignore right-clicks

        if (e.pointerType === 'touch') {
            e.preventDefault();
        }

        this.repairBtn = e.target.closest('#repair-btn');
        if (!this.repairBtn) return;

        // Explicitly set pointer capture for this element
        try {
            this.repairBtn.setPointerCapture(e.pointerId);
        } catch (err) {
            // console.warn("Could not set pointer capture:", err.message);
        }


        this.activeElementId = this.repairBtn.id;
        this.isRepairing = true;

        this._applyVisuals('repair');

        // Set last tick time to the past so the loop fires its first tick IMMEDIATELY
        this.lastTickTime = performance.now() - this.holdInterval;

        if (!this.animationFrameId) {
            this.animationFrameId = requestAnimationFrame(this._boundLoop);
        }
    }

    /**
     * Stops the tap/hold process for repairing.
     * This function *only* sets state. It does NOT remove event listeners.
     * @private
     */
    _stopRepairing() {
         if (this.activeElementId !== 'repair-btn') {
            return;
        }

        this.activeElementId = null;
        this.isRepairing = false; // This will stop the loop

        this._removeVisualsWithDelay('repair'); // Remove visuals ONCE
    }

     // --- VIRTUAL WORKBENCH MODIFICATIONS TO STEPPER LOGIC ---
     
    /**
     * Starts the tap/hold process for a market quantity stepper.
     * @param {PointerEvent} e - The 'pointerdown' event.
     * @param {HTMLElement} button - The stepper button that was pressed.
     * @private
     */
     _startStepperHold(e, button) {
        this._stopStepperHold(); // Clear any previous
        this.isStepperHolding = false;

        const controls = button.closest('.transaction-controls');
        if (!controls) return;

        // Set pointer capture to ensure 'pointerup' fires reliably
        try {
            button.setPointerCapture(e.pointerId);
        } catch (err) {
            // ignore
        }

        // --- VIRTUAL WORKBENCH: BUG FIX ---
        // Prevent default browser actions (like text selection or context menu)
        // on touch-hold or mouse-drag, which would otherwise fire 'pointercancel'
        // and stop our hold logic before it starts.
        e.preventDefault();
        // --- END VIRTUAL WORKBENCH ---

        const qtyStepperEl = button.closest('.qty-stepper');
        const qtyInput = controls.querySelector('input');
        const direction = button.classList.contains('qty-up') ? 1 : -1;
        
        // Store all necessary state for the hold
        this.stepperTarget = {
            input: qtyInput,
            direction: direction,
            element: qtyStepperEl,
            button: button,
            pointerId: e.pointerId
        };

        // Start the timer for the auto-increment
        this.stepperTimeout = setTimeout(() => {
            this.isStepperHolding = true; // Flag to suppress click on release
            this.stepperStartTime = Date.now();

            if (this.stepperTarget && this.stepperTarget.element) {
                this.stepperTarget.element.classList.add('stepper-active');
            }

            this._stepperTick(); // Fire the first tick immediately
            // Start the repeating interval
            this.stepperInterval = setInterval(() => this._stepperTick(), this.stepperRepeatRate);
        }, this.stepperInitialDelay);
    }

    /**
     * Stops the tap/hold process for the market quantity stepper.
     * @private
     */
    _stopStepperHold() {
        // This function is now called by the master _handleInteractionStop
        
        if (!this.stepperTarget) return;

        // Release pointer capture
        if (this.stepperTarget.button && this.stepperTarget.button.hasPointerCapture(this.stepperTarget.pointerId)) {
            try {
                this.stepperTarget.button.releasePointerCapture(this.stepperTarget.pointerId);
            } catch (err) {
                // ignore
            }
        }

        // Clear all timers
        clearTimeout(this.stepperTimeout);
        clearInterval(this.stepperInterval);

        // Remove active visual state
        if (this.stepperTarget.element) {
            this.stepperTarget.element.classList.remove('stepper-active');
        }

        // --- VIRTUAL WORKBENCH: BUG FIX ---
        // DO NOT reset this.isStepperHolding here.
        // It must be reset by EventManager *after* the click event is suppressed.
        // this.isStepperHolding = false; // <-- This line is removed.
        // --- END VIRTUAL WORKBENCH ---

        // Clear the state
        this.stepperTimeout = null;
        this.stepperInterval = null;
        this.stepperStartTime = null;
        this.stepperTarget = null;
    }

    /**
     * Executes a single "tick" of the stepper, auto-incrementing the value.
     * @private
     */
     _stepperTick() {
        if (!this.stepperTarget) {
            this._stopStepperHold();
            return;
        }

        const { input, direction } = this.stepperTarget;
        const holdDuration = (Date.now() - this.stepperStartTime) / 1000;
        
        // Accelerate the step amount based on hold duration
        let step = 1;
        if (holdDuration > 5) step = 25;
        else if (holdDuration > 2) step = 5;

        let currentValue = parseInt(input.value, 10) || 0;
        currentValue += step * direction;
        input.value = Math.max(0, currentValue); // Ensure value is not negative

        // Dispatch an 'input' event so the MarketEventHandler updates the UI
        input.dispatchEvent(new Event('input', { bubbles: true, cancelable: true }));
    }
}
--- END OF FILE: ./js/services/handlers/HoldEventHandler.js ---

--- START OF FILE: ./js/services/handlers/ActionClickHandler.js ---
// js/services/handlers/ActionClickHandler.js
/**
 * @fileoverview Handles the primary routing of 'data-action' click events,
 * delegating them to the appropriate services. This module focuses on general
 * actions like navigation, modal triggers, and simple state changes, while
 * more complex interactions are handled by other specialized handlers.
 */
import { DB } from '../../data/database.js';
import { ACTION_IDS, NAV_IDS, SCREEN_IDS } from '../../data/constants.js';
import { formatCredits } from '../../utils.js';

export class ActionClickHandler {
    /**
     * @param {import('../GameState.js').GameState} gameState The central game state object.
     * @param {import('../SimulationService.js').SimulationService} simulationService The core game logic engine.
     * @param {import('../UIManager.js').UIManager} uiManager The UI rendering service.
     * @param {import('../TutorialService.js').TutorialService} tutorialService The tutorial management service.
     */
    constructor(gameState, simulationService, uiManager, tutorialService) {
        this.gameState = gameState;
        this.simulationService = simulationService;
        this.uiManager = uiManager;
        this.tutorialService = tutorialService;
    }

    /**
     * Handles a delegated click event if it matches a data-action.
     * @param {Event} e The click event object.
     * @param {HTMLElement} actionTarget The DOM element with the data-action attribute.
     */
    async handle(e, actionTarget) { // <-- Add async
        const state = this.gameState.getState();
        if (actionTarget.hasAttribute('disabled')) return;

        const { action, ...dataset } = actionTarget.dataset;
        let actionData = null; // For the TutorialService

        switch (action) {
            // --- Ship Actions (Hangar/Shipyard) ---
            case ACTION_IDS.BUY_SHIP: {
                const { shipId } = dataset;
                if (!shipId) return;
                e.stopPropagation();
                await this.simulationService.buyShip(shipId, e); // <-- Add await
                actionData = { type: 'ACTION', action: ACTION_IDS.BUY_SHIP };
                break;
            }
            case ACTION_IDS.SELL_SHIP: {
                const { shipId } = dataset;
                if (!shipId) return;
                e.stopPropagation();
                await this.simulationService.sellShip(shipId, e); // <-- Add await
                break;
            }
            // --- VIRTUAL WORKBENCH: MODIFICATION (Phase 5) ---
            case ACTION_IDS.SELECT_SHIP: {
                const { shipId } = dataset;
                if (!shipId) return;
                e.stopPropagation(); // Prevent any other clicks
                await this.simulationService.boardShip(shipId, e); // <-- Asynchronous
                // actionData is now set *inside* SimulationService.boardShip
                break;
            }
            // --- END VIRTUAL WORKBENCH ---

            // --- [[START]] VIRTUAL WORKBENCH (Phase 3) ---
            // REMOVED 'show_ship_info' case
            // --- [[END]] VIRTUAL WORKBENCH (Phase 3) ---
    
            // --- Hangar UI ---
            case ACTION_IDS.TOGGLE_HANGAR_MODE:
                if (dataset.mode && this.gameState.uiState.hangarShipyardToggleState !== dataset.mode) {
                    this.gameState.uiState.hangarShipyardToggleState = dataset.mode;
                    this.gameState.setState({});
                }
                break;
            case ACTION_IDS.SET_HANGAR_PAGE: {
                const isHangarMode = this.gameState.uiState.hangarShipyardToggleState === 'hangar';
                const currentIndex = isHangarMode ? this.gameState.uiState.hangarActiveIndex : this.gameState.uiState.shipyardActiveIndex;
                const shipList = isHangarMode ? state.player.ownedShipIds : this.simulationService._getShipyardInventory();
                const totalItems = shipList.length;

                let newIndex;
                const JUMP_DISTANCE = 5; // How many pages to jump with half-dots

                if (dataset.jumpDirection) {
                    if (dataset.jumpDirection === 'next') {
                        newIndex = Math.min(totalItems - 1, currentIndex + JUMP_DISTANCE);
                    } else { // 'prev'
                        newIndex = Math.max(0, currentIndex - JUMP_DISTANCE);
                    }
                } else {
                    newIndex = parseInt(dataset.index, 10);
                }

                if (isNaN(newIndex)) return;

                const carousel = document.getElementById('hangar-carousel');
                if (carousel) {
                    const pagesToSkip = Math.abs(newIndex - currentIndex);
                    const duration = Math.min(0.8, 0.2 + pagesToSkip * 0.1);
                    carousel.style.transitionDuration = `${duration}s`;

                    this.simulationService.setHangarCarouselIndex(newIndex, isHangarMode ? 'hangar' : 'shipyard');

                    setTimeout(() => {
                        if (carousel) carousel.style.transitionDuration = '';
                    }, duration * 1000);
                } else {
                    this.simulationService.setHangarCarouselIndex(newIndex, isHangarMode ? 'hangar' : 'shipyard');
                }
                break;
            }

            // --- Navigation & Screen Changes ---
            case ACTION_IDS.SET_SCREEN: {
                // This is the "smarter" logic you described.
                // We check if the *actual* click target (e.target) was a sub-nav button.
                // We assume sub-nav buttons are <a> tags inside the main nav's data-action target.
                const isSubNavClick = e.target.tagName === 'A' && actionTarget.contains(e.target);

                if (dataset.navId === state.activeNav && !isSubNavClick) {
                    // This is a TRUE 2nd-tap on the MAIN nav tab. Toggle the sub-nav.
                    this.gameState.subNavCollapsed = !this.gameState.subNavCollapsed;
                    this.uiManager.render(this.gameState.getState());
                } else {
                    // This is a click on a NEW main nav tab OR a click on ANY sub-nav button.
                    // In both cases, we want to show the sub-nav and set the screen.
                    this.gameState.subNavCollapsed = false;
                    this.simulationService.setScreen(dataset.navId, dataset.screenId);
                }
                actionData = { type: 'ACTION', action: ACTION_IDS.SET_SCREEN, navId: dataset.navId, screenId: dataset.screenId };
                break;
            }
            case ACTION_IDS.TRAVEL:
                this.uiManager.hideModal('launch-modal');
                this.simulationService.travelTo(dataset.locationId);
                actionData = { type: 'ACTION', action: ACTION_IDS.TRAVEL };
                break;

            // --- VIRTUAL WORKBENCH: ADD INTEL ACTIONS ---
            case 'set-intel-tab':
                this.uiManager.handleSetIntelTab(actionTarget);
                break;
            case 'show_intel_offer':
                this.uiManager.handleShowIntelOffer(actionTarget);
                break;
            // --- VIRTUAL WORKBENCH START: Phase 5 ---
            case 'buy_intel':
                this.uiManager.handleBuyIntel(actionTarget, e);
                break;
            // --- VIRTUAL WORKBENCH END: Phase 5 ---
            case 'show_intel_details':
                this.uiManager.handleShowIntelDetails(actionTarget);
                break;
            // --- END VIRTUAL WORKBENCH ---

            // --- Modals ---
            case 'show-mission-modal':
                this.uiManager.showMissionModal(dataset.missionId);
                actionData = { type: 'ACTION', action: 'show-mission-modal' };
                break;
            case 'show_cargo_detail':
                this.uiManager.showCargoDetailModal(state, dataset.goodId);
                break;
            case 'show-launch-modal':
                this.uiManager.showLaunchModal(dataset.locationId);
                break;
            case 'show-map-modal':
                this.uiManager.showMapDetailModal(dataset.locationId);
                break;
            case 'close-map-modal':
                this.uiManager.hideMapDetailModal();
                break;
            
            // [[START]] VIRTUAL WORKBENCH (EULA Modal)
            case 'show_eula_modal':
                e.preventDefault();
                this.uiManager.showEulaModal();
                break;
            // [[END]] VIRTUAL WORKBENCH (EULA Modal)

            
            // --- Mission Actions ---
            case 'accept-mission':
                this.simulationService.missionService.acceptMission(dataset.missionId);
                this.uiManager.hideModal('mission-modal');
                actionData = { type: 'ACTION', action: 'accept-mission', missionId: dataset.missionId };
                break;
            case 'abandon-mission':
                this.simulationService.missionService.abandonMission();
                this.uiManager.hideModal('mission-modal');
                break;
            case 'complete-mission':
                this.simulationService.missionService.completeActiveMission();
                this.uiManager.hideModal('mission-modal');
                actionData = { type: 'ACTION', action: 'complete-mission' };
                break;

            // --- Finance & Licenses ---
            // --- VIRTUAL WORKBENCH: MODIFIED (Point C) ---
            // Pass the event object 'e' to the service layer
            case ACTION_IDS.PAY_DEBT:
                this.simulationService.payOffDebt(e);
                break;
            case ACTION_IDS.TAKE_LOAN:
                this.simulationService.takeLoan(JSON.parse(dataset.loanDetails), e);
                break;
            // --- END VIRTUAL WORKBENCH ---
            case ACTION_IDS.PURCHASE_INTEL:
                // This is now obsolete, but we'll leave it in case any old UI elements still call it.
                // The new flow is show_intel_offer -> buy_intel
                this.logger.warn('ActionClickHandler', 'Obsolete ACTION_IDS.PURCHASE_INTEL called.');
                break;
            case ACTION_IDS.ACQUIRE_LICENSE:
                this._handleAcquireLicense(dataset.licenseId, e);
                break;

            // --- Market Card Minimization ---
            case ACTION_IDS.TOGGLE_MARKET_CARD_VIEW:
                if (dataset.goodId) {
                    this.gameState.uiState.marketCardMinimized[dataset.goodId] = !this.gameState.uiState.marketCardMinimized[dataset.goodId];
                    this.gameState.setState({});
                }
                break;
        }

        if (actionData) {
            this.tutorialService.checkState(actionData);
        }
    }

    /**
     * Handles the UI flow for acquiring a trade license.
     * @param {string} licenseId The ID of the license to acquire.
     * @param {Event} [e] The original click event for positioning floating text.
     * @private
     */
    _handleAcquireLicense(licenseId, e) {
        const license = DB.LICENSES[licenseId];
        if (!license) return;

        if (license.type === 'purchase') {
            // --- VIRTUAL WORKBENCH START: Phase 2 ---
            const description = `${license.description}<br><br>Cost: <span class="text-glow-red">${formatCredits(-license.cost, true)}</span>`;
            // --- VIRTUAL WORKBENCH END: Phase 2 ---
            this.uiManager.queueModal('event-modal', `Purchase ${license.name}?`, description, null, {
                // --- VIRTUAL WORKBENCH: BUG FIX ---
                // Add dismissOutside: true to allow the modal to be closed
                dismissOutside: true,
                // --- END VIRTUAL WORKBENCH ---
                customSetup: (modal, closeHandler) => {
                    const btnContainer = modal.querySelector('#event-button-container');
                    btnContainer.innerHTML = `
                        <button id="confirm-license-purchase" class="btn btn-pulse-green">Confirm</button>
                        <button id="cancel-license-purchase" class="btn">Cancel</button>
                    `;
                    modal.querySelector('#confirm-license-purchase').onclick = () => {
                        const result = this.simulationService.purchaseLicense(licenseId);

                        if (result.success) {
                            if (e) {
                                this.uiManager.createFloatingText(`-${formatCredits(license.cost, false)}`, e.clientX, e.clientY, '#f87171');
                            }
                        } else if (result.error === 'INSUFFICIENT_FUNDS') {
                            this.uiManager.queueModal('event-modal', 'Purchase Failed', `You cannot afford the ${formatCredits(license.cost)} fee for this license.`);
                        }
                        closeHandler();
                    };
                    modal.querySelector('#cancel-license-purchase').onclick = closeHandler;
                }
            });
        } else if (license.type === 'mission') {
            this.uiManager.queueModal('event-modal', license.name, license.guidanceText);
        }
    }
}
--- END OF FILE: ./js/services/handlers/ActionClickHandler.js ---

--- START OF FILE: ./js/services/handlers/TooltipHandler.js ---
// js/services/handlers/TooltipHandler.js
/**
 * @fileoverview Manages the display and lifecycle of tooltips, price graphs,
 * and other contextual pop-ups that appear on user interaction (hover or click).
 */
import { ACTION_IDS } from '../../data/constants.js';

export class TooltipHandler {
    /**
     * @param {import('../GameState.js').GameState} gameState The central game state object.
     * @param {import('../UIManager.js').UIManager} uiManager The UI rendering service.
     */
    constructor(gameState, uiManager) {
        this.gameState = gameState;
        this.uiManager = uiManager;
        this.activeTooltipTarget = null;
        this.activeStatusTooltip = null;
    }

    /**
     * Handles click events to manage tooltips, primarily for mobile and special cases.
     * @param {Event} e The click event.
     */
    handleClick(e) {
        const actionTarget = e.target.closest('[data-action]');

        // --- Pre-action Cleanup ---
        if (this.activeStatusTooltip && !this.uiManager.isClickInside(e, '[data-action="toggle-tooltip"]')) {
            this.activeStatusTooltip.classList.remove('visible');
            this.activeStatusTooltip = null;
        }
        if (this.uiManager.isClickInside(e, '#graph-tooltip, #generic-tooltip')) {
            this.uiManager.hideGraph();
            this.uiManager.hideGenericTooltip();
            this.activeTooltipTarget = null;
            return;
        }
        if (this.activeTooltipTarget && actionTarget !== this.activeTooltipTarget) {
            this.uiManager.hideGraph();
            this.uiManager.hideGenericTooltip();
            this.activeTooltipTarget = null;
        }
        
        // --- Action Handling ---
        if (actionTarget) {
            const { action } = actionTarget.dataset;
            switch(action) {
                case 'toggle-tooltip':
                    this._toggleStatusTooltip(actionTarget);
                    return;
                case ACTION_IDS.SHOW_PRICE_GRAPH:
                case ACTION_IDS.SHOW_FINANCE_GRAPH:
                    if (this.uiManager.isMobile) {
                        this.uiManager.hideGenericTooltip();
                        if (this.activeTooltipTarget === actionTarget) {
                            this.uiManager.hideGraph();
                            this.activeTooltipTarget = null;
                        } else {
                            this.uiManager.showGraph(actionTarget, this.gameState.getState());
                            this.activeTooltipTarget = actionTarget;
                        }
                    }
                    break;
            }
        }
        
        if (this.uiManager.isMobile) {
            this._handleMobileTooltip(e);
        }

        this._handleLoreAndTutorialLog(e);
    }

    /**
     * Handles mouseover events for desktop tooltips and graphs.
     * @param {Event} e The mouseover event.
     */
    handleMouseOver(e) {
        if (this.uiManager.isMobile) return;
        const graphTarget = e.target.closest(`[data-action="${ACTION_IDS.SHOW_PRICE_GRAPH}"], [data-action="${ACTION_IDS.SHOW_FINANCE_GRAPH}"]`);
        if (graphTarget) {
            this.uiManager.showGraph(graphTarget, this.gameState.getState());
        }
    }

    /**
     * Handles mouseout events for desktop tooltips and graphs.
     * @param {Event} e The mouseout event.
     */
    handleMouseOut(e) {
        if (this.uiManager.isMobile) return;
        const graphTarget = e.target.closest(`[data-action="${ACTION_IDS.SHOW_PRICE_GRAPH}"], [data-action="${ACTION_IDS.SHOW_FINANCE_GRAPH}"]`);
        if (graphTarget) {
            this.uiManager.hideGraph();
        }
    }

    _toggleStatusTooltip(target) {
        const tooltip = target.querySelector('.status-tooltip');
        if (!tooltip) return;
        if (this.activeStatusTooltip === tooltip) {
            tooltip.classList.remove('visible');
            this.activeStatusTooltip = null;
        } else {
            if (this.activeStatusTooltip) this.activeStatusTooltip.classList.remove('visible');
            tooltip.classList.add('visible');
            this.activeStatusTooltip = tooltip;
        }
    }

    _handleMobileTooltip(e) {
        const tooltipTarget = e.target.closest('[data-tooltip]');
        if (tooltipTarget && !tooltipTarget.closest('[data-action="toggle-tooltip"]')) {
            this.uiManager.hideGraph();
            if (this.activeTooltipTarget === tooltipTarget) {
                this.uiManager.hideGenericTooltip();
                this.activeTooltipTarget = null;
            } else {
                this.uiManager.showGenericTooltip(tooltipTarget, tooltipTarget.dataset.tooltip);
                this.activeTooltipTarget = tooltipTarget;
            }
        }
    }

    _handleLoreAndTutorialLog(e) {
        const tutorialTrigger = e.target.closest('.tutorial-container');
        const loreTrigger = e.target.closest('.lore-container');

        const visibleTooltip = document.querySelector('.lore-tooltip.visible, .tutorial-tooltip.visible');
        if (visibleTooltip && !e.target.closest('.lore-tooltip, .tutorial-tooltip')) {
            visibleTooltip.classList.remove('visible');
        }
        
        if (loreTrigger) {
            loreTrigger.querySelector('.lore-tooltip')?.classList.toggle('visible');
        }

        if (tutorialTrigger) {
            this.uiManager.showTutorialLogModal({
                seenBatches: this.gameState.tutorials.seenBatchIds,
                onSelect: (batchId) => this.tutorialService.triggerBatch(batchId)
            });
        }
    }
}
--- END OF FILE: ./js/services/handlers/TooltipHandler.js ---

--- START OF FILE: ./js/services/handlers/CarouselEventHandler.js ---
// js/services/handlers/CarouselEventHandler.js
/**
 * @fileoverview Manages all pointer, touch, and wheel events for the
 * hangar/shipyard carousel, providing a smooth drag-and-swipe interface.
 */
export class CarouselEventHandler {
    /**
     * @param {import('../GameState.js').GameState} gameState The central game state object.
     * @param {import('../SimulationService.js').SimulationService} simulationService The core game logic engine.
     */
    constructor(gameState, simulationService) {
        this.gameState = gameState;
        this.simulationService = simulationService;

        this.isScrolling = false;
        this.scrollTimeout = null;

        this.state = {
            isDragging: false,
            startX: 0,
            startTranslate: 0,
            currentTranslate: 0,
            activeCarousel: null,
            containerWidth: 0,
            pageCount: 0,
            currentIndex: 0,
            moved: false
        };
    }

    /**
     * Handles wheel events (mouse scroll) over the carousel to navigate between pages.
     * @param {WheelEvent} e The wheel event.
     */
    handleWheel(e) {
        if (this.isScrolling) return;

        let direction = e.deltaY > 0 ? 'next' : 'prev';
        this.simulationService.cycleHangarCarousel(direction);

        this.isScrolling = true;
        clearTimeout(this.scrollTimeout);
        this.scrollTimeout = setTimeout(() => {
            this.isScrolling = false;
        }, 300); // Throttle scroll events
    }

    /**
     * Initiates a drag sequence on the carousel.
     * @param {MouseEvent|TouchEvent} e The mousedown or touchstart event.
     */
    handleDragStart(e) {
        const carouselContainer = e.target.closest('.carousel-container');
        const carousel = carouselContainer ? carouselContainer.querySelector('#hangar-carousel') : null;

        if (e.target.closest('.action-button') || !carousel || carousel.children.length <= 1) {
            this.state.isDragging = false;
            return;
        }
        e.preventDefault();

        const gameState = this.gameState.getState();
        const isHangarMode = gameState.uiState.hangarShipyardToggleState === 'hangar';

        this.state.isDragging = true;
        this.state.activeCarousel = carousel;
        this.state.startX = e.pageX ?? e.touches[0].pageX;
        this.state.containerWidth = carousel.parentElement.offsetWidth;
        this.state.pageCount = carousel.children.length;
        this.state.currentIndex = isHangarMode ? (gameState.uiState.hangarActiveIndex || 0) : (gameState.uiState.shipyardActiveIndex || 0);
        this.state.startTranslate = -this.state.currentIndex * this.state.containerWidth;
        this.state.currentTranslate = this.state.startTranslate;
        this.state.moved = false;

        carousel.style.transitionDuration = '0s'; // Make drag instant
        document.body.style.cursor = 'grabbing';
    }

    /**
     * Handles the movement during a carousel drag.
     * @param {MouseEvent|TouchEvent} e The mousemove or touchmove event.
     */
    handleDragMove(e) {
        if (!this.state.isDragging) return;
        e.preventDefault();

        const currentX = e.pageX ?? e.touches[0].pageX;
        const diff = currentX - this.state.startX;
        this.state.currentTranslate = this.state.startTranslate + diff;

        if (Math.abs(diff) > 10) this.state.moved = true;

        if (this.state.activeCarousel) {
            this.state.activeCarousel.style.transform = `translateX(${this.state.currentTranslate}px)`;
        }
    }

    /**
     * Ends the drag sequence and snaps the carousel to the nearest or intended page.
     */
    handleDragEnd() {
        if (!this.state.isDragging) return;

        const { activeCarousel, startTranslate, currentTranslate, currentIndex, containerWidth, pageCount } = this.state;

        this.state.isDragging = false;
        document.body.style.cursor = 'default';

        if (!activeCarousel) return;

        activeCarousel.style.transitionDuration = ''; // Revert to CSS-defined duration for smooth snap

        const movedBy = currentTranslate - startTranslate;
        let newIndex = currentIndex;
        const threshold = containerWidth / 4;

        if (movedBy < -threshold && currentIndex < pageCount - 1) {
            newIndex++;
        } else if (movedBy > threshold && currentIndex > 0) {
            newIndex--;
        }

        const mode = this.gameState.uiState.hangarShipyardToggleState;
        this.simulationService.setHangarCarouselIndex(newIndex, mode);

        // A timeout is used to reset the 'moved' flag, preventing a click event from firing immediately after a drag.
        setTimeout(() => {
            this.state.moved = false;
        }, 50);
    }
    
    /**
     * Returns whether the carousel was moved during the last drag operation.
     * Used by EventManager to suppress clicks after a drag.
     * @returns {boolean}
     */
    wasMoved() {
        return this.state.moved;
    }
}
--- END OF FILE: ./js/services/handlers/CarouselEventHandler.js ---

--- START OF FILE: ./js/services/player/PlayerActionService.js ---
// js/services/player/PlayerActionService.js
/**
 * @fileoverview Manages all direct, player-initiated actions that have an
 * immediate effect, such as buying/selling commodities, purchasing ships,
 * and using station services.
 */
import { DB } from '../../data/database.js';
import { formatCredits, calculateInventoryUsed } from '../../utils.js';
import { GAME_RULES, PERK_IDS, ACTION_IDS, LOCATION_IDS } from '../../data/constants.js';

export class PlayerActionService {
    /**
     * @param {import('../GameState.js').GameState} gameState
     * @param {import('../UIManager.js').UIManager} uiManager
     * @param {import('../MissionService.js').MissionService} missionService
     * @param {import('../simulation/MarketService.js').MarketService} marketService
     * @param {import('../world/TimeService.js').TimeService} timeService
     * @param {import('../../services/LoggingService.js').Logger} logger
     * @param {import('../SimulationService.js').SimulationService} simulationServiceFacade
     */
    constructor(gameState, uiManager, missionService, marketService, timeService, logger, simulationServiceFacade) {
        this.gameState = gameState;
        this.uiManager = uiManager;
        this.missionService = missionService;
        this.marketService = marketService;
        this.timeService = timeService;
        this.logger = logger;
        this.simulationService = simulationServiceFacade;
        this.isTransactionInProgress = false;
    }

    /**
     * Handles the purchase of a specified quantity of a commodity from the current market.
     * @param {string} goodId - The COMMODITY_ID of the item to purchase.
     * @param {number} quantity - The integer amount to buy.
     * @returns {boolean} - True if the purchase was successful, false otherwise.
     */
    buyItem(goodId, quantity) {
        const state = this.gameState.getState();
        if (state.isGameOver || quantity <= 0) return false;

        const good = DB.COMMODITIES.find(c=>c.id===goodId);
        if (good.licenseId && !state.player.unlockedLicenseIds.includes(good.licenseId)) {
            this.uiManager.queueModal('event-modal', "License Required", `You do not have the required license to trade ${good.name}.`);
            return false;
        }

        const price = this.uiManager.getItemPrice(state, goodId);
        const totalCost = price * quantity;
        const marketStock = state.market.inventory[state.currentLocationId][goodId].quantity;

        if (marketStock <= 0) { this.uiManager.queueModal('event-modal', "Sold Out", `This station has no more ${good.name} available.`); return false; }
        if (quantity > marketStock) { this.uiManager.queueModal('event-modal', "Limited Stock", `This station only has ${marketStock} units available.`); return false; }

   
     const activeShip = this.simulationService._getActiveShip();
        const activeInventory = this.simulationService._getActiveInventory();
        if (calculateInventoryUsed(activeInventory) + quantity > activeShip.cargoCapacity) {
             this.uiManager.queueModal('event-modal', "Cargo Hold Full", "You don't have enough space.");
            return false;
        }
         if (state.player.credits < totalCost) { this.uiManager.queueModal('event-modal', "Insufficient Funds", "Your credit balance is too low."); return false; }

        const inventoryItem = this.gameState.market.inventory[state.currentLocationId][goodId];
        const stockBeforeBuy = inventoryItem.quantity; // Get stock *before* purchase
        inventoryItem.quantity -= quantity;

        // --- VIRTUAL WORKBENCH: REFACTOR ---
      
     // Check for depletion bonus logic
        if (inventoryItem.quantity <= 0) {
            // Delegate depletion check to MarketService
            this.marketService.checkDepletion(good, inventoryItem, stockBeforeBuy, state.day);
        }
        // --- END VIRTUAL WORKBENCH ---

        const playerInvItem = activeInventory[goodId];
        playerInvItem.avgCost = ((playerInvItem.quantity * playerInvItem.avgCost) + totalCost) / (playerInvItem.quantity + quantity);
        playerInvItem.quantity += quantity;

        this.gameState.player.credits -= totalCost;
        this.logger.info.player(state.day, 'BUY', `Bought ${quantity}x ${good.name} for ${formatCredits(totalCost)}`);
        this.simulationService._logConsolidatedTrade(good.name, quantity, -totalCost);
        this.timeService._checkMilestones();
        this.missionService.checkTriggers();

        this.marketService.applyMarketImpact(goodId, quantity, 'buy');

        // --- VIRTUAL WORKBENCH: BUG FIX ---
        // Set timestamp to force UIManager to do a full re-render of HangarScreen
        this.gameState.uiState.lastTransactionTimestamp = Date.now();
        // --- END VIRTUAL WORKBENCH ---

        this.gameState.setState({});
        return true;
    }

    /**
     * Sells a specified quantity of a commodity to the current market.
     * @param {string} goodId - The COMMODITY_ID of the item to sell.
     * @param {number} quantity - The integer amount to sell.
     * @returns {number} - The total value of the sale, or 0 if failed.
     */
    sellItem(goodId, quantity) {
        const state = this.gameState.getState();
        if (state.isGameOver || quantity <= 0) return 0;

        const good = DB.COMMODITIES.find(c=>c.id===goodId);
        if (good.licenseId && !state.player.unlockedLicenseIds.includes(good.licenseId)) {
            this.uiManager.queueModal('event-modal', "License Required", `You do not have the required license to trade ${good.name}.`);
            return 0;
        }

        const activeInventory = this.simulationService._getActiveInventory();
        const item = activeInventory[goodId];
        if (!item || item.quantity < quantity) {
             this.uiManager.queueModal('event-modal', "Insufficient Inventory", `You do not have ${quantity} units of ${good.name} to sell.`);
            return 0;
        }

        const { totalPrice } = this.uiManager._calculateSaleDetails(goodId, quantity);
        let totalSaleValue = totalPrice;

        const profit = totalSaleValue - (item.avgCost * quantity);
        if (profit > 0) {
            let totalBonus = (state.player.activePerks[PERK_IDS.TRADEMASTER] ? DB.PERKS[PERK_IDS.TRADEMASTER].profitBonus : 0) + (state.player.birthdayProfitBonus || 0);
            totalSaleValue += profit * totalBonus;
        }

        totalSaleValue = Math.floor(totalSaleValue);
        
        // --- VIRTUAL WORKBENCH: APPLY CREDIT CAP ---
        this.gameState.player.credits = Math.min(Number.MAX_SAFE_INTEGER, this.gameState.player.credits + totalSaleValue);
        // --- END VIRTUAL WORKBENCH ---

        item.quantity -= quantity;
        if (item.quantity === 0) item.avgCost = 0;

        const inventoryItem = this.gameState.market.inventory[state.currentLocationId][goodId];
        inventoryItem.quantity += quantity;

        this.logger.info.player(state.day, 'SELL', `Sold ${quantity}x ${good.name} for ${formatCredits(totalSaleValue)}`);
        this.simulationService._logConsolidatedTrade(good.name, quantity, totalSaleValue);

        this.timeService._checkMilestones();
        this.missionService.checkTriggers();

        this.marketService.applyMarketImpact(goodId, quantity, 'sell');

        // --- VIRTUAL WORKBENCH: BUG FIX ---
        // Set timestamp to force UIManager to do a full re-render of HangarScreen
        this.gameState.uiState.lastTransactionTimestamp = Date.now();
        // --- END VIRTUAL WORKBENCH ---

        this.gameState.setState({});

        return totalSaleValue;
    }

    /**
     * Validates if a ship purchase is possible.
     * @param {string} shipId - The ID of the ship to buy.
     * @returns {object} { success: boolean, errorTitle?: string, errorMessage?: string }
     * @JSDoc
     */
     validateBuyShip(shipId) {
        if (this.isTransactionInProgress) {
            return { success: false, errorTitle: "Transaction in Progress", errorMessage: "Please wait for the current transaction to complete." };
        }
        const ship = DB.SHIPS[shipId];
        if (!ship) {
            this.logger.error('PlayerActionService', `validateBuyShip called with invalid shipId: ${shipId}`);
            return { success: false, errorTitle: "Ship Not Found", errorMessage: "The selected ship does not exist in the database." };
        }
        if (this.gameState.player.credits < ship.price) {
  
             return { success: false, errorTitle: "Insufficient Funds", errorMessage: "You cannot afford this ship." };
        }
        return { success: true };
    }

    /**
     * Executes the purchase of a new ship (Assumes validation passed).
     * This replaces the logic in the original buyShip .
     * @param {string} shipId - The ID of the ship to buy.
     * @param {Event} [event] - The click event for placing floating text.
     * @returns {object|null} - The purchased ship object.
     * @JSDoc
     */
    executeBuyShip(shipId, event) {
        this.isTransactionInProgress = true;

        try {
            const ship = DB.SHIPS[shipId];
            if (!ship) {
                // This check is redundant if validateBuyShip was called, but good practice.
                this.logger.error('PlayerActionService', `executeBuyShip called with invalid shipId: ${shipId}`);
                return null;
            }

            this.gameState.player.credits -= ship.price;
            this.logger.info.player(this.gameState.day, 'SHIP_PURCHASE', `Purchased ${ship.name} for ${formatCredits(ship.price)}.`);
            if (event) {
                this.uiManager.createFloatingText(`-${formatCredits(ship.price, false)}`, event.clientX, event.clientY, '#f87171');
            }
            this.simulationService._logTransaction('ship', -ship.price, `Purchased ${ship.name}`);
            this.simulationService.addShipToHangar(shipId);

            // Determine the new active index for the shipyard carousel *after* the purchase.
            const shipyardInventory = this.simulationService._getShipyardInventory();
            const currentShipyardIndex = this.gameState.uiState.shipyardActiveIndex || 0;
            const newShipyardIndex = Math.min(currentShipyardIndex, Math.max(0, shipyardInventory.length - 1));

            if (this.gameState.tutorials.activeBatchId === 'intro_hangar') {
                this.simulationService.setHangarShipyardMode('hangar');
                this.simulationService.tutorialService.checkState({ type: 'ACTION', action: ACTION_IDS.BUY_SHIP });
            }

            // --- VIRTUAL WORKBENCH: MODIFICATION (Request B) ---
            // Pass negative price and 'true' to formatCredits to get '⌬ -1,234'
            const purchaseDescription = `You purchased the ${ship.name} for <span class="text-glow-red">${formatCredits(-ship.price, true)}</span>.`;
            this.uiManager.queueModal('event-modal', "Vessel Purchased", purchaseDescription);
            // --- END VIRTUAL WORKBENCH ---

            this.gameState.setState({
                uiState: {
                    ...this.gameState.uiState,
                    shipyardActiveIndex: newShipyardIndex, // Set the corrected index
                    lastTransactionTimestamp: Date.now()
                }
            });
            return ship;
        } finally {
            setTimeout(() => { this.isTransactionInProgress = false; }, 100); // Reset guard
        }
    }

    /**
     * Validates if a ship sale is possible.
     * @param {string} shipId - The ID of the ship to sell.
     * @returns {object} { success: boolean, errorTitle?: string, errorMessage?: string }
     * @JSDoc
     */
    validateSellShip(shipId) {
        if (this.isTransactionInProgress) {
            return { success: false, errorTitle: "Transaction in Progress", errorMessage: "Please wait for the current transaction to complete." };
        }
        const state = this.gameState.getState(); // Get fresh state for validation
        if (state.player.ownedShipIds.length <= 1) {
             return { success: false, errorTitle: "Action Blocked", errorMessage: "You cannot sell your last remaining ship." };
        }
        if (shipId === state.player.activeShipId) {
            return { success: false, errorTitle: "Action Blocked", errorMessage: "You cannot sell your active ship." };
        }
        if (calculateInventoryUsed(state.player.inventories[shipId]) > 0) {
            return { success: false, errorTitle: "Cannot Sell Ship", errorMessage: "This vessel's cargo hold is not empty." };
        }
    
     const ship = DB.SHIPS[shipId];
        if (!ship) {
            this.logger.error('PlayerActionService', `validateSellShip called with invalid shipId: ${shipId}`);
            return { success: false, errorTitle: "Ship Not Found", errorMessage: "The selected ship does not exist." };
        }
        return { success: true, ship: ship };
    }


    /**
     * Executes the sale of a ship (Assumes validation passed).
     * This replaces the logic in the original sellShip .
     * @param {string} shipId - The ID of the ship to sell.
     * @param {Event} [event] - The click event for placing floating text.
     * @returns {number|false} - The sale price.
     * @JSDoc
     */
    executeSellShip(shipId, event) {
        this.isTransactionInProgress = true;

        try {
            const ship = DB.SHIPS[shipId];
            if (!ship) {
                // This check is redundant if validateSellShip was called, but good practice.
                this.logger.error('PlayerActionService', `executeSellShip called with invalid shipId: ${shipId}`);
                return false;
            }
            
         
     const salePrice = Math.floor(ship.price * GAME_RULES.SHIP_SELL_MODIFIER);
            
            // --- VIRTUAL WORKBENCH: APPLY CREDIT CAP ---
            this.gameState.player.credits = Math.min(Number.MAX_SAFE_INTEGER, this.gameState.player.credits + salePrice);
            // --- END VIRTUAL WORKBENCH ---

            this.logger.info.player(this.gameState.day, 'SHIP_SALE', `Sold ${ship.name} for ${formatCredits(salePrice)}.`);
            if (event) {
                this.uiManager.createFloatingText(`+${formatCredits(salePrice, false)}`, event.clientX, event.clientY, '#34d399');
            }
            this.simulationService._logTransaction('ship', salePrice, `Sold ${ship.name}`);

            const shipIndex = this.gameState.player.ownedShipIds.indexOf(shipId);
            this.gameState.player.ownedShipIds = this.gameState.player.ownedShipIds.filter(id => id !== shipId);
            delete this.gameState.player.shipStates[shipId];
            delete this.gameState.player.inventories[shipId];

            let newActiveIndex = this.gameState.uiState.hangarActiveIndex;
            if (shipIndex < newActiveIndex) {
                newActiveIndex--;
            }
            if (newActiveIndex >= this.gameState.player.ownedShipIds.length) {
                newActiveIndex = Math.max(0, this.gameState.player.ownedShipIds.length - 1);
            }

            // --- VIRTUAL WORKBENCH: MODIFICATION (Request B) ---
            // Add '+' sign and pass 'true' to formatCredits to get '+⌬ 12,345'
            const saleDescription = `You sold the ${ship.name} for <span class="credits-text-pulsing">+${formatCredits(salePrice, true)}</span>.`;
            this.uiManager.queueModal('event-modal', "Vessel Sold", saleDescription);
            // --- END VIRTUAL WORKBENCH ---

            this.gameState.setState({
                uiState: {
                    ...this.gameState.uiState,
                    hangarActiveIndex: newActiveIndex,
                    lastTransactionTimestamp: Date.now()
                }
            });
            return salePrice;
        } finally {
            setTimeout(() => { this.isTransactionInProgress = false; }, 100);
        }
    }

    /**
     * Validates if setting a ship as active is possible.
     * @param {string} shipId - The ID of the ship to make active.
     * @returns {object} { success: boolean, errorTitle?: string, errorMessage?: string }
     * @JSDoc
     */
    validateSetActiveShip(shipId) {
        if (this.isTransactionInProgress) {
            return { success: false, errorTitle: "Transaction in Progress", errorMessage: "Please wait for the current transaction to complete." };
        }
        if (!this.gameState.player.ownedShipIds.includes(shipId)) {
            this.logger.error('PlayerActionService', `validateSetActiveShip called with unowned shipId: ${shipId}`);
            return { success: false, errorTitle: "Ship Not Found", errorMessage: "You do not own this ship." };
        }
        if (this.gameState.player.activeShipId === shipId) {
            return { success: false, errorTitle: "Action Redundant", errorMessage: "This ship is already your active vessel." };
        }
        return { success: true };
    }


    /**
     * Executes setting the player's currently active ship (Assumes validation passed).
     * @param {string} shipId - The ID of the ship to make active.
     * @JSDoc
     */
    executeSetActiveShip(shipId) {
        // --- VIRTUAL WORKBENCH: RENAMED FROM setActiveShip ---
        if (!this.gameState.player.ownedShipIds.includes(shipId)) return;
        
        this.isTransactionInProgress = true; // Set guard

        try {
            this.gameState.player.activeShipId = shipId;
            const newIndex = this.gameState.player.ownedShipIds.indexOf(shipId);
            if (newIndex !== -1) {
                this.gameState.uiState.hangarActiveIndex = newIndex;
            }

            this.logger.info.player(this.gameState.day, 'SET_ACTIVE_SHIP', `Boarded the ${DB.SHIPS[shipId].name}.`);
            
            // The tutorial check is now moved to SimulationService.boardShip
            // after the animation completes.

            this.gameState.setState({
                uiState: {
                    ...this.gameState.uiState,
                    lastTransactionTimestamp: Date.now()
                }
            });
        } finally {
             // Reset guard after a short delay to allow UI to update
            setTimeout(() => { this.isTransactionInProgress = false; }, 100);
        }
        // --- END VIRTUAL WORKBENCH ---
    }


    /**
     * Pays off the player's entire outstanding debt.
     * @param {Event} [event] - The click event for placing floating text.
     */
    payOffDebt(event) {
        if (this.gameState.isGameOver) return;
        const { player } = this.gameState;
        if (player.credits < player.debt) {
            this.uiManager.queueModal('event-modal', "Insufficient Funds", "You can't afford to pay off your entire debt.");
            return;
        }

        const debtAmount = player.debt;
        player.credits -= debtAmount;

        // --- VIRTUAL WORKBENCH START: Phase 2 ---
        if (event) {
      
             this.uiManager.createFloatingText(`-${formatCredits(debtAmount, false)}`, event.clientX, event.clientY, '#f87171'); // Red
        }
        // --- VIRTUAL WORKBENCH END: Phase 2 ---

        this.logger.info.player(this.gameState.day, 'DEBT_PAID', `Paid off ${formatCredits(debtAmount)} in debt.`);
        this.simulationService._logTransaction('loan', -debtAmount, `Paid off ${formatCredits(debtAmount)} debt`);
        player.debt = 0;
        player.monthlyInterestAmount = 0;
        player.loanStartDate = null;

        this.timeService._checkMilestones();
        this.gameState.setState({});
    }

    /**
     * Allows the player to take out a loan, adding to their debt.
     * @param {object} loanData - Contains amount, fee, and interest for the loan.
     * @param {Event} [event] - The click event for placing floating text.
     */
    takeLoan(loanData, event) {
        const { player, day } = this.gameState;
        if (player.debt > 0) {
            this.uiManager.queueModal('event-modal', "Loan Unavailable", `You must pay off your existing debt first.`);
            return;
        }
        if (player.credits < loanData.fee) {
            this.uiManager.queueModal('event-modal', "Unable to Secure Loan", `The financing fee is ${formatCredits(loanData.fee)}, but you only have ${formatCredits(player.credits)}.`);
            return;
        }

        player.credits -= loanData.fee;
        this.simulationService._logTransaction('loan', -loanData.fee, `Financing fee for ${formatCredits(loanData.amount)} loan`);
        
        // --- VIRTUAL WORKBENCH: APPLY CREDIT CAP ---
        player.credits = Math.min(Number.MAX_SAFE_INTEGER, player.credits + loanData.amount);
        // --- END VIRTUAL WORKBENCH ---

        // --- VIRTUAL WORKBENCH START: Phase 2 ---
        if (event) {
            this.uiManager.createFloatingText(`+${formatCredits(loanData.amount, false)}`, event.clientX, event.clientY, '#34d399'); // Green
        }
        // --- VIRTUAL WORKBENCH END: Phase 2 ---

        this.simulationService._logTransaction('loan', loanData.amount, `Acquired ${formatCredits(loanData.amount)} loan`);

        player.debt += loanData.amount;
        player.monthlyInterestAmount = loanData.interest;
        player.loanStartDate = day;
        player.seenGarnishmentWarning = false;

        // --- VIRTUAL WORKBENCH: REMOVED FONT-ROBOTO-MONO ---
        // Added glowing classes and removed font-roboto-mono for consistency
 
        const loanDesc = `You've acquired a loan of <span class="credits-text-pulsing">${formatCredits(loanData.amount, true)}</span>.<br>A financing fee of <span class="text-glow-red">${formatCredits(-loanData.fee, true)}</span> was deducted.`;
        // --- END VIRTUAL WORKBENCH ---
        
        this.uiManager.queueModal('event-modal', "Loan Acquired", loanDesc);
        this.logger.info.player(day, 'LOAN_TAKEN', `Took a loan for ${formatCredits(loanData.amount)}.`);
        this.gameState.setState({});
    }

    /**
     * Purchases a trade license for a specific commodity tier.
     * @param {string} licenseId - The ID of the license to purchase.
     * @returns {object} A structured object indicating success or failure with a specific error code.
     */
    purchaseLicense(licenseId) {
        const license = DB.LICENSES[licenseId];
        const { player, day } = this.gameState;

        if (!license) return { success: false, error: 'INVALID_LICENSE' };
        if (license.type !== 'purchase') return { success: false, error: 'NOT_FOR_PURCHASE' };
        if (player.unlockedLicenseIds.includes(licenseId)) return { success: false, error: 'ALREADY_OWNED' };
        
        // --- VIRTUAL WORKBENCH: BUG FIX ---
        // This is the check that was failing. It will now correctly compare
        // a (potentially huge) number against a number.
        if (player.credits < license.cost) {
            return { success: false, error: 'INSUFFICIENT_FUNDS' };
        }
        // --- END VIRTUAL WORKBENCH ---

        player.credits -= license.cost;
        player.unlockedLicenseIds.push(licenseId);
        this.logger.info.player(day, 'LICENSE_PURCHASE', `Purchased ${license.name}.`);
        this.simulationService._logTransaction('license', -license.cost, `Purchased ${license.name}`);
        this.gameState.setState({});

        return { success: true };
    }

    /**
     * Purchases market intel, providing a temporary trade advantage.
     * @param {number} cost - The credit cost of the intel.
     */
    purchaseIntel(cost) {
        const { player, currentLocationId, day } = this.gameState;
        if (player.credits < cost) {
            this.uiManager.queueModal('event-modal', "Insufficient Funds", "You can't afford this intel.");
            return;
        }

        player.credits -= cost;
        this.logger.info.player(day, 'INTEL_PURCHASE', `Purchased intel for ${formatCredits(cost)}.`);
        this.simulationService._logTransaction('intel', -cost, 'Purchased market intel');
        this.gameState.intel.available[currentLocationId] = false;

        const otherMarkets = DB.MARKETS.filter(m => m.id !== currentLocationId && player.unlockedLicenseIds.includes(m.id));
        if (otherMarkets.length === 0) return;

        const targetMarket = otherMarkets[Math.floor(Math.random() * otherMarkets.length)];
        const availableCommodities = DB.COMMODITIES.filter(c => c.tier <= player.revealedTier);
        const commodity = availableCommodities[Math.floor(Math.random() * availableCommodities.length)];

        if (commodity) {
      
             this.gameState.intel.active = {
                targetMarketId: targetMarket.id,
                commodityId: commodity.id,
                type: 'demand',
                startDay: day,
                endDay: day + 100
            };
        }
  
         this.gameState.setState({});
    }

    /**
     * Processes one "tick" of refueling while the button is held, costing credits and adding fuel.
     * @returns {number} - The cost of the fuel tick, or 0 if no fuel was added.
     */
    refuelTick() {
        const state = this.gameState;
        const ship = this.simulationService._getActiveShip();
        if (!ship || ship.fuel >= ship.maxFuel) return 0; // Check if ship exists

        let costPerTick = DB.MARKETS.find(m => m.id === state.currentLocationId).fuelPrice / 2;
        if (state.player.activePerks[PERK_IDS.VENETIAN_SYNDICATE] && state.currentLocationId === LOCATION_IDS.VENUS) {
    
             costPerTick *= (1 - DB.PERKS[PERK_IDS.VENETIAN_SYNDICATE].fuelDiscount);
        }
        costPerTick = Math.max(1, Math.round(costPerTick)); // Ensure cost is at least 1

        if (state.player.credits < costPerTick) return 0;

        state.player.credits -= costPerTick;
        state.player.shipStates[ship.id].fuel = Math.min(ship.maxFuel, state.player.shipStates[ship.id].fuel + 5);
        this.simulationService._logConsolidatedTransaction('fuel', -costPerTick, 'Fuel Purchase');

        // --- ADDED: Floating Text ---
        const refuelBtn = document.getElementById('refuel-btn');
        if (refuelBtn) {
            const rect = refuelBtn.getBoundingClientRect();
            // Calculate center X, top Y for the text origin
        
             const x = rect.left + rect.width / 2;
            const y = rect.top;
            this.uiManager.createFloatingText(`-${formatCredits(costPerTick, false)}`, x, y, '#f87171'); // Red color for cost
        }
        // --- END ADDED ---

        this.gameState.setState({}); // Notify state change *after* potentially adding text
        return costPerTick;
    }

    /**
     * Processes one "tick" of repairing while the button is held, costing credits and restoring health.
     * @returns {number} - The cost of the repair tick, or 0 if no repairs were made.
     */
    repairTick() {
        const state = this.gameState;
        const ship = this.simulationService._getActiveShip();
        if (!ship || ship.health >= ship.maxHealth) return 0; // Check if ship exists

        const repairAmount = ship.maxHealth * (GAME_RULES.REPAIR_AMOUNT_PER_TICK / 100);
        let costPerTick = repairAmount * GAME_RULES.REPAIR_COST_PER_HP;

        if (state.player.activePerks[PERK_IDS.VENETIAN__SYNDICATE] && state.currentLocationId === LOCATION_IDS.VENUS) {
            costPerTick *= (1 - DB.PERKS[PERK_IDS.VENETIAN_SYNDICATE].repairDiscount);
        }
         costPerTick = Math.max(1, Math.round(costPerTick)); // Ensure cost is at least 1

        if (state.player.credits < costPerTick) return 0;
        state.player.credits -= costPerTick;
        state.player.shipStates[ship.id].health = Math.min(ship.maxHealth, state.player.shipStates[ship.id].health + repairAmount);
        this.simulationService._logConsolidatedTransaction('repair', -costPerTick, 'Hull Repairs');
        this.simulationService._checkHullWarnings(ship.id);

        // --- ADDED: Floating Text ---
        const repairBtn = document.getElementById('repair-btn');
        if (repairBtn) {
             const rect = repairBtn.getBoundingClientRect();
             // Calculate center X, top Y for the text origin
            const x = rect.left + rect.width / 2;
            const y = rect.top;
            this.uiManager.createFloatingText(`-${formatCredits(costPerTick, false)}`, x, y, '#f87171'); // Red color for cost
        }
      
       // --- END ADDED ---

        this.gameState.setState({}); // Notify state change *after* potentially adding text
        return costPerTick;
    }
}
--- END OF FILE: ./js/services/player/PlayerActionService.js ---

--- START OF FILE: ./meta/CHANGELOG.md ---
# Changelog

All notable changes to the Orbital Trading project will be documented in this file. Gemini is never to modify this file or provide updates. The user will always manually update this file.

## [32.90] - 2025-11-116
-  updated fixed aspect ratio

## [32.80] - 2025-11-16
-  ship card polish

## [32.70] - 2025-11-15
-  added contingency max credit limit

## [32.60] - 2025-11-15
-  credit text styling alignment
-  modal dismissal bug fixes

## [32.50] - 2025-11-14
-  ship card polish

## [32.40] - 2025-11-11
-  removed quantity sale penalty
-  updated hangar/ship card frame to 1x1
-  removed parameter bars from H/S ship cards

## [32.30] - 2025-11-10
-  added boarding animation
-  ship card polish

## [32.20] - 2025-11-8
-  services screen polish

## [32.10] - 2025-11-8
-  ship transaction polish

## [32.00] - 2025-11-8
-  added transition effects
-  add ship card transitions
-  added AnimationService.js

## [31.90] - 2025-11-7
-  finance screen polish

## [31.80] - 2025-11-7
-  map screen rebuild
-  added player location to map screen

## [31.70] - 2025-11-6
-  news ticker polish
-  added EULA
-  added EULA gate to title screen
-  intel polish

## [31.60] - 2025-11-6
-  intel messaging rewrites
-  intel debug features added

## [31.50] - 2025-11-5
-  intel system polish
-  time dependencies polish

## [31.40] - 2025-11-4
-  intel system overhaul V2
-  added intel-screen.css
-  added intelMessages.js
-  added IntelService.js
-  added IntelMarketRenderer.js

## [31.30] - 2025-11-3
-  navigation bar polish
-  news ticker polish

## [31.20] - 2025-11-2
-  build tooling update V2

## [31.10] - 2025-11-1
-  news ticker update V2
-  added databases for news ticker messaging
-  added news ticker themes

## [31.00] - 2025-10-31
-  implemented news ticker
-  added NewsTickerService.js
-  added TimeService.js
-  added news_flavor.js
-  added news-ticker.css
-  updated meta files

## [30.90] - 2025-10-30
-  autotrader update
-  DebugServive.js refactor
-  added AutomatedPlayerService.js
-  economic behavior tuning

## [30.80] - 2025-10-30
-  economic behavior update
-  added ECONOMIC_BEHAVIOR.md
-  updated meta files

## [30.70] - 2025-10-29
-  market behavior update
-  database refactor
-  added age_events.js
-  added events.js
-  added missions.js
-  added tutorials.js
-  ship list completed
-  ship lore completed
-  bug fixes

## [30.60] - 2025-10-25
- mission modal polish
- added css/fonts path
- added font Oxanium

## [30.50] - 2025-10-24
- adjusted navigation/market containers
- services screen polish
- added floating texts to more purchases
- bug fixes

## [30.40] - 2025-10-23
- fixed license bug
- overhaul license locked cards

## [30.30] - 2025-10-22
- overhauled services screen
- bug fixes

## [30.20] - 2025-10-21
- updated map screen modals
- updated economic behavior for imports/exports

## [30.10] - 2025-10-21
- updated intel screen

## [30.00] - 2025-10-20
- positioned tutorial modals for play
- name referencing bug fixes

## [29.60] - 2025-10-20
- updated tutorial mmodals
- added tutorial modal config exporter

## [29.55] - 2025-10-19
- added STATE-SCHEMA.md
- added SERVICES.md

## [29.50] - 2025-10-17
- added game over condition for zero credits
- removed tap-hold link preview on sub-navigation
- updated map screen

## [29.40] - 2025-10-16
- reduced space below iphone camera notch
- overhauled shipyard pagination indicators

## [29.30] - 2025-10-15
- fixed navigation screen performance bug
- Improved screen adaptability by removing fixed viewport heights.
- fixed transaction log container sizing
- limited transaction log limit to 25 entries
- fixed ship purchasing bug
- updated debug menu
- expanded ship debug commands

## [29.20] - 2025-10-13
- added border glows to more modals
- deprecaded some map screen code

## [29.10] - 2025-10-12
- fixed map screen bug
- fixed signature modal bug
- title screen debug 'simple start'

## [29.00] - 2025-10-11
- adapted Xcode into workflow
- simulating native iOS for dev
- programmatic webview with ViewController.swift
- simulator connected to VSCode LiveServer

## [28.10] - 2025-10-10
- decommissioned the 'System Surge' celebratory effect, removing all associated JS, CSS, and HTML to prepare for a new implementation.
- updated debug settings 

## [28.00] - 2025-10-07
- rebalanced solar system map distances.
- updated travel calculation
- zoned travel cost updates
- location supply/demand update
- launch modal update
- travel animation visual update
- location quirks
- deprecated status screen
- new map screen
- bug fixes

## [27.50] - 2025-10-04
- navigation bar visual update
- bug fixes

## [27.40] - 2025-10-04
- effects polish
- effects performance improvements

## [27.30] - 2025-10-03
- bug fixes
- mobile screen viewport optimization
- tutorial positioning adjustment

## [27.20] - 2025-10-02
- travel animation refactor
- code cleanup

## [27.10] - 2025-09-29
- SimulationService refactor
- EventManager refactor
- created Architectural Decisions meta file
- created Roadmap meta file

## [27.00] - 2025-09-28
- shipyard/hangar overhaul
- UI update
- hardest godamn update yet

## [26.15] - 2025-09-20
- portrait mode enforcement
- PWA optimization

## [26.10] - 2025-09-20
- UI update
- cargo overhaul

## [26.00] - 2025-09-18
- celebratory effects layer
- updated lexicon.json
- updated data_flow.md

## [25.60] - 2025-09-16
- tutorial update
- writing
- license bug fixes

## [25.50] - 2025-09-15
- refactoring
- bug fixes

## [25.40] - 2025-09-15
- removed tutorial editor tooling
- improved sub nav bar visibility

## [25.30] - 2025-09-14
- tutorial editor tools

## [25.20] - 2025-09-13
- scrollbar indicator

## [25.20] - 2025-09-13
- console debug diagnostic tools

## [25.10] - 2025-09-12
- minimizable commodities

## [25.00] - 2025-09-12
- navigation launch confirmation modal

## [24.70] - 2025-09-10
- shipyard/hangar visual overhaul v1
- balance update
- writing update

## [24.30] - 2025-09-7
- cargo visual overhaul

## [24.20] - 2025-09-6
- economy v4 update
- commodity card update

## [24.00] - 2025-09-3
- economy v3 update
- progression update
- ship cargo balancing
- wealth milestone update

## [23.20] - 2025-08-31
- diminishing returns in economy
- expected profit display

## [23.00] - 2025-08-30
- navigation bar overhaul

## [22.30] - 2025-08-29
- debug/market toasts removed
- economy adjusted

## [22.20] - 2025-08-28
- transaction module visual overhaul

## [22.10] - 2025-08-28
- debug gui for visual overhauls added
- market screen visuals updated

## [22.00] - 2025-08-28
- CSS Refactor

## [21.01] - 2025-08-24
- transaction visual overhaul
- indicator overhaul

## [21.00] - 2025-08-24
- intro completed
- tutorial completed
- removed tutorial highlighting
- writing polish

## [20.02] - 2025-08-17
- Polished introduction sequence with gated navigation access
- UI polish

## [20.01] - 2025-08-16
- Implemented mission prerequisite system. Missions now only appear when their conditions are met.

## [20.00] - 2025-08-15
- implemented V1 MissionEngine

## [19.14] - 2025-08-11
- intro overhaul
- shipyard/hanger tutorial v1
- style, writing, and functionality polish

## [19.13] - 2025-08-10
- bug fixes
- polish

## [19.12] - 2025-08-09
- v1 intro sequence

## [19.11] - 2025-08-07
- removed test tools

## [19.09] - 2025-08-07
- updated lexicon
- new build tools: OrbitalBuilder

## [19.08] - 2025-08-06
- added meta/ folder
- added lexicon.json
- added CHANGELOG.md
- commentary overhaul

## [19.07] - 2025-07-XX
- Added extensive code comments to improve readability and AI-assisted development.
- Reached a stable build, code is considered well-documented.

## [19.06] - 2025-07-XX
- Created `combine.sh` script to aggregate project files for analysis.

## [19.05] - 2025-07-XX
- Overhauled UI navigation with a new top-bar and sub-navigation system.
- Refactored screen rendering logic in `UIManager.js`.

## [19.04] - 2025-07-XX
- Major refactor of game logic into distinct services (`GameState`, `SimulationService`, `EventManager`).
--- END OF FILE: ./meta/CHANGELOG.md ---

--- START OF FILE: ./meta/ECONOMIC_BEHAVIOR.md ---
CURRENT ECONOMIC BEHAVIOR
Orbital Trading Gameplay Data
Last Edit: 10/30/25, ver. 30.80
This document provides a complete breakdown of the game's current economic model, including the core price mechanics, local market influences, and the specific forces that govern the player-driven simulation.

I. Core Price Mechanics Explained
These are the foundational rules that establish the baseline price of a commodity before any player actions are taken.
Galactic Average: This is the foundational, system-wide average price for a commodity. Think of it as the "default" price before any local factors.
Local Price Target: This is the new price baseline that each location's market thinks it should have. It's calculated by taking the Galactic Average and pulling it 50% of the way toward its "ideal" import/export price.
An Exporter (e.g., modifier of 2.0) has a local target price that is significantly lower than the Galactic Average.
An Importer (e.g., modifier of 0.5) has a local target price that is significantly higher than the Galactic Average.
Mean Reversion: This is the "gravitational pull" (currently set to 4% strength) that slowly pulls a commodity's current price back toward its new Local Price Target each week. This new system ensures that import/export locations will always trend toward the prices you expect, creating stable and logical trade routes.

II. Local Price Influences by Location
This is the full list of price influences for every market.
Venus
Exports (Price Reverts Toward a Lower Baseline):
Cloned Organs
Neural Processors
Imports (Price Reverts Toward a Higher Baseline):
GMO Seed Cultures
Sentient AI Cores
Earth
Exports (Price Reverts Toward a Lower Baseline):
Hydroponics
GMO Seed Cultures
Imports (Price Reverts Toward a Higher Baseline):
Cloned Organs
Xeno-Geologicals
The Moon
Exports (Price Reverts Toward a Lower Baseline):
Plasteel
Refined Propellant
Imports (Price Reverts Toward a Higher Baseline):
Water Ice
Hydroponics
Mars
Exports (Price Reverts Toward a Lower Baseline):
Plasteel
Imports (Price Reverts Toward a Higher Baseline):
Hydroponics
Cryo-Sleep Pods
Water Ice
The Belt
Exports (Price Reverts Toward a Lower Baseline):
Water Ice
Xeno-Geologicals
Imports (Price Reverts Toward a Higher Baseline):
Hydroponics
Cybernetics
The Exchange
Neutral Location: This location has no local modifiers. All prices will revert directly toward the Galactic Average.
Jupiter
Exports (Price Reverts Toward a Lower Baseline):
Refined Propellant
Atmo Processors
Imports (Price Reverts Toward a Higher Baseline):
Neural Processors
Saturn
Imports (Price Reverts Toward a Higher Baseline):
Cryo-Sleep Pods
Cloned Organs
Uranus
Exports (Price Reverts Toward a Lower Baseline):
Atmo Processors
Imports (Price Reverts Toward a Higher Baseline):
Sentient AI Cores
Neural Processors
Neptune
Imports (Price Reverts Toward a Higher Baseline):
Plasteel (Note: This is a strong import with a 0.1 modifier, so prices will trend very high)
Refined Propellant
Kepler's Eye
Neutral Location: This location has no local modifiers. All prices will revert directly toward the Galactic Average.
Pluto
Exports (Price Reverts Toward a Lower Baseline):
Water Ice
Xeno-Geologicals
Imports (Price Reverts Toward a Higher Baseline):
Hydroponics
Cybernetics
Cloned Organs

III. Player-Driven Market Dynamics & Simulation
Beyond the baseline mechanics, the market is governed by a set of interconnected, player-driven systems. These forces are designed to make the market a dynamic entity that the player actively manipulates. These forces are processed during the weekly TimeService.advanceDays simulation tick.
1. Force: Availability Pressure (The Delayed Market Shock)
This is the new, unified force that replaces the old "Player Pressure" and "Scarcity Pressure." It is the primary driver of all player-initiated price changes.
Mechanic: This force directly simulates supply and demand. When a player buys or sells, they immediately change the item's quantity at that market. This change in stock is the only thing that drives the price change.
Technical Detail: In evolveMarketPrices, the system calculates an availabilityRatio (current quantity / targetStock). This ratio is used to create an availabilityEffect.
The 7-Day Delay (Anti-Abuse): This effect is intentionally delayed. The game checks if 7 days have passed since the lastPlayerInteractionTimestamp. The availabilityEffect is only calculated after this 7-day window, preventing players from manipulating a price and exploiting it in the same visit.
The Strength (High Impact): This effect is controlled by AVAILABILITY_PRESSURE_STRENGTH (currently 0.50). This high value makes market manipulation feel powerful and rewarding.
Example (Sell): Doubling a market's stock (a 2.0 ratio) will cause the price to crash by 50% after the 7-day delay.
Example (Buy): Buying half a market's stock (a 0.5 ratio) will cause the price to spike by 25% after the 7-day delay.
2. Force: Price Lock (The Core Loop)
This is the system that makes market manipulation viable.
Mechanic: When a player makes a trade, the market's natural "Mean Reversion" (the 4% pull back to the local average) is disabled for a long duration.
Technical Detail: When applyMarketImpact is called, it sets a priceLockEndDay on the inventory item.
Jan-Jun (Day 1-182): 75 to 120 days (2.5 - 4 months).
Jul-Dec (Day 183-365): 105 to 195 days (3.5 - 6.5 months).
Effect: In evolveMarketPrices, the system checks if this.gameState.day < inventoryItem.priceLockEndDay. If true, reversionEffect is set to 0. This "locks" the price at the new level created by the player's trade, allowing them to travel and return to exploit the price they created.
3. Force: Depletion Bonus (The Panic)
A special, one-time bonus for buying out a significant portion of a market's stock, simulating a supply panic.
Technical Detail: This is a multi-part check originating in PlayerActionService.buyItem.
Trigger: When a purchase reduces inventoryItem.quantity to <= 0.
Threshold Check: The game checks if the amount purchased was >= 8% of the item's calculated targetStock.
Cooldown Check: It then checks if 365 days have passed since the last bonus (depletionBonusDay).
Effect: If all checks pass, isDepleted and depletionDay are set. For the next 7 days, evolveMarketPrices applies a 1.5x priceHikeMultiplier to the availabilityEffect, causing the price to rise 50% faster than normal.
4. Force: Inventory Replenishment (The Bottleneck)
The market's supply-side response. This is the primary balancing factor that bottlenecks market manipulation.
Mechanic: The market slowly restocks (or sheds) its inventory to move back toward its targetStock.
Technical Detail: In replenishMarketInventory, the market only moves 10% of the difference (targetStock - currentStock) each week.
Effect: This slow 10% rate acts as the main "cooldown" for the manipulation loop. A player can lock a price, but they must wait for stock to slowly recover (or be shed, in a surplus) before they can trade against that locked price again.
Role of marketPressure: The marketPressure variable (set during a trade) is now used exclusively by this system. Negative pressure (from player buying) will dynamically increase the market's targetStock, simulating the market adapting to new demand.
5. Force: Market Memory (The Reset)
The passive fail-safe that prevents the universe from being permanently altered.
Mechanic: This is the "garbage collector" for markets the player abandons.
Technical Detail: In replenishMarketInventory, the system checks if lastPlayerInteractionTimestamp is older than 120 days.
Effect: If the player has not traded that specific item at that specific location for 120 days, the item's state is completely reset.
marketPressure is reset to 0.
priceLockEndDay is reset to 0, re-enabling Mean Reversion.
depletionBonusDay is reset to 0, allowing the bonus to be triggered again.

IV. How The Market Behaves (Simple Terms)
Here is a simple breakdown of those forces with examples.
Availability Pressure (The Shock): You sell 1,000 "Plasteel" on Mars, doubling its stock.
For the next 7 days, nothing happens to the price (this prevents you from buying it right back).
On Day 7, the price crashes by 50%.
Price Lock (Your Loop): You sell 1,000 "Plasteel" on Mars, crashing the price.
That price will stay crashed (it won't recover from natural Mean Reversion) for a random 3-6 months.
This allows you to travel, then return to buy it back at the low price you created.
Depletion Bonus (The Panic): You buy the entire large stock of "Cybernetics" (e.g., 50 units) on Earth.
For the next 7 days, the price for "Cybernetics" on Earth will rise 50% faster than normal.
This won't happen if you just buy the last 2 units, and it can only happen once per year.
Replenishment (The Bottleneck): A market wants 1,000 "Plasteel" but has 1,200 (a surplus of 200).
It will not shed 200 units at once.
It will only shed 10% of the 200-unit gap, losing 20 units per week.
This is the "race": the price crash from your sale slowly gets weaker each week as the surplus shrinks.
Market Memory (The Reset): You crash the "Plasteel" price on Mars, then fly to the outer system and don't come back.
After 120 days of you not trading Plasteel on Mars, the market "forgets" you, and the price returns to normal.

V. Commodity Behavior
This is the full spectrum of default economic behaviors for all commodities, based on the definitions in js/data/database.js.
Section 1: Overview of Core Economic Parameters
This details the three fundamental parameters that define the economic behavior of a commodity before any local market modifiers (like import/export specialties) or system states are applied.
Base Price Range: This array [min, max] defines the foundational value of a commodity. The game's MarketService uses this range to establish a "Galactic Average" price, which serves as the baseline from which all local prices are derived.
Volatility: This decimal number represents the commodity's inherent price instability. A higher volatility value means the commodity's price will experience larger and more frequent fluctuations, making it a riskier but potentially more profitable asset.
Canonical Availability: This array [min, max] defines the default quantity of a commodity that a "neutral" market (one with no specialty modifiers for this item) will attempt to stock. This represents the item's general abundance or scarcity.
Section 2: Commodity Economic Behavior by Tier
The following is the complete breakdown of the default economic profiles for every tradable commodity, organized by tier.
Tier 1: Basic Materials
Water Ice
Base Price Range: [15, 80]
Volatility: 0.01 (Very Low)
Canonical Availability: [80, 150] (Abundant)
Plasteel
Base Price Range: [100, 280]
Volatility: 0.015 (Very Low)
Canonical Availability: [80, 150] (Abundant)
Tier 2: Industrial & Agricultural Goods
Hydroponics
Base Price Range: [850, 2400]
Volatility: 0.025 (Low)
Canonical Availability: [40, 70] (Common)
Cybernetics
Base Price Range: [1200, 3800]
Volatility: 0.03 (Low)
Canonical Availability: [40, 70] (Common)
Tier 3: Refined & Processed Goods
Refined Propellant
Base Price Range: [14000, 38000]
Volatility: 0.035 (Low-Medium)
Canonical Availability: [25, 50] (Uncommon)
Neural Processors
Base Price Range: [18000, 52000]
Volatility: 0.045 (Medium)
Canonical Availability: [25, 50] (Uncommon)
Tier 4: Advanced & Civilian Goods
GMO Seed Cultures
Base Price Range: [190000, 550000]
Volatility: 0.06 (Medium-High)
Canonical Availability: [15, 30] (Scarce)
Cryo-Sleep Pods
Base Price Range: [250000, 750000]
Volatility: 0.075 (High)
Canonical Availability: [15, 30] (Scarce)
Tier 5: High-Tech & Bio-Engineering
Atmo Processors
Base Price Range: [2800000, 8500000]
Volatility: 0.08 (High)
Canonical Availability: [10, 20] (Very Scarce)
Cloned Organs
Base Price Range: [3500000, 11000000]
Volatility: 0.09 (Very High)
Canonical Availability: [10, 20] (Very Scarce)
Tier 6: Exotic & Restricted Tech
Xeno-Geologicals
Base Price Range: [24000000, 70000000]
Volatility: 0.1 (Extremely High)
Canonical Availability: [2, 10] (Rare)
Sentient AI Cores
Base Price Range: [32000000, 95000000]
Volatility: 0.125 (Extremely High)
Canonical Availability: [2, 10] (Rare)
Tier 7: "Endgame" & Exotic Matter
Antimatter
Base Price Range: [280000000, 800000000]
Volatility: 0.15 (Hyper-Volatile)
Canonical Availability: [2, 10] (Exotic)
Folded-Space Drives
Base Price Range: [350000000, 1100000000]
Volatility: 0.15 (Hyper-Volatile)
Canonical Availability: [2, 10] (Exotic)
Section 3: Observable Patterns & Logic
Based on this data, a clear "full spectrum" pattern emerges:
Price & Tier: Commodity prices increase exponentially with each tier, establishing a clear progression of value.
Volatility & Tier: Volatility directly correlates with tier. Low-tier goods are stable and predictable, while high-tier "luxury" or "exotic" goods are highly volatile, making them high-risk, high-reward speculative assets.
Availability & Tier: Canonical availability is inversely proportional to tier. Tier 1 goods are abundant, while Tier 6 and 7 goods are exceptionally rare, reinforcing their high value.



--- END OF FILE: ./meta/ECONOMIC_BEHAVIOR.md ---

--- START OF FILE: ./meta/lexicon.json ---
{
  "project_info": {
    "project_name": "Orbital Trading",
    "synopsis": "A single-player, persistent browser game about interstellar arbitrage trading and capital accumulation.",
    "core_mechanics": [
      "arbitrage_trading",
      "ship_progression",
      "procedural_events",
      "debt_management",
      "wealth_milestones",
      "deal-on-demand intel"
    ],
    "gameplay_loop": "Player travels between locations -> trades commodities based on market prices -> uses profits to upgrade ship and pay debt -> unlocks new locations/commodITIES -> repeats."
  },
  "ai_collaboration_guidelines": {
    "description": "Instructions for AI developers to optimize the collaborative workflow with the human designer/playtester.",
    "bug_reporting_protocol": {
      "title": "Standard Bug Reporting and Diagnostic Workflow",
      "steps": [
        "When the user reports a bug or unexpected behavior, ALWAYS first ask them to generate a bug report.",
        "Instruct the user to open the debug panel (using the backtick '`' key) and click the 'Generate Bug Report' button.",
        "Ask the user to paste the entire clipboard content, which will contain both the full game state snapshot and the recent log history.",
        "Analyze the provided game state to understand the exact conditions at the time of the bug. Do not assume; use the state as the single source of truth.",
        "Analyze the log history to trace the sequence of events leading up to the bug. The logs provide context that a simple description cannot.",
        "Use the combined information from the state snapshot and log history to perform a root cause analysis and propose a specific, targeted code fix."
      ]
    },
    "logging_utility_overview": {
      "title": "About the Centralized Logging System",
      "description": "The project uses a centralized LoggingService (F030) to manage all console output. This system is designed to provide clear, filterable, and context-rich information for debugging. Ad-hoc 'console.log' statements should not be used; all new logging must be routed through this service."
    }
  },
  "key_concepts": {
    "Market_Pressure": "A value representing recent player trading activity for a commodity at a specific location. This value is now used exclusively to influence a market's 'targetStock' for replenishment, simulating the market adapting to new supply/demand.",
    "Galactic_Average": "The baseline, long-term average price for a commodity across the entire system. Market prices tend to revert to this average over time.",
    "Wealth_Milestones": "Specific credit thresholds that, when reached by the player, unlock higher tiers of commodities for trading, gating progression.",
    "Random_Events": "Procedurally triggered events that can occur during travel, presenting the player with choices that have various risks and rewards.",
    "Local_Data_Broker": "The 'Intel Market' tab on the Intel screen. A location-gated 'shop' where players can purchase Intel Packets.",
    "Intel_Packet": "A purchasable data object that creates a temporary, guaranteed market deal (e.g., a commodity at 40% off).",
    "One-Deal_Lock": "A core mechanic where the player can only have one active intel deal at a time, forcing a strategic choice."
  },
  "service_summaries": {
    "GameState": {
      "description": "The single source of truth for all mutable game data. It holds the current state and notifies other services of changes.",
      "dependencies": [],
      "key_functions": {
        "setState": "Merges a partial state object into the main state and notifies subscribers.",
        "getState": "Returns a deep copy of the current game state.",
        "startNewGame": "Initializes the entire game state for a new session.",
        "subscribe": "Allows other services (primarily UIManager) to listen for state changes."
      },
      "mutates_state": [
        "day",
        "currentLocationId",
        "player",
        "market",
        "missions",
        "tutorials",
        "introSequenceActive",
        "uiState",
        "intelMarket",
        "activeIntelDeal"
      ]
    },
    "SimulationService": {
      "description": "The core game engine **Facade**. It instantiates and coordinates all specialized services. It receives calls from the EventManager and delegates them to the appropriate service. It also hosts shared helper methods needed by multiple services.",
      "dependencies": [
        "GameState",
        "UIManager",
        "Logger",
        "MarketService",
        "TimeService",
        "TravelService",
        "IntroService",
        "PlayerActionService",
        "TutorialService",
        "MissionService",
        "NewsTickerService",
        "IntelService",
        "js/services/ui/AnimationService.js"
      ],
      "key_functions": {
        "constructor": "Instantiates all specialized services.",
        "setScreen": "Sets the active navigation tab and screen.",
        "travelTo": "Facade method that delegates to TravelService.",
        "buyItem": "Facade method that delegates to PlayerActionService.",
        "pushNewsMessage": "Facade method to push a message to the NewsTickerService.",
        "buyShip": "Orchestrates the ship purchase flow: validates, awaits the UI animation, then executes the PlayerActionService logic.",
        "sellShip": "Orchestrates the ship sale flow: validates, awaits the UI animation, then executes the PlayerActionService logic."
      },
      "mutates_state": [
        "activeNav",
        "activeScreen",
        "isGameOver",
        "uiState"
      ]
    },
    "IntroService": {
      "description": "Manages the entire new game introduction sequence, from the initial lore modals to the final tutorial kickoff.",
      "dependencies": [
        "GameState",
        "UIManager",
        "Logger",
        "SimulationService (Facade)"
      ],
      "key_functions": {
        "start": "Begins the intro sequence.",
        "handleIntroClick": "Handles clicks on intro-specific buttons.",
        "continueAfterTutorial": "Resumes the intro sequence after a tutorial batch is completed."
      },
      "mutates_state": [
        "player.introStep",
        "player.name",
        "player.debt",
        "introSequenceActive"
      ]
    },
    "PlayerActionService": {
      "description": "Manages all direct, player-initiated actions that have an immediate effect, such as buying/selling commodities, purchasing ships, and using station services (refuel/repair).",
      "dependencies": [
        "GameState",
        "UIManager",
        "MissionService",
        "MarketService",
        "TimeService",
        "Logger",
        "SimulationService (Facade)"
      ],
      "key_functions": {
        "buyItem": "Handles the logic for purchasing a commodity.",
        "sellItem": "Handles the logic for selling a commodity.",
        "validateBuyShip": "Validates if a ship purchase is possible.",
        "executeBuyShip": "Executes the state changes for purchasing a ship.",
        "validateSellShip": "Validates if a ship sale is possible.",
        "executeSellShip": "Executes the state changes for selling a ship.",
        "refuelTick": "Processes one 'tick' of refueling."
      },
      "mutates_state": [
        "player.credits",
        "player.debt",
        "player.inventories",
        "player.shipStates",
        "player.ownedShipIds",
        "market.inventory"
      ]
    },
    "TravelService": {
      "description": "Handles all aspects of interstellar travel, including initiating trips, calculating costs, and managing the random event system during transit. Draws event data from `js/data/events.js`.",
      "dependencies": [
        "GameState",
        "UIManager",
        "TimeService",
        "Logger",
        "SimulationService (Facade)",
        "js/data/events.js",
        "js/services/eventEffectResolver.js"
      ],
      "key_functions": {
        "travelTo": "Validates and begins travel to a new location.",
        "initiateTravel": "Executes the core travel logic, consuming fuel and time.",
        "resumeTravel": "Continues a pending travel action after an event."
      },
      "mutates_state": [
        "pendingTravel",
        "player.shipStates.health",
        "player.shipStates.fuel"
      ]
    },
    "TimeService": {
      "description": "Responsible for advancing the game clock (`advanceDays`) and triggering all time-based events like birthdays, debt interest charges, and weekly market updates. Draws age event data from `js/data/age_events.js`. Also checks for `activeIntelDeal` expiration and triggers the `IntelService` refresh.",
      "dependencies": [
        "GameState",
        "MarketService",
        "UIManager",
        "Logger",
        "SimulationService (Facade)",
        "js/data/age_events.js",
        "IntelService"
      ],
      "key_functions": {
        "advanceDays": "Advances game time and triggers all associated daily, weekly, and monthly logic."
      },
      "mutates_state": [
        "day",
        "player.playerAge",
        "player.debt",
        "player.shipStates.health",
        "market.prices",
        "market.inventory",
        "activeIntelDeal"
      ]
    },
    "MarketService": {
      "description": "Handles the simulation of the in-game economy, including price evolution, inventory replenishment, and applying market pressure from player trades. Its `getPrice` logic is modified to check for `activeIntelDeal` overrides.",
      "dependencies": [
        "GameState",
        "IntelService"
      ],
      "key_functions": {
        "evolveMarketPrices": "Simulates daily price changes for all commodities.",
        "replenishMarketInventory": "Handles the weekly restocking of all markets.",
        "applyMarketImpact": "Adjusts market pressure based on player buy/sell actions.",
        "_updateShipyardStock": "Updates the available ships for sale at each location.",
        "getPrice": "Gets the price, checking for Intel overrides first."
      },
      "mutates_state": [
        "market.prices",
        "market.inventory",
        "market.shipyardStock"
      ]
    },
    "IntelService": {
      "description": "The 'brain' of the Intel system. Manages the lifecycle of intel: generation, persistence, dynamic pricing logic, and the purchase transaction.",
      "dependencies": [
        "GameState",
        "TimeService",
        "MarketService",
        "NewsTickerService",
        "js/data/intelContent.js",
        "DB"
      ],
      "key_functions": {
        "generateIntelRefresh": "Called by TimeService to repopulate intel markets.",
        "calculateIntelPrice": "Dynamically calculates intel price based on player credits and deal value.",
        "purchaseIntel": "Validates and executes the purchase, creating an 'activeIntelDeal'."
      },
      "mutates_state": [
        "intelMarket",
        "activeIntelDeal",
        "player.credits"
      ]
    },
    "UIManager": {
      "description": "Responsible for rendering the entire UI based on the current GameState. It reads from the state but never modifies it. It also manages visual effects via the EffectsManager, travel animations via the TravelAnimationService, and news ticker content.",
      "dependencies": [
        "Logger",
        "EffectsManager",
        "TravelAnimationService",
        "MissionService",
        "SimulationService",
        "NewsTickerService",
        "IntelService",
        "IntelMarketRenderer",
        "js/services/ui/AnimationService.js"
      ],
      "key_functions": {
        "render": "The main function that orchestrates the re-drawing of all UI components.",
        "queueModal": "Manages a queue for displaying modals to prevent overlap.",
        "triggerEffect": "Initiates a visual effect through the EffectsManager.",
        "showTravelAnimation": "Initiates the travel animation sequence.",
        "_renderNewsTicker": "Renders the news ticker content only when its content is dirty.",
        "handleShowIntelOffer": "New handler for Intel Market.",
        "handleBuyIntel": "New handler for Intel Market.",
        "handleShowIntelDetails": "New handler for Intel Market.",
        "runShipTransactionAnimation": "Finds the active ship card and calls AnimationService.playBlockingAnimation to run the 'dematerialize' effect."
      },
      "mutates_state": []
    },
    "IntelMarketRenderer": {
      "description": "A dedicated renderer class. Its sole job is to be called by UIManager to dynamically build the HTML for the content of the 'Intel Market' tab.",
      "dependencies": [
        "UIManager",
        "GameState",
        "IntelService",
        "DB"
      ],
      "key_functions": {
        "render": "Builds and injects the HTML for the Intel Market."
      },
      "mutates_state": []
    },
    "NewsTickerService": {
      "description": "Manages the dynamic message queue for the scrolling news ticker. Handles different message types (SYSTEM, INTEL, FLAVOR, ALERT, STATUS), rebuilds the queue on location change, and pulls data from various sources. Is a primary driver for the Intel system.",
      "dependencies": [
        "GameState",
        "js/data/flavorAds.js",
        "js/data/intelMessages.js",
        "js/data/database.js"
      ],
      "key_functions": {
        "pushMessage": "Adds a new, non-duplicate message to the ticker queue and sets the dirty flag.",
        "pulse": "Called daily by TimeService; currently stubbed, logic moved to `onLocationChange`.",
        "getTickerContentHtml": "Returns the complete HTML string for the UIManager to render, generating live data (like STATUS) on the fly.",
        "onLocationChange": "Rebuilds the entire default message queue (welcome, intel, ads, status) when the player arrives at a new location.",
        "setServices": "Injects MarketService and SimulationService for generating dynamic intel and status messages."
      },
      "mutates_state": []
    },
    "EventManager": {
      "description": "The universal input layer. Instantiates specialized handlers, binds global listeners, and delegates event handling to the appropriate module.",
      "dependencies": [
        "GameState",
        "SimulationService",
        "UIManager",
        "TutorialService",
        "DebugService",
        "Logger"
      ],
      "key_functions": {
        "bindEvents": "Sets up all global event listeners for the application.",
        "_handleClick": "The central delegated click handler that routes events to the appropriate handler module, now async to support awaiting animated actions."
      },
      "mutates_state": []
    },
    "ActionClickHandler": {
      "description": "Handles general `data-action` click events, such as navigation, modal triggers, and simple state changes. Now also handles Intel Market actions like 'show_intel_offer'.",
      "dependencies": [
        "GameState",
        "SimulationService",
        "UIManager",
        "TutorialService"
      ],
      "key_functions": {
        "handle": "Processes a click event on an element with a `data-action` attribute, now an async function to await promise-based actions like animated ship purchases."
      },
      "mutates_state": []
    },
    "MarketEventHandler": {
      "description": "Manages all interactions within a market commodity card, including mode toggling, quantity changes, and trade confirmations.",
      "dependencies": [
        "GameState",
        "SimulationService",
        "UIManager"
      ],
      "key_functions": {
        "handleClick": "Handles clicks on market card controls.",
        "handleInput": "Handles direct input into the quantity field."
      },
      "mutates_state": []
    },
    "HoldEventHandler": {
      "description": "Manages 'hold-to-act' functionality (e.g., Refuel/Repair) using a persistent, capture-phase Pointer Event model to remain stable through UI re-renders.",
      "dependencies": [
        "PlayerActionService",
        "UIManager"
      ],
      "key_functions": {
        "bindHoldEvents": "Binds persistent 'pointerdown', 'pointerup', and 'pointercancel' listeners.",
        "_handleInteractionStart": "Master 'start' handler that delegates to specific actions.",
        "_handleInteractionStop": "Master 'stop' handler that stops any active action."
      },
      "mutates_state": []
    },
    "CarouselEventHandler": {
      "description": "Encapsulates all logic for the drag, swipe, and scroll functionality of the hangar/shipyard carousel.",
      "dependencies": [
        "GameState",
        "SimulationService"
      ],
      "key_functions": {
        "handleDragStart": "Initiates a drag sequence.",
        "handleDragMove": "Updates the carousel during a drag.",
        "handleDragEnd": "Concludes a drag sequence and snaps to a page.",
        "handleWheel": "Handles mouse wheel scrolling."
      },
      "mutates_state": []
    },
    "TooltipHandler": {
      "description": "Manages the display and lifecycle of tooltips, price graphs, and other contextual pop-ups on both desktop (hover) and mobile (click).",
      "dependencies": [
        "GameState",
        "UIManager"
      ],
      "key_functions": {
        "handleClick": "Manages tooltip visibility on click.",
        "handleMouseOver": "Shows tooltips on hover.",
        "handleMouseOut": "Hides tooltips on hover out."
      },
      "mutates_state": []
    },
    "MissionService": {
      "description": "Manages the state, progression, and availability of player missions. Draws mission data from `js/data/missions.js`.",
      "dependencies": [
        "GameState",
        "UIManager",
        "Logger",
        "SimulationService",
        "js/data/missions.js"
      ],
      "key_functions": {
        "getAvailableMissions": "Returns a list of all missions whose prerequisites are met.",
        "acceptMission": "Sets a mission as active and initializes its progress tracking.",
        "checkTriggers": "Checks if the objectives for the active mission are met based on the current game state.",
        "completeActiveMission": "Grants rewards and updates mission state upon successful completion."
      },
      "mutates_state": [
        "missions.activeMissionId",
        "missions.completedMissionIds",
        "missions.missionProgress",
        "missions.activeMissionObjectivesMet"
      ]
    },
    "TutorialService": {
      "description": "Manages the state and flow of interactive tutorials. Draws tutorial data from `js/data/tutorials.js`.",
      "dependencies": [
        "GameState",
        "UIManager",
        "SimulationService",
        "Logger",
        "js/data/tutorials.js"
      ],
      "key_functions": {
        "checkState": "Checks game state/action against triggers/completion conditions.",
        "triggerBatch": "Starts a specific tutorial batch.",
        "advanceStep": "Moves to the next step in the current batch.",
        "skipActiveTutorial": "Skips the current tutorial batch."
      },
      "mutates_state": [
        "tutorials.activeBatchId",
        "tutorials.activeStepId",
        "tutorials.seenBatchIds",
        "tutorials.skippedTutorialBatches",
        "tutorials.navLock"
      ]
    },
    "TravelAnimationService": {
      "description": "Handles the rendering and animation logic for the travel sequence modal. It uses the Canvas API to create a dynamic visual representation of the journey.",
      "dependencies": [],
      "key_functions": {
        "play": "Starts the travel animation sequence."
      },
      "mutates_state": []
    },
    "AnimationService": {
      "description": "Provides a generic, promise-based utility (playBlockingAnimation) to run CSS animations and block further execution until the animation completes. Used for ship buy/sell transitions.",
      "dependencies": [],
      "key_functions": {
        "playBlockingAnimation": "Returns a promise that resolves on 'animationend' for a given element and CSS class."
      },
      "mutates_state": []
    },
    "MapScreen": {
      "description": "A UI component responsible for rendering the interactive D3.js solar system map.",
      "dependencies": [
        "UIManager"
      ],
      "key_functions": {
        "renderMapScreen": "Renders the initial container for the map.",
        "initMap": "Initializes the D3 map, drawing all celestial bodies and labels."
      },
      "mutates_state": []
    },
    "ViewController": {
      "description": "The native Swift code for the iOS wrapper. It is responsible for creating and configuring the WKWebView that hosts the entire web application. It also handles the communication bridge for debugging and is the key to the live-reload development workflow with the Xcode simulator.",
      "dependencies": [
        "WKWebView"
      ],
      "key_functions": {
        "viewDidLoad": "Initializes the web view, sets its constraints to fill the screen, and loads the game either from the local development server or the bundled files."
      },
      "mutates_state": []
    }
  },
  "asset_index": {
    "F001": {
      "path": "./index.html",
      "role": "DOCUMENT_ROOT"
    },
    "F003": {
      "path": "./js/main.js",
      "role": "ENTRY_POINT"
    },
    "F004": {
      "path": "./js/utils.js",
      "role": "UTILITY_LIBRARY"
    },
    "F005": {
      "path": "./js/data/constants.js",
      "role": "DATA_DEFINITION"
    },
    "F006": {
      "path": "./js/data/database.js",
      "role": "DATA_AGGREGATOR",
      "description": "Aggregates and exports static game data imported from other modules."
    },
    "F009": {
      "path": "./js/services/GameState.js",
      "role": "STATE_MANAGER"
    },
    "F010": {
      "path": "./js/services/simulation/MarketService.js",
      "role": "LOGIC_SERVICE",
      "dependencies": [
        "js/services/IntelService.js"
      ]
    },
    "F011": {
      "path": "./js/services/SimulationService.js",
      "role": "LOGIC_FACADE"
    },
    "F014": {
      "path": "./js/services/eventEffectResolver.js",
      "role": "LOGIC_SERVICE",
      "dependencies": [
        "js/data/events.js"
      ]
    },
    "F015": {
      "path": "./js/services/EventManager.js",
      "role": "EVENT_HANDLER"
    },
    "F016": {
      "path": "./js/services/TutorialService.js",
      "role": "LOGIC_SERVICE"
    },
    "F017": {
      "path": "./js/services/UIManager.js",
      "role": "UI_RENDERER",
      "dependencies": [
        "js/services/IntelService.js",
        "js/ui/renderers/IntelMarketRenderer.js"
      ]
    },
    "F018": {
      "path": "./js/services/MissionService.js",
      "role": "LOGIC_SERVICE"
    },
    "F019": {
      "path": "./js/ui/components/CargoScreen.js",
      "role": "UI_COMPONENT"
    },
    "F020": {
      "path": "./js/ui/components/FinanceScreen.js",
      "role": "UI_COMPONENT"
    },
    "F021": {
      "path": "./js/ui/components/HangarScreen.js",
      "role": "UI_COMPONENT"
    },
    "F022": {
      "path": "./js/ui/components/IntelScreen.js",
      "role": "UI_COMPONENT",
      "description": "Renders the static shell for the Intel screen (Codex and Intel Market tabs)."
    },
    "F023": {
      "path": "./js/ui/components/MarketScreen.js",
      "role": "UI_COMPONENT"
    },
    "F024": {
      "path": "./js/ui/components/MissionsScreen.js",
      "role": "UI_COMPONENT"
    },
    "F025": {
      "path": "./js/ui/components/NavigationScreen.js",
      "role": "UI_COMPONENT"
    },
    "F026": {
      "path": "./js/ui/components/ServicesScreen.js",
      "role": "UI_COMPONENT"
    },
    "F027": {
      "path": "./js/ui/components/StatusScreen.js",
      "role": "UI_COMPONENT",
      "status": "deprecated"
    },
    "F028": {
      "path": "./js/ui/components/MapScreen.js",
      "role": "UI_COMPONENT"
    },
    "F029": {
      "path": "./js/services/DebugService.js",
      "role": "DEBUG_TOOL"
    },
    "F030": {
      "path": "./js/services/LoggingService.js",
      "role": "DEBUG_TOOL"
    },
    "F031": {
      "path": "./js/effects/BaseEffect.js",
      "role": "LOGIC_MODULE"
    },
    "F032": {
      "path": "./js/effects/EffectsManager.js",
      "role": "LOGIC_SERVICE"
    },
    "F033": {
      "path": "./js/services/game/IntroService.js",
      "role": "LOGIC_SERVICE"
    },
    "F034": {
      "path": "./js/services/player/PlayerActionService.js",
      "role": "LOGIC_SERVICE"
    },
    "F035": {
      "path": "./js/services/world/TimeService.js",
      "role": "LOGIC_SERVICE",
      "dependencies": [
        "js/services/IntelService.js"
      ]
    },
    "F036": {
      "path": "./js/services/world/TravelService.js",
      "role": "LOGIC_SERVICE"
    },
    "F037": {
      "path": "./meta/ROADMAP.md",
      "role": "DOCUMENTATION"
    },
    "F038": {
      "path": "./meta/ARCHITECTURAL_DECISIONS.md",
      "role": "DOCUMENTATION"
    },
    "F039": {
      "path": "./js/services/handlers/ActionClickHandler.js",
      "role": "EVENT_HANDLER"
    },
    "F040": {
      "path": "./js/services/handlers/MarketEventHandler.js",
      "role": "EVENT_HANDLER"
    },
    "F041": {
      "path": "./js/services/handlers/HoldEventHandler.js",
      "role": "EVENT_HANDLER"
    },
    "F042": {
      "path": "./js/services/handlers/CarouselEventHandler.js",
      "role": "EVENT_HANDLER"
    },
    "F043": {
      "path": "./js/services/handlers/TooltipHandler.js",
      "role": "EVENT_HANDLER"
    },
    "F044": {
      "path": "./js/services/ui/TravelAnimationService.js",
      "role": "UI_SERVICE"
    },
    "F045": {
      "path": "./css/orientation.css",
      "role": "STYLESHEET"
    },
    "F046": {
      "path": "ViewController.swift",
      "role": "NATIVE_IOS_WRAPPER"
    },
    "F047": {
      "path": "./meta/STATE_SCHEMA.md",
      "role": "DOCUMENTATION_STATE_SCHEMA"
    },
    "F048": {
      "path": "./meta/SERVICES.md",
      "role": "DOCUMENTATION_SERVICE_RESPONSIBILITY"
    },
    "F049": {
      "path": "./js/data/age_events.js",
      "role": "DATA_DEFINITION"
    },
    "F050": {
      "path": "./js/data/events.js",
      "role": "DATA_DEFINITION"
    },
    "F051": {
      "path": "./js/data/missions.js",
      "role": "DATA_DEFINITION"
    },
    "F052": {
      "path": "./js/data/tutorials.js",
      "role": "DATA_DEFINITION"
    },
    "F053": {
      "path": "./js/services/NewsTickerService.js",
      "role": "UI_SERVICE"
    },
    "F054": {
      "path": "./js/data/flavorAds.js",
      "role": "DATA_DEFINITION",
      "description": "Defines location-specific flavor text for the news ticker."
    },
    "F055": {
      "path": "./css/news-ticker.css",
      "role": "STYLESHEET"
    },
    "F056": {
      "path": "./js/data/intelMessages.js",
      "role": "DATA_DEFINITION",
      "description": "Defines templates for market intel messages for the news ticker."
    },
    "F057": {
      "path": "./js/services/IntelService.js",
      "role": "LOGIC_SERVICE"
    },
    "F058": {
      "path": "./js/ui/renderers/IntelMarketRenderer.js",
      "role": "UI_RENDERER"
    },
    "F059": {
      "path": "./js/data/intelContent.js",
      "role": "DATA_DEFINITION",
      "description": "Defines sample/detail text for the Intel Market."
    },
    "F060": {
      "path": "./js/services/ui/AnimationService.js",
      "role": "UI_SERVICE"
    },
    "F061": {
      "path": "./js/services/bot/AutomatedPlayerService.js",
      "role": "AUTOMATION_SERVICE",
      "description": "Contains the AutomatedPlayer class, a bot for stress-testing the economy."
    }
  }
}
--- END OF FILE: ./meta/lexicon.json ---

--- START OF FILE: ./meta/ROADMAP.md ---
## Immediate Concerns, Bugs, Issues
- n/a

## Planned Ideas
- Implement ship list
- implement ship lore
- Station Quirks
- (Gem3) Add ship card BOARDING effect
- Install tailwind CSS resources locally

## Long-Term Ideas
- Refine commodities names, identity
- Reputation system
- Player age events
- Player Stations
- Additional tutorials
- Design and canonize color themes, Orbital Trading brand, lore, planets, aesthetics
- Finalize mobile views
- Optimize repetitive calculations, long-term data accumulation, and re-renders
- Storyline
- Storyline Timeline Governor (Mission availability, System States, Features)
- Design cononical missions
- System states influencing market performance DEFERRED
- Tactile feedback
- Art design
- Sound design

## Far-Future Wishlist Ideas ()
- Purchasable stations
- Each ship has a unique nav bar
- Desktop version with super ultra wide compatibility
- Extend gameplay with simple but robust IAP DLC
--- END OF FILE: ./meta/ROADMAP.md ---

--- START OF FILE: ./meta/SERVICES.md ---
# Orbital Trading - Service Responsibilities
**Version:** 1.7
**Source:** `js/services/` directory structure and `js/data/` structure

This document defines the single responsibility of each service in the application and notes key static data dependencies.

---

### Core Services

-   **`GameState.js`**: Manages the central `state` object, provides load/save/reset functionality, and allows other services to subscribe to state changes.
-   **`SimulationService.js`**: Acts as the main game loop "heartbeat" (facade), triggering simulation ticks for all other time-based services (Time, Market) and delegating player actions and UI messages (e.g., to the `NewsTickerService`).
-   **`EventManager.js`**: Instantiates specialized handlers, binds global listeners, and delegates event handling to the appropriate module.
-   **`UIManager.js`**: Manages all DOM manipulation, screen rendering, UI state (modals, toasts), and data-binding updates based on GameState changes. New data-action handlers (`show_intel_offer`, `buy_intel`, `show_intel_details`) added for the Intel Market modal flow.
-   **`LoggingService.js`**: Provides a centralized service for logging debug, info, warn, and error messages to the console.
-   **`NewsTickerService.js`**: Manages the dynamic message queue for the scrolling news ticker. Handles different message types (SYSTEM, INTEL, FLAVOR, ALERT, STATUS), rebuilds the queue on location change, and pulls data from various sources. Is a primary driver for the Intel system. **Uses:** `js/data/flavorAds.js`, `js/data/intelMessages.js`, `js/data/database.js`.

### Game Logic Services

#### Player

-   **`PlayerActionService.js`**: Contains all business logic for player-initiated actions with immediate effects (buy/sell items/ships, use services).

#### World

-   **`TimeService.js`**: Manages the in-game clock, advancing the `GameState.day` and triggering time-based events (birthdays, interest, market updates) via the `SimulationService` facade. Calls `IntelService.generateIntelRefresh()` and checks for `activeIntelDeal` expiration. **Uses:** `js/data/age_events.js`.
-   **`TravelService.js`**: Handles the business logic for player travel, initiating trips, calculating costs/time, and managing random events. **Uses:** `js/data/events.js` (via `eventEffectResolver`).

#### Simulation

-   **`MarketService.js`**: Simulates the galactic economy. Manages all price evolution (mean reversion, volatility) and inventory replenishment. It implements a "Delayed Supply" model where player actions (buy/sell) change stock levels, which in turn creates a single, powerful `availabilityEffect` on price that is *delayed by 7 days* to prevent abuse. Checks for an `activeIntelDeal` override before calculating its normal prices.
-   **`IntelService.js`**: The "brain" of the Intel Market system. Manages the entire lifecycle of intel: procedural generation, persistence, dynamic pricing, and the core purchase logic. **Uses:** `js/data/intelContent.js`.
-   **`MissionService.js`**: Manages the state of player missions, checking objective progress and updating `GameState.missions` when criteria are met. **Uses:** `js/data/missions.js`.

#### Game

-   **`IntroService.js`**: Manages the logic for the one-time introductory sequence and splash screen.
-   **`TutorialService.js`**: Controls the flow of the tutorial, managing steps and dispatching tutorial-specific UI events. **Uses:** `js/data/tutorials.js`.

### UI/Event Handlers

-   **`ActionClickHandler.js`**: Handles general `data-action` click events (navigation, simple modals, basic state changes).
-   **`MarketEventHandler.js`**: Manages complex UI interactions specific to the Market screen commodity cards.
-   **`HoldEventHandler.js`**: Implements the "click-and-hold" functionality for buttons (e.g., refuel/repair, market quantity steppers).
-   **`CarouselEventHandler.js`**: Manages the swipe/drag/wheel logic for carousel components (e.g., Hangar ship selector).
-   **`TooltipHandler.js`**: Attaches and manages global listeners to show/hide tooltips, price graphs, etc., on hover/click.
-   **`TravelAnimationService.js`**: Controls the visual "travel animation" modal when the player travels.

### UI/Renderers

-   **`IntelMarketRenderer.js`**: A new, dedicated renderer. Its sole job is to be called by UIManager to dynamically build the HTML for the content of the "Intel Market" tab.

### Event Effects

-   **`eventEffectResolver.js`**: A central service that applies the game logic effects of a random event outcome by routing to specific handlers. **Uses:** `js/data/events.js`.
-   **`effectAdriftPassenger.js`**: The specific implementation for the "Adrift Passenger" event outcome.
-   **`effectSpaceRace.js`**: The specific implementation for the "Space Race" event outcome.

### Effects

-   **`EffectsManager.js`**: Manages the queueing and execution of visual effects (particle effects, UI animations, etc.).
-   **`BaseEffect.js`**: The abstract base class for all visual effects.

### Debug & Automation

-   **`DebugService.js`**: Manages the debug panel (`lil-gui`), synchronizing its UI controls with the `GameState` and providing cheat/test functionalities.
-   **`bot/AutomatedPlayerService.js`**: Contains the `AutomatedPlayer` class, a state-machine-driven bot designed to stress-test the economy by simulating an advanced, market-manipulating player.

---

### Static Data Files (`js/data/`)

-   **`database.js`**: Aggregates and exports static game data imported from other modules (constants, commodities, ships, markets, etc.).
-   **`constants.js`**: Defines widely used constant values and enums (IDs, game rules).
-   **`age_events.js`**: Defines static data for narrative events triggered by game progression (e.g., player age, wealth).
-   **`events.js`**: Defines static data for random events encountered during travel.
-   **`missions.js`**: Defines static data for all player missions.
-   **`tutorials.js`**: Defines static data for all tutorial batches and steps.
-   **`flavorAds.js`**: Defines static, location-specific flavor text ads for the news ticker.
-   **`intelMessages.js`**: Defines message templates for free and purchased market intel displayed on the news ticker.
-   **`intelContent.js`**: Defines the "Sample" and "Details" message pairs for the purchasable Intel Packets in the Intel Market.
--- END OF FILE: ./meta/SERVICES.md ---

--- START OF FILE: ./meta/ARCHITECTURAL_DECISIONS.md ---
# Architectural Decision Records (ADRs)

This document records the key architectural decisions made during the development of Orbital Trading. Understanding the "why" behind these decisions is crucial for maintaining a consistent and robust codebase.

---

### ADR-001: Service-Oriented Architecture & Unidirectional Data Flow

* **Status**: Accepted (2025-07-XX)
* **Context**: The initial prototype had game logic loosely distributed, making state management and debugging difficult. A predictable and traceable state mutation model was required to build a stable application.
* **Decision**: The application was architected around a strict unidirectional data flow model (`Input -> Logic -> State -> Render`). All mutable game data is held in a single `GameState` object. Game logic is encapsulated in specialized, single-responsibility services that are coordinated by a central `SimulationService` facade. The `UIManager` reads from the `GameState` to render the UI, but never modifies it directly.
* **Consequences**:
    * **Pro**: State changes are highly predictable and easy to trace back to the service that initiated them.
    * **Pro**: Prevents complex, circular dependencies and potential race conditions.
    * **Pro**: Simplifies debugging by creating a single source of truth for all game data.
    * **Con**: Can introduce boilerplate, as even minor state changes must flow through the entire service -> state -> UI loop.

---

### ADR-002: SimulationService as a Facade & EventManager Refactor

* **Status**: Accepted (2025-09-29)
* **Context**: As new features were added, `SimulationService` was becoming a "god object" with too many direct responsibilities (player actions, time progression, travel, etc.). Similarly, the `EventManager` contained a large, monolithic click handler with complex conditional logic.
* **Decision**: `SimulationService` was refactored into a lean **Facade**. Its direct logic was extracted into new, specialized services (`PlayerActionService`, `TravelService`, `TimeService`, etc.). `EventManager` was refactored to delegate input handling to context-specific modules (`MarketEventHandler`, `CarouselEventHandler`, etc.).
* **Consequences**:
    * **Pro**: Enforces the Single Responsibility Principle, making the codebase significantly more modular and organized.
    * **Pro**: Logic for a specific domain (e.g., travel) is now located in a single, predictable place.
    * **Pro**: Reduces the cognitive load required to understand and modify any single part of the system.
    * **Con**: Increases the number of files and the initial setup complexity in `SimulationService`'s constructor.

---

### ADR-003: Decommissioning of `SystemSurgeEffect`

* **Status**: Accepted (2025-10-10)
* **Context**: The `SystemSurgeEffect` was a visual effect intended to celebrate major player achievements. However, it suffered from persistent and critical rendering bugs on the primary target platform (iOS PWA) that proved difficult to resolve.
* **Decision**: The entire feature was surgically removed from the codebase. This included its dedicated JavaScript and CSS files, all HTML containers, and every line of code that triggered the effect from other services (`GameState`, `MissionService`, `DebugService`).
* **Consequences**:
    * **Pro**: Eliminates a source of critical, user-facing bugs, immediately improving application stability.
    * **Pro**: Creates a clean slate, free of legacy code, for a future, more robust and performant replacement effect.
    * **Con**: Temporarily removes a "juice" or "reward" feature from the player experience.

---

### ADR-004: Robust "Hold-to-Act" Event Handling

* **Status**: Accepted (2025-10-22)
* **Context**: The "hold-to-act" buttons (Refuel, Repair) on the Services screen exhibited "sticky" or "toggle" behavior on the primary test target (iOS Simulator / WKWebView). A `mousedown`/`touchstart` would trigger the action, but the UI re-render (caused by the resulting state change) would destroy the original button element. This prevented the corresponding `mouseup`/`touchend` event from ever being received, leaving the action "stuck" in an active loop.
* **Decision**: A persistent, delegated, and capture-phase event model was implemented in `HoldEventHandler.js`.
    1.  **Use Pointer Events**: Switched from separate `mouse` and `touch` events to the modern **Pointer Events API** (`pointerdown`, `pointerup`, `pointercancel`) for unified and more reliable input handling.
    2.  **Delegated "Start"**: A single, persistent `pointerdown` listener is attached to `document.body`. This listener never gets destroyed and delegates the event to the correct handler based on `e.target`.
    3.  **Capture-Phase "Stop"**: Single, persistent `pointerup` and `pointercancel` listeners are attached to the `window` object using the **`{ capture: true }`** option. This ensures the "stop" event is intercepted *before* the UI re-render can stop its propagation.
    4.  **State-Based Logic**: The `_start...` and `_stop...` functions no longer add/remove listeners. They *only* set internal state flags (e.g., `this.activeElementId`), which the persistent global listeners check.
* **Consequences**:
    * **Pro**: Creates an extremely robust event handling model that is immune to UI re-renders, permanently fixing the "sticky button" bug.
    * **Pro**: Simplifies the handler logic by removing the need to manually manage listener lifecycles.
    * **Pro**: Consolidates mouse and touch logic into a single, cleaner API.

---

### ADR-005: Economic Model Refactor to "Delayed Supply"

* **Status**: Accepted (2025-10-30)
* **Context**: The previous economic model used two separate forces: an immediate `availabilityEffect` (from stock changes) and a delayed `pressureEffect` (a direct player penalty). This created a "double-dip," was logically redundant, and hard to tune.
* **Decision**: The model was unified into a single force. The old `pressureEffect` and immediate `availabilityEffect` were removed from the price calculation. The *new* model uses a single **`availabilityEffect`** (derived from the `availabilityRatio` of current stock vs. target stock) as the sole driver of player-initiated price changes. To prevent same-day abuse, this new `availabilityEffect` is now **delayed by 7 days** (inheriting the delay logic from the old system). The strength of this effect was also tuned to `0.50` to make it a viable core gameplay loop.
* **Consequences**:
    * **Pro**: Simplifies the economic model to a single, clean cause-and-effect (trade -> delayed price change).
    * **Pro**: Eliminates the "double-dip," making the market's reaction more logical and easier to balance.
    * **Pro**: Still achieves the primary goal of preventing same-day/same-visit market manipulation.
    * **Pro**: The `marketPressure` variable is retained, but as correctly noted in `ECONOMIC_BEHAVIOR.md`, it is now used *exclusively* for its non-price-related logic (influencing `targetStock` in replenishment), not for price calculation.

---

### ADR-006: Intel System Refactor to "Local Data Broker"

* **Status**: Accepted (2025-11-04)
* **Context**: The original `IntelScreen.js` was a static, non-interactive lore repository. A new, recyclable gameplay loop and credit-sink was needed to drive player engagement and travel.
* **Decision**: Refactored the Intel system into a two-tab component ('Codex' for lore, 'Intel Market' for gameplay). A new `IntelService` was created to procedurally generate, price, and manage 'Intel Packets'. A dedicated `IntelMarketRenderer` was created to dynamically build the 'shop' UI, separating dynamic content from the static `IntelScreen` shell. This implements the 'Local Data Broker' feature.
* **Consequences**:
    * **Pro**: Separates logic (`IntelService`) from static presentation (`IntelScreen`) and dynamic presentation (`IntelMarketRenderer`), avoiding a monolithic component.
    * **Pro**: Creates a systemic, scalable, and recyclable gameplay loop.
    * **Pro**: Provides a scalable, dynamic credit-sink based on player wealth.
    * **Pro**: Creates a strong, non-arbitrary incentive for player travel.
    * **Con**: Increases the number of services and adds new dependencies to `TimeService` and `MarketService`.

---

### ADR-007: Dynamic Viewport "Letterbox" Scaling

* **Status**: Accepted (2025-11-16)
* **Context**: The game's UI is designed for a tall phone screen aspect ratio (e.g., iPhone Pro Max, ~926px). On shorter devices (e.g., iPhone SE) or in mobile browsers where the URL bar reduces the `visualViewport`, the UI was "crushed" and clipped.
* **Decision**: Implemented a dynamic scaling mechanism to ensure layout integrity.
    1.  **CSS Foundation**: `body` is set to `display: flex`, `align-items: center`, `justify-content: center`, and `height: 100dvh`. `css/global.css` padding for `.game-container` was corrected to use `env(safe-area-inset-top)`.
    2.  **JS Scaling Logic**: The `setAppHeight` function in `js/main.js` now runs on load and resize. It compares the `window.visualViewport.height` to a fixed `DESIGN_TARGET_HEIGHT` of 926px.
    3.  **Scaling (If Shorter)**: If `visualHeight < DESIGN_TARGET_HEIGHT`, a CSS `transform: scale()` is applied to the `.game-container`, and `transform-origin` is set to `top center`. The `body`'s `align-items` is set to `flex-start` to align the scaled container to the top of the viewport.
    4.  **No Scaling (If Taller)**: If `visualHeight >= DESIGN_TARGET_HEIGHT`, the `transform` is set to `none`, and the `body`'s `align-items` is set to `center` to vertically center the container.
* **Consequences**:
    * **Pro**: Guarantees the game's UI fits proportionally on any screen shorter than the 926px design target, preventing all clipping and layout breakage.
    * **Pro**: Maintains the intended 1:1 layout on the target device (iPhone Pro Max) and taller screens (where it is vertically centered).
    * **Pro**: Uses `visualViewport` to correctly adapt to dynamic browser UI changes (URL bar, keyboard).
    * **Con**: Results in black bars (letterboxing) on shorter devices, as the UI does not reflow. This is the accepted trade-off for layout integrity.
--- END OF FILE: ./meta/ARCHITECTURAL_DECISIONS.md ---

--- START OF FILE: ./meta/DATA_FLOW.md ---
# Orbital Trading - Core Data Flow

## System Architecture

The application is built on a strict **unidirectional data flow** model. This ensures that the state of the game is always predictable and that data mutations are traceable.

-   **Input Layer (`EventManager` & Handlers)**: Captures all user interactions and translates them into specific, semantic game actions.
-   **Logic Layer (`SimulationService` & Sub-Services)**: Executes the core game logic in response to actions from the input layer. This is the only layer authorized to request a state change.
-   **State Layer (`GameState`)**: The single source of truth. It holds all mutable game data and notifies the UI layer when changes occur.
-   **Output Layer (`UIManager`)**: Renders the UI based on the current data from the `GameState`. It is a "dumb" layer that only reads state and displays it.

---

## Core Logic Flowchart

The system uses two primary flows: a main flow for most game actions, and a "hot loop" for high-frequency, responsive actions.

```mermaid
graph TD
    subgraph Input Layer
        A[User Interaction e.g., Click/PointerDown] --> B{EventManager / Handlers};
    end

    subgraph Logic Layer
        B -- 1a. Main Flow (e.g., Buy Item) --> D[SimulationService Facade];
        D --> E[Specialized Service e.g., PlayerActionService];

        B -- 1b. Hot Loop (e.g., Refuel Tick) --> E;
    end

    subgraph State Layer
        E -- 2. Executes logic & computes new state --> F((GameState));
    end

    subgraph Output Layer
        F -- 3. Notifies subscribers of change --> G[UIManager];
        G -- 4. Reads new state & re-renders UI --> H[DOM];
    end

    H --> A;

    style F fill:#2a9d8f,stroke:#fff,stroke-width:2px
    style G fill:#f4a261,stroke:#fff,stroke-width:2px
}
Detailed Flow Example: Intel Market (Local Data Broker)
This diagram shows the data flow for the "Local Data Broker" feature, from rendering the shop to the activeIntelDeal affecting market prices.

Code snippet

graph TD
    subgraph Player Action (UI)
        A[Player clicks 'Intel Market' tab] --> B[UIManager calls IntelMarketRenderer];
        B --> C{Reads gameState.intelMarket[loc_id]};
        C --> D[IntelService.calculateIntelPrice(packet)];
        D --> E[Renders 'Purchase Intel' button];
        E -- Click --> F[UIManager.handleBuyIntel];
    end

    subgraph Logic Layer (Services)
        F --> G[IntelService.purchaseIntel(packetId)];
        G -- 1. --> H[Deducts player.credits];
        G -- 2. --> I[Sets packet.isPurchased = true];
        G -- 3. --> J[Creates 'activeIntelDeal' object];
        G -- 4. --> K[NewsTickerService.pushMessage];
    end

    subgraph State Layer
        H & I & J -- 5. Update --> L((GameState));
    end

    subgraph Downstream Effects
        L -- 6. On next Market render --> M[MarketService.getPrice(loc, comm)];
        M --> N{activeIntelDeal exists?};
        N -- Yes --> O[Return deal.overridePrice];
        N -- No --> P[...normal price logic...];
        
        L -- 7. On daily tick --> Q[TimeService.pulse];
        Q --> R{activeIntelDeal expired?};
        R -- Yes --> S[Set activeIntelDeal = null];
    end

    style L fill:#2a9d8f,stroke:#fff,stroke-width:2px
Explanation of Intel Market Data Flow
UI Render: When the 'Intel Market' tab is clicked, IntelMarketRenderer is called. [cite_start]It reads gameState.intelMarket for the current location and calls IntelService.calculateIntelPrice for each packet to get a dynamic price based on player credits.

Player Purchase: Player clicks 'Purchase'. [cite_start]UIManager calls IntelService.purchaseIntel.

Transaction Logic: IntelService validates the purchase, deducts player.credits, sets the packet's isPurchased flag, and (most importantly) creates the gameState.activeIntelDeal object. [cite_start]This object "locks" the market.

Market Override: The MarketService.getPrice function is modified to first check for an activeIntelDeal. [cite_start]If a deal matches the location and commodity, it returns the deal.overridePrice, bypassing all normal simulation logic.

Expiration: The TimeService.pulse function checks daily if the activeIntelDeal has expired. [cite_start]If it has, it sets activeIntelDeal back to null, "unlocking" the Intel Market.

Detailed Flow Example: Market Simulation
This diagram shows the data flow for the "Delayed Supply" economic model, which is triggered by a player trade and processed during the weekly simulation tick.

Code snippet

graph TD
    subgraph Player Action (Instant)
        A[PlayerActionService.buyItem/sellItem] --> B[Sets inventoryItem.lastPlayerInteractionTimestamp];
        A --> C[Instantly changes inventoryItem.quantity];
        A --> D[Sets inventoryItem.marketPressure];
    end

    subgraph Weekly Tick (Delayed)
        E(TimeService.advanceDays) --> F[SimulationService.updateMarket];
        F --> G[MarketService.evolveMarketPrices];
        F --> H[MarketService.replenishMarketInventory];
    end

    subgraph Price Logic (evolveMarketPrices)
        G --> I{Day >= timestamp + 7?};
        I -- No (Delay Active) --> J[Price change = meanReversion + randomFluctuation];
        I -- Yes (Delay Over) --> K[Calculate availabilityEffect from quantity];
        K --> L[Price change = meanReversion + randomFluctuation + availabilityEffect];
        C -.-> K;
        B -.-> I;
    end

    subgraph Stock Logic (replenishMarketInventory)
        H --> M[Calculate targetStock];
        M --> N[Calculate 10% replenishment];
        H --> O[Reset state if untouched > 120 days];
        D -.-> M;
    end

    style A fill:#e63946,stroke:#fff
    style E fill:#457b9d,stroke:#fff
Explanation of Market Data Flow
This model ensures player actions have a powerful, delayed effect, preventing same-day abuse.

Instant Player Action: When a player trades, PlayerActionService immediately modifies the GameState:

It changes the item's quantity (e.g., increases it on a sale).

It sets lastPlayerInteractionTimestamp to the current day.

It sets marketPressure (this is only for stock logic, not price).

It activates the priceLockEndDay (this disables meanReversion).

Weekly Price Logic (evolveMarketPrices): On the weekly tick, MarketService runs its price logic:

It checks if the 7-day anti-abuse delay has passed (Day >= timestamp + 7).

If NO (Delay Active): No availabilityEffect is calculated. The price is only affected by natural meanReversion (which is likely disabled by the Price Lock) and randomFluctuation.

If YES (Delay Over): The availabilityEffect is calculated now, using the quantity the player changed days ago. This single effect (tuned to 0.50 strength) creates the large price crash or spike.

Weekly Stock Logic (replenishMarketInventory):

This system runs separately and is not subject to the 7-day price delay.

It uses the marketPressure set by the player to dynamically adjust the targetStock.

It then moves the quantity 10% closer to this targetStock every week, creating the "race" for the player as the market's supply (and thus its price) slowly recovers.

Detailed Flow Example: Animated Ship Purchase
This diagram illustrates the asynchronous event flow for purchasing a ship, which includes a blocking animation.

Code snippet

graph TD
    subgraph Input Layer
        A[Click 'Buy Ship' Button] --> B[EventManager];
        B --> C[ActionClickHandler.handle (async)];
    end

    subgraph Logic Layer
        C -- 1. --> D[SimulationService.buyShip (async)];
        D -- 2. --> E[PlayerActionService.validateBuyShip];
        E -- 3. (Success) --> D;
        D -- 4. --> F[UIManager.runShipTransactionAnimation (await)];
        F -- 5. --> G[AnimationService.playBlockingAnimation (await)];
    end
    
    subgraph Output Layer
        G -- 6. (Animation ends) --> H[Promise Resolves];
    end

    subgraph Logic Layer
        H -- 7. --> D;
        D -- 8. --> I[PlayerActionService.executeBuyShip];
    end

    subgraph State Layer
        I -- 9. --> J((GameState.setState));
    end

    subgraph Output Layer
        J -- 10. --> K[UIManager.render];
        K -- 11. --> L[DOM (Ship card is gone)];
    end

    style J fill:#2a9d8f,stroke:#fff,stroke-width:2px
    style K fill:#f4a261,stroke:#fff,stroke-width:2px
    style F fill:#e76f51,stroke:#fff,stroke-width:2px
    style G fill:#e76f51,stroke:#fff,stroke-width:2px
Explanation of Animated Ship Purchase Flow
Async Handling: The EventManager and ActionClickHandler are now async to handle the await keyword.

Orchestration: SimulationService.buyShip acts as the orchestrator.

Validation: It first calls the synchronous PlayerActionService.validateBuyShip. If this fails, the process stops.

Blocking Animation: On success, it calls await UIManager.runShipTransactionAnimation. The await keyword pauses the execution of the buyShip function.

Promise: The UIManager in turn calls await AnimationService.playBlockingAnimation. This service attaches a CSS animation class and returns a Promise that only resolves when the animationend event fires.

Execution: Once the animation Promise resolves, execution resumes in SimulationService.buyShip. It then calls the synchronous PlayerActionService.executeBuyShip.

State Change: executeBuyShip mutates the GameState (deducts credits, adds ship).

Final Render: The GameState.setState call notifies UIManager.render, which re-renders the Hangar/Shipyard, now showing the newly purchased ship (or its absence from the shipyard list).
--- END OF FILE: ./meta/DATA_FLOW.md ---

--- START OF FILE: ./meta/STATE_SCHEMA.md ---
Orbital Trading - GameState Schema
Version: 2.3 Source: js/services/GameState.js (see startNewGame method)

This document defines the structure of the central GameState object, which is instantiated in main.js and managed by GameState.js. It is the "source of truth" for all dynamic, mutable data in the application.

day: {number} - The current in-game day.

lastInterestChargeDay: {number} - The day on which player debt interest was last calculated.

lastMarketUpdateDay: {number} - The day on which market prices and inventories were last updated.

currentLocationId: {string} - The LOCATION_ID where the player is currently docked.

activeNav: {string} - The NAV_ID of the currently active main navigation tab (e.g., "ship", "starport").

activeScreen: {string} - The SCREEN_ID of the currently active screen (e.g., "map", "market").

isGameOver: {boolean} - Flag indicating if the game over state has been triggered.

subNavCollapsed: {boolean} - Flag tracking the UI state of the sub-navigation bar.

introSequenceActive: {boolean} - Flag indicating if the introductory tutorial/sequence is active.

lastActiveScreen: {object} - A map storing the last active screen for each main navigation tab.

[NAV_ID: string]: {string} - The SCREEN_ID to return to (e.g., ship: "map").

pendingTravel: {object | null} - If not null, contains details of a travel action interrupted by an event.

destinationId: {string} - The LOCATION_ID the player was traveling to.
eventHullDamagePercent: {number} - (Optional) Hull damage from an event, applied on arrival.
travelTimeAdd: {number} - (Optional) Flat number of days added to the trip by an event.
travelTimeAddPercent: {number} - (Optional) Multiplier to increase travel time from an event.
setTravelTime: {number} - (Optional) A new, fixed travel time set by an event.

player: {object} - Contains all data specific to the player.

name: {string} - The player's chosen name.

playerTitle: {string} - The player's current title (e.g., "Captain").

playerAge: {number} - The player's current age.

lastBirthdayYear: {number} - The in-game year of the player's last birthday.

birthdayProfitBonus: {number} - A permanent, cumulative profit bonus that increases each birthday.

introStep: {number} - A counter tracking progress through the intro sequence.

credits: {number} - Player's current currency.

debt: {number} - Player's outstanding loan amount.

monthlyInterestAmount: {number} - The amount of interest added to the debt each cycle.

loanStartDate: {number | null} - The day on which the loan was taken.

seenGarnishmentWarning: {boolean} - Flag tracking if the player has been warned about wage garnishment.

revealedTier: {number} - The highest market tier the player has unlocked.

unlockedLicenseIds: {Array<string>} - A list of LICENSE_IDs the player has purchased.

unlockedLocationIds: {Array<string>} - A list of LOCATION_IDs the player is allowed to visit.

seenCommodityMilestones: {Array<string>} - A log of commodity trade value milestones achieved.

financeLog: {Array<object>} - A log of all financial transactions.

{object}:

day: {number} - The day of the transaction.

type: {string} - "buy", "sell", "interest", "loan", "payment", "ship", "fee", "bonus".

amount: {number} - Credits value (positive for income, negative for expense).

description: {string} - Human-readable log (e.g., "Bought 10 Water").

activePerks: {object} - A map of active player perks (e.g., `PERK_IDS.NAVIGATOR: true`).

seenEvents: {Array<string>} - A list of EVENT_IDs the player has already encountered.

activeShipId: {string} - The SHIP_ID of the player's currently active ship.

ownedShipIds: {Array<string>} - A list of SHIP_IDs for all ships the player owns.

shipStates: {object} - A map of the dynamic state for each ship the player owns.

[SHIP_ID: string]: {object}

health: {number} - Current hull integrity.

fuel: {number} - Current fuel units.

hullAlerts: {object} - Flags for triggering hull damage warnings.

one: {boolean} - Flag for first damage warning.

two: {boolean} - Flag for second (critical) damage warning.

inventories: {object} - A map of cargo inventories, keyed by SHIP_ID.

[SHIP_ID: string]: {object}

[COMMODITY_ID: string]: {object}

quantity: {number} - The quantity of the commodity held.

avgCost: {number} - The average purchase price for the units held, for profit tracking.

debugEventIndex: {number} - A developer tool for forcing specific events.

market: {object} - Contains all data related to the galactic economy.

prices: {object} - A map of current commodity prices by location.

[LOCATION_ID: string]: {object}

[COMMODITY_ID: string]: {number} - The current price.

inventory: {object} - A map of current commodity inventory by location.

[LOCATION_ID: string]: {object}

[COMMODITY_ID: string]: {object}

quantity: {number} - The current available quantity.

marketPressure: {number} - A value from -1 to 1 tracking player impact on this item.

lastPlayerInteractionTimestamp: {number} - The day the player last traded this item here.

hoverUntilDay: {number} - The day until which this item's price is artificially modified by an event.

rivalArbitrage: {object} - Tracks AI rival activity.

isActive: {boolean} - Whether a rival is currently targeting this item.

endDay: {number} - The day this rival activity will cease.

priceLockEndDay: {number} - The day until which natural mean reversion is disabled for this item.

isDepleted: {boolean} - Flag indicating if the item was bought out, triggering a price hike.

depletionDay: {number} - The day the depletion event was triggered.

depletionBonusDay: {number} - The day the depletion cooldown was set (prevents spamming).

galacticAverages: {object} - A map of the baseline average price for each commodity.

[COMMODDITY_ID: string]: {number} - The calculated average price.

priceHistory: {object} - A log of the last N prices for charts.

[LOCATION_ID: string]: {object}

[COMMODITY_ID: string]: {Array<number>} - An array of recent prices.

shipyardStock: {object} - A map of ships available for sale at each location.

[LOCATION_ID: string]: {object}

day: {number} - The day the stock was last refreshed.

shipsForSale: {Array<string>} - A list of SHIP_IDs available for purchase.

intelMarket: {object} - The master "inventory" for all Data Brokers, keyed by locationId.

[LOCATION_ID: string]: {Array<object>} - An array of `intelPacket` objects available at this location.

{intelPacket}:
id: {string} - Unique packet ID.
locationId: {string} - The location where the packet is SOLD.
dealLocationId: {string} - The location where the DEAL is.
commodityId: {string} - The commodity of the deal.
discountPercent: {float} - The hidden discount (e.g., 0.40).
durationDays: {integer} - The hidden duration (used for pricing).
valueMultiplier: {float} - Scaling factor for price calculation.
messageKey: {string} - Key to look up text in `intelContent.js`.
isPurchased: {boolean} - State flag, `false` by default.
pricePaid: {number} - (Set on purchase) The credit amount the player paid.
expiryDay: {number} - (Set on purchase) The game day the deal expires.

activeIntelDeal: {object | null} - Stores the single active, purchased deal. If `null`, the Intel Market is "unlocked".

locationId: {string} - The location where the deal is active (dealLocationId from packet).
commodityId: {string} - The commodity affected by the deal.
overridePrice: {number} - The pre-calculated, locked-in price for the commodity.
expiryDay: {number} - The game-day this deal expires.
sourcePacketId: {string} - The ID of the packet that generated this deal.
sourceSaleLocationId: {string} - The LOCATION_ID of the market where the packet was purchased.

tutorials: {object} - State of the Tutorial Toast System (TTS).

activeBatchId: {string | null} - The ID of the tutorial batch currently being displayed.

activeStepId: {string | null} - The ID of the specific tutorial step currently being displayed.

seenBatchIds: {Array<string>} - A list of tutorial batch IDs the player has already completed.

skippedTutorialBatches: {Array<string>} - A list of batch IDs the player has explicitly skipped.

navLock: {object | null} - If set, locks the UI to a specific NAV_ID or SCREEN_ID (e.g., `{ navId: 'ship', screenId: 'navigation' }`).

missions: {object} - Tracks mission states.

activeMissionId: {string | null} - The MISSION_ID of the player's currently accepted mission.

completedMissionIds: {Array<string>} - A list of MISSION_IDs the player has completed.

missionProgress: {object} - A map for tracking progress on specific mission objectives.

activeMissionObjectivesMet: {boolean} - A flag set to true when all objectives for the active mission are complete.

uiState: {object} - Contains the transient state of various UI components.

marketCardMinimized: {object} - A map tracking the minimized state of market cards.

[COMMODITY_ID: string]: {boolean} - True if the card is minimized.

hangarShipyardToggleState: {string} - The active tab on the Hangar screen ("hangar" or "shipyard").

hangarActiveIndex: {number} - The index of the ship carousel slide in "hangar" mode.

shipyardActiveIndex: {number} - The index of the ship carousel slide in "shipyard" mode.

activeIntelTab: {string} - The active tab on the Intel screen ("codex" or "market").
--- END OF FILE: ./meta/STATE_SCHEMA.md ---

