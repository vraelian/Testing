<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">

    <script>
      window.onerror = function(message, source, lineno, colno, error) {
        // This function will catch any uncaught JavaScript error.
        var fullMessage = "Message: " + message + "\nSource: " + source + "\nLine: " + lineno + "\nColumn: " + colno;
        
        // Check if the webkit message handler exists and send the error message to our Swift code.
        if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.errorObserver) {
          window.webkit.messageHandlers.errorObserver.postMessage(fullMessage);
        }
        
        // Prevent the browser's default error handling.
        return true;
      };
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>Orbital Trading 31.00</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lil-gui@0.19"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&family=Orbitron:wght@500;700&family=Roboto+Mono:wght@400;700&family=Aldrich&family=Space+Mono:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/global.css">
    <link rel="stylesheet" href="./css/navigation.css">
    <link rel="stylesheet" href="./css/news-ticker.css"> <link rel="stylesheet" href="./css/modals.css">
    <link rel="stylesheet" href="./css/hud.css">
    <link rel="stylesheet" href="./css/missions.css">
    <link rel="stylesheet" href="./css/tutorial.css">
    <link rel="stylesheet" href="./css/debug.css">
    <link rel="stylesheet" href="./css/screens/market-screen.css">
    <link rel="stylesheet" href="./css/screens/hangar-screen.css">
    <link rel="stylesheet" href="./css/screens/navigation-screen.css">
    <link rel="stylesheet" href="./css/screens/finance-screen.css">
    <link rel="stylesheet" href="./css/screens/intel-screen.css">
    <link rel="stylesheet" href="./css/screens/map-screen.css">
    <link rel="stylesheet" href="./css/screens/services-screen.css">
    <link rel="stylesheet" href="./css/screens/cargo-screen.css">
    <link rel="icon" href="./favicon.svg" type="image/svg+xml">
</head>
<body>

    <div id="splash-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-8 text-center bg-[#0c101d]">
        <button id="debug-start-btn" class="btn" data-action="debug-simple-start">D</button>
        <div class="max-w-3xl w-full panel-border border border-slate-700 bg-black/30 p-8 md:p-12 rounded-lg btn-pulse">
            <h1 class="text-6xl md:text-7xl font-orbitron font-bold text-cyan-300 mb-2">Orbital Trading</h1>
            <p class="text-xl md:text-2xl text-gray-400 mb-16"><span class="hl">A game of heliocentric adventure & arbitrage</span></p>
          
    
            <div class="flex flex-col items-center gap-4 w-full max-w-sm mx-auto">
                <button id="start-game-btn" class="btn btn-header btn-pulse w-full">Start Game</button>
                <button class="btn btn-header w-full" disabled="">Load Game</button>
                <button class="btn btn-header w-full" disabled="">Options</button>
            </div>
    
        </div>

        <footer class="absolute bottom-4 text-center text-slate-500 text-sm w-full">
            <p>Version 31.00</p>
            <a href="https://docs.google.com/forms/d/e/1FAIpQLSeVqjUEC6nsZlxTQ9-vzz0_fHO0ng8w0AueZaGzkHPoLJIBDA/viewform?usp=header" target="_blank" class="hover:text-cyan-300 transition-colors"><span class="hl">Submit Playtesting Feedback</span></a>
        </footer>
    </div>
    
    <div id="save-toast" class="hidden fixed top-5 left-1/2 -translate-x-1/2 bg-cyan-500/80 text-white px-6 py-2 rounded-lg shadow-lg transition-all duration-300 pointer-events-none z-50">Checkpoint Saved</div>
    <div id="garnishment-toast" class="hidden fixed top-5 left-1/2 -translate-x-1/2 text-white px-6 py-2 rounded-lg shadow-lg transition-all duration-300 pointer-events-none z-50"></div>
    <div id="hull-warning-toast" class="hidden fixed top-20 left-1/2 -translate-x-1/2 text-white px-6 py-2 rounded-lg shadow-lg transition-all duration-300 pointer-events-none z-50"></div>
    <div id="starport-unlock-tooltip" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-gray-900/90 text-white px-6 py-3 rounded-lg shadow-lg transition-all duration-300 pointer-events-none z-50 border border-yellow-500 text-center">
        Pay off your initial loan to access the Starport!
    </div>

    <main id="game-container" class="game-container hidden">
        <div id="top-bar-container">
            <header id="header-main" class="relative">
                <div id="nav-bar"></div>
                <div id="news-ticker-bar"></div> <div id="sub-nav-bar"></div>
            </header>
            <div id="sticky-bar"></div>
        </div>
        
        <div class="main-content-wrapper px-4 md:px-8 pb-4 md:pb-8">
            <div id="main-content">
                <div id="map-screen" class="screen"></div>
                <div id="navigation-screen" class="screen"></div>
                <div id="services-screen" class="screen"></div>
               
                <div id="market-screen" class="screen"></div>
                <div id="cargo-screen" class="screen"></div>
                <div id="hangar-screen" class="screen"></div>

                <div id="missions-screen" class="screen"></div>
                <div id="finance-screen" class="screen"></div>
                <div id="intel-screen" class="screen"></div>
            </div>
        </div>

        <div id="mission-modal" class="modal-backdrop hidden">
            <div class="modal-content sci-fi-frame flex flex-col items-center text-center">
                <div class="modal-header">
                    <div>
                        <h3 id="mission-modal-title" class="text-xl font-orbitron mb-1"></h3>
                        <p id="mission-modal-type" class="mission-type"></p>
                    </div>
                    
                </div>
                <p id="mission-modal-description" class="my-4 text-gray-300"></p>
                <div id="mission-modal-objectives"></div>
                <div id="mission-modal-rewards" class="reward-section mb-4"></div>
                <div id="mission-modal-buttons" class="mt-4"></div>
            </div>
        </div>
         <div id="map-detail-modal" class="modal-backdrop hidden">
             <div class="modal-content">
                <div id="map-modal-content-container">
                </div>
             </div>
        </div>
    </main>
    <div id="mission-sticky-bar" class="bottom-sticky-bar">
        <div class="sticky-content sci-fi-frame">
            <p id="sticky-objective-text"></p>
            <p id="sticky-objective-progress" class="font-roboto-mono"></p>
        </div>
    </div>

    <div id="travel-animation-modal" class="modal-backdrop hidden">
        <div id="travel-animation-content" class="modal-content">
            <div id="travel-header-panel">
                <h3 id="travel-status-text" class="text-2xl font-orbitron text-cyan-300"></h3>
                <p id="travel-arrival-lore" class="text-base text-gray-300 italic mt-2"></p>
            </div>
            <canvas id="travel-canvas"></canvas>
            <div id="travel-footer-panel">
                <div id="travel-progress-container" class="w-full bg-slate-700 rounded-full h-1.5 my-4">
                    <div id="travel-progress-bar" class="h-1.5 rounded-full" style="width: 0%"></div>
                </div>
                <div id="travel-readout-container" class="hidden">
                    <p id="travel-info-text" class="text-base font-roboto-mono"></p>
                    <p id="travel-hull-damage" class="text-sm font-roboto-mono mt-1"></p>
                </div>
                <button id="travel-confirm-button" class="btn px-8 py-2 mt-4">Enter Station</button>
            </div>
        </div>
    </div>

    <dialog id="name-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-orbitron mb-4 text-cyan-300">What is your name, Spacer?</h3>
            <input type="text" id="player-name-input" maxlength="18" class="w-full p-2 rounded bg-slate-900 border border-slate-600 text-center text-lg mb-4 text-gray-200" placeholder="Enter name...">
            <div id="name-modal-buttons" class="mt-4 flex flex-col sm:flex-row justify-center items-center gap-4"></div>
        </div>
    </dialog>

    <div id="event-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="event-title" class="text-2xl font-orbitron mb-4 text-cyan-300 text-center"></h3>
            <p id="event-description" class="mb-6 text-lg"></p>
            <div id="event-button-container" class="mt-6 flex justify-center gap-4"></div>
        </div>
    </div>

    <div id="charter-modal" class="modal-backdrop hidden modal-theme-gold">
        <div class="modal-content">
            <h3 id="charter-title" class-"text-2xl font-orbitron mb-4 text-gray-300 text-center"></h3>
            <div id="charter-description" class="mb-6 text-lg"></div>
            <div id="charter-button-container" class="mt-6 flex justify-center gap-4"></div>
        </div>
    </div>

    <div id="signature-modal" class="modal-backdrop hidden modal-theme-gold">
        <div class="modal-content">
            <h3 id="signature-title" class="text-2xl font-orbitron mb-4 text-gray-300 text-center"></h3>
            <div id="signature-description" class="mb-6 text-lg"></div>
            <input type="text" id="signature-input" maxlength="18" class="w-full p-2 rounded bg-slate-900 border border-slate-600 text-center text-lg mb-4 text-gray-200" placeholder="INPUT YOUR NAME...">
            <div id="signature-button-container" class="mt-6 flex justify-center gap-4"></div>
        </div>
    </div>

    <div id="processing-modal" class="modal-backdrop hidden">
        <div class="modal-content modal-theme-admin">
            <h3 id="processing-title" class="text-xl font-orbitron mb-4 text-gray-300"></h3>
            <div class="w-full bg-slate-700 rounded-full h-2.5 my-4">
                <div id="processing-progress-bar" class"bg-white h-2.5 rounded-full" style="width: 0%; transition: width 4s ease-out;"></div>
            </div>
            <p id="processing-status" class="text-lg text-gray-400 font-roboto-mono h-6"></p>
        </div>
    </div>

    <div id="random-event-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="random-event-title" class="text-2xl font-orbitron mb-4 text-yellow-300"></h3>
            <p id="random-event-scenario" class="mb-6 text-lg"></p>
            <div id="random-event-choices-container" class="mt-6 flex flex-col justify-center gap-4"></div>
        </div>
    </div>
    
    <div id="age-event-modal" class="modal-backdrop hidden age-event-modal">
        <div class="modal-content">
            <h3 id="age-event-title" class="text-2xl font-orbitron mb-2"></h3>
            <p id="age-event-description" class="mb-6 text-lg"></p>
            <div id="age-event-button-container" class="mt-6 flex flex-col md:flex-row justify-center gap-4"></div>
        </div>
    </div>

    <div id="lore-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <div id="lore-modal-content" class="text-gray-300">
                </div>
        </div>
    </div>
    <div id="tutorial-anchor-overlay" class="fixed inset-0 z-30 pointer-events-none"></div>

    <div id="tutorial-toast-container" class="hidden fixed z-40 p-4 rounded-lg shadow-2xl transition-all duration-300 pointer-events-auto">
        <div id="tt-arrow" data-popper-arrow></div>
        <div class="tt-controls-container">
            <button id="tutorial-toast-skip-btn" class="absolute top-1 right-2 text-2xl font-bold opacity-70 hover:opacity-1.01">×</button>
            <button id="tutorial-toast-next-btn" class="tt-next-arrow hidden">›</button>
        </div>
        <p id="tutorial-toast-text" class="text-lg pr-6"></p>
        </div>
    
    <div id="skip-tutorial-modal" class="modal-backdrop hidden">
         <div class="modal-content">
            <h3 id="skip-tutorial-title" class="text-2xl font-orbitron mb-4">Skip Tutorial?</h3>
            <p id="skip-tutorial-description" class="mb-6 text-lg">Are you sure you want to skip the rest of this tutorial? You can replay it later from the tutorial log.</p>
            <div id="skip-tutorial-button-container" class="mt-6 flex justify-center gap-4">
                 <button id="skip-tutorial-confirm-btn" class="btn bg-red-800/80">Yes, Skip</button>
                 <button id="skip-tutorial-cancel-btn" class="btn">No, Cancel</button>
            </div>
        </div>
    </div>

    <div id="ship-detail-modal" class="modal-backdrop hidden">
        <div id="ship-detail-content" class="modal-content">
            </div>
    </div>

    <div id="launch-modal" class="modal-backdrop hidden">
        <div id="launch-modal-content" class="modal-content">
            </div>
    </div>

    <div id="cargo-detail-modal" class="modal-backdrop hidden">
        <div id="cargo-detail-content" class="modal-content">
            </div>
    </div>

    <div id="graph-tooltip"></div>
    <div id="generic-tooltip" class="generic-tooltip"></div>
    
    <div id="tutorial-highlight-overlay" class="hidden"></div>
    <div id="orientation-overlay">Please rotate your device to portrait mode.</div>

    <div id="diagnostic-overlay" class="hidden">
        <div class="diag-section">
            <p><strong>Viewport:</strong> <span id="diag-window-w"></span>x<span id="diag-window-h"></span></p>
            <p><strong>Visual VP:</strong> <span id="diag-visual-vp-w"></span>x<span id="diag-visual-vp-h"></span></p>
            <p><strong>Game Cont:</strong> <span id="diag-game-container-w"></span>x<span id="diag-game-container-h"></span></p>
            <p><strong>Body:</strong> <span id="diag-body-w"></span>x<span id="diag-body-h"></span></p>
        </div>
        <div class="diag-section">
            <p><strong>Pixel Ratio:</strong> <span id="diag-pixel-ratio"></span></p>
            <p><strong>Display Mode:</strong> <span id="diag-display-mode"></span></p>
        </div>
        <div class="diag-section">
            <p><strong>Day:</strong> <span id="diag-day"></span></p>
            <p><strong>Nav/Screen:</strong> <span id="diag-nav-screen"></span></p>
        </div>
        <div class="diag-section">
            <p><strong>Tutorial Batch:</strong> <span id="diag-tutorial-batch"></span></p>
            <p><strong>Tutorial Step:</strong> <span id="diag-tutorial-step"></span></D></p>
        </div>
    </div>

    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script type="module" src="./js/main.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { // Corrected arrow function syntax
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>